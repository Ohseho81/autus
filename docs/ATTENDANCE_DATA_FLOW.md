# ì˜¨ë¦¬ìŒ¤ ì¶œì„ ê´€ë¦¬ - ë°ì´í„° íë¦„ ë° ì•„í‚¤í…ì²˜

## ğŸ—ï¸ í˜„ì¬ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì˜¨ë¦¬ìŒ¤ Mobile App                          â”‚
â”‚                  (Expo React Native)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Attendance   â”‚  â”‚ QRScanner   â”‚  â”‚SmartAttend  â”‚
    â”‚   Screen     â”‚  â”‚   Screen    â”‚  â”‚   Screen    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚                 â”‚                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  API Service      â”‚
                    â”‚  (axios + methods)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
      âŒ ì—°ë™ì•ˆë¨    âŒ ì—°ë™ì•ˆë¨    âŒ ì—°ë™ì•ˆë¨
            â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Backend API â”‚  â”‚  Supabase   â”‚  â”‚   (ë¯¸ì •)     â”‚
    â”‚ (ì¤€ë¹„ì¤‘)     â”‚  â”‚  DB (ë¯¸ìƒì„±)â”‚  â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ì¶œì„ ê¸°ë¡ ì‘ì„± íë¦„

### í˜„ì¬ ìƒíƒœ (ì‘ë™ ì•ˆí•¨)
```
ì‚¬ìš©ì ì…ë ¥
    â†“
[Attendance Screen]
    setState (ë©”ëª¨ë¦¬)
    â†“
í™”ë©´ì—ë§Œ í‘œì‹œ
    â†“
ìƒˆë¡œê³ ì¹¨ â†’ ì´ˆê¸°í™” âŒ
```

### í•„ìš”í•œ ìƒíƒœ (ëª©í‘œ)
```
ì‚¬ìš©ì ì…ë ¥
    â†“
[Attendance Screen]
    â†“
useMutation {
    mutationFn: api.recordAttendance(data)
}
    â†“
[Backend API]
    â†“
[Supabase: attendance_records]
    INSERT { student_id, date, status, ... }
    â†“
[useQuery invalidateQueries]
    â†“
í™”ë©´ ìë™ ì—…ë°ì´íŠ¸
    â†“
ì˜ì†ì„± âœ…
```

---

## ğŸ”„ QR ìŠ¤ìº” ìƒì„¸ íë¦„ (ì„¤ê³„ë„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. QR ìŠ¤ìº” ì‹œì‘                                          â”‚
â”‚    - BarCodeScanner from 'expo-barcode-scanner'       â”‚
â”‚    - ë¦¬ì–¼íƒ€ì„ ì¹´ë©”ë¼ í”¼ë“œ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. QR ë°ì´í„° íŒŒì‹±                                        â”‚
â”‚    Format: "ATB-{student_id}-{timestamp}"             â”‚
â”‚    ì˜ˆ: "ATB-s123-1707000123"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Supabase ì¿¼ë¦¬ 1: í•™ìƒ + ìˆ˜ë‚© ì •ë³´                    â”‚
â”‚                                                         â”‚
â”‚  SELECT *                                             â”‚
â”‚  FROM students                                        â”‚
â”‚  WHERE id = '${studentId}'                            â”‚
â”‚  JOIN student_payments ON students.id = student_id   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ìˆ˜ë‚© ìƒíƒœ ì²´í¬            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ paid === true?            â”‚
        â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
          â”‚ NO                   â”‚ YES
      âŒ ë¯¸ë‚©                  âœ… ë‚©ë¶€
          â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ ì˜¤ë¥˜ í‘œì‹œ   â”‚        â”‚ ê³„ì† ì§„í–‰     â”‚
    â”‚ ë¶€ëª¨ ì•Œë¦¼   â”‚        â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
        â”‚ 4. Supabase ì¿¼ë¦¬ 2: ì˜¤ëŠ˜ ë ˆìŠ¨â”‚
        â”‚                               â”‚
        â”‚  SELECT *                    â”‚
        â”‚  FROM lesson_slots           â”‚
        â”‚  WHERE date = TODAY()        â”‚
        â”‚  ORDER BY start_time         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 5. í˜„ì¬ ì‹œê°„ í™•ì¸             â”‚
        â”‚    í˜„ì¬ >= (ë ˆìŠ¨ì‹œì‘-30ë¶„)    â”‚
        â”‚    í˜„ì¬ <= ë ˆìŠ¨ì¢…ë£Œ           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. Supabase INSERT: ì¶œì„ ê¸°ë¡         â”‚
    â”‚                                        â”‚
    â”‚  INSERT INTO attendance_records       â”‚
    â”‚  VALUES (                             â”‚
    â”‚    student_id: string,               â”‚
    â”‚    lesson_slot_id: string,           â”‚
    â”‚    check_in_time: NOW(),             â”‚
    â”‚    status: 'present',                â”‚
    â”‚    verified_by: 'qr_scan'            â”‚
    â”‚  )                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 7. Supabase UPDATE: ë ˆìŠ¨ ì°¨ê°        â”‚
    â”‚                                       â”‚
    â”‚  UPDATE student_payments             â”‚
    â”‚  SET remaining_lessons = remaining - 1
    â”‚  WHERE student_id = '...'           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 8. Supabase Edge Function í˜¸ì¶œ      â”‚
    â”‚    attendance-chain-reaction        â”‚
    â”‚                                       â”‚
    â”‚    Actions:                          â”‚
    â”‚    - send_parent_notification       â”‚
    â”‚    - update_growth_log              â”‚
    â”‚    - prepare_feedback_session       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 9. ê²°ê³¼ í‘œì‹œ (Animated)              â”‚
    â”‚                                       â”‚
    â”‚    âœ… ì¶œì„ ì™„ë£Œ!                      â”‚
    â”‚    í•™ìƒëª…: ê¹€ë¯¼ìˆ˜                     â”‚
    â”‚    ì‹œê°„: 14:03                       â”‚
    â”‚    ì”ì—¬: 6íšŒ                         â”‚
    â”‚                                       â”‚
    â”‚    ìë™ ì²˜ë¦¬:                        â”‚
    â”‚    âœ“ ì¶œì„ ê¸°ë¡                       â”‚
    â”‚    âœ“ ë ˆìŠ¨ -1íšŒ                      â”‚
    â”‚    âœ“ ë¶€ëª¨ ì•Œë¦¼                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ ë°ì´í„° ëª¨ë¸ ê°„ ê´€ê³„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    academies     â”‚
â”‚                  â”‚
â”‚ id (PK)          â”‚
â”‚ name             â”‚
â”‚ address          â”‚
â”‚ owner_id         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     students          â”‚
â”‚                       â”‚
â”‚ id (PK)               â”‚
â”‚ academy_id (FK)       â”‚ â—„â”€â”€â”€â”€ í˜„ì¬ ìƒíƒœ: íƒ€ì…ë§Œ ì •ì˜
â”‚ name                  â”‚       ì‹¤ì œ í…Œì´ë¸” ì—†ìŒ
â”‚ grade, school         â”‚
â”‚ parent_name           â”‚
â”‚ parent_phone          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                                  â”‚
  â”‚                                  â”‚
â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lesson_packages    â”‚   â”‚ attendance_recordsâ”‚
â”‚                     â”‚   â”‚                   â”‚
â”‚ id (PK)             â”‚   â”‚ id (PK)           â”‚
â”‚ student_id (FK)     â”‚   â”‚ student_id (FK)   â”‚
â”‚ type: 'count'       â”‚   â”‚ lesson_slot_id(FK)â”‚
â”‚ total_count         â”‚   â”‚ check_in_time     â”‚
â”‚ used_count          â”‚   â”‚ status            â”‚
â”‚ remaining_count     â”‚   â”‚ check_in_method   â”‚
â”‚ price, paid_amount  â”‚   â”‚ created_at        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:N
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ student_payments      â”‚
â”‚                       â”‚
â”‚ id (PK)               â”‚
â”‚ student_id (FK)       â”‚
â”‚ package_id (FK)       â”‚
â”‚ paid (boolean)        â”‚
â”‚ remaining_lessons     â”‚
â”‚ amount, due_date      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      lesson_slots            â”‚
â”‚                              â”‚
â”‚ id (PK)                      â”‚
â”‚ academy_id (FK)              â”‚
â”‚ class_id (FK)                â”‚
â”‚ date, start_time, end_time   â”‚
â”‚ coach_id (FK)                â”‚
â”‚ max_count, current_count     â”‚
â”‚ created_at                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

### Attendance ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸

```
1ï¸âƒ£ GET /attendance
   â”œâ”€ Query: date, student_id, status
   â”œâ”€ Response: {
   â”‚    data: [
   â”‚      { id, student_id, student_name, date, status, checkInTime, ... }
   â”‚    ],
   â”‚    summary: {
   â”‚      total: 10,
   â”‚      present: 8,
   â”‚      absent: 1,
   â”‚      late: 1,
   â”‚      presentRate: 80
   â”‚    }
   â”‚  }
   â””â”€ í˜„í™©: âŒ ë°±ì—”ë“œ ë¯¸êµ¬í˜„

2ï¸âƒ£ POST /attendance
   â”œâ”€ Body: {
   â”‚    student_id: string,
   â”‚    date: string (YYYY-MM-DD),
   â”‚    status: 'present' | 'absent' | 'late' | 'excused',
   â”‚    note?: string
   â”‚  }
   â”œâ”€ Response: { success: true, id: uuid }
   â””â”€ í˜„í™©: âŒ ë°±ì—”ë“œ ë¯¸êµ¬í˜„

3ï¸âƒ£ POST /attendance/qr-scan
   â”œâ”€ Body: {
   â”‚    qr_data: string (ATB-{id}-{ts}),
   â”‚    location_id: string,
   â”‚    coach_id?: string
   â”‚  }
   â”œâ”€ Response: {
   â”‚    success: boolean,
   â”‚    student: { id, name, grade, ... },
   â”‚    lesson: { id, name, time, ... },
   â”‚    remaining_lessons: number,
   â”‚    message: string
   â”‚  }
   â””â”€ í˜„í™©: âŒ ë°±ì—”ë“œ ë¯¸êµ¬í˜„

4ï¸âƒ£ GET /lessons/today
   â”œâ”€ Query: date (optional)
   â”œâ”€ Response: [
   â”‚    {
   â”‚      id, class_id, date, start_time, end_time,
   â”‚      max_count, current_count, coach_name, location
   â”‚    }
   â”‚  ]
   â””â”€ í˜„í™©: âŒ ë°±ì—”ë“œ ë¯¸êµ¬í˜„

5ï¸âƒ£ POST /lessons/{id}/deduct
   â”œâ”€ Body: {
   â”‚    student_id: string,
   â”‚    count: number (default: 1)
   â”‚  }
   â”œâ”€ Response: {
   â”‚    remaining_lessons: number,
   â”‚    amount_deducted: number
   â”‚  }
   â””â”€ í˜„í™©: âŒ ë°±ì—”ë“œ ë¯¸êµ¬í˜„
```

---

## ğŸ” Supabase RLS ì •ì±… (í•„ìš”)

```sql
-- attendance_records í…Œì´ë¸” RLS
CREATE POLICY "Coaches can insert attendance"
ON attendance_records
FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = current_user_id);

CREATE POLICY "View own attendance"
ON attendance_records
FOR SELECT
TO authenticated
USING (
  student_id IN (
    SELECT id FROM students
    WHERE academy_id = current_user_academy_id
  )
);

-- student_payments í…Œì´ë¸” RLS
CREATE POLICY "Update remaining lessons"
ON student_payments
FOR UPDATE
TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM students
    WHERE id = student_id
    AND academy_id = current_user_academy_id
  )
);
```

---

## âš¡ ì²´ì¸ ë°˜ì‘ (Chain Reaction) êµ¬í˜„

### Edge Function: `attendance-chain-reaction`

```typescript
// í•„ìš”í•œ ë¡œì§ (í˜„ì¬ ë¯¸êµ¬í˜„)

export default async (req: Request) => {
  const { student_id, lesson_slot_id, actions } = await req.json();

  const chainReactions = [];

  // 1. ë¶€ëª¨ ì•Œë¦¼ ì „ì†¡
  if (actions.includes('send_parent_notification')) {
    const result = await sendNotification({
      type: 'attendance_confirmed',
      student_id,
      message: `${studentName} í•™ìƒì˜ ì¶œì„ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      channel: ['push', 'kakao', 'sms']
    });
    chainReactions.push(result);
  }

  // 2. ì„±ì¥ ë¡œê·¸ ì—…ë°ì´íŠ¸
  if (actions.includes('update_growth_log')) {
    const result = await updateGrowthLog({
      student_id,
      event: 'attendance_checked',
      vIndexImpact: +2
    });
    chainReactions.push(result);
  }

  // 3. í”¼ë“œë°± ì„¸ì…˜ ì¤€ë¹„
  if (actions.includes('prepare_feedback_session')) {
    const result = await prepareFeedback({
      student_id,
      lesson_slot_id,
      status: 'pending'
    });
    chainReactions.push(result);
  }

  return new Response(
    JSON.stringify({ success: true, reactions: chainReactions }),
    { headers: { 'Content-Type': 'application/json' } }
  );
};
```

---

## ğŸ“± ìƒíƒœ ê´€ë¦¬ ì „ëµ (í˜„ì¬ vs ëª©í‘œ)

### í˜„ì¬ ìƒíƒœ
```typescript
// AttendanceScreen.tsx
const [records, setRecords] = useState<AttendanceRecord[]>([]);
const [selectedDate, setSelectedDate] = useState<string>(today);

// ë¬¸ì œ:
// - ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥
// - ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì†Œì‹¤
// - ë‹¤ë¥¸ í™”ë©´ê³¼ ê³µìœ  ë¶ˆê°€
```

### ëª©í‘œ ìƒíƒœ (Zustand ê¶Œì¥)
```typescript
// store/attendanceStore.ts
export const useAttendanceStore = create((set) => ({
  records: [],
  selectedDate: today,

  // Actions
  setRecords: (records) => set({ records }),
  setSelectedDate: (date) => set({ selectedDate: date }),

  // Async actions
  fetchRecords: async (date) => {
    const data = await api.getAttendance({ date });
    set({ records: data.records });
  },

  recordAttendance: async (studentId, status) => {
    const result = await api.recordAttendance({
      student_id: studentId,
      date: selectedDate,
      status
    });
    // Refetch
    const updated = await api.getAttendance({ date: selectedDate });
    set({ records: updated.records });
  }
}));

// ì‚¬ìš©:
const AttendanceScreen = () => {
  const { records, fetchRecords } = useAttendanceStore();

  useEffect(() => {
    fetchRecords(selectedDate);
  }, [selectedDate]);

  return <FlatList data={records} ... />;
};
```

---

## ğŸ“Š ë°ì´í„° íë¦„ ì‹œê°„ íë¦„ë„

```
t=0     QR ìŠ¤ìº”
        â†“
t=50ms  íŒŒì‹± ì™„ë£Œ
        â†“
t=100ms Supabase ì¿¼ë¦¬ (í•™ìƒ+ìˆ˜ë‚©)
        â†“
t=150ms í˜„ì¬ ë ˆìŠ¨ í™•ì¸
        â†“
t=200ms INSERT attendance_records
        â†“
t=250ms UPDATE student_payments (ì°¨ê°)
        â†“
t=300ms Edge Function í˜¸ì¶œ
        â”œâ”€â”€ send_parent_notification
        â”œâ”€â”€ update_growth_log
        â””â”€â”€ prepare_feedback_session
        â†“
t=500ms ê²°ê³¼ ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ
        â†“
t=1000ms ë¦¬ì…‹ ê°€ëŠ¥
```

---

## ğŸ¯ ìš°ì„ ìˆœìœ„ë³„ êµ¬í˜„ ìˆœì„œ

### Phase 1: Database Foundation (3ì¼)
```
1. Supabase í…Œì´ë¸” ìƒì„±
   - students
   - lesson_slots
   - attendance_records
   - student_payments
   - academies
   - coaches

2. ìƒ˜í”Œ ë°ì´í„° INSERT (í…ŒìŠ¤íŠ¸ìš©)
3. RLS ì •ì±… ì„¤ì •
```

### Phase 2: Backend API (1ì£¼)
```
1. GET /attendance êµ¬í˜„
2. POST /attendance êµ¬í˜„
3. GET /lessons/today êµ¬í˜„
4. POST /attendance/qr-scan êµ¬í˜„
5. POST /lessons/{id}/deduct êµ¬í˜„
```

### Phase 3: Frontend Integration (1ì£¼)
```
1. AttendanceScreen: API ì—°ë™
2. QRScannerScreen: Supabase ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
3. SmartAttendanceScreen: Mock â†’ API ë³€ê²½
4. ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
5. ë¡œë”© ìƒíƒœ í‘œì‹œ
```

### Phase 4: Chain Reactions (3-5ì¼)
```
1. Edge Function êµ¬í˜„
2. ë¶€ëª¨ ì•Œë¦¼ ì „ì†¡
3. V-Index ì—…ë°ì´íŠ¸
4. ì„±ì¥ ë¡œê·¸ ê¸°ë¡
```

---

## ğŸ“š ì°¸ê³  ì½”ë“œ ìœ„ì¹˜

| í•­ëª© | íŒŒì¼ | ë¼ì¸ | ìƒíƒœ |
|------|------|------|------|
| API ë©”ì„œë“œ | `/allthatbasket/src/services/api.ts` | 166-182 | ğŸŸ¡ ë©”ì„œë“œë§Œ |
| QR ìŠ¤ìº” ë¡œì§ | `/allthatbasket/src/screens/attendance/QRScannerScreen.tsx` | 132-235 | ğŸŸ¡ ì¿¼ë¦¬ ì‘ì„±ë¨ |
| Supabase ì„¤ì • | `/allthatbasket/src/lib/supabase.ts` | - | âœ… ì¤€ë¹„ë¨ |
| íƒ€ì… ì •ì˜ | `/allthatbasket/src/types/lesson.ts` | 1-277 | âœ… ì™„ì„±ë¨ |
| DB ìŠ¤í‚¤ë§ˆ | `/mnt/autus/AUTUS_CORE_V1.sql` | 24-37 | âœ… ì„¤ê³„ë¨ |

