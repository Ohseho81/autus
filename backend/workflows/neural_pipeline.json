{
  "name": "KRATON Neural Pipeline",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "neural-input",
        "responseMode": "onReceived",
        "responseData": "allEntries"
      },
      "id": "webhook-input",
      "name": "Quick-Tag Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "neural-input"
    },
    {
      "parameters": {
        "functionCode": "// ìž…ë ¥ ë°ì´í„° ì •ê·œí™”\nconst input = items[0].json;\n\n// ì»¨í…ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ì¡°í•©\nlet contextParts = [];\n\nif (input.interaction_type) {\n  contextParts.push(`[ìƒí˜¸ìž‘ìš© ìœ í˜•] ${input.interaction_type}`);\n}\n\nif (input.sentiment_emoji) {\n  const emojiMap = {\n    'ðŸ˜Š': 'ë§¤ìš° ë§Œì¡± (+20)',\n    'ðŸ™‚': 'ë§Œì¡± (+10)',\n    'ðŸ˜': 'ë¶ˆë§Œì¡± (-10)',\n    'ðŸ˜Ÿ': 'ë§¤ìš° ë¶ˆë§Œ (-20)'\n  };\n  contextParts.push(`[ê°ì • ìƒíƒœ] ${emojiMap[input.sentiment_emoji] || input.sentiment_emoji}`);\n}\n\nif (input.bond_tag) {\n  contextParts.push(`[ìœ ëŒ€ ê°•ë„] ${input.bond_tag}`);\n}\n\nif (input.issue_triggers && input.issue_triggers.length) {\n  contextParts.push(`[ì´ìŠˆ íŠ¸ë¦¬ê±°] ${input.issue_triggers.join(', ')}`);\n}\n\nif (input.tags && input.tags.length) {\n  contextParts.push(`[íƒœê·¸] ${input.tags.join(', ')}`);\n}\n\nif (input.raw_text) {\n  contextParts.push(`[ë©”ëª¨] ${input.raw_text}`);\n}\n\nif (input.voice_transcript) {\n  contextParts.push(`[ìŒì„± ê¸°ë¡] ${input.voice_transcript}`);\n}\n\nreturn [{\n  json: {\n    ...input,\n    context_text: contextParts.join('\\n'),\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "prepare-context",
      "name": "Prepare Context",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "requestMethod": "POST",
        "jsonParameters": true,
        "options": {
          "bodyParameters": {
            "parameters": []
          }
        },
        "bodyParametersJson": "={{ JSON.stringify({ model: 'claude-3-5-sonnet-20241022', max_tokens: 1024, messages: [{ role: 'user', content: `ë‹¹ì‹ ì€ KRATON Physics Engineì˜ ë°ì´í„° ë²¡í„°í™” ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ë‹¤ìŒ ìƒí˜¸ìž‘ìš© ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ JSONìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”.\n\nì¶”ì¶œí•  ë³€ìˆ˜:\n1. s_delta (ë§Œì¡±ë„ ë³€í™”): -100 ~ +100\n2. m_delta (ì„±ê³¼ ë³€í™”): -100 ~ +100\n3. bond_strength (ìœ ëŒ€ ê°•ë„): 0 ~ 100\n4. risk_indicators (ìœ„í—˜ ì‹ í˜¸): string[]\n5. psychological_triggers (ì‹¬ë¦¬ì  íŠ¸ë¦¬ê±°): string[]\n6. analysis_summary (ë¶„ì„ ìš”ì•½): string\n7. recommended_action (ê¶Œìž¥ ì¡°ì¹˜): string\n\në°ì´í„°:\n${$json.context_text}\n\nJSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:` }] }) }}"
      },
      "id": "claude-vectorize",
      "name": "Claude Vectorization",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 300],
      "credentials": {
        "anthropicApi": {
          "id": "anthropic-cred",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Claude ì‘ë‹µì—ì„œ JSON ì¶”ì¶œ\nconst response = items[0].json;\nconst input = $('Prepare Context').first().json;\n\nlet physicsVector;\ntry {\n  const content = response.content[0].text;\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  physicsVector = jsonMatch ? JSON.parse(jsonMatch[0]) : null;\n} catch (e) {\n  physicsVector = {\n    s_delta: 0,\n    m_delta: 0,\n    bond_strength: 50,\n    risk_indicators: [],\n    psychological_triggers: [],\n    analysis_summary: 'ë¶„ì„ ì‹¤íŒ¨',\n    recommended_action: 'ìˆ˜ë™ ê²€í†  í•„ìš”'\n  };\n}\n\n// Risk Score ê³„ì‚°: R(t) = Î£(risk) + |min(0, s_delta)|\nconst riskScore = (physicsVector.risk_indicators?.length || 0) * 10 + \n                  Math.abs(Math.min(0, physicsVector.s_delta || 0));\n\nreturn [{\n  json: {\n    node_id: input.node_id,\n    target_id: input.target_id,\n    context_text: input.context_text,\n    physics_vector: physicsVector,\n    risk_score: riskScore,\n    risk_triggered: riskScore > 30,\n    priority: riskScore > 60 ? 'CRITICAL' : riskScore > 40 ? 'HIGH' : 'MEDIUM',\n    timestamp: input.timestamp\n  }\n}];"
      },
      "id": "parse-vector",
      "name": "Parse Physics Vector",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "interaction_logs",
        "columns": "node_pair_id,source_node,target_node,raw_content,sentiment_score,vectorized_data,created_at",
        "additionalFields": {}
      },
      "id": "save-log",
      "name": "Save Interaction Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1050, 200],
      "credentials": {
        "postgres": {
          "id": "supabase-pg",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": "public",
        "table": "physics_metrics",
        "columns": "node_id,s_index,m_score,bond_strength,risk_indicators,last_interaction,updated_at",
        "conflictColumns": "node_id",
        "additionalFields": {}
      },
      "id": "update-metrics",
      "name": "Update Physics Metrics",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1050, 400],
      "credentials": {
        "postgres": {
          "id": "supabase-pg",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.risk_triggered }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-risk",
      "name": "Risk Threshold Check",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "url": "={{ $env.ACTIVE_SHIELD_WEBHOOK }}",
        "method": "POST",
        "jsonParameters": true,
        "bodyParametersJson": "={{ JSON.stringify({ node_id: $json.target_id, risk_score: $json.risk_score, priority: $json.priority, physics_vector: $json.physics_vector, triggered_at: $json.timestamp }) }}"
      },
      "id": "trigger-shield",
      "name": "Trigger Active Shield",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1450, 200]
    },
    {
      "parameters": {},
      "id": "no-risk",
      "name": "No Risk Action",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1450, 400]
    }
  ],
  "connections": {
    "Quick-Tag Webhook": {
      "main": [
        [{ "node": "Prepare Context", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Context": {
      "main": [
        [{ "node": "Claude Vectorization", "type": "main", "index": 0 }]
      ]
    },
    "Claude Vectorization": {
      "main": [
        [{ "node": "Parse Physics Vector", "type": "main", "index": 0 }]
      ]
    },
    "Parse Physics Vector": {
      "main": [
        [
          { "node": "Save Interaction Log", "type": "main", "index": 0 },
          { "node": "Update Physics Metrics", "type": "main", "index": 0 },
          { "node": "Risk Threshold Check", "type": "main", "index": 0 }
        ]
      ]
    },
    "Risk Threshold Check": {
      "main": [
        [{ "node": "Trigger Active Shield", "type": "main", "index": 0 }],
        [{ "node": "No Risk Action", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
