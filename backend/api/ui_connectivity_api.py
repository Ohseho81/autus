"""
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ›ï¸ AUTUS UI CONNECTIVITY API
UIê°€ í˜¸ì¶œ ê°€ëŠ¥í•œ ì „ë¶€ (GET only, ìƒíƒœ ìŠ¤ëƒ…ìƒ·)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ê³µí†µ ì›ì¹™:
- GET only
- ìƒíƒœ ìŠ¤ëƒ…ìƒ·
- ê¶Œí•œë³„ ì‘ë‹µ ì°¨ë“±
- ìˆ˜ì¹˜ ìµœì†Œí™” / êµ¬ì¡° ì¤‘ì‹¬
"""

from fastapi import APIRouter, Depends, HTTPException, WebSocket, WebSocketDisconnect
from fastapi.responses import JSONResponse
from typing import Optional, List, Dict, Any
from datetime import datetime
from enum import Enum
import asyncio
import json

router = APIRouter(tags=["UI Connectivity"])

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GATE STATE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class GateState(str, Enum):
    OBSERVE = "OBSERVE"
    RING = "RING"
    LOCK = "LOCK"

# In-memory state (ì‹¤ì œë¡œëŠ” Redis/DB)
_current_gate_state = GateState.OBSERVE
_gate_subscribers: List[WebSocket] = []

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1ï¸âƒ£ CITY TWIN - ê³µê°„ ë§¥ë½ (K2/K10 ê³µí†µ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("/city/context")
async def get_city_context():
    """
    City Twin ê³µê°„ ë§¥ë½
    - K2/K10 ê³µí†µ
    - ìˆ˜ì¹˜ ì—†ìŒ
    """
    return {
        "center": {"lat": 37.4998, "lng": 127.0573},
        "boundaries": ["gangnam", "seocho", "songpa"],
        "densityLayer": "available",
        "timeContext": _get_time_context()
    }

def _get_time_context() -> str:
    hour = datetime.now().hour
    if 6 <= hour < 12:
        return "morning"
    elif 12 <= hour < 18:
        return "afternoon"
    elif 18 <= hour < 22:
        return "evening"
    else:
        return "night"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 2ï¸âƒ£ WORK GENOME - ë‹¨ì¼ Task (K2 ì „ìš©)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("/genome/current")
async def get_current_genome():
    """
    Work Genome í˜„ìž¬ Task
    - ë‹¨ì¼ Taskë§Œ ë°˜í™˜
    - ë¦¬ìŠ¤íŠ¸ âŒ
    """
    return {
        "task": {
            "id": "GEN-001",
            "name": "ë³¸ì‚¬ ìš´ì˜ ì ê²€",
            "state": "idle"  # idle / active / blocked
        }
    }

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 3ï¸âƒ£ GATE STATE - ëª¨ë“  UI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("/gate/state")
async def get_gate_state():
    """
    Gate ìƒíƒœ
    - OBSERVE / RING / LOCK
    - ì´ìœ  âŒ
    - ìž„ê³„ì¹˜ âŒ
    """
    return {
        "state": _current_gate_state.value
    }

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 4ï¸âƒ£ SIMULATION FRAME - K10 ì „ìš©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("/simulation/frame")
async def get_simulation_frame(time: str = "now"):
    """
    ì‹œë®¬ë ˆì´ì…˜ í”„ë ˆìž„
    - ë Œë”ìš© ë°ì´í„°ë§Œ
    - ì˜ë¯¸ í•´ì„ âŒ
    """
    return {
        "waves": "encoded_wave_data",
        "halos": "encoded_halo_data",
        "timestamp": datetime.utcnow().isoformat()
    }

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 5ï¸âƒ£ AFTERIMAGE INDEX - K10 / Audit
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("/afterimage/index")
async def get_afterimage_index():
    """
    Afterimage ì¸ë±ìŠ¤
    - IDì™€ Hashë§Œ
    """
    return [
        {"id": "AI-001", "hash": "0x92fa3b1c", "gate": "LOCK"},
        {"id": "AI-002", "hash": "0x7d2e4a9f", "gate": "RING"},
        {"id": "AI-003", "hash": "0xa1b2c3d4", "gate": "LOCK"},
    ]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 6ï¸âƒ£ AFTERIMAGE REPLAY - Hash ê¸°ë°˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("/afterimage/replay/{hash}")
async def get_afterimage_replay(hash: str):
    """
    Afterimage ìž¬ìƒ
    - ê²°ì •ë¡ ì  í”„ë ˆìž„
    """
    return {
        "hash": hash,
        "frames": "deterministic_replay_data",
        "environment_version": "1.0.0",
        "geo_reference": {"lat": 37.4998, "lng": 127.0573}
    }

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ìœ ì¼í•œ UI ì‹ í˜¸: EXECUTE EVENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.post("/event/execute")
async def execute_event(task_id: str):
    """
    ì‹¤í–‰ ì´ë²¤íŠ¸
    - ì„±ê³µ/ì‹¤íŒ¨ ì‘ë‹µ ì—†ìŒ
    - ACKë§Œ ë°˜í™˜
    - ê²°ê³¼ëŠ” Gate/í™˜ê²½ ë³€í™”ë¡œë§Œ ì²´ê°
    """
    # ë‚´ë¶€ ì²˜ë¦¬ (UIëŠ” ëª¨ë¦„)
    # - Work Genome ë³€í™”
    # - Physics ê³„ì‚°
    # - Gate íŒì •
    # - (LOCK ì‹œ) Gravity ì ìš© â†’ Afterimage ê¸°ë¡
    
    return JSONResponse(
        status_code=200,
        content={"ack": True}
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GATE STATE STREAM (WebSocket)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.websocket("/stream/gate")
async def gate_stream(websocket: WebSocket):
    """
    Gate ìƒíƒœ ìŠ¤íŠ¸ë¦¼
    - ì‹¤ì‹œê°„
    - í…ìŠ¤íŠ¸ ì—†ìŒ
    - UIëŠ” ëŠë¼ê¸°ë§Œ í•¨
    """
    await websocket.accept()
    _gate_subscribers.append(websocket)
    
    try:
        # ì´ˆê¸° ìƒíƒœ ì „ì†¡
        await websocket.send_json({"state": _current_gate_state.value})
        
        while True:
            # Keep-alive
            await asyncio.sleep(1)
            await websocket.send_json({"state": _current_gate_state.value})
            
    except WebSocketDisconnect:
        _gate_subscribers.remove(websocket)

async def broadcast_gate_state(new_state: GateState):
    """Gate ìƒíƒœ ë¸Œë¡œë“œìºìŠ¤íŠ¸"""
    global _current_gate_state
    _current_gate_state = new_state
    
    for ws in _gate_subscribers:
        try:
            await ws.send_json({"state": new_state.value})
        except:
            pass

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ë‚´ë¶€ ì „ìš© (UI ë¯¸ë…¸ì¶œ) - ì°¸ì¡°ìš© ì£¼ì„
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Gate.evaluate() - UI ì ‘ê·¼ ë¶ˆê°€
# Simulation.run() - UI ì ‘ê·¼ ë¶ˆê°€
# Afterimage.append() - UI ì ‘ê·¼ ë¶ˆê°€
# Gravity.applyPreset() - UI ì ‘ê·¼ ë¶ˆê°€

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# K-SCALE ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ ê·œì¹™
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

K2_ALLOWED = [
    "/city/context",
    "/genome/current",
    "/gate/state",
]

K10_ALLOWED = [
    "/city/context",
    "/genome/current",
    "/gate/state",
    "/simulation/frame",
    "/afterimage/index",
    "/afterimage/replay",
]

K10_FORBIDDEN = [
    "/event/execute",  # K10ì€ ì‹¤í–‰ ë¶ˆê°€
]
