{
  "name": "AUTUS Stripe Webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stripe",
        "responseMode": "responseNode"
      },
      "id": "stripe_webhook",
      "name": "Stripe Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Stripe → Zero Meaning\nconst data = $input.item.json.body || $input.item.json;\nconst eventType = data.type || '';\nconst obj = data.data?.object || data;\n\n// ID 추출\nlet nodeId = obj.customer || obj.id || null;\nif (typeof nodeId === 'object') nodeId = nodeId.id;\nnodeId = nodeId ? String(nodeId) : null;\n\n// 금액 추출 (cents → 원)\nlet value = 0;\nif (obj.amount) value = obj.amount / 100;\nelse if (obj.amount_paid) value = obj.amount_paid / 100;\nelse if (obj.total) value = obj.total / 100;\n\n// 흐름 타입\nlet flowType = 'inflow';\nif (eventType.includes('refund') || eventType.includes('dispute')) {\n  flowType = 'outflow';\n}\n\nreturn [{\n  json: {\n    node_id: nodeId,\n    value: value,\n    flow_type: flowType,\n    source: 'stripe',\n    event_type: eventType,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "stripe_transform",
      "name": "Zero Meaning 정제",
      "type": "n8n-nodes-base.function",
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.node_id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "has_node_id",
      "name": "노드 ID 있음?",
      "type": "n8n-nodes-base.if",
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: 'stripe' }) }}"
      },
      "id": "upsert_node",
      "name": "노드 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.flow_type === 'inflow' ? $json.node_id : 'owner', target_id: $json.flow_type === 'inflow' ? 'owner' : $json.node_id, amount: $json.value, direction: $json.flow_type }) }}"
      },
      "id": "create_motion",
      "name": "모션 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, node_id: $json.node_id, amount: $json.value, flow_type: $json.flow_type } }}"
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Stripe Webhook": {
      "main": [[{ "node": "Zero Meaning 정제", "type": "main", "index": 0 }]]
    },
    "Zero Meaning 정제": {
      "main": [[{ "node": "노드 ID 있음?", "type": "main", "index": 0 }]]
    },
    "노드 ID 있음?": {
      "main": [
        [{ "node": "노드 생성", "type": "main", "index": 0 }],
        [{ "node": "Response", "type": "main", "index": 0 }]
      ]
    },
    "노드 생성": {
      "main": [[{ "node": "모션 생성", "type": "main", "index": 0 }]]
    },
    "모션 생성": {
      "main": [[{ "node": "Response", "type": "main", "index": 0 }]]
    }
  }
}


{
  "name": "AUTUS Stripe Webhook",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stripe",
        "responseMode": "responseNode"
      },
      "id": "stripe_webhook",
      "name": "Stripe Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Stripe → Zero Meaning\nconst data = $input.item.json.body || $input.item.json;\nconst eventType = data.type || '';\nconst obj = data.data?.object || data;\n\n// ID 추출\nlet nodeId = obj.customer || obj.id || null;\nif (typeof nodeId === 'object') nodeId = nodeId.id;\nnodeId = nodeId ? String(nodeId) : null;\n\n// 금액 추출 (cents → 원)\nlet value = 0;\nif (obj.amount) value = obj.amount / 100;\nelse if (obj.amount_paid) value = obj.amount_paid / 100;\nelse if (obj.total) value = obj.total / 100;\n\n// 흐름 타입\nlet flowType = 'inflow';\nif (eventType.includes('refund') || eventType.includes('dispute')) {\n  flowType = 'outflow';\n}\n\nreturn [{\n  json: {\n    node_id: nodeId,\n    value: value,\n    flow_type: flowType,\n    source: 'stripe',\n    event_type: eventType,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "stripe_transform",
      "name": "Zero Meaning 정제",
      "type": "n8n-nodes-base.function",
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.node_id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "has_node_id",
      "name": "노드 ID 있음?",
      "type": "n8n-nodes-base.if",
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: 'stripe' }) }}"
      },
      "id": "upsert_node",
      "name": "노드 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.flow_type === 'inflow' ? $json.node_id : 'owner', target_id: $json.flow_type === 'inflow' ? 'owner' : $json.node_id, amount: $json.value, direction: $json.flow_type }) }}"
      },
      "id": "create_motion",
      "name": "모션 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, node_id: $json.node_id, amount: $json.value, flow_type: $json.flow_type } }}"
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Stripe Webhook": {
      "main": [[{ "node": "Zero Meaning 정제", "type": "main", "index": 0 }]]
    },
    "Zero Meaning 정제": {
      "main": [[{ "node": "노드 ID 있음?", "type": "main", "index": 0 }]]
    },
    "노드 ID 있음?": {
      "main": [
        [{ "node": "노드 생성", "type": "main", "index": 0 }],
        [{ "node": "Response", "type": "main", "index": 0 }]
      ]
    },
    "노드 생성": {
      "main": [[{ "node": "모션 생성", "type": "main", "index": 0 }]]
    },
    "모션 생성": {
      "main": [[{ "node": "Response", "type": "main", "index": 0 }]]
    }
  }
}








