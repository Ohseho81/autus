{
  "name": "AUTUS 토스 가상계좌 (수수료 0%)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "toss-va",
        "responseMode": "responseNode"
      },
      "id": "toss_webhook",
      "name": "토스 Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.status || $json.body?.status }}",
              "value2": "DONE"
            }
          ]
        }
      },
      "id": "status_check",
      "name": "입금 완료?",
      "type": "n8n-nodes-base.if",
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// 토스 → Zero Meaning (수수료 0%)\nconst data = $input.item.json.body || $input.item.json;\n\n// orderId에서 고객ID 추출\nconst orderId = data.orderId || '';\nlet nodeId = orderId.includes('_') ? orderId.split('_')[0] : orderId;\nnodeId = nodeId || 'toss_' + (data.paymentKey || Date.now());\n\nconst amount = data.totalAmount || data.amount || 0;\n\n// 카드 수수료 3% vs 가상계좌 0%\nconst cardFee = amount * 0.03;\nconst actualFee = 0; // 가상계좌!\nconst feeSaved = cardFee - actualFee;\n\nreturn [{\n  json: {\n    node_id: nodeId,\n    value: amount,\n    flow_type: 'inflow',\n    source: 'toss_va',\n    fee: 0,\n    fee_saved: feeSaved,\n    method: 'virtual_account',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "toss_transform",
      "name": "Zero Meaning (수수료 0%)",
      "type": "n8n-nodes-base.function",
      "position": [650, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: 'toss_va' }) }}"
      },
      "id": "upsert_node",
      "name": "노드 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.node_id, target_id: 'owner', amount: $json.value, direction: 'inflow', fee: 0 }) }}"
      },
      "id": "create_motion",
      "name": "모션 (수수료 0%)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, node_id: $json.node_id, amount: $json.value, fee: 0, fee_saved: $json.fee_saved, method: 'virtual_account', message: '₩' + Math.round($json.fee_saved).toLocaleString() + ' 절약!' } }}"
      },
      "id": "response_success",
      "name": "Response (성공)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, action: 'skipped', reason: 'status_not_done' } }}"
      },
      "id": "response_skip",
      "name": "Response (스킵)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [650, 400]
    }
  ],
  "connections": {
    "토스 Webhook": {
      "main": [[{ "node": "입금 완료?", "type": "main", "index": 0 }]]
    },
    "입금 완료?": {
      "main": [
        [{ "node": "Zero Meaning (수수료 0%)", "type": "main", "index": 0 }],
        [{ "node": "Response (스킵)", "type": "main", "index": 0 }]
      ]
    },
    "Zero Meaning (수수료 0%)": {
      "main": [[{ "node": "노드 생성", "type": "main", "index": 0 }]]
    },
    "노드 생성": {
      "main": [[{ "node": "모션 (수수료 0%)", "type": "main", "index": 0 }]]
    },
    "모션 (수수료 0%)": {
      "main": [[{ "node": "Response (성공)", "type": "main", "index": 0 }]]
    }
  }
}


{
  "name": "AUTUS 토스 가상계좌 (수수료 0%)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "toss-va",
        "responseMode": "responseNode"
      },
      "id": "toss_webhook",
      "name": "토스 Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.status || $json.body?.status }}",
              "value2": "DONE"
            }
          ]
        }
      },
      "id": "status_check",
      "name": "입금 완료?",
      "type": "n8n-nodes-base.if",
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// 토스 → Zero Meaning (수수료 0%)\nconst data = $input.item.json.body || $input.item.json;\n\n// orderId에서 고객ID 추출\nconst orderId = data.orderId || '';\nlet nodeId = orderId.includes('_') ? orderId.split('_')[0] : orderId;\nnodeId = nodeId || 'toss_' + (data.paymentKey || Date.now());\n\nconst amount = data.totalAmount || data.amount || 0;\n\n// 카드 수수료 3% vs 가상계좌 0%\nconst cardFee = amount * 0.03;\nconst actualFee = 0; // 가상계좌!\nconst feeSaved = cardFee - actualFee;\n\nreturn [{\n  json: {\n    node_id: nodeId,\n    value: amount,\n    flow_type: 'inflow',\n    source: 'toss_va',\n    fee: 0,\n    fee_saved: feeSaved,\n    method: 'virtual_account',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "toss_transform",
      "name": "Zero Meaning (수수료 0%)",
      "type": "n8n-nodes-base.function",
      "position": [650, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: 'toss_va' }) }}"
      },
      "id": "upsert_node",
      "name": "노드 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.node_id, target_id: 'owner', amount: $json.value, direction: 'inflow', fee: 0 }) }}"
      },
      "id": "create_motion",
      "name": "모션 (수수료 0%)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, node_id: $json.node_id, amount: $json.value, fee: 0, fee_saved: $json.fee_saved, method: 'virtual_account', message: '₩' + Math.round($json.fee_saved).toLocaleString() + ' 절약!' } }}"
      },
      "id": "response_success",
      "name": "Response (성공)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, action: 'skipped', reason: 'status_not_done' } }}"
      },
      "id": "response_skip",
      "name": "Response (스킵)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [650, 400]
    }
  ],
  "connections": {
    "토스 Webhook": {
      "main": [[{ "node": "입금 완료?", "type": "main", "index": 0 }]]
    },
    "입금 완료?": {
      "main": [
        [{ "node": "Zero Meaning (수수료 0%)", "type": "main", "index": 0 }],
        [{ "node": "Response (스킵)", "type": "main", "index": 0 }]
      ]
    },
    "Zero Meaning (수수료 0%)": {
      "main": [[{ "node": "노드 생성", "type": "main", "index": 0 }]]
    },
    "노드 생성": {
      "main": [[{ "node": "모션 (수수료 0%)", "type": "main", "index": 0 }]]
    },
    "모션 (수수료 0%)": {
      "main": [[{ "node": "Response (성공)", "type": "main", "index": 0 }]]
    }
  }
}







