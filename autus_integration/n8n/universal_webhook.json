{
  "name": "AUTUS Universal Webhook (자동 감지)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "universal",
        "responseMode": "responseNode"
      },
      "id": "universal_webhook",
      "name": "Universal Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// SaaS 자동 감지 + Zero Meaning 정제\nconst data = $input.item.json.body || $input.item.json;\nconst headers = $input.item.json.headers || {};\n\n// ═══════════════════════════════════════════════════════════════\n// 1. 소스 자동 감지\n// ═══════════════════════════════════════════════════════════════\nlet source = 'unknown';\n\n// 헤더 기반\nif (headers['stripe-signature']) source = 'stripe';\nelse if (headers['x-shopify-hmac-sha256']) source = 'shopify';\nelse if (headers['x-quickbooks-signature']) source = 'quickbooks';\nelse if (headers['x-toss-signature']) source = 'toss';\n\n// 페이로드 기반\nelse if (data.livemode !== undefined || (data.type && data.type.includes('.'))) source = 'stripe';\nelse if (data.admin_graphql_api_id) source = 'shopify';\nelse if (data.paymentKey || data.orderId) source = 'toss';\nelse if (data.realmId) source = 'quickbooks';\nelse if (data.portalId || data.subscriptionType) source = 'hubspot';\nelse if (data.AccountId || data.sobjectType) source = 'salesforce';\nelse if (data.student_id && data.tuition) source = 'highclass';\nelse if (data.member_no) source = 'academy_plus';\nelse if (data.membership_fee) source = 'gymbox';\n\n// ═══════════════════════════════════════════════════════════════\n// 2. Zero Meaning 정제\n// ═══════════════════════════════════════════════════════════════\nconst mapping = {\n  stripe: { id: ['customer', 'id'], value: ['amount', 100], event: ['type'] },\n  shopify: { id: ['customer.id', 'id'], value: ['total_price', 1], event: ['topic'] },\n  toss: { id: ['orderId'], value: ['totalAmount', 1], event: ['status'] },\n  hubspot: { id: ['properties.hs_contact_id', 'vid'], value: ['properties.amount', 1], event: ['subscriptionType'] },\n  highclass: { id: ['student_id'], value: ['tuition', 1], event: ['event'] },\n  academy_plus: { id: ['member_no'], value: ['pay_amount', 1], event: ['event'] },\n  gymbox: { id: ['member_id'], value: ['membership_fee', 1], event: ['event'] }\n};\n\nconst map = mapping[source] || { id: ['id'], value: ['amount', 1], event: ['event'] };\n\n// 중첩 필드 접근\nfunction getVal(obj, path) {\n  return path.split('.').reduce((o, p) => o && o[p], obj);\n}\n\n// ID 추출\nlet nodeId = null;\nfor (const f of map.id) {\n  const v = f.includes('.') ? getVal(data, f) : data[f];\n  if (v) { nodeId = String(v); break; }\n}\nnodeId = nodeId || 'anon_' + Date.now();\n\n// 금액 추출\nlet value = 0;\nconst [valField, divisor] = Array.isArray(map.value) ? map.value : [map.value, 1];\nfor (const f of (typeof valField === 'string' ? [valField] : map.id)) {\n  const v = f.includes('.') ? getVal(data, f) : data[f];\n  if (v) { value = parseFloat(v) / divisor; break; }\n}\nif (data.amount) value = parseFloat(data.amount) / (map.value[1] || 1);\nif (data.totalAmount) value = parseFloat(data.totalAmount);\nif (data.total_price) value = parseFloat(data.total_price);\nif (data.tuition) value = parseFloat(data.tuition);\nif (data.membership_fee) value = parseFloat(data.membership_fee);\n\n// 흐름 타입\nlet flowType = 'inflow';\nlet eventType = '';\nfor (const f of map.event) {\n  const v = data[f];\n  if (v) { eventType = String(v).toLowerCase(); break; }\n}\nif (eventType.includes('refund') || eventType.includes('cancel') || eventType.includes('dispute')) {\n  flowType = 'outflow';\n}\n\nreturn [{\n  json: {\n    node_id: nodeId,\n    value: value,\n    flow_type: flowType,\n    source: source,\n    event_type: eventType,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "auto_detect",
      "name": "자동 감지 + Zero Meaning",
      "type": "n8n-nodes-base.function",
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.node_id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "has_node_id",
      "name": "노드 ID 있음?",
      "type": "n8n-nodes-base.if",
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: $json.source }) }}"
      },
      "id": "upsert_node",
      "name": "노드 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.flow_type === 'inflow' ? $json.node_id : 'owner', target_id: $json.flow_type === 'inflow' ? 'owner' : $json.node_id, amount: $json.value, direction: $json.flow_type }) }}"
      },
      "id": "create_motion",
      "name": "모션 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, action: $json.flow_type + '_created', node_id: $json.node_id, amount: $json.value, detected_source: $json.source } }}"
      },
      "id": "response_success",
      "name": "Response (성공)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, action: 'skipped', reason: 'no_node_id', detected_source: $json.source } }}"
      },
      "id": "response_skip",
      "name": "Response (스킵)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [850, 400]
    }
  ],
  "connections": {
    "Universal Webhook": {
      "main": [[{ "node": "자동 감지 + Zero Meaning", "type": "main", "index": 0 }]]
    },
    "자동 감지 + Zero Meaning": {
      "main": [[{ "node": "노드 ID 있음?", "type": "main", "index": 0 }]]
    },
    "노드 ID 있음?": {
      "main": [
        [{ "node": "노드 생성", "type": "main", "index": 0 }],
        [{ "node": "Response (스킵)", "type": "main", "index": 0 }]
      ]
    },
    "노드 생성": {
      "main": [[{ "node": "모션 생성", "type": "main", "index": 0 }]]
    },
    "모션 생성": {
      "main": [[{ "node": "Response (성공)", "type": "main", "index": 0 }]]
    }
  }
}


{
  "name": "AUTUS Universal Webhook (자동 감지)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "universal",
        "responseMode": "responseNode"
      },
      "id": "universal_webhook",
      "name": "Universal Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// SaaS 자동 감지 + Zero Meaning 정제\nconst data = $input.item.json.body || $input.item.json;\nconst headers = $input.item.json.headers || {};\n\n// ═══════════════════════════════════════════════════════════════\n// 1. 소스 자동 감지\n// ═══════════════════════════════════════════════════════════════\nlet source = 'unknown';\n\n// 헤더 기반\nif (headers['stripe-signature']) source = 'stripe';\nelse if (headers['x-shopify-hmac-sha256']) source = 'shopify';\nelse if (headers['x-quickbooks-signature']) source = 'quickbooks';\nelse if (headers['x-toss-signature']) source = 'toss';\n\n// 페이로드 기반\nelse if (data.livemode !== undefined || (data.type && data.type.includes('.'))) source = 'stripe';\nelse if (data.admin_graphql_api_id) source = 'shopify';\nelse if (data.paymentKey || data.orderId) source = 'toss';\nelse if (data.realmId) source = 'quickbooks';\nelse if (data.portalId || data.subscriptionType) source = 'hubspot';\nelse if (data.AccountId || data.sobjectType) source = 'salesforce';\nelse if (data.student_id && data.tuition) source = 'highclass';\nelse if (data.member_no) source = 'academy_plus';\nelse if (data.membership_fee) source = 'gymbox';\n\n// ═══════════════════════════════════════════════════════════════\n// 2. Zero Meaning 정제\n// ═══════════════════════════════════════════════════════════════\nconst mapping = {\n  stripe: { id: ['customer', 'id'], value: ['amount', 100], event: ['type'] },\n  shopify: { id: ['customer.id', 'id'], value: ['total_price', 1], event: ['topic'] },\n  toss: { id: ['orderId'], value: ['totalAmount', 1], event: ['status'] },\n  hubspot: { id: ['properties.hs_contact_id', 'vid'], value: ['properties.amount', 1], event: ['subscriptionType'] },\n  highclass: { id: ['student_id'], value: ['tuition', 1], event: ['event'] },\n  academy_plus: { id: ['member_no'], value: ['pay_amount', 1], event: ['event'] },\n  gymbox: { id: ['member_id'], value: ['membership_fee', 1], event: ['event'] }\n};\n\nconst map = mapping[source] || { id: ['id'], value: ['amount', 1], event: ['event'] };\n\n// 중첩 필드 접근\nfunction getVal(obj, path) {\n  return path.split('.').reduce((o, p) => o && o[p], obj);\n}\n\n// ID 추출\nlet nodeId = null;\nfor (const f of map.id) {\n  const v = f.includes('.') ? getVal(data, f) : data[f];\n  if (v) { nodeId = String(v); break; }\n}\nnodeId = nodeId || 'anon_' + Date.now();\n\n// 금액 추출\nlet value = 0;\nconst [valField, divisor] = Array.isArray(map.value) ? map.value : [map.value, 1];\nfor (const f of (typeof valField === 'string' ? [valField] : map.id)) {\n  const v = f.includes('.') ? getVal(data, f) : data[f];\n  if (v) { value = parseFloat(v) / divisor; break; }\n}\nif (data.amount) value = parseFloat(data.amount) / (map.value[1] || 1);\nif (data.totalAmount) value = parseFloat(data.totalAmount);\nif (data.total_price) value = parseFloat(data.total_price);\nif (data.tuition) value = parseFloat(data.tuition);\nif (data.membership_fee) value = parseFloat(data.membership_fee);\n\n// 흐름 타입\nlet flowType = 'inflow';\nlet eventType = '';\nfor (const f of map.event) {\n  const v = data[f];\n  if (v) { eventType = String(v).toLowerCase(); break; }\n}\nif (eventType.includes('refund') || eventType.includes('cancel') || eventType.includes('dispute')) {\n  flowType = 'outflow';\n}\n\nreturn [{\n  json: {\n    node_id: nodeId,\n    value: value,\n    flow_type: flowType,\n    source: source,\n    event_type: eventType,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "auto_detect",
      "name": "자동 감지 + Zero Meaning",
      "type": "n8n-nodes-base.function",
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.node_id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "has_node_id",
      "name": "노드 ID 있음?",
      "type": "n8n-nodes-base.if",
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/nodes/upsert",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ external_id: $json.node_id, source: $json.source }) }}"
      },
      "id": "upsert_node",
      "name": "노드 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.AUTUS_API_URL }}/motions/create",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ source_id: $json.flow_type === 'inflow' ? $json.node_id : 'owner', target_id: $json.flow_type === 'inflow' ? 'owner' : $json.node_id, amount: $json.value, direction: $json.flow_type }) }}"
      },
      "id": "create_motion",
      "name": "모션 생성",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, action: $json.flow_type + '_created', node_id: $json.node_id, amount: $json.value, detected_source: $json.source } }}"
      },
      "id": "response_success",
      "name": "Response (성공)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1250, 200]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { received: true, action: 'skipped', reason: 'no_node_id', detected_source: $json.source } }}"
      },
      "id": "response_skip",
      "name": "Response (스킵)",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [850, 400]
    }
  ],
  "connections": {
    "Universal Webhook": {
      "main": [[{ "node": "자동 감지 + Zero Meaning", "type": "main", "index": 0 }]]
    },
    "자동 감지 + Zero Meaning": {
      "main": [[{ "node": "노드 ID 있음?", "type": "main", "index": 0 }]]
    },
    "노드 ID 있음?": {
      "main": [
        [{ "node": "노드 생성", "type": "main", "index": 0 }],
        [{ "node": "Response (스킵)", "type": "main", "index": 0 }]
      ]
    },
    "노드 생성": {
      "main": [[{ "node": "모션 생성", "type": "main", "index": 0 }]]
    },
    "모션 생성": {
      "main": [[{ "node": "Response (성공)", "type": "main", "index": 0 }]]
    }
  }
}







