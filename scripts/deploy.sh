#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# AUTUS 배포 스크립트
# ═══════════════════════════════════════════════════════════════════════════════

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

echo "╔══════════════════════════════════════════════════════════════════════════════╗"
echo "║                        AUTUS 배포 스크립트 v1.0                               ║"
echo "╚══════════════════════════════════════════════════════════════════════════════╝"

# ─────────────────────────────────────────────────────────────────────────────
# 1. Frontend 빌드
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo "📦 [1/4] Frontend 빌드..."
cd frontend
npm install --silent
npm run build
cd ..
echo "✅ Frontend 빌드 완료: frontend/dist/"

# ─────────────────────────────────────────────────────────────────────────────
# 2. Backend Docker 이미지 빌드
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo "🐳 [2/4] Backend Docker 이미지 빌드..."
docker build -t autus-api:latest ./backend
echo "✅ Docker 이미지 빌드 완료: autus-api:latest"

# ─────────────────────────────────────────────────────────────────────────────
# 3. Docker Compose 실행
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo "🚀 [3/4] Docker Compose 실행..."
docker-compose up -d db redis api
echo "✅ 서비스 시작됨"

# ─────────────────────────────────────────────────────────────────────────────
# 4. 헬스 체크
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo "🏥 [4/4] 헬스 체크..."
sleep 5
max_attempts=30
attempt=0
while [ $attempt -lt $max_attempts ]; do
    if curl -sf http://localhost:8000/health > /dev/null; then
        echo "✅ API 서버 정상 작동 중"
        break
    fi
    attempt=$((attempt + 1))
    echo "  대기 중... ($attempt/$max_attempts)"
    sleep 2
done

if [ $attempt -eq $max_attempts ]; then
    echo "❌ API 서버 시작 실패"
    docker-compose logs api
    exit 1
fi

# ─────────────────────────────────────────────────────────────────────────────
# 완료
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo "╔══════════════════════════════════════════════════════════════════════════════╗"
echo "║                        AUTUS 배포 완료!                                       ║"
echo "╠══════════════════════════════════════════════════════════════════════════════╣"
echo "║                                                                              ║"
echo "║   🌐 API:        http://localhost:8000                                        ║"
echo "║   📚 API Docs:   http://localhost:8000/docs                                   ║"
echo "║   🔧 Adminer:    http://localhost:8080 (dev 프로필 시)                          ║"
echo "║                                                                              ║"
echo "║   📊 서비스 상태:                                                              ║"
docker-compose ps --format "table {{.Name}}\t{{.Status}}" 2>/dev/null || docker-compose ps
echo "║                                                                              ║"
echo "╚══════════════════════════════════════════════════════════════════════════════╝"
