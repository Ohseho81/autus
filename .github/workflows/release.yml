# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ AUTUS - ë¦´ë¦¬ì¦ˆ ìë™í™”
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# íƒœê·¸ push ì‹œ ìë™ìœ¼ë¡œ GitHub Release ìƒì„±
# ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìë™ ìƒì„± (Conventional Commits ê¸°ë°˜)
#
# ì‚¬ìš©ë²•:
#   git tag v1.0.0
#   git push origin v1.0.0
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'ë²„ì „ (ì˜ˆ: 1.0.0)'
        required: true
      prerelease:
        description: 'í”„ë¦¬ë¦´ë¦¬ì¦ˆ ì—¬ë¶€'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ë¦´ë¦¬ì¦ˆ ìƒì„±
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ìš©)

      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Generate Release Notes
        id: notes
        run: |
          # ì´ì „ íƒœê·¸ ì°¾ê¸°
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
          cat > release_notes.md << 'EOF'
          ## ğŸ‰ AUTUS ${{ steps.version.outputs.version }}
          
          ### âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥
          EOF
          
          # feat ì»¤ë°‹ ìˆ˜ì§‘
          if [[ -n "$PREV_TAG" ]]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^feat" >> release_notes.md || true
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ### ğŸ› ë²„ê·¸ ìˆ˜ì •
          EOF
          
          # fix ì»¤ë°‹ ìˆ˜ì§‘
          if [[ -n "$PREV_TAG" ]]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^fix" >> release_notes.md || true
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ### ğŸ“š ë¬¸ì„œ
          EOF
          
          # docs ì»¤ë°‹ ìˆ˜ì§‘
          if [[ -n "$PREV_TAG" ]]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^docs" >> release_notes.md || true
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ### ğŸ”§ ê¸°íƒ€
          EOF
          
          # ê¸°íƒ€ ì»¤ë°‹ ìˆ˜ì§‘
          if [[ -n "$PREV_TAG" ]]; then
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^chore\|^refactor\|^style\|^perf\|^test" >> release_notes.md || true
          fi
          
          cat >> release_notes.md << 'EOF'
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG:-initial}...${{ steps.version.outputs.version }}
          EOF
          
          echo "Generated release notes:"
          cat release_notes.md

      - name: ğŸ—ï¸ Build Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: ğŸ“¦ Create Release Archive
        run: |
          # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ì••ì¶•
          tar -czf autus-frontend-${{ steps.version.outputs.version }}.tar.gz -C frontend/dist .
          
          # ì†ŒìŠ¤ ì••ì¶• (node_modules, __pycache__ ì œì™¸)
          tar --exclude='node_modules' --exclude='__pycache__' --exclude='.git' \
              -czf autus-source-${{ steps.version.outputs.version }}.tar.gz \
              backend frontend scripts Makefile docker-compose.yml

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: AUTUS ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          files: |
            autus-frontend-${{ steps.version.outputs.version }}.tar.gz
            autus-source-${{ steps.version.outputs.version }}.tar.gz
          generate_release_notes: false

      - name: ğŸ“¢ Notify Release
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "ğŸš€ AUTUS ${{ steps.version.outputs.version }} ë¦´ë¦¬ì¦ˆ ì™„ë£Œ!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ AUTUS ${{ steps.version.outputs.version }} ë¦´ë¦¬ì¦ˆ"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ìƒˆ ë²„ì „ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}|ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ & Push
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker:
    name: Build Docker Image
    needs: release
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') }}
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: ğŸ”¨ Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
