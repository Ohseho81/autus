# ============================================
# AUTUS GitHub Actions - CI/CD ÏûêÎèôÌôî
# ============================================

name: AUTUS Deploy & Monitor

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Îß§Ïùº Ïò§Ï†Ñ 9Ïãú (KST) ÏúÑÌóò ÌïôÏÉù Ïä§Ï∫î
    - cron: '0 0 * * *'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # ============================================
  # 1. ÏûêÎèô Î∞∞Ìè¨
  # ============================================
  deploy:
    name: üöÄ Vercel Î∞∞Ìè¨
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Vercel Î∞∞Ìè¨
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
      
      - name: Slack ÏïåÎ¶º - Î∞∞Ìè¨ ÏôÑÎ£å
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üöÄ AUTUS Î∞∞Ìè¨ ÏôÑÎ£å!\nÏª§Î∞ã: ${{ github.event.head_commit.message }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # 2. PR ÎØ∏Î¶¨Î≥¥Í∏∞ Î∞∞Ìè¨
  # ============================================
  preview:
    name: üëÄ Preview Î∞∞Ìè¨
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Vercel Preview Î∞∞Ìè¨
        uses: amondnet/vercel-action@v25
        id: vercel
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
      
      - name: PRÏóê Preview URL ÏΩîÎ©òÌä∏
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üîó Preview Î∞∞Ìè¨ ÏôÑÎ£å!\n\n${{ steps.vercel.outputs.preview-url }}`
            })

  # ============================================
  # 3. Îß§Ïùº ÏúÑÌóò Ïä§Ï∫î (Ïä§ÏºÄÏ§Ñ)
  # ============================================
  daily-risk-scan:
    name: üîç ÏùºÏùº ÏúÑÌóò Ïä§Ï∫î
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: n8n ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ìä∏Î¶¨Í±∞
        run: |
          curl -X POST "${{ secrets.N8N_WEBHOOK_URL }}/risk-detection" \
            -H "Content-Type: application/json" \
            -d '{"trigger": "github_actions", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}'
      
      - name: Vercel API - Claude Î∂ÑÏÑù Ìò∏Ï∂ú
        run: |
          curl -X POST "https://vercel-api-two-rust.vercel.app/api/brain" \
            -H "Content-Type: application/json" \
            -d '{"action": "analyzeRisk", "payload": {"scope": "all"}}'

  # ============================================
  # 4. Supabase ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
  # ============================================
  migrate:
    name: üóÑÔ∏è DB ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[migrate]')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Supabase CLI ÏÑ§Ïπò
        run: npm install -g supabase
      
      - name: ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìñâ
        run: |
          supabase link --project-ref pphzvnaedmzcvpxjulti
          supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # ============================================
  # 5. Ï£ºÍ∞Ñ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± (Í∏àÏöîÏùº Ïò§Ï†Ñ 9Ïãú KST)
  # ============================================
  weekly-report:
    name: üìä Ï£ºÍ∞Ñ Î¶¨Ìè¨Ìä∏
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Ï£ºÍ∞Ñ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ïó¨Î∂Ä ÌôïÏù∏
        id: check-friday
        run: |
          if [ "$(date +%u)" = "5" ]; then
            echo "is_friday=true" >> $GITHUB_OUTPUT
          fi
      
      - name: n8n Ï£ºÍ∞Ñ Î¶¨Ìè¨Ìä∏ Ìä∏Î¶¨Í±∞
        if: steps.check-friday.outputs.is_friday == 'true'
        run: |
          curl -X POST "${{ secrets.N8N_WEBHOOK_URL }}/weekly-report" \
            -H "Content-Type: application/json" \
            -d '{"trigger": "github_actions", "week": "'$(date +%Y-W%V)'"}'
