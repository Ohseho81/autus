# AUTUS í—Œë²• ìë™ ê²€ì¦
# ëª¨ë“  PR/Pushì—ì„œ í—Œë²• ì¤€ìˆ˜ ì—¬ë¶€ í™•ì¸

name: Constitution Guard

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  constitution-check:
    name: í—Œë²• ê²€ì¦
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ì œ1ë²•ì¹™: íë¦„ (í”„ë¡œí† ì½œ = ê³µê°œ)
      - name: "ì œ1ë²•ì¹™: í”„ë¡œí† ì½œ ê³µê°œ í™•ì¸"
        run: |
          echo "âœ… ì œ1ë²•ì¹™: í”„ë¡œí† ì½œì€ ê³µê°œë˜ì–´ ìˆìŒ"
          test -f spec/PROTOCOL.md && echo "  - PROTOCOL.md ì¡´ì¬" || exit 1
          test -f spec/PACK_FORMAT.md && echo "  - PACK_FORMAT.md ì¡´ì¬" || exit 1

      # ì œ2ë²•ì¹™: ì†Œìœ  (Zero Identity)
      - name: "ì œ2ë²•ì¹™: Zero Identity ê²€ì¦"
        run: |
          echo "ğŸ” ì œ2ë²•ì¹™: PII í•„ë“œ ê²€ì‚¬..."
          
          # ê¸ˆì§€ íŒ¨í„´
          FORBIDDEN="user_id|user_email|user_name|password|ssn|phone_number"
          
          # Python íŒŒì¼ ê²€ì‚¬
          if grep -rE "$FORBIDDEN" --include="*.py" . 2>/dev/null | grep -v "test_" | grep -v "#"; then
            echo "âŒ PII í•„ë“œ ë°œê²¬!"
            exit 1
          fi
          
          echo "âœ… ì œ2ë²•ì¹™: Zero Identity ì¤€ìˆ˜"

      # ì œ3ë²•ì¹™: ìˆœí™˜ (ê¸°ì—¬ = ë³´ìƒ êµ¬ì¡°)
      - name: "ì œ3ë²•ì¹™: ìˆœí™˜ êµ¬ì¡° í™•ì¸"
        run: |
          echo "âœ… ì œ3ë²•ì¹™: ìˆœí™˜ êµ¬ì¡° ë¬¸ì„œ í™•ì¸"
          test -f docs/CONSTITUTION.md && echo "  - í—Œë²• ì¡´ì¬" || exit 1

      # ì œ4ë²•ì¹™: ë¶„ì‚° (ì¤‘ì•™ ì„œë²„ ì˜ì¡´ì„± ìµœì†Œí™”)
      - name: "ì œ4ë²•ì¹™: ë¶„ì‚° êµ¬ì¡° í™•ì¸"
        run: |
          echo "ğŸ” ì œ4ë²•ì¹™: í•˜ë“œì½”ë”©ëœ ì„œë²„ URL ê²€ì‚¬..."
          
          # í—ˆìš©ë˜ì§€ ì•ŠëŠ” ì¤‘ì•™ ì„œë²„ íŒ¨í„´
          if grep -rE "https?://autus\.(com|io|ai)" --include="*.py" . 2>/dev/null | grep -v "#" | grep -v "example"; then
            echo "âš ï¸ ì¤‘ì•™ ì„œë²„ URL ë°œê²¬ (í™•ì¸ í•„ìš”)"
          fi
          
          echo "âœ… ì œ4ë²•ì¹™: ë¶„ì‚° êµ¬ì¡° í™•ì¸ ì™„ë£Œ"

      # ì œ5ë²•ì¹™: ì ì‘ (í¬ë¡œìŠ¤í”Œë«í¼)
      - name: "ì œ5ë²•ì¹™: Python í˜¸í™˜ì„±"
        run: |
          echo "âœ… ì œ5ë²•ì¹™: Python 3.11+ ì§€ì›"

      # ì œ6ë²•ì¹™: ì°½ë°œ (í…ŒìŠ¤íŠ¸)
      - name: "ì œ6ë²•ì¹™: í…ŒìŠ¤íŠ¸ ì¡´ì¬ í™•ì¸"
        run: |
          echo "ğŸ” ì œ6ë²•ì¹™: í…ŒìŠ¤íŠ¸ íŒŒì¼ í™•ì¸..."
          
          if [ -d "tests" ]; then
            TEST_COUNT=$(find tests -name "test_*.py" | wc -l)
            echo "  - í…ŒìŠ¤íŠ¸ íŒŒì¼: $TEST_COUNT ê°œ"
            if [ "$TEST_COUNT" -lt 1 ]; then
              echo "âš ï¸ í…ŒìŠ¤íŠ¸ íŒŒì¼ ë¶€ì¡±"
            fi
          fi
          
          echo "âœ… ì œ6ë²•ì¹™: í…ŒìŠ¤íŠ¸ êµ¬ì¡° í™•ì¸ ì™„ë£Œ"

      # ì œ13ë²•ì¹™: ìë¹„ (ì—ëŸ¬ ì²˜ë¦¬)
      - name: "ì œ13ë²•ì¹™: ìë¹„ - ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸"
        run: |
          echo "ğŸ” ì œ13ë²•ì¹™: try-except íŒ¨í„´ í™•ì¸..."
          
          # ì£¼ìš” íŒŒì¼ì— ì—ëŸ¬ ì²˜ë¦¬ ì¡´ì¬ í™•ì¸
          if [ -f "main.py" ]; then
            if grep -q "try:" main.py; then
              echo "  - main.py: ì—ëŸ¬ ì²˜ë¦¬ ìˆìŒ"
            fi
          fi
          
          echo "âœ… ì œ13ë²•ì¹™: ìë¹„ êµ¬ì¡° í™•ì¸ ì™„ë£Œ"

      # í—Œë²• ë¬¸ì„œ ì¡´ì¬ í™•ì¸
      - name: "í—Œë²• ë¬¸ì„œ í™•ì¸"
        run: |
          echo "ğŸ“œ í—Œë²• ë¬¸ì„œ ê²€ì¦..."
          
          test -f docs/CONSTITUTION.md && echo "  âœ… CONSTITUTION.md" || exit 1
          test -f docs/SUCCESSION.md && echo "  âœ… SUCCESSION.md" || exit 1
          
          echo "âœ… ëª¨ë“  í—Œë²• ë¬¸ì„œ ì¡´ì¬"

      # ìµœì¢… ê²°ê³¼
      - name: "ğŸ‰ í—Œë²• ê²€ì¦ ì™„ë£Œ"
        run: |
          echo ""
          echo "=================================="
          echo "âœ… AUTUS í—Œë²• ê²€ì¦ í†µê³¼"
          echo "=================================="
          echo ""
          echo "ìì—°ì„ 99.9% ë”°ë¥´ë˜,"
          echo "ì¸ê°„ì´ ë¶ˆí–‰í•´ì§€ì§€ ì•ŠëŠ” ë°©í–¥ì„"
          echo "ëŠì„ì—†ì´ ì°¾ëŠ”ë‹¤."
          echo ""

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: constitution-check
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest tests/ -v --ignore=tests/load_test.py || true
          echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # ë³´ì•ˆ ê²€ì‚¬
  security:
    name: ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ğŸ”’ ë¯¼ê° ì •ë³´ ê²€ì‚¬"
        run: |
          echo "ğŸ” ë¯¼ê° ì •ë³´ íŒ¨í„´ ê²€ì‚¬..."
          
          # API í‚¤ íŒ¨í„´
          if grep -rE "(api_key|apikey|secret_key|password)\s*=\s*['\"][^'\"]+['\"]" --include="*.py" . 2>/dev/null | grep -v "example" | grep -v "test" | grep -v "#"; then
            echo "âš ï¸ í•˜ë“œì½”ë”©ëœ ë¯¼ê° ì •ë³´ ë°œê²¬ ê°€ëŠ¥ì„±"
          fi
          
          echo "âœ… ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
