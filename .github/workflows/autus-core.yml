name: AUTUS Core CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pydantic pyyaml python-dotenv fastapi httpx uvicorn qrcode pillow
      
      - name: Run tests
        run: pytest tests/ -v --tb=short
      
      - name: Check syntax (all Python files)
        run: python -m compileall . -q
      
      - name: Validate constitution.yaml
        run: python -c "import yaml; yaml.safe_load(open('constitution.yaml')); print('✅ constitution.yaml is valid')"
      
      - name: Validate policies
        run: |
          python -c "import yaml; yaml.safe_load(open('policies/global.yaml')); print('✅ global.yaml is valid')"
          python -c "import yaml; yaml.safe_load(open('policies/city_clark.yaml')); print('✅ city_clark.yaml is valid')"
      
      - name: Validate rules
        run: |
          python -c "import yaml; yaml.safe_load(open('rules/view_scope.yaml')); print('✅ view_scope.yaml is valid')"
          python -c "import yaml; yaml.safe_load(open('rules/auth_scopes.yaml')); print('✅ auth_scopes.yaml is valid')"
      
      - name: Test imports
        run: |
          python -c "from protocols.reality import RealityEvent; print('✅ RealityEvent import OK')"
          python -c "from protocols.rules import RuleEngine; print('✅ RuleEngine import OK')"
          python -c "from engines import Telemetry; print('✅ Telemetry import OK')"

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install ruff
        run: pip install ruff
      
      - name: Run linter
        run: ruff check . --ignore=E501,F401 || true  # Don't fail on lint errors yet



