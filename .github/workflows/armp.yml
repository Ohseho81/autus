name: ARMP Compliance

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  armp-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov bandit safety

    - name: ğŸ” PII Scanner
      run: |
        echo "::group::PII Compliance Check"
        python -m core.armp.scanners.pii_scanner
        echo "::endgroup::"

    - name: ğŸ” Code Security Scanner
      run: |
        echo "::group::Code Security Check"
        python -m core.armp.scanners.code_scanner
        echo "::endgroup::"

    - name: ğŸ” Constitution Checker
      run: |
        echo "::group::Constitution Compliance"
        python -m core.armp.scanners.constitution_checker
        echo "::endgroup::"

    - name: ğŸ”’ Security Scan (Bandit)
      run: |
        echo "::group::Bandit Security Scan"
        bandit -r core/ protocols/ -f json -o bandit-report.json || true
        bandit -r core/ protocols/ -ll
        echo "::endgroup::"

    - name: ğŸ”’ Dependency Check (Safety)
      run: |
        echo "::group::Dependency Security Check"
        safety check --json || true
        safety check
        echo "::endgroup::"

    - name: ğŸ§ª Run Tests
      run: |
        echo "::group::Test Suite"
        pytest tests/ -v --cov=. --cov-report=term --cov-report=xml
        echo "::endgroup::"

    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: âœ… ARMP Compliance Summary
      if: always()
      run: |
        echo "::notice::ARMP Compliance Check Completed"
        echo "Review the logs above for any violations"




