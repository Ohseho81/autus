# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¥ AUTUS - í—¬ìŠ¤ì²´í¬ & ëª¨ë‹ˆí„°ë§
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ì •ê¸°ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ë° ì•Œë¦¼
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Health Check

on:
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤
    - cron: '*/30 * * * *'
  
  workflow_dispatch:

env:
  API_URL: ${{ vars.API_URL || 'https://api.autus.app' }}
  FRONTEND_URL: ${{ vars.FRONTEND_URL || 'https://autus.app' }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # API í—¬ìŠ¤ì²´í¬
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  api-health:
    name: API Health Check
    runs-on: ubuntu-latest
    
    outputs:
      status: ${{ steps.check.outputs.status }}
      response_time: ${{ steps.check.outputs.response_time }}
    
    steps:
      - name: ğŸ¥ Check API Health
        id: check
        run: |
          START=$(date +%s%N)
          
          # API í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            "${{ env.API_URL }}/health" || echo "000")
          
          END=$(date +%s%N)
          RESPONSE_TIME=$(( (END - START) / 1000000 ))
          
          echo "response_time=${RESPONSE_TIME}ms" >> $GITHUB_OUTPUT
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… API ì •ìƒ (${RESPONSE_TIME}ms)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ API ì´ìƒ (HTTP $HTTP_CODE)"
          fi

      - name: ğŸ“Š Check API Docs
        run: |
          curl -sf "${{ env.API_URL }}/docs" > /dev/null && \
            echo "âœ… API Docs ì ‘ê·¼ ê°€ëŠ¥" || \
            echo "âš ï¸ API Docs ì ‘ê·¼ ë¶ˆê°€"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Frontend í—¬ìŠ¤ì²´í¬
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  frontend-health:
    name: Frontend Health Check
    runs-on: ubuntu-latest
    
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: ğŸŒ Check Frontend
        id: check
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            "${{ env.FRONTEND_URL }}" || echo "000")
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Frontend ì •ìƒ"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Frontend ì´ìƒ (HTTP $HTTP_CODE)"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Database í—¬ìŠ¤ì²´í¬ (Supabase)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  database-health:
    name: Database Health Check
    runs-on: ubuntu-latest
    if: ${{ secrets.SUPABASE_URL }}
    
    outputs:
      status: ${{ steps.check.outputs.status }}
    
    steps:
      - name: ğŸ—„ï¸ Check Database
        id: check
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/" || echo "000")
          
          if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "401" ]]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Database ì—°ê²° ê°€ëŠ¥"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Database ì—°ê²° ë¶ˆê°€"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ê²°ê³¼ ì•Œë¦¼
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: Send Notification
    needs: [api-health, frontend-health]
    runs-on: ubuntu-latest
    if: |
      always() && 
      (needs.api-health.outputs.status == 'unhealthy' || 
       needs.frontend-health.outputs.status == 'unhealthy')
    
    steps:
      - name: ğŸš¨ Alert - Service Down
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "ğŸš¨ AUTUS ì„œë¹„ìŠ¤ ì´ìƒ ê°ì§€!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš¨ ì„œë¹„ìŠ¤ ì´ìƒ ê°ì§€"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*API*\n${{ needs.api-health.outputs.status == 'healthy' && 'âœ… ì •ìƒ' || 'âŒ ì´ìƒ' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Frontend*\n${{ needs.frontend-health.outputs.status == 'healthy' && 'âœ… ì •ìƒ' || 'âŒ ì´ìƒ' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ë‹µ ì‹œê°„*\n${{ needs.api-health.outputs.response_time }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‹œê°„*\n$(date)"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "GitHub Actions í™•ì¸"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: ğŸ“§ Discord Alert
        if: ${{ secrets.DISCORD_WEBHOOK_URL }}
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: failure
          title: "ğŸš¨ AUTUS ì„œë¹„ìŠ¤ ì´ìƒ"
          description: |
            API: ${{ needs.api-health.outputs.status }}
            Frontend: ${{ needs.frontend-health.outputs.status }}
          color: 0xff0000
          username: "AUTUS Monitor"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ìƒíƒœ ë¦¬í¬íŠ¸ (ì •ìƒ ì‹œ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  status-report:
    name: Status Report
    needs: [api-health, frontend-health]
    runs-on: ubuntu-latest
    if: |
      always() && 
      needs.api-health.outputs.status == 'healthy' && 
      needs.frontend-health.outputs.status == 'healthy'
    
    steps:
      - name: âœ… All Services Healthy
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… AUTUS ì„œë¹„ìŠ¤ ìƒíƒœ: ì •ìƒ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  API: ${{ needs.api-health.outputs.status }}"
          echo "  API ì‘ë‹µì‹œê°„: ${{ needs.api-health.outputs.response_time }}"
          echo "  Frontend: ${{ needs.frontend-health.outputs.status }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
