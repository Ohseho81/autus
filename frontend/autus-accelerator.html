<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AUTUS — Decision Accelerator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      background: #000;
      color: #fff;
      font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', sans-serif;
    }

    .container {
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════════════════════════
       SECTION 1: DECISION DASHBOARD (Tesla 계기판)
       ═══════════════════════════════════════════════════════════ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 16px;
      background: linear-gradient(180deg, #111 0%, #000 100%);
    }

    .gauge {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 20px 12px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .gauge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gauge-color, #00ff88);
      opacity: 0.5;
    }

    .gauge-icon {
      font-size: 20px;
      margin-bottom: 8px;
      opacity: 0.6;
    }

    .gauge-value {
      font-size: 22px;
      font-weight: 700;
      font-family: 'SF Mono', 'Menlo', monospace;
      color: var(--gauge-color, #fff);
      margin-bottom: 4px;
    }

    .gauge-label {
      font-size: 9px;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    .gauge.velocity { --gauge-color: #ff6b6b; }
    .gauge.energy { --gauge-color: #00ff88; }
    .gauge.radar { --gauge-color: #ffaa00; }

    /* ═══════════════════════════════════════════════════════════
       SECTION 2: COST NAVIGATION (Tesla 네비)
       ═══════════════════════════════════════════════════════════ */
    .navigation {
      padding: 24px 16px;
      background: #000;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .nav-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .nav-point {
      text-align: center;
    }

    .nav-point-label {
      font-size: 10px;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .nav-point-value {
      font-size: 18px;
      font-weight: 600;
      font-family: 'SF Mono', monospace;
      margin-top: 4px;
    }

    .nav-point.now .nav-point-value { color: #00ff88; }
    .nav-point.pnr .nav-point-value { color: #ff4444; }

    .nav-track {
      position: relative;
      height: 60px;
      margin: 16px 0;
    }

    #nav-canvas {
      width: 100%;
      height: 100%;
    }

    .nav-eta {
      text-align: center;
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }

    .nav-eta strong {
      color: #ff4444;
    }

    /* ═══════════════════════════════════════════════════════════
       SECTION 3: MISSION CONTROL (SpaceX 관제)
       ═══════════════════════════════════════════════════════════ */
    .mission {
      flex: 1;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #000;
    }

    .orbit-container {
      width: 100%;
      max-width: 300px;
      aspect-ratio: 1;
      position: relative;
    }

    #orbit-canvas {
      width: 100%;
      height: 100%;
    }

    .mission-stats {
      width: 100%;
      max-width: 400px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 24px;
    }

    .stat-box {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      padding: 16px;
    }

    .stat-label {
      font-size: 9px;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      font-family: 'SF Mono', monospace;
    }

    .stability-track {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .stability-fill {
      height: 100%;
      background: #00ff88;
      transition: width 0.5s ease;
    }

    .phase-indicator {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 400px;
      margin-top: 24px;
      padding: 0 8px;
    }

    .phase-dot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .phase-circle {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.3s;
    }

    .phase-circle.active {
      background: #00ff88;
      box-shadow: 0 0 12px rgba(0,255,136,0.5);
    }

    .phase-circle.passed {
      background: rgba(0,255,136,0.4);
    }

    .phase-label {
      font-size: 8px;
      color: rgba(255,255,255,0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .phase-dot.active .phase-label {
      color: #00ff88;
    }

    /* ═══════════════════════════════════════════════════════════
       SECTION 4: ACTION
       ═══════════════════════════════════════════════════════════ */
    .action-section {
      padding: 24px 16px;
      padding-bottom: calc(24px + env(safe-area-inset-bottom));
      background: linear-gradient(0deg, #000 0%, transparent 100%);
      position: sticky;
      bottom: 0;
    }

    .action-btn {
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      display: block;
      padding: 20px 32px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: #222;
      color: #555;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: not-allowed;
      transition: all 0.3s;
    }

    .action-btn.enabled {
      background: #fff;
      color: #000;
      border-color: #fff;
      cursor: pointer;
      animation: pulse 2s infinite;
    }

    .action-btn.enabled:active {
      transform: scale(0.98);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); }
      50% { box-shadow: 0 0 20px 4px rgba(255,255,255,0.2); }
    }

    /* ═══════════════════════════════════════════════════════════
       SECTION 5: VALUE ACCUMULATION (도착 후)
       ═══════════════════════════════════════════════════════════ */
    .accumulation {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 100;
      animation: fadeIn 0.5s;
    }

    .accumulation.hidden { display: none; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .success-icon {
      width: 80px;
      height: 80px;
      border: 2px solid #00ff88;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #00ff88;
      margin-bottom: 16px;
    }

    .success-text {
      font-size: 20px;
      font-weight: 300;
      margin-bottom: 8px;
    }

    .audit-id {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
      font-family: 'SF Mono', monospace;
      margin-bottom: 32px;
    }

    .value-stats {
      display: flex;
      gap: 32px;
      margin-bottom: 32px;
    }

    .value-stat {
      text-align: center;
    }

    .value-stat-label {
      font-size: 9px;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .value-stat-value {
      font-size: 24px;
      font-weight: 600;
      font-family: 'SF Mono', monospace;
    }

    .value-stat-value.highlight {
      color: #00ff88;
    }

    .acceleration-note {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      text-align: center;
      max-width: 280px;
      line-height: 1.5;
    }

    /* ═══════════════════════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════════════════════ */
    @media (max-width: 380px) {
      .dashboard { gap: 8px; padding: 12px; }
      .gauge { padding: 16px 8px; }
      .gauge-value { font-size: 18px; }
      .value-stats { gap: 20px; }
      .value-stat-value { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="container" id="main-container">
    <!-- SECTION 1: DECISION DASHBOARD -->
    <section class="dashboard">
      <div class="gauge velocity">
        <div class="gauge-icon">⚡</div>
        <div class="gauge-value" id="velocity-value">+₩41K</div>
        <div class="gauge-label">Cost Velocity</div>
      </div>
      <div class="gauge energy">
        <div class="gauge-icon">◐</div>
        <div class="gauge-value" id="energy-value">72%</div>
        <div class="gauge-label">Value Energy</div>
      </div>
      <div class="gauge radar">
        <div class="gauge-icon">◎</div>
        <div class="gauge-value" id="radar-value">14d</div>
        <div class="gauge-label">Risk Proximity</div>
      </div>
    </section>

    <!-- SECTION 2: COST NAVIGATION -->
    <section class="navigation">
      <div class="nav-header">
        <div class="nav-point now">
          <div class="nav-point-label">Now</div>
          <div class="nav-point-value" id="nav-now">₩12.4M</div>
        </div>
        <div class="nav-point pnr">
          <div class="nav-point-label">PNR</div>
          <div class="nav-point-value" id="nav-pnr">₩48M</div>
        </div>
      </div>
      <div class="nav-track">
        <canvas id="nav-canvas"></canvas>
      </div>
      <div class="nav-eta">
        PNR까지 <strong id="pnr-days">14일</strong>
      </div>
    </section>

    <!-- SECTION 3: MISSION CONTROL -->
    <section class="mission">
      <div class="orbit-container">
        <canvas id="orbit-canvas"></canvas>
      </div>
      
      <div class="mission-stats">
        <div class="stat-box">
          <div class="stat-label">Stability</div>
          <div class="stat-value" id="stability-value">82%</div>
          <div class="stability-track">
            <div class="stability-fill" id="stability-fill" style="width: 82%"></div>
          </div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Failure Cost</div>
          <div class="stat-value" id="failure-value">₩3.2M</div>
        </div>
      </div>

      <div class="phase-indicator">
        <div class="phase-dot" data-phase="approach">
          <div class="phase-circle passed"></div>
          <div class="phase-label">Approach</div>
        </div>
        <div class="phase-dot active" data-phase="entry">
          <div class="phase-circle active"></div>
          <div class="phase-label">Entry</div>
        </div>
        <div class="phase-dot" data-phase="descent">
          <div class="phase-circle"></div>
          <div class="phase-label">Descent</div>
        </div>
        <div class="phase-dot" data-phase="landing">
          <div class="phase-circle"></div>
          <div class="phase-label">Landing</div>
        </div>
      </div>
    </section>

    <!-- SECTION 4: ACTION -->
    <section class="action-section">
      <button class="action-btn" id="action-btn">선택</button>
    </section>
  </div>

  <!-- SECTION 5: VALUE ACCUMULATION -->
  <div class="accumulation hidden" id="accumulation">
    <div class="success-icon">✓</div>
    <div class="success-text">기록됨</div>
    <div class="audit-id" id="audit-id">AUD-20251221-001</div>
    
    <div class="value-stats">
      <div class="value-stat">
        <div class="value-stat-label">Value Gained</div>
        <div class="value-stat-value" id="value-gained">₩8.4M</div>
      </div>
      <div class="value-stat">
        <div class="value-stat-label">Decisions</div>
        <div class="value-stat-value" id="decision-count">12회</div>
      </div>
      <div class="value-stat">
        <div class="value-stat-label">Next Velocity</div>
        <div class="value-stat-value highlight" id="next-velocity">×1.3</div>
      </div>
    </div>
    
    <div class="acceleration-note">
      다음 결정의 비용 계산이 30% 더 정확해집니다
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      // ═══════════════════════════════════════════════════════════
      // CONFIG
      // ═══════════════════════════════════════════════════════════
      const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000' 
        : 'https://autus-production.up.railway.app';

      // ═══════════════════════════════════════════════════════════
      // STATE
      // ═══════════════════════════════════════════════════════════
      const STATE = {
        velocity: 41000,
        energy: 72,
        pnrDays: 14,
        currentCost: 12400000,
        projectedCost: 48000000,
        stability: 82,
        failureCost: 3200000,
        phase: 'ENTRY',  // APPROACH, ENTRY, DESCENT, LANDING
        totalDecisions: 11,
        costs: {
          time: 2100000,
          risk: 3500000,
          resource: 1200000,
          position: 2000000,
          learning: 1500000,
          trust: 1600000,
          irreversibility: 500000
        }
      };

      // Elements
      const els = {
        velocityValue: document.getElementById('velocity-value'),
        energyValue: document.getElementById('energy-value'),
        radarValue: document.getElementById('radar-value'),
        navNow: document.getElementById('nav-now'),
        navPnr: document.getElementById('nav-pnr'),
        pnrDays: document.getElementById('pnr-days'),
        navCanvas: document.getElementById('nav-canvas'),
        orbitCanvas: document.getElementById('orbit-canvas'),
        stabilityValue: document.getElementById('stability-value'),
        stabilityFill: document.getElementById('stability-fill'),
        failureValue: document.getElementById('failure-value'),
        actionBtn: document.getElementById('action-btn'),
        accumulation: document.getElementById('accumulation'),
        mainContainer: document.getElementById('main-container'),
        auditId: document.getElementById('audit-id'),
        valueGained: document.getElementById('value-gained'),
        decisionCount: document.getElementById('decision-count'),
        nextVelocity: document.getElementById('next-velocity')
      };

      // ═══════════════════════════════════════════════════════════
      // INIT
      // ═══════════════════════════════════════════════════════════
      function init() {
        fetchState();
        updateDashboard();
        drawNavigation();
        drawOrbit();
        updatePhase();
        setupEvents();
        startSimulation();
      }

      // ═══════════════════════════════════════════════════════════
      // FETCH STATE
      // ═══════════════════════════════════════════════════════════
      async function fetchState() {
        try {
          const res = await fetch(`${API_BASE}/api/v1/physics/solar-binding`);
          const data = await res.json();
          
          if (data.loss_rate) STATE.velocity = data.loss_rate;
          if (data.pnr_days !== undefined) STATE.pnrDays = data.pnr_days;
          if (data.total_loss) STATE.currentCost = data.total_loss;
          if (data.costs) STATE.costs = data.costs;
          
          // Energy = 1 - (currentCost / projectedCost)
          STATE.energy = Math.max(0, Math.round((1 - STATE.currentCost / STATE.projectedCost) * 100));
          
          // Stability from risk
          if (data.risk) STATE.stability = Math.max(0, 100 - data.risk);
          
          updateDashboard();
          drawNavigation();
        } catch (e) {
          console.log('[AUTUS] Using local state');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // DASHBOARD
      // ═══════════════════════════════════════════════════════════
      function updateDashboard() {
        els.velocityValue.textContent = `+₩${Math.round(STATE.velocity/1000)}K`;
        els.energyValue.textContent = `${STATE.energy}%`;
        els.radarValue.textContent = `${STATE.pnrDays}d`;
        els.navNow.textContent = `₩${(STATE.currentCost/1000000).toFixed(1)}M`;
        els.navPnr.textContent = `₩${(STATE.projectedCost/1000000).toFixed(0)}M`;
        els.pnrDays.textContent = `${STATE.pnrDays}일`;
        els.stabilityValue.textContent = `${STATE.stability}%`;
        els.stabilityFill.style.width = `${STATE.stability}%`;
        els.stabilityFill.style.background = STATE.stability > 70 ? '#00ff88' : STATE.stability > 40 ? '#ffaa00' : '#ff4444';
        els.failureValue.textContent = `₩${(STATE.failureCost/1000000).toFixed(1)}M`;
      }

      // ═══════════════════════════════════════════════════════════
      // NAVIGATION CANVAS
      // ═══════════════════════════════════════════════════════════
      function drawNavigation() {
        const canvas = els.navCanvas;
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        
        canvas.width = rect.width * 2;
        canvas.height = rect.height * 2;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.scale(2, 2);

        const w = rect.width;
        const h = rect.height;
        const padding = 20;

        // Clear
        ctx.clearRect(0, 0, w, h);

        // Draw curve
        ctx.beginPath();
        ctx.moveTo(padding, h - 10);
        
        // Exponential curve
        for (let x = padding; x <= w - padding; x++) {
          const t = (x - padding) / (w - padding * 2);
          const y = h - 10 - (Math.pow(t, 1.8) * (h - 20));
          ctx.lineTo(x, y);
        }
        
        ctx.strokeStyle = 'rgba(255,68,68,0.6)';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Gradient fill
        const gradient = ctx.createLinearGradient(0, h, 0, 0);
        gradient.addColorStop(0, 'rgba(255,68,68,0)');
        gradient.addColorStop(1, 'rgba(255,68,68,0.15)');
        
        ctx.lineTo(w - padding, h - 10);
        ctx.lineTo(padding, h - 10);
        ctx.fillStyle = gradient;
        ctx.fill();

        // NOW dot
        ctx.beginPath();
        ctx.arc(padding, h - 10, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#00ff88';
        ctx.fill();

        // PNR dot
        ctx.beginPath();
        ctx.arc(w - padding, 10, 6, 0, Math.PI * 2);
        ctx.fillStyle = '#ff4444';
        ctx.fill();
      }

      // ═══════════════════════════════════════════════════════════
      // ORBIT CANVAS (Value Orbit)
      // ═══════════════════════════════════════════════════════════
      function drawOrbit() {
        const canvas = els.orbitCanvas;
        const ctx = canvas.getContext('2d');
        const rect = canvas.parentElement.getBoundingClientRect();
        
        canvas.width = rect.width * 2;
        canvas.height = rect.height * 2;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.scale(2, 2);

        const w = rect.width;
        const h = rect.height;
        const cx = w / 2;
        const cy = h / 2;
        const maxR = Math.min(w, h) / 2 - 20;

        const costTypes = [
          { key: 'time', color: '#4ECDC4' },
          { key: 'risk', color: '#FF6B6B' },
          { key: 'resource', color: '#45B7D1' },
          { key: 'position', color: '#96CEB4' },
          { key: 'learning', color: '#FFEAA7' },
          { key: 'trust', color: '#DDA0DD' },
          { key: 'irreversibility', color: '#FF4444' }
        ];

        const startAngles = costTypes.map(() => Math.random() * Math.PI * 2);
        const total = Object.values(STATE.costs).reduce((a, b) => a + b, 0);

        function render() {
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, w, h);

          // Mission Target (center)
          const targetSize = maxR * 0.12;
          const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, targetSize);
          grad.addColorStop(0, '#00ff88');
          grad.addColorStop(0.6, '#00aa55');
          grad.addColorStop(1, 'rgba(0,170,85,0)');
          ctx.beginPath();
          ctx.arc(cx, cy, targetSize, 0, Math.PI * 2);
          ctx.fillStyle = grad;
          ctx.fill();

          // Target icon
          ctx.fillStyle = '#000';
          ctx.font = '16px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('◉', cx, cy);

          // Value vectors (planets)
          const time = Date.now() / 1000;

          costTypes.forEach((type, i) => {
            const value = STATE.costs[type.key];
            const ratio = value / total;
            const orbit = maxR * (0.3 + i * 0.09);
            const speed = 0.012 - (ratio * 0.006);
            const angle = startAngles[i] + time * speed;
            const x = cx + Math.cos(angle) * orbit;
            const y = cy + Math.sin(angle) * orbit;

            // Orbit line
            ctx.beginPath();
            ctx.arc(cx, cy, orbit, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(255,255,255,0.04)';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Planet
            const size = 4 + (ratio * 16);
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fillStyle = type.color;
            ctx.fill();

            // Glow
            ctx.beginPath();
            ctx.arc(x, y, size + 3, 0, Math.PI * 2);
            ctx.fillStyle = type.color + '20';
            ctx.fill();
          });

          requestAnimationFrame(render);
        }

        render();
      }

      // ═══════════════════════════════════════════════════════════
      // PHASE
      // ═══════════════════════════════════════════════════════════
      function updatePhase() {
        const phases = ['approach', 'entry', 'descent', 'landing'];
        const currentIndex = phases.indexOf(STATE.phase.toLowerCase());

        document.querySelectorAll('.phase-dot').forEach((dot, i) => {
          const circle = dot.querySelector('.phase-circle');
          
          dot.classList.remove('active');
          circle.classList.remove('active', 'passed');
          
          if (i < currentIndex) {
            circle.classList.add('passed');
          } else if (i === currentIndex) {
            dot.classList.add('active');
            circle.classList.add('active');
          }
        });

        // Enable action button in DESCENT phase
        if (STATE.phase === 'DESCENT') {
          els.actionBtn.classList.add('enabled');
        } else {
          els.actionBtn.classList.remove('enabled');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // EVENTS
      // ═══════════════════════════════════════════════════════════
      function setupEvents() {
        els.actionBtn.addEventListener('click', executeAction);
        
        window.addEventListener('resize', () => {
          drawNavigation();
        });
      }

      async function executeAction() {
        if (!els.actionBtn.classList.contains('enabled')) return;

        // Calculate values
        const valueGained = STATE.currentCost * 0.7;  // 70% 회수
        const nextVelocity = 1 + (STATE.totalDecisions * 0.05);

        // Call API
        try {
          const res = await fetch(`${API_BASE}/api/v1/action/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'SELECT',
              phase: STATE.phase,
              total_cost: STATE.currentCost,
              costs: STATE.costs,
              pnr_days: STATE.pnrDays
            })
          });
          const data = await res.json();
          showAccumulation(data.audit_id || `AUD-${Date.now()}`, valueGained, nextVelocity);
        } catch (e) {
          showAccumulation(`AUD-${Date.now()}`, valueGained, nextVelocity);
        }
      }

      function showAccumulation(auditId, valueGained, nextVelocity) {
        // Update accumulation screen
        els.auditId.textContent = auditId;
        els.valueGained.textContent = `₩${(valueGained/1000000).toFixed(1)}M`;
        els.decisionCount.textContent = `${STATE.totalDecisions + 1}회`;
        els.nextVelocity.textContent = `×${nextVelocity.toFixed(1)}`;

        // Show accumulation
        els.mainContainer.style.display = 'none';
        els.accumulation.classList.remove('hidden');

        // Lock navigation
        window.history.pushState(null, '', window.location.pathname);
        window.addEventListener('popstate', () => {
          window.history.pushState(null, '', window.location.pathname);
        });
      }

      // ═══════════════════════════════════════════════════════════
      // SIMULATION
      // ═══════════════════════════════════════════════════════════
      function startSimulation() {
        // Phase progression simulation
        setTimeout(() => {
          STATE.phase = 'DESCENT';
          updatePhase();
        }, 5000);

        // Cost erosion simulation
        setInterval(() => {
          if (STATE.phase === 'LANDING') return;
          
          STATE.currentCost += Math.round(STATE.velocity / 86400 * 10);
          STATE.pnrDays = Math.max(0, STATE.pnrDays - 0.01);
          STATE.energy = Math.max(0, STATE.energy - 0.05);
          
          updateDashboard();
        }, 1000);
      }

      // ═══════════════════════════════════════════════════════════
      // START
      // ═══════════════════════════════════════════════════════════
      document.readyState === 'loading'
        ? document.addEventListener('DOMContentLoaded', init)
        : init();

    })();
  </script>
</body>
</html>
