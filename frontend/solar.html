<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AUTUS Solar HQ â€” 7 Layer Complete</title>
  <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  AUTUS SOLAR HQ â€” 7 LAYER COMPLETE                            â•‘
    â•‘                                                               â•‘
    â•‘  L0 SOLAR      - Base Reality (9í–‰ì„± íƒœì–‘ê³„)                   â•‘
    â•‘  L1 CORE       - í—Œë²•/ê¸°ì¤€/ì œì•½                                â•‘
    â•‘  L2 SIMULATION - ì˜ˆì¸¡ ë§ (Forecast)                           â•‘
    â•‘  L3 ACTION     - HUD ë²„íŠ¼ (Preview-only)                      â•‘
    â•‘  L4 AUDIT      - íŒì •/ë½ì¸ ì˜¤ë²„ë ˆì´                            â•‘
    â•‘  L5 MEMORY     - íƒ€ì„ë¼ì¸/ë¡œê·¸                                 â•‘
    â•‘  L6 GOVERNANCE - Phase 2 (ë¯¸êµ¬í˜„)                             â•‘
    â•‘  L7 SYSTEM     - ì—”ì§„/ì„±ëŠ¥ ìƒíƒœ                                â•‘
    â•‘                                                               â•‘
    â•‘  PHYSICS KERNEL v2.2 â€” FROZEN                                  â•‘
    â•‘  Law 4/5/6/7 + Single Bottleneck + ImpulseProfiles            â•‘
    â•‘  BUILD: 2025-12-18                                            â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <style>
    /* ============================================
       CSS VARIABLES & FREEZE STATES
       LIQUID GLASS + NEO-TACTILE DESIGN SYSTEM
       ============================================ */
    :root {
      --freeze-level: 0;
      --primary-hue: 190;
      --alert-hue: 190;
      --motion-speed: 1.0;
      --global-opacity: 1.0;
      --overlay-opacity: 0;
      
      /* === LIQUID GLASS DESIGN SYSTEM === */
      /* Primary Gradient */
      --primary-start: #00D4AA;
      --primary-end: #00B4D8;
      --primary-gradient: linear-gradient(135deg, var(--primary-start), var(--primary-end));
      
      /* Neon Glow */
      --neon-cyan: #00F5FF;
      --neon-glow: 0 0 20px rgba(0, 245, 255, 0.5);
      --neon-glow-strong: 0 0 30px rgba(0, 245, 255, 0.7), 0 0 60px rgba(0, 245, 255, 0.3);
      
      /* Glass Effect */
      --glass-bg: rgba(10, 20, 40, 0.75);
      --glass-border: rgba(0, 212, 255, 0.2);
      --glass-blur: blur(20px);
      
      /* Status Colors */
      --success: #00D4AA;
      --warning: #FFB800;
      --danger: #FF4757;
      --info: #00B4D8;
      
      /* Text */
      --text-primary: #FFFFFF;
      --text-secondary: #A0AEC0;
      --text-muted: #718096;
      
      /* Spacing */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }
    
    body.freeze-caution {
      --freeze-level: 1;
      --primary-hue: 45;
      --alert-hue: 45;
      --motion-speed: 0.7;
    }
    
    body.freeze-frozen {
      --freeze-level: 2;
      --primary-hue: 210;
      --alert-hue: 210;
      --motion-speed: 0.2;
      --global-opacity: 0.8;
      --overlay-opacity: 0.15;
    }
    
    body.freeze-lockdown {
      --freeze-level: 3;
      --primary-hue: 0;
      --alert-hue: 0;
      --motion-speed: 0;
      --global-opacity: 0.9;
      --overlay-opacity: 0.25;
    }
    
    /* ============================================
       RESET & BASE
       ============================================ */
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:#020408;
      overflow:hidden;
      font-family:'Inter','SF Pro Display',system-ui,sans-serif;
      color:#fff;
      transition: filter 0.5s ease;
    }
    
    body.freeze-frozen { filter: saturate(0.7) brightness(0.9); }
    body.freeze-lockdown { filter: saturate(0.5) brightness(0.85); }
    
    /* ============================================
       FRAME
       ============================================ */
    .frame{position:fixed;top:24px;left:24px;right:24px;bottom:24px;border:1px solid rgba(0,212,255,.2);border-radius:6px;pointer-events:none;z-index:50}
    .corner{position:absolute;width:14px;height:14px}
    .corner::before,.corner::after{content:'';position:absolute;background:rgba(0,212,255,.4)}
    .corner.tl{top:-1px;left:-1px}.corner.tl::before{width:14px;height:1px}.corner.tl::after{width:1px;height:14px}
    .corner.tr{top:-1px;right:-1px}.corner.tr::before{width:14px;height:1px;right:0}.corner.tr::after{width:1px;height:14px;right:0}
    .corner.bl{bottom:-1px;left:-1px}.corner.bl::before{width:14px;height:1px;bottom:0}.corner.bl::after{width:1px;height:14px;bottom:0}
    .corner.br{bottom:-1px;right:-1px}.corner.br::before{width:14px;height:1px;bottom:0;right:0}.corner.br::after{width:1px;height:14px;bottom:0;right:0}
    
    /* ============================================
       L7 SYSTEM - TOP BAR (LIQUID GLASS)
       ============================================ */
    .system-bar{
      position:fixed;
      top:0;left:0;right:0;
      height:28px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border-bottom:1px solid var(--glass-border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 40px;
      font-size:9px;
      letter-spacing:0.08em;
      z-index:300;
    }
    .system-bar .left{display:flex;gap:20px;color:var(--text-muted)}
    .system-bar .right{display:flex;gap:20px;color:var(--neon-cyan)}
    .system-bar .status-dot{width:6px;height:6px;border-radius:50%;margin-right:5px;display:inline-block;box-shadow:0 0 8px currentColor}
    .system-bar .status-dot.ok{background:var(--success);box-shadow:0 0 8px var(--success)}
    .system-bar .status-dot.warn{background:var(--warning);box-shadow:0 0 8px var(--warning)}
    .system-bar .status-dot.err{background:var(--danger);box-shadow:0 0 8px var(--danger)}
    
    /* ============================================
       GATE + SLA TOPBAR (LIQUID GLASS)
       ============================================ */
    .autus-topbar{
      position:fixed;top:36px;left:50%;transform:translateX(-50%);
      display:flex;gap:16px;align-items:center;z-index:200;
    }
    .gate-badge{
      padding:12px 24px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-md);
      font-size:14px;font-weight:700;letter-spacing:.15em;
      text-shadow:0 0 12px currentColor;
      transition:all 0.3s ease;
    }
    .gate-badge:hover{transform:translateY(-2px);box-shadow:var(--neon-glow)}
    .gate-green{
      background:linear-gradient(135deg, rgba(0,212,170,0.15), rgba(0,180,216,0.1));
      color:var(--success);border-color:var(--success);
      box-shadow:0 0 20px rgba(0,212,170,0.2);
    }
    .gate-amber{
      background:linear-gradient(135deg, rgba(255,184,0,0.15), rgba(255,140,0,0.1));
      color:var(--warning);border-color:var(--warning);
      box-shadow:0 0 20px rgba(255,184,0,0.2);
    }
    .gate-red{
      background:linear-gradient(135deg, rgba(255,71,87,0.15), rgba(255,50,50,0.1));
      color:var(--danger);border-color:var(--danger);
      box-shadow:0 0 20px rgba(255,71,87,0.2);
    }
    .sla-strip{display:flex;gap:8px;font-size:11px}
    .sla-strip span{
      padding:8px 16px;border-radius:var(--radius-sm);
      background:var(--glass-bg);backdrop-filter:blur(10px);
      border:1px solid var(--glass-border);transition:all 0.2s ease;
    }
    .sla-strip span:hover{transform:translateY(-1px)}
    .sla-ok{color:var(--success);border-color:rgba(0,212,170,.4)!important;box-shadow:0 0 10px rgba(0,212,170,0.15)}
    .sla-risk{color:var(--warning);border-color:rgba(255,184,0,.4)!important;background:rgba(255,184,0,.08)!important}
    .sla-breach{color:var(--danger);border-color:rgba(255,71,87,.4)!important;background:rgba(255,71,87,.08)!important}
    
    /* ============================================
       PHYSICS DISPLAY (LIQUID GLASS)
       ============================================ */
    .physics-display{
      position:fixed;top:100px;right:40px;width:240px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid rgba(255,77,109,0.3);
      border-radius:var(--radius-lg);
      padding:18px;
      z-index:150;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      transition:all 0.3s ease;
    }
    .physics-display:hover{
      border-color:rgba(255,77,109,0.5);
      box-shadow:0 8px 32px rgba(0,0,0,0.4), 0 0 20px rgba(255,77,109,0.1);
    }
    .physics-display .title{
      font-size:9px;letter-spacing:0.2em;color:rgba(255,77,109,0.9);
      margin-bottom:14px;padding-bottom:10px;
      border-bottom:1px solid rgba(255,77,109,0.2);
      text-shadow:0 0 10px rgba(255,77,109,0.3);
    }
    .physics-row{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);
      font-size:11px;transition:all 0.2s ease;
    }
    .physics-row:hover{background:rgba(255,255,255,0.02);margin:0 -8px;padding:8px}
    .physics-row:last-child{border-bottom:none}
    .physics-key{color:var(--text-muted)}
    .physics-val{font-family:'SF Mono',monospace;font-weight:600;text-shadow:0 0 10px currentColor}
    .physics-val.danger{color:var(--danger)}
    .physics-val.warning{color:var(--warning)}
    .physics-val.safe{color:var(--success)}
    
    /* ============================================
       L1 CORE - í—Œë²•/ê¸°ì¤€ íŒ¨ë„ (ì¢Œì¸¡)
       ============================================ */
    #layer-core{
      position:fixed;top:90px;left:40px;width:200px;
      background:rgba(0,20,40,0.9);
      border:1px solid rgba(0,212,255,0.25);
      border-radius:8px;padding:14px;
      backdrop-filter:blur(10px);
      z-index:100;
      display:none;
    }
    #layer-core.active{display:block}
    #layer-core .layer-title{
      font-size:9px;letter-spacing:0.2em;color:rgba(0,212,255,0.7);
      margin-bottom:12px;padding-bottom:8px;
      border-bottom:1px solid rgba(0,212,255,0.2);
    }
    #layer-core .rule-item{
      font-size:10px;padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,0.04);
      display:flex;justify-content:space-between;
    }
    #layer-core .rule-item:last-child{border-bottom:none}
    #layer-core .rule-key{color:#888}
    #layer-core .rule-val{color:#00d4ff;font-family:'SF Mono',monospace}
    #layer-core .rule-val.violated{color:#ff4444}
    #layer-core .priority-list{
      margin-top:12px;padding-top:10px;
      border-top:1px solid rgba(0,212,255,0.15);
      font-size:9px;color:#666;line-height:1.8;
    }
    #layer-core .priority-list strong{color:#00d4ff}
    
    /* ============================================
       INFO PANEL (LIQUID GLASS)
       ============================================ */
    #info{
      position:fixed;top:100px;left:40px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-lg);
      padding:18px;
      font-size:10px;z-index:95;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      transition:all 0.3s ease;
    }
    #info:hover{border-color:rgba(0,212,255,0.4);box-shadow:0 8px 32px rgba(0,0,0,0.4),var(--neon-glow)}
    #info.shifted{top:330px}
    #info h1{
      font-size:12px;font-weight:600;letter-spacing:.25em;
      color:var(--neon-cyan);margin-bottom:16px;
      text-shadow:0 0 15px rgba(0,245,255,0.5);
    }
    .stat-row{display:flex;justify-content:space-between;width:170px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05);transition:all 0.2s}
    .stat-row:hover{background:rgba(255,255,255,0.02);margin:0 -8px;padding:8px}
    .stat-label{color:var(--text-muted);font-size:9px}
    .stat-value{color:var(--neon-cyan);font-variant-numeric:tabular-nums;font-weight:500;text-shadow:0 0 10px currentColor}
    .stat-value.critical{color:var(--danger)!important;font-weight:700}
    .stat-value.warning{color:var(--warning)!important}
    
    /* ============================================
       PLANETS PANEL (LIQUID GLASS)
       ============================================ */
    #planets{
      position:fixed;top:290px;left:40px;width:200px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-lg);
      padding:16px;
      z-index:95;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    #planets.shifted{top:510px}
    .panel-title{font-size:8px;letter-spacing:.18em;color:rgba(0,245,255,.7);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,212,255,.15)}
    .planet-row{
      display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:6px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius-sm);
      cursor:pointer;transition:all .25s cubic-bezier(0.4,0,0.2,1);
    }
    .planet-row:hover{
      background:rgba(0,212,255,.1);
      border-color:rgba(0,212,255,.4);
      transform:translateX(4px);
      box-shadow:0 4px 15px rgba(0,212,255,0.15);
    }
    .planet-row.active{
      background:linear-gradient(135deg, rgba(0,212,170,0.15), rgba(0,180,216,0.1));
      border-color:var(--primary-start);
      box-shadow:0 0 15px rgba(0,212,170,0.2);
    }
    .planet-row.bottleneck{
      background:linear-gradient(135deg, rgba(255,71,87,0.15), rgba(255,50,50,0.1));
      border-color:var(--danger);
      animation:bottleneckPulse 2s infinite;
    }
    @keyframes bottleneckPulse{0%,100%{box-shadow:0 0 10px rgba(255,71,87,0.2)}50%{box-shadow:0 0 20px rgba(255,71,87,0.4)}}
    .planet-row.collapsed{opacity:.25;pointer-events:none;height:0;padding:0;margin:0;overflow:hidden;border:none}
    .planet-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;box-shadow:0 0 8px currentColor}
    .planet-name{font-size:10px;flex:1;color:var(--text-secondary)}
    .planet-val{font-size:11px;font-weight:600;font-family:'SF Mono',monospace;text-shadow:0 0 8px currentColor}
    
    /* ============================================
       METRICS PANEL (LIQUID GLASS)
       ============================================ */
    #metrics{
      position:fixed;top:380px;right:40px;width:240px;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-lg);
      padding:18px;
      z-index:100;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    .metric-section{margin-bottom:20px}
    .metric-title{font-size:8px;letter-spacing:.18em;color:rgba(0,245,255,.7);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,212,255,.15)}
    .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .metric-card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius-md);
      padding:14px 10px;
      text-align:center;
      transition:all 0.3s ease;
    }
    .metric-card:hover{
      background:rgba(255,255,255,.05);
      border-color:rgba(0,212,255,.3);
      transform:translateY(-2px);
      box-shadow:0 4px 15px rgba(0,0,0,0.2);
    }
    .metric-value{font-size:20px;font-weight:300;color:var(--neon-cyan);text-shadow:0 0 15px currentColor}
    .metric-value.warning{color:var(--warning)}
    .metric-value.danger{color:var(--danger)}
    .metric-label{font-size:8px;color:var(--text-muted);margin-top:6px;letter-spacing:.12em}
    
    /* ============================================
       L3 ACTION HUD (LIQUID GLASS + NEO-TACTILE)
       ============================================ */
    #layer-action{
      position:fixed;bottom:180px;right:40px;
      display:flex;flex-direction:column;gap:12px;z-index:150;
    }
    .action-btn{
      padding:16px 32px;
      border-radius:var(--radius-md);
      font-size:12px;font-weight:600;
      letter-spacing:.12em;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4,0,0.2,1);
      text-align:center;
      min-width:180px;
      backdrop-filter:blur(10px);
      position:relative;
      overflow:hidden;
    }
    .action-btn::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);
      transition:left 0.5s ease;
    }
    .action-btn:hover::before{left:100%}
    .action-btn:hover:not(:disabled){
      transform:translateY(-3px) scale(1.02);
      box-shadow:0 10px 30px rgba(0,0,0,0.3), 0 0 30px currentColor;
    }
    .action-btn:active:not(:disabled){transform:scale(0.98)}
    .action-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}
    .action-btn.recover{
      background:linear-gradient(135deg, rgba(0,212,170,0.2), rgba(0,180,216,0.1));
      border:1px solid var(--success);color:var(--success);
      box-shadow:0 4px 20px rgba(0,212,170,0.2);
    }
    .action-btn.defriction{
      background:linear-gradient(135deg, rgba(0,180,216,0.2), rgba(0,102,255,0.1));
      border:1px solid var(--info);color:var(--info);
      box-shadow:0 4px 20px rgba(0,180,216,0.2);
    }
    .action-btn.shock-damp{
      background:linear-gradient(135deg, rgba(255,184,0,0.2), rgba(255,140,0,0.1));
      border:1px solid var(--warning);color:var(--warning);
      box-shadow:0 4px 20px rgba(255,184,0,0.2);
    }
    .action-btn.critical-highlight{animation:criticalPulse 1.5s infinite}
    @keyframes criticalPulse{
      0%,100%{box-shadow:0 4px 20px rgba(255,71,87,0.3)}
      50%{box-shadow:0 4px 40px rgba(255,71,87,0.6), 0 0 60px rgba(255,71,87,0.3)}
    }
    .preview-label{font-size:9px;color:var(--text-muted);text-align:center;margin-top:6px;letter-spacing:.1em}
    
    /* ============================================
       ACTION LOG (LIQUID GLASS)
       ============================================ */
    #action-log{
      position:fixed;right:40px;bottom:420px;width:240px;max-height:180px;
      overflow-y:auto;z-index:150;
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid var(--glass-border);
      border-radius:var(--radius-lg);
      padding:16px;
      font-size:10px;line-height:1.7;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    #action-log::-webkit-scrollbar{width:4px}
    #action-log::-webkit-scrollbar-track{background:rgba(255,255,255,0.02)}
    #action-log::-webkit-scrollbar-thumb{background:rgba(0,212,255,.4);border-radius:4px}
    #action-log::-webkit-scrollbar-thumb:hover{background:rgba(0,212,255,.6)}
    #action-log .log-title{
      font-size:9px;letter-spacing:.18em;color:rgba(0,245,255,.8);
      margin-bottom:12px;padding-bottom:8px;
      border-bottom:1px solid rgba(0,212,255,.2);
    }
    #action-log .log-item{
      color:var(--text-secondary);padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.04);
      transition:all 0.2s;
    }
    #action-log .log-item:hover{color:var(--text-primary);padding-left:4px}
    #action-log .log-item:last-child{border-bottom:none}
    #action-log .log-item.warning{color:var(--warning)}
    #action-log .log-item.critical{color:var(--danger)}
    
    /* ============================================
       L4 AUDIT - LIQUID GLASS MODAL
       ============================================ */
    #layer-audit{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(30px);
      -webkit-backdrop-filter:blur(30px);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:500;
      opacity:0;
      transition:opacity 0.4s ease;
    }
    #layer-audit.active{
      display:flex;
      animation:auditFadeIn 0.4s ease forwards;
    }
    @keyframes auditFadeIn{from{opacity:0;backdrop-filter:blur(0)}to{opacity:1;backdrop-filter:blur(30px)}}
    
    .audit-card{
      background:var(--glass-bg);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      border:1px solid rgba(0,245,255,0.3);
      border-radius:var(--radius-xl);
      padding:45px 55px;
      text-align:center;
      max-width:460px;
      box-shadow:
        0 25px 80px rgba(0,0,0,0.5),
        0 0 60px rgba(0,245,255,0.15),
        inset 0 1px 0 rgba(255,255,255,0.1);
      transform:scale(1);
      transition:all 0.3s ease;
    }
    .audit-card.locking{animation:lockShrink 0.6s ease forwards}
    @keyframes lockShrink{
      0%{transform:scale(1);opacity:1;box-shadow:0 25px 80px rgba(0,0,0,0.5),0 0 60px rgba(0,212,170,0.3)}
      50%{transform:scale(0.9);opacity:0.8}
      100%{transform:scale(0.3) translateX(-200px);opacity:0}
    }
    .audit-card.rejecting{animation:rejectFade 0.3s ease forwards}
    @keyframes rejectFade{to{transform:scale(0.95);opacity:0}}
    
    .audit-card h2{
      font-size:15px;letter-spacing:0.3em;color:var(--neon-cyan);
      margin-bottom:35px;text-shadow:0 0 25px rgba(0,245,255,0.6);
    }
    .audit-summary{
      background:rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--radius-md);
      padding:24px;
      margin-bottom:35px;
      text-align:left;
    }
    .audit-summary .row{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05);
      font-size:14px;transition:all 0.2s;
    }
    .audit-summary .row:hover{background:rgba(255,255,255,0.02);margin:0 -12px;padding:12px}
    .audit-summary .row:last-child{border-bottom:none}
    .audit-summary .label{color:var(--text-muted)}
    .audit-summary .value{color:var(--neon-cyan);font-family:'SF Mono',monospace;font-weight:500;text-shadow:0 0 10px currentColor}
    .audit-summary .value.positive{color:var(--success)}
    .audit-summary .value.negative{color:var(--danger)}
    
    .audit-buttons{display:flex;gap:16px;justify-content:center}
    .audit-btn{
      padding:18px 40px;
      border-radius:var(--radius-md);
      font-size:14px;font-weight:600;
      letter-spacing:0.12em;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      position:relative;overflow:hidden;
      backdrop-filter:blur(10px);
    }
    .audit-btn::before{
      content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.15),transparent);
      transition:left 0.5s ease;
    }
    .audit-btn:hover::before{left:100%}
    .audit-btn:hover{transform:translateY(-3px) scale(1.05)}
    .audit-btn:active{transform:scale(0.98)}
    .audit-btn.lock{
      background:linear-gradient(135deg, rgba(0,212,170,0.25), rgba(0,180,216,0.15));
      border:1px solid var(--success);color:var(--success);
      box-shadow:0 4px 25px rgba(0,212,170,0.25);
    }
    .audit-btn.lock:hover{box-shadow:0 8px 40px rgba(0,212,170,0.4), 0 0 30px rgba(0,212,170,0.3)}
    .audit-btn.reject{
      background:linear-gradient(135deg, rgba(255,71,87,0.25), rgba(255,50,50,0.15));
      border:1px solid var(--danger);color:var(--danger);
      box-shadow:0 4px 25px rgba(255,71,87,0.25);
    }
    .audit-btn.reject:hover{box-shadow:0 8px 40px rgba(255,71,87,0.4), 0 0 30px rgba(255,71,87,0.3)}
    .audit-btn.hold{
      background:linear-gradient(135deg, rgba(255,184,0,0.25), rgba(255,140,0,0.15));
      border:1px solid var(--warning);color:var(--warning);
      box-shadow:0 4px 25px rgba(255,184,0,0.25);
    }
    .audit-btn.hold:hover{box-shadow:0 8px 40px rgba(255,184,0,0.4)}
    
    .audit-timer{
      font-size:13px;color:var(--text-muted);margin-top:30px;letter-spacing:0.1em;transition:all 0.3s;
    }
    .audit-timer.urgent{color:var(--danger);font-weight:600;animation:timerPulse 0.5s infinite}
    @keyframes timerPulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .audit-timer .countdown{font-size:28px;font-weight:200;margin-left:10px;text-shadow:0 0 15px currentColor}
    
    /* ============================================
       FREEZE OVERLAYS
       ============================================ */
    .freeze-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      pointer-events:none;z-index:400;opacity:0;transition:opacity 0.5s;
    }
    
    /* Frost Overlay (FROZEN) */
    body.freeze-frozen .frost-overlay{
      opacity:1;
      background:
        radial-gradient(ellipse at 20% 30%, rgba(100,150,255,0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(100,150,255,0.12) 0%, transparent 50%);
      backdrop-filter:blur(1px);
    }
    body.freeze-frozen .frost-overlay::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:repeating-linear-gradient(60deg,transparent,transparent 10px,rgba(150,200,255,0.02) 10px,rgba(150,200,255,0.02) 20px);
      animation:frostShimmer 8s infinite;
    }
    @keyframes frostShimmer{0%,100%{opacity:0.3}50%{opacity:0.8}}
    
    /* Lockdown Overlay */
    body.freeze-lockdown .lockdown-overlay{
      opacity:1;
      background:repeating-linear-gradient(0deg,transparent 0px,transparent 2px,rgba(255,0,0,0.03) 2px,rgba(255,0,0,0.03) 4px);
      animation:scanLines 0.1s linear infinite;
    }
    @keyframes scanLines{0%{background-position:0 0}100%{background-position:0 4px}}
    
    body.freeze-lockdown::after{
      content:'';position:fixed;top:0;left:0;right:0;bottom:0;
      pointer-events:none;z-index:399;
      background:radial-gradient(ellipse at center,transparent 40%,rgba(0,0,0,0.4) 100%);
    }
    
    /* Freeze indicator */
    .freeze-indicator{
      position:fixed;top:80px;left:50%;transform:translateX(-50%);
      padding:10px 24px;border-radius:8px;font-size:12px;font-weight:600;
      letter-spacing:0.15em;z-index:450;opacity:0;transition:opacity 0.3s;
      pointer-events:none;
    }
    body.freeze-caution .freeze-indicator{opacity:1;background:rgba(255,180,0,0.2);border:1px solid #ffb400;color:#ffb400}
    body.freeze-frozen .freeze-indicator{opacity:1;background:rgba(100,150,255,0.2);border:1px solid #6496ff;color:#6496ff}
    body.freeze-lockdown .freeze-indicator{opacity:1;background:rgba(255,60,60,0.3);border:1px solid #ff4444;color:#ff4444;animation:lockdownPulse 0.5s infinite}
    @keyframes lockdownPulse{0%,100%{box-shadow:0 0 10px rgba(255,60,60,0.3)}50%{box-shadow:0 0 25px rgba(255,60,60,0.6)}}
    
    /* Frame color changes */
    body.freeze-caution .frame{border-color:rgba(255,180,0,0.3)}
    body.freeze-caution .corner::before,body.freeze-caution .corner::after{background:rgba(255,180,0,0.5)}
    body.freeze-frozen .frame{border-color:rgba(100,150,255,0.25)}
    body.freeze-frozen .corner::before,body.freeze-frozen .corner::after{background:rgba(100,150,255,0.4)}
    body.freeze-lockdown .frame{border-color:rgba(255,60,60,0.4);animation:framePulse 0.5s infinite}
    body.freeze-lockdown .corner::before,body.freeze-lockdown .corner::after{background:rgba(255,60,60,0.6)}
    @keyframes framePulse{0%,100%{border-color:rgba(255,60,60,0.4)}50%{border-color:rgba(255,60,60,0.7)}}
    
    /* Action buttons freeze states */
    body.freeze-frozen .action-btn{opacity:0.4;pointer-events:none}
    body.freeze-lockdown .action-btn.defriction,body.freeze-lockdown .action-btn.shock-damp{opacity:0.3;pointer-events:none;border-color:#666}
    body.freeze-lockdown .action-btn.recover{animation:recoverPulse 1s infinite}
    @keyframes recoverPulse{0%,100%{box-shadow:0 0 10px rgba(0,255,136,0.3)}50%{box-shadow:0 0 30px rgba(0,255,136,0.6)}}
    
    /* ============================================
       L5 MEMORY - íƒ€ì„ë¼ì¸ (ì¢Œì¸¡ ìŠ¬ë¼ì´ë“œ)
       ============================================ */
    #layer-memory{
      position:fixed;top:24px;left:24px;bottom:24px;width:320px;
      background:rgba(0,10,20,0.98);
      border-right:1px solid rgba(0,212,255,0.2);
      transform:translateX(-100%);
      transition:transform 0.3s ease;
      z-index:400;
      overflow-y:auto;
      padding:20px;
    }
    #layer-memory.active{transform:translateX(0)}
    #layer-memory .memory-title{
      font-size:10px;letter-spacing:0.25em;color:rgba(0,212,255,0.8);
      margin-bottom:20px;padding-bottom:12px;
      border-bottom:1px solid rgba(0,212,255,0.2);
    }
    #layer-memory .memory-filters{
      display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;
    }
    #layer-memory .filter-btn{
      padding:6px 12px;font-size:9px;border-radius:4px;
      background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.2);
      color:#888;cursor:pointer;transition:all 0.2s;
    }
    #layer-memory .filter-btn:hover{color:#00d4ff;border-color:#00d4ff}
    #layer-memory .filter-btn.active{background:rgba(0,212,255,0.2);color:#00d4ff;border-color:#00d4ff}
    .memory-item{
      background:rgba(0,20,40,0.5);
      border:1px solid rgba(0,212,255,0.1);
      border-radius:8px;
      padding:14px;
      margin-bottom:10px;
    }
    .memory-item .time{font-size:9px;color:#666;margin-bottom:6px}
    .memory-item .action{font-size:11px;color:#fff;margin-bottom:8px}
    .memory-item .verdict{
      display:inline-block;padding:3px 10px;border-radius:4px;font-size:9px;font-weight:600;
    }
    .memory-item .verdict.lock{background:rgba(0,255,136,0.2);color:#00ff88}
    .memory-item .verdict.reject{background:rgba(255,68,68,0.2);color:#ff4444}
    .memory-item .delta{font-size:9px;color:#888;margin-top:8px}
    
    /* ============================================
       LAYER TOGGLE BUTTONS
       ============================================ */
    #layer-toggles{
      position:fixed;bottom:40px;left:40px;
      display:flex;gap:8px;z-index:200;
    }
    .layer-toggle{
      padding:10px 16px;background:rgba(0,20,40,0.8);
      border:1px solid rgba(0,212,255,0.25);border-radius:6px;
      font-size:9px;letter-spacing:0.1em;color:#888;
      cursor:pointer;transition:all 0.2s;
    }
    .layer-toggle:hover{color:#00d4ff;border-color:#00d4ff}
    .layer-toggle.active{background:rgba(0,212,255,0.15);color:#00d4ff;border-color:#00d4ff}
    
    /* ============================================
       SINGLE QUESTION
       ============================================ */
    #single-question{
      position:fixed;left:40px;bottom:100px;max-width:300px;
      padding:14px 18px;background:rgba(0,20,40,.9);
      border:1px solid rgba(0,212,255,.3);border-radius:10px;
      z-index:150;font-size:11px;color:#9ab;line-height:1.5;
    }
    #single-question strong{color:#00d4ff}
    
    /* ============================================
       CONTROLS
       ============================================ */
    #controls{
      position:fixed;bottom:40px;right:40px;
      display:flex;gap:8px;z-index:100;
    }
    #controls button{
      padding:10px 16px;background:rgba(0,212,255,.1);
      border:1px solid rgba(0,212,255,.25);color:#00d4ff;
      border-radius:5px;font-size:9px;cursor:pointer;transition:all .2s;
    }
    #controls button:hover{background:rgba(0,212,255,.2)}
    #controls button.active{background:rgba(0,212,255,.25);border-color:#00d4ff}
    
    /* ============================================
       PLANET LABELS
       ============================================ */
    .planet-label{
      position:absolute;font-size:10px;color:#fff;
      pointer-events:none;text-shadow:0 0 10px rgba(0,0,0,.95);
      white-space:nowrap;transition:opacity .2s;
    }
    
    /* ============================================
       KEYBOARD HINTS
       ============================================ */
    .keyboard-hint{
      position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
      font-size:9px;color:#444;letter-spacing:0.1em;z-index:50;
    }
  </style>
</head>
<body>
  <!-- Frame -->
  <div class="frame">
    <div class="corner tl"></div>
    <div class="corner tr"></div>
    <div class="corner bl"></div>
    <div class="corner br"></div>
  </div>
  
  <!-- Freeze Overlays -->
  <div class="freeze-overlay frost-overlay"></div>
  <div class="freeze-overlay lockdown-overlay"></div>
  <div class="freeze-indicator" id="freeze-indicator">NORMAL</div>
  
  <!-- L7 SYSTEM BAR -->
  <div class="system-bar">
    <div class="left">
      <span><span class="status-dot ok"></span>API</span>
      <span><span class="status-dot ok"></span>DB</span>
      <span><span class="status-dot ok"></span>WORKER</span>
      <span>SYNC: 2s ago</span>
    </div>
    <div class="right">
      <span>POLICY v1.0</span>
      <span>FPS: <span id="sys-fps">60</span></span>
      <span>UPTIME: 99.9%</span>
      <span>LATENCY: 12ms</span>
    </div>
  </div>
  
  <!-- GATE + SLA TOPBAR -->
  <div class="autus-topbar">
    <div id="gate-badge" class="gate-badge gate-green">GATE: GREEN</div>
    <div id="sla-strip" class="sla-strip">
      <span data-sla="worker" class="sla-ok">WORKER Â· OK</span>
      <span data-sla="employer" class="sla-ok">EMPLOYER Â· OK</span>
      <span data-sla="ops" class="sla-ok">OPS Â· OK</span>
      <span data-sla="reg" class="sla-ok">REG Â· OK</span>
    </div>
  </div>
  
  <!-- KERNEL DISPLAY (v2.1) -->
  <div class="physics-display">
    <div class="title">KERNEL v2.2 Â· FROZEN</div>
    <div class="physics-row"><span class="physics-key">radiusScale</span><span class="physics-val" id="phy-radius">1.00</span></div>
    <div class="physics-row"><span class="physics-key">thickness</span><span class="physics-val" id="phy-thick">0.15</span></div>
    <div class="physics-row"><span class="physics-key">pulseHz</span><span class="physics-val" id="phy-pulse">0.50</span></div>
    <div class="physics-row"><span class="physics-key">asymStrength</span><span class="physics-val" id="phy-asym">0.00</span></div>
    <div class="physics-row"><span class="physics-key">asymAngle</span><span class="physics-val" id="phy-angle">0Â°</span></div>
    <div class="physics-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,77,109,0.2)">
      <span class="physics-key">BOTTLENECK</span><span class="physics-val danger" id="phy-bottleneck">â€”</span>
    </div>
  </div>
  
  <!-- L1 CORE -->
  <div id="layer-core">
    <div class="layer-title">L1 Â· CORE Â· CONSTITUTION</div>
    <div class="rule-item"><span class="rule-key">RECOVERY_AMBER</span><span class="rule-val" id="rule-amber">0.60</span></div>
    <div class="rule-item"><span class="rule-key">RECOVERY_RED</span><span class="rule-val" id="rule-red">0.30</span></div>
    <div class="rule-item"><span class="rule-key">CRITICAL_THRESHOLD</span><span class="rule-val">0.60</span></div>
    <div class="rule-item"><span class="rule-key">COLLAPSE</span><span class="rule-val">OUT/QUA/TIM</span></div>
    <div class="priority-list">
      <strong>PRIORITY:</strong><br>
      REC â†’ STA â†’ COH â†’ SHK â†’ FRI â†’ TRA â†’ TIM â†’ QUA â†’ OUT
    </div>
  </div>
  
  <!-- Info Panel -->
  <div id="info">
    <h1>SOLAR HQ Â· 7 LAYER</h1>
    <div class="stat-row"><span class="stat-label">VERSION</span><span class="stat-value">1.0</span></div>
    <div class="stat-row"><span class="stat-label">LAYERS</span><span class="stat-value" id="s-layers">L0</span></div>
    <div class="stat-row"><span class="stat-label">PLANETS</span><span class="stat-value">9/9 ğŸ”’</span></div>
    <div class="stat-row"><span class="stat-label">STATUS</span><span class="stat-value" id="s-status">STABLE</span></div>
    <div class="stat-row"><span class="stat-label">ORBIT</span><span class="stat-value" id="s-orbit">0Â°</span></div>
  </div>
  
  <!-- Planets Panel -->
  <div id="planets">
    <div class="panel-title">9 PLANETS Â· PRIORITY ORDER</div>
    <div id="planet-list"></div>
  </div>
  
  <!-- Metrics -->
  <div id="metrics">
    <div class="metric-section">
      <div class="metric-title">TWIN STATE</div>
      <div class="metric-grid">
        <div class="metric-card"><div class="metric-value" id="m-entropy">0.00</div><div class="metric-label">ENTROPY</div></div>
        <div class="metric-card"><div class="metric-value" id="m-pressure">0.00</div><div class="metric-label">PRESSURE</div></div>
        <div class="metric-card"><div class="metric-value" id="m-risk">0.00</div><div class="metric-label">RISK</div></div>
        <div class="metric-card"><div class="metric-value" id="m-flow">0.00</div><div class="metric-label">FLOW</div></div>
      </div>
    </div>
      </div>
  
  <!-- Action Log -->
  <div id="action-log">
    <div class="log-title">L3 Â· ACTION LOG</div>
    <div id="log-items"></div>
    </div>
  
  <!-- L3 ACTION HUD -->
  <div id="layer-action">
    <button class="action-btn recover" onclick="previewAction('recover')">RECOVER</button>
    <button class="action-btn defriction" onclick="previewAction('defriction')">DEFRICTION</button>
    <button class="action-btn shock-damp" onclick="previewAction('shock_damp')">SHOCK DAMP</button>
    <div class="preview-label">â–² PREVIEW ONLY Â· Hold 3s for AUDIT</div>
  </div>
  
  <!-- L4 AUDIT OVERLAY -->
  <div id="layer-audit">
    <div class="audit-card">
      <h2>L4 Â· AUDIT Â· CONFIRM</h2>
      <div class="audit-summary">
        <div class="row"><span class="label">Action</span><span class="value" id="audit-action">RECOVER</span></div>
        <div class="row"><span class="label">Î” Recovery</span><span class="value positive" id="audit-rec">+15%</span></div>
        <div class="row"><span class="label">Î” Friction</span><span class="value positive" id="audit-fri">-5%</span></div>
        <div class="row"><span class="label">Risk</span><span class="value" id="audit-risk">0.58 â†’ 0.42</span></div>
        <div class="row"><span class="label">Confidence</span><span class="value" id="audit-conf">87%</span></div>
      </div>
      <div class="audit-buttons">
        <button class="audit-btn lock" onclick="auditDecision('LOCK')">LOCK</button>
        <button class="audit-btn hold" onclick="auditDecision('HOLD')">HOLD</button>
        <button class="audit-btn reject" onclick="auditDecision('REJECT')">REJECT</button>
      </div>
      <div class="audit-timer">Auto-reject in <span id="audit-countdown" class="countdown">30</span>s</div>
    </div>
  </div>
  
  <!-- L5 MEMORY PANEL -->
  <div id="layer-memory">
    <div class="memory-title">L5 Â· MEMORY Â· TIMELINE</div>
    <div class="memory-filters">
      <button class="filter-btn active" data-filter="all">ALL</button>
      <button class="filter-btn" data-filter="lock">LOCK</button>
      <button class="filter-btn" data-filter="reject">REJECT</button>
      <button class="filter-btn" data-filter="today">TODAY</button>
    </div>
    <div id="memory-list"></div>
  </div>
  
  <!-- Single Question -->
  <div id="single-question">
    <strong>Q â†’</strong> What single action raises Recovery fastest?
  </div>
  
  <!-- Layer Toggle Buttons -->
  <div id="layer-toggles">
    <button class="layer-toggle" data-layer="core" onclick="toggleLayer('core')">L1 CORE</button>
    <button class="layer-toggle active" data-layer="sim" onclick="toggleLayer('sim')">L2 SIM</button>
    <button class="layer-toggle active" data-layer="action" onclick="toggleLayer('action')">L3 ACTION</button>
    <button class="layer-toggle" data-layer="memory" onclick="toggleLayer('memory')">L5 MEMORY</button>
  </div>
  
  <!-- Controls -->
  <div id="controls">
    <button onclick="togglePlanets()" class="active">PLANETS</button>
    <button onclick="toggleOrbits()">ORBITS</button>
  </div>
  
  <!-- Keyboard Hints -->
  <div class="keyboard-hint">
    [C] Core Â· [S] Simulation Â· [A] Action Â· [M] Memory Â· [ESC] Close
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTUS SOLAR HQ â€” 7 LAYER COMPLETE
   BUILD: 2025-12-17
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS CONSTANTS â€” 7 LAWS (FROZEN)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PHYSICS = Object.freeze({
  // Law 5: Failure Horizon
  RING_RISK_COMPRESSION: 0.65,     // Î±: radiusScale = 1 - Î±*risk
  RING_BASE_RADIUS: 8.0,
  
  // Law 5: Pressure â†’ Thickness
  RING_PRESSURE_MULT: 1.2,         // Î³: thickness = base*(1 + Î³*pressure)
  RING_BASE_THICKNESS: 0.15,
  
  // Law 6: Entropy â†’ Pulse
  RING_ENTROPY_MULT: 2.0,          // Î´: pulseHz = base*(1 + Î´*entropy)
  RING_BASE_PULSE: 0.5,
  
  // Law 4: Shock â†’ Asymmetry
  RING_SHOCK_ASYM: 0.95,           // Î²: asymStrength = Î²*shock
});

// Time Constants (Ï„) in SECONDS
const TAU = Object.freeze({
  radiusScale: 0.8,    // Ï„=0.8s for Riskâ†’Radius
  thickness: 0.6,      // Ï„=0.6s for Pressureâ†’Thickness
  pulseHz: 0.4,        // Ï„=0.4s for Entropyâ†’Pulse
  asymStrength: 0.7,   // Ï„=0.7s for Shockâ†’Asymmetry
  asymAngle: 0.9,      // Ï„=0.9s for Bottleneck direction
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTLENECK WEIGHTS & ANGLES (FROZEN v2.1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOTTLENECK_WEIGHTS = Object.freeze({
  RECOVERY:  0.20,   // ê°€ì¥ ì¤‘ìš”í•œ ì–‘ì„± ì§€í‘œ
  STABILITY: 0.15,
  COHESION:  0.10,
  SHOCK:     0.25,   // ê°€ì¥ ìœ„í—˜í•œ ìŒì„± ì§€í‘œ âš ï¸
  FRICTION:  0.15,
  TRANSFER:  0.05,
  TIME:      0.05,
  QUALITY:   0.03,
  OUTPUT:    0.02,
});

const BOTTLENECK_ANGLES = Object.freeze({
  RECOVERY:  0,                    // 0Â° (12ì‹œ ë°©í–¥)
  STABILITY: Math.PI * 0.25,       // 45Â°
  COHESION:  Math.PI * 0.5,        // 90Â° (3ì‹œ ë°©í–¥)
  SHOCK:     Math.PI * 1.25,       // 225Â° (7ì‹œ ë°˜ ë°©í–¥)
  FRICTION:  Math.PI * 0.75,       // 135Â° (4ì‹œ ë°˜ ë°©í–¥)
  TRANSFER:  Math.PI * 1.5,        // 270Â° (9ì‹œ ë°©í–¥)
  TIME:      Math.PI * 1.75,       // 315Â°
  QUALITY:   Math.PI,              // 180Â° (6ì‹œ ë°©í–¥)
  OUTPUT:    Math.PI * 0.125,      // 22.5Â°
});

// Positive indicators (higher is better)
const POSITIVE_INDICATORS = Object.freeze([
  'RECOVERY', 'STABILITY', 'COHESION', 'TRANSFER', 'QUALITY', 'OUTPUT'
]);

// Negative indicators (higher is worse)
const NEGATIVE_INDICATORS = Object.freeze([
  'SHOCK', 'FRICTION', 'TIME'
]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPULSE PROFILES (FROZEN v2.2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê° Actionì´ TwinStateì— ì ìš©í•˜ëŠ” Î”ê°’
// Preview: Ghost Ringì—ë§Œ ì ìš©, TwinState ë¶ˆë³€
// Lock: TwinStateì— ì‹¤ì œ ì ìš©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IMPULSE_PROFILES = Object.freeze({
  // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  // â”‚ RECOVER â€” íšŒë³µ ìš°ì„  (Recovery First)                        â”‚
  // â”‚ ëª©ì : Recoveryâ†‘, ë¶€ìˆ˜ì ìœ¼ë¡œ Stabilityâ†‘, Friction/Shockâ†“    â”‚
  // â”‚ íŠ¸ë ˆì´ë“œì˜¤í”„: ì—†ìŒ (ìˆœìˆ˜ íšŒë³µ)                               â”‚
  // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  recover: Object.freeze({
    label: 'RECOVER',
    description: 'Recovery First â€” íšŒë³µ ìµœìš°ì„ ',
    delta: Object.freeze({
      RECOVERY:  +0.15,   // Primary effect
      STABILITY: +0.05,   // Secondary effect
      FRICTION:  -0.05,   // Side benefit
      SHOCK:     -0.05    // Side benefit
    }),
    color: 0x00ff88,
    priority: 1           // CRITICAL ì‹œ ìœ ì¼í•˜ê²Œ í™œì„±í™”
  }),
  
  // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  // â”‚ DEFRICTION â€” ë§ˆì°° ì œê±° (Flow Optimization)                  â”‚
  // â”‚ ëª©ì : Frictionâ†“â†“, Transferâ†‘, Recoveryâ†‘                     â”‚
  // â”‚ íŠ¸ë ˆì´ë“œì˜¤í”„: ì—†ìŒ (ìˆœìˆ˜ ìµœì í™”)                             â”‚
  // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  defriction: Object.freeze({
    label: 'DEFRICTION',
    description: 'Flow Optimization â€” ë§ˆì°° ì œê±°',
    delta: Object.freeze({
      FRICTION:  -0.20,   // Primary effect (ê°•ë ¥)
      TRANSFER:  +0.10,   // Secondary effect
      RECOVERY:  +0.05    // Side benefit
    }),
    color: 0x44aaff,
    priority: 2
  }),
  
  // â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  // â”‚ SHOCK_DAMP â€” ì¶©ê²© í¡ìˆ˜ (Stability Focus)                    â”‚
  // â”‚ ëª©ì : Shockâ†“â†“â†“, Stabilityâ†‘, Cohesionâ†‘                      â”‚
  // â”‚ íŠ¸ë ˆì´ë“œì˜¤í”„: Recoveryâ†“ (ì—ë„ˆì§€ ì†Œëª¨)                        â”‚
  // â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  shock_damp: Object.freeze({
    label: 'SHOCK DAMP',
    description: 'Stability Focus â€” ì¶©ê²© í¡ìˆ˜',
    delta: Object.freeze({
      SHOCK:     -0.25,   // Primary effect (ë§¤ìš° ê°•ë ¥)
      STABILITY: +0.08,   // Secondary effect
      COHESION:  +0.05,   // Side benefit
      RECOVERY:  -0.10    // Trade-off âš ï¸
    }),
    color: 0xffaa00,
    priority: 3
  })
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLICY (FROZEN)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const POLICY = Object.freeze({
  RECOVERY_AMBER: 0.60,
  RECOVERY_RED: 0.30,
  CRITICAL_THRESHOLD: 0.60,
  CRITICAL_COLLAPSE: ['OUTPUT', 'QUALITY', 'TIME'],
  PRIORITY: ['RECOVERY', 'STABILITY', 'COHESION', 'SHOCK', 'FRICTION', 'TRANSFER', 'TIME', 'QUALITY', 'OUTPUT']
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANETS (9/9 LOCKED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLANETS = Object.freeze([
  { key: 'RECOVERY',  name: 'Recovery',  icon: 'ğŸ”§', color: 0x44ff44, size: 0.14, orbit: 5.4, speed: 0.50 },
  { key: 'STABILITY', name: 'Stability', icon: 'ğŸ¯', color: 0x8844ff, size: 0.20, orbit: 4.4, speed: 0.35, rings: true },
  { key: 'COHESION',  name: 'Cohesion',  icon: 'ğŸ”—', color: 0xff44aa, size: 0.13, orbit: 4.9, speed: 0.60 },
  { key: 'SHOCK',     name: 'Shock',     icon: 'âš ï¸', color: 0xff8800, size: 0.19, orbit: 6.4, speed: 0.30 },
  { key: 'FRICTION',  name: 'Friction',  icon: 'âš¡', color: 0xff4444, size: 0.16, orbit: 3.9, speed: 0.45 },
  { key: 'TRANSFER',  name: 'Transfer',  icon: 'ğŸ“¡', color: 0x44aaff, size: 0.12, orbit: 5.9, speed: 0.75, rings: true },
  { key: 'TIME',      name: 'Time',      icon: 'â±ï¸', color: 0xffaa00, size: 0.14, orbit: 3.4, speed: 0.85 },
  { key: 'QUALITY',   name: 'Quality',   icon: 'ğŸ›¡ï¸', color: 0x00d4ff, size: 0.15, orbit: 2.9, speed: 0.55, rings: true },
  { key: 'OUTPUT',    name: 'Output',    icon: 'ğŸ”¥', color: 0x00ff88, size: 0.18, orbit: 2.4, speed: 0.70 }
]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let planets9 = {
  RECOVERY: 0.42,
  STABILITY: 0.55,
  COHESION: 0.62,
  SHOCK: 0.72,      // High shock â†’ bottleneck
  FRICTION: 0.79,   // High friction â†’ bottleneck
  TRANSFER: 0.60,
  TIME: 0.50,
  QUALITY: 0.68,
  OUTPUT: 0.55
};
let selectedPlanet = 'RECOVERY';
let state = { risk: 0.75, entropy: 0.50, pressure: 0.50, flow: 0.50 };
let planetsVisible = true;
let orbitsVisible = true;
let lastCriticalState = false;
let activeLayers = { core: false, sim: true, action: true, memory: false };
let memoryLog = [];
let auditTimer = null;
let currentAuditAction = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS FRAME â€” ë¬¼ë¦¬ ê¸°ë°˜ UI ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PhysicsFrame = {
  ring: {
    // í˜„ì¬ ê°’ (ë Œë”ë§ìš©)
    radiusScale: 1.0,     // 0.5 ~ 1.0 (Riskâ†‘ â†’ ìˆ˜ì¶•)
    thickness: 0.15,      // 0.1 ~ 0.4 (Pressureâ†‘ â†’ ë‘êº¼ì›€)
    pulseHz: 0.5,         // 0.3 ~ 2.0 (Entropyâ†‘ â†’ ë¹ ë¥¸ ë§¥ë™)
    asymStrength: 0.0,    // 0.0 ~ 0.3 (Shockâ†‘ â†’ ë¹„ëŒ€ì¹­)
    asymAngle: 0.0,       // 0 ~ 2Ï€ (Bottleneck ë°©í–¥)
    
    // ëª©í‘œ ê°’ (TwinStateì—ì„œ ê³„ì‚°)
    targetRadiusScale: 1.0,
    targetThickness: 0.15,
    targetPulseHz: 0.5,
    targetAsymStrength: 0.0,
    targetAsymAngle: 0.0
  },
  
  // Preview (Ghost) ìƒíƒœ
  preview: {
    active: false,
    radiusScale: 1.0,
    thickness: 0.15,
    asymStrength: 0.0,
    asymAngle: 0.0
  },
  
  // Bottleneck info
  bottleneck: {
    axis: 'FRICTION',
    value: 0.79,
    angle: Math.PI * 0.75
  }
};

// ì‹œê°„ ìƒìˆ˜ (ì´ˆ â†’ í”„ë ˆì„ ë³€í™˜: 60fps ê¸°ì¤€)
const TAU = {
  radiusScale: 0.8,   // Law 5: Failure Horizon
  thickness: 0.6,
  pulseHz: 0.4,       // Law 6: Entropy Pulse
  asymStrength: 0.7,  // Law 4: Shock Asymmetry
  asymAngle: 0.9
};

// Lerp with Ï„ (ì‹œê°„ ìƒìˆ˜ ê¸°ë°˜ ì§€ìˆ˜ ê°ì‡ )
function lerpTau(current, target, tau, dt = 0.016) {
  const alpha = 1 - Math.exp(-dt / tau);
  return current + (target - current) * alpha;
}

// Clamp utility
function clamp(v, min = 0, max = 1) {
  return Math.max(min, Math.min(max, v));
}

// Calculate derived state from planets
function calculateDerivedState() {
  const rec = planets9.RECOVERY || 0.5;
  const sta = planets9.STABILITY || 0.5;
  const coh = planets9.COHESION || 0.5;
  const shk = planets9.SHOCK || 0.5;
  const fri = planets9.FRICTION || 0.5;
  const tra = planets9.TRANSFER || 0.5;
  const tim = planets9.TIME || 0.5;
  const qua = planets9.QUALITY || 0.5;
  const out = planets9.OUTPUT || 0.5;
  
  // Risk: weighted sum of negative factors
  state.risk = clamp(
    0.20 * (1 - rec) +
    0.15 * (1 - sta) +
    0.10 * (1 - coh) +
    0.25 * shk +
    0.15 * fri +
    0.05 * (1 - tra) +
    0.05 * tim +
    0.03 * (1 - qua) +
    0.02 * (1 - out)
  );
  
  // Entropy: mainly from Shock
  state.entropy = clamp(0.3 * shk + 0.2 * fri + 0.2 * tim + 0.3 * (1 - coh));
  
  // Pressure: from Shock + Friction
  state.pressure = clamp(0.4 * shk + 0.3 * fri + 0.3 * (1 - rec));
  
  // Flow: Transfer efficiency
  state.flow = clamp(0.4 * tra + 0.3 * (1 - fri) + 0.3 * (1 - tim));
  
  // Bottleneck calculated by separate single-source function
  computeBottleneck();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTLENECK â€” SINGLE SOURCE (FROZEN v2.1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeBottleneck() {
  let maxBadness = -Infinity;
  let maxAxis = 'SHOCK';
  
  // Iterate all planets
  for (const key in planets9) {
    const value = planets9[key] || 0.5;
    const weight = BOTTLENECK_WEIGHTS[key] || 0.05;
    
    // badness = 1 - value (positive indicators)
    // badness = value     (negative indicators)
    const isPositive = POSITIVE_INDICATORS.includes(key);
    const badness = isPositive ? (1 - value) : value;
    const weighted = weight * badness;
    
    if (weighted > maxBadness) {
      maxBadness = weighted;
      maxAxis = key;
    }
  }
  
  // Update PhysicsFrame.bottleneck (Single Source)
  PhysicsFrame.bottleneck.axis = maxAxis;
  PhysicsFrame.bottleneck.value = planets9[maxAxis] || 0.5;
  PhysicsFrame.bottleneck.angle = BOTTLENECK_ANGLES[maxAxis] || 0;
}

// TwinState â†’ PhysicsFrame ë³€í™˜ (Law 4,5,6,7)
function updatePhysicsFrame() {
  const risk = state.risk || 0;
  const pressure = state.pressure || 0;
  const entropy = state.entropy || 0;
  const shock = Math.max(planets9.SHOCK || 0.5, planets9.FRICTION || 0.5);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Law 5: Failure Horizon â€” Riskâ†‘ â†’ Radiusâ†“
  // radiusScale = 1 - 0.65 * risk
  // Risk 0.75 â†’ radiusScale = 1 - 0.65 * 0.75 = 0.5125
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PhysicsFrame.ring.targetRadiusScale = 1.0 - PHYSICS.RING_RISK_COMPRESSION * risk;
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Law 5: Pressure â†’ Thickness
  // thickness = base * (1 + 1.2 * pressure)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PhysicsFrame.ring.targetThickness = PHYSICS.RING_BASE_THICKNESS * (1 + PHYSICS.RING_PRESSURE_MULT * pressure);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Law 6: Entropy Pulse â€” Entropyâ†‘ â†’ PulseHzâ†‘
  // pulseHz = base * (1 + 2.0 * entropy)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PhysicsFrame.ring.targetPulseHz = PHYSICS.RING_BASE_PULSE * (1 + PHYSICS.RING_ENTROPY_MULT * entropy);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Law 4: Shock Asymmetry â€” Shockâ†‘ â†’ AsymStrengthâ†‘
  // asymStrength = 0.95 * max(shock, friction)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PhysicsFrame.ring.targetAsymStrength = PHYSICS.RING_SHOCK_ASYM * shock;
  
  // Asymmetry angle: bottleneck direction
  PhysicsFrame.ring.targetAsymAngle = PhysicsFrame.bottleneck.angle;
}

// UPDATE KERNEL DISPLAY (ì—­ì°¸ì¡° PhysicsFrame)
function updateKernelDisplay() {
  const r = PhysicsFrame.ring;
  
  const radiusEl = document.getElementById('phy-radius');
  radiusEl.textContent = r.radiusScale.toFixed(2);
  radiusEl.className = 'physics-val ' + (r.radiusScale < 0.6 ? 'danger' : r.radiusScale < 0.8 ? 'warning' : 'safe');
  
  const thickEl = document.getElementById('phy-thick');
  thickEl.textContent = r.thickness.toFixed(2);
  thickEl.className = 'physics-val ' + (r.thickness > 0.25 ? 'warning' : 'safe');
  
  const pulseEl = document.getElementById('phy-pulse');
  pulseEl.textContent = r.pulseHz.toFixed(2);
  pulseEl.className = 'physics-val ' + (r.pulseHz > 1.0 ? 'warning' : 'safe');
  
  const asymEl = document.getElementById('phy-asym');
  asymEl.textContent = r.asymStrength.toFixed(2);
  asymEl.className = 'physics-val ' + (r.asymStrength > 0.5 ? 'danger' : r.asymStrength > 0.3 ? 'warning' : 'safe');
  
  document.getElementById('phy-angle').textContent = Math.round(r.asymAngle * 180 / Math.PI) + 'Â°';
  
  const bnEl = document.getElementById('phy-bottleneck');
  bnEl.textContent = `${PhysicsFrame.bottleneck.axis} (${Math.round(PhysicsFrame.bottleneck.value * 100)}%)`;
}

// PhysicsFrame ì• ë‹ˆë©”ì´ì…˜ (ë§¤ í”„ë ˆì„ í˜¸ì¶œ)
function animatePhysicsFrame(dt = 0.016) {
  const r = PhysicsFrame.ring;
  
  // Law 7: Time Constant ì ìš©
  r.radiusScale = lerpTau(r.radiusScale, r.targetRadiusScale, TAU.radiusScale, dt);
  r.thickness = lerpTau(r.thickness, r.targetThickness, TAU.thickness, dt);
  r.pulseHz = lerpTau(r.pulseHz, r.targetPulseHz, TAU.pulseHz, dt);
  r.asymStrength = lerpTau(r.asymStrength, r.targetAsymStrength, TAU.asymStrength, dt);
  r.asymAngle = lerpTau(r.asymAngle, r.targetAsymAngle, TAU.asymAngle, dt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 1000);
camera.position.set(0, 8, 14);
camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0x404050, 0.5));
scene.add(new THREE.PointLight(0xffffff, 1.5, 50));

// Starfield
const starsGeo = new THREE.BufferGeometry();
const starPos = [];
for (let i = 0; i < 2500; i++) {
  const r = 45 + Math.random() * 70;
  const t = Math.random() * Math.PI * 2;
  const p = Math.acos(2 * Math.random() - 1);
  starPos.push(r * Math.sin(p) * Math.cos(t), r * Math.sin(p) * Math.sin(t), r * Math.cos(p));
}
starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.08 })));

// Globe
const globeGroup = new THREE.Group();
scene.add(globeGroup);
const globe = new THREE.Mesh(
  new THREE.SphereGeometry(1.5, 64, 64),
  new THREE.MeshPhongMaterial({ color: 0x0066aa, emissive: 0x001133, transparent: true, opacity: 0.85 })
);
globeGroup.add(globe);
globeGroup.add(new THREE.Mesh(
  new THREE.SphereGeometry(1.52, 36, 18),
  new THREE.MeshBasicMaterial({ color: 0x00d4ff, wireframe: true, transparent: true, opacity: 0.15 })
));

// L2 SIMULATION RINGS â†’ FAILURE HORIZON RING (Physics-based)
const simGroup = new THREE.Group();
const RING_SEGMENTS = 128;
const BASE_RADIUS = 8.0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAILURE RING (Main) â€” ë™ì  ë³€í˜• ê°€ëŠ¥í•œ TorusGeometry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const failureRingGeo = new THREE.TorusGeometry(BASE_RADIUS, 0.15, 16, RING_SEGMENTS);
const failureRingMat = new THREE.MeshBasicMaterial({
  color: 0xff4444,
  transparent: true,
  opacity: 0.6,
  side: THREE.DoubleSide
});
const failureRing = new THREE.Mesh(failureRingGeo, failureRingMat);
failureRing.rotation.x = Math.PI / 2;
failureRing.position.y = 0.3;
simGroup.add(failureRing);

// ì›ë³¸ ì •ì  ì €ì¥ (ë³€í˜• ê¸°ì¤€)
const failureRingBasePositions = failureRingGeo.attributes.position.array.slice();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GHOST RING (Preview) â€” Action Preview ì‹œ í‘œì‹œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ghostRingGeo = new THREE.TorusGeometry(BASE_RADIUS, 0.1, 8, RING_SEGMENTS);
const ghostRingMat = new THREE.MeshBasicMaterial({
  color: 0x00d4ff,
  transparent: true,
  opacity: 0.0,
  wireframe: true
});
const ghostRing = new THREE.Mesh(ghostRingGeo, ghostRingMat);
ghostRing.rotation.x = Math.PI / 2;
ghostRing.position.y = 0.35;
simGroup.add(ghostRing);
const ghostRingBasePositions = ghostRingGeo.attributes.position.array.slice();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INNER HEALTH RING (Recovery/Stability ê¸°ë°˜)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const innerRingMat = new THREE.MeshBasicMaterial({ color: 0x00ffaa, transparent: true, opacity: 0.25, side: THREE.DoubleSide });
const innerRing = new THREE.Mesh(new THREE.RingGeometry(6.5, 6.7, 64), innerRingMat);
innerRing.rotation.x = -Math.PI / 2;
innerRing.position.y = 0.25;
simGroup.add(innerRing);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OUTER PRESSURE RING (Shock/Friction ê¸°ë°˜)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const outerRingMat = new THREE.MeshBasicMaterial({ color: 0xff8844, transparent: true, opacity: 0.2, side: THREE.DoubleSide });
const outerRing = new THREE.Mesh(new THREE.RingGeometry(9.0, 9.2, 64), outerRingMat);
outerRing.rotation.x = -Math.PI / 2;
outerRing.position.y = 0.35;
simGroup.add(outerRing);

scene.add(simGroup);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAILURE RING DEFORMATION â€” ë¬¼ë¦¬ ê¸°ë°˜ ë³€í˜• í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deformFailureRing(time) {
  const pf = PhysicsFrame.ring;
  const positions = failureRingGeo.attributes.position.array;
  const basePos = failureRingBasePositions;
  
  // Pulse amplitude (Law 6: Entropy)
  const pulseAmp = 0.1 + pf.thickness * 0.5;
  const pulse = Math.sin(time * pf.pulseHz * Math.PI * 2) * pulseAmp;
  
  for (let i = 0; i < positions.length; i += 3) {
    const bx = basePos[i];
    const by = basePos[i + 1];
    const bz = basePos[i + 2];
    
    // Vertex angle in XZ plane
    const angle = Math.atan2(bz, bx);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Law 5: Radius scaling (Risk-based compression)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const radiusMult = pf.radiusScale;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Law 4: Asymmetry (Shock-based distortion)
    // Compress toward bottleneck angle, expand opposite
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const asymOffset = Math.cos(angle - pf.asymAngle) * pf.asymStrength * 0.4;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Law 6: Pulse (Entropy-based pulsation)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const pulseMult = 1 + pulse * 0.15;
    
    // Combined scale
    const scale = radiusMult * (1 + asymOffset) * pulseMult;
    
    // Apply deformation
    positions[i] = bx * scale;
    positions[i + 1] = by * (1 + pf.thickness * 3); // Thickness
    positions[i + 2] = bz * scale;
  }
  
  failureRingGeo.attributes.position.needsUpdate = true;
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Color based on Risk level
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const risk = state.risk;
  if (risk > 0.6) {
    failureRingMat.color.setHex(0xff4444); // Critical: Red
  } else if (risk > 0.4) {
    failureRingMat.color.setHex(0xffaa00); // Warning: Orange
  } else {
    failureRingMat.color.setHex(0x00d4aa); // Safe: Cyan
  }
  failureRingMat.opacity = 0.4 + risk * 0.5;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GHOST RING DEFORMATION â€” Preview ì‹œ ë¯¸ë˜ ìƒíƒœ í‘œì‹œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deformGhostRing(time) {
  const pv = PhysicsFrame.preview;
  if (!pv.active) {
    ghostRingMat.opacity = 0;
    return;
  }
  
  ghostRingMat.opacity = 0.4;
  const positions = ghostRingGeo.attributes.position.array;
  const basePos = ghostRingBasePositions;
  
  for (let i = 0; i < positions.length; i += 3) {
    const bx = basePos[i];
    const by = basePos[i + 1];
    const bz = basePos[i + 2];
    
    const angle = Math.atan2(bz, bx);
    const radiusMult = pv.radiusScale;
    const asymOffset = Math.cos(angle - pv.asymAngle) * pv.asymStrength;
    const scale = radiusMult * (1 + asymOffset);
    
    positions[i] = bx * scale;
    positions[i + 1] = by * (1 + pv.thickness * 2);
    positions[i + 2] = bz * scale;
  }
  
  ghostRingGeo.attributes.position.needsUpdate = true;
}

// Planets
const planetGroup = new THREE.Group();
scene.add(planetGroup);
const planetMeshes = {};
const planetLabelsEl = {};
const orbitRings = [];

PLANETS.forEach((p, i) => {
  const group = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({ color: p.color, emissive: p.color, emissiveIntensity: 0.3 });
  group.add(new THREE.Mesh(new THREE.SphereGeometry(p.size, 24, 24), mat));
  group.add(new THREE.Mesh(
    new THREE.SphereGeometry(p.size * 1.3, 16, 16),
    new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.15, side: THREE.BackSide })
  ));
  if (p.rings) {
    const ring = new THREE.Mesh(
      new THREE.RingGeometry(p.size * 1.5, p.size * 2, 32),
      new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.25, side: THREE.DoubleSide })
    );
    ring.rotation.x = Math.PI / 2.2;
    group.add(ring);
  }
  planetGroup.add(group);
  planetMeshes[p.key] = group;
  
  // Orbit ring
  const oRing = new THREE.Mesh(
    new THREE.RingGeometry(p.orbit - 0.015, p.orbit + 0.015, 64),
    new THREE.MeshBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.2, side: THREE.DoubleSide })
  );
  oRing.rotation.x = -Math.PI / 2;
  scene.add(oRing);
  orbitRings.push(oRing);
  
  // Label
  const label = document.createElement('div');
  label.className = 'planet-label';
  label.innerHTML = `<span style="color:#${p.color.toString(16).padStart(6,'0')}">${p.icon}</span> ${p.name}`;
  document.body.appendChild(label);
  planetLabelsEl[p.key] = label;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LAYER MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleLayer(layer) {
  activeLayers[layer] = !activeLayers[layer];
  
  const btn = document.querySelector(`.layer-toggle[data-layer="${layer}"]`);
  btn.classList.toggle('active', activeLayers[layer]);
  
  if (layer === 'core') {
    document.getElementById('layer-core').classList.toggle('active', activeLayers.core);
    document.getElementById('info').classList.toggle('shifted', activeLayers.core);
    document.getElementById('planets').classList.toggle('shifted', activeLayers.core);
  }
  if (layer === 'sim') simGroup.visible = activeLayers.sim;
  if (layer === 'action') document.getElementById('layer-action').style.display = activeLayers.action ? 'flex' : 'none';
  if (layer === 'memory') document.getElementById('layer-memory').classList.toggle('active', activeLayers.memory);
  
  updateLayerDisplay();
  logAction(`Layer ${layer.toUpperCase()} ${activeLayers[layer] ? 'ON' : 'OFF'}`);
}

function updateLayerDisplay() {
  const active = ['L0'];
  if (activeLayers.core) active.push('L1');
  if (activeLayers.sim) active.push('L2');
  if (activeLayers.action) active.push('L3');
  if (activeLayers.memory) active.push('L5');
  active.push('L7');
  document.getElementById('s-layers').textContent = active.join('+');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTION LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function logAction(msg, type = 'info') {
  const container = document.getElementById('log-items');
  if (!container) return;
  const item = document.createElement('div');
  item.className = 'log-item' + (type === 'warning' ? ' warning' : type === 'critical' ? ' critical' : '');
  const ts = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  item.textContent = `[${ts}] ${msg}`;
  container.insertBefore(item, container.firstChild);
  while (container.children.length > 20) container.removeChild(container.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GATE & SLA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeGate(rec, risk) {
  if (risk > POLICY.CRITICAL_THRESHOLD) return 'AMBER';
  if (rec < POLICY.RECOVERY_RED) return 'RED';
  if (rec < POLICY.RECOVERY_AMBER) return 'AMBER';
  return 'GREEN';
}

function updateGateSLA() {
  const rec = planets9.RECOVERY || 0.5;
  const sta = planets9.STABILITY || 0.5;
  const coh = planets9.COHESION || 0.5;
  const shk = planets9.SHOCK || 0.5;
  
  const gate = computeGate(rec, state.risk);
  const gateEl = document.getElementById('gate-badge');
  gateEl.className = 'gate-badge gate-' + gate.toLowerCase();
  gateEl.textContent = 'GATE: ' + gate;
  
  // Update L1 CORE violation highlights
  document.getElementById('rule-amber').classList.toggle('violated', rec < POLICY.RECOVERY_AMBER);
  document.getElementById('rule-red').classList.toggle('violated', rec < POLICY.RECOVERY_RED);
  
  // SLA
  const sla = {
    worker: rec < 0.35 ? 'BREACH' : rec < 0.50 ? 'AT_RISK' : 'OK',
    employer: (sta < 0.20 || coh < 0.25) ? 'AT_RISK' : 'OK',
    ops: shk > 0.75 ? 'BREACH' : shk > 0.60 ? 'AT_RISK' : 'OK',
    reg: shk > 0.85 ? 'BREACH' : 'OK'
  };
  const classMap = { OK: 'sla-ok', AT_RISK: 'sla-risk', BREACH: 'sla-breach' };
  for (const [key, value] of Object.entries(sla)) {
    const el = document.querySelector(`#sla-strip span[data-sla="${key}"]`);
    if (el) {
      el.className = classMap[value];
      el.textContent = `${key.toUpperCase()} Â· ${value.replace('_', ' ')}`;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// L3 ACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let actionHoldTimer = null;

function previewAction(action) {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // IMPULSE PROFILE ì°¸ì¡° (FROZEN v2.2)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const profile = IMPULSE_PROFILES[action];
  if (!profile) {
    console.error(`Unknown action: ${action}`);
    return;
  }
  const delta = profile.delta;
  
  // Flash rings
  innerRingMat.opacity = 0.6;
  outerRingMat.opacity = 0.6;
  setTimeout(() => { innerRingMat.opacity = 0.25; outerRingMat.opacity = 0.2; }, 800);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // GHOST RING PREVIEW â€” Calculate future state
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const futureState = {};
  for (const key in planets9) {
    futureState[key] = clamp((planets9[key] || 0.5) + (delta[key] || 0));
  }
  
  // Calculate future risk
  const futureRisk = clamp(
    0.20 * (1 - futureState.RECOVERY) +
    0.15 * (1 - futureState.STABILITY) +
    0.10 * (1 - futureState.COHESION) +
    0.25 * futureState.SHOCK +
    0.15 * futureState.FRICTION +
    0.05 * (1 - futureState.TRANSFER) +
    0.05 * futureState.TIME +
    0.03 * (1 - futureState.QUALITY) +
    0.02 * (1 - futureState.OUTPUT)
  );
  
  const futurePressure = clamp(0.4 * futureState.SHOCK + 0.3 * futureState.FRICTION + 0.3 * (1 - futureState.RECOVERY));
  const futureShock = Math.max(futureState.SHOCK, futureState.FRICTION);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Ghost Ring Preview (Law 5/4 applied to future state)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PhysicsFrame.preview.active = true;
  PhysicsFrame.preview.radiusScale = 1.0 - PHYSICS.RING_RISK_COMPRESSION * futureRisk;
  PhysicsFrame.preview.thickness = PHYSICS.RING_BASE_THICKNESS * (1 + PHYSICS.RING_PRESSURE_MULT * futurePressure);
  PhysicsFrame.preview.asymStrength = PHYSICS.RING_SHOCK_ASYM * futureShock;
  PhysicsFrame.preview.asymAngle = PhysicsFrame.bottleneck.angle;
  
  // Ghost color: green if improved, red if worse
  ghostRingMat.color.setHex(futureRisk < state.risk ? 0x00ff88 : 0xff4444);
  
  logAction(`Preview: ${action.toUpperCase()} (Risk ${(state.risk * 100).toFixed(0)}% â†’ ${(futureRisk * 100).toFixed(0)}%)`, 'warning');
  
  // Open audit
  currentAuditAction = { action, delta, futureRisk, futureState };
  openAudit(action, delta);
}

function updateActionHUD() {
  const rec = planets9.RECOVERY || 0.5;
  const fri = planets9.FRICTION || 0.5;
  const shk = planets9.SHOCK || 0.5;
  const isCritical = state.risk > POLICY.CRITICAL_THRESHOLD;
  
  const recoverBtn = document.querySelector('.action-btn.recover');
  const defrictionBtn = document.querySelector('.action-btn.defriction');
  const shockBtn = document.querySelector('.action-btn.shock-damp');
  
  if (isCritical) {
    recoverBtn.disabled = false;
    recoverBtn.classList.add('critical-highlight');
    defrictionBtn.disabled = true;
    shockBtn.disabled = true;
  } else {
    recoverBtn.disabled = rec > 0.7;
    recoverBtn.classList.remove('critical-highlight');
    defrictionBtn.disabled = fri < 0.4;
    shockBtn.disabled = shk < 0.4;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FREEZE VISUAL STATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.freezeLevel = 0;
window.freezeMotionMultiplier = 1.0;

const FREEZE_LABELS = ['NORMAL', 'CAUTION âš ', 'FROZEN â„', 'LOCKDOWN ğŸ”’'];

function applyFreezeVisual(level) {
  const body = document.body;
  const indicator = document.getElementById('freeze-indicator');
  
  // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
  body.classList.remove('freeze-caution', 'freeze-frozen', 'freeze-lockdown');
  
  // ìƒˆ í´ë˜ìŠ¤ ì ìš©
  if (level === 1) body.classList.add('freeze-caution');
  if (level === 2) body.classList.add('freeze-frozen');
  if (level === 3) body.classList.add('freeze-lockdown');
  
  // ëª¨ì…˜ ì†ë„ ì¡°ì •
  window.freezeLevel = level;
  window.freezeMotionMultiplier = [1.0, 0.7, 0.2, 0][level];
  
  // ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
  indicator.textContent = FREEZE_LABELS[level];
  
  // ë¡œê·¸
  logAction(`Freeze: ${FREEZE_LABELS[level]}`, level >= 2 ? 'critical' : level === 1 ? 'warning' : 'info');
  
  // LOCKDOWN ì‹œ ë²„íŠ¼ ìƒíƒœ (CSSë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ ì¶”ê°€ ë¡œì§)
  if (level === 3) {
    logAction('RECOVERY ONLY mode', 'critical');
  }
}

// ìë™ Freeze ë ˆë²¨ ê²°ì •
function autoFreezeLevel(risk, failureRate) {
  if (failureRate > 0.05) return 3; // LOCKDOWN
  if (risk > 0.70) return 2;        // FROZEN
  if (risk > 0.50) return 1;        // CAUTION
  return 0;                          // NORMAL
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OUTCOME CLASSIFICATION (Failure / Near-miss íŒì •)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CRITICAL_THRESHOLD = 0.60;
const EPSILON = 0.05;

function classifyOutcome(riskBefore, riskAfter, recoveryBefore, recoveryAfter) {
  const gateAfter = riskAfter > CRITICAL_THRESHOLD ? 'AMBER' : recoveryAfter < 0.30 ? 'RED' : 'GREEN';
  
  // FAILURE: ìƒí™© ì•…í™” ë˜ëŠ” RED ì§„ì…
  if (riskAfter > riskBefore) {
    return { outcome: 'FAILURE', reason: 'risk increased', icon: 'âœ—', type: 'critical' };
  }
  if (gateAfter === 'RED') {
    return { outcome: 'FAILURE', reason: 'gate RED', icon: 'âœ—', type: 'critical' };
  }
  if (recoveryAfter < recoveryBefore) {
    return { outcome: 'FAILURE', reason: 'recovery decreased', icon: 'âœ—', type: 'critical' };
  }
  
  // NEAR_MISS: CRITICAL ê²½ê³„ ê·¼ì ‘
  const boundaryDistance = Math.abs(riskAfter - CRITICAL_THRESHOLD);
  if (boundaryDistance <= EPSILON) {
    return { outcome: 'NEAR_MISS', reason: 'near boundary', icon: 'âš ', type: 'warning' };
  }
  if (riskBefore > CRITICAL_THRESHOLD && riskAfter <= CRITICAL_THRESHOLD) {
    return { outcome: 'NEAR_MISS', reason: 'escaped critical', icon: 'âš ', type: 'warning' };
  }
  
  // SUCCESS: ê°œì„ ë¨
  if (riskAfter < riskBefore && recoveryAfter > recoveryBefore) {
    return { outcome: 'SUCCESS', reason: 'improved', icon: 'âœ“', type: 'info' };
  }
  
  // NEUTRAL: ë³€í™” ì—†ìŒ
  return { outcome: 'NEUTRAL', reason: 'no change', icon: 'â—‹', type: 'info' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// L4 AUDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.auditActive = false;

function openAudit(action, delta) {
  clearInterval(auditTimer);
  clearTimeout(actionHoldTimer);
  
  // íƒœì–‘ê³„ ì •ì§€
  window.auditActive = true;
  
  const auditEl = document.getElementById('layer-audit');
  const cardEl = auditEl.querySelector('.audit-card');
  cardEl.classList.remove('locking', 'rejecting');
  
  auditEl.classList.add('active');
  
  // IMPULSE_PROFILES ì°¸ì¡° (v2.2)
  const profile = IMPULSE_PROFILES[action];
  const label = profile?.label || action.toUpperCase();
  const recDelta = delta.RECOVERY || 0;
  const friDelta = delta.FRICTION || 0;
  
  document.getElementById('audit-action').textContent = label;
  document.getElementById('audit-rec').textContent = `${recDelta > 0 ? '+' : ''}${Math.round(recDelta * 100)}%`;
  document.getElementById('audit-rec').className = 'value ' + (recDelta > 0 ? 'positive' : recDelta < 0 ? 'negative' : '');
  document.getElementById('audit-fri').textContent = `${friDelta > 0 ? '+' : ''}${Math.round(friDelta * 100)}%`;
  document.getElementById('audit-fri').className = 'value ' + (friDelta < 0 ? 'positive' : friDelta > 0 ? 'negative' : '');
  
  // PhysicsFrameì—ì„œ ê³„ì‚°ëœ ë¯¸ë˜ Risk ì‚¬ìš©
  const futureRisk = currentAuditAction?.futureRisk || Math.max(0, state.risk - 0.16);
  const riskImproved = futureRisk < state.risk;
  document.getElementById('audit-risk').textContent = `${state.risk.toFixed(2)} â†’ ${futureRisk.toFixed(2)}`;
  document.getElementById('audit-risk').className = 'value ' + (riskImproved ? 'positive' : 'negative');
  document.getElementById('audit-conf').textContent = `${75 + Math.floor(Math.random() * 20)}%`;
  
  let countdown = 30;
  const timerEl = document.getElementById('audit-countdown');
  const timerContainer = timerEl.parentElement;
  timerEl.textContent = countdown;
  timerContainer.classList.remove('urgent');
  
  auditTimer = setInterval(() => {
    countdown--;
    timerEl.textContent = countdown;
    
    // 10ì´ˆ ì´í•˜: ê¸´ê¸‰ í‘œì‹œ
    if (countdown <= 10) {
      timerContainer.classList.add('urgent');
    }
    
    if (countdown <= 0) {
      auditDecision('REJECT');
    }
  }, 1000);
  
  logAction('L4 AUDIT opened', 'warning');
}

async function auditDecision(verdict) {
  clearInterval(auditTimer);
  
  // Ghost Ring ë¹„í™œì„±í™”
  PhysicsFrame.preview.active = false;
  
  const auditEl = document.getElementById('layer-audit');
  const cardEl = auditEl.querySelector('.audit-card');
  const action = currentAuditAction?.action || 'unknown';
  const delta = currentAuditAction?.delta || {};
  
  if (verdict === 'LOCK') {
    // LOCK ì• ë‹ˆë©”ì´ì…˜
    cardEl.classList.add('locking');
    
    // API í˜¸ì¶œ + Outcome íŒì •
    const riskBefore = state.risk;
    const recoveryBefore = planets9.RECOVERY || 0.5;
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOCK: ì‹¤ì œ ìƒíƒœ ë³€ê²½ (Delta ì ìš©)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const applyDelta = () => {
      // Deltaë¥¼ planets9ì— ì ìš© (0~1 ë²”ìœ„ ìœ ì§€)
      for (const key in delta) {
        if (planets9.hasOwnProperty(key)) {
          planets9[key] = clamp((planets9[key] || 0.5) + delta[key]);
        }
      }
      
      // Recalculate derived state
      calculateDerivedState();
      
      // UI ì—…ë°ì´íŠ¸
      renderPlanetList();
    };
    
    try {
      const response = await fetch('/autus/solar/release', { method: 'POST' });
      const result = await response.json();
      
      // ì„œë²„ ì‘ë‹µìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ìˆìœ¼ë©´)
      if (result.signals) {
        planets9.SHOCK = result.signals.entropy || planets9.SHOCK;
        planets9.FRICTION = result.signals.pressure || planets9.FRICTION;
        state.risk = Math.min(1, (planets9.SHOCK || 0.5) * 1.2 + (planets9.FRICTION || 0.5) * 0.3);
      } else {
        applyDelta();
      }
      
      const riskAfter = state.risk;
      const recoveryAfter = planets9.RECOVERY || 0.5;
      
      // Outcome íŒì •
      const outcome = classifyOutcome(riskBefore, riskAfter, recoveryBefore, recoveryAfter);
      logAction(`${outcome.icon} LOCKED: ${action.toUpperCase()} â†’ ${outcome.reason}`, outcome.type);
      logAction(`Risk: ${riskBefore.toFixed(2)} â†’ ${riskAfter.toFixed(2)}`, riskAfter < riskBefore ? 'info' : 'warning');
    } catch (e) {
      // ì˜¤í”„ë¼ì¸: ì˜ˆìƒ ê²°ê³¼ë¡œ ìƒíƒœ ë³€ê²½
      applyDelta();
      
      const riskAfter = state.risk;
      const recoveryAfter = planets9.RECOVERY || 0.5;
      const outcome = classifyOutcome(riskBefore, riskAfter, recoveryBefore, recoveryAfter);
      logAction(`${outcome.icon} LOCKED: ${action.toUpperCase()} â†’ ${outcome.reason}`, outcome.type);
      logAction(`Risk: ${riskBefore.toFixed(2)} â†’ ${riskAfter.toFixed(2)}`, riskAfter < riskBefore ? 'info' : 'warning');
    }
    
    // ì• ë‹ˆë©”ì´ì…˜ í›„ ë‹«ê¸°
    setTimeout(() => {
      auditEl.classList.remove('active');
      cardEl.classList.remove('locking');
      window.auditActive = false;
      renderPlanetList();
    }, 600);
    
  } else if (verdict === 'REJECT') {
    cardEl.classList.add('rejecting');
    logAction(`REJECTED: ${action.toUpperCase()}`);
    
    setTimeout(() => {
      auditEl.classList.remove('active');
      cardEl.classList.remove('rejecting');
      window.auditActive = false;
    }, 300);
    
  } else {
    logAction(`HOLD: ${action.toUpperCase()}`);
    // HOLDëŠ” íƒ€ì´ë¨¸ë§Œ ë©ˆì¶”ê³  ëŒ€ê¸°
    return;
  }
  
  // L5 MEMORYì— ê¸°ë¡
  const record = {
    time: new Date().toISOString(),
    action: action,
    verdict: verdict,
    delta: delta
  };
  memoryLog.unshift(record);
  renderMemoryList();
  
  currentAuditAction = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// L5 MEMORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMemoryList() {
  const container = document.getElementById('memory-list');
  container.innerHTML = memoryLog.slice(0, 20).map(item => {
    const time = new Date(item.time).toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    return `
      <div class="memory-item">
        <div class="time">${time}</div>
        <div class="action">${item.action.toUpperCase()}</div>
        <span class="verdict ${item.verdict.toLowerCase()}">${item.verdict}</span>
        <div class="delta">Î”REC: ${item.delta?.recovery || 0}</div>
      </div>
    `;
  }).join('');
}

// Memory filters
document.querySelectorAll('#layer-memory .filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#layer-memory .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    // Filter logic here if needed
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRITICAL PROTECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enforceCriticalProtection() {
  const isCritical = state.risk > POLICY.CRITICAL_THRESHOLD;
  
  if (isCritical && !lastCriticalState) {
    logAction('CRITICAL state entered', 'critical');
  }
  if (!isCritical && lastCriticalState) {
    logAction('CRITICAL state cleared');
  }
  lastCriticalState = isCritical;
  
  POLICY.CRITICAL_COLLAPSE.forEach(key => {
    const row = document.querySelector(`.planet-row[data-key="${key}"]`);
    if (row) row.classList.toggle('collapsed', isCritical);
  });
  
  const statusEl = document.getElementById('s-status');
  statusEl.textContent = isCritical ? 'CRITICAL' : state.risk > 0.35 ? 'WARNING' : 'STABLE';
  statusEl.className = 'stat-value' + (isCritical ? ' critical' : state.risk > 0.35 ? ' warning' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANET LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPlanetList() {
  const container = document.getElementById('planet-list');
  const isCritical = state.risk > POLICY.CRITICAL_THRESHOLD;
  
  container.innerHTML = PLANETS.map(p => {
    const value = Math.round((planets9[p.key] || 0.5) * 100);
    const isActive = p.key === selectedPlanet;
    const colorHex = '#' + p.color.toString(16).padStart(6, '0');
    const isCollapsed = isCritical && POLICY.CRITICAL_COLLAPSE.includes(p.key);
    
    return `
      <div class="planet-row ${isActive ? 'active' : ''} ${isCollapsed ? 'collapsed' : ''}" data-key="${p.key}" onclick="selectPlanet('${p.key}')">
        <div class="planet-dot" style="background:${colorHex}"></div>
      <span class="planet-name">${p.icon} ${p.name}</span>
        <span class="planet-val" style="color:${colorHex}">${value}%</span>
      </div>
    `;
  }).join('');
}

function selectPlanet(key) {
  if (state.risk > POLICY.CRITICAL_THRESHOLD && POLICY.CRITICAL_COLLAPSE.includes(key)) {
    logAction(`${key} blocked in CRITICAL`, 'warning');
    return;
  }
  selectedPlanet = key;
      renderPlanetList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePlanets() {
  planetsVisible = !planetsVisible;
  planetGroup.visible = planetsVisible;
  Object.values(planetLabelsEl).forEach(el => el.style.display = planetsVisible ? 'block' : 'none');
  document.querySelector('#controls button:nth-child(1)').classList.toggle('active', planetsVisible);
}

function toggleOrbits() {
  orbitsVisible = !orbitsVisible;
  orbitRings.forEach(r => r.visible = orbitsVisible);
  document.querySelector('#controls button:nth-child(2)').classList.toggle('active', orbitsVisible);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (e.key === 'c' || e.key === 'C') toggleLayer('core');
  if (e.key === 's' || e.key === 'S') toggleLayer('sim');
  if (e.key === 'a' || e.key === 'A') toggleLayer('action');
  if (e.key === 'm' || e.key === 'M') toggleLayer('memory');
  if (e.key === 'Escape') {
    document.getElementById('layer-audit').classList.remove('active');
    document.getElementById('layer-memory').classList.remove('active');
    activeLayers.memory = false;
    document.querySelector('.layer-toggle[data-layer="memory"]').classList.remove('active');
    clearTimeout(actionHoldTimer);
    clearInterval(auditTimer);
  }
  
  // Freeze í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ìˆ«ì í‚¤)
  if (e.key === '0') applyFreezeVisual(0); // NORMAL
  if (e.key === '1') applyFreezeVisual(1); // CAUTION
  if (e.key === '2') applyFreezeVisual(2); // FROZEN
  if (e.key === '3') applyFreezeVisual(3); // LOCKDOWN
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let time = 0;
let frames = 0, lastFPS = performance.now();
let lastFrameTime = performance.now();

function animate() {
  requestAnimationFrame(animate);
  
  // Delta time ê³„ì‚° (ì‹¤ì œ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ìš©)
  const now = performance.now();
  const dt = (now - lastFrameTime) / 1000;
  lastFrameTime = now;
  
  time += 0.016;
  
  // L4 AUDIT ì—´ë ¤ìˆìœ¼ë©´ íƒœì–‘ê³„ ì •ì§€, Freeze ë ˆë²¨ì— ë”°ë¼ ì†ë„ ì¡°ì ˆ
  const motionMult = window.freezeMotionMultiplier || 1.0;
  if (!window.auditActive) {
    globeGroup.rotation.y += 0.003 * motionMult;
  }
  
  if (planetsVisible) {
    PLANETS.forEach((p, i) => {
      const value = planets9[p.key] || 0.5;
      const group = planetMeshes[p.key];
      const angle = time * p.speed * 0.3 * motionMult + (i / PLANETS.length) * Math.PI * 2;
      const r = p.orbit + (value - 0.5) * 0.2;
      
      group.position.x = Math.cos(angle) * r;
      group.position.z = Math.sin(angle) * r;
      group.position.y = Math.sin(time * 0.2 + i) * 0.1;
      group.rotation.y += 0.02;
      group.scale.setScalar(p.key === selectedPlanet ? 1.5 : 1);
      
      const label = planetLabelsEl[p.key];
      const screenPos = group.position.clone().project(camera);
      if (screenPos.z < 1) {
        label.style.left = ((screenPos.x + 1) / 2 * innerWidth) + 'px';
        label.style.top = ((-screenPos.y + 1) / 2 * innerHeight - 22) + 'px';
        label.style.opacity = p.key === selectedPlanet ? '1' : '0.5';
      } else {
        label.style.opacity = '0';
      }
    });
  }
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // L2 PHYSICS-BASED FAILURE RING
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if (activeLayers.sim) {
    const rec = planets9.RECOVERY || 0.5;
    const sta = planets9.STABILITY || 0.5;
    const shk = planets9.SHOCK || 0.5;
    const fri = planets9.FRICTION || 0.5;
    
    // Calculate derived state from planets
    calculateDerivedState();
    
    // PhysicsFrame ì—…ë°ì´íŠ¸ (TwinState â†’ ë¬¼ë¦¬ê°’)
    updatePhysicsFrame();
    
    // Law 7: ì‹œê°„ ìƒìˆ˜ ê¸°ë°˜ ì• ë‹ˆë©”ì´ì…˜
    animatePhysicsFrame(dt);
    
    // Update kernel display panel (ì—­ì°¸ì¡°)
    updateKernelDisplay();
    
    // Failure Ring ë³€í˜• (Law 4,5,6 ì ìš©)
    deformFailureRing(time * motionMult);
    
    // Ghost Ring ë³€í˜• (Preview ì‹œ)
    deformGhostRing(time * motionMult);
    
    // Inner Health Ring (ê¸°ì¡´ ìœ ì§€)
    innerRingMat.color.setHex((rec + sta) / 2 > 0.4 ? 0x00ffaa : 0xff4444);
    innerRing.rotation.z += 0.003 * motionMult;
    
    // Outer Pressure Ring (ê¸°ì¡´ ìœ ì§€)
    outerRingMat.color.setHex((shk + fri) / 2 > 0.5 ? 0xff8844 : 0x44aaff);
    outerRing.rotation.z -= 0.002 * motionMult;
    
    // Failure Ring ì²œì²œíˆ íšŒì „
    failureRing.rotation.z += 0.001 * motionMult;
  }
  
  // FPS
  frames++;
  if (performance.now() - lastFPS >= 1000) {
    document.getElementById('sys-fps').textContent = frames;
    frames = 0;
    lastFPS = performance.now();
  }
  
  document.getElementById('s-orbit').textContent = Math.round(globeGroup.rotation.y * 180 / Math.PI % 360) + 'Â°';
  document.getElementById('m-entropy').textContent = (planets9.SHOCK || 0.5).toFixed(2);
  document.getElementById('m-pressure').textContent = (planets9.FRICTION || 0.5).toFixed(2);
  document.getElementById('m-risk').textContent = state.risk.toFixed(2);
  document.getElementById('m-flow').textContent = (planets9.TRANSFER || 0.5).toFixed(2);
  
  const riskEl = document.getElementById('m-risk');
  riskEl.className = 'metric-value' + (state.risk > 0.6 ? ' danger' : state.risk > 0.35 ? ' warning' : '');
  
  updateGateSLA();
  updateActionHUD();
  enforceCriticalProtection();
  
  renderer.render(scene, camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchState() {
  try {
    const r = await fetch('/shadow/snapshot/ENT_001');
    const data = await r.json();
    if (data.shadow) {
      PLANETS.forEach(p => planets9[p.key] = data.shadow[p.key.toLowerCase()] || 0.5);
    }
  } catch(e) {
    const base = { RECOVERY: 0.45, STABILITY: 0.32, COHESION: 0.38, SHOCK: 0.55, FRICTION: 0.48, TRANSFER: 0.62, TIME: 0.59, QUALITY: 0.70, OUTPUT: 0.53 };
    PLANETS.forEach(p => planets9[p.key] = base[p.key] || 0.5);
  }
  
  state.risk = Math.min(1, (planets9.SHOCK || 0.5) * 1.2 + (planets9.FRICTION || 0.5) * 0.3);
  renderPlanetList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let isDragging = false, prevMouse = { x: 0, y: 0 };
let cameraTheta = 0, cameraPhi = 1.0, cameraDistance = 16;

renderer.domElement.addEventListener('mousedown', e => { isDragging = true; prevMouse = { x: e.clientX, y: e.clientY }; });
renderer.domElement.addEventListener('mousemove', e => {
  if (!isDragging) return;
  cameraTheta += (e.clientX - prevMouse.x) * 0.005;
  cameraPhi = Math.max(0.3, Math.min(2.5, cameraPhi + (e.clientY - prevMouse.y) * 0.005));
  prevMouse = { x: e.clientX, y: e.clientY };
  camera.position.set(
    cameraDistance * Math.sin(cameraPhi) * Math.cos(cameraTheta),
    cameraDistance * Math.cos(cameraPhi),
    cameraDistance * Math.sin(cameraPhi) * Math.sin(cameraTheta)
  );
  camera.lookAt(0, 0, 0);
});
renderer.domElement.addEventListener('mouseup', () => isDragging = false);
renderer.domElement.addEventListener('wheel', e => {
  cameraDistance = Math.max(8, Math.min(30, cameraDistance + e.deltaY * 0.02));
  camera.position.set(
    cameraDistance * Math.sin(cameraPhi) * Math.cos(cameraTheta),
    cameraDistance * Math.cos(cameraPhi),
    cameraDistance * Math.sin(cameraPhi) * Math.sin(cameraTheta)
  );
  camera.lookAt(0, 0, 0);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onresize = () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
};

console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('  AUTUS SOLAR HQ â€” PHYSICS KERNEL v2.2 FROZEN');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('  Law 4: asymStrength = 0.95 Ã— max(shock, friction)');
console.log('  Law 5: radiusScale = 1 - 0.65 Ã— risk');
console.log('  Law 6: pulseHz = 0.5 Ã— (1 + 2 Ã— entropy)  [Aì•ˆ í™•ì •]');
console.log('  Law 7: Ï„-based exponential approach');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('  Bottleneck: SINGLE SOURCE (argmax weighted badness)');
console.log('  ImpulseProfiles: RECOVER / DEFRICTION / SHOCK_DAMP');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

// Initialize physics
calculateDerivedState();
updatePhysicsFrame();

logAction('Physics Engine v2.0 initialized');
logAction(`Risk: ${(state.risk * 100).toFixed(0)}% | Bottleneck: ${PhysicsFrame.bottleneck.axis}`, 'warning');

updateLayerDisplay();
fetchState();
setInterval(fetchState, 3000);
renderPlanetList();
animate();
  </script>
</body>
</html>

