<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AUTUS Solar HQ â€” Physics Kernel v2.4 EP10</title>
  <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  AUTUS SOLAR HQ â€” PHYSICS KERNEL v2.4 (EP10 FULL LOOP)        â•‘
    â•‘                                                               â•‘
    â•‘  v2.4 EP10 CHANGES:                                           â•‘
    â•‘  âœ“ DIGNITY = Quality Ã— Stability âˆ’ Entropy Ã— Friction         â•‘
    â•‘  âœ“ REPUTATION = âˆ’Future Shock Residual                        â•‘
    â•‘  âœ“ FORECAST BRANCH â€” ì„ íƒë³„ ë¯¸ë˜ ë¶„ê¸°                         â•‘
    â•‘  âœ“ ACTION VALUE â€” ğŸ’°Cost â±ï¸Time ğŸ›ï¸Dignity ğŸŒReputation        â•‘
    â•‘  âœ“ "ë¯¸ë˜ë¥¼ ë§íˆëŠ” ê²Œ ì•„ë‹ˆë¼ ë¯¸ë˜ì˜ ì°¨ì´ë¥¼ ë³´ì—¬ì¤€ë‹¤"           â•‘
    â•‘                                                               â•‘
    â•‘  FROZEN LAWS: 4/5/6/7                                         â•‘
    â•‘  FROZEN IMPULSE: RECOVER / DEFRICTION / SHOCK_DAMP            â•‘
    â•‘  USER VALUE: Costâ†“ Timeâ†“ Qualityâ†‘ Reputationâ†‘                 â•‘
    â•‘                                                               â•‘
    â•‘  BUILD: 2025-12-18 v2.4 EP10                                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <style>
    :root {
      --bg-primary: #020408;
      --bg-panel: rgba(0,20,40,0.95);
      --border-cyan: rgba(0,212,255,0.25);
      --text-primary: #fff;
      --text-secondary: #888;
      --accent-cyan: #00d4ff;
      --accent-green: #00ff88;
      --accent-orange: #ffaa00;
      --accent-red: #ff4444;
    }
    
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:var(--bg-primary);
      overflow:hidden;
      font-family:'Inter','SF Pro Display',system-ui,sans-serif;
      color:var(--text-primary);
    }
    
    .frame{position:fixed;top:24px;left:24px;right:24px;bottom:24px;border:1px solid var(--border-cyan);border-radius:6px;pointer-events:none;z-index:50}
    .corner{position:absolute;width:14px;height:14px}
    .corner::before,.corner::after{content:'';position:absolute;background:rgba(0,212,255,.4)}
    .corner.tl{top:-1px;left:-1px}.corner.tl::before{width:14px;height:1px}.corner.tl::after{width:1px;height:14px}
    .corner.tr{top:-1px;right:-1px}.corner.tr::before{width:14px;height:1px;right:0}.corner.tr::after{width:1px;height:14px;right:0}
    .corner.bl{bottom:-1px;left:-1px}.corner.bl::before{width:14px;height:1px;bottom:0}.corner.bl::after{width:1px;height:14px;bottom:0}
    .corner.br{bottom:-1px;right:-1px}.corner.br::before{width:14px;height:1px;bottom:0;right:0}.corner.br::after{width:1px;height:14px;bottom:0;right:0}
    
    .system-bar{
      position:fixed;top:0;left:0;right:0;height:24px;
      background:rgba(0,10,20,0.95);
      border-bottom:1px solid rgba(0,212,255,0.15);
      display:flex;justify-content:space-between;align-items:center;
      padding:0 40px;font-size:9px;letter-spacing:0.08em;z-index:300;
    }
    .system-bar .left{display:flex;gap:20px;color:#666}
    .system-bar .right{display:flex;gap:20px;color:var(--accent-cyan)}
    .system-bar .status-dot{width:6px;height:6px;border-radius:50%;margin-right:5px;display:inline-block}
    .system-bar .status-dot.ok{background:var(--accent-green)}
    .system-bar .status-dot.warn{background:var(--accent-orange)}
    
    .gate-container{
      position:fixed;top:32px;left:50%;transform:translateX(-50%);
      display:flex;gap:16px;align-items:center;z-index:200;
    }
    .gate-badge{
      padding:10px 20px;border:2px solid;border-radius:8px;
      font-size:14px;font-weight:700;letter-spacing:.15em;
    }
    .gate-green{background:rgba(0,255,120,.15);color:var(--accent-green);border-color:var(--accent-green)}
    .gate-amber{background:rgba(255,180,0,.15);color:var(--accent-orange);border-color:var(--accent-orange)}
    .gate-red{background:rgba(255,60,60,.15);color:var(--accent-red);border-color:var(--accent-red)}
    
    .kernel-display{
      display:none; /* B: ìˆ¨ê¹€ - ê°œë°œììš© */
      position:fixed;top:90px;right:40px;width:280px;
      background:var(--bg-panel);border:1px solid rgba(0,255,136,0.4);
      border-radius:8px;padding:16px;z-index:150;
    }
    .kernel-display .title{
      font-size:9px;letter-spacing:0.2em;color:rgba(0,255,136,0.9);
      margin-bottom:14px;padding-bottom:10px;
      border-bottom:1px solid rgba(0,255,136,0.3);
      display:flex;justify-content:space-between;align-items:center;
    }
    .kernel-display .title .version{
      background:rgba(0,255,136,0.2);color:var(--accent-green);
      padding:2px 8px;border-radius:4px;font-size:8px;
    }
    .kernel-section{margin-bottom:14px}
    .kernel-section-title{
      font-size:8px;letter-spacing:0.15em;color:#666;
      margin-bottom:8px;padding-bottom:4px;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .kernel-row{
      display:flex;justify-content:space-between;
      padding:5px 0;font-size:10px;
    }
    .kernel-key{color:var(--text-secondary)}
    .kernel-val{font-family:'SF Mono',monospace;font-weight:600}
    .kernel-val.danger{color:var(--accent-red)}
    .kernel-val.warning{color:var(--accent-orange)}
    .kernel-val.safe{color:var(--accent-green)}
    
    .single-source-badge{
      display:inline-block;padding:2px 6px;margin-left:6px;
      background:rgba(0,212,255,0.15);border:1px solid rgba(0,212,255,0.3);
      border-radius:3px;font-size:7px;color:var(--accent-cyan);
    }
    
    .bottleneck-display{
      margin-top:12px;padding:12px;
      background:rgba(255,68,68,0.1);
      border:1px solid rgba(255,68,68,0.3);
      border-radius:6px;
    }
    .bottleneck-display .bn-label{
      font-size:8px;letter-spacing:0.12em;color:rgba(255,68,68,0.8);
      margin-bottom:8px;display:flex;align-items:center;
    }
    .bottleneck-display .bn-value{
      font-size:16px;font-weight:700;color:var(--accent-red);
      display:flex;justify-content:space-between;align-items:center;
    }
    .bottleneck-display .bn-angle{
      font-size:10px;color:#888;font-weight:400;
    }
    .bottleneck-display .bn-warning{
      margin-top:8px;padding:8px;
      background:rgba(255,68,68,0.15);border-radius:4px;
      font-size:9px;color:var(--accent-red);
    }
    
    #info{display:none; /* B: ìˆ¨ê¹€ - ì¤‘ë³µ ì •ë³´ */ position:fixed;top:90px;left:40px;font-size:10px;z-index:95}
    #info h1{font-size:12px;font-weight:600;letter-spacing:.25em;color:var(--accent-cyan);margin-bottom:14px}
    .stat-row{display:flex;justify-content:space-between;width:180px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .stat-label{opacity:.5;font-size:9px}
    .stat-value{color:var(--accent-cyan);font-variant-numeric:tabular-nums;font-weight:500}
    .stat-value.critical{color:var(--accent-red)!important;font-weight:700}
    .stat-value.warning{color:var(--accent-orange)!important}
    
    #planets{position:fixed;top:220px;left:40px;width:200px;z-index:95}
    .panel-title{font-size:8px;letter-spacing:.18em;color:rgba(0,212,255,.6);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(0,212,255,.15)}
    .planet-row{
      display:flex;align-items:center;gap:8px;padding:6px 10px;margin-bottom:4px;
      background:rgba(0,20,40,.5);border:1px solid rgba(0,212,255,.12);border-radius:5px;
      cursor:pointer;transition:all .2s;
    }
    .planet-row:hover{background:rgba(0,212,255,.12);border-color:rgba(0,212,255,.35)}
    .planet-row.bottleneck-active{
      background:rgba(255,68,68,0.15);
      border-color:rgba(255,68,68,0.5);
      box-shadow:0 0 12px rgba(255,68,68,0.3);
    }
    .planet-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
    .planet-name{font-size:9px;flex:1;color:#ccc}
    .planet-val{font-size:10px;font-weight:600;font-family:'SF Mono',monospace}
    
    #twin-state{display:none; /* B: ìˆ¨ê¹€ - ì¤‘ë³µ ì •ë³´ */ position:fixed;top:520px;right:40px;width:280px;z-index:100}
    .metric-title{font-size:8px;letter-spacing:.18em;color:rgba(0,212,255,.6);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(0,212,255,.15);display:flex;justify-content:space-between;align-items:center}
    .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .metric-card{background:rgba(0,20,40,.7);border:1px solid rgba(0,212,255,.18);border-radius:6px;padding:10px;text-align:center}
    .metric-value{font-size:20px;font-weight:200;color:var(--accent-cyan)}
    .metric-value.warning{color:var(--accent-orange)}
    .metric-value.danger{color:var(--accent-red)}
    .metric-label{font-size:7px;opacity:.45;margin-top:3px;letter-spacing:.12em}
    
    #layer-action{
      position:fixed;bottom:80px;right:50px;
      display:flex;flex-direction:column;gap:12px;z-index:150;
    }
    #action-header{
      text-align:center;margin-bottom:16px;
    }
    .problem-indicator{
      background:linear-gradient(135deg, rgba(255,68,68,0.25), rgba(255,100,50,0.15));
      border:3px solid var(--accent-red);
      border-radius:12px;padding:16px 24px;margin-bottom:10px;
      box-shadow:0 4px 20px rgba(255,68,68,0.3);
    }
    .problem-label{font-size:11px;letter-spacing:0.12em;color:rgba(255,150,150,0.9);font-weight:600}
    .problem-value{display:block;font-size:28px;font-weight:800;color:#ff6666;margin-top:6px;text-shadow:0 0 20px rgba(255,100,100,0.5)}
    
    /* Bezos: ìœ„í—˜ ê²½ê³  â€” ë” ëˆˆì— ë„ê²Œ */
    .danger-warning{
      background:rgba(255,40,40,0.25);border:2px solid var(--accent-red);
      border-radius:10px;padding:12px 18px;margin-top:0;
      animation:danger-pulse 1.2s infinite;
    }
    .danger-warning .warn-text{font-size:12px;color:#ff8888;font-weight:700;letter-spacing:0.05em}
    @keyframes danger-pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:0.7;transform:scale(0.98)}
    }
    .action-btn{
      padding:18px 36px;border-radius:12px;font-size:14px;font-weight:700;
      letter-spacing:.15em;cursor:pointer;transition:all .25s;text-align:center;min-width:240px;
      position:relative;
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
    }
    .action-btn:hover:not(:disabled){transform:scale(1.08);box-shadow:0 8px 30px currentColor}
    .action-btn:disabled{opacity:.25;cursor:not-allowed}
    .action-btn.recover{background:rgba(0,255,136,.2);border:2px solid var(--accent-green);color:var(--accent-green)}
    .action-btn.defriction{background:rgba(68,170,255,.2);border:2px solid #44aaff;color:#44aaff}
    .action-btn.shock-damp{background:rgba(255,170,0,.2);border:2px solid var(--accent-orange);color:var(--accent-orange)}
    
    /* Elon+Bezos: CTA ê°•í™” â€” ì¶”ì²œ ë²„íŠ¼ */
    .action-btn-wrapper.recommended{
      position:relative;
    }
    .action-btn-wrapper.recommended .action-btn{
      animation:pulse-glow 1.5s infinite;
      box-shadow:0 0 35px currentColor;
      border-width:3px;
    }
    .action-btn-wrapper.recommended::before{
      content:'âš¡ ìµœì  ì„ íƒ';position:absolute;top:-32px;left:50%;transform:translateX(-50%);
      background:linear-gradient(90deg, #00ff88, #00ffcc);color:#000;padding:6px 16px;border-radius:14px;
      font-size:11px;font-weight:800;letter-spacing:0.12em;z-index:10;
      box-shadow:0 4px 15px rgba(0,255,136,0.4);
      animation:badge-bounce 2s infinite;
    }
    @keyframes pulse-glow{
      0%,100%{box-shadow:0 0 25px currentColor}
      50%{box-shadow:0 0 50px currentColor,0 0 80px currentColor}
    }
    @keyframes badge-bounce{
      0%,100%{transform:translateX(-50%) translateY(0)}
      50%{transform:translateX(-50%) translateY(-4px)}
    }
    .action-btn .btn-cost{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      font-size:8px;opacity:0.6;
    }
    .preview-label{font-size:8px;color:#666;text-align:center;margin-top:4px;letter-spacing:.12em}
    
    #action-log{
      display:none; /* B: ìˆ¨ê¹€ - ì •ë¦¬ í›„ ì¬ë°°ì¹˜ */
      position:fixed;right:40px;bottom:280px;width:280px;max-height:120px;
      overflow-y:auto;z-index:150;
      border:1px solid rgba(0,212,255,.2);border-radius:8px;padding:12px;
      background:rgba(0,10,20,.9);font-size:9px;line-height:1.6;
    }
    #action-log .log-title{font-size:8px;letter-spacing:.18em;color:rgba(0,212,255,.7);margin-bottom:8px}
    #action-log .log-item{color:#8ac;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)}
    #action-log .log-item.warning{color:var(--accent-orange)}
    #action-log .log-item.critical{color:var(--accent-red)}
    #action-log .log-item.success{color:var(--accent-green)}
    
    #layer-audit{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.92);backdrop-filter:blur(20px);
      display:none;justify-content:center;align-items:center;
      z-index:500;
    }
    #layer-audit.active{display:flex;animation:auditFadeIn 0.4s ease forwards}
    @keyframes auditFadeIn{from{opacity:0}to{opacity:1}}
    
    .audit-card{
      background:var(--bg-panel);border:2px solid rgba(0,212,255,0.4);
      border-radius:16px;padding:40px 50px;text-align:center;max-width:520px;
      box-shadow:0 0 60px rgba(0,212,255,0.3);
    }
    .audit-card h2{font-size:14px;letter-spacing:0.3em;color:rgba(0,212,255,0.9);margin-bottom:30px}
    
    .audit-summary{
      background:rgba(0,0,0,0.4);border:1px solid rgba(0,212,255,0.15);
      border-radius:10px;padding:20px;margin-bottom:20px;text-align:left;
    }
    .audit-summary .row{
      display:flex;justify-content:space-between;
      padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06);font-size:12px;
    }
    .audit-summary .row:last-child{border-bottom:none}
    .audit-summary .label{color:#888}
    .audit-summary .value{color:var(--accent-cyan);font-family:'SF Mono',monospace;font-weight:500}
    .audit-summary .value.positive{color:var(--accent-green)}
    .audit-summary .value.negative{color:var(--accent-red)}
    
    .audit-costs{
      background:rgba(255,68,68,0.05);border:1px solid rgba(255,68,68,0.2);
      border-radius:8px;padding:12px;margin-bottom:20px;text-align:left;
    }
    .audit-costs .costs-title{font-size:8px;letter-spacing:0.15em;color:rgba(255,68,68,0.8);margin-bottom:8px}
    .audit-costs .cost-item{
      display:inline-block;padding:4px 10px;margin:2px;
      background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);
      border-radius:4px;font-size:10px;color:var(--accent-red);
    }
    
    .audit-laws{
      background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);
      border-radius:8px;padding:12px;margin-bottom:20px;text-align:left;
    }
    .audit-laws .laws-title{font-size:8px;letter-spacing:0.15em;color:rgba(0,212,255,0.7);margin-bottom:8px}
    .audit-laws .law-tag{
      display:inline-block;padding:4px 10px;margin:2px;
      background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);
      border-radius:4px;font-size:9px;color:var(--accent-cyan);
    }
    
    .audit-buttons{display:flex;gap:15px;justify-content:center}
    .audit-btn{
      padding:16px 35px;border-radius:8px;font-size:13px;font-weight:600;
      letter-spacing:0.12em;cursor:pointer;transition:all 0.2s;
    }
    .audit-btn:hover{transform:scale(1.08)}
    .audit-btn.lock{background:rgba(0,255,136,0.15);border:2px solid var(--accent-green);color:var(--accent-green)}
    .audit-btn.reject{background:rgba(255,68,68,0.15);border:2px solid var(--accent-red);color:var(--accent-red)}
    .audit-btn.hold{background:rgba(255,170,0,0.15);border:2px solid var(--accent-orange);color:var(--accent-orange)}
    
    .audit-timer{font-size:12px;color:#666;margin-top:25px}
    .audit-timer .countdown{font-size:24px;font-weight:200;margin-left:8px}
    
    #controls{
      display:none; /* B: ìˆ¨ê¹€ - ê°œë°œììš© */
      position:fixed;bottom:40px;right:40px;
      gap:8px;z-index:100;
    }
    #controls button{
      padding:10px 16px;background:rgba(0,212,255,.1);
      border:1px solid rgba(0,212,255,.25);color:var(--accent-cyan);
      border-radius:5px;font-size:9px;cursor:pointer;transition:all .2s;
    }
    #controls button:hover{background:rgba(0,212,255,.2)}
    #controls button.active{background:rgba(0,212,255,.25);border-color:var(--accent-cyan)}
    
    .planet-label{
      position:absolute;font-size:10px;color:#fff;
      pointer-events:none;text-shadow:0 0 10px rgba(0,0,0,.95);
      white-space:nowrap;transition:opacity .2s;
    }
    
    .keyboard-hint{
      position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
      font-size:9px;color:#444;letter-spacing:0.1em;z-index:50;
    }
    
    .test-badge{
      display:none; /* B: ìˆ¨ê¹€ */
      position:fixed;bottom:40px;left:40px;
      padding:8px 16px;background:rgba(0,255,136,0.1);
      border:1px solid rgba(0,255,136,0.3);border-radius:6px;
      font-size:9px;color:var(--accent-green);z-index:100;
    }
    .test-badge.fail{background:rgba(255,68,68,0.1);border-color:rgba(255,68,68,0.3);color:var(--accent-red)}
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EP10: FORECAST BRANCH CARD + VALUE INDICATORS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    #forecast-panel{
      position:fixed;top:90px;left:40px;width:200px;
      background:var(--bg-panel);border:1px solid rgba(138,92,246,0.4);
      border-radius:8px;padding:14px;z-index:150;
    }
    .forecast-title{
      font-size:9px;letter-spacing:0.2em;color:rgba(138,92,246,0.9);
      margin-bottom:14px;padding-bottom:10px;
      border-bottom:1px solid rgba(138,92,246,0.3);
      display:flex;justify-content:space-between;align-items:center;
    }
    .forecast-title .tag{
      background:rgba(138,92,246,0.2);color:#8a5cf6;
      padding:2px 8px;border-radius:4px;font-size:8px;
    }
    .forecast-branch{
      padding:10px 12px;margin-bottom:8px;
      background:rgba(0,0,0,0.3);border-radius:6px;
      border-left:3px solid #666;transition:all 0.2s;
    }
    .forecast-branch.best{border-left-color:var(--accent-green);background:rgba(0,255,136,0.08)}
    .forecast-branch.neutral{display:none; /* B: ìˆ¨ê¹€ */ border-left-color:var(--accent-orange)}
    .forecast-branch.worst{display:none; /* B: ìˆ¨ê¹€ */ border-left-color:var(--accent-red);background:rgba(255,68,68,0.05)}
    .forecast-branch .branch-label{
      font-size:9px;letter-spacing:0.1em;color:#888;margin-bottom:6px;
    }
    .forecast-branch .branch-values{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .forecast-branch .value-chip{
      font-size:10px;font-weight:600;padding:2px 6px;
      border-radius:3px;background:rgba(255,255,255,0.05);
    }
    .forecast-branch .value-chip.positive{color:var(--accent-green)}
    .forecast-branch .value-chip.negative{color:var(--accent-red)}
    .forecast-branch .value-chip.neutral{color:var(--accent-orange)}
    
    /* Action Value Indicators */
    .action-btn-wrapper{
      position:relative;margin-bottom:8px;
    }
    .action-btn{
      width:100%;margin-bottom:0;
    }
    .value-indicators{
      display:flex;justify-content:space-around;
      padding:10px 8px;margin-top:-1px;
      background:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.15);
      border-top:none;border-radius:0 0 12px 12px;
      font-size:10px;
      flex-wrap:wrap;gap:4px;
    }
    .value-ind{display:flex;align-items:center;gap:2px;white-space:nowrap}
    .value-ind .icon{font-size:9px}
    .value-ind .val{font-weight:600;font-family:'SF Mono',monospace;font-size:9px}
    .value-ind .val.up{color:var(--accent-green)}
    .value-ind .val.down{color:var(--accent-red)}
    
    /* Dignity Badge â€” GATE ì˜†ì— ë‚˜ë€íˆ */
    #dignity-display{
      padding:10px 16px;border-radius:8px;
      font-size:12px;font-weight:600;letter-spacing:0.1em;
      transition:all 0.3s;
    }
    
    /* Dimon: Risk 24h íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ */
    #risk-chart-container{
      position:fixed;top:90px;right:40px;width:200px;
      background:var(--bg-panel);border:1px solid rgba(255,68,68,0.4);
      border-radius:8px;padding:12px;z-index:150;
    }
    .risk-chart-title{
      font-size:9px;letter-spacing:0.15em;color:rgba(255,68,68,0.9);
      margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;
    }
    .risk-chart-title .tag{
      background:rgba(255,68,68,0.2);color:#ff6666;
      padding:2px 6px;border-radius:4px;font-size:7px;
    }
    #risk-chart{
      width:100%;height:60px;border-radius:4px;
      background:rgba(0,0,0,0.3);
    }
    .risk-chart-stats{
      display:flex;justify-content:space-between;margin-top:8px;
      font-size:9px;color:#888;
    }
    .risk-chart-stats .stat{text-align:center}
    .risk-chart-stats .stat-value{font-size:11px;font-weight:600;color:var(--accent-red)}
    .risk-chart-stats .stat-value.up{color:var(--accent-red)}
    .risk-chart-stats .stat-value.down{color:var(--accent-green)}
    .risk-chart-stats .stat-label{font-size:7px;color:#666;margin-top:2px}
    
    /* Jack Ma: ì²« ì‚¬ìš©ì ì˜¨ë³´ë”© ê°€ì´ë“œ */
    #onboarding-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.92);backdrop-filter:blur(15px);
      display:flex;justify-content:center;align-items:center;
      z-index:1000;animation:fadeIn 0.5s ease;
    }
    #onboarding-overlay.hidden{display:none}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    
    .onboarding-card{
      background:linear-gradient(135deg, rgba(0,20,40,0.98), rgba(0,10,30,0.98));
      border:2px solid rgba(0,212,255,0.4);
      border-radius:20px;padding:40px;max-width:480px;
      text-align:center;box-shadow:0 0 80px rgba(0,212,255,0.2);
    }
    .onboarding-card .logo{
      font-size:48px;margin-bottom:16px;
    }
    .onboarding-card h2{
      font-size:24px;font-weight:300;color:var(--accent-cyan);
      margin-bottom:8px;letter-spacing:0.3em;
    }
    .onboarding-card .tagline{
      font-size:13px;color:#888;margin-bottom:32px;
    }
    
    .onboarding-steps{
      text-align:left;margin-bottom:32px;
    }
    .onboarding-step{
      display:flex;align-items:flex-start;gap:16px;
      padding:16px;margin-bottom:12px;
      background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.15);
      border-radius:12px;transition:all 0.2s;
    }
    .onboarding-step:hover{background:rgba(0,212,255,0.1);border-color:rgba(0,212,255,0.3)}
    .onboarding-step .step-icon{
      font-size:24px;width:40px;height:40px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,212,255,0.1);border-radius:10px;flex-shrink:0;
    }
    .onboarding-step .step-content h3{
      font-size:14px;font-weight:600;color:#fff;margin-bottom:4px;
    }
    .onboarding-step .step-content p{
      font-size:11px;color:#888;line-height:1.5;
    }
    
    .onboarding-actions{
      display:flex;flex-direction:column;gap:12px;align-items:center;
    }
    .onboarding-start{
      padding:16px 48px;background:linear-gradient(90deg, var(--accent-cyan), #00aaff);
      border:none;border-radius:30px;color:#000;font-size:14px;font-weight:700;
      letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;
    }
    .onboarding-start:hover{transform:scale(1.05);box-shadow:0 0 30px rgba(0,212,255,0.5)}
    .onboarding-skip{
      background:none;border:none;color:#666;font-size:11px;
      cursor:pointer;text-decoration:underline;
    }
    .onboarding-skip:hover{color:#888}
    
    /* Nadella: ê³µìœ  ê¸°ëŠ¥ */
    #share-button{
      position:fixed;top:32px;right:40px;
      padding:10px 18px;background:rgba(0,212,255,0.15);
      border:1px solid rgba(0,212,255,0.4);border-radius:8px;
      color:var(--accent-cyan);font-size:11px;font-weight:600;
      letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;z-index:200;
      display:flex;align-items:center;gap:8px;
    }
    #share-button:hover{background:rgba(0,212,255,0.25);transform:scale(1.05)}
    #share-button.copied{
      background:rgba(0,255,136,0.2);border-color:var(--accent-green);
      color:var(--accent-green);
    }
    
    /* ê³µìœ  í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .share-toast{
      position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);
      padding:14px 28px;background:rgba(0,255,136,0.15);
      border:1px solid var(--accent-green);border-radius:10px;
      color:var(--accent-green);font-size:12px;font-weight:600;
      opacity:0;transition:all 0.3s ease;z-index:500;
      pointer-events:none;
    }
    .share-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       P0 ì—…ë¬´ ìë™í™” PANEL â€” "Human decides once â†’ System closes forever"
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    #task-panel{
      position:fixed;bottom:100px;left:40px;width:280px;
      background:var(--bg-panel);border:1px solid rgba(255,170,0,0.4);
      border-radius:10px;padding:14px;z-index:160;
      max-height:300px;overflow-y:auto;
    }
    .task-panel-title{
      font-size:9px;letter-spacing:0.15em;color:rgba(255,170,0,0.9);
      margin-bottom:12px;padding-bottom:8px;
      border-bottom:1px solid rgba(255,170,0,0.3);
      display:flex;justify-content:space-between;align-items:center;
    }
    .task-panel-title .badge{
      background:rgba(255,68,68,0.2);color:#ff6666;
      padding:2px 8px;border-radius:10px;font-size:9px;font-weight:700;
    }
    
    .task-item{
      padding:12px;margin-bottom:8px;
      background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;cursor:pointer;transition:all 0.2s;
    }
    .task-item:hover{background:rgba(255,170,0,0.1);border-color:rgba(255,170,0,0.4)}
    .task-item.high{border-left:3px solid var(--accent-red)}
    .task-item.medium{border-left:3px solid var(--accent-orange)}
    .task-item.low{border-left:3px solid var(--accent-cyan)}
    
    .task-item .task-title{font-size:11px;font-weight:600;color:#fff;margin-bottom:4px}
    .task-item .task-desc{font-size:9px;color:#888;margin-bottom:8px}
    .task-item .task-actions{display:flex;gap:6px}
    .task-item .task-btn{
      flex:1;padding:6px 10px;border-radius:6px;font-size:9px;font-weight:600;
      cursor:pointer;transition:all 0.2s;text-align:center;
    }
    .task-item .task-btn.lock{background:rgba(0,255,136,0.15);border:1px solid var(--accent-green);color:var(--accent-green)}
    .task-item .task-btn.hold{background:rgba(255,170,0,0.15);border:1px solid var(--accent-orange);color:var(--accent-orange)}
    .task-item .task-btn.reject{background:rgba(255,68,68,0.15);border:1px solid var(--accent-red);color:var(--accent-red)}
    .task-item .task-btn:hover{transform:scale(1.05)}
    
    .task-empty{
      text-align:center;padding:20px;color:#666;font-size:10px;
    }
    .task-empty .icon{font-size:24px;margin-bottom:8px;display:block}
    
    /* Task ì™„ë£Œ í† ìŠ¤íŠ¸ */
    .task-toast{
      position:fixed;bottom:420px;left:40px;width:280px;
      padding:12px 16px;background:rgba(0,255,136,0.15);
      border:1px solid var(--accent-green);border-radius:8px;
      color:var(--accent-green);font-size:11px;font-weight:600;
      opacity:0;transform:translateY(10px);transition:all 0.3s;z-index:170;
    }
    .task-toast.show{opacity:1;transform:translateY(0)}
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COMMIT ì¤‘ì‹¬ â€” í•™ìƒ 1ëª… ì‹œë®¬ë ˆì´ì…˜ Panel
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    #commit-panel{
      position:fixed;top:90px;left:240px;width:320px;
      background:var(--bg-panel);border:1px solid rgba(138,92,246,0.4);
      border-radius:10px;padding:16px;z-index:160;
    }
    .commit-panel-title{
      font-size:10px;letter-spacing:0.15em;color:rgba(138,92,246,0.9);
      margin-bottom:12px;padding-bottom:8px;
      border-bottom:1px solid rgba(138,92,246,0.3);
      display:flex;justify-content:space-between;align-items:center;
    }
    .commit-panel-title .badge{
      padding:3px 8px;border-radius:10px;font-size:8px;font-weight:700;
    }
    .commit-panel-title .badge.green{background:rgba(0,255,136,0.2);color:var(--accent-green)}
    .commit-panel-title .badge.yellow{background:rgba(255,170,0,0.2);color:var(--accent-orange)}
    .commit-panel-title .badge.red{background:rgba(255,68,68,0.2);color:var(--accent-red)}
    
    .commit-person-card{
      padding:12px;margin-bottom:12px;
      background:rgba(0,0,0,0.3);border:1px solid rgba(138,92,246,0.2);
      border-radius:8px;
    }
    .commit-person-card .person-name{
      font-size:14px;font-weight:600;color:#fff;margin-bottom:4px;
    }
    .commit-person-card .person-role{
      font-size:9px;color:#888;letter-spacing:0.1em;
    }
    
    .commit-metrics{
      display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;
    }
    .commit-metric{
      padding:10px;background:rgba(0,0,0,0.4);
      border-radius:6px;text-align:center;
    }
    .commit-metric .metric-value{
      font-size:18px;font-weight:300;
    }
    .commit-metric .metric-value.danger{color:var(--accent-red)}
    .commit-metric .metric-value.warning{color:var(--accent-orange)}
    .commit-metric .metric-value.safe{color:var(--accent-green)}
    .commit-metric .metric-label{
      font-size:8px;color:#666;margin-top:4px;letter-spacing:0.1em;
    }
    
    .commit-list{
      max-height:150px;overflow-y:auto;
    }
    .commit-item{
      display:flex;align-items:center;justify-content:space-between;
      padding:8px 10px;margin-bottom:6px;
      background:rgba(0,0,0,0.3);border-radius:6px;
      border-left:3px solid #666;
    }
    .commit-item.tuition{border-left-color:#ff6666}
    .commit-item.wage{border-left-color:var(--accent-green)}
    .commit-item.grant{border-left-color:var(--accent-cyan)}
    .commit-item.management{border-left-color:var(--accent-orange)}
    
    .commit-item .commit-info{
      flex:1;
    }
    .commit-item .commit-type{
      font-size:9px;color:#888;letter-spacing:0.08em;
    }
    .commit-item .commit-amount{
      font-size:12px;font-weight:600;color:#fff;
    }
    .commit-item .commit-physics{
      text-align:right;font-size:9px;color:#666;
    }
    .commit-item .commit-physics .mass{color:var(--accent-cyan)}
    
    .commit-worst-case{
      padding:10px;margin-top:12px;
      background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);
      border-radius:6px;font-size:10px;color:#ff8888;
    }
    
    .commit-actions{
      display:flex;gap:8px;margin-top:12px;
    }
    .commit-action-btn{
      flex:1;padding:8px;border-radius:6px;font-size:9px;font-weight:600;
      cursor:pointer;transition:all 0.2s;text-align:center;
    }
    .commit-action-btn.primary{
      background:rgba(138,92,246,0.2);border:1px solid rgba(138,92,246,0.5);
      color:#8a5cf6;
    }
    .commit-action-btn.primary:hover{background:rgba(138,92,246,0.3)}
    .commit-action-btn.secondary{
      background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);
      color:#888;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       6ê°œ ì—­í•  ì‹œìŠ¤í…œ â€” ì—­í•  ì„ íƒ UI
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    #role-selector{
      position:fixed;top:32px;left:40px;
      display:flex;gap:6px;z-index:200;
    }
    .role-btn{
      padding:8px 12px;background:rgba(0,0,0,0.5);
      border:1px solid rgba(255,255,255,0.2);border-radius:6px;
      font-size:10px;color:#888;cursor:pointer;transition:all 0.2s;
      display:flex;align-items:center;gap:6px;
    }
    .role-btn:hover{background:rgba(255,255,255,0.1);color:#fff}
    .role-btn.active{
      background:rgba(138,92,246,0.2);border-color:rgba(138,92,246,0.5);
      color:#8a5cf6;
    }
    .role-btn .role-icon{font-size:12px}
    .role-btn .role-priority{
      font-size:8px;opacity:0.6;
    }
    
    /* ì—­í• ë³„ í…Œë§ˆ ìƒ‰ìƒ */
    .role-btn.subject.active{border-color:var(--accent-cyan);color:var(--accent-cyan)}
    .role-btn.operator.active{border-color:var(--accent-green);color:var(--accent-green)}
    .role-btn.sponsor.active{border-color:#ffd700;color:#ffd700}
    .role-btn.employer.active{border-color:var(--accent-orange);color:var(--accent-orange)}
    .role-btn.institution.active{border-color:#8a5cf6;color:#8a5cf6}
    .role-btn.system.active{border-color:var(--accent-red);color:var(--accent-red)}
    
    /* ì—­í•  ì •ë³´ íŒ¨ë„ */
    #role-info{
      position:fixed;top:70px;left:40px;width:220px;
      background:var(--bg-panel);border:1px solid rgba(138,92,246,0.3);
      border-radius:8px;padding:12px;z-index:190;
      display:none;
    }
    #role-info.visible{display:block}
    .role-info-title{
      font-size:11px;font-weight:600;color:#fff;margin-bottom:8px;
      display:flex;align-items:center;gap:8px;
    }
    .role-info-title .icon{font-size:16px}
    .role-info-perms{
      font-size:9px;color:#888;
    }
    .role-info-perms .perm-item{
      display:flex;justify-content:space-between;padding:4px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .role-info-perms .perm-value.yes{color:var(--accent-green)}
    .role-info-perms .perm-value.no{color:var(--accent-red)}
    .role-info-perms .perm-value.read{color:var(--accent-cyan)}
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ì˜¨ë³´ë”© + Magic Link ì¸ì¦ UI
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    #auth-overlay{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);
      display:flex;justify-content:center;align-items:center;
      z-index:2000;
    }
    #auth-overlay.hidden{display:none}
    
    .auth-card{
      background:linear-gradient(135deg, rgba(0,20,40,0.98), rgba(0,10,30,0.98));
      border:2px solid rgba(0,212,255,0.4);border-radius:20px;
      padding:40px;max-width:420px;width:90%;
      text-align:center;box-shadow:0 0 60px rgba(0,212,255,0.2);
    }
    .auth-card .logo{font-size:48px;margin-bottom:16px}
    .auth-card h2{font-size:20px;color:var(--accent-cyan);margin-bottom:8px;letter-spacing:0.2em}
    .auth-card .subtitle{font-size:11px;color:#888;margin-bottom:32px}
    
    .auth-input{
      width:100%;padding:14px 18px;margin-bottom:16px;
      background:rgba(0,0,0,0.4);border:1px solid rgba(0,212,255,0.3);
      border-radius:10px;color:#fff;font-size:14px;
      outline:none;transition:all 0.2s;
    }
    .auth-input:focus{border-color:var(--accent-cyan);box-shadow:0 0 15px rgba(0,212,255,0.2)}
    .auth-input::placeholder{color:#666}
    
    .auth-btn{
      width:100%;padding:14px;
      background:linear-gradient(90deg, var(--accent-cyan), #00aaff);
      border:none;border-radius:10px;color:#000;
      font-size:14px;font-weight:700;cursor:pointer;
      transition:all 0.2s;margin-bottom:12px;
    }
    .auth-btn:hover{transform:scale(1.02);box-shadow:0 0 20px rgba(0,212,255,0.4)}
    .auth-btn:disabled{opacity:0.5;cursor:not-allowed}
    
    .auth-link{
      color:var(--accent-cyan);font-size:11px;
      text-decoration:underline;cursor:pointer;
    }
    
    /* ì˜¨ë³´ë”© ìŠ¤í… */
    .onboarding-steps{
      display:flex;justify-content:center;gap:8px;margin-bottom:24px;
    }
    .onboarding-step-dot{
      width:10px;height:10px;border-radius:50%;
      background:rgba(255,255,255,0.2);transition:all 0.3s;
    }
    .onboarding-step-dot.active{background:var(--accent-cyan);box-shadow:0 0 10px var(--accent-cyan)}
    .onboarding-step-dot.completed{background:var(--accent-green)}
    
    .onboarding-form{display:none}
    .onboarding-form.active{display:block}
    
    .auth-success{
      padding:20px;background:rgba(0,255,136,0.1);
      border:1px solid var(--accent-green);border-radius:10px;
      color:var(--accent-green);margin-bottom:16px;
    }
    
    /* ê³„ì•½ì„œ ë¯¸ë¦¬ë³´ê¸° */
    #contract-modal{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.9);display:none;
      justify-content:center;align-items:center;z-index:1500;
    }
    #contract-modal.visible{display:flex}
    
    .contract-preview{
      background:#fff;color:#000;width:90%;max-width:600px;
      max-height:80vh;overflow-y:auto;padding:40px;border-radius:10px;
    }
    .contract-preview h1{font-size:18px;margin-bottom:20px;color:#000}
    .contract-preview h2{font-size:14px;margin-top:20px;color:#333}
    .contract-preview p{font-size:12px;line-height:1.6;color:#444}
    .contract-preview .signature{
      margin-top:30px;padding-top:20px;border-top:1px solid #ddd;
      font-size:10px;color:#888;
    }
    .contract-actions{
      display:flex;gap:10px;margin-top:20px;
    }
    .contract-actions button{
      flex:1;padding:12px;border-radius:6px;font-size:12px;cursor:pointer;
    }
    .contract-actions .print{background:#000;color:#fff;border:none}
    .contract-actions .close{background:#eee;color:#333;border:1px solid #ddd}
    
    /* Musk: ë¹ ë¥¸ ì‹¤í–‰ ëª¨ë“œ */
    .quick-exec-hint{
      position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
      padding:8px 16px;background:rgba(0,212,255,0.1);
      border:1px solid rgba(0,212,255,0.3);border-radius:20px;
      font-size:10px;color:var(--accent-cyan);z-index:100;
      display:flex;align-items:center;gap:8px;
    }
    .quick-exec-hint kbd{
      padding:2px 6px;background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.2);border-radius:4px;
      font-family:'SF Mono',monospace;font-size:9px;
    }
    
    /* ì¦‰ì‹œ ì‹¤í–‰ í† ìŠ¤íŠ¸ */
    .exec-toast{
      position:fixed;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.9);
      padding:24px 40px;background:rgba(0,255,136,0.2);
      border:2px solid var(--accent-green);border-radius:16px;
      color:var(--accent-green);font-size:16px;font-weight:700;
      letter-spacing:0.1em;opacity:0;z-index:600;
      pointer-events:none;transition:all 0.3s ease;
    }
    .exec-toast.show{opacity:1;transform:translate(-50%, -50%) scale(1)}
    #dignity-display.low{background:rgba(255,68,68,0.15);border:1px solid var(--accent-red);color:var(--accent-red)}
    #dignity-display.balanced{background:rgba(255,170,0,0.15);border:1px solid var(--accent-orange);color:var(--accent-orange)}
    #dignity-display.elevated{background:rgba(0,255,136,0.15);border:1px solid var(--accent-green);color:var(--accent-green)}
    
    /* Reputation Status */
    .reputation-status{
      margin-top:8px;padding:8px;
      background:rgba(138,92,246,0.1);border:1px solid rgba(138,92,246,0.3);
      border-radius:4px;font-size:9px;color:#8a5cf6;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PHASE 1: HOVER SIMULATION CARD + CONFIDENCE + PHYSICS REASON
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .hover-sim-card{
      position:absolute;left:calc(100% + 16px);top:0;width:300px;
      background:var(--bg-panel);border:1px solid rgba(0,212,255,0.4);
      border-radius:10px;padding:16px;z-index:300;
      opacity:0;visibility:hidden;transition:all 0.2s ease;
      box-shadow:0 10px 40px rgba(0,0,0,0.5);
    }
    .action-btn-wrapper:hover .hover-sim-card{
      opacity:1;visibility:visible;
    }
    .hover-sim-card .sim-title{
      font-size:10px;letter-spacing:0.15em;color:var(--accent-cyan);
      margin-bottom:12px;padding-bottom:8px;
      border-bottom:1px solid rgba(0,212,255,0.2);
    }
    
    /* BEST/LIKELY/WORST Branches */
    .sim-branch{
      padding:10px;margin-bottom:8px;border-radius:6px;
      background:rgba(0,0,0,0.3);position:relative;
    }
    .sim-branch.best{border-left:3px solid var(--accent-green)}
    .sim-branch.likely{border-left:3px solid var(--accent-cyan)}
    .sim-branch.worst{border-left:3px solid var(--accent-red)}
    .sim-branch .branch-tag{
      position:absolute;top:8px;right:8px;
      font-size:8px;font-weight:700;letter-spacing:0.1em;
      padding:2px 6px;border-radius:3px;
    }
    .sim-branch.best .branch-tag{background:rgba(0,255,136,0.2);color:var(--accent-green)}
    .sim-branch.likely .branch-tag{background:rgba(0,212,255,0.2);color:var(--accent-cyan)}
    .sim-branch.worst .branch-tag{background:rgba(255,68,68,0.2);color:var(--accent-red)}
    .sim-branch .branch-delta{
      font-size:11px;font-weight:600;margin-bottom:4px;
    }
    .sim-branch .branch-metrics{
      font-size:9px;color:#888;
    }
    .sim-branch .branch-metrics span{margin-right:8px}
    
    /* Confidence Bar */
    .confidence-row{
      display:flex;align-items:center;gap:8px;margin-top:4px;
    }
    .confidence-bar{
      flex:1;height:4px;background:rgba(255,255,255,0.1);
      border-radius:2px;overflow:hidden;
    }
    .confidence-fill{
      height:100%;border-radius:2px;transition:width 0.3s;
    }
    .confidence-fill.high{background:var(--accent-green)}
    .confidence-fill.mid{background:var(--accent-cyan)}
    .confidence-fill.low{background:var(--accent-red)}
    .confidence-pct{
      font-size:9px;font-weight:600;min-width:32px;text-align:right;
    }
    
    /* Physics Reason */
    .physics-reason{
      margin-top:12px;padding:10px;
      background:rgba(255,170,0,0.08);border:1px solid rgba(255,170,0,0.25);
      border-radius:6px;font-size:9px;line-height:1.5;
    }
    .physics-reason .reason-icon{margin-right:6px}
    .physics-reason .reason-text{color:var(--accent-orange)}
    
    /* Recommended Badge */
    .recommended-badge{
      position:absolute;top:-8px;right:-8px;
      background:var(--accent-green);color:#000;
      font-size:8px;font-weight:700;letter-spacing:0.1em;
      padding:3px 8px;border-radius:10px;
      animation:pulse-badge 2s infinite;
    }
    @keyframes pulse-badge{
      0%,100%{box-shadow:0 0 0 0 rgba(0,255,136,0.4)}
      50%{box-shadow:0 0 0 8px rgba(0,255,136,0)}
    }
    
    /* #6 ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    @media (max-width: 1200px) {
      #forecast-panel { left: 20px; width: 180px; padding: 12px; }
      #commit-panel { left: 20px; top: auto; bottom: 320px; width: 200px; }
      #risk-chart-container { right: 20px; width: 180px; }
      #planets { left: 20px; width: 180px; }
      #layer-action { right: 20px; }
      .action-btn { min-width: 200px; padding: 14px 24px; font-size: 12px; }
    }
    
    @media (max-width: 900px) {
      .system-bar { padding: 0 20px; font-size: 8px; }
      .gate-container { gap: 8px; }
      .gate-badge { padding: 8px 14px; font-size: 12px; }
      #dignity-display { padding: 8px 12px; font-size: 10px; }
      #forecast-panel { display: none; }
      #commit-panel { display: none; }
      #risk-chart-container { top: 70px; right: 10px; width: 150px; padding: 8px; }
      #risk-chart { height: 40px; }
      .risk-chart-stats { font-size: 8px; }
      #planets { top: 80px; width: 160px; }
      .planet-row { padding: 4px 8px; font-size: 10px; }
      #task-panel { left: 10px; width: 160px; bottom: 60px; max-height: 180px; }
      .task-item { padding: 8px; }
      .task-item .task-title { font-size: 10px; }
      .task-item .task-btn { padding: 4px 6px; font-size: 8px; }
      #layer-action { bottom: 60px; right: 10px; }
      .action-btn { min-width: 160px; padding: 12px 16px; font-size: 11px; }
      #action-header { display: none; }
    }
    
    @media (max-width: 600px) {
      .system-bar .left { display: none; }
      .gate-container { top: 50px; }
      #risk-chart-container { display: none; }
      #task-panel { display: none; }
      #planets { top: 100px; left: 10px; width: 140px; }
      .panel-title { font-size: 7px; }
      #layer-action { bottom: 40px; right: 5px; gap: 8px; }
      .action-btn { min-width: 140px; padding: 10px 12px; font-size: 10px; }
      .value-indicators { display: none; }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PRODUCTION MODE â€” "ì™„ì œí’ˆ ì²´ê°" v2.0
       "ì„¤ëª…í•˜ëŠ” í™”ë©´" â†’ "ì™„ê²° OS"
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    /* === 1. ì—­í•  UI ì™„ì „ ì œê±° â€” URL íŒŒë¼ë¯¸í„°ë¡œë§Œ ì²˜ë¦¬ === */
    #role-selector { display: none !important; }
    #role-info { display: none !important; }

    /* === 2. ì¢Œì¸¡ íŒ¨ë„ ìˆ¨ê¹€ â€” Operator ëª¨ë“œì—ì„œë§Œ í‘œì‹œ === */
    #panel-forecast { display: none !important; }
    #planets { display: none !important; }
    body.operator-mode #panel-forecast { display: block !important; }
    body.operator-mode #planets { display: block !important; }

    /* === 3. Commit Dashboard ì •ë¦¬ â€” ìƒíƒœ ì•„ì´ì½˜ë§Œ === */
    #commit-dashboard { display: none !important; }

    /* === 4. Risk Trend ìˆ¨ê¹€ â€” ê³µìœ  ë§í¬ì—ì„œë§Œ í‘œì‹œ === */
    #risk-chart-container { display: none !important; }
    body.shared-view #risk-chart-container { display: block !important; }

    /* === 5. ACTION ë‹¨ì¼í™” â€” JSë¡œ ë™ì  ì œì–´ === */
    .action-btn-wrapper { display: none !important; }
    .action-btn-wrapper.primary-action { display: block !important; }
    
    /* ë‹¨ì¼ ACTION ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .action-btn-wrapper.primary-action .action-btn {
      font-size: 18px !important;
      padding: 20px 48px !important;
      letter-spacing: 0.12em !important;
      min-width: 220px !important;
    }
    
    /* Value Indicators ë‹¨ìˆœí™” â€” ì•„ì´ì½˜+ìˆ«ìë§Œ */
    .action-btn-wrapper.primary-action .value-indicators {
      justify-content: center !important;
      gap: 16px !important;
    }
    .value-ind .val { font-size: 13px !important; }

    /* === 6. ì„¤ëª… í…ìŠ¤íŠ¸ ë‹¨ìˆœí™” === */
    .danger-warning .warn-text {
      font-size: 13px !important;
    }
    #action-header { display: none !important; }

    /* === 7. PENDING TASKS ìˆ¨ê¹€ === */
    #pending-tasks { display: none !important; }

    /* === 8. ë‹¨ì¶•í‚¤ ì•ˆë‚´ ì œê±° === */
    .keyboard-hint { display: none !important; }
    .quick-exec-hint { display: none !important; }
    .test-badge { display: none !important; }

    /* === 9. ê°œë°œì íŒ¨ë„ ìˆ¨ê¹€ === */
    .kernel-display { display: none !important; }
    #panel-metrics { display: none !important; }
    #action-log { display: none !important; }
    body.operator-mode #action-log { display: block !important; }

    /* === 10. ì‹œìŠ¤í…œ ë°” ë‹¨ìˆœí™” === */
    .system-bar .left span:nth-child(3) { display: none !important; }

    /* === 11. Gate/Dignity ê°•ì¡° === */
    .gate-container { gap: 20px !important; }
    #gate-badge, #dignity-display {
      font-size: 15px !important;
      padding: 12px 24px !important;
    }

    /* === 12. Risk % ê°•ì¡° === */
    #action-risk-container {
      transform: scale(1.15);
      margin-bottom: 24px !important;
    }
    #action-risk { font-size: 56px !important; }
    .action-risk-label { display: none !important; }

    /* === 13. AUDIT ì¹¨ë¬µ ëª¨ë“œ === */
    body.audit-mode .gate-container,
    body.audit-mode #share-button,
    body.audit-mode .system-bar,
    body.audit-mode #layer-action .danger-warning {
      opacity: 0.15 !important;
      pointer-events: none !important;
      transition: opacity 0.4s ease !important;
    }
    
    body.audit-mode #layer-audit {
      z-index: 500 !important;
    }
    
    body.audit-mode .audit-card {
      transform: scale(1.02) !important;
      box-shadow: 0 0 60px rgba(0, 212, 255, 0.3) !important;
    }

    /* === 14. SHARE ë²„íŠ¼ === */
    #share-button {
      top: 90px !important;
      right: 40px !important;
    }
    
  </style>
</head>
<body>
  <!-- Magic Link ì¸ì¦ + ì˜¨ë³´ë”© í”Œë¡œìš° -->
  <div id="auth-overlay" class="hidden">
    <div class="auth-card">
      <div class="logo">ğŸŒ</div>
      <h2>AUTUS</h2>
      <p class="subtitle">ë¹„ë°€ë²ˆí˜¸ ì—†ì´, ì´ë©”ì¼ë§Œìœ¼ë¡œ ë¡œê·¸ì¸</p>
      
      <!-- ë¡œê·¸ì¸ í¼ -->
      <div id="auth-login" class="onboarding-form active">
        <input type="email" class="auth-input" id="auth-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        <button class="auth-btn" onclick="requestMagicLink()">ğŸ”— Magic Link ë°›ê¸°</button>
        <p class="auth-link" onclick="showOnboarding()">ì²˜ìŒì´ì‹ ê°€ìš”? ë“±ë¡í•˜ê¸°</p>
  </div>
  
      <!-- ì˜¨ë³´ë”© Step 1 -->
      <div id="onboard-step1" class="onboarding-form">
        <div class="onboarding-steps">
          <div class="onboarding-step-dot active"></div>
          <div class="onboarding-step-dot"></div>
          <div class="onboarding-step-dot"></div>
          <div class="onboarding-step-dot"></div>
        </div>
        <h3 style="color:#fff;margin-bottom:16px">Step 1: ê¸°ë³¸ ì •ë³´</h3>
        <input type="text" class="auth-input" id="ob-name" placeholder="ì´ë¦„">
        <input type="email" class="auth-input" id="ob-email" placeholder="ì´ë©”ì¼">
        <select class="auth-input" id="ob-country">
          <option value="PH">Philippines</option>
          <option value="VN">Vietnam</option>
          <option value="ID">Indonesia</option>
          <option value="KR">Korea</option>
        </select>
        <button class="auth-btn" onclick="submitOnboardingStep(1)">ë‹¤ìŒ â†’</button>
      </div>
      
      <!-- ì˜¨ë³´ë”© Step 2 -->
      <div id="onboard-step2" class="onboarding-form">
        <div class="onboarding-steps">
          <div class="onboarding-step-dot completed"></div>
          <div class="onboarding-step-dot active"></div>
          <div class="onboarding-step-dot"></div>
          <div class="onboarding-step-dot"></div>
        </div>
        <h3 style="color:#fff;margin-bottom:16px">Step 2: êµìœ¡ ì •ë³´</h3>
        <input type="text" class="auth-input" id="ob-university" placeholder="ëŒ€í•™êµëª…">
        <input type="text" class="auth-input" id="ob-major" placeholder="ì „ê³µ">
        <input type="number" class="auth-input" id="ob-tuition" placeholder="ë“±ë¡ê¸ˆ (ì›)">
        <button class="auth-btn" onclick="submitOnboardingStep(2)">ë‹¤ìŒ â†’</button>
      </div>
      
      <!-- ì˜¨ë³´ë”© Step 3 -->
      <div id="onboard-step3" class="onboarding-form">
        <div class="onboarding-steps">
          <div class="onboarding-step-dot completed"></div>
          <div class="onboarding-step-dot completed"></div>
          <div class="onboarding-step-dot active"></div>
          <div class="onboarding-step-dot"></div>
        </div>
        <h3 style="color:#fff;margin-bottom:16px">Step 3: ì·¨ì—… ì •ë³´</h3>
        <input type="text" class="auth-input" id="ob-employer" placeholder="íšŒì‚¬ëª…">
        <input type="text" class="auth-input" id="ob-job" placeholder="ì§ë¬´">
        <input type="number" class="auth-input" id="ob-wage" placeholder="ì›”ê¸‰ (ì›)">
        <button class="auth-btn" onclick="submitOnboardingStep(3)">ë‹¤ìŒ â†’</button>
      </div>
      
      <!-- ì˜¨ë³´ë”© Step 4 -->
      <div id="onboard-step4" class="onboarding-form">
        <div class="onboarding-steps">
          <div class="onboarding-step-dot completed"></div>
          <div class="onboarding-step-dot completed"></div>
          <div class="onboarding-step-dot completed"></div>
          <div class="onboarding-step-dot active"></div>
        </div>
        <h3 style="color:#fff;margin-bottom:16px">Step 4: ì§€ì› ì •ë³´ (ì„ íƒ)</h3>
        <input type="text" class="auth-input" id="ob-sponsor" placeholder="ì¥í•™ì¬ë‹¨ (ì„ íƒ)">
        <input type="number" class="auth-input" id="ob-grant" placeholder="ì¥í•™ê¸ˆ (ì›, ì„ íƒ)">
        <button class="auth-btn" onclick="submitOnboardingStep(4)">ì™„ë£Œ âœ“</button>
        <p class="auth-link" onclick="submitOnboardingStep(4)">ê±´ë„ˆë›°ê¸°</p>
      </div>
      
      <!-- ì™„ë£Œ -->
      <div id="onboard-complete" class="onboarding-form">
        <div class="auth-success">
          âœ“ ì˜¨ë³´ë”© ì™„ë£Œ!<br>
          ì´ì œ AUTUSì—ì„œ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        <button class="auth-btn" onclick="closeAuthOverlay()">ì‹œì‘í•˜ê¸° â†’</button>
      </div>
      
      <!-- Magic Link ì „ì†¡ë¨ -->
      <div id="auth-sent" class="onboarding-form">
        <div class="auth-success">
          âœ“ Magic Link ì „ì†¡ë¨!<br>
          ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
        </div>
        <p class="auth-link" onclick="showLogin()">ë‹¤ì‹œ ì‹œë„</p>
      </div>
    </div>
  </div>
  
  <!-- ê³„ì•½ì„œ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <div id="contract-modal">
    <div class="contract-preview" id="contract-content">
      <h1>ê³„ì•½ì„œ ë¡œë”© ì¤‘...</h1>
    </div>
  </div>
  
  <!-- Jack Ma: ì²« ì‚¬ìš©ì ì˜¨ë³´ë”© -->
  <div id="onboarding-overlay">
    <div class="onboarding-card">
      <div class="logo">ğŸŒ</div>
      <h2>AUTUS SOLAR HQ</h2>
      <p class="tagline">ë¯¸ë˜ë¥¼ ë§íˆëŠ” ê²Œ ì•„ë‹ˆë¼, ë” ë‚˜ì€ ì„ íƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤</p>
      
      <div class="onboarding-steps">
        <div class="onboarding-step">
          <div class="step-icon">ğŸ“Š</div>
          <div class="step-content">
            <h3>1. í˜„ì¬ ìƒíƒœ í™•ì¸</h3>
            <p>RISK ìˆ˜ì¹˜ì™€ íŠ¸ë Œë“œ ì°¨íŠ¸ë¡œ ì‹œìŠ¤í…œ ê±´ê°• ìƒíƒœë¥¼ í•œëˆˆì— íŒŒì•…í•˜ì„¸ìš”</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="step-icon">âš¡</div>
          <div class="step-content">
            <h3>2. ìµœì  ì„ íƒ í™•ì¸</h3>
            <p>"âš¡ ìµœì  ì„ íƒ" ë°°ì§€ê°€ ë¶™ì€ ë²„íŠ¼ì´ ê°€ì¥ íš¨ê³¼ì ì¸ ì¡°ì¹˜ì…ë‹ˆë‹¤</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="step-icon">ğŸ’°</div>
          <div class="step-content">
            <h3>3. êµ¬ì²´ì  ë¹„ìš© ì ˆê°</h3>
            <p>ê° ë²„íŠ¼ ì•„ë˜ì— ì‹¤ì œ ì ˆê° ê¸ˆì•¡ê³¼ ì‹œê°„ì´ í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
        </div>
      </div>
      
      <div class="onboarding-actions">
        <button class="onboarding-start" onclick="closeOnboarding()">ì‹œì‘í•˜ê¸°</button>
        <button class="onboarding-skip" onclick="closeOnboarding(true)">ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°</button>
      </div>
    </div>
  </div>

  <div class="frame">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
  </div>
  
  <div class="system-bar">
    <div class="left">
      <span><span class="status-dot ok"></span>KERNEL v2.4 EP10</span>
      <span><span class="status-dot" id="api-status-dot"></span><span id="api-status">CONNECTING...</span></span>
      <span><span class="status-dot ok"></span>FUTURE VALUE</span>
    </div>
    <div class="right">
      <span>FPS: <span id="sys-fps">60</span></span>
      <span id="sys-time"></span>
    </div>
  </div>
  
  <!-- 6ê°œ ì—­í•  ì„ íƒ -->
  <div id="role-selector">
    <button class="role-btn subject active" onclick="switchRole('subject')" title="ë‹¹ì‚¬ì (í•™ìƒ/ê·¼ë¡œì)">
      <span class="role-icon">ğŸ‘¤</span>
      <span>Subject</span>
    </button>
    <button class="role-btn operator" onclick="switchRole('operator')" title="ìš´ì˜ì (ATB)">
      <span class="role-icon">ğŸ”§</span>
      <span>Operator</span>
    </button>
    <button class="role-btn sponsor" onclick="switchRole('sponsor')" title="ìê¸ˆ ì œê³µì">
      <span class="role-icon">ğŸ’°</span>
      <span>Sponsor</span>
    </button>
    <button class="role-btn employer" onclick="switchRole('employer')" title="ê³ ìš©ì£¼">
      <span class="role-icon">ğŸ¢</span>
      <span>Employer</span>
    </button>
    <button class="role-btn institution" onclick="switchRole('institution')" title="ì œë„ ì œê³µì">
      <span class="role-icon">ğŸ›ï¸</span>
      <span>Institution</span>
    </button>
  </div>
  
  <!-- ì—­í•  ì •ë³´ íŒ¨ë„ -->
  <div id="role-info">
    <div class="role-info-title">
      <span class="icon" id="role-info-icon">ğŸ‘¤</span>
      <span id="role-info-name">Subject</span>
    </div>
    <div class="role-info-perms" id="role-info-perms">
      <div class="perm-item"><span>Action</span><span class="perm-value yes">âœ“</span></div>
      <div class="perm-item"><span>Commit</span><span class="perm-value no">âœ—</span></div>
      <div class="perm-item"><span>Audit</span><span class="perm-value read">ì—´ëŒ</span></div>
    </div>
  </div>
  
  <div class="gate-container">
    <div id="gate-badge" class="gate-badge gate-amber">GATE: AMBER</div>
    <div id="dignity-display" class="balanced">DIGNITY: BALANCED</div>
  </div>
  
  <!-- Nadella: ê³µìœ  ë²„íŠ¼ -->
  <button id="share-button" onclick="shareCurrentState()">
    <span>ğŸ“¤</span> SHARE
  </button>
  <div class="share-toast" id="share-toast">âœ“ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>
  
  <!-- Dimon: Risk 24h History Chart -->
  <div id="risk-chart-container">
    <div class="risk-chart-title">
      <span>ğŸ“ˆ RISK TREND</span>
      <span class="tag">24h</span>
    </div>
    <canvas id="risk-chart"></canvas>
    <div class="risk-chart-stats">
      <div class="stat">
        <div class="stat-value" id="risk-min">0%</div>
        <div class="stat-label">MIN</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="risk-current">0%</div>
        <div class="stat-label">NOW</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="risk-max">0%</div>
        <div class="stat-label">MAX</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="risk-trend">â€”</div>
        <div class="stat-label">TREND</div>
      </div>
    </div>
  </div>
  
  <!-- COMMIT ì¤‘ì‹¬ â€” í•™ìƒ 1ëª… ì‹œë®¬ë ˆì´ì…˜ -->
  <div id="commit-panel">
    <div class="commit-panel-title">
      <span>ğŸ‘¤ COMMIT DASHBOARD</span>
      <span class="badge green" id="commit-status">STABLE</span>
    </div>
    
    <div class="commit-person-card" id="commit-person">
      <div class="person-name">â€” ë¡œë”© ì¤‘ â€”</div>
      <div class="person-role">STUDENT</div>
  </div>
  
    <div class="commit-metrics">
      <div class="commit-metric">
        <div class="metric-value safe" id="survival-mass">0.0</div>
        <div class="metric-label">SURVIVAL MASS</div>
      </div>
      <div class="commit-metric">
        <div class="metric-value" id="risk-score">0</div>
        <div class="metric-label">RISK SCORE</div>
      </div>
    </div>
    
    <div class="commit-list" id="commit-list">
      <div style="text-align:center;color:#666;font-size:10px;padding:20px">
        ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘...
      </div>
    </div>
    
    <div class="commit-worst-case" id="worst-case">
      âš ï¸ ìƒíƒœ ë¶„ì„ ì¤‘...
    </div>
    
    <div class="commit-actions">
      <button class="commit-action-btn primary" onclick="createDemoStudent()">ğŸ“Š ë°ëª¨ ìƒì„±</button>
      <button class="commit-action-btn secondary" onclick="refreshCommitData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="commit-actions" style="margin-top:8px">
      <button class="commit-action-btn secondary" onclick="generateContract('STU_001')" style="flex:1">ğŸ“„ ê³„ì•½ì„œ</button>
      <button class="commit-action-btn secondary" onclick="showAuthOverlay()" style="flex:1">ğŸ”‘ ë¡œê·¸ì¸</button>
    </div>
  </div>
  
  <!-- EP10: FORECAST BRANCH PANEL -->
  <div id="forecast-panel">
    <div class="forecast-title">
      <span>FUTURE BRANCH</span>
      <span class="tag">Î”t +1h</span>
    </div>
    <div class="forecast-branch best" id="fc-best">
      <div class="branch-label">IF SHOCK DAMP:</div>
      <div class="branch-values">
        <span class="value-chip positive">ğŸ’° Cost âˆ’32%</span>
        <span class="value-chip positive">â±ï¸ Time âˆ’18%</span>
        <span class="value-chip positive">ğŸŒ Rep +0.6Ïƒ</span>
      </div>
    </div>
    <div class="forecast-branch neutral" id="fc-mid">
      <div class="branch-label">IF RECOVER:</div>
      <div class="branch-values">
        <span class="value-chip positive">ğŸ›ï¸ Quality +21%</span>
        <span class="value-chip positive">âš ï¸ Risk âˆ’9%</span>
        <span class="value-chip neutral">â±ï¸ Time âˆ’5%</span>
      </div>
    </div>
    <div class="forecast-branch worst" id="fc-worst">
      <div class="branch-label">IF NO ACTION:</div>
      <div class="branch-values">
        <span class="value-chip negative">ğŸ“ˆ Entropy +14%</span>
        <span class="value-chip negative">âš ï¸ Shock ì§€ì†</span>
        <span class="value-chip negative">ğŸŒ Rep âˆ’0.3Ïƒ</span>
      </div>
    </div>
    <div class="reputation-status" id="rep-status">ğŸŒ External Perception: Volatile</div>
  </div>
  
  <div class="kernel-display">
    <div class="title">
      <span>PHYSICS KERNEL</span>
      <span class="version">v2.4 EP10</span>
    </div>
    
    <div class="kernel-section">
      <div class="kernel-section-title">RING PHYSICS <span class="single-source-badge">SINGLE SOURCE</span></div>
      <div class="kernel-row"><span class="kernel-key">radiusScale</span><span class="kernel-val" id="pf-radius">1.00</span></div>
      <div class="kernel-row"><span class="kernel-key">thickness</span><span class="kernel-val" id="pf-thick">0.15</span></div>
      <div class="kernel-row"><span class="kernel-key">pulseHz</span><span class="kernel-val" id="pf-pulse">0.50</span></div>
      <div class="kernel-row"><span class="kernel-key">asymStrength</span><span class="kernel-val" id="pf-asym">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">asymAngle</span><span class="kernel-val" id="pf-angle">0Â°</span></div>
    </div>
    
    <div class="kernel-section">
      <div class="kernel-section-title">SNAPSHOT <span class="single-source-badge">SINGLE SOURCE</span></div>
      <div class="kernel-row"><span class="kernel-key">risk</span><span class="kernel-val" id="snap-risk">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">entropy</span><span class="kernel-val" id="snap-entropy">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">pressure</span><span class="kernel-val" id="snap-pressure">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">flow</span><span class="kernel-val" id="snap-flow">0.00</span></div>
    </div>
    
    <div class="bottleneck-display">
      <div class="bn-label">â–¼ BOTTLENECK <span class="single-source-badge">SINGLE SOURCE</span></div>
      <div class="bn-value">
        <span id="bn-axis">â€”</span>
        <span class="bn-angle" id="bn-angle">0Â°</span>
      </div>
      <div class="bn-warning" id="bn-warning">âš ï¸ â€” bottleneck detected</div>
    </div>
  </div>
  
  <div id="info">
    <h1>SOLAR HQ Â· EP10</h1>
    <div class="stat-row"><span class="stat-label">KERNEL</span><span class="stat-value">v2.4 EP10</span></div>
    <div class="stat-row"><span class="stat-label">LAWS</span><span class="stat-value">4/5/6/7 âœ“</span></div>
    <div class="stat-row"><span class="stat-label">VALUE</span><span class="stat-value">ğŸ’°â±ï¸ğŸ›ï¸ğŸŒ</span></div>
    <div class="stat-row"><span class="stat-label">SINGLE SRC</span><span class="stat-value">âœ“ LOCKED</span></div>
    <div class="stat-row"><span class="stat-label">STATUS</span><span class="stat-value" id="s-status">STABLE</span></div>
  </div>
  
  <div id="planets">
    <div class="panel-title">9 PLANETS Â· TwinState</div>
    <div id="planet-list"></div>
  </div>
  
  <!-- P0 ì—…ë¬´ ìë™í™” Panel -->
  <div id="task-panel">
    <div class="task-panel-title">
      <span>ğŸ“‹ PENDING TASKS</span>
      <span class="badge" id="task-count">0</span>
    </div>
    <div id="task-list">
      <div class="task-empty">
        <span class="icon">âœ…</span>
        ëª¨ë“  ì—…ë¬´ ì™„ë£Œ
      </div>
    </div>
  </div>
  <div class="task-toast" id="task-toast">âœ“ ì—…ë¬´ ì™„ë£Œ</div>
  
  <div id="twin-state">
    <div class="metric-title">
      <span>DERIVED STATE</span>
      <span class="single-source-badge">FROM SNAPSHOT</span>
    </div>
      <div class="metric-grid">
        <div class="metric-card"><div class="metric-value" id="m-entropy">0.00</div><div class="metric-label">ENTROPY</div></div>
        <div class="metric-card"><div class="metric-value" id="m-pressure">0.00</div><div class="metric-label">PRESSURE</div></div>
        <div class="metric-card"><div class="metric-value" id="m-risk">0.00</div><div class="metric-label">RISK</div></div>
        <div class="metric-card"><div class="metric-value" id="m-flow">0.00</div><div class="metric-label">FLOW</div></div>
    </div>
      </div>
  
  <div id="action-log">
    <div class="log-title">ACTION LOG</div>
    <div id="log-items"></div>
    </div>
  
  <div id="layer-action">
    <!-- Elon+Bezos: í•µì‹¬ ì§€í‘œ + ìœ„í—˜ ê²½ê³  -->
    <div id="action-header">
      <div class="problem-indicator">
        <span class="problem-label">âš ï¸ í˜„ì¬ RISK</span>
        <span class="problem-value" id="action-risk">58%</span>
      </div>
      <div class="danger-warning">
        <span class="warn-text" id="no-action-warning">â° í–‰ë™ ì•ˆ í•˜ë©´: 24h ë‚´ ë¶•ê´´ ìœ„í—˜ â†‘</span>
      </div>
    </div>
    <div class="action-btn-wrapper" id="wrapper-recover">
      <button class="action-btn recover" onclick="previewAction('recover', event)">RECOVER</button>
      <div class="value-indicators" id="vi-recover">
        <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val down">âˆ’8%</span></span>
        <span class="value-ind"><span class="icon">â±ï¸</span><span class="val down">âˆ’5%</span></span>
        <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val up">+0.2</span></span>
        <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val up">+0.1Ïƒ</span></span>
      </div>
      <div class="hover-sim-card" id="sim-recover"></div>
    </div>
    <div class="action-btn-wrapper" id="wrapper-defriction">
      <button class="action-btn defriction" onclick="previewAction('defriction', event)">DEFRICTION</button>
      <div class="value-indicators" id="vi-defriction">
        <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val down">âˆ’12%</span></span>
        <span class="value-ind"><span class="icon">â±ï¸</span><span class="val down">âˆ’10%</span></span>
        <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val">+0.1</span></span>
        <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val up">+0.2Ïƒ</span></span>
      </div>
      <div class="hover-sim-card" id="sim-defriction"></div>
    </div>
    <div class="action-btn-wrapper" id="wrapper-shock_damp">
      <button class="action-btn shock-damp" onclick="previewAction('shock_damp', event)">SHOCK DAMP</button>
      <div class="value-indicators" id="vi-shock_damp">
        <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val down">âˆ’32%</span></span>
        <span class="value-ind"><span class="icon">â±ï¸</span><span class="val down">âˆ’18%</span></span>
        <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val up">+0.3</span></span>
        <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val up">+0.6Ïƒ</span></span>
      </div>
      <div class="hover-sim-card" id="sim-shock_damp"></div>
    </div>
    <div class="preview-label">â–² ë¯¸ë˜ ê°€ì¹˜ ìƒì„±ê¸° Â· HOVERë¡œ ì‹œë®¬ë ˆì´ì…˜ Â· CLICKìœ¼ë¡œ AUDIT</div>
  </div>
  
  <div id="layer-audit">
    <div class="audit-card">
      <h2>AUDIT Â· PHYSICS VERIFICATION</h2>
      <div class="audit-summary">
        <div class="row"><span class="label">Impulse</span><span class="value" id="audit-action">RECOVER</span></div>
        <div class="row"><span class="label">Î” Risk</span><span class="value" id="audit-risk">0% â†’ 0%</span></div>
        <div class="row"><span class="label">Î” Bottleneck</span><span class="value" id="audit-bn">â€” â†’ â€”</span></div>
        <div class="row"><span class="label">Confidence</span><span class="value" id="audit-conf">0%</span></div>
      </div>
      <div class="audit-costs">
        <div class="costs-title">âš ï¸ TRADE-OFF COSTS</div>
        <div id="audit-costs-list"></div>
      </div>
      <div class="audit-laws">
        <div class="laws-title">LAWS APPLIED</div>
        <span class="law-tag">Law 4: Shockâ†’Asym</span>
        <span class="law-tag">Law 5: Riskâ†’Radius</span>
        <span class="law-tag">Law 6: Entropyâ†’Pulse</span>
        <span class="law-tag">Law 7: Ï„-Transition</span>
      </div>
      <div class="audit-buttons">
        <button class="audit-btn lock" onclick="auditDecision('LOCK')">LOCK</button>
        <button class="audit-btn hold" onclick="auditDecision('HOLD')">HOLD</button>
        <button class="audit-btn reject" onclick="auditDecision('REJECT')">REJECT</button>
      </div>
      <div class="audit-timer">Auto-reject in <span id="audit-countdown" class="countdown">30</span>s</div>
    </div>
  </div>
  
  <div id="controls">
    <button onclick="togglePlanets()" class="active">PLANETS</button>
    <button onclick="toggleOrbits()">ORBITS</button>
    <button onclick="runAcceptanceTests()">RUN TESTS</button>
  </div>
  
  <div class="test-badge" id="test-badge">TESTS: â€”</div>
  
  <div class="keyboard-hint">[ESC] Close Â· [R] Reset Â· [T] Run Tests</div>
  
  <!-- Musk: ë¹ ë¥¸ ì‹¤í–‰ íŒíŠ¸ -->
  <div class="quick-exec-hint">
    <kbd>âŒ˜</kbd>/<kbd>Ctrl</kbd> + Click = ì¦‰ì‹œ ì‹¤í–‰ (AUDIT ìŠ¤í‚µ)
  </div>
  <div class="exec-toast" id="exec-toast">âš¡ ì¦‰ì‹œ ì‹¤í–‰ ì™„ë£Œ</div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTUS PHYSICS KERNEL v2.4 â€” EP10 FULL LOOP
   
   "AutusëŠ” ë¯¸ë˜ë¥¼ ë§íˆëŠ” ì‹œìŠ¤í…œì´ ì•„ë‹ˆë¼,
    ì‚¬ëŒì´ ë” í’ˆìœ„ ìˆëŠ” ì„ íƒì„ í•˜ë„ë¡
    ë¯¸ë˜ì˜ ì°¨ì´ë¥¼ ë³´ì—¬ì£¼ëŠ” ì‹œìŠ¤í…œì´ë‹¤."
   
   EP10 CHANGES:
   1. DIGNITY = Quality Ã— Stability âˆ’ Entropy Ã— Friction
   2. REPUTATION = âˆ’Future Shock Residual
   3. FORECAST BRANCH â€” ì„ íƒë³„ ë¯¸ë˜ ë¶„ê¸° í‘œì‹œ
   4. ACTION VALUE â€” ğŸ’°Cost â±ï¸Time ğŸ›ï¸Dignity ğŸŒReputation
   5. USER VALUE MAPPING:
      - ì›ê°€ ì ˆê° â†’ Entropyâ†“ + Frictionâ†“
      - ì‹œê°„ ì ˆê° â†’ Timeâ†“ + Pressureâ†“
      - í’ˆìœ„ ìƒìŠ¹ â†’ Qualityâ†‘ + Stabilityâ†‘
      - ëª…ì„± ì¦ê°€ â†’ Outputâ†‘ + Shockâ†“
   
   SINGLE SOURCE PIPELINE:
   TwinState â†’ computeDerived() â†’ PhysicsFrame.snapshot (+ dignity, reputation)
                                â†’ PhysicsFrame.actionValues (per action)
                                â†’ FORECAST BRANCH UI
                                â†’ VALUE INDICATORS UI
   
   BUILD: 2025-12-18 v2.4 EP10
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS CONSTANTS â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PHYSICS = Object.freeze({
  RISK_COMPRESSION: 0.65,
  BASE_RADIUS: 8.0,
  PRESSURE_MULT: 1.2,
  BASE_THICKNESS: 0.15,
  ENTROPY_MULT: 2.0,
  BASE_PULSE: 0.5,
  SHOCK_ASYM: 0.95,
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEZOS: êµ¬ì²´ì  ë¹„ìš© í‘œì‹œ â€” ì‹¤ì œ ê¸ˆì•¡ìœ¼ë¡œ ê°€ì¹˜ ì²´ê°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COST_CONFIG = Object.freeze({
  BASE_MONTHLY_COST: 10000000,   // ì›” ìš´ì˜ë¹„ ê¸°ì¤€: â‚©10,000,000
  BASE_HOURLY_RATE: 50000,       // ì‹œê°„ë‹¹ ë¹„ìš©: â‚©50,000
  CURRENCY: 'â‚©',
  LOCALE: 'ko-KR'
});

// ê¸ˆì•¡ í¬ë§· í•¨ìˆ˜ (Bezos: êµ¬ì²´ì  ìˆ«ìë¡œ ì‹ ë¢° êµ¬ì¶•)
function formatCurrency(amount) {
  if (Math.abs(amount) >= 1000000) {
    return `${COST_CONFIG.CURRENCY}${(amount / 10000).toLocaleString(COST_CONFIG.LOCALE)}ë§Œ`;
  }
  return `${COST_CONFIG.CURRENCY}${amount.toLocaleString(COST_CONFIG.LOCALE)}`;
}

// ì‹œê°„ í¬ë§· í•¨ìˆ˜
function formatTime(hours) {
  if (hours >= 24) return `${Math.round(hours / 24)}ì¼`;
  if (hours >= 1) return `${Math.round(hours)}ì‹œê°„`;
  return `${Math.round(hours * 60)}ë¶„`;
}

const TAU = Object.freeze({
  radiusScale: 0.8, thickness: 0.6, pulseHz: 0.4, asymStrength: 0.7, asymAngle: 0.9,
});

const BOTTLENECK_WEIGHTS = Object.freeze({
  RECOVERY: 0.20, STABILITY: 0.15, COHESION: 0.10,
  SHOCK: 0.25, FRICTION: 0.15, TRANSFER: 0.05,
  TIME: 0.05, QUALITY: 0.03, OUTPUT: 0.02,
});

const BOTTLENECK_ANGLES = Object.freeze({
  RECOVERY: 0, STABILITY: Math.PI*0.25, COHESION: Math.PI*0.50,
  SHOCK: Math.PI*1.25, FRICTION: Math.PI*0.75, TRANSFER: Math.PI*1.50,
  TIME: Math.PI*1.75, QUALITY: Math.PI, OUTPUT: Math.PI*0.125,
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPULSE PROFILES â€” FROZEN (v1.0)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IMPULSE_PROFILES = Object.freeze({
  recover: {
    name: 'RECOVER', description: 'ì—ë„ˆì§€ ì¬ë¶„ë°°',
    delta: { RECOVERY: +0.15, STABILITY: +0.06, COHESION: +0.04, TRANSFER: -0.06, OUTPUT: -0.04, TIME: +0.03 },
    bottleneckBonus: { axes: ['SHOCK', 'FRICTION'], delta: { SHOCK: -0.05, FRICTION: -0.05 } },
    confidence: 87, costs: ['TRAâ†“6%', 'OUTâ†“4%', 'TIMâ†‘3%']
  },
  defriction: {
    name: 'DEFRICTION', description: 'ë§ˆì°° ê°ì†Œ',
    delta: { FRICTION: -0.18, SHOCK: -0.07, TRANSFER: +0.06, TIME: -0.05, QUALITY: -0.04, OUTPUT: -0.03 },
    bottleneckBonus: { axes: ['FRICTION'], delta: { FRICTION: -0.04 } },
    confidence: 82, costs: ['QUAâ†“4%', 'OUTâ†“3%']
  },
  shock_damp: {
    name: 'SHOCK_DAMP', description: 'ì¶©ê²© ê°ì‡ ',
    delta: { SHOCK: -0.25, STABILITY: +0.08, COHESION: +0.05, RECOVERY: -0.10, TIME: +0.04, OUTPUT: -0.05, FRICTION: -0.03 },
    bottleneckBonus: { axes: ['SHOCK'], delta: { SHOCK: -0.05 } },
    confidence: 91, costs: ['RECâ†“10%', 'TIMâ†‘4%', 'OUTâ†“5%']
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANETS CONFIG â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLANETS = Object.freeze([
  { key: 'RECOVERY',  name: 'Recovery',  icon: 'ğŸ”§', color: 0x44ff44, size: 0.14, orbit: 5.4, speed: 0.50, positive: true },
  { key: 'STABILITY', name: 'Stability', icon: 'ğŸ¯', color: 0x8844ff, size: 0.20, orbit: 4.4, speed: 0.35, positive: true, rings: true },
  { key: 'COHESION',  name: 'Cohesion',  icon: 'ğŸ”—', color: 0xff44aa, size: 0.13, orbit: 4.9, speed: 0.60, positive: true },
  { key: 'SHOCK',     name: 'Shock',     icon: 'âš ï¸', color: 0xff8800, size: 0.19, orbit: 6.4, speed: 0.30, positive: false },
  { key: 'FRICTION',  name: 'Friction',  icon: 'âš¡', color: 0xff4444, size: 0.16, orbit: 3.9, speed: 0.45, positive: false },
  { key: 'TRANSFER',  name: 'Transfer',  icon: 'ğŸ“¡', color: 0x44aaff, size: 0.12, orbit: 5.9, speed: 0.75, positive: true, rings: true },
  { key: 'TIME',      name: 'Time',      icon: 'â±ï¸', color: 0xffaa00, size: 0.14, orbit: 3.4, speed: 0.85, positive: false },
  { key: 'QUALITY',   name: 'Quality',   icon: 'ğŸ›¡ï¸', color: 0x00d4ff, size: 0.15, orbit: 2.9, speed: 0.55, positive: true, rings: true },
  { key: 'OUTPUT',    name: 'Output',    icon: 'ğŸ”¥', color: 0x00ff88, size: 0.18, orbit: 2.4, speed: 0.70, positive: true }
]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE â€” SINGLE SOURCE OF TRUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TwinState = {
  RECOVERY: 0.42, STABILITY: 0.55, COHESION: 0.62,
  SHOCK: 0.72, FRICTION: 0.79, TRANSFER: 0.60,
  TIME: 0.50, QUALITY: 0.68, OUTPUT: 0.55
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIMON: Risk 24h History â€” ë¦¬ìŠ¤í¬ íŠ¸ë Œë“œ ì¶”ì 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RISK_HISTORY_CONFIG = {
  maxPoints: 60,           // 60ê°œ í¬ì¸íŠ¸ (1ì‹œê°„ì— 60ê°œ â†’ 24hëŠ” 1440ê°œì§€ë§Œ í™”ë©´ ì œì•½)
  sampleInterval: 2000,    // 2ì´ˆë§ˆë‹¤ ìƒ˜í”Œë§ (ë°ëª¨ìš©, ì‹¤ì œëŠ” ë” ê¸¸ê²Œ)
  chartColor: '#ff4444',
  chartColorGood: '#00ff88'
};

const riskHistory = [];
let lastRiskSample = 0;

function sampleRiskHistory() {
  const now = Date.now();
  if (now - lastRiskSample < RISK_HISTORY_CONFIG.sampleInterval) return;
  lastRiskSample = now;
  
  const risk = PhysicsFrame.snapshot.risk;
  riskHistory.push({ time: now, value: risk });
  
  // ìµœëŒ€ ê°œìˆ˜ ìœ ì§€
  while (riskHistory.length > RISK_HISTORY_CONFIG.maxPoints) {
    riskHistory.shift();
  }
  
  renderRiskChart();
}

function renderRiskChart() {
  const canvas = document.getElementById('risk-chart');
  if (!canvas || riskHistory.length < 2) return;
  
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2;
  const H = canvas.height = canvas.offsetHeight * 2;
  ctx.clearRect(0, 0, W, H);
  
  // ë°ì´í„° ë¶„ì„
  const values = riskHistory.map(d => d.value);
  const minVal = Math.min(...values);
  const maxVal = Math.max(...values);
  const range = Math.max(maxVal - minVal, 0.1);
  const currentVal = values[values.length - 1];
  const prevVal = values[Math.max(0, values.length - 10)]; // 10ê°œ ì „ ê°’
  const trend = currentVal - prevVal;
  
  // ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
  const gradient = ctx.createLinearGradient(0, 0, 0, H);
  gradient.addColorStop(0, 'rgba(255, 68, 68, 0.3)');
  gradient.addColorStop(1, 'rgba(255, 68, 68, 0.05)');
  
  // ì°¨íŠ¸ ê·¸ë¦¬ê¸° â€” ì˜ì—­
  ctx.beginPath();
  ctx.moveTo(0, H);
  
  values.forEach((val, i) => {
    const x = (i / (values.length - 1)) * W;
    const y = H - ((val - minVal) / range) * H * 0.85 - H * 0.05;
    if (i === 0) ctx.lineTo(x, y);
    else ctx.lineTo(x, y);
  });
  
  ctx.lineTo(W, H);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();
  
  // ë¼ì¸ ê·¸ë¦¬ê¸°
  ctx.beginPath();
  values.forEach((val, i) => {
    const x = (i / (values.length - 1)) * W;
    const y = H - ((val - minVal) / range) * H * 0.85 - H * 0.05;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.strokeStyle = currentVal > 0.5 ? RISK_HISTORY_CONFIG.chartColor : RISK_HISTORY_CONFIG.chartColorGood;
  ctx.lineWidth = 3;
  ctx.stroke();
  
  // í˜„ì¬ ì  í‘œì‹œ
  const lastX = W;
  const lastY = H - ((currentVal - minVal) / range) * H * 0.85 - H * 0.05;
  ctx.beginPath();
  ctx.arc(lastX - 4, lastY, 6, 0, Math.PI * 2);
  ctx.fillStyle = currentVal > 0.5 ? '#ff4444' : '#00ff88';
  ctx.fill();
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 2;
  ctx.stroke();
  
  // í†µê³„ ì—…ë°ì´íŠ¸
  document.getElementById('risk-min').textContent = `${Math.round(minVal * 100)}%`;
  document.getElementById('risk-current').textContent = `${Math.round(currentVal * 100)}%`;
  document.getElementById('risk-current').className = 'stat-value ' + (currentVal > 0.5 ? 'up' : 'down');
  document.getElementById('risk-max').textContent = `${Math.round(maxVal * 100)}%`;
  
  const trendEl = document.getElementById('risk-trend');
  if (Math.abs(trend) < 0.02) {
    trendEl.textContent = 'â†’';
    trendEl.className = 'stat-value';
  } else if (trend > 0) {
    trendEl.textContent = 'â†‘' + Math.round(trend * 100);
    trendEl.className = 'stat-value up';
  } else {
    trendEl.textContent = 'â†“' + Math.round(Math.abs(trend) * 100);
    trendEl.className = 'stat-value down';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CONNECTION â€” Phase 1: ë¬¼ë¦¬ ì—”ì§„ ì—°ê²°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX: API_BASEë¥¼ Railway ì„œë²„ë¡œ ì„¤ì •
const API_BASE = window.location.hostname === 'localhost' 
  ? 'http://localhost:8000' 
  : 'https://autus-production.up.railway.app';
let apiConnected = false;

// #5 ì—ëŸ¬ í•¸ë“¤ë§ â€” API ìƒíƒœ í‘œì‹œ
function updateApiStatus(connected, message = '') {
  const dot = document.getElementById('api-status-dot');
  const text = document.getElementById('api-status');
  if (dot && text) {
    dot.className = 'status-dot ' + (connected ? 'ok' : 'warn');
    text.textContent = connected ? 'API LIVE' : (message || 'OFFLINE');
    text.style.color = connected ? 'var(--accent-green)' : 'var(--accent-orange)';
  }
}

async function fetchState() {
  try {
    const res = await fetch(`${API_BASE}/api/state`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    updateApiStatus(true);
    return await res.json();
  } catch (err) {
    console.warn('[API] Fetch failed:', err.message);
    updateApiStatus(false, 'FETCH ERROR');
    return null;
  }
}

function updateTwinStateFromAPI(data) {
  if (!data || !data.planets) return false;
  
  const p = data.planets;
  TwinState.RECOVERY = p.recovery || TwinState.RECOVERY;
  TwinState.STABILITY = p.stability || TwinState.STABILITY;
  TwinState.COHESION = p.cohesion || TwinState.COHESION;
  TwinState.SHOCK = p.shock || TwinState.SHOCK;
  TwinState.FRICTION = p.friction || TwinState.FRICTION;
  TwinState.TRANSFER = p.transfer || TwinState.TRANSFER;
  TwinState.TIME = p.time || TwinState.TIME;
  TwinState.QUALITY = p.quality || TwinState.QUALITY;
  TwinState.OUTPUT = p.output || TwinState.OUTPUT;
  
  return true;
}

async function syncWithAPI() {
  const data = await fetchState();
  if (data && updateTwinStateFromAPI(data)) {
    if (!apiConnected) {
      apiConnected = true;
      logAction('API Connected â€” Live data', 'success');
    }
    updateFullState();
    renderPlanetList();
  }
}

// Phase 3: SSE ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì—°ê²°
let sseConnection = null;

function connectSSE() {
  if (sseConnection) sseConnection.close();
  
  try {
    sseConnection = new EventSource(`${API_BASE}/api/v1/stream/state`);
    
    sseConnection.onopen = () => {
      if (!apiConnected) {
        apiConnected = true;
        logAction('SSE Connected â€” Real-time stream', 'success');
      }
      updateApiStatus(true, 'SSE LIVE');
    };

    sseConnection.onmessage = (event) => {
      updateApiStatus(true, 'SSE LIVE');
      try {
        const data = JSON.parse(event.data);
        if (updateTwinStateFromAPI(data)) {
          updateFullState();
          renderPlanetList();
        }
      } catch (e) {
        console.warn('[SSE] Parse error:', e);
      }
    };
    
    sseConnection.onerror = (e) => {
      console.warn('[SSE] Connection error, falling back to polling');
      updateApiStatus(false, 'SSE ERROR');
      sseConnection.close();
      sseConnection = null;
      // Fallback to polling
      startPolling();
    };
  } catch (e) {
    console.warn('[SSE] Not supported, using polling');
    startPolling();
  }
}

function startPolling() {
  setInterval(syncWithAPI, 1000);
}

// Try SSE first, fallback to polling
setTimeout(() => {
  connectSSE();
  // Initial sync via fetch
  syncWithAPI();
  // Phase 4: ì˜ˆì¸¡ API í˜¸ì¶œ
  fetchPredictBranches();
  // 30ì´ˆë§ˆë‹¤ ì˜ˆì¸¡ ì—…ë°ì´íŠ¸
  setInterval(fetchPredictBranches, 30000);
}, 500);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PhysicsFrame â€” THE SINGLE SOURCE FOR ALL UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PhysicsFrame = {
  // SNAPSHOT: All UI derived values come from here (SINGLE SOURCE)
  // EP10: Added dignity, reputation for user value calculation
  snapshot: { risk: 0, entropy: 0, pressure: 0, flow: 0, dignity: 0, reputation: 0 },
  
  // BOTTLENECK: All bottleneck displays read from here (SINGLE SOURCE)
  bottleneck: { axis: 'FRICTION', value: 0.79, angle: BOTTLENECK_ANGLES.FRICTION, badness: 0 },
  
  // RING: Ring physics values
  ring: {
    radiusScale: 1.0, thickness: 0.15, pulseHz: 0.5, asymStrength: 0.0, asymAngle: 0.0,
    targetRadiusScale: 1.0, targetThickness: 0.15, targetPulseHz: 0.5, targetAsymStrength: 0.0, targetAsymAngle: 0.0
  },
  
  // PREVIEW: Separate snapshot for preview mode
  preview: {
    active: false,
    snapshot: { risk: 0, entropy: 0, pressure: 0, flow: 0, dignity: 0, reputation: 0 },
    bottleneck: { axis: 'FRICTION', value: 0, angle: 0 },
    ring: { radiusScale: 1.0, thickness: 0.15, pulseHz: 0.5, asymStrength: 0.0, asymAngle: 0.0 }
  },
  
  // EP10: ACTION VALUE CACHE â€” Cost/Time/Dignity/Reputation per action
  actionValues: {
    recover: { cost: 0, time: 0, dignity: 0, reputation: 0 },
    defriction: { cost: 0, time: 0, dignity: 0, reputation: 0 },
    shock_damp: { cost: 0, time: 0, dignity: 0, reputation: 0 },
    no_action: { cost: 0, time: 0, dignity: 0, reputation: 0 }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE FUNCTIONS â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clamp(v, min = 0, max = 1) { return Math.max(min, Math.min(max, v)); }
function lerpTau(current, target, tau, dt) { return current + (target - current) * (1 - Math.exp(-dt / tau)); }

// Compute derived values from any state object
// EP10: Added dignity and reputation calculations
function computeDerived(state) {
  const entropy = clamp(0.30*state.SHOCK + 0.25*state.FRICTION + 0.20*state.TIME + 0.25*(1-state.COHESION));
  const pressure = clamp(0.35*state.SHOCK + 0.35*state.FRICTION + 0.30*(1-state.RECOVERY));
  
  // EP10: DIGNITY = Quality Ã— Stability âˆ’ Entropy Ã— Friction
  const dignity = clamp(state.QUALITY * state.STABILITY - entropy * state.FRICTION, -1, 1);
  
  // EP10: REPUTATION = âˆ’Future Shock Residual (higher shock = lower reputation)
  const reputation = clamp(1 - state.SHOCK - 0.3 * state.FRICTION, -1, 1);
  
  return {
    risk: clamp(
      BOTTLENECK_WEIGHTS.RECOVERY * (1 - state.RECOVERY) +
      BOTTLENECK_WEIGHTS.STABILITY * (1 - state.STABILITY) +
      BOTTLENECK_WEIGHTS.COHESION * (1 - state.COHESION) +
      BOTTLENECK_WEIGHTS.SHOCK * state.SHOCK +
      BOTTLENECK_WEIGHTS.FRICTION * state.FRICTION +
      BOTTLENECK_WEIGHTS.TRANSFER * (1 - state.TRANSFER) +
      BOTTLENECK_WEIGHTS.TIME * state.TIME +
      BOTTLENECK_WEIGHTS.QUALITY * (1 - state.QUALITY) +
      BOTTLENECK_WEIGHTS.OUTPUT * (1 - state.OUTPUT)
    ),
    entropy,
    pressure,
    flow: clamp(0.40*state.TRANSFER + 0.30*(1-state.FRICTION) + 0.30*(1-state.TIME)),
    dignity,
    reputation
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: COMPUTE ACTION VALUE â€” Cost/Time/Dignity/Reputation for each action
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeActionValue(currentState, currentDerived, actionKey) {
  if (actionKey === 'no_action') {
    // NO ACTION: things get worse
    return {
      cost: Math.round(currentDerived.entropy * 20),      // Cost increases with entropy
      time: Math.round(currentDerived.pressure * 15),     // Time increases with pressure
      dignity: -0.1,                                       // Dignity decreases
      reputation: -(currentState.SHOCK * 0.5).toFixed(1)  // Reputation drops with shock
    };
  }
  
  const futureState = applyImpulse(currentState, actionKey);
  const futureDerived = computeDerived(futureState);
  
  // Calculate deltas (positive = improvement)
  const deltaEntropy = currentDerived.entropy - futureDerived.entropy;
  const deltaFriction = currentState.FRICTION - futureState.FRICTION;
  const deltaTime = currentState.TIME - futureState.TIME;
  const deltaPressure = currentDerived.pressure - futureDerived.pressure;
  const deltaShock = currentState.SHOCK - futureState.SHOCK;
  
  // EP10 Value Mapping:
  // Cost â†“ = Entropy â†“ + Friction â†“
  // Time â†“ = Time â†“ + Pressure â†“
  // Dignity = Quality Ã— Stability âˆ’ Entropy Ã— Friction (delta)
  // Reputation = âˆ’Future Shock Residual (delta)
  
  const costDelta = Math.round((deltaEntropy + deltaFriction) * 50);
  const timeDelta = Math.round((deltaTime + deltaPressure) * 40);
  const dignityDelta = (futureDerived.dignity - currentDerived.dignity).toFixed(1);
  const repDelta = ((futureDerived.reputation - currentDerived.reputation) * 1.5).toFixed(1);
  
  return {
    cost: costDelta,
    time: timeDelta,
    dignity: parseFloat(dignityDelta),
    reputation: parseFloat(repDelta)
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHASE 1: FUTURE BRANCH SIMULATION â€” BEST / LIKELY / WORST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function simulateFutureBranches(actionKey) {
  const profile = IMPULSE_PROFILES[actionKey];
  if (!profile) return null;
  
  const currentDerived = computeDerived(TwinState);
  const futureState = applyImpulse(TwinState, actionKey);
  const futureDerived = computeDerived(futureState);
  
  // BEST scenario: 120% effectiveness
  const bestState = { ...TwinState };
  for (const key in profile.delta) {
    if (bestState.hasOwnProperty(key)) bestState[key] = clamp(bestState[key] + profile.delta[key] * 1.2);
  }
  const bestDerived = computeDerived(bestState);
  
  // LIKELY scenario: 100% effectiveness (normal)
  const likelyDerived = futureDerived;
  
  // WORST scenario: 50% effectiveness + entropy spike
  const worstState = { ...TwinState };
  for (const key in profile.delta) {
    if (worstState.hasOwnProperty(key)) worstState[key] = clamp(worstState[key] + profile.delta[key] * 0.5);
  }
  worstState.SHOCK = clamp(worstState.SHOCK + 0.05); // Small entropy spike
  const worstDerived = computeDerived(worstState);
  
  return {
    best: {
      recovery: Math.round((bestState.RECOVERY - TwinState.RECOVERY) * 100),
      risk: Math.round((currentDerived.risk - bestDerived.risk) * 100),
      entropy: Math.round((currentDerived.entropy - bestDerived.entropy) * 100),
      confidence: profile.confidence + 5
    },
    likely: {
      recovery: Math.round((futureState.RECOVERY - TwinState.RECOVERY) * 100),
      risk: Math.round((currentDerived.risk - likelyDerived.risk) * 100),
      entropy: Math.round((currentDerived.entropy - likelyDerived.entropy) * 100),
      confidence: profile.confidence
    },
    worst: {
      recovery: Math.round((worstState.RECOVERY - TwinState.RECOVERY) * 100),
      risk: Math.round((currentDerived.risk - worstDerived.risk) * -100),
      entropy: Math.round((worstDerived.entropy - currentDerived.entropy) * 100),
      confidence: Math.max(5, profile.confidence - 60)
    }
  };
}

// Generate physics-based reason for action recommendation
function generatePhysicsReason(actionKey) {
  const bn = PhysicsFrame.bottleneck;
  const snap = PhysicsFrame.snapshot;
  const recovery = TwinState.RECOVERY;
  const shock = TwinState.SHOCK;
  const friction = TwinState.FRICTION;
  
  const reasons = {
    recover: () => {
      if (recovery < 0.5) return `Recovery ${Math.round(recovery*100)}% < Critical(50%). ë³µêµ¬ ì—†ì´ ì‹œìŠ¤í…œ ë¶•ê´´ ê°€ì†.`;
      if (snap.entropy > 0.6) return `Entropy ${snap.entropy.toFixed(2)} ë†’ìŒ. Recoveryë¡œ ì•ˆì •í™” í•„ìš”.`;
      return `Recovery í™•ë³´ë¡œ ì „ì²´ Risk ${Math.round(snap.risk*100)}% ê°ì†Œ ê°€ëŠ¥.`;
    },
    defriction: () => {
      if (friction > 0.7) return `Friction ${Math.round(friction*100)}% ë³‘ëª©. ë§ˆì°° ì œê±°ë¡œ Flow ê°œì„ .`;
      if (snap.pressure > 0.6) return `Pressure ${snap.pressure.toFixed(2)} ê³¼ë‹¤. Defrictionìœ¼ë¡œ í•´ì†Œ.`;
      return `ë§ˆì°° ê°ì†Œë¡œ Time/Cost ì ˆê° íš¨ê³¼.`;
    },
    shock_damp: () => {
      if (shock > 0.7) return `Shock ${Math.round(shock*100)}% ìœ„í—˜. ì¦‰ì‹œ ê°ì‡  í•„ìš”.`;
      if (bn.axis === 'SHOCK') return `SHOCKì´ í˜„ì¬ ë³‘ëª©. ê°ì‡  ì‹œ ì „ì²´ ì•ˆì •í™”.`;
      return `ì¶©ê²© ê°ì‡ ë¡œ Reputation ë³´í˜¸ ë° ë¯¸ë˜ ìœ„í—˜ ì°¨ë‹¨.`;
    }
  };
  
  return reasons[actionKey] ? reasons[actionKey]() : '';
}

// Rank actions by physics score
function rankActions() {
  const snap = PhysicsFrame.snapshot;
  const bn = PhysicsFrame.bottleneck;
  const recovery = TwinState.RECOVERY;
  
  const scores = {
    recover: 0,
    defriction: 0,
    shock_damp: 0
  };
  
  // Recovery urgency
  if (recovery < 0.5) scores.recover += 30;
  if (recovery < 0.4) scores.recover += 20;
  
  // Bottleneck alignment
  if (bn.axis === 'SHOCK') scores.shock_damp += 25;
  if (bn.axis === 'FRICTION') scores.defriction += 25;
  if (bn.axis === 'RECOVERY') scores.recover += 25;
  
  // Risk mitigation
  scores.shock_damp += snap.risk * 20;
  scores.recover += snap.entropy * 15;
  scores.defriction += snap.pressure * 15;
  
  // Reputation protection
  if (TwinState.SHOCK > 0.7) scores.shock_damp += 20;
  
  return Object.entries(scores)
    .sort((a, b) => b[1] - a[1])
    .map(([action, score], idx) => ({ action, score, rank: idx + 1 }));
}

// Update hover simulation cards
function updateHoverSimCards() {
  const ranked = rankActions();
  const topAction = ranked[0].action;
  
  ['recover', 'defriction', 'shock_damp'].forEach(key => {
    const sim = simulateFutureBranches(key);
    const reason = generatePhysicsReason(key);
    const isTop = key === topAction;
    const el = document.getElementById(`sim-${key}`);
    if (!el || !sim) return;
    
    const profile = IMPULSE_PROFILES[key];
    
    el.innerHTML = `
      ${isTop ? '<div class="recommended-badge">ğŸ¯ RECOMMENDED</div>' : ''}
      <div class="sim-title">${profile.name} ì„ íƒ ì‹œ ì˜ˆì¸¡</div>
      
      <div class="sim-branch best">
        <span class="branch-tag">BEST</span>
        <div class="branch-delta">Recovery ${sim.best.recovery > 0 ? '+' : ''}${sim.best.recovery}% | Risk âˆ’${sim.best.risk}%</div>
        <div class="branch-metrics">
          <span>Entropy â†“${sim.best.entropy}%</span>
        </div>
        <div class="confidence-row">
          <div class="confidence-bar"><div class="confidence-fill high" style="width:${sim.best.confidence}%"></div></div>
          <span class="confidence-pct">${sim.best.confidence}%</span>
        </div>
      </div>
      
      <div class="sim-branch likely">
        <span class="branch-tag">LIKELY</span>
        <div class="branch-delta">Recovery ${sim.likely.recovery > 0 ? '+' : ''}${sim.likely.recovery}% | Risk âˆ’${sim.likely.risk}%</div>
        <div class="branch-metrics">
          <span>Entropy â†“${sim.likely.entropy}%</span>
        </div>
        <div class="confidence-row">
          <div class="confidence-bar"><div class="confidence-fill mid" style="width:${sim.likely.confidence}%"></div></div>
          <span class="confidence-pct">${sim.likely.confidence}%</span>
        </div>
      </div>
      
      <div class="sim-branch worst">
        <span class="branch-tag">WORST</span>
        <div class="branch-delta">Recovery ${sim.worst.recovery > 0 ? '+' : ''}${sim.worst.recovery}% | Risk +${sim.worst.risk}%</div>
        <div class="branch-metrics">
          <span>Entropy â†‘${sim.worst.entropy}%</span>
        </div>
        <div class="confidence-row">
          <div class="confidence-bar"><div class="confidence-fill low" style="width:${sim.worst.confidence}%"></div></div>
          <span class="confidence-pct">${sim.worst.confidence}%</span>
        </div>
      </div>
      
      <div class="physics-reason">
        <span class="reason-icon">ğŸ’¡</span>
        <span class="reason-text">${reason}</span>
      </div>
    `;
  });
}

// Compute bottleneck from any state object
function computeBottleneckFrom(state) {
  let maxBadness = -1, maxAxis = 'RECOVERY';
  PLANETS.forEach(p => {
    const value = state[p.key] || 0.5;
    const badness = p.positive ? (1 - value) : value;
    const weighted = BOTTLENECK_WEIGHTS[p.key] * badness;
    if (weighted > maxBadness) { maxBadness = weighted; maxAxis = p.key; }
  });
  return { axis: maxAxis, value: state[maxAxis] || 0.5, angle: BOTTLENECK_ANGLES[maxAxis], badness: maxBadness };
}

// Compute ring targets from derived and state
function computeRingTargets(derived, state, bottleneck) {
  return {
    targetRadiusScale: clamp(1.0 - PHYSICS.RISK_COMPRESSION * derived.risk, 0.25, 1.0),
    targetThickness: PHYSICS.BASE_THICKNESS * (1 + PHYSICS.PRESSURE_MULT * derived.pressure),
    targetPulseHz: PHYSICS.BASE_PULSE * (1 + PHYSICS.ENTROPY_MULT * derived.entropy),
    targetAsymStrength: clamp(PHYSICS.SHOCK_ASYM * Math.max(state.SHOCK, state.FRICTION), 0, 0.95),
    targetAsymAngle: bottleneck.angle
  };
}

// UPDATE FULL STATE â€” Writes to PhysicsFrame (SINGLE SOURCE)
function updateFullState() {
  // 1. Compute derived from TwinState
  const derived = computeDerived(TwinState);
  
  // 2. Write to PhysicsFrame.snapshot (SINGLE SOURCE)
  PhysicsFrame.snapshot.risk = derived.risk;
  PhysicsFrame.snapshot.entropy = derived.entropy;
  PhysicsFrame.snapshot.pressure = derived.pressure;
  PhysicsFrame.snapshot.flow = derived.flow;
  PhysicsFrame.snapshot.dignity = derived.dignity;       // EP10
  PhysicsFrame.snapshot.reputation = derived.reputation; // EP10
  
  // 3. Compute and write bottleneck (SINGLE SOURCE)
  const bn = computeBottleneckFrom(TwinState);
  PhysicsFrame.bottleneck.axis = bn.axis;
  PhysicsFrame.bottleneck.value = bn.value;
  PhysicsFrame.bottleneck.angle = bn.angle;
  PhysicsFrame.bottleneck.badness = bn.badness;
  
  // 4. Compute and write ring targets
  const targets = computeRingTargets(derived, TwinState, bn);
  PhysicsFrame.ring.targetRadiusScale = targets.targetRadiusScale;
  PhysicsFrame.ring.targetThickness = targets.targetThickness;
  PhysicsFrame.ring.targetPulseHz = targets.targetPulseHz;
  PhysicsFrame.ring.targetAsymStrength = targets.targetAsymStrength;
  PhysicsFrame.ring.targetAsymAngle = targets.targetAsymAngle;
  
  // 5. EP10: Compute action values for each impulse
  PhysicsFrame.actionValues.recover = computeActionValue(TwinState, derived, 'recover');
  PhysicsFrame.actionValues.defriction = computeActionValue(TwinState, derived, 'defriction');
  PhysicsFrame.actionValues.shock_damp = computeActionValue(TwinState, derived, 'shock_damp');
  PhysicsFrame.actionValues.no_action = computeActionValue(TwinState, derived, 'no_action');
  
  // 6. EP10: Update UI for forecast and value indicators
  updateForecastPanel();
  updateValueIndicators();
  updateDignityDisplay();
  
  // 7. PHASE 1: Update hover simulation cards
  updateHoverSimCards();
  
  // 8. PRODUCTION MODE: Update primary action button
  updatePrimaryAction();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTION MODE â€” ë‹¨ì¼ ACTION ì„ íƒ ë¡œì§
// "Autusê°€ 1ê°œë§Œ ì¶”ì²œ, ë‚˜ë¨¸ì§€ëŠ” ì¡´ì¬ ìì²´ë¥¼ ìˆ¨ê¹€"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectPrimaryAction() {
  const shock = TwinState.SHOCK;
  const friction = TwinState.FRICTION;
  const recovery = TwinState.RECOVERY;
  const entropy = PhysicsFrame.snapshot.entropy;
  
  // ìš°ì„ ìˆœìœ„ 1: SHOCKì´ ë†’ìœ¼ë©´ â†’ SHOCK_DAMP
  if (shock > 0.5) {
    return { action: 'shock_damp', label: 'ì¶©ê²© ì™„í™”', key: 'shock_damp' };
  }
  
  // ìš°ì„ ìˆœìœ„ 2: FRICTIONì´ ë†’ìœ¼ë©´ â†’ DEFRICTION
  if (friction > 0.4) {
    return { action: 'defriction', label: 'ë§ˆì°° ê°ì†Œ', key: 'defriction' };
  }
  
  // ìš°ì„ ìˆœìœ„ 3: RECOVERYê°€ ë‚®ìœ¼ë©´ â†’ RECOVER
  if (recovery < 0.5) {
    return { action: 'recover', label: 'íšŒë³µ ì‹¤í–‰', key: 'recover' };
  }
  
  // ê¸°ë³¸ê°’: rankActions()ë¡œ ìµœì  ì„ íƒ
  const ranked = rankActions();
  const labels = {
    'recover': 'ìƒíƒœ ìœ ì§€',
    'defriction': 'ë§ˆì°° ê°ì†Œ',
    'shock_damp': 'ì¶©ê²© ì™„í™”'
  };
  return { 
    action: ranked[0].action, 
    label: labels[ranked[0].action] || 'ì§€ê¸ˆ ì¡°ì¹˜',
    key: ranked[0].action 
  };
}

function updatePrimaryAction() {
  const primary = selectPrimaryAction();
  
  // ëª¨ë“  wrapperì—ì„œ primary-action í´ë˜ìŠ¤ ì œê±°
  document.querySelectorAll('.action-btn-wrapper').forEach(w => {
    w.classList.remove('primary-action');
  });
  
  // ì„ íƒëœ ACTIONì— primary-action í´ë˜ìŠ¤ ì¶”ê°€
  const wrapper = document.getElementById(`wrapper-${primary.key}`);
  if (wrapper) {
    wrapper.classList.add('primary-action');
    
    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì„ íƒì )
    const btn = wrapper.querySelector('.action-btn');
    if (btn && !btn.dataset.originalText) {
      btn.dataset.originalText = btn.textContent;
    }
  }
  
  // ìœ„í—˜ ê²½ê³  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  const warning = document.getElementById('no-action-warning');
  if (warning) {
    const risk = Math.round(PhysicsFrame.snapshot.risk * 100);
    const cost = Math.round(risk * 3.5); // ê°„ë‹¨í•œ ë¹„ìš© ì¶”ì •
    warning.textContent = `âš ï¸ ${risk}% Â· ğŸ’° âˆ’â‚©${cost}ë§Œ`;
  }
}

function animatePhysicsFrame(dt) {
  const r = PhysicsFrame.ring;
  r.radiusScale = lerpTau(r.radiusScale, r.targetRadiusScale, TAU.radiusScale, dt);
  r.thickness = lerpTau(r.thickness, r.targetThickness, TAU.thickness, dt);
  r.pulseHz = lerpTau(r.pulseHz, r.targetPulseHz, TAU.pulseHz, dt);
  r.asymStrength = lerpTau(r.asymStrength, r.targetAsymStrength, TAU.asymStrength, dt);
  r.asymAngle = lerpTau(r.asymAngle, r.targetAsymAngle, TAU.asymAngle, dt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPULSE APPLICATION â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyImpulse(state, profileKey) {
  const profile = IMPULSE_PROFILES[profileKey];
  if (!profile) return { ...state };
  const next = { ...state };
  for (const key in profile.delta) {
    if (next.hasOwnProperty(key)) next[key] = clamp(next[key] + profile.delta[key]);
  }
  if (profile.bottleneckBonus && profile.bottleneckBonus.axes.includes(PhysicsFrame.bottleneck.axis)) {
    for (const key in profile.bottleneckBonus.delta) {
      if (next.hasOwnProperty(key)) next[key] = clamp(next[key] + profile.bottleneckBonus.delta[key]);
    }
  }
  return next;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 1000);
camera.position.set(0, 8, 14); camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0x404050, 0.5));
scene.add(new THREE.PointLight(0xffffff, 1.5, 50));

// Starfield
const starsGeo = new THREE.BufferGeometry();
const starPos = [];
for (let i = 0; i < 2500; i++) {
  const r = 45 + Math.random() * 70, t = Math.random() * Math.PI * 2, p = Math.acos(2 * Math.random() - 1);
  starPos.push(r * Math.sin(p) * Math.cos(t), r * Math.sin(p) * Math.sin(t), r * Math.cos(p));
}
starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.08 })));

// Globe
const globeGroup = new THREE.Group();
scene.add(globeGroup);
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.5, 64, 64), new THREE.MeshPhongMaterial({ color: 0x0066aa, emissive: 0x001133, transparent: true, opacity: 0.85 })));
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.52, 36, 18), new THREE.MeshBasicMaterial({ color: 0x00d4ff, wireframe: true, transparent: true, opacity: 0.15 })));

// Failure Ring
const simGroup = new THREE.Group();
const RING_SEGMENTS = 128;
const failureRingGeo = new THREE.TorusGeometry(PHYSICS.BASE_RADIUS, 0.15, 16, RING_SEGMENTS);
const failureRingMat = new THREE.MeshBasicMaterial({ color: 0xff4444, transparent: true, opacity: 0.7, side: THREE.DoubleSide });
const failureRing = new THREE.Mesh(failureRingGeo, failureRingMat);
failureRing.rotation.x = Math.PI / 2; failureRing.position.y = 0.3;
simGroup.add(failureRing);
const failureRingBasePositions = failureRingGeo.attributes.position.array.slice();

// Ghost Ring
const ghostRingGeo = new THREE.TorusGeometry(PHYSICS.BASE_RADIUS, 0.08, 8, RING_SEGMENTS);
const ghostRingMat = new THREE.MeshBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.0, wireframe: true });
const ghostRing = new THREE.Mesh(ghostRingGeo, ghostRingMat);
ghostRing.rotation.x = Math.PI / 2; ghostRing.position.y = 0.35;
simGroup.add(ghostRing);
const ghostRingBasePositions = ghostRingGeo.attributes.position.array.slice();

scene.add(simGroup);

// Ring Deformation â€” READS FROM PhysicsFrame ONLY
function deformFailureRing(time) {
  const pf = PhysicsFrame.ring;
  const snap = PhysicsFrame.snapshot; // SINGLE SOURCE
  const positions = failureRingGeo.attributes.position.array;
  const basePos = failureRingBasePositions;
  const pulse = Math.sin(time * pf.pulseHz * Math.PI * 2) * 0.1;
  
  for (let i = 0; i < positions.length; i += 3) {
    const bx = basePos[i], by = basePos[i + 1], bz = basePos[i + 2];
    const angle = Math.atan2(bz, bx);
    const asymOffset = Math.cos(angle - pf.asymAngle) * pf.asymStrength * 0.4;
    const scale = pf.radiusScale * (1 + asymOffset) * (1 + pulse * 0.15);
    positions[i] = bx * scale;
    positions[i + 1] = by * (1 + pf.thickness * 3);
    positions[i + 2] = bz * scale;
  }
  failureRingGeo.attributes.position.needsUpdate = true;
  
  // Color based on snapshot.risk (SINGLE SOURCE)
  failureRingMat.color.setHex(snap.risk > 0.6 ? 0xff4444 : snap.risk > 0.4 ? 0xffaa00 : 0x00d4aa);
  failureRingMat.opacity = 0.4 + snap.risk * 0.5;
}

function deformGhostRing() {
  const pv = PhysicsFrame.preview;
  if (!pv.active) { ghostRingMat.opacity = 0; return; }
  
  ghostRingMat.opacity = 0.5;
  const positions = ghostRingGeo.attributes.position.array;
  const basePos = ghostRingBasePositions;
  
  for (let i = 0; i < positions.length; i += 3) {
    const bx = basePos[i], by = basePos[i + 1], bz = basePos[i + 2];
    const angle = Math.atan2(bz, bx);
    const asymOffset = Math.cos(angle - pv.ring.asymAngle) * pv.ring.asymStrength * 0.4;
    const scale = pv.ring.radiusScale * (1 + asymOffset);
    positions[i] = bx * scale;
    positions[i + 1] = by * (1 + pv.ring.thickness * 3);
    positions[i + 2] = bz * scale;
  }
  ghostRingGeo.attributes.position.needsUpdate = true;
}

// Planets
const planetGroup = new THREE.Group();
scene.add(planetGroup);
const planetMeshes = {}, planetLabelsEl = {}, orbitRings = [];
const phantomMeshes = {}; // Phase 4: Phantom Orbit
let planetsVisible = true, orbitsVisible = true;

PLANETS.forEach((p, i) => {
  const group = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({ color: p.color, emissive: p.color, emissiveIntensity: 0.3 });
  group.add(new THREE.Mesh(new THREE.SphereGeometry(p.size, 24, 24), mat));
  group.add(new THREE.Mesh(new THREE.SphereGeometry(p.size * 1.3, 16, 16), new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.15, side: THREE.BackSide })));
  if (p.rings) {
    const ring = new THREE.Mesh(new THREE.RingGeometry(p.size * 1.5, p.size * 2, 32), new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.25, side: THREE.DoubleSide }));
    ring.rotation.x = Math.PI / 2.2; group.add(ring);
  }
  planetGroup.add(group);
  planetMeshes[p.key] = group;
  
  // Phase 4: Phantom Orbit â€” ghost planet for preview
  const phantomGroup = new THREE.Group();
  const phantomMat = new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.3, wireframe: true });
  phantomGroup.add(new THREE.Mesh(new THREE.SphereGeometry(p.size * 1.2, 12, 12), phantomMat));
  phantomGroup.visible = false;
  planetGroup.add(phantomGroup);
  phantomMeshes[p.key] = phantomGroup;
  
  const oRing = new THREE.Mesh(new THREE.RingGeometry(p.orbit - 0.015, p.orbit + 0.015, 64), new THREE.MeshBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.2, side: THREE.DoubleSide }));
  oRing.rotation.x = -Math.PI / 2; scene.add(oRing); orbitRings.push(oRing);
  
  const label = document.createElement('div');
  label.className = 'planet-label';
  label.innerHTML = `<span style="color:#${p.color.toString(16).padStart(6,'0')}">${p.icon}</span> ${p.name}`;
  document.body.appendChild(label);
  planetLabelsEl[p.key] = label;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI UPDATES â€” ALL READ FROM PhysicsFrame (SINGLE SOURCE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKernelDisplay() {
  const r = PhysicsFrame.ring;
  const snap = PhysicsFrame.snapshot;  // SINGLE SOURCE
  const bn = PhysicsFrame.bottleneck;  // SINGLE SOURCE
  
  // Ring physics
  const radiusEl = document.getElementById('pf-radius');
  radiusEl.textContent = r.radiusScale.toFixed(3);
  radiusEl.className = 'kernel-val ' + (r.radiusScale < 0.6 ? 'danger' : r.radiusScale < 0.8 ? 'warning' : 'safe');
  document.getElementById('pf-thick').textContent = r.thickness.toFixed(3);
  document.getElementById('pf-pulse').textContent = r.pulseHz.toFixed(3);
  const asymEl = document.getElementById('pf-asym');
  asymEl.textContent = r.asymStrength.toFixed(3);
  asymEl.className = 'kernel-val ' + (r.asymStrength > 0.5 ? 'danger' : r.asymStrength > 0.3 ? 'warning' : 'safe');
  document.getElementById('pf-angle').textContent = Math.round(r.asymAngle * 180 / Math.PI) + 'Â°';
  
  // Snapshot (SINGLE SOURCE for all derived values)
  const riskEl = document.getElementById('snap-risk');
  riskEl.textContent = snap.risk.toFixed(3);
  riskEl.className = 'kernel-val ' + (snap.risk > 0.6 ? 'danger' : snap.risk > 0.4 ? 'warning' : 'safe');
  document.getElementById('snap-entropy').textContent = snap.entropy.toFixed(3);
  document.getElementById('snap-pressure').textContent = snap.pressure.toFixed(3);
  document.getElementById('snap-flow').textContent = snap.flow.toFixed(3);
  
  // Bottleneck (SINGLE SOURCE)
  document.getElementById('bn-axis').textContent = `${bn.axis} (${Math.round(bn.value * 100)}%)`;
  document.getElementById('bn-angle').textContent = Math.round(bn.angle * 180 / Math.PI) + 'Â°';
  document.getElementById('bn-warning').textContent = `âš ï¸ ${bn.axis} bottleneck detected ${bn.value.toFixed(2)}`;
  
  // C: Action header bottleneck display
  const actionBn = document.getElementById('action-bottleneck');
  if (actionBn) actionBn.textContent = `${bn.axis} ${Math.round(bn.value * 100)}%`;
  
  // Metric cards (READ FROM SNAPSHOT â€” SINGLE SOURCE)
  document.getElementById('m-entropy').textContent = snap.entropy.toFixed(2);
  document.getElementById('m-pressure').textContent = snap.pressure.toFixed(2);
  document.getElementById('m-risk').textContent = snap.risk.toFixed(2);
  document.getElementById('m-risk').className = 'metric-value' + (snap.risk > 0.6 ? ' danger' : snap.risk > 0.4 ? ' warning' : '');
  document.getElementById('m-flow').textContent = snap.flow.toFixed(2);
  
  // Status (READ FROM SNAPSHOT)
  const statusEl = document.getElementById('s-status');
  statusEl.textContent = snap.risk > 0.6 ? 'CRITICAL' : snap.risk > 0.4 ? 'WARNING' : 'STABLE';
  statusEl.className = 'stat-value' + (snap.risk > 0.6 ? ' critical' : snap.risk > 0.4 ? ' warning' : '');
  
  // Gate (READ FROM SNAPSHOT)
  const gateEl = document.getElementById('gate-badge');
  if (snap.risk > 0.6) { gateEl.className = 'gate-badge gate-red'; gateEl.textContent = 'GATE: RED'; }
  else if (snap.risk > 0.4) { gateEl.className = 'gate-badge gate-amber'; gateEl.textContent = 'GATE: AMBER'; }
  else { gateEl.className = 'gate-badge gate-green'; gateEl.textContent = 'GATE: GREEN'; }
}

function renderPlanetList() {
  const bn = PhysicsFrame.bottleneck; // SINGLE SOURCE
  const container = document.getElementById('planet-list');
  container.innerHTML = PLANETS.map(p => {
    const value = Math.round((TwinState[p.key] || 0.5) * 100);
    const colorHex = '#' + p.color.toString(16).padStart(6, '0');
    const isBottleneck = p.key === bn.axis; // Uses SINGLE SOURCE
    return `<div class="planet-row ${isBottleneck ? 'bottleneck-active' : ''}" data-key="${p.key}">
      <div class="planet-dot" style="background:${colorHex}"></div>
      <span class="planet-name">${p.icon} ${p.name}</span>
      <span class="planet-val" style="color:${colorHex}">${value}%</span>
    </div>`;
  }).join('');
}

function logAction(msg, type = 'info') {
  const container = document.getElementById('log-items');
  if (!container) return;
  const item = document.createElement('div');
  item.className = 'log-item' + (type === 'warning' ? ' warning' : type === 'critical' ? ' critical' : type === 'success' ? ' success' : '');
  const ts = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  item.textContent = `[${ts}] ${msg}`;
  container.insertBefore(item, container.firstChild);
  while (container.children.length > 15) container.removeChild(container.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: FORECAST PANEL UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Phase 4: ì˜ˆì¸¡ API ë°ì´í„° ì €ì¥
let predictData = null;

async function fetchPredictBranches() {
  try {
    const res = await fetch(`${API_BASE}/api/v1/predict/branches`);
    if (res.ok) {
      predictData = await res.json();
      updateForecastPanelFromAPI();
    }
  } catch (e) {
    console.warn('[API] Predict fetch failed:', e);
  }
}

function updateForecastPanelFromAPI() {
  if (!predictData) return;
  
  const { branches, recommended } = predictData;
  const best = branches[recommended.toLowerCase()] || branches.shock_damp;
  
  // Bezos: API ë°ì´í„°ë„ êµ¬ì²´ì  ê¸ˆì•¡ìœ¼ë¡œ ë³€í™˜
  const savingAmount = formatCurrency(Math.round(COST_CONFIG.BASE_MONTHLY_COST * (best.cost_percent / 100)));
  const savedTime = formatTime(best.time_percent * 0.8);
  
  document.getElementById('fc-best').innerHTML = `
    <div class="branch-label">IF ${best.action.replace('_', ' ')}:</div>
    <div class="branch-values">
      <span class="value-chip positive">ğŸ’° âˆ’${savingAmount}/ì›”</span>
      <span class="value-chip positive">â±ï¸ âˆ’${savedTime}</span>
      <span class="value-chip positive">ğŸŒ Rep +${best.reputation_sigma}Ïƒ</span>
    </div>
  `;
  
  // NO ACTION ê²½ê³  â€” êµ¬ì²´ì  ì†ì‹¤ ê¸ˆì•¡
  const noAct = branches.no_action;
  const lossAmount = formatCurrency(Math.round(COST_CONFIG.BASE_MONTHLY_COST * noAct.collapse_probability * 0.5));
  const repEl = document.getElementById('rep-status');
  if (repEl) {
    repEl.innerHTML = `âš ï¸ NO ACTION: ${noAct.hours_to_critical}h ë‚´ ${lossAmount} ì†ì‹¤ ìœ„í—˜`;
    repEl.style.color = 'var(--accent-red)';
  }
}

function updateForecastPanel() {
  // API ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
  if (predictData) {
    updateForecastPanelFromAPI();
    return;
  }
  
  const av = PhysicsFrame.actionValues;
  const snap = PhysicsFrame.snapshot;

  // Find best action (highest reputation gain)
  const actions = [
    { key: 'shock_damp', val: av.shock_damp },
    { key: 'recover', val: av.recover },
    { key: 'defriction', val: av.defriction }
  ].sort((a, b) => (b.val.reputation + b.val.dignity) - (a.val.reputation + a.val.dignity));

  // Bezos: êµ¬ì²´ì  ê¸ˆì•¡ ê³„ì‚°
  const calcSaving = (pct) => formatCurrency(Math.round(COST_CONFIG.BASE_MONTHLY_COST * (Math.abs(pct) / 100)));
  const calcTime = (pct) => formatTime(Math.abs(pct) * 0.8);

  // Best branch â€” êµ¬ì²´ì  ê¸ˆì•¡
  const best = actions[0];
  document.getElementById('fc-best').innerHTML = `
    <div class="branch-label">IF ${best.key.toUpperCase().replace('_', ' ')}:</div>
    <div class="branch-values">
      <span class="value-chip ${best.val.cost > 0 ? 'positive' : 'negative'}">ğŸ’° ${best.val.cost > 0 ? 'âˆ’' : '+'}${calcSaving(best.val.cost)}</span>
      <span class="value-chip ${best.val.time > 0 ? 'positive' : 'negative'}">â±ï¸ ${best.val.time > 0 ? 'âˆ’' : '+'}${calcTime(best.val.time)}</span>
      <span class="value-chip ${best.val.reputation > 0 ? 'positive' : 'negative'}">ğŸŒ Rep ${best.val.reputation > 0 ? '+' : ''}${best.val.reputation}Ïƒ</span>
    </div>
  `;
  
  // Mid branch
  const mid = actions[1];
  document.getElementById('fc-mid').innerHTML = `
    <div class="branch-label">IF ${mid.key.toUpperCase().replace('_', ' ')}:</div>
    <div class="branch-values">
      <span class="value-chip ${mid.val.dignity > 0 ? 'positive' : 'neutral'}">ğŸ›ï¸ Dignity ${mid.val.dignity > 0 ? '+' : ''}${mid.val.dignity}</span>
      <span class="value-chip ${mid.val.cost > 0 ? 'positive' : 'negative'}">ğŸ’° ${mid.val.cost > 0 ? 'âˆ’' : '+'}${calcSaving(mid.val.cost)}</span>
      <span class="value-chip neutral">â±ï¸ ${mid.val.time > 0 ? 'âˆ’' : '+'}${calcTime(mid.val.time)}</span>
    </div>
  `;
  
  // Worst branch (no action) â€” ì†ì‹¤ ê¸ˆì•¡ ê°•ì¡°
  const noAct = av.no_action;
  const lossAmount = calcSaving(noAct.cost);
  document.getElementById('fc-worst').innerHTML = `
    <div class="branch-label">IF NO ACTION:</div>
    <div class="branch-values">
      <span class="value-chip negative">ğŸ’¸ ì†ì‹¤ +${lossAmount}/ì›”</span>
      <span class="value-chip negative">âš ï¸ Shock ì§€ì†</span>
      <span class="value-chip negative">ğŸŒ Rep ${noAct.reputation}Ïƒ</span>
    </div>
  `;
  
  // Reputation status
  const repEl = document.getElementById('rep-status');
  if (snap.reputation < 0.2) {
    repEl.textContent = 'ğŸŒ External Perception: Volatile';
    repEl.style.color = 'var(--accent-red)';
  } else if (snap.reputation < 0.5) {
    repEl.textContent = 'ğŸŒ External Perception: Uncertain';
    repEl.style.color = 'var(--accent-orange)';
  } else {
    repEl.textContent = 'ğŸŒ External Trust: Stabilizing';
    repEl.style.color = 'var(--accent-green)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: VALUE INDICATORS UPDATE â€” Bezos: êµ¬ì²´ì  ê¸ˆì•¡ í‘œì‹œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateValueIndicators() {
  const av = PhysicsFrame.actionValues;
  const snap = PhysicsFrame.snapshot;

  // Elon+Bezos: í•µì‹¬ Risk í‘œì‹œ
  const riskEl = document.getElementById('action-risk');
  if (riskEl) riskEl.textContent = `${Math.round(snap.risk * 100)}%`;
  
  // Bezos: NO ACTION ê²½ê³  â€” êµ¬ì²´ì  ì†ì‹¤ ê¸ˆì•¡ í‘œì‹œ
  const warnEl = document.getElementById('no-action-warning');
  if (warnEl) {
    const noActCost = av.no_action?.cost || 10;
    const lossAmount = Math.round(COST_CONFIG.BASE_MONTHLY_COST * (noActCost / 100));
    warnEl.textContent = `â° í–‰ë™ ì•ˆ í•˜ë©´: ${formatCurrency(lossAmount)} ì†ì‹¤/ì›”`;
  }

  // ìµœì  action ì°¾ê¸° (reputation + dignity ê¸°ì¤€)
  const actions = ['recover', 'defriction', 'shock_damp'];
  let bestAction = actions[0];
  let bestScore = -Infinity;
  
  actions.forEach(key => {
    const v = av[key];
    const score = (v.reputation || 0) + (v.dignity || 0) + (v.cost || 0) * 0.1;
    if (score > bestScore) { bestScore = score; bestAction = key; }
    
    // Bezos: í¼ì„¼íŠ¸ â†’ ì‹¤ì œ ê¸ˆì•¡ìœ¼ë¡œ ë³€í™˜
    const savingAmount = Math.round(COST_CONFIG.BASE_MONTHLY_COST * (Math.abs(v.cost) / 100));
    const savedTime = Math.abs(v.time) * 0.8; // ì‹œê°„ ì ˆê° (ì‹œê°„ ë‹¨ìœ„)
    
    // Value indicators ì—…ë°ì´íŠ¸ â€” êµ¬ì²´ì  ìˆ«ì
    const el = document.getElementById(`vi-${key}`);
    if (!el) return;
    el.innerHTML = `
      <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val ${v.cost > 0 ? 'down' : 'up'}">${v.cost > 0 ? 'âˆ’' : '+'}${formatCurrency(savingAmount)}</span></span>
      <span class="value-ind"><span class="icon">â±ï¸</span><span class="val ${v.time > 0 ? 'down' : 'up'}">${v.time > 0 ? 'âˆ’' : '+'}${formatTime(savedTime)}</span></span>
      <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val ${v.dignity > 0 ? 'up' : 'down'}">${v.dignity > 0 ? '+' : ''}${v.dignity}</span></span>
      <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val ${v.reputation > 0 ? 'up' : 'down'}">${v.reputation > 0 ? '+' : ''}${v.reputation}Ïƒ</span></span>
    `;
  });
  
  // Elon: ì¶”ì²œ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
  actions.forEach(key => {
    const wrapper = document.getElementById(`wrapper-${key}`);
    if (wrapper) wrapper.classList.toggle('recommended', key === bestAction);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: DIGNITY DISPLAY UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDignityDisplay() {
  const dignity = PhysicsFrame.snapshot.dignity;
  const el = document.getElementById('dignity-display');
  
  if (dignity < 0.2) {
    el.className = 'low';
    el.textContent = 'DIGNITY: LOW';
  } else if (dignity < 0.5) {
    el.className = 'balanced';
    el.textContent = 'DIGNITY: BALANCED';
  } else {
    el.className = 'elevated';
    el.textContent = 'DIGNITY: ELEVATED';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW / AUDIT / LOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentAuditAction = null, auditTimer = null;
window.auditActive = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MUSK: ë¹ ë¥¸ ì‹¤í–‰ ëª¨ë“œ â€” Cmd/Ctrl+Clickìœ¼ë¡œ AUDIT ìŠ¤í‚µ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function quickExecuteAction(actionKey) {
  const profile = IMPULSE_PROFILES[actionKey];
  if (!profile) return;
  
  // ì¦‰ì‹œ ì‹¤í–‰ í† ìŠ¤íŠ¸ í‘œì‹œ
  const toast = document.getElementById('exec-toast');
  toast.textContent = `âš¡ ${profile.name} ì¦‰ì‹œ ì‹¤í–‰`;
  toast.classList.add('show');
  
  // Backend ì‹¤í–‰
  const result = await executeAction(actionKey);
  
  if (result && result.ok) {
    // ì„±ê³µ: ìƒíƒœ ì—…ë°ì´íŠ¸
    const futureState = applyImpulse(TwinState, actionKey);
    Object.assign(TwinState, futureState);
    updateFullState();
    renderPlanetList();
    
    toast.textContent = `âœ“ ${profile.name} ì™„ë£Œ`;
    logAction(`Quick Execute: ${profile.name} âœ“`, 'success');
    
    // API ë™ê¸°í™”
    setTimeout(syncWithAPI, 500);
  } else {
    toast.textContent = `âœ— ì‹¤í–‰ ì‹¤íŒ¨`;
    toast.style.borderColor = 'var(--accent-red)';
    toast.style.color = 'var(--accent-red)';
    logAction(`Quick Execute Failed: ${profile.name}`, 'critical');
  }
  
  setTimeout(() => {
    toast.classList.remove('show');
    toast.style.borderColor = '';
    toast.style.color = '';
  }, 1500);
}

async function previewAction(actionKey, event) {
  // Musk: Cmd/Ctrl+Click ê°ì§€ â†’ ì¦‰ì‹œ ì‹¤í–‰
  if (event && (event.metaKey || event.ctrlKey)) {
    await quickExecuteAction(actionKey);
    return;
  }

  const profile = IMPULSE_PROFILES[actionKey];
  if (!profile) return;

  // === AUDIT ì¹¨ë¬µ ëª¨ë“œ ì‹œì‘ ===
  document.body.classList.add('audit-mode');

  // Phase 2: API Simulate í˜¸ì¶œ
  const impulseMap = { 'recover': 'RECOVER', 'defriction': 'DEFRICTION', 'shock_damp': 'SHOCK_DAMP' };
  let apiResult = null;
  try {
    const res = await fetch(`${API_BASE}/api/v1/burn/simulate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ impulse: impulseMap[actionKey] || 'RECOVER', magnitude: 1.0 })
    });
    if (res.ok) apiResult = await res.json();
  } catch (e) { console.warn('[API] Simulate failed:', e); }

  const futureState = applyImpulse(TwinState, actionKey);
  const futureDerived = computeDerived(futureState);
  const futureBottleneck = computeBottleneckFrom(futureState);
  const futureRing = computeRingTargets(futureDerived, futureState, futureBottleneck);

  // Set preview (SEPARATE from main snapshot)
  PhysicsFrame.preview.active = true;
  PhysicsFrame.preview.snapshot = { ...futureDerived };
  PhysicsFrame.preview.bottleneck = { ...futureBottleneck };
  PhysicsFrame.preview.ring = {
    radiusScale: futureRing.targetRadiusScale,
    thickness: futureRing.targetThickness,
    pulseHz: futureRing.targetPulseHz,
    asymStrength: futureRing.targetAsymStrength,
    asymAngle: futureRing.targetAsymAngle
  };

  ghostRingMat.color.setHex(futureDerived.risk < PhysicsFrame.snapshot.risk ? 0x00ff88 : 0xff4444);

  // API ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ ê³„ì‚°ê°’ ì‚¬ìš©
  const confidence = apiResult?.confidence || profile.confidence;
  const costPercent = apiResult?.cost_percent || Math.round(profile.delta.FRICTION * -100);
  
  logAction(`Preview: ${profile.name} (Risk ${(PhysicsFrame.snapshot.risk*100).toFixed(0)}% â†’ ${(futureDerived.risk*100).toFixed(0)}%) [${confidence}% confidence]`, 'warning');

  currentAuditAction = { key: actionKey, profile, futureState, futureDerived, futureBottleneck, apiResult };
  openAudit();
}

function openAudit() {
  if (!currentAuditAction) return;
  clearInterval(auditTimer);
  window.auditActive = true;
  
  const { profile, futureDerived, futureBottleneck, apiResult } = currentAuditAction;
  const snap = PhysicsFrame.snapshot; // SINGLE SOURCE
  const bn = PhysicsFrame.bottleneck; // SINGLE SOURCE

  document.getElementById('layer-audit').classList.add('active');
  document.getElementById('audit-action').textContent = `${profile.name} â€” ${profile.description}`;

  // API ê²°ê³¼ ìš°ì„ , ì—†ìœ¼ë©´ í´ë¼ì´ì–¸íŠ¸ ê³„ì‚°ê°’
  const currentRisk = apiResult?.current?.risk ?? snap.risk;
  const predictedRisk = apiResult?.predicted?.risk ?? futureDerived.risk;
  const confidence = apiResult?.confidence ?? profile.confidence;
  
  const riskImproved = predictedRisk < currentRisk;
  document.getElementById('audit-risk').textContent = `${(currentRisk*100).toFixed(0)}% â†’ ${(predictedRisk*100).toFixed(0)}%`;
  document.getElementById('audit-risk').className = 'value ' + (riskImproved ? 'positive' : 'negative');

  document.getElementById('audit-bn').textContent = `${bn.axis} â†’ ${futureBottleneck.axis}`;
  document.getElementById('audit-bn').className = 'value ' + (futureBottleneck.axis !== bn.axis ? 'positive' : '');

  document.getElementById('audit-conf').textContent = confidence + '%';

  // API ê²°ê³¼ë¡œ costs ì—…ë°ì´íŠ¸ â€” Bezos: êµ¬ì²´ì  ê¸ˆì•¡
  const costsEl = document.getElementById('audit-costs-list');
  if (apiResult) {
    const savingAmount = formatCurrency(Math.round(COST_CONFIG.BASE_MONTHLY_COST * (apiResult.cost_percent / 100)));
    const savedTime = formatTime(apiResult.time_percent * 0.8);
    costsEl.innerHTML = `
      <span class="cost-item">ğŸ’° ì ˆê°: ${savingAmount}/ì›”</span>
      <span class="cost-item">â±ï¸ ë‹¨ì¶•: ${savedTime}</span>
      <span class="cost-item">ğŸ“Š Entropy: ${(apiResult.delta.entropy * 100).toFixed(0)}%</span>
    `;
  } else {
    // í”„ë¡œí•„ ê¸°ë°˜ êµ¬ì²´ì  ê¸ˆì•¡ ê³„ì‚°
    const costPct = Math.abs(profile.delta.FRICTION || 0.1) * 100;
    const timePct = Math.abs(profile.delta.TIME || 0.05) * 100;
    const savingAmount = formatCurrency(Math.round(COST_CONFIG.BASE_MONTHLY_COST * (costPct / 100)));
    const savedTime = formatTime(timePct * 0.8);
    costsEl.innerHTML = `
      <span class="cost-item">ğŸ’° ì ˆê°: ${savingAmount}/ì›”</span>
      <span class="cost-item">â±ï¸ ë‹¨ì¶•: ${savedTime}</span>
      ${profile.costs.slice(0, 1).map(c => `<span class="cost-item">${c}</span>`).join('')}
    `;
  }
  
  let countdown = 30;
  const timerEl = document.getElementById('audit-countdown');
  timerEl.textContent = countdown;
  auditTimer = setInterval(() => {
    countdown--;
    timerEl.textContent = countdown;
    if (countdown <= 0) auditDecision('REJECT');
  }, 1000);
}

// Action mapping: frontend â†’ backend
const ACTION_MAP = {
  'recover': 'AUTO_STABILIZE',
  'defriction': 'REMOVE_LOW_IMPACT',
  'shock_damp': 'FORCE_DECISION'
};

async function executeAction(actionKey) {
  const backendAction = ACTION_MAP[actionKey] || 'AUTO_STABILIZE';
  try {
    const res = await fetch(`${API_BASE}/execute`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: backendAction })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const result = await res.json();
    console.log('[BURN] Execute result:', result);
    return result;
  } catch (err) {
    console.error('[BURN] Execute failed:', err.message);
    return null;
  }
}

async function auditDecision(verdict) {
  clearInterval(auditTimer);
  PhysicsFrame.preview.active = false;
  
  if (verdict === 'LOCK' && currentAuditAction) {
    // Phase 2: Execute burn on backend
    const actionKey = currentAuditAction.key;
    logAction(`Executing ${actionKey}...`, 'warning');
    
    const result = await executeAction(actionKey);
    
    if (result && result.ok) {
      // Success: Update local state and sync
      Object.assign(TwinState, currentAuditAction.futureState);
      updateFullState();
      renderPlanetList();
      logAction(`LOCKED: ${currentAuditAction.profile.name} â†’ Burn executed âœ“`, 'success');
      // Force sync to get latest state
      setTimeout(syncWithAPI, 500);
      } else {
      logAction(`LOCK FAILED: ${currentAuditAction.profile.name} â€” API error`, 'error');
    }
  } else if (verdict === 'REJECT') {
    logAction(`REJECTED: ${currentAuditAction?.profile?.name || 'unknown'}`);
  } else {
    logAction(`HOLD: ${currentAuditAction?.profile?.name || 'unknown'}`);
    return;
  }

  document.getElementById('layer-audit').classList.remove('active');
  document.body.classList.remove('audit-mode'); // AUDIT ì¹¨ë¬µ ëª¨ë“œ í•´ì œ
  window.auditActive = false;
  currentAuditAction = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCEPTANCE TESTS â€” 8 AUTOMATED VERIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAcceptanceTests() {
  const tests = [];
  const snap = PhysicsFrame.snapshot;
  const bn = PhysicsFrame.bottleneck;
  const r = PhysicsFrame.ring;
  
  // Test 1: Single Source - Risk card matches snapshot
  const riskCard = parseFloat(document.getElementById('m-risk').textContent);
  tests.push({ name: 'T1: Risk Single Source', pass: Math.abs(riskCard - snap.risk) < 0.01 });
  
  // Test 2: Single Source - Pressure card matches snapshot
  const pressureCard = parseFloat(document.getElementById('m-pressure').textContent);
  tests.push({ name: 'T2: Pressure Single Source', pass: Math.abs(pressureCard - snap.pressure) < 0.01 });
  
  // Test 3: Bottleneck - Warning text includes correct axis
  const bnWarning = document.getElementById('bn-warning').textContent;
  tests.push({ name: 'T3: Bottleneck Axis Match', pass: bnWarning.includes(bn.axis) });
  
  // Test 4: Ring-Bottleneck coupling - asymAngle matches bottleneck angle
  tests.push({ name: 'T4: Ring-BN Angle Coupling', pass: Math.abs(r.targetAsymAngle - bn.angle) < 0.01 });
  
  // Test 5: Law 5 - Riskâ†’Radius monotonicity
  const expectedRadius = 1.0 - PHYSICS.RISK_COMPRESSION * snap.risk;
  tests.push({ name: 'T5: Law 5 Riskâ†’Radius', pass: Math.abs(r.targetRadiusScale - expectedRadius) < 0.01 });
  
  // Test 6: Law 6 - Entropyâ†’Pulse
  const expectedPulse = PHYSICS.BASE_PULSE * (1 + PHYSICS.ENTROPY_MULT * snap.entropy);
  tests.push({ name: 'T6: Law 6 Entropyâ†’Pulse', pass: Math.abs(r.targetPulseHz - expectedPulse) < 0.01 });
  
  // Test 7: Preview separation - preview.active is boolean
  tests.push({ name: 'T7: Preview Separation', pass: typeof PhysicsFrame.preview.active === 'boolean' });
  
  // Test 8: Impulse reproducibility - same input produces same output
  const state1 = applyImpulse({ ...TwinState }, 'recover');
  const state2 = applyImpulse({ ...TwinState }, 'recover');
  tests.push({ name: 'T8: Impulse Reproducibility', pass: JSON.stringify(state1) === JSON.stringify(state2) });
  
  // Report
  const passed = tests.filter(t => t.pass).length;
  const total = tests.length;
  const allPass = passed === total;
  
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  ACCEPTANCE TESTS â€” PHYSICS KERNEL v2.3');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  tests.forEach(t => console.log(`  ${t.pass ? 'âœ“' : 'âœ—'} ${t.name}`));
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log(`  RESULT: ${passed}/${total} ${allPass ? 'ALL PASS âœ“' : 'FAILED âœ—'}`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  const badge = document.getElementById('test-badge');
  badge.textContent = `TESTS: ${passed}/${total} ${allPass ? 'âœ“' : 'âœ—'}`;
  badge.className = 'test-badge' + (allPass ? '' : ' fail');
  
  logAction(`Tests: ${passed}/${total} ${allPass ? 'PASS' : 'FAIL'}`, allPass ? 'success' : 'critical');
  
  return { passed, total, allPass, tests };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePlanets() {
  planetsVisible = !planetsVisible;
  planetGroup.visible = planetsVisible;
  Object.values(planetLabelsEl).forEach(el => el.style.display = planetsVisible ? 'block' : 'none');
  document.querySelector('#controls button:nth-child(1)').classList.toggle('active', planetsVisible);
}

function toggleOrbits() {
  orbitsVisible = !orbitsVisible;
  orbitRings.forEach(r => r.visible = orbitsVisible);
  document.querySelector('#controls button:nth-child(2)').classList.toggle('active', orbitsVisible);
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('layer-audit').classList.remove('active');
    document.body.classList.remove('audit-mode'); // AUDIT ì¹¨ë¬µ ëª¨ë“œ í•´ì œ
    PhysicsFrame.preview.active = false;
    clearInterval(auditTimer);
    window.auditActive = false;
  }
  // PRODUCTION MODE: ê°œë°œì ë‹¨ì¶•í‚¤ ì œê±° (R, T)
  // if (e.key === 'r' || e.key === 'R') { ... }
  // if (e.key === 't' || e.key === 'T') { ... }
});

// Camera
let isDragging = false, prevMouse = { x: 0, y: 0 };
let cameraTheta = 0, cameraPhi = 1.0, cameraDistance = 16;
renderer.domElement.addEventListener('mousedown', e => { isDragging = true; prevMouse = { x: e.clientX, y: e.clientY }; });
renderer.domElement.addEventListener('mousemove', e => {
  if (!isDragging) return;
  cameraTheta += (e.clientX - prevMouse.x) * 0.005;
  cameraPhi = Math.max(0.3, Math.min(2.5, cameraPhi + (e.clientY - prevMouse.y) * 0.005));
  prevMouse = { x: e.clientX, y: e.clientY };
  camera.position.set(cameraDistance * Math.sin(cameraPhi) * Math.cos(cameraTheta), cameraDistance * Math.cos(cameraPhi), cameraDistance * Math.sin(cameraPhi) * Math.sin(cameraTheta));
  camera.lookAt(0, 0, 0);
});
renderer.domElement.addEventListener('mouseup', () => isDragging = false);
renderer.domElement.addEventListener('wheel', e => {
  cameraDistance = Math.max(8, Math.min(30, cameraDistance + e.deltaY * 0.02));
  camera.position.set(cameraDistance * Math.sin(cameraPhi) * Math.cos(cameraTheta), cameraDistance * Math.cos(cameraPhi), cameraDistance * Math.sin(cameraPhi) * Math.sin(cameraTheta));
  camera.lookAt(0, 0, 0);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let time = 0, frames = 0, lastFPS = performance.now(), lastFrameTime = performance.now();

function animate() {
  requestAnimationFrame(animate);
  const now = performance.now();
  const dt = (now - lastFrameTime) / 1000;
  lastFrameTime = now;
  time += 0.016;
  
  if (!window.auditActive) globeGroup.rotation.y += 0.003;
  
  if (planetsVisible) {
    const bn = PhysicsFrame.bottleneck; // SINGLE SOURCE
    const previewActive = PhysicsFrame.preview.active;
    const futureState = currentAuditAction?.futureState;
    
    PLANETS.forEach((p, i) => {
      const value = TwinState[p.key] || 0.5;
      const group = planetMeshes[p.key];
      const angle = time * p.speed * 0.3 + (i / PLANETS.length) * Math.PI * 2;
      const r = p.orbit + (value - 0.5) * 0.2;
      group.position.set(Math.cos(angle) * r, Math.sin(time * 0.2 + i) * 0.1, Math.sin(angle) * r);
      group.rotation.y += 0.02;
      group.scale.setScalar(p.key === bn.axis ? 1.5 : 1); // Uses SINGLE SOURCE

      // Phase 4: Phantom Orbit â€” show future position during preview
      const phantom = phantomMeshes[p.key];
      if (previewActive && futureState) {
        const futureValue = futureState[p.key] || 0.5;
        const futureR = p.orbit + (futureValue - 0.5) * 0.2;
        const futureAngle = angle + 0.5; // Slight offset to show movement
        phantom.position.set(Math.cos(futureAngle) * futureR, Math.sin(time * 0.2 + i) * 0.1 + 0.3, Math.sin(futureAngle) * futureR);
        phantom.visible = Math.abs(futureValue - value) > 0.01; // Only show if change
        phantom.rotation.y += 0.03;
      } else {
        phantom.visible = false;
      }
      
      const label = planetLabelsEl[p.key];
      const screenPos = group.position.clone().project(camera);
      if (screenPos.z < 1) {
        label.style.left = ((screenPos.x + 1) / 2 * innerWidth) + 'px';
        label.style.top = ((-screenPos.y + 1) / 2 * innerHeight - 22) + 'px';
        label.style.opacity = p.key === bn.axis ? '1' : '0.5';
      } else label.style.opacity = '0';
    });
  }
  
  animatePhysicsFrame(dt);
  deformFailureRing(time);
  deformGhostRing();
  failureRing.rotation.z += 0.001;
  
  updateKernelDisplay();
  
  // Dimon: Risk íˆìŠ¤í† ë¦¬ ìƒ˜í”Œë§
  sampleRiskHistory();
  
  frames++;
  if (now - lastFPS >= 1000) { document.getElementById('sys-fps').textContent = frames; frames = 0; lastFPS = now; }
  document.getElementById('sys-time').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
  
  renderer.render(scene, camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6ê°œ ì—­í•  ì‹œìŠ¤í…œ â€” ì—­í•  ì „í™˜ ë° ê¶Œí•œ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentRole = 'subject';
let roleConfig = null;

async function switchRole(role) {
  currentRole = role;
  
  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  document.querySelectorAll('.role-btn').forEach(btn => {
    btn.classList.toggle('active', btn.classList.contains(role));
  });
  
  // ì—­í•  UI ì„¤ì • ê°€ì ¸ì˜¤ê¸°
  try {
    const res = await fetch(`${API_BASE}/api/v1/role/ui/${role}`);
    if (res.ok) {
      roleConfig = await res.json();
      applyRoleConfig(roleConfig);
    }
  } catch (e) {
    console.warn('[Role] Config fetch failed:', e);
    // ê¸°ë³¸ ì„¤ì • ì ìš©
    applyRoleConfig(getDefaultRoleConfig(role));
  }
  
  // ì—­í•  ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸
  updateRoleInfo(role);
  
  logAction(`Role switched to ${role.toUpperCase()}`, 'success');
}

function getDefaultRoleConfig(role) {
  const configs = {
    subject: { buttons: { LOCK: true, HOLD: true, REJECT: true, CREATE_COMMIT: false } },
    operator: { buttons: { LOCK: true, HOLD: true, REJECT: true, CREATE_COMMIT: true, CLOSE_COMMIT: true } },
    sponsor: { buttons: { LOCK: false, HOLD: false, REJECT: false, CREATE_COMMIT: true } },
    employer: { buttons: { LOCK: true, HOLD: true, REJECT: true, CREATE_COMMIT: true } },
    institution: { buttons: { LOCK: false, HOLD: false, REJECT: false, CREATE_COMMIT: false } },
    system: { buttons: { LOCK: true, HOLD: true, REJECT: true, CREATE_COMMIT: true, OVERRIDE: true } }
  };
  return configs[role] || configs.subject;
}

function applyRoleConfig(config) {
  if (!config || !config.buttons) return;
  
  // Action ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
  const actionPanel = document.getElementById('layer-action');
  if (actionPanel) {
    const canAction = config.buttons.LOCK || config.buttons.HOLD || config.buttons.REJECT;
    // ë²„íŠ¼ì„ ìˆ¨ê¸°ì§€ ì•Šê³  ë¹„í™œì„±í™”
    document.querySelectorAll('.action-btn').forEach(btn => {
      btn.disabled = !canAction;
      btn.style.opacity = canAction ? '1' : '0.3';
    });
  }
  
  // Commit íŒ¨ë„ ë²„íŠ¼ ì¡°ì •
  const commitPanel = document.getElementById('commit-panel');
  if (commitPanel) {
    const createBtn = commitPanel.querySelector('.commit-action-btn.primary');
    if (createBtn) {
      createBtn.style.display = config.buttons.CREATE_COMMIT ? 'block' : 'none';
    }
  }
  
  // Task íŒ¨ë„ì€ Operatorë§Œ
  const taskPanel = document.getElementById('task-panel');
  if (taskPanel) {
    taskPanel.style.display = (currentRole === 'operator' || currentRole === 'system') ? 'block' : 'none';
  }
}

function updateRoleInfo(role) {
  const roleData = {
    subject: { icon: 'ğŸ‘¤', name: 'Subject (ë‹¹ì‚¬ì)', perms: { Action: 'yes', Commit: 'no', Audit: 'read' } },
    operator: { icon: 'ğŸ”§', name: 'Operator (ìš´ì˜ì)', perms: { Action: 'yes', Commit: 'yes', Audit: 'read' } },
    sponsor: { icon: 'ğŸ’°', name: 'Sponsor (ìê¸ˆ ì œê³µ)', perms: { Action: 'no', Commit: 'yes', Audit: 'read' } },
    employer: { icon: 'ğŸ¢', name: 'Employer (ê³ ìš©ì£¼)', perms: { Action: 'yes', Commit: 'yes', Audit: 'read' } },
    institution: { icon: 'ğŸ›ï¸', name: 'Institution (ì œë„)', perms: { Action: 'no', Commit: 'no', Audit: 'read' } },
    system: { icon: 'ğŸ”’', name: 'System (ì‹œìŠ¤í…œ)', perms: { Action: 'auto', Commit: 'auto', Audit: 'write' } }
  };
  
  const data = roleData[role] || roleData.subject;
  
  document.getElementById('role-info-icon').textContent = data.icon;
  document.getElementById('role-info-name').textContent = data.name;
  
  const permsHtml = Object.entries(data.perms).map(([key, val]) => {
    const cls = val === 'yes' || val === 'auto' ? 'yes' : val === 'no' ? 'no' : 'read';
    const text = val === 'yes' ? 'âœ“' : val === 'no' ? 'âœ—' : val === 'auto' ? 'âš¡' : 'ì—´ëŒ';
    return `<div class="perm-item"><span>${key}</span><span class="perm-value ${cls}">${text}</span></div>`;
  }).join('');
  
  document.getElementById('role-info-perms').innerHTML = permsHtml;
  
  // íŒ¨ë„ í‘œì‹œ
  const infoPanel = document.getElementById('role-info');
  infoPanel.classList.add('visible');
  setTimeout(() => infoPanel.classList.remove('visible'), 3000);
}

// ì´ˆê¸° ì—­í•  ì„¤ì •
setTimeout(() => switchRole('subject'), 500);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Magic Link ì¸ì¦ + ì˜¨ë³´ë”© í”Œë¡œìš°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentSession = null;
let onboardingPersonId = null;

function checkAuth() {
  // URLì—ì„œ ì„¸ì…˜ í† í° í™•ì¸
  const params = new URLSearchParams(window.location.search);
  const sessionToken = params.get('session');
  
  if (sessionToken) {
    validateSession(sessionToken);
    return;
  }
  
  // ì €ì¥ëœ ì„¸ì…˜ í™•ì¸
  const savedSession = localStorage.getItem('autus_session');
  if (savedSession) {
    validateSession(savedSession);
    return;
  }
  
  // ì¸ì¦ í•„ìš” â€” í•˜ì§€ë§Œ ë°ëª¨ ëª¨ë“œë¡œ ì§„í–‰ ê°€ëŠ¥í•˜ë„ë¡ ìˆ¨ê¹€
  // showAuthOverlay();
}

async function validateSession(token) {
  try {
    const res = await fetch(`${API_BASE}/api/v1/auth/session/${token}`);
    if (res.ok) {
      currentSession = await res.json();
      localStorage.setItem('autus_session', token);
      logAction(`Logged in as ${currentSession.email}`, 'success');
      // URL ì •ë¦¬
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  } catch (e) {
    console.warn('[Auth] Session validation failed');
  }
}

function showAuthOverlay() {
  document.getElementById('auth-overlay').classList.remove('hidden');
}

function closeAuthOverlay() {
  document.getElementById('auth-overlay').classList.add('hidden');
}

function showLogin() {
  document.querySelectorAll('.onboarding-form').forEach(f => f.classList.remove('active'));
  document.getElementById('auth-login').classList.add('active');
}

function showOnboarding() {
  document.querySelectorAll('.onboarding-form').forEach(f => f.classList.remove('active'));
  document.getElementById('onboard-step1').classList.add('active');
}

async function requestMagicLink() {
  const email = document.getElementById('auth-email').value;
  if (!email) return alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  
  try {
    const res = await fetch(`${API_BASE}/api/v1/auth/magic-link/request`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    if (res.ok) {
      const data = await res.json();
      document.querySelectorAll('.onboarding-form').forEach(f => f.classList.remove('active'));
      document.getElementById('auth-sent').classList.add('active');
      
      // ê°œë°œìš©: ìë™ ë¡œê·¸ì¸ ë§í¬ í‘œì‹œ
      if (data._dev_url) {
        console.log('[DEV] Magic Link:', data._dev_url);
        // ìë™ ê²€ì¦ (ê°œë°œìš©)
        setTimeout(() => {
          window.location.href = `${API_BASE}${data._dev_url}`;
        }, 2000);
      }
    }
  } catch (e) {
    console.error('[Auth] Magic link request failed:', e);
  }
}

async function submitOnboardingStep(step) {
  const endpoints = {
    1: '/api/v1/onboarding/step1',
    2: '/api/v1/onboarding/step2',
    3: '/api/v1/onboarding/step3',
    4: '/api/v1/onboarding/step4'
  };
  
  let body = {};
  
  if (step === 1) {
    body = {
      email: document.getElementById('ob-email').value,
      name: document.getElementById('ob-name').value,
      country: document.getElementById('ob-country').value
    };
  } else if (step === 2) {
    body = {
      person_id: onboardingPersonId,
      university: document.getElementById('ob-university').value,
      major: document.getElementById('ob-major').value,
      enrollment_date: new Date().toISOString().split('T')[0],
      tuition_amount: parseInt(document.getElementById('ob-tuition').value) || 0
    };
  } else if (step === 3) {
    body = {
      person_id: onboardingPersonId,
      employer: document.getElementById('ob-employer').value,
      job_title: document.getElementById('ob-job').value,
      wage_amount: parseInt(document.getElementById('ob-wage').value) || 0,
      start_date: new Date().toISOString().split('T')[0]
    };
  } else if (step === 4) {
    body = {
      person_id: onboardingPersonId,
      sponsor: document.getElementById('ob-sponsor').value || null,
      grant_amount: parseInt(document.getElementById('ob-grant').value) || null
    };
  }
  
  try {
    const res = await fetch(`${API_BASE}${endpoints[step]}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    
    if (res.ok) {
      const data = await res.json();
      
      if (step === 1) {
        onboardingPersonId = data.person_id;
      }
      
      // ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ
      document.querySelectorAll('.onboarding-form').forEach(f => f.classList.remove('active'));
      
      if (step < 4) {
        document.getElementById(`onboard-step${step + 1}`).classList.add('active');
      } else {
        document.getElementById('onboard-complete').classList.add('active');
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        setTimeout(() => {
          refreshCommitData();
        }, 1000);
      }
      
      logAction(`Onboarding Step ${step} completed`, 'success');
    }
  } catch (e) {
    console.error('[Onboarding] Step failed:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê³„ì•½ì„œ PDF ìƒì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateContract(personId) {
  try {
    const res = await fetch(`${API_BASE}/api/v1/contract/generate/${personId}`);
    if (!res.ok) return;
    
    const data = await res.json();
    showContractModal(data);
  } catch (e) {
    console.error('[Contract] Generation failed:', e);
  }
}

function showContractModal(data) {
  const modal = document.getElementById('contract-modal');
  const content = document.getElementById('contract-content');
  
  let html = `
    <h1>ğŸ“„ ê³„ì•½ì„œ íŒ¨í‚¤ì§€</h1>
    <p style="color:#888;font-size:11px">AUTUS ì‹œìŠ¤í…œì— ì˜í•´ ìë™ ìƒì„±ë¨ | ${new Date().toLocaleDateString()}</p>
    <hr style="margin:20px 0;border-color:#eee">
    
    <h2>ğŸ‘¤ ìˆ˜í˜œì ì •ë³´</h2>
    <p><strong>ID:</strong> ${data.person_id}</p>
    <p><strong>ì´ë¦„:</strong> ${data.person_name || 'â€”'}</p>
    
    <h2>ğŸ“Š Commit ìš”ì•½</h2>
    <p><strong>ì´ Commit:</strong> ${data.summary?.total_commits || 0}ê°œ</p>
    <p><strong>ì´ ê¸ˆì•¡:</strong> ${formatCurrency(data.summary?.total_amount || 0)}</p>
    <p><strong>Survival Mass:</strong> ${data.summary?.survival_mass?.toFixed(2) || '0.00'}</p>
    <p><strong>Risk Score:</strong> ${Math.round(data.summary?.risk_score || 0)}ì </p>
  `;
  
  if (data.contracts && data.contracts.length > 0) {
    data.contracts.forEach((contract, i) => {
      html += `
        <hr style="margin:20px 0;border-color:#eee">
        <h2>${i + 1}. ${contract.type?.toUpperCase()} ê³„ì•½</h2>
        <p><strong>Contract ID:</strong> ${contract.contract_id}</p>
        <p><strong>ê¸ˆì•¡:</strong> ${formatCurrency(contract.terms?.amount || 0)}</p>
        <p><strong>ê¸°ê°„:</strong> ${contract.terms?.start_date || 'â€”'} ~ ${contract.terms?.end_date || 'ì§„í–‰ì¤‘'}</p>
        
        <h3>ê³„ì•½ ì¡°í•­</h3>
        <ul style="font-size:11px;line-height:1.8">
          ${(contract.clauses || []).map(c => `<li><strong>${c.title}:</strong> ${c.content}</li>`).join('')}
        </ul>
        
        <div class="signature">
          <p>âœ“ AUTUS ê²€ì¦ ì™„ë£Œ</p>
          <p>Commit ID: ${contract.signatures?.commit_id}</p>
          <p>Audit Hash: ${contract.signatures?.audit_hash}</p>
        </div>
      `;
    });
  }
  
  html += `
    <div class="contract-actions">
      <button class="print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
      <button class="close" onclick="closeContractModal()">ë‹«ê¸°</button>
    </div>
  `;
  
  content.innerHTML = html;
  modal.classList.add('visible');
}

function closeContractModal() {
  document.getElementById('contract-modal').classList.remove('visible');
}

// ì¸ì¦ ì²´í¬ (ì´ˆê¸°í™” ì‹œ)
setTimeout(checkAuth, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMIT ì¤‘ì‹¬ â€” í•™ìƒ 1ëª… ì‹œë®¬ë ˆì´ì…˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let commitData = null;

async function createDemoStudent() {
  try {
    const res = await fetch(`${API_BASE}/api/v1/commit/demo/student`, { method: 'POST' });
    if (res.ok) {
      const data = await res.json();
      logAction('Demo student created: ê¹€ìœ í•™', 'success');
      await refreshCommitData();
    }
  } catch (e) {
    console.warn('[Commit] Demo creation failed:', e);
    logAction('Demo ìƒì„± ì‹¤íŒ¨', 'critical');
  }
}

async function refreshCommitData() {
  try {
    const res = await fetch(`${API_BASE}/api/v1/commit/person/STU_001`);
    if (!res.ok) {
      // Personì´ ì—†ìœ¼ë©´ íŒ¨ë„ ìˆ¨ê¸°ê¸° ëŒ€ì‹  ì•ˆë‚´ í‘œì‹œ
      document.getElementById('commit-person').innerHTML = `
        <div class="person-name">ë°ì´í„° ì—†ìŒ</div>
        <div class="person-role">"ğŸ“Š ë°ëª¨ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
      `;
      return;
    }
    
    commitData = await res.json();
    renderCommitPanel();
  } catch (e) {
    console.warn('[Commit] Refresh failed:', e);
  }
}

function renderCommitPanel() {
  if (!commitData || commitData.error) return;
  
  const { person, commits, survival, risk } = commitData;
  
  // Person ì •ë³´
  document.getElementById('commit-person').innerHTML = `
    <div class="person-name">${person.name || person.person_id}</div>
    <div class="person-role">${person.role?.toUpperCase() || 'UNKNOWN'} Â· ${person.country || 'N/A'}</div>
  `;
  
  // Status Badge
  const statusBadge = document.getElementById('commit-status');
  statusBadge.textContent = survival.status?.toUpperCase() || 'UNKNOWN';
  statusBadge.className = `badge ${survival.status || 'yellow'}`;
  
  // Metrics
  const massEl = document.getElementById('survival-mass');
  massEl.textContent = survival.survival_mass?.toFixed(2) || '0.0';
  massEl.className = 'metric-value ' + (survival.status === 'green' ? 'safe' : survival.status === 'yellow' ? 'warning' : 'danger');
  
  const riskEl = document.getElementById('risk-score');
  riskEl.textContent = Math.round(risk.risk_score || 0);
  riskEl.className = 'metric-value ' + (risk.risk_score > 70 ? 'danger' : risk.risk_score > 40 ? 'warning' : 'safe');
  
  // Commit List
  const listEl = document.getElementById('commit-list');
  if (commits && commits.length > 0) {
    listEl.innerHTML = commits.map(c => `
      <div class="commit-item ${c.commit_type}">
        <div class="commit-info">
          <div class="commit-type">${c.commit_type?.toUpperCase()}</div>
          <div class="commit-amount">${formatCurrency(c.amount)}</div>
        </div>
        <div class="commit-physics">
          <div class="mass">M: ${c.mass?.toFixed(2)}</div>
          <div>G: ${c.gravity?.toFixed(2)}</div>
        </div>
      </div>
    `).join('');
  } else {
    listEl.innerHTML = '<div style="text-align:center;color:#666;font-size:10px;padding:10px">í™œì„± Commit ì—†ìŒ</div>';
  }
  
  // Worst Case
  document.getElementById('worst-case').innerHTML = `âš ï¸ ${risk.worst_case_label || 'ìƒíƒœ ë¶„ì„ ì¤‘...'}`;
}

// ì´ˆê¸° ë¡œë“œ
setTimeout(refreshCommitData, 1500);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// P0 ì—…ë¬´ ìë™í™” â€” "Human decides once â†’ System closes forever"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingTasks = [];

async function fetchPendingTasks() {
  try {
    const res = await fetch(`${API_BASE}/api/v1/tasks/pending`);
    if (!res.ok) return;
    const data = await res.json();
    pendingTasks = data.tasks || [];
    renderTaskPanel();
  } catch (e) {
    console.warn('[Tasks] Fetch failed:', e);
  }
}

function renderTaskPanel() {
  const container = document.getElementById('task-list');
  const countBadge = document.getElementById('task-count');
  
  countBadge.textContent = pendingTasks.length;
  countBadge.style.display = pendingTasks.length > 0 ? 'inline' : 'none';
  
  if (pendingTasks.length === 0) {
    container.innerHTML = `
      <div class="task-empty">
        <span class="icon">âœ…</span>
        ëª¨ë“  ì—…ë¬´ ì™„ë£Œ
      </div>
    `;
    return;
  }
  
  container.innerHTML = pendingTasks.map(task => `
    <div class="task-item ${task.priority?.toLowerCase() || 'medium'}" data-id="${task.id}">
      <div class="task-title">${task.title}</div>
      <div class="task-desc">${task.description}</div>
      <div class="task-actions">
        <button class="task-btn lock" onclick="executeTask('${task.id}', 'LOCK')">LOCK</button>
        <button class="task-btn hold" onclick="executeTask('${task.id}', 'HOLD')">HOLD</button>
        <button class="task-btn reject" onclick="executeTask('${task.id}', 'REJECT')">REJECT</button>
      </div>
    </div>
  `).join('');
}

async function executeTask(taskId, action) {
  const task = pendingTasks.find(t => t.id === taskId);
  if (!task) return;
  
  // ë²„íŠ¼ ë¹„í™œì„±í™”
  const taskEl = document.querySelector(`[data-id="${taskId}"]`);
  if (taskEl) taskEl.style.opacity = '0.5';
  
  try {
    // ë¦¬ìŠ¤í¬ ì°¨ë‹¨ API í˜¸ì¶œ
    const res = await fetch(`${API_BASE}/api/v1/task/risk/decide`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        risk_type: task.type,
        action: action,
        actor_id: 'user'
      })
    });
    
    if (res.ok) {
      const result = await res.json();
      
      // í† ìŠ¤íŠ¸ í‘œì‹œ
      const toast = document.getElementById('task-toast');
      toast.textContent = `âœ“ ${action === 'LOCK' ? 'ìŠ¹ì¸ ì™„ë£Œ' : action === 'HOLD' ? 'ë³´ë¥˜ë¨' : 'ê±°ë¶€ë¨'}`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
      
      // ëª©ë¡ì—ì„œ ì œê±°
      pendingTasks = pendingTasks.filter(t => t.id !== taskId);
      renderTaskPanel();
      
      // ë¡œê·¸
      logAction(`Task ${action}: ${task.title}`, action === 'LOCK' ? 'success' : 'warning');
      
      // LOCKì¸ ê²½ìš° ì‹œìŠ¤í…œ ìƒíƒœ ê°±ì‹ 
      if (action === 'LOCK') {
        setTimeout(syncWithAPI, 500);
      }
    }
  } catch (e) {
    console.error('[Task] Execute failed:', e);
    if (taskEl) taskEl.style.opacity = '1';
  }
}

// ì£¼ê¸°ì ìœ¼ë¡œ ëŒ€ê¸° ì—…ë¬´ í™•ì¸ (30ì´ˆë§ˆë‹¤)
setInterval(fetchPendingTasks, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NADELLA: ê³µìœ  ê¸°ëŠ¥ â€” íŒ€ í˜‘ì—… ì§€ì›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateShareableState() {
  // í˜„ì¬ ìƒíƒœë¥¼ ê°„ê²°í•œ JSONìœ¼ë¡œ ì¸ì½”ë”©
  const state = {
    r: Math.round(TwinState.RECOVERY * 100),    // Recovery
    s: Math.round(TwinState.STABILITY * 100),   // Stability
    c: Math.round(TwinState.COHESION * 100),    // Cohesion
    h: Math.round(TwinState.SHOCK * 100),       // Shock (h for hazard)
    f: Math.round(TwinState.FRICTION * 100),    // Friction
    t: Math.round(TwinState.TRANSFER * 100),    // Transfer
    i: Math.round(TwinState.TIME * 100),        // Time (i for interval)
    q: Math.round(TwinState.QUALITY * 100),     // Quality
    o: Math.round(TwinState.OUTPUT * 100),      // Output
    ts: Date.now()                              // Timestamp
  };
  return btoa(JSON.stringify(state)); // Base64 ì¸ì½”ë”©
}

function parseSharedState(encoded) {
  try {
    const state = JSON.parse(atob(encoded));
    return {
      RECOVERY: (state.r || 50) / 100,
      STABILITY: (state.s || 50) / 100,
      COHESION: (state.c || 50) / 100,
      SHOCK: (state.h || 50) / 100,
      FRICTION: (state.f || 50) / 100,
      TRANSFER: (state.t || 50) / 100,
      TIME: (state.i || 50) / 100,
      QUALITY: (state.q || 50) / 100,
      OUTPUT: (state.o || 50) / 100
    };
  } catch (e) {
    console.warn('[Share] Invalid state encoding');
    return null;
  }
}

function shareCurrentState() {
  const encoded = generateShareableState();
  const url = `${window.location.origin}${window.location.pathname}?state=${encoded}`;
  
  // í´ë¦½ë³´ë“œì— ë³µì‚¬
  navigator.clipboard.writeText(url).then(() => {
    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
    const btn = document.getElementById('share-button');
    btn.classList.add('copied');
    btn.innerHTML = '<span>âœ“</span> COPIED';
    
    // í† ìŠ¤íŠ¸ í‘œì‹œ
    const toast = document.getElementById('share-toast');
    toast.classList.add('show');
    
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = '<span>ğŸ“¤</span> SHARE';
      toast.classList.remove('show');
    }, 2500);
    
    logAction('Share link copied to clipboard', 'success');
  }).catch(err => {
    console.error('[Share] Copy failed:', err);
    // Fallback: promptë¡œ í‘œì‹œ
    prompt('ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', url);
  });
}

function loadSharedState() {
  const params = new URLSearchParams(window.location.search);
  const encoded = params.get('state');
  if (!encoded) return false;
  
  const state = parseSharedState(encoded);
  if (!state) return false;
  
  // ê³µìœ ëœ ìƒíƒœ ì ìš©
  Object.assign(TwinState, state);
  updateFullState();
renderPlanetList();
  logAction('Loaded shared state', 'success');
  
  // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (íˆìŠ¤í† ë¦¬ ì •ë¦¬)
  window.history.replaceState({}, document.title, window.location.pathname);
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JACK MA: ì²« ì‚¬ìš©ì ì˜¨ë³´ë”©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkOnboarding() {
  const hasVisited = localStorage.getItem('autus_onboarding_complete');
  if (hasVisited) {
    document.getElementById('onboarding-overlay').classList.add('hidden');
  }
}

function closeOnboarding(skipForever = false) {
  if (skipForever) {
    localStorage.setItem('autus_onboarding_complete', 'true');
  }
  const overlay = document.getElementById('onboarding-overlay');
  overlay.style.animation = 'fadeOut 0.3s ease forwards';
  setTimeout(() => overlay.classList.add('hidden'), 300);
  logAction('Welcome to AUTUS Solar HQ', 'success');
}

// ì˜¨ë³´ë”© fade out ì• ë‹ˆë©”ì´ì…˜
const styleSheet = document.createElement('style');
styleSheet.textContent = '@keyframes fadeOut{from{opacity:1}to{opacity:0}}';
document.head.appendChild(styleSheet);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onresize = () => { camera.aspect = innerWidth / innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); };

// ì˜¨ë³´ë”© ì²´í¬
checkOnboarding();

// Nadella: ê³µìœ ëœ ìƒíƒœ ë¡œë“œ
loadSharedState();

// P0: ëŒ€ê¸° ì—…ë¬´ ë¡œë“œ
setTimeout(fetchPendingTasks, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTION MODE â€” URL íŒŒë¼ë¯¸í„°ë¡œ ì—­í•  ì²˜ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initProductionMode() {
  const params = new URLSearchParams(location.search);
  const role = params.get('role') || 'subject';
  const shared = params.has('state');
  
  // ì—­í•  ì„¤ì • (CSS ì œì–´ìš©)
  document.body.dataset.role = role;
  
  // ê³µìœ  ë§í¬ í‘œì‹œ
  if (shared) {
    document.body.classList.add('shared-view');
  }
  
  // Operator ëª¨ë“œ í† ê¸€ (ë”ë¸”í´ë¦­ìœ¼ë¡œ ìˆ¨ê²¨ì§„ ê¸°ëŠ¥)
  const solarCore = document.querySelector('canvas') || document.body;
  let clickCount = 0;
  let clickTimer = null;
  
  solarCore.addEventListener('click', () => {
    clickCount++;
    if (clickTimer) clearTimeout(clickTimer);
    
    if (clickCount >= 3) {
      // íŠ¸ë¦¬í”Œ í´ë¦­ìœ¼ë¡œ Operator ëª¨ë“œ í† ê¸€
      document.body.classList.toggle('operator-mode');
      const isOp = document.body.classList.contains('operator-mode');
      console.log(`[AUTUS] Operator mode: ${isOp ? 'ON' : 'OFF'}`);
      clickCount = 0;
    } else {
      clickTimer = setTimeout(() => { clickCount = 0; }, 500);
    }
  });
  
  console.log(`[AUTUS] Role: ${role}, Shared: ${shared}`);
})();

// Initialize state
updateFullState();
renderPlanetList();

// Kernel init log (minimal)
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('  AUTUS SOLAR HQ â€” PRODUCTION MODE');
console.log('');
console.log('  "ì™„ë²½í•´ì•¼ ì“°ëŠ” ì œí’ˆ â†’ ì¨ë³´ë‹ˆ ì™„ë²½í•œ ì œí’ˆ"');
console.log('');
console.log('  Triple-click on canvas to toggle Operator mode');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

animate();
  </script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTUS BEGINNER/EXPERT MODE v2.0
     - ViewMode ê´€ë¦¬ (localStorage ì €ì¥)
     - i18n ì§€ì› (ko-KR, en, vi-VN, id-ID)
     - Copy Set A/B í…ŒìŠ¤íŠ¸
     - Auto-Apply ê¸°ëŠ¥ (Policy ê¸°ë°˜)
     - Audit ë¡œê¹…
     - window.__AUTUS_MODEL ë°ì´í„° ì†ŒìŠ¤
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- PhysicsFrame â†’ __AUTUS_MODEL ë¸Œë¦¿ì§€ + (7)(8)(9) Verdict/i18n/Scoring -->
<script>
(function(){
  'use strict';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // (8) LocalePack â€” i18n + CopySet
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const LocalePacks = {
    "ko-KR": {
      toneDefault: "DIRECT",
      formatMoney: (n) => {
        if (!Number.isFinite(n)) return "â€”";
        const man = Math.round(Math.abs(n) / 10000);
        return `â‚©${man}ë§Œ`;
      },
      templates: {
        A: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `ì§€ê¸ˆì€ ìœ„í—˜ ìƒíƒœì…ë‹ˆë‹¤. ${c} ë¬¸ì œë¡œ 24ì‹œê°„ ë‚´ ${loss24} ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`
                  : `ì§€ê¸ˆì€ ìœ„í—˜ ìƒíƒœì…ë‹ˆë‹¤. ${c} ë¬¸ì œë¡œ ë§¤ë‹¬ ${lossM} ì†ì‹¤ì´ í™•ëŒ€ë©ë‹ˆë‹¤.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `ì§€ê¸ˆì€ ì•ˆì „í•´ ë³´ì—¬ë„ ${c} ë¬¸ì œë¡œ 24ì‹œê°„ ë‚´ ${loss24} ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`
                  : `ì§€ê¸ˆì€ ì•ˆì „í•´ ë³´ì—¬ë„ ${c} ë¬¸ì œë¡œ ë°©ì¹˜ ì‹œ ë§¤ë‹¬ ${lossM} ì†ì‹¤ì´ ë°œìƒí•©ë‹ˆë‹¤.`,
          HEALTHY: (c) => `í˜„ì¬ëŠ” ì•ˆì •ì ì…ë‹ˆë‹¤. ${c} ê°œì„  ì‹œ ì„±ê³¼ë¥¼ ë” ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
          NO_DATA: () => `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.`
        },
        B: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `ì§€ê¸ˆ ê°œì…í•˜ì§€ ì•Šìœ¼ë©´ ${c} ë¬¸ì œë¡œ 24ì‹œê°„ ë‚´ ${loss24} ì†ì‹¤ì´ ì»¤ì§‘ë‹ˆë‹¤.`
                  : `ì§€ê¸ˆ ê°œì…í•˜ì§€ ì•Šìœ¼ë©´ ${c} ë¬¸ì œë¡œ ë§¤ë‹¬ ${lossM} ì†ì‹¤ì´ ëˆ„ì ë©ë‹ˆë‹¤.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `ì§€ê¸ˆ ê°œì…í•˜ë©´ ${c} ë¬¸ì œë¡œ ì¸í•œ 24ì‹œê°„ ì†ì‹¤(${loss24})ì„ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
                  : `ì§€ê¸ˆ ê°œì…í•˜ë©´ ${c} ë¬¸ì œë¡œ ì¸í•œ ì›” ì†ì‹¤(${lossM})ì„ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
          HEALTHY: (c) => `í˜„ì¬ëŠ” ì•ˆì •ì ì…ë‹ˆë‹¤. ${c} ê°œì„ ìœ¼ë¡œ ì„±ê³¼ë¥¼ ë†’ì´ì„¸ìš”.`,
          NO_DATA: () => `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.`
        }
      },
      causeLabel: {
        RECOVERY: "íšŒë³µ(Recovery)",
        STABILITY: "ì•ˆì •(Stability)",
        COHESION: "ì—°ê²°(Cohesion)",
        SHOCK: "ì¶©ê²©(Shock)",
        FRICTION: "ë¹„íš¨ìœ¨(Friction)",
        TRANSFER: "ì „ë‹¬(Transfer)",
        TIME: "ì‹œê°„(Time)",
        QUALITY: "í’ˆì§ˆ(Quality)",
        OUTPUT: "ì„±ê³¼(Output)",
      }
    },

    "en-PH": {
      toneDefault: "SOFT",
      formatMoney: (n) => {
        if (!Number.isFinite(n)) return "â€”";
        const abs = Math.abs(n);
        if (abs >= 1_000_000) return `â‚±${(abs/1_000_000).toFixed(1)}M`;
        if (abs >= 1_000) return `â‚±${(abs/1_000).toFixed(1)}k`;
        return `â‚±${abs.toFixed(0)}`;
      },
      templates: {
        A: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `High risk now. ${c} is criticalâ€”act within 24h to prevent ${loss24} loss.`
                  : `High risk now. ${c} is criticalâ€”loss may reach ${lossM}/month.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `Stable, but ${c} is weakâ€”loss may reach ${loss24} within 24h.`
                  : `Stable, but ${c} is weakâ€”loss may reach ${lossM}/month.`,
          HEALTHY: (c) => `Stable now. Improving ${c} can increase outcomes.`,
          NO_DATA: () => `Loading data. Please check again shortly.`
        },
        B: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `Action needed. ${c} is driving a potential ${loss24} loss within 24h.`
                  : `Action needed. ${c} is driving a potential ${lossM}/month loss.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `Recommended: fix ${c} to avoid ${loss24} loss within 24h.`
                  : `Recommended: fix ${c} to avoid ${lossM}/month loss.`,
          HEALTHY: (c) => `Stable now. Improve ${c} to grow outcomes.`,
          NO_DATA: () => `Loading data. Please check again shortly.`
        }
      },
      causeLabel: {
        RECOVERY: "Recovery",
        STABILITY: "Stability",
        COHESION: "Cohesion",
        SHOCK: "Shock",
        FRICTION: "Friction",
        TRANSFER: "Transfer",
        TIME: "Time",
        QUALITY: "Quality",
        OUTPUT: "Output",
      }
    },

    "vi-VN": {
      toneDefault: "SOFT",
      formatMoney: (n) => {
        if (!Number.isFinite(n)) return "â€”";
        const abs = Math.abs(n);
        if (abs >= 1_000_000) return `${(abs/1_000_000).toFixed(1)}Mâ‚«`;
        if (abs >= 1_000) return `${(abs/1_000).toFixed(1)}kâ‚«`;
        return `${abs.toFixed(0)}â‚«`;
      },
      templates: {
        A: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `Rá»§i ro cao. ${c} Ä‘ang gÃ¢y tá»•n tháº¥t ${loss24} trong 24h.`
                  : `Rá»§i ro cao. ${c} Ä‘ang gÃ¢y tá»•n tháº¥t ${lossM}/thÃ¡ng.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `á»”n Ä‘á»‹nh, nhÆ°ng ${c} yáº¿uâ€”cÃ³ thá»ƒ máº¥t ${loss24} trong 24h.`
                  : `á»”n Ä‘á»‹nh, nhÆ°ng ${c} yáº¿uâ€”cÃ³ thá»ƒ máº¥t ${lossM}/thÃ¡ng.`,
          HEALTHY: (c) => `á»”n Ä‘á»‹nh. Cáº£i thiá»‡n ${c} Ä‘á»ƒ tÄƒng káº¿t quáº£.`,
          NO_DATA: () => `Äang táº£i dá»¯ liá»‡u. Vui lÃ²ng kiá»ƒm tra láº¡i sau.`
        },
        B: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `Cáº§n hÃ nh Ä‘á»™ng. ${c} cÃ³ thá»ƒ gÃ¢y máº¥t ${loss24} trong 24h.`
                  : `Cáº§n hÃ nh Ä‘á»™ng. ${c} cÃ³ thá»ƒ gÃ¢y máº¥t ${lossM}/thÃ¡ng.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `Khuyáº¿n nghá»‹: sá»­a ${c} Ä‘á»ƒ trÃ¡nh máº¥t ${loss24} trong 24h.`
                  : `Khuyáº¿n nghá»‹: sá»­a ${c} Ä‘á»ƒ trÃ¡nh máº¥t ${lossM}/thÃ¡ng.`,
          HEALTHY: (c) => `á»”n Ä‘á»‹nh. Cáº£i thiá»‡n ${c} Ä‘á»ƒ phÃ¡t triá»ƒn.`,
          NO_DATA: () => `Äang táº£i dá»¯ liá»‡u. Vui lÃ²ng kiá»ƒm tra láº¡i sau.`
        }
      },
      causeLabel: {
        RECOVERY: "Phá»¥c há»“i(Recovery)",
        STABILITY: "á»”n Ä‘á»‹nh(Stability)",
        COHESION: "LiÃªn káº¿t(Cohesion)",
        SHOCK: "CÃº sá»‘c(Shock)",
        FRICTION: "Ma sÃ¡t(Friction)",
        TRANSFER: "Truyá»n táº£i(Transfer)",
        TIME: "Thá»i gian(Time)",
        QUALITY: "Cháº¥t lÆ°á»£ng(Quality)",
        OUTPUT: "Káº¿t quáº£(Output)",
      }
    },

    "id-ID": {
      toneDefault: "SOFT",
      formatMoney: (n) => {
        if (!Number.isFinite(n)) return "â€”";
        const abs = Math.abs(n);
        if (abs >= 1_000_000) return `Rp${(abs/1_000_000).toFixed(1)}jt`;
        if (abs >= 1_000) return `Rp${(abs/1_000).toFixed(1)}rb`;
        return `Rp${abs.toFixed(0)}`;
      },
      templates: {
        A: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `Risiko tinggi. ${c} kritisâ€”bertindak dalam 24j untuk mencegah kerugian ${loss24}.`
                  : `Risiko tinggi. ${c} kritisâ€”kerugian bisa mencapai ${lossM}/bulan.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `Stabil, tapi ${c} lemahâ€”kerugian bisa ${loss24} dalam 24j.`
                  : `Stabil, tapi ${c} lemahâ€”kerugian bisa ${lossM}/bulan.`,
          HEALTHY: (c) => `Stabil sekarang. Tingkatkan ${c} untuk hasil lebih baik.`,
          NO_DATA: () => `Memuat data. Silakan periksa lagi nanti.`
        },
        B: {
          DANGER: (c, loss24, lossM) =>
            loss24 ? `Tindakan diperlukan. ${c} bisa menyebabkan kerugian ${loss24} dalam 24j.`
                  : `Tindakan diperlukan. ${c} bisa menyebabkan kerugian ${lossM}/bulan.`,
          STAGNANT: (c, loss24, lossM) =>
            loss24 ? `Rekomendasi: perbaiki ${c} untuk menghindari kerugian ${loss24} dalam 24j.`
                  : `Rekomendasi: perbaiki ${c} untuk menghindari kerugian ${lossM}/bulan.`,
          HEALTHY: (c) => `Stabil. Tingkatkan ${c} untuk berkembang.`,
          NO_DATA: () => `Memuat data. Silakan periksa lagi nanti.`
        }
      },
      causeLabel: {
        RECOVERY: "Pemulihan(Recovery)",
        STABILITY: "Stabilitas(Stability)",
        COHESION: "Keterhubungan(Cohesion)",
        SHOCK: "Guncangan(Shock)",
        FRICTION: "Gesekan(Friction)",
        TRANSFER: "Transfer(Transfer)",
        TIME: "Waktu(Time)",
        QUALITY: "Kualitas(Quality)",
        OUTPUT: "Hasil(Output)",
      }
    }
  };

  function getPack(locale, copySet){
    const loc = LocalePacks[locale] ? locale : "ko-KR";
    const set = (copySet === "B") ? "B" : "A";
    return { pack: LocalePacks[loc], set };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // (7) Verdict Generator
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function classifyState(model){
    const b = model?.bottleneck?.value;
    const risk = model?.snapshot?.risk_now ?? model?.snapshot?.risk;
    const isDanger = (Number.isFinite(b) && b >= 0.60) || (Number.isFinite(risk) && risk >= 0.55);
    const isHealthy = (Number.isFinite(b) && b < 0.40) && (Number.isFinite(risk) && risk < 0.35);
    return isDanger ? "DANGER" : (isHealthy ? "HEALTHY" : "STAGNANT");
  }

  function rootCauseType(model){
    return model?.bottleneck?.type || "COHESION";
  }

  function computeVerdict(model, locale, copySet){
    const { pack, set } = getPack(locale, copySet);
    const state = classifyState(model);
    const cause = pack.causeLabel[rootCauseType(model)] || "Key factor";
    const loss24 = model?.future?.no_action?.loss_24h;
    const lossM = model?.future?.no_action?.loss_monthly;
    const f24 = (Number.isFinite(loss24) && loss24 > 0) ? pack.formatMoney(loss24) : null;
    const fM  = (Number.isFinite(lossM)  && lossM  > 0) ? pack.formatMoney(lossM)  : null;

    const age = model?.snapshot?.ageSeconds;
    if (Number.isFinite(age) && age > 30) return pack.templates[set].NO_DATA();

    if (state === "DANGER") return pack.templates[set].DANGER(cause, f24, fM);
    if (state === "HEALTHY") return pack.templates[set].HEALTHY(cause);
    return pack.templates[set].STAGNANT(cause, f24, fM);
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // (9) Action Scoring + RECOMMENDED
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  function normalizeMoneySaved(action, noActionLossM){
    const moneyDelta = action?.deltas?.money_delta_monthly;
    const saved = Math.max(0, -(moneyDelta || 0));
    return clamp01(saved / Math.max(noActionLossM || 1, 1));
  }
  function normalizeTimeSaved(action){
    const timeDeltaH = action?.deltas?.time_delta_hours;
    const saved = Math.max(0, -(timeDeltaH || 0));
    return clamp01(saved / 24);
  }
  function normalizeRiskBenefit(action){
    const d = action?.deltas?.risk_delta;
    return clamp01(Math.max(0, -(d || 0)) / 0.10);
  }
  function normalizeEntropyBenefit(action){
    const d = action?.deltas?.entropy_delta;
    return clamp01(Math.max(0, -(d || 0)) / 0.10);
  }
  function normalizeRep(action){
    const s = action?.deltas?.rep_delta_sigma || 0;
    return clamp01((s + 0.5) / 1.0);
  }
  function normalizeDignity(action){
    const d = action?.deltas?.dignity_delta || 0;
    return clamp01((d + 1.0) / 2.0);
  }
  function recoveryPenalty(action){
    const r = action?.tradeoff?.recovery_delta;
    const loss = Math.max(0, -(r || 0));
    return clamp01(loss / 0.20);
  }

  const RoleWeights = {
    SUBJECT:      { wM:0.30,wT:0.15,wR:0.20,wE:0.15,wP:0.10,wD:0.10,wK:0.25 },
    OPERATOR:     { wM:0.35,wT:0.25,wR:0.15,wE:0.10,wP:0.05,wD:0.10,wK:0.20 },
    SPONSOR:      { wM:0.35,wT:0.20,wR:0.15,wE:0.10,wP:0.10,wD:0.10,wK:0.20 },
    EMPLOYER:     { wM:0.30,wT:0.20,wR:0.20,wE:0.10,wP:0.10,wD:0.10,wK:0.20 },
    INSTITUTION:  { wM:0.15,wT:0.10,wR:0.25,wE:0.15,wP:0.15,wD:0.20,wK:0.15 }
  };

  function scoreAction(action, model){
    const role = model?.role || "SUBJECT";
    const w = RoleWeights[role] || RoleWeights.SUBJECT;
    const noActionLossM = model?.future?.no_action?.loss_monthly || 1;

    const M = normalizeMoneySaved(action, noActionLossM);
    const T = normalizeTimeSaved(action);
    const R = normalizeRiskBenefit(action);
    const E = normalizeEntropyBenefit(action);
    const P = normalizeRep(action);
    const D = normalizeDignity(action);
    const K = recoveryPenalty(action);

    const S = w.wM*M + w.wT*T + w.wR*R + w.wE*E + w.wP*P + w.wD*D - w.wK*K;
    return { S, breakdown:{M,T,R,E,P,D,K}, weights:w };
  }

  function confidenceGate(model, action){
    const flags = model?.flags || {};
    if (flags.demo || flags.offline || flags.connecting) return { ok:false, reason:["ENV_BLOCKED"] };
    const age = model?.snapshot?.ageSeconds;
    if (Number.isFinite(age) && age > 30) return { ok:false, reason:["SNAPSHOT_STALE"] };
    const conf = action?.confidence;
    if (Number.isFinite(conf) && conf < 0.70) return { ok:false, reason:["CONFIDENCE_LOW"] };
    const lossM = model?.future?.no_action?.loss_monthly;
    const loss24 = model?.future?.no_action?.loss_24h;
    if (!(Number.isFinite(lossM) || Number.isFinite(loss24))) return { ok:false, reason:["FUTURE_NO_ACTION_MISSING"] };
    return { ok:true, reason:[] };
  }

  function pickRecommended(model){
    const actions = Array.isArray(model?.actions) ? model.actions : [];
    if (!actions.length) return null;

    const scored = actions.map(a => {
      const r = scoreAction(a, model);
      return { key:a.key, action:a, score:r.S, breakdown:r.breakdown };
    }).sort((a,b)=>b.score-a.score);

    const winner = scored[0];
    const gate = confidenceGate(model, winner.action);
    if (!gate.ok){
      return {
        recommendedKey: null,
        scored,
        reason_codes: gate.reason.map(x => `RC_${x}`)
      };
    }

    // tie-breaker
    if (scored[1] && Math.abs(scored[0].score - scored[1].score) < 0.05){
      const a = scored[0], b = scored[1];
      const aRE = (a.breakdown.R + a.breakdown.E);
      const bRE = (b.breakdown.R + b.breakdown.E);
      if (bRE > aRE) scored.unshift(scored.splice(1,1)[0]);
    }

    return {
      recommendedKey: scored[0].key,
      scored,
      reason_codes: ["RC_SCORE_WINNER"]
    };
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // enrichModelWith789 â€” (7)(8)(9) í†µí•©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function enrichModelWith789(model){
    const locale = model?.locale || "ko-KR";
    const copySet = (localStorage.getItem("autus.copySet") || "A").toUpperCase();

    // (7) Verdict ìƒì„±
    model.verdict = computeVerdict(model, locale, copySet);
    model.stateClass = classifyState(model);

    // (9) Action Scoring + RECOMMENDED
    const rec = pickRecommended(model);
    model.recommendation = rec;

    if (rec?.recommendedKey && Array.isArray(model.actions)){
      model.actions.forEach(a => { a.recommended = (a.key === rec.recommendedKey); });
    }

    // Reason codes for audit
    model.reason_codes = [
      ...(rec?.reason_codes || []),
      `RC_STATE_${classifyState(model)}`,
      `RC_BOTTLENECK_${rootCauseType(model)}`
    ];

    // (8) LocalePack ì •ë³´ ì¶”ê°€
    const { pack } = getPack(locale, copySet);
    model.causeLabel = pack.causeLabel[rootCauseType(model)] || "Key factor";

    return model;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PhysicsFrame â†’ __AUTUS_MODEL ë™ê¸°í™”
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function syncAutusModel() {
    if (typeof PhysicsFrame === 'undefined') return;
    
    const snap = PhysicsFrame.snapshot || {};
    const bn = PhysicsFrame.bottleneck || {};
    const ts = Date.now();
    
    // Risk ê¸°ë°˜ ì†ì‹¤ ê³„ì‚° (24h/ì›”)
    const risk = snap.risk || 0;
    const hourlyLoss = Math.round(risk * 500000);
    const loss24h = hourlyLoss * 24;
    const lossMonthly = loss24h * 30;
    
    // TwinStateì—ì„œ ì¶”ê°€ ë¸íƒ€ ê³„ì‚°
    const twinState = typeof TwinState !== 'undefined' ? TwinState : {};
    
    // Actions ìƒì„± (í™•ì¥ëœ deltas í¬í•¨)
    const actions = [
      {
        key: 'RECOVER',
        confidence: 0.87,
        tradeoff: { recovery_delta: 0.15 },
        deltas: {
          RECOVERY: 0.15, STABILITY: 0.06, COHESION: 0.04,
          risk_delta: -0.08,
          entropy_delta: -0.05,
          money_delta_monthly: -Math.round(lossMonthly * 0.4),
          time_delta_hours: -2,
          dignity_delta: 0.1,
          rep_delta_sigma: 0.1
        }
      },
      {
        key: 'DEFRICTION',
        confidence: 0.82,
        tradeoff: { recovery_delta: -0.04 },
        deltas: {
          FRICTION: -0.18, SHOCK: -0.07, TRANSFER: 0.06,
          risk_delta: -0.05,
          entropy_delta: -0.08,
          money_delta_monthly: -Math.round(lossMonthly * 0.35),
          time_delta_hours: -3,
          dignity_delta: 0.05,
          rep_delta_sigma: 0.05
        }
      },
      {
        key: 'SHOCK_DAMP',
        confidence: 0.91,
        tradeoff: { recovery_delta: -0.10 },
        deltas: {
          SHOCK: -0.25, STABILITY: 0.08, COHESION: 0.05,
          risk_delta: -0.12,
          entropy_delta: -0.03,
          money_delta_monthly: -Math.round(lossMonthly * 0.5),
          time_delta_hours: -1,
          dignity_delta: 0.15,
          rep_delta_sigma: 0.2
        }
      }
    ];
    
    // Role ê²°ì • (URL íŒŒë¼ë¯¸í„°ì—ì„œ)
    const params = new URLSearchParams(location.search);
    const role = (params.get('role') || 'SUBJECT').toUpperCase();
    
    // Locale ê²°ì •
    const langParam = params.get('locale');
    let locale = langParam || 'ko-KR';
    if (!langParam) {
      const lang = navigator.language || 'ko-KR';
      if (lang.startsWith('en')) locale = 'en-PH';
      else if (lang.startsWith('vi')) locale = 'vi-VN';
      else if (lang.startsWith('id')) locale = 'id-ID';
      else locale = 'ko-KR';
    }
    
    // __AUTUS_MODEL ìƒì„±
    window.__AUTUS_MODEL = {
      snapshot: {
        id: `snap_${ts}`,
        hash: btoa(JSON.stringify(snap)).slice(0, 12),
        risk: snap.risk || 0,
        risk_now: snap.risk || 0,
        entropy: snap.entropy || 0,
        pressure: snap.pressure || 0,
        flow: snap.flow || 0,
        dignity: snap.dignity || 0,
        reputation: snap.reputation || 0,
        ts: ts,
        ageSeconds: 0
      },
      bottleneck: {
        type: bn.axis || 'FRICTION',
        value: bn.value || 0
      },
      future: {
        no_action: {
          loss_24h: loss24h,
          loss_monthly: lossMonthly
        }
      },
      actions: actions,
      role: role,
      locale: locale,
      kernel_version: 'v2.4',
      flags: {
        demo: false,
        offline: false,
        connecting: false
      }
    };
    
    // (7)(8)(9) í†µí•© ì ìš©
    enrichModelWith789(window.__AUTUS_MODEL);
  }
  
  // ì´ˆê¸°í™” ë° ì£¼ê¸°ì  ë™ê¸°í™”
  function init() {
    syncAutusModel();
    setInterval(syncAutusModel, 500);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // ì™¸ë¶€ ì ‘ê·¼ìš©
  window.__AUTUS_ENRICH = enrichModelWith789;
  window.__AUTUS_LOCALE_PACKS = LocalePacks;
})();
</script>

<!-- Beginner/Expert ìŠ¤íƒ€ì¼ -->
<style>
  .hide-in-beginner{ display:none !important; }

  .decision-shell{
    position: fixed; left: 0; top: 0; right: 0;
    z-index: 99999;
    pointer-events: none;
    font-family: ui-sans-serif, system-ui, -apple-system;
  }
  .decision-panel{
    width: min(820px, calc(100vw - 24px));
    margin: 14px auto 0 auto;
    padding: 14px 14px 12px 14px;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 14px;
    background: rgba(0,0,0,0.62);
    backdrop-filter: blur(10px);
    pointer-events: auto;
  }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .title{ font-size: 12px; opacity: 0.75; font-weight: 700; letter-spacing: .4px; }
  .verdict{ font-size: 18px; line-height: 1.25; font-weight: 900; margin-top: 8px; }
  .sub{ font-size: 12px; opacity: .78; margin-top: 8px; }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
  .card{
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 12px;
    padding: 10px 12px;
    background: rgba(0,0,0,0.35);
  }
  .card h4{ margin:0 0 6px 0; font-size:11px; opacity:.72; font-weight:800; letter-spacing:.3px; }
  .v{ font-size:16px; font-weight:950; }
  .d{ font-size:12px; opacity:.75; margin-top:6px; }

  .actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  .btn-primary{
    appearance:none; border:0; cursor:pointer;
    padding: 12px 16px; border-radius: 12px;
    font-weight: 950; letter-spacing: 0.4px;
    background: #00ff85; color:#001a0e;
  }
  .btn-ghost{
    appearance:none; border:1px solid rgba(255,255,255,0.16);
    background: transparent; color:white;
    padding: 10px 12px; border-radius: 12px;
    cursor:pointer; font-weight:850;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding: 6px 10px; border-radius: 999px;
    border:1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.06);
    font-size: 12px; font-weight: 800;
  }
  .warn{ color: #ffd38a; }
  .ok{ color: #b9ffdd; }
  
  /* Expert ëª¨ë“œ ì „í™˜ ë²„íŠ¼ */
  #btn-beginner-from-expert {
    position: fixed;
    top: 32px;
    right: 140px;
    padding: 8px 16px;
    font-size: 11px;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.6);
    background: rgba(0,0,0,0.8);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    cursor: pointer;
    z-index: 300;
    transition: all 0.2s;
  }
  #btn-beginner-from-expert:hover {
    border-color: #00ff88;
    color: #00ff88;
  }
  
  /* Expert ëª¨ë“œì¼ ë•Œ ìˆ¨ê¹€ */
  body:not(.expert-mode) #btn-beginner-from-expert { display: none; }
  
  /* Expert Root ìš”ì†Œë“¤ */
  body.beginner-mode .expert-root { display: none !important; }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ”’ UI FINAL LOCK â€” Expert ëª¨ë“œ ì •ë¦¬
     ëª©í‘œ: "ì„¤ëª… ì—†ëŠ” ì™„ì œí’ˆ ì²´ê° UI"
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  
  /* 1ï¸âƒ£ ì¢Œì¸¡ íŒ¨ë„ ê¸°ë³¸ ìˆ¨ê¹€ */
  body.expert-mode .kernel-display,
  body.expert-mode #panel-metrics,
  body.expert-mode #panel-forecast,
  body.expert-mode #planet-list { display: none !important; }
  
  /* 2ï¸âƒ£ ì—­í•  íƒ­ ì œê±° */
  body.expert-mode .role-tabs,
  body.expert-mode [class*="role-select"],
  body.expert-mode [class*="role-switch"] { display: none !important; }
  
  /* 3ï¸âƒ£ Commit Dashboard ì œê±° */
  body.expert-mode .commit-dashboard,
  body.expert-mode [class*="commit-card"],
  body.expert-mode [class*="demo-data"] { display: none !important; }
  
  /* 4ï¸âƒ£ ë‹¨ì¶•í‚¤/ë””ë²„ê·¸ ì œê±° */
  body.expert-mode .keyboard-hint,
  body.expert-mode footer,
  body.expert-mode .bottom-controls,
  body.expert-mode [class*="shortcut"],
  body.expert-mode .test-results { display: none !important; }
  
  /* 5ï¸âƒ£ Risk Trend ê·¸ë˜í”„ ìˆ¨ê¹€ */
  body.expert-mode .risk-trend,
  body.expert-mode [class*="trend-chart"] { display: none !important; }
  
  /* 6ï¸âƒ£ ì„¤ëª… í…ìŠ¤íŠ¸ ì œê±° */
  body.expert-mode [class*="help-text"],
  body.expert-mode [class*="instruction"],
  body.expert-mode [class*="tooltip"] { display: none !important; }
  
  /* 7ï¸âƒ£ ACTION ë‹¨ì¼í™” â€” ì¶”ì²œë˜ì§€ ì•Šì€ ë²„íŠ¼ ìˆ¨ê¹€ */
  body.expert-mode .action-btn:not(.recommended) { display: none !important; }
  body.expert-mode #layer-action .non-recommended { display: none !important; }
  
  /* 8ï¸âƒ£ SOLAR ë¼ë²¨/í…ìŠ¤íŠ¸ ì œê±° */
  body.expert-mode #info { display: none !important; }
  body.expert-mode .solar-label,
  body.expert-mode .orbit-label { display: none !important; }
  
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Mini Compare (Action ë¹„êµ)
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #mini-compare {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 12px;
  }
  
  #mini-compare .mc {
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.25);
    transition: all 0.2s;
  }
  
  #mini-compare .mc:hover {
    border-color: rgba(255,255,255,0.2);
    background: rgba(0,0,0,0.4);
  }
  
  #mini-compare .mc.best {
    border-color: rgba(0,255,133,0.4);
    background: rgba(0,255,133,0.08);
  }
  
  #mini-compare .mc.warn {
    border-color: rgba(255,170,0,0.3);
  }
  
  #mini-compare .mc h5 {
    margin: 0 0 8px 0;
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 0.5px;
    color: rgba(255,255,255,0.9);
  }
  
  #mini-compare .mc.best h5 {
    color: #00ff85;
  }
  
  #mini-compare .mc .v {
    font-size: 14px;
    font-weight: 800;
    color: #00ff85;
    margin-bottom: 4px;
  }
  
  #mini-compare .mc .s {
    font-size: 11px;
    color: rgba(255,255,255,0.6);
    line-height: 1.4;
  }
  
  #mini-compare .mc.warn .s:last-child {
    color: #ffa94d;
  }
  
  /* Execute Preview */
  #execute-preview {
    margin-top: 10px;
    padding: 10px 12px;
    background: rgba(0,255,133,0.06);
    border: 1px solid rgba(0,255,133,0.15);
    border-radius: 8px;
    font-size: 12px;
    color: rgba(255,255,255,0.8);
  }
  
  #execute-preview .ok {
    color: #69db7c;
    font-weight: 700;
  }
  
  #execute-preview .warn {
    color: #ffa94d;
    font-weight: 700;
  }
  
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ”’ AUDIT ì—°ì¶œ (LOCK)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  
  /* AUDIT ì§„í–‰ ì¤‘ â€” ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ì •ì§€ */
  body.audit-freeze * {
    animation-play-state: paused !important;
    transition: none !important;
  }
  
  body.audit-freeze canvas {
    filter: grayscale(0.5) brightness(0.7);
  }
  
  /* í™”ë©´ ì§„ë™ */
  @keyframes auditShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
  }
  
  /* íŒì • í† í° ë‚™í•˜ */
  .audit-token {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: #00ff85;
    animation: tokenDrop 0.9s ease-in forwards;
    z-index: 100000;
    text-shadow: 0 0 20px rgba(0,255,133,0.8);
  }
  
  @keyframes tokenDrop {
    0% { 
      top: 50%; 
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    100% { 
      top: 85%; 
      opacity: 0.8;
      transform: translate(-50%, -50%) scale(1.5);
    }
  }
  
  /* AUDIT ì™„ë£Œ ì˜¤ë²„ë ˆì´ */
  .audit-complete-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100001;
    animation: fadeIn 0.3s ease-out;
  }
  
  .audit-complete-content {
    text-align: center;
  }
  
  .audit-complete-content .audit-icon {
    font-size: 72px;
    color: #00ff85;
    margin-bottom: 16px;
    animation: auditPulse 0.5s ease-out;
  }
  
  @keyframes auditPulse {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); opacity: 1; }
  }
  
  .audit-complete-content .audit-text {
    font-size: 24px;
    font-weight: 300;
    color: #fff;
    letter-spacing: 0.1em;
  }
  
  .audit-complete-content .audit-action {
    font-size: 14px;
    color: rgba(255,255,255,0.5);
    margin-top: 8px;
    letter-spacing: 0.2em;
  }
  
  /* ëª¨ë°”ì¼ ëŒ€ì‘ */
  @media (max-width: 600px) {
    #mini-compare {
      grid-template-columns: 1fr;
    }
  }
  
  body.beginner-mode .frame,
  body.beginner-mode .system-bar,
  body.beginner-mode .gate-container,
  body.beginner-mode .kernel-display,
  body.beginner-mode #panel-metrics,
  body.beginner-mode #panel-forecast,
  body.beginner-mode #planet-list,
  body.beginner-mode #info,
  body.beginner-mode #layer-action,
  body.beginner-mode #layer-audit,
  body.beginner-mode .test-results,
  body.beginner-mode .keyboard-hint,
  body.beginner-mode #action-risk-container { display: none !important; }
  
  body.beginner-mode canvas { opacity: 0.2; }
</style>

<!-- Beginner/Expert ë¡œì§ -->
<script>
(function(){
  // ---------------------------
  // 0) View Mode (4)
  // ---------------------------
  const ViewMode = { BEGINNER:"BEGINNER", EXPERT:"EXPERT" };
  const LS_VIEW = "autus.viewMode";
  let viewMode = localStorage.getItem(LS_VIEW) || ViewMode.BEGINNER;

  function setViewMode(mode){
    viewMode = mode;
    localStorage.setItem(LS_VIEW, mode);
    applyViewModeVisibility();
    renderDecision();
  }

  function applyViewModeVisibility(){
    const expertRoots = document.querySelectorAll(".expert-root");
    expertRoots.forEach(el=>{
      if(viewMode===ViewMode.BEGINNER) el.classList.add("hide-in-beginner");
      else el.classList.remove("hide-in-beginner");
    });
    const shell = document.getElementById("decision-shell");
    if(shell) shell.style.display = (viewMode===ViewMode.BEGINNER) ? "block" : "none";
    
    // body í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
    if(viewMode===ViewMode.BEGINNER) {
      document.body.classList.add("beginner-mode");
      document.body.classList.remove("expert-mode");
    } else {
      document.body.classList.remove("beginner-mode");
      document.body.classList.add("expert-mode");
    }
  }

  // ---------------------------
  // 1) Single Source ëª¨ë¸(í•„ìˆ˜)
  // Cursorê°€ ê¸°ì¡´ ë³€ìˆ˜ë¡œ window.__AUTUS_MODELì„ ì±„ì›Œì•¼ í•¨.
  // ---------------------------
  function getAutusModel(){
    return window.__AUTUS_MODEL || null;
  }

  // ---------------------------
  // 2) i18n + Copy Set (6)
  // ---------------------------
  const LS_COPY_SET = "autus.copySet"; // "A" | "B"
  const copySet = (localStorage.getItem(LS_COPY_SET) || "A").toUpperCase();

  const causeLabel = {
    RECOVERY:{ko:"íšŒë³µ(Recovery)", en:"Recovery", vi:"Phá»¥c há»“i(Recovery)", id:"Pemulihan(Recovery)"},
    STABILITY:{ko:"ì•ˆì •(Stability)", en:"Stability", vi:"á»”n Ä‘á»‹nh(Stability)", id:"Stabilitas(Stability)"},
    COHESION:{ko:"ì—°ê²°(Cohesion)", en:"Cohesion", vi:"LiÃªn káº¿t(Cohesion)", id:"Keterhubungan(Cohesion)"},
    SHOCK:{ko:"ì¶©ê²©(Shock)", en:"Shock", vi:"CÃº sá»‘c(Shock)", id:"Guncangan(Shock)"},
    FRICTION:{ko:"ë¹„íš¨ìœ¨(Friction)", en:"Friction", vi:"Ma sÃ¡t(Friction)", id:"Gesekan(Friction)"},
    TRANSFER:{ko:"ì „ë‹¬(Transfer)", en:"Transfer", vi:"Truyá»n táº£i(Transfer)", id:"Transfer(Transfer)"},
    TIME:{ko:"ì‹œê°„(Time)", en:"Time", vi:"Thá»i gian(Time)", id:"Waktu(Time)"},
    QUALITY:{ko:"í’ˆì§ˆ(Quality)", en:"Quality", vi:"Cháº¥t lÆ°á»£ng(Quality)", id:"Kualitas(Quality)"},
    OUTPUT:{ko:"ì„±ê³¼(Output)", en:"Output", vi:"Káº¿t quáº£(Output)", id:"Hasil(Output)"},
  };

  function fmtMoney(n, locale){
    if(!Number.isFinite(n)) return "â€”";
    if(locale==="ko-KR"){
      const man = Math.round(Math.abs(n)/10000);
      return `â‚©${man}ë§Œ`;
    }
    const abs = Math.abs(n);
    if(abs>=1_000_000) return `${(abs/1_000_000).toFixed(1)}M`;
    if(abs>=1_000) return `${(abs/1_000).toFixed(1)}k`;
    return `${abs.toFixed(0)}`;
  }

  function getCauseText(type, locale){
    const entry = causeLabel[type] || null;
    if(!entry) return locale==="ko-KR" ? "í•µì‹¬ ì§€í‘œ" : "Key factor";
    if(locale==="ko-KR") return entry.ko;
    if(locale==="vi-VN") return entry.vi;
    if(locale==="id-ID") return entry.id;
    return entry.en;
  }

  function buildVerdict(model){
    const locale = model?.locale || "ko-KR";
    const bType = model?.bottleneck?.type;
    const cause = getCauseText(bType, locale);

    const loss24h = model?.future?.no_action?.loss_24h;
    const lossM = model?.future?.no_action?.loss_monthly;

    if(locale==="ko-KR"){
      if(copySet==="B"){
        if(Number.isFinite(loss24h) && loss24h>0) return `ì§€ê¸ˆ ê°œì…í•˜ì§€ ì•Šìœ¼ë©´ ${cause} ë¬¸ì œë¡œ 24ì‹œê°„ ë‚´ ${fmtMoney(loss24h, locale)} ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`;
        if(Number.isFinite(lossM) && lossM>0) return `ì§€ê¸ˆ ê°œì…í•˜ì§€ ì•Šìœ¼ë©´ ${cause} ë¬¸ì œë¡œ ë§¤ë‹¬ ${fmtMoney(lossM, locale)} ì†ì‹¤ì´ ëˆ„ì ë©ë‹ˆë‹¤.`;
        return `í˜„ì¬ëŠ” ì•ˆì •ì ì´ë‚˜ ${cause} ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
      }
      if(Number.isFinite(loss24h) && loss24h>0) return `ì§€ê¸ˆì€ ì•ˆì „í•´ ë³´ì—¬ë„ ${cause} ë¬¸ì œë¡œ 24ì‹œê°„ ë‚´ ${fmtMoney(loss24h, locale)} ì†ì‹¤ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.`;
      if(Number.isFinite(lossM) && lossM>0) return `ì§€ê¸ˆì€ ì•ˆì „í•´ ë³´ì—¬ë„ ${cause} ë¬¸ì œë¡œ ë°©ì¹˜ ì‹œ ë§¤ë‹¬ ${fmtMoney(lossM, locale)} ì†ì‹¤ì´ ë°œìƒí•©ë‹ˆë‹¤.`;
      return `í˜„ì¬ëŠ” ì•ˆì •ì ì´ì§€ë§Œ ${cause} ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
    }

    const lossPart = (Number.isFinite(loss24h) && loss24h>0) ? `${fmtMoney(loss24h, locale)} within 24h`
                   : (Number.isFinite(lossM) && lossM>0) ? `${fmtMoney(lossM, locale)} /month`
                   : null;

    if(copySet==="B"){
      return lossPart
        ? `Action recommended: ${cause} is weak â€” potential loss ${lossPart}.`
        : `Stable now. Improving ${cause} can increase outcomes.`;
    }
    return lossPart
      ? `Stable, but ${cause} is weak â€” loss may reach ${lossPart} if unchanged.`
      : `Stable now. Improving ${cause} can increase outcomes.`;
  }

  // ---------------------------
  // 3) Primary Action ì„ íƒ â€” ğŸ”’ LOCK ê·œì¹™
  // ---------------------------
  /**
   * ACTION SELECT LOGIC (LOCK):
   * if (risk >= 60 && shock > friction): SHOCK_DAMP
   * elif (risk >= 60 && friction >= shock): DEFRICTION
   * elif (risk < 60 && recovery_possible): RECOVER
   * else: NONE (ë²„íŠ¼ ë¯¸ë…¸ì¶œ)
   * SYSTEM RED â†’ ëª¨ë“  ACTION ë¯¸ë…¸ì¶œ
   */
  function pickSingleAction(model){
    // SYSTEM RED â†’ ACTION ì—†ìŒ
    const risk = model?.snapshot?.risk || 0;
    const gate = model?.snapshot?.gate || (risk >= 0.55 ? "RED" : risk >= 0.30 ? "AMBER" : "GREEN");
    if (gate === "RED" && risk >= 0.70) return null; // ê·¹ì‹¬í•œ ìœ„í—˜: ì‹œìŠ¤í…œ ì°¨ë‹¨
    
    const shock = model?.bottleneck?.type === "SHOCK" ? (model?.bottleneck?.value || 0) : 0;
    const friction = model?.bottleneck?.type === "FRICTION" ? (model?.bottleneck?.value || 0) : 0;
    const recovery = model?.snapshot?.recovery || 0.5;
    
    // ê³ ìœ„í—˜ ìƒí™© (risk >= 60%)
    if (risk >= 0.60) {
      if (shock > friction) return "SHOCK_DAMP";
      if (friction >= shock && friction > 0) return "DEFRICTION";
      return "RECOVER";
    }
    
    // ì¤‘ìœ„í—˜ ìƒí™© (30% <= risk < 60%)
    if (risk >= 0.30) {
      if (model?.bottleneck?.type === "SHOCK") return "SHOCK_DAMP";
      if (model?.bottleneck?.type === "FRICTION") return "DEFRICTION";
      if (recovery < 0.50) return "RECOVER";
      return "RECOVER";
    }
    
    // ì €ìœ„í—˜ ìƒí™© (risk < 30%)
    // ì—¬ì „íˆ bottleneckì´ ìˆìœ¼ë©´ ì¡°ì¹˜ ê¶Œì¥
    if (model?.bottleneck?.value >= 0.40) {
      if (model?.bottleneck?.type === "SHOCK") return "SHOCK_DAMP";
      if (model?.bottleneck?.type === "FRICTION") return "DEFRICTION";
      return "RECOVER";
    }
    
    // ì•ˆì • ìƒíƒœ â†’ ACTION ì—†ìŒ (ì„ íƒì )
    return "RECOVER"; // ê¸°ë³¸ê°’ìœ¼ë¡œ RECOVER ìœ ì§€
  }
  
  // í•˜ìœ„ í˜¸í™˜ì„±
  function pickPrimaryAction(model){
    return pickSingleAction(model) || "RECOVER";
  }

  function findActionButtonByKey(key){
    const label = (key==="SHOCK_DAMP") ? "SHOCK DAMP" : key;
    const buttons = Array.from(document.querySelectorAll("button"));
    return buttons.find(b => (b.textContent||"").trim() === label) || null;
  }

  // ---------------------------
  // 4) Auto-Apply (5) + Audit
  // ---------------------------
  const LS_AUTO = "autus.autoApply.enabled";
  const LS_LAST_RUN = "autus.autoApply.lastRunMs";
  const AUTO_COOLDOWN_MS = 60_000;

  function nowMs(){ return Date.now(); }

  function emitAudit(event){
    try{
      const arr = JSON.parse(localStorage.getItem("autus.audit") || "[]");
      arr.push(event);
      localStorage.setItem("autus.audit", JSON.stringify(arr.slice(-300)));
    }catch(e){}
    console.log("[AUTUS_AUDIT]", event);
  }

  function policyEvaluate(model){
    const flags = model?.flags || {};
    const role = model?.role || "SUBJECT";
    const locale = model?.locale || "ko-KR";

    if(role==="INSTITUTION"){
      return { status:"BLOCKED", reason:["ROLE_INSTITUTION_NO_AUTO_APPLY"], grace:0, undo:0, boundary:false, locale };
    }

    const reasons = [];
    if(flags.demo) reasons.push("DEMO_MODE");
    if(flags.offline) reasons.push("OFFLINE");
    if(flags.connecting) reasons.push("CONNECTING");

    const age = model?.snapshot?.ageSeconds;
    if(Number.isFinite(age) && age > 30) reasons.push("SNAPSHOT_STALE");

    const lossM = model?.future?.no_action?.loss_monthly;
    const loss24h = model?.future?.no_action?.loss_24h;
    if(!(Number.isFinite(lossM) || Number.isFinite(loss24h))) reasons.push("FUTURE_NO_ACTION_MISSING");

    const actions = Array.isArray(model?.actions) ? model.actions : [];
    const primaryKey = pickPrimaryAction(model);
    const primary = actions.find(a=>a?.key===primaryKey) || null;

    const confidence = primary?.confidence;
    if(Number.isFinite(confidence) && confidence < 0.70) reasons.push("CONFIDENCE_LOW");

    const lastRun = Number(localStorage.getItem(LS_LAST_RUN) || "0");
    if(lastRun && (nowMs()-lastRun)<AUTO_COOLDOWN_MS) reasons.push("COOLDOWN_ACTIVE");

    if(reasons.length){
      return { status:"BLOCKED", reason:reasons, grace:0, undo:0, boundary:false, locale, primaryKey, confidence };
    }

    const recDelta = primary?.tradeoff?.recovery_delta;
    const boundary = Number.isFinite(recDelta) && recDelta < 0;

    const riskNow = model?.snapshot?.risk_now ?? model?.snapshot?.risk;
    const bVal = model?.bottleneck?.value;
    const high = (Number.isFinite(riskNow) && riskNow>=0.55) || (Number.isFinite(bVal) && bVal>=0.60);

    const grace = boundary ? 5 : 2;
    const undo = 30;

    return { status: high ? "ALLOW" : "ALLOW", reason:[], grace, undo, boundary, locale, primaryKey, confidence, recDelta };
  }

  async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  let graceAbort = { aborted:false };

  async function runAutoApply(model){
    const evalr = policyEvaluate(model);
    if(evalr.status!=="ALLOW") return;

    const enabled = localStorage.getItem(LS_AUTO) === "1";
    if(!enabled) return;

    const actionKey = evalr.primaryKey || pickPrimaryAction(model);
    const btn = findActionButtonByKey(actionKey);
    if(!btn) return;

    const eventBase = {
      event_id: crypto?.randomUUID ? crypto.randomUUID() : String(nowMs()),
      timestamp: new Date().toISOString(),
      actor: { role: model?.role || "SUBJECT", locale: model?.locale || "ko-KR" },
      system: { app:"AUTUS_SOLAR_HQ", kernel_version: model?.kernel_version || "v2.4", ep:"EP10", policy_version:"auto_apply_v1.0" },
      decision_basis: {
        recommended_action: actionKey,
        confidence: evalr.confidence ?? null,
        boundary_state: evalr.boundary,
        tradeoff: evalr.boundary ? { type:"RECOVERY_LOSS", value: evalr.recDelta } : null
      },
      snapshot_ref: {
        snapshot_id: model?.snapshot?.id || null,
        snapshot_hash: model?.snapshot?.hash || null,
        age_seconds: model?.snapshot?.ageSeconds ?? null
      }
    };

    graceAbort = { aborted:false };

    emitAudit({ ...eventBase, event_type:"AUTO_COMMIT_SCHEDULED", grace_seconds: evalr.grace, undo_seconds: evalr.undo });

    setBanner(`ìë™ ì ìš© ì¤‘â€¦ (${evalr.grace}s)`, true);

    for(let i=evalr.grace; i>0; i--){
      if(graceAbort.aborted){ setBanner("ìë™ ì ìš© ì·¨ì†Œë¨", false); emitAudit({ ...eventBase, event_type:"AUTO_COMMIT_CANCELED", cancel:{by:"USER", at_second: (evalr.grace - i)} }); return; }
      setBanner(`ìë™ ì ìš© ì¤‘â€¦ (${i}s)`, true);
      await sleep(1000);
    }

    localStorage.setItem(LS_LAST_RUN, String(nowMs()));
    btn.click();
    emitAudit({ ...eventBase, event_type:"AUTO_COMMIT_EXECUTED", execution:{ action:actionKey, mode:"BEGINNER_AUTO_APPLY", command:"LOCK", immediate:false } });

    showUndo(evalr.undo, eventBase);
  }

  // ---------------------------
  // 5) Beginner Panel DOM (4~6)
  // ---------------------------
  function ensureDecisionUI(){
    let shell = document.getElementById("decision-shell");
    if(shell) return shell;

    shell = document.createElement("div");
    shell.id = "decision-shell";
    shell.className = "decision-shell";
    shell.innerHTML = `
      <div class="decision-panel">
        <div class="row">
          <div class="title">AUTUS Â· Decision</div>
          <div class="row">
            <span id="pill-mode" class="pill ok">BEGINNER</span>
            <button id="btn-expert" class="btn-ghost">ë‹¤ë¥¸ ì „ëµ ë³´ê¸° â–¸</button>
          </div>
        </div>

        <div id="verdict" class="verdict">â€”</div>

        <div class="grid">
          <div class="card">
            <h4>Root Cause</h4>
            <div id="cause" class="v">â€”</div>
            <div id="causeDesc" class="d">â€”</div>
          </div>
          <div class="card">
            <h4>Next Action</h4>
            <div id="action" class="v">â€”</div>
            <div id="actionDesc" class="d">ì¶”ì²œ ì¡°ì¹˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</div>
          </div>
        </div>

        <!-- Mini Compare: 3ê°œ ì•¡ì…˜ ë¹„êµ -->
        <div id="mini-compare"></div>

        <!-- Execute Preview: ì‹¤í–‰ ì‹œ íš¨ê³¼ ìš”ì•½ -->
        <div id="execute-preview" class="sub"></div>

        <div class="actions">
          <button id="btn-primary" class="btn-primary">ì§€ê¸ˆ ì¡°ì¹˜</button>
          <span id="autoPill" class="pill">ìë™: <b id="autoState">OFF</b></span>
          <button id="btn-auto-toggle" class="btn-ghost">í† ê¸€</button>
          <button id="btn-cancel-grace" class="btn-ghost" style="display:none;">ì·¨ì†Œ</button>
        </div>

        <div id="banner" class="sub">â€”</div>
      </div>
    `;
    document.body.appendChild(shell);

    // Expert ëª¨ë“œ ì „í™˜ ë²„íŠ¼
    const expertBtn = document.createElement("button");
    expertBtn.id = "btn-beginner-from-expert";
    expertBtn.textContent = "ê°„í¸ ëª¨ë“œ";
    expertBtn.onclick = () => setViewMode(ViewMode.BEGINNER);
    document.body.appendChild(expertBtn);

    shell.querySelector("#btn-expert").onclick = ()=> setViewMode(ViewMode.EXPERT);

    shell.querySelector("#btn-primary").onclick = async ()=>{
      const model = getAutusModel();
      const key = pickSingleAction(model);
      
      if (!key) {
        setBanner("í˜„ì¬ ì¡°ì¹˜ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤", false);
        return;
      }

      // ğŸ”’ AUDIT ì—°ì¶œ ì‹œì‘
      executeAuditSequence(key);

      // API í˜¸ì¶œ
      const apiBase = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000' 
        : 'https://autus-production.up.railway.app';
      
      try {
        await fetch(`${apiBase}/api/v1/burn/execute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ impulse: key, magnitude: 1.0 })
        });
      } catch (e) {
        console.log('[AUDIT] API offline, local mode');
      }
    };

    shell.querySelector("#btn-auto-toggle").onclick = ()=>{
      const model = getAutusModel();
      const evalr = policyEvaluate(model);

      if(evalr.status==="BLOCKED" && (evalr.reason||[]).includes("ROLE_INSTITUTION_NO_AUTO_APPLY")){
        setBanner("Institution Roleì€ ìë™ ì‹¤í–‰ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤. (ìë™ ê¶Œê³ ë§Œ)", false);
        return;
      }

      const cur = localStorage.getItem(LS_AUTO) === "1";
      const next = !cur;

      if(next && evalr.boundary){
        setBanner("ì£¼ì˜: ì ìš© ì‹œ íšŒë³µ(Recovery)ì´ ê°ì†Œí•  ìˆ˜ ìˆìŒ. (5ì´ˆ ì·¨ì†Œ/30ì´ˆ ë˜ëŒë¦¬ê¸°)", false);
      }

      if(next && evalr.status==="BLOCKED"){
        setBanner(`ìë™ ì‹¤í–‰ ë¶ˆê°€: ${(evalr.reason||[]).join(", ")}`, false);
        localStorage.setItem(LS_AUTO, "0");
        renderDecision();
        return;
      }

      localStorage.setItem(LS_AUTO, next ? "1" : "0");
      renderDecision();
    };

    shell.querySelector("#btn-cancel-grace").onclick = ()=>{
      graceAbort.aborted = true;
    };

    return shell;
  }

  function setBanner(text, warn){
    const el = document.getElementById("banner");
    if(!el) return;
    el.textContent = text;
    el.className = warn ? "sub warn" : "sub";
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Mini Compare (10)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmtKRW(n){
    if(!Number.isFinite(n)) return "â€”";
    const man=Math.round(Math.abs(n)/10000);
    return `â‚©${man}ë§Œ`;
  }

  function buildCompare(actions){
    const order=["RECOVER","DEFRICTION","SHOCK_DAMP"];
    return order.map(k=>{
      const a=actions.find(x=>x.key===k)||{};
      const d=a.deltas||{};
      const t=a.tradeoff||{};
      return {
        key:k,
        money: Number.isFinite(d.money_delta_monthly)? fmtKRW(d.money_delta_monthly):"â€”",
        time: Number.isFinite(d.time_delta_hours)? `${Math.round(Math.abs(d.time_delta_hours)*60)}ë¶„`:"â€”",
        risk: Number.isFinite(d.risk_delta)? `${Math.round(-d.risk_delta*100)}%â†“`:"â€”",
        trade: Number.isFinite(t.recovery_delta)&&t.recovery_delta<0? `âš ï¸ Recovery ${Math.round(t.recovery_delta*100)}%`:"â€”",
        best: a.recommended===true,
        warn: Number.isFinite(t.recovery_delta)&&t.recovery_delta<0
      };
    });
  }

  function renderMiniCompare(model){
    const el=document.getElementById("mini-compare");
    if(!el||!model?.actions) return;
    const rows=buildCompare(model.actions);
    el.innerHTML = rows.map(r=>`
      <div class="mc ${r.best?'best':''} ${r.warn?'warn':''}">
        <h5>${r.key}${r.best?' âœ“':''}</h5>
        <div class="v">ğŸ’° ${r.money}</div>
        <div class="s">â±ï¸ ${r.time} Â· Risk ${r.risk}</div>
        <div class="s">${r.trade}</div>
      </div>
    `).join("");
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Execute Preview (11)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderExecutePreview(model){
    const el=document.getElementById("execute-preview");
    if(!el||!model?.actions) return;

    const a=model.actions.find(x=>x.recommended);
    if(!a) {
      el.innerHTML = "";
      return;
    }

    const d=a.deltas||{};
    const loss24=model.future?.no_action?.loss_24h;

    const riskTxt = Number.isFinite(d.risk_delta)
      ? `Risk ${Math.round(-d.risk_delta*100)}%â†“`
      : "Risk ê°ì†Œ";

    const lossTxt = Number.isFinite(loss24)
      ? `24h ì†ì‹¤ â‚©${Math.round(loss24/10000)}ë§Œ ë°©ì–´`
      : "ì†ì‹¤ ë°©ì–´";

    const recVal = a.tradeoff?.recovery_delta;
    const recTxt = Number.isFinite(recVal)
      ? (recVal >= 0 ? `Recovery +${Math.round(recVal*100)}%` : `Recovery ${Math.round(recVal*100)}%`)
      : "Recovery íšŒë³µ";
    const recClass = Number.isFinite(recVal) && recVal < 0 ? "warn" : "ok";

    el.innerHTML = `
      ì‹¤í–‰ ì‹œ:
      <span class="ok">âœ“ ${riskTxt}</span> Â·
      <span class="ok">âœ“ ${lossTxt}</span> Â·
      <span class="${recClass}">${recVal >= 0 ? 'âœ“' : 'âš ï¸'} ${recTxt}</span>
    `;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”’ AUDIT ì—°ì¶œ (LOCK)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function executeAuditSequence(actionKey) {
    // 1. ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ì¦‰ì‹œ ì •ì§€ (0.3s)
    document.body.classList.add("audit-freeze");
    
    // 2. íŒì • í† í° ë‚™í•˜ + í™”ë©´ ì§„ë™
    setTimeout(() => {
      triggerAuditEffect();
    }, 300);
    
    // 3. AUDIT ìƒì„± í›„ UI ì¹¨ë¬µ
    setTimeout(() => {
      showAuditComplete(actionKey);
    }, 1200);
  }
  
  function triggerAuditEffect() {
    // í™”ë©´ ì§„ë™
    document.body.style.animation = "auditShake 0.1s ease-in-out 3";
    
    // ì§„ë™ ì‚¬ìš´ë“œ (ëª¨ë°”ì¼)
    if (navigator.vibrate) {
      navigator.vibrate([50, 30, 50]);
    }
    
    // í† í° ë‚™í•˜ ì‹œê° íš¨ê³¼
    const token = document.createElement("div");
    token.className = "audit-token";
    token.innerHTML = "â¬¤";
    document.body.appendChild(token);
    
    setTimeout(() => token.remove(), 900);
  }
  
  function showAuditComplete(actionKey) {
    const overlay = document.createElement("div");
    overlay.className = "audit-complete-overlay";
    overlay.innerHTML = `
      <div class="audit-complete-content">
        <div class="audit-icon">âœ“</div>
        <div class="audit-text">AUDIT ì™„ë£Œ</div>
        <div class="audit-action">${actionKey}</div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    // ì¹¨ë¬µ â€” ì¶”ê°€ UI ì—†ìŒ
    setTimeout(() => {
      overlay.remove();
      document.body.classList.remove("audit-freeze");
      location.reload();
    }, 2000);
  }

  function showUndo(seconds, eventBase){
    let remain = seconds;
    const undoId = "autus-undo-btn";

    const panel = document.querySelector(".decision-panel");
    if(!panel) return;

    let btn = document.getElementById(undoId);
    if(!btn){
      btn = document.createElement("button");
      btn.id = undoId;
      btn.className = "btn-ghost";
      btn.textContent = "ë˜ëŒë¦¬ê¸°";
      btn.onclick = ()=>{
        emitAudit({ ...eventBase, event_type:"AUTO_COMMIT_UNDONE", undo:{ within_seconds: (seconds - remain), reason:"USER_REQUEST" } });
        setBanner("ë˜ëŒë¦¬ê¸° ê¸°ë¡ ì™„ë£Œ (ì‹¤ì œ ë˜ëŒë¦¬ê¸° ë¡œì§ì€ Command Busì— ì—°ê²°)", false);
        btn.remove();
      };
      panel.querySelector(".actions").appendChild(btn);
    }

    const timer = setInterval(()=>{
      remain -= 1;
      if(remain<=0){
        clearInterval(timer);
        if(btn && btn.parentNode) btn.remove();
        setBanner("ë˜ëŒë¦¬ê¸° ì°½ ì¢…ë£Œ", false);
        return;
      }
      setBanner(`ì ìš© ì™„ë£Œ â€” ë˜ëŒë¦¬ê¸° ê°€ëŠ¥ (${remain}s)`, false);
    }, 1000);
  }

  function renderDecision(){
    const shell = ensureDecisionUI();
    const model = getAutusModel();

    if(!model){
      shell.querySelector("#verdict").textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.";
      shell.querySelector("#cause").textContent = "â€”";
      shell.querySelector("#causeDesc").textContent = "â€”";
      shell.querySelector("#action").textContent = "â€”";
      shell.querySelector("#autoState").textContent = "OFF";
      setBanner("ëª¨ë¸ ëŒ€ê¸° ì¤‘", false);
      applyViewModeVisibility();
      return;
    }

    const bVal = model?.bottleneck?.value;
    const pct = Number.isFinite(bVal) ? Math.round(bVal*100) : null;

    // (7)(8)(9) í†µí•©ëœ ê°’ ì‚¬ìš©
    const verdict = model.verdict || "ìƒíƒœ ë¶„ì„ ì¤‘...";
    const cause = model.causeLabel || getCauseText(model?.bottleneck?.type, model.locale);
    
    // (9) Action Scoringì—ì„œ ì¶”ì²œëœ ì•¡ì…˜ ì‚¬ìš©
    const actionKey = model.recommendation?.recommendedKey || pickPrimaryAction(model);
    const actionLabel = (actionKey==="SHOCK_DAMP") ? "SHOCK DAMP" : actionKey;

    // State classì— ë”°ë¥¸ verdict ìŠ¤íƒ€ì¼
    const verdictEl = shell.querySelector("#verdict");
    verdictEl.textContent = verdict;
    verdictEl.className = "verdict";
    if (model.stateClass === "DANGER") verdictEl.style.color = "#ff6b6b";
    else if (model.stateClass === "HEALTHY") verdictEl.style.color = "#69db7c";
    else verdictEl.style.color = "#ffd43b";

    shell.querySelector("#cause").textContent = cause;
    shell.querySelector("#causeDesc").textContent = (pct!=null) ? `í˜„ì¬ ë³‘ëª© ê°•ë„: ${pct}%` : "í˜„ì¬ ë³‘ëª© ê°•ë„: â€”";
    shell.querySelector("#action").textContent = actionLabel;

    // Scoring breakdown í‘œì‹œ (ë””ë²„ê·¸ìš©)
    const actionDescEl = shell.querySelector("#actionDesc");
    if (actionDescEl && model.recommendation?.scored) {
      const top = model.recommendation.scored[0];
      if (top) {
        actionDescEl.textContent = `Score: ${top.score.toFixed(2)} | ${model.reason_codes?.join(", ") || ""}`;
      }
    }

    const enabled = localStorage.getItem(LS_AUTO) === "1";
    shell.querySelector("#autoState").textContent = enabled ? "ON" : "OFF";

    // (10) Mini Compare ë Œë”ë§
    renderMiniCompare(model);

    // (11) Execute Preview ë Œë”ë§
    renderExecutePreview(model);

    const evalr = policyEvaluate(model);
    if(evalr.status==="BLOCKED"){
      setBanner(`ìë™ ì‹¤í–‰ ì œí•œ: ${(evalr.reason||[]).join(", ")}`, false);
    }else if(evalr.boundary){
      setBanner("ê²½ê³„ ìƒíƒœ: trade-off ì¡´ì¬ (ìë™ ì‹¤í–‰ì€ ê¸°ë³¸ OFF ê¶Œì¥)", false);
    }else{
      const stateMsg = model.stateClass === "DANGER" ? "âš ï¸ ìœ„í—˜" : model.stateClass === "HEALTHY" ? "âœ“ ì•ˆì •" : "â— ì£¼ì˜";
      setBanner(`${stateMsg} | ê²°ë¡  â†’ ì›ì¸ â†’ ì‹¤í–‰ ìˆœì„œë¡œ ì§„í–‰`, false);
    }

    applyViewModeVisibility();

    runAutoApply(model).catch(()=>{});
  }

  // ---------------------------
  // Boot
  // ---------------------------
  document.addEventListener("DOMContentLoaded", ()=>{
    // URL íŒŒë¼ë¯¸í„°ë¡œ ëª¨ë“œ ì§€ì •
    const params = new URLSearchParams(location.search);
    if(params.get("mode") === "expert") {
      viewMode = ViewMode.EXPERT;
      localStorage.setItem(LS_VIEW, viewMode);
    }
    
    ensureDecisionUI();
    applyViewModeVisibility();
    renderDecision();
  });

  setInterval(()=>{ if(viewMode===ViewMode.BEGINNER) renderDecision(); }, 600);

  window.__AUTUS_SET_VIEWMODE = setViewMode;
})();
</script>

</body>
</html>
