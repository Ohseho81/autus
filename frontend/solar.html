<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AUTUS Solar HQ â€” Physics Kernel v2.4 EP10</title>
  <!--
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  AUTUS SOLAR HQ â€” PHYSICS KERNEL v2.4 (EP10 FULL LOOP)        â•‘
    â•‘                                                               â•‘
    â•‘  v2.4 EP10 CHANGES:                                           â•‘
    â•‘  âœ“ DIGNITY = Quality Ã— Stability âˆ’ Entropy Ã— Friction         â•‘
    â•‘  âœ“ REPUTATION = âˆ’Future Shock Residual                        â•‘
    â•‘  âœ“ FORECAST BRANCH â€” ì„ íƒë³„ ë¯¸ë˜ ë¶„ê¸°                         â•‘
    â•‘  âœ“ ACTION VALUE â€” ğŸ’°Cost â±ï¸Time ğŸ›ï¸Dignity ğŸŒReputation        â•‘
    â•‘  âœ“ "ë¯¸ë˜ë¥¼ ë§íˆëŠ” ê²Œ ì•„ë‹ˆë¼ ë¯¸ë˜ì˜ ì°¨ì´ë¥¼ ë³´ì—¬ì¤€ë‹¤"           â•‘
    â•‘                                                               â•‘
    â•‘  FROZEN LAWS: 4/5/6/7                                         â•‘
    â•‘  FROZEN IMPULSE: RECOVER / DEFRICTION / SHOCK_DAMP            â•‘
    â•‘  USER VALUE: Costâ†“ Timeâ†“ Qualityâ†‘ Reputationâ†‘                 â•‘
    â•‘                                                               â•‘
    â•‘  BUILD: 2025-12-18 v2.4 EP10                                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  -->
  <style>
    :root {
      --bg-primary: #020408;
      --bg-panel: rgba(0,20,40,0.95);
      --border-cyan: rgba(0,212,255,0.25);
      --text-primary: #fff;
      --text-secondary: #888;
      --accent-cyan: #00d4ff;
      --accent-green: #00ff88;
      --accent-orange: #ffaa00;
      --accent-red: #ff4444;
    }
    
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:var(--bg-primary);
      overflow:hidden;
      font-family:'Inter','SF Pro Display',system-ui,sans-serif;
      color:var(--text-primary);
    }
    
    .frame{position:fixed;top:24px;left:24px;right:24px;bottom:24px;border:1px solid var(--border-cyan);border-radius:6px;pointer-events:none;z-index:50}
    .corner{position:absolute;width:14px;height:14px}
    .corner::before,.corner::after{content:'';position:absolute;background:rgba(0,212,255,.4)}
    .corner.tl{top:-1px;left:-1px}.corner.tl::before{width:14px;height:1px}.corner.tl::after{width:1px;height:14px}
    .corner.tr{top:-1px;right:-1px}.corner.tr::before{width:14px;height:1px;right:0}.corner.tr::after{width:1px;height:14px;right:0}
    .corner.bl{bottom:-1px;left:-1px}.corner.bl::before{width:14px;height:1px;bottom:0}.corner.bl::after{width:1px;height:14px;bottom:0}
    .corner.br{bottom:-1px;right:-1px}.corner.br::before{width:14px;height:1px;bottom:0;right:0}.corner.br::after{width:1px;height:14px;bottom:0;right:0}
    
    .system-bar{
      position:fixed;top:0;left:0;right:0;height:24px;
      background:rgba(0,10,20,0.95);
      border-bottom:1px solid rgba(0,212,255,0.15);
      display:flex;justify-content:space-between;align-items:center;
      padding:0 40px;font-size:9px;letter-spacing:0.08em;z-index:300;
    }
    .system-bar .left{display:flex;gap:20px;color:#666}
    .system-bar .right{display:flex;gap:20px;color:var(--accent-cyan)}
    .system-bar .status-dot{width:6px;height:6px;border-radius:50%;margin-right:5px;display:inline-block}
    .system-bar .status-dot.ok{background:var(--accent-green)}
    .system-bar .status-dot.warn{background:var(--accent-orange)}
    
    .gate-container{
      position:fixed;top:32px;left:50%;transform:translateX(-50%);
      display:flex;gap:16px;align-items:center;z-index:200;
    }
    .gate-badge{
      padding:10px 20px;border:2px solid;border-radius:8px;
      font-size:14px;font-weight:700;letter-spacing:.15em;
    }
    .gate-green{background:rgba(0,255,120,.15);color:var(--accent-green);border-color:var(--accent-green)}
    .gate-amber{background:rgba(255,180,0,.15);color:var(--accent-orange);border-color:var(--accent-orange)}
    .gate-red{background:rgba(255,60,60,.15);color:var(--accent-red);border-color:var(--accent-red)}
    
    .kernel-display{
      position:fixed;top:90px;right:40px;width:280px;
      background:var(--bg-panel);border:1px solid rgba(0,255,136,0.4);
      border-radius:8px;padding:16px;z-index:150;
    }
    .kernel-display .title{
      font-size:9px;letter-spacing:0.2em;color:rgba(0,255,136,0.9);
      margin-bottom:14px;padding-bottom:10px;
      border-bottom:1px solid rgba(0,255,136,0.3);
      display:flex;justify-content:space-between;align-items:center;
    }
    .kernel-display .title .version{
      background:rgba(0,255,136,0.2);color:var(--accent-green);
      padding:2px 8px;border-radius:4px;font-size:8px;
    }
    .kernel-section{margin-bottom:14px}
    .kernel-section-title{
      font-size:8px;letter-spacing:0.15em;color:#666;
      margin-bottom:8px;padding-bottom:4px;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .kernel-row{
      display:flex;justify-content:space-between;
      padding:5px 0;font-size:10px;
    }
    .kernel-key{color:var(--text-secondary)}
    .kernel-val{font-family:'SF Mono',monospace;font-weight:600}
    .kernel-val.danger{color:var(--accent-red)}
    .kernel-val.warning{color:var(--accent-orange)}
    .kernel-val.safe{color:var(--accent-green)}
    
    .single-source-badge{
      display:inline-block;padding:2px 6px;margin-left:6px;
      background:rgba(0,212,255,0.15);border:1px solid rgba(0,212,255,0.3);
      border-radius:3px;font-size:7px;color:var(--accent-cyan);
    }
    
    .bottleneck-display{
      margin-top:12px;padding:12px;
      background:rgba(255,68,68,0.1);
      border:1px solid rgba(255,68,68,0.3);
      border-radius:6px;
    }
    .bottleneck-display .bn-label{
      font-size:8px;letter-spacing:0.12em;color:rgba(255,68,68,0.8);
      margin-bottom:8px;display:flex;align-items:center;
    }
    .bottleneck-display .bn-value{
      font-size:16px;font-weight:700;color:var(--accent-red);
      display:flex;justify-content:space-between;align-items:center;
    }
    .bottleneck-display .bn-angle{
      font-size:10px;color:#888;font-weight:400;
    }
    .bottleneck-display .bn-warning{
      margin-top:8px;padding:8px;
      background:rgba(255,68,68,0.15);border-radius:4px;
      font-size:9px;color:var(--accent-red);
    }
    
    #info{position:fixed;top:90px;left:40px;font-size:10px;z-index:95}
    #info h1{font-size:12px;font-weight:600;letter-spacing:.25em;color:var(--accent-cyan);margin-bottom:14px}
    .stat-row{display:flex;justify-content:space-between;width:180px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .stat-label{opacity:.5;font-size:9px}
    .stat-value{color:var(--accent-cyan);font-variant-numeric:tabular-nums;font-weight:500}
    .stat-value.critical{color:var(--accent-red)!important;font-weight:700}
    .stat-value.warning{color:var(--accent-orange)!important}
    
    #planets{position:fixed;top:300px;left:40px;width:180px;z-index:95}
    .panel-title{font-size:8px;letter-spacing:.18em;color:rgba(0,212,255,.6);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(0,212,255,.15)}
    .planet-row{
      display:flex;align-items:center;gap:8px;padding:6px 10px;margin-bottom:4px;
      background:rgba(0,20,40,.5);border:1px solid rgba(0,212,255,.12);border-radius:5px;
      cursor:pointer;transition:all .2s;
    }
    .planet-row:hover{background:rgba(0,212,255,.12);border-color:rgba(0,212,255,.35)}
    .planet-row.bottleneck-active{
      background:rgba(255,68,68,0.15);
      border-color:rgba(255,68,68,0.5);
      box-shadow:0 0 12px rgba(255,68,68,0.3);
    }
    .planet-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
    .planet-name{font-size:9px;flex:1;color:#ccc}
    .planet-val{font-size:10px;font-weight:600;font-family:'SF Mono',monospace}
    
    #twin-state{position:fixed;top:520px;right:40px;width:280px;z-index:100}
    .metric-title{font-size:8px;letter-spacing:.18em;color:rgba(0,212,255,.6);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(0,212,255,.15);display:flex;justify-content:space-between;align-items:center}
    .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .metric-card{background:rgba(0,20,40,.7);border:1px solid rgba(0,212,255,.18);border-radius:6px;padding:10px;text-align:center}
    .metric-value{font-size:20px;font-weight:200;color:var(--accent-cyan)}
    .metric-value.warning{color:var(--accent-orange)}
    .metric-value.danger{color:var(--accent-red)}
    .metric-label{font-size:7px;opacity:.45;margin-top:3px;letter-spacing:.12em}
    
    #layer-action{
      position:fixed;bottom:100px;right:40px;
      display:flex;flex-direction:column;gap:10px;z-index:150;
    }
    .action-btn{
      padding:14px 28px;border-radius:8px;font-size:11px;font-weight:600;
      letter-spacing:.12em;cursor:pointer;transition:all .2s;text-align:center;min-width:200px;
      position:relative;
    }
    .action-btn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 0 20px currentColor}
    .action-btn:disabled{opacity:.25;cursor:not-allowed}
    .action-btn.recover{background:rgba(0,255,136,.15);border:1px solid var(--accent-green);color:var(--accent-green)}
    .action-btn.defriction{background:rgba(68,170,255,.15);border:1px solid #44aaff;color:#44aaff}
    .action-btn.shock-damp{background:rgba(255,170,0,.15);border:1px solid var(--accent-orange);color:var(--accent-orange)}
    .action-btn .btn-cost{
      position:absolute;right:10px;top:50%;transform:translateY(-50%);
      font-size:8px;opacity:0.6;
    }
    .preview-label{font-size:8px;color:#666;text-align:center;margin-top:4px;letter-spacing:.12em}
    
    #action-log{
      position:fixed;right:40px;bottom:280px;width:280px;max-height:120px;
      overflow-y:auto;z-index:150;
      border:1px solid rgba(0,212,255,.2);border-radius:8px;padding:12px;
      background:rgba(0,10,20,.9);font-size:9px;line-height:1.6;
    }
    #action-log .log-title{font-size:8px;letter-spacing:.18em;color:rgba(0,212,255,.7);margin-bottom:8px}
    #action-log .log-item{color:#8ac;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)}
    #action-log .log-item.warning{color:var(--accent-orange)}
    #action-log .log-item.critical{color:var(--accent-red)}
    #action-log .log-item.success{color:var(--accent-green)}
    
    #layer-audit{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.92);backdrop-filter:blur(20px);
      display:none;justify-content:center;align-items:center;
      z-index:500;
    }
    #layer-audit.active{display:flex;animation:auditFadeIn 0.4s ease forwards}
    @keyframes auditFadeIn{from{opacity:0}to{opacity:1}}
    
    .audit-card{
      background:var(--bg-panel);border:2px solid rgba(0,212,255,0.4);
      border-radius:16px;padding:40px 50px;text-align:center;max-width:520px;
      box-shadow:0 0 60px rgba(0,212,255,0.3);
    }
    .audit-card h2{font-size:14px;letter-spacing:0.3em;color:rgba(0,212,255,0.9);margin-bottom:30px}
    
    .audit-summary{
      background:rgba(0,0,0,0.4);border:1px solid rgba(0,212,255,0.15);
      border-radius:10px;padding:20px;margin-bottom:20px;text-align:left;
    }
    .audit-summary .row{
      display:flex;justify-content:space-between;
      padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.06);font-size:12px;
    }
    .audit-summary .row:last-child{border-bottom:none}
    .audit-summary .label{color:#888}
    .audit-summary .value{color:var(--accent-cyan);font-family:'SF Mono',monospace;font-weight:500}
    .audit-summary .value.positive{color:var(--accent-green)}
    .audit-summary .value.negative{color:var(--accent-red)}
    
    .audit-costs{
      background:rgba(255,68,68,0.05);border:1px solid rgba(255,68,68,0.2);
      border-radius:8px;padding:12px;margin-bottom:20px;text-align:left;
    }
    .audit-costs .costs-title{font-size:8px;letter-spacing:0.15em;color:rgba(255,68,68,0.8);margin-bottom:8px}
    .audit-costs .cost-item{
      display:inline-block;padding:4px 10px;margin:2px;
      background:rgba(255,68,68,0.1);border:1px solid rgba(255,68,68,0.3);
      border-radius:4px;font-size:10px;color:var(--accent-red);
    }
    
    .audit-laws{
      background:rgba(0,212,255,0.05);border:1px solid rgba(0,212,255,0.2);
      border-radius:8px;padding:12px;margin-bottom:20px;text-align:left;
    }
    .audit-laws .laws-title{font-size:8px;letter-spacing:0.15em;color:rgba(0,212,255,0.7);margin-bottom:8px}
    .audit-laws .law-tag{
      display:inline-block;padding:4px 10px;margin:2px;
      background:rgba(0,212,255,0.1);border:1px solid rgba(0,212,255,0.3);
      border-radius:4px;font-size:9px;color:var(--accent-cyan);
    }
    
    .audit-buttons{display:flex;gap:15px;justify-content:center}
    .audit-btn{
      padding:16px 35px;border-radius:8px;font-size:13px;font-weight:600;
      letter-spacing:0.12em;cursor:pointer;transition:all 0.2s;
    }
    .audit-btn:hover{transform:scale(1.08)}
    .audit-btn.lock{background:rgba(0,255,136,0.15);border:2px solid var(--accent-green);color:var(--accent-green)}
    .audit-btn.reject{background:rgba(255,68,68,0.15);border:2px solid var(--accent-red);color:var(--accent-red)}
    .audit-btn.hold{background:rgba(255,170,0,0.15);border:2px solid var(--accent-orange);color:var(--accent-orange)}
    
    .audit-timer{font-size:12px;color:#666;margin-top:25px}
    .audit-timer .countdown{font-size:24px;font-weight:200;margin-left:8px}
    
    #controls{
      position:fixed;bottom:40px;right:40px;
      display:flex;gap:8px;z-index:100;
    }
    #controls button{
      padding:10px 16px;background:rgba(0,212,255,.1);
      border:1px solid rgba(0,212,255,.25);color:var(--accent-cyan);
      border-radius:5px;font-size:9px;cursor:pointer;transition:all .2s;
    }
    #controls button:hover{background:rgba(0,212,255,.2)}
    #controls button.active{background:rgba(0,212,255,.25);border-color:var(--accent-cyan)}
    
    .planet-label{
      position:absolute;font-size:10px;color:#fff;
      pointer-events:none;text-shadow:0 0 10px rgba(0,0,0,.95);
      white-space:nowrap;transition:opacity .2s;
    }
    
    .keyboard-hint{
      position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
      font-size:9px;color:#444;letter-spacing:0.1em;z-index:50;
    }
    
    .test-badge{
      position:fixed;bottom:40px;left:40px;
      padding:8px 16px;background:rgba(0,255,136,0.1);
      border:1px solid rgba(0,255,136,0.3);border-radius:6px;
      font-size:9px;color:var(--accent-green);z-index:100;
    }
    .test-badge.fail{background:rgba(255,68,68,0.1);border-color:rgba(255,68,68,0.3);color:var(--accent-red)}
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       EP10: FORECAST BRANCH CARD + VALUE INDICATORS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    #forecast-panel{
      position:fixed;top:90px;left:240px;width:320px;
      background:var(--bg-panel);border:1px solid rgba(138,92,246,0.4);
      border-radius:8px;padding:16px;z-index:150;
    }
    .forecast-title{
      font-size:9px;letter-spacing:0.2em;color:rgba(138,92,246,0.9);
      margin-bottom:14px;padding-bottom:10px;
      border-bottom:1px solid rgba(138,92,246,0.3);
      display:flex;justify-content:space-between;align-items:center;
    }
    .forecast-title .tag{
      background:rgba(138,92,246,0.2);color:#8a5cf6;
      padding:2px 8px;border-radius:4px;font-size:8px;
    }
    .forecast-branch{
      padding:10px 12px;margin-bottom:8px;
      background:rgba(0,0,0,0.3);border-radius:6px;
      border-left:3px solid #666;transition:all 0.2s;
    }
    .forecast-branch.best{border-left-color:var(--accent-green);background:rgba(0,255,136,0.08)}
    .forecast-branch.neutral{border-left-color:var(--accent-orange)}
    .forecast-branch.worst{border-left-color:var(--accent-red);background:rgba(255,68,68,0.05)}
    .forecast-branch .branch-label{
      font-size:9px;letter-spacing:0.1em;color:#888;margin-bottom:6px;
    }
    .forecast-branch .branch-values{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .forecast-branch .value-chip{
      font-size:10px;font-weight:600;padding:2px 6px;
      border-radius:3px;background:rgba(255,255,255,0.05);
    }
    .forecast-branch .value-chip.positive{color:var(--accent-green)}
    .forecast-branch .value-chip.negative{color:var(--accent-red)}
    .forecast-branch .value-chip.neutral{color:var(--accent-orange)}
    
    /* Action Value Indicators */
    .action-btn-wrapper{
      position:relative;margin-bottom:12px;
    }
    .action-btn{
      width:100%;margin-bottom:0;
    }
    .value-indicators{
      display:flex;justify-content:space-around;
      padding:8px 10px;margin-top:-1px;
      background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);
      border-top:none;border-radius:0 0 8px 8px;
      font-size:9px;
    }
    .value-ind{display:flex;align-items:center;gap:3px}
    .value-ind .icon{font-size:10px}
    .value-ind .val{font-weight:600;font-family:'SF Mono',monospace}
    .value-ind .val.up{color:var(--accent-green)}
    .value-ind .val.down{color:var(--accent-red)}
    
    /* Dignity Badge */
    #dignity-display{
      position:fixed;top:32px;left:50%;transform:translateX(calc(-50% + 120px));
      padding:8px 16px;border-radius:6px;
      font-size:11px;font-weight:600;letter-spacing:0.1em;
      z-index:200;transition:all 0.3s;
    }
    #dignity-display.low{background:rgba(255,68,68,0.15);border:1px solid var(--accent-red);color:var(--accent-red)}
    #dignity-display.balanced{background:rgba(255,170,0,0.15);border:1px solid var(--accent-orange);color:var(--accent-orange)}
    #dignity-display.elevated{background:rgba(0,255,136,0.15);border:1px solid var(--accent-green);color:var(--accent-green)}
    
    /* Reputation Status */
    .reputation-status{
      margin-top:8px;padding:8px;
      background:rgba(138,92,246,0.1);border:1px solid rgba(138,92,246,0.3);
      border-radius:4px;font-size:9px;color:#8a5cf6;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PHASE 1: HOVER SIMULATION CARD + CONFIDENCE + PHYSICS REASON
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .hover-sim-card{
      position:absolute;left:calc(100% + 16px);top:0;width:300px;
      background:var(--bg-panel);border:1px solid rgba(0,212,255,0.4);
      border-radius:10px;padding:16px;z-index:300;
      opacity:0;visibility:hidden;transition:all 0.2s ease;
      box-shadow:0 10px 40px rgba(0,0,0,0.5);
    }
    .action-btn-wrapper:hover .hover-sim-card{
      opacity:1;visibility:visible;
    }
    .hover-sim-card .sim-title{
      font-size:10px;letter-spacing:0.15em;color:var(--accent-cyan);
      margin-bottom:12px;padding-bottom:8px;
      border-bottom:1px solid rgba(0,212,255,0.2);
    }
    
    /* BEST/LIKELY/WORST Branches */
    .sim-branch{
      padding:10px;margin-bottom:8px;border-radius:6px;
      background:rgba(0,0,0,0.3);position:relative;
    }
    .sim-branch.best{border-left:3px solid var(--accent-green)}
    .sim-branch.likely{border-left:3px solid var(--accent-cyan)}
    .sim-branch.worst{border-left:3px solid var(--accent-red)}
    .sim-branch .branch-tag{
      position:absolute;top:8px;right:8px;
      font-size:8px;font-weight:700;letter-spacing:0.1em;
      padding:2px 6px;border-radius:3px;
    }
    .sim-branch.best .branch-tag{background:rgba(0,255,136,0.2);color:var(--accent-green)}
    .sim-branch.likely .branch-tag{background:rgba(0,212,255,0.2);color:var(--accent-cyan)}
    .sim-branch.worst .branch-tag{background:rgba(255,68,68,0.2);color:var(--accent-red)}
    .sim-branch .branch-delta{
      font-size:11px;font-weight:600;margin-bottom:4px;
    }
    .sim-branch .branch-metrics{
      font-size:9px;color:#888;
    }
    .sim-branch .branch-metrics span{margin-right:8px}
    
    /* Confidence Bar */
    .confidence-row{
      display:flex;align-items:center;gap:8px;margin-top:4px;
    }
    .confidence-bar{
      flex:1;height:4px;background:rgba(255,255,255,0.1);
      border-radius:2px;overflow:hidden;
    }
    .confidence-fill{
      height:100%;border-radius:2px;transition:width 0.3s;
    }
    .confidence-fill.high{background:var(--accent-green)}
    .confidence-fill.mid{background:var(--accent-cyan)}
    .confidence-fill.low{background:var(--accent-red)}
    .confidence-pct{
      font-size:9px;font-weight:600;min-width:32px;text-align:right;
    }
    
    /* Physics Reason */
    .physics-reason{
      margin-top:12px;padding:10px;
      background:rgba(255,170,0,0.08);border:1px solid rgba(255,170,0,0.25);
      border-radius:6px;font-size:9px;line-height:1.5;
    }
    .physics-reason .reason-icon{margin-right:6px}
    .physics-reason .reason-text{color:var(--accent-orange)}
    
    /* Recommended Badge */
    .recommended-badge{
      position:absolute;top:-8px;right:-8px;
      background:var(--accent-green);color:#000;
      font-size:8px;font-weight:700;letter-spacing:0.1em;
      padding:3px 8px;border-radius:10px;
      animation:pulse-badge 2s infinite;
    }
    @keyframes pulse-badge{
      0%,100%{box-shadow:0 0 0 0 rgba(0,255,136,0.4)}
      50%{box-shadow:0 0 0 8px rgba(0,255,136,0)}
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
  </div>
  
  <div class="system-bar">
    <div class="left">
      <span><span class="status-dot ok"></span>KERNEL v2.4 EP10</span>
      <span><span class="status-dot ok"></span>SINGLE SOURCE</span>
      <span><span class="status-dot ok"></span>FUTURE VALUE</span>
    </div>
    <div class="right">
      <span>FPS: <span id="sys-fps">60</span></span>
      <span id="sys-time"></span>
    </div>
  </div>
  
  <div class="gate-container">
    <div id="gate-badge" class="gate-badge gate-amber">GATE: AMBER</div>
  </div>
  
  <div id="dignity-display" class="balanced">DIGNITY: BALANCED</div>
  
  <!-- EP10: FORECAST BRANCH PANEL -->
  <div id="forecast-panel">
    <div class="forecast-title">
      <span>FUTURE BRANCH</span>
      <span class="tag">Î”t +1h</span>
    </div>
    <div class="forecast-branch best" id="fc-best">
      <div class="branch-label">IF SHOCK DAMP:</div>
      <div class="branch-values">
        <span class="value-chip positive">ğŸ’° Cost âˆ’32%</span>
        <span class="value-chip positive">â±ï¸ Time âˆ’18%</span>
        <span class="value-chip positive">ğŸŒ Rep +0.6Ïƒ</span>
      </div>
    </div>
    <div class="forecast-branch neutral" id="fc-mid">
      <div class="branch-label">IF RECOVER:</div>
      <div class="branch-values">
        <span class="value-chip positive">ğŸ›ï¸ Quality +21%</span>
        <span class="value-chip positive">âš ï¸ Risk âˆ’9%</span>
        <span class="value-chip neutral">â±ï¸ Time âˆ’5%</span>
      </div>
    </div>
    <div class="forecast-branch worst" id="fc-worst">
      <div class="branch-label">IF NO ACTION:</div>
      <div class="branch-values">
        <span class="value-chip negative">ğŸ“ˆ Entropy +14%</span>
        <span class="value-chip negative">âš ï¸ Shock ì§€ì†</span>
        <span class="value-chip negative">ğŸŒ Rep âˆ’0.3Ïƒ</span>
      </div>
    </div>
    <div class="reputation-status" id="rep-status">ğŸŒ External Perception: Volatile</div>
  </div>
  
  <div class="kernel-display">
    <div class="title">
      <span>PHYSICS KERNEL</span>
      <span class="version">v2.4 EP10</span>
    </div>
    
    <div class="kernel-section">
      <div class="kernel-section-title">RING PHYSICS <span class="single-source-badge">SINGLE SOURCE</span></div>
      <div class="kernel-row"><span class="kernel-key">radiusScale</span><span class="kernel-val" id="pf-radius">1.00</span></div>
      <div class="kernel-row"><span class="kernel-key">thickness</span><span class="kernel-val" id="pf-thick">0.15</span></div>
      <div class="kernel-row"><span class="kernel-key">pulseHz</span><span class="kernel-val" id="pf-pulse">0.50</span></div>
      <div class="kernel-row"><span class="kernel-key">asymStrength</span><span class="kernel-val" id="pf-asym">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">asymAngle</span><span class="kernel-val" id="pf-angle">0Â°</span></div>
    </div>
    
    <div class="kernel-section">
      <div class="kernel-section-title">SNAPSHOT <span class="single-source-badge">SINGLE SOURCE</span></div>
      <div class="kernel-row"><span class="kernel-key">risk</span><span class="kernel-val" id="snap-risk">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">entropy</span><span class="kernel-val" id="snap-entropy">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">pressure</span><span class="kernel-val" id="snap-pressure">0.00</span></div>
      <div class="kernel-row"><span class="kernel-key">flow</span><span class="kernel-val" id="snap-flow">0.00</span></div>
    </div>
    
    <div class="bottleneck-display">
      <div class="bn-label">â–¼ BOTTLENECK <span class="single-source-badge">SINGLE SOURCE</span></div>
      <div class="bn-value">
        <span id="bn-axis">â€”</span>
        <span class="bn-angle" id="bn-angle">0Â°</span>
      </div>
      <div class="bn-warning" id="bn-warning">âš ï¸ â€” bottleneck detected</div>
    </div>
  </div>
  
  <div id="info">
    <h1>SOLAR HQ Â· EP10</h1>
    <div class="stat-row"><span class="stat-label">KERNEL</span><span class="stat-value">v2.4 EP10</span></div>
    <div class="stat-row"><span class="stat-label">LAWS</span><span class="stat-value">4/5/6/7 âœ“</span></div>
    <div class="stat-row"><span class="stat-label">VALUE</span><span class="stat-value">ğŸ’°â±ï¸ğŸ›ï¸ğŸŒ</span></div>
    <div class="stat-row"><span class="stat-label">SINGLE SRC</span><span class="stat-value">âœ“ LOCKED</span></div>
    <div class="stat-row"><span class="stat-label">STATUS</span><span class="stat-value" id="s-status">STABLE</span></div>
  </div>
  
  <div id="planets">
    <div class="panel-title">9 PLANETS Â· TwinState</div>
    <div id="planet-list"></div>
  </div>
  
  <div id="twin-state">
    <div class="metric-title">
      <span>DERIVED STATE</span>
      <span class="single-source-badge">FROM SNAPSHOT</span>
    </div>
    <div class="metric-grid">
      <div class="metric-card"><div class="metric-value" id="m-entropy">0.00</div><div class="metric-label">ENTROPY</div></div>
      <div class="metric-card"><div class="metric-value" id="m-pressure">0.00</div><div class="metric-label">PRESSURE</div></div>
      <div class="metric-card"><div class="metric-value" id="m-risk">0.00</div><div class="metric-label">RISK</div></div>
      <div class="metric-card"><div class="metric-value" id="m-flow">0.00</div><div class="metric-label">FLOW</div></div>
    </div>
  </div>
  
  <div id="action-log">
    <div class="log-title">ACTION LOG</div>
    <div id="log-items"></div>
  </div>
  
  <div id="layer-action">
    <div class="action-btn-wrapper" id="wrapper-recover">
      <button class="action-btn recover" onclick="previewAction('recover')">RECOVER</button>
      <div class="value-indicators" id="vi-recover">
        <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val down">âˆ’8%</span></span>
        <span class="value-ind"><span class="icon">â±ï¸</span><span class="val down">âˆ’5%</span></span>
        <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val up">+0.2</span></span>
        <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val up">+0.1Ïƒ</span></span>
      </div>
      <div class="hover-sim-card" id="sim-recover"></div>
    </div>
    <div class="action-btn-wrapper" id="wrapper-defriction">
      <button class="action-btn defriction" onclick="previewAction('defriction')">DEFRICTION</button>
      <div class="value-indicators" id="vi-defriction">
        <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val down">âˆ’12%</span></span>
        <span class="value-ind"><span class="icon">â±ï¸</span><span class="val down">âˆ’10%</span></span>
        <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val">+0.1</span></span>
        <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val up">+0.2Ïƒ</span></span>
      </div>
      <div class="hover-sim-card" id="sim-defriction"></div>
    </div>
    <div class="action-btn-wrapper" id="wrapper-shock_damp">
      <button class="action-btn shock-damp" onclick="previewAction('shock_damp')">SHOCK DAMP</button>
      <div class="value-indicators" id="vi-shock_damp">
        <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val down">âˆ’32%</span></span>
        <span class="value-ind"><span class="icon">â±ï¸</span><span class="val down">âˆ’18%</span></span>
        <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val up">+0.3</span></span>
        <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val up">+0.6Ïƒ</span></span>
      </div>
      <div class="hover-sim-card" id="sim-shock_damp"></div>
    </div>
    <div class="preview-label">â–² ë¯¸ë˜ ê°€ì¹˜ ìƒì„±ê¸° Â· HOVERë¡œ ì‹œë®¬ë ˆì´ì…˜ Â· CLICKìœ¼ë¡œ AUDIT</div>
  </div>
  
  <div id="layer-audit">
    <div class="audit-card">
      <h2>AUDIT Â· PHYSICS VERIFICATION</h2>
      <div class="audit-summary">
        <div class="row"><span class="label">Impulse</span><span class="value" id="audit-action">RECOVER</span></div>
        <div class="row"><span class="label">Î” Risk</span><span class="value" id="audit-risk">0% â†’ 0%</span></div>
        <div class="row"><span class="label">Î” Bottleneck</span><span class="value" id="audit-bn">â€” â†’ â€”</span></div>
        <div class="row"><span class="label">Confidence</span><span class="value" id="audit-conf">0%</span></div>
      </div>
      <div class="audit-costs">
        <div class="costs-title">âš ï¸ TRADE-OFF COSTS</div>
        <div id="audit-costs-list"></div>
      </div>
      <div class="audit-laws">
        <div class="laws-title">LAWS APPLIED</div>
        <span class="law-tag">Law 4: Shockâ†’Asym</span>
        <span class="law-tag">Law 5: Riskâ†’Radius</span>
        <span class="law-tag">Law 6: Entropyâ†’Pulse</span>
        <span class="law-tag">Law 7: Ï„-Transition</span>
      </div>
      <div class="audit-buttons">
        <button class="audit-btn lock" onclick="auditDecision('LOCK')">LOCK</button>
        <button class="audit-btn hold" onclick="auditDecision('HOLD')">HOLD</button>
        <button class="audit-btn reject" onclick="auditDecision('REJECT')">REJECT</button>
      </div>
      <div class="audit-timer">Auto-reject in <span id="audit-countdown" class="countdown">30</span>s</div>
    </div>
  </div>
  
  <div id="controls">
    <button onclick="togglePlanets()" class="active">PLANETS</button>
    <button onclick="toggleOrbits()">ORBITS</button>
    <button onclick="runAcceptanceTests()">RUN TESTS</button>
  </div>
  
  <div class="test-badge" id="test-badge">TESTS: â€”</div>
  
  <div class="keyboard-hint">[ESC] Close Â· [R] Reset Â· [T] Run Tests</div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTUS PHYSICS KERNEL v2.4 â€” EP10 FULL LOOP
   
   "AutusëŠ” ë¯¸ë˜ë¥¼ ë§íˆëŠ” ì‹œìŠ¤í…œì´ ì•„ë‹ˆë¼,
    ì‚¬ëŒì´ ë” í’ˆìœ„ ìˆëŠ” ì„ íƒì„ í•˜ë„ë¡
    ë¯¸ë˜ì˜ ì°¨ì´ë¥¼ ë³´ì—¬ì£¼ëŠ” ì‹œìŠ¤í…œì´ë‹¤."
   
   EP10 CHANGES:
   1. DIGNITY = Quality Ã— Stability âˆ’ Entropy Ã— Friction
   2. REPUTATION = âˆ’Future Shock Residual
   3. FORECAST BRANCH â€” ì„ íƒë³„ ë¯¸ë˜ ë¶„ê¸° í‘œì‹œ
   4. ACTION VALUE â€” ğŸ’°Cost â±ï¸Time ğŸ›ï¸Dignity ğŸŒReputation
   5. USER VALUE MAPPING:
      - ì›ê°€ ì ˆê° â†’ Entropyâ†“ + Frictionâ†“
      - ì‹œê°„ ì ˆê° â†’ Timeâ†“ + Pressureâ†“
      - í’ˆìœ„ ìƒìŠ¹ â†’ Qualityâ†‘ + Stabilityâ†‘
      - ëª…ì„± ì¦ê°€ â†’ Outputâ†‘ + Shockâ†“
   
   SINGLE SOURCE PIPELINE:
   TwinState â†’ computeDerived() â†’ PhysicsFrame.snapshot (+ dignity, reputation)
                                â†’ PhysicsFrame.actionValues (per action)
                                â†’ FORECAST BRANCH UI
                                â†’ VALUE INDICATORS UI
   
   BUILD: 2025-12-18 v2.4 EP10
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHYSICS CONSTANTS â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PHYSICS = Object.freeze({
  RISK_COMPRESSION: 0.65,
  BASE_RADIUS: 8.0,
  PRESSURE_MULT: 1.2,
  BASE_THICKNESS: 0.15,
  ENTROPY_MULT: 2.0,
  BASE_PULSE: 0.5,
  SHOCK_ASYM: 0.95,
});

const TAU = Object.freeze({
  radiusScale: 0.8, thickness: 0.6, pulseHz: 0.4, asymStrength: 0.7, asymAngle: 0.9,
});

const BOTTLENECK_WEIGHTS = Object.freeze({
  RECOVERY: 0.20, STABILITY: 0.15, COHESION: 0.10,
  SHOCK: 0.25, FRICTION: 0.15, TRANSFER: 0.05,
  TIME: 0.05, QUALITY: 0.03, OUTPUT: 0.02,
});

const BOTTLENECK_ANGLES = Object.freeze({
  RECOVERY: 0, STABILITY: Math.PI*0.25, COHESION: Math.PI*0.50,
  SHOCK: Math.PI*1.25, FRICTION: Math.PI*0.75, TRANSFER: Math.PI*1.50,
  TIME: Math.PI*1.75, QUALITY: Math.PI, OUTPUT: Math.PI*0.125,
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPULSE PROFILES â€” FROZEN (v1.0)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IMPULSE_PROFILES = Object.freeze({
  recover: {
    name: 'RECOVER', description: 'ì—ë„ˆì§€ ì¬ë¶„ë°°',
    delta: { RECOVERY: +0.15, STABILITY: +0.06, COHESION: +0.04, TRANSFER: -0.06, OUTPUT: -0.04, TIME: +0.03 },
    bottleneckBonus: { axes: ['SHOCK', 'FRICTION'], delta: { SHOCK: -0.05, FRICTION: -0.05 } },
    confidence: 87, costs: ['TRAâ†“6%', 'OUTâ†“4%', 'TIMâ†‘3%']
  },
  defriction: {
    name: 'DEFRICTION', description: 'ë§ˆì°° ê°ì†Œ',
    delta: { FRICTION: -0.18, SHOCK: -0.07, TRANSFER: +0.06, TIME: -0.05, QUALITY: -0.04, OUTPUT: -0.03 },
    bottleneckBonus: { axes: ['FRICTION'], delta: { FRICTION: -0.04 } },
    confidence: 82, costs: ['QUAâ†“4%', 'OUTâ†“3%']
  },
  shock_damp: {
    name: 'SHOCK_DAMP', description: 'ì¶©ê²© ê°ì‡ ',
    delta: { SHOCK: -0.25, STABILITY: +0.08, COHESION: +0.05, RECOVERY: -0.10, TIME: +0.04, OUTPUT: -0.05, FRICTION: -0.03 },
    bottleneckBonus: { axes: ['SHOCK'], delta: { SHOCK: -0.05 } },
    confidence: 91, costs: ['RECâ†“10%', 'TIMâ†‘4%', 'OUTâ†“5%']
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLANETS CONFIG â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLANETS = Object.freeze([
  { key: 'RECOVERY',  name: 'Recovery',  icon: 'ğŸ”§', color: 0x44ff44, size: 0.14, orbit: 5.4, speed: 0.50, positive: true },
  { key: 'STABILITY', name: 'Stability', icon: 'ğŸ¯', color: 0x8844ff, size: 0.20, orbit: 4.4, speed: 0.35, positive: true, rings: true },
  { key: 'COHESION',  name: 'Cohesion',  icon: 'ğŸ”—', color: 0xff44aa, size: 0.13, orbit: 4.9, speed: 0.60, positive: true },
  { key: 'SHOCK',     name: 'Shock',     icon: 'âš ï¸', color: 0xff8800, size: 0.19, orbit: 6.4, speed: 0.30, positive: false },
  { key: 'FRICTION',  name: 'Friction',  icon: 'âš¡', color: 0xff4444, size: 0.16, orbit: 3.9, speed: 0.45, positive: false },
  { key: 'TRANSFER',  name: 'Transfer',  icon: 'ğŸ“¡', color: 0x44aaff, size: 0.12, orbit: 5.9, speed: 0.75, positive: true, rings: true },
  { key: 'TIME',      name: 'Time',      icon: 'â±ï¸', color: 0xffaa00, size: 0.14, orbit: 3.4, speed: 0.85, positive: false },
  { key: 'QUALITY',   name: 'Quality',   icon: 'ğŸ›¡ï¸', color: 0x00d4ff, size: 0.15, orbit: 2.9, speed: 0.55, positive: true, rings: true },
  { key: 'OUTPUT',    name: 'Output',    icon: 'ğŸ”¥', color: 0x00ff88, size: 0.18, orbit: 2.4, speed: 0.70, positive: true }
]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE â€” SINGLE SOURCE OF TRUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TwinState = {
  RECOVERY: 0.42, STABILITY: 0.55, COHESION: 0.62,
  SHOCK: 0.72, FRICTION: 0.79, TRANSFER: 0.60,
  TIME: 0.50, QUALITY: 0.68, OUTPUT: 0.55
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PhysicsFrame â€” THE SINGLE SOURCE FOR ALL UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PhysicsFrame = {
  // SNAPSHOT: All UI derived values come from here (SINGLE SOURCE)
  // EP10: Added dignity, reputation for user value calculation
  snapshot: { risk: 0, entropy: 0, pressure: 0, flow: 0, dignity: 0, reputation: 0 },
  
  // BOTTLENECK: All bottleneck displays read from here (SINGLE SOURCE)
  bottleneck: { axis: 'FRICTION', value: 0.79, angle: BOTTLENECK_ANGLES.FRICTION, badness: 0 },
  
  // RING: Ring physics values
  ring: {
    radiusScale: 1.0, thickness: 0.15, pulseHz: 0.5, asymStrength: 0.0, asymAngle: 0.0,
    targetRadiusScale: 1.0, targetThickness: 0.15, targetPulseHz: 0.5, targetAsymStrength: 0.0, targetAsymAngle: 0.0
  },
  
  // PREVIEW: Separate snapshot for preview mode
  preview: {
    active: false,
    snapshot: { risk: 0, entropy: 0, pressure: 0, flow: 0, dignity: 0, reputation: 0 },
    bottleneck: { axis: 'FRICTION', value: 0, angle: 0 },
    ring: { radiusScale: 1.0, thickness: 0.15, pulseHz: 0.5, asymStrength: 0.0, asymAngle: 0.0 }
  },
  
  // EP10: ACTION VALUE CACHE â€” Cost/Time/Dignity/Reputation per action
  actionValues: {
    recover: { cost: 0, time: 0, dignity: 0, reputation: 0 },
    defriction: { cost: 0, time: 0, dignity: 0, reputation: 0 },
    shock_damp: { cost: 0, time: 0, dignity: 0, reputation: 0 },
    no_action: { cost: 0, time: 0, dignity: 0, reputation: 0 }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE FUNCTIONS â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clamp(v, min = 0, max = 1) { return Math.max(min, Math.min(max, v)); }
function lerpTau(current, target, tau, dt) { return current + (target - current) * (1 - Math.exp(-dt / tau)); }

// Compute derived values from any state object
// EP10: Added dignity and reputation calculations
function computeDerived(state) {
  const entropy = clamp(0.30*state.SHOCK + 0.25*state.FRICTION + 0.20*state.TIME + 0.25*(1-state.COHESION));
  const pressure = clamp(0.35*state.SHOCK + 0.35*state.FRICTION + 0.30*(1-state.RECOVERY));
  
  // EP10: DIGNITY = Quality Ã— Stability âˆ’ Entropy Ã— Friction
  const dignity = clamp(state.QUALITY * state.STABILITY - entropy * state.FRICTION, -1, 1);
  
  // EP10: REPUTATION = âˆ’Future Shock Residual (higher shock = lower reputation)
  const reputation = clamp(1 - state.SHOCK - 0.3 * state.FRICTION, -1, 1);
  
  return {
    risk: clamp(
      BOTTLENECK_WEIGHTS.RECOVERY * (1 - state.RECOVERY) +
      BOTTLENECK_WEIGHTS.STABILITY * (1 - state.STABILITY) +
      BOTTLENECK_WEIGHTS.COHESION * (1 - state.COHESION) +
      BOTTLENECK_WEIGHTS.SHOCK * state.SHOCK +
      BOTTLENECK_WEIGHTS.FRICTION * state.FRICTION +
      BOTTLENECK_WEIGHTS.TRANSFER * (1 - state.TRANSFER) +
      BOTTLENECK_WEIGHTS.TIME * state.TIME +
      BOTTLENECK_WEIGHTS.QUALITY * (1 - state.QUALITY) +
      BOTTLENECK_WEIGHTS.OUTPUT * (1 - state.OUTPUT)
    ),
    entropy,
    pressure,
    flow: clamp(0.40*state.TRANSFER + 0.30*(1-state.FRICTION) + 0.30*(1-state.TIME)),
    dignity,
    reputation
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: COMPUTE ACTION VALUE â€” Cost/Time/Dignity/Reputation for each action
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeActionValue(currentState, currentDerived, actionKey) {
  if (actionKey === 'no_action') {
    // NO ACTION: things get worse
    return {
      cost: Math.round(currentDerived.entropy * 20),      // Cost increases with entropy
      time: Math.round(currentDerived.pressure * 15),     // Time increases with pressure
      dignity: -0.1,                                       // Dignity decreases
      reputation: -(currentState.SHOCK * 0.5).toFixed(1)  // Reputation drops with shock
    };
  }
  
  const futureState = applyImpulse(currentState, actionKey);
  const futureDerived = computeDerived(futureState);
  
  // Calculate deltas (positive = improvement)
  const deltaEntropy = currentDerived.entropy - futureDerived.entropy;
  const deltaFriction = currentState.FRICTION - futureState.FRICTION;
  const deltaTime = currentState.TIME - futureState.TIME;
  const deltaPressure = currentDerived.pressure - futureDerived.pressure;
  const deltaShock = currentState.SHOCK - futureState.SHOCK;
  
  // EP10 Value Mapping:
  // Cost â†“ = Entropy â†“ + Friction â†“
  // Time â†“ = Time â†“ + Pressure â†“
  // Dignity = Quality Ã— Stability âˆ’ Entropy Ã— Friction (delta)
  // Reputation = âˆ’Future Shock Residual (delta)
  
  const costDelta = Math.round((deltaEntropy + deltaFriction) * 50);
  const timeDelta = Math.round((deltaTime + deltaPressure) * 40);
  const dignityDelta = (futureDerived.dignity - currentDerived.dignity).toFixed(1);
  const repDelta = ((futureDerived.reputation - currentDerived.reputation) * 1.5).toFixed(1);
  
  return {
    cost: costDelta,
    time: timeDelta,
    dignity: parseFloat(dignityDelta),
    reputation: parseFloat(repDelta)
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHASE 1: FUTURE BRANCH SIMULATION â€” BEST / LIKELY / WORST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function simulateFutureBranches(actionKey) {
  const profile = IMPULSE_PROFILES[actionKey];
  if (!profile) return null;
  
  const currentDerived = computeDerived(TwinState);
  const futureState = applyImpulse(TwinState, actionKey);
  const futureDerived = computeDerived(futureState);
  
  // BEST scenario: 120% effectiveness
  const bestState = { ...TwinState };
  for (const key in profile.delta) {
    if (bestState.hasOwnProperty(key)) bestState[key] = clamp(bestState[key] + profile.delta[key] * 1.2);
  }
  const bestDerived = computeDerived(bestState);
  
  // LIKELY scenario: 100% effectiveness (normal)
  const likelyDerived = futureDerived;
  
  // WORST scenario: 50% effectiveness + entropy spike
  const worstState = { ...TwinState };
  for (const key in profile.delta) {
    if (worstState.hasOwnProperty(key)) worstState[key] = clamp(worstState[key] + profile.delta[key] * 0.5);
  }
  worstState.SHOCK = clamp(worstState.SHOCK + 0.05); // Small entropy spike
  const worstDerived = computeDerived(worstState);
  
  return {
    best: {
      recovery: Math.round((bestState.RECOVERY - TwinState.RECOVERY) * 100),
      risk: Math.round((currentDerived.risk - bestDerived.risk) * 100),
      entropy: Math.round((currentDerived.entropy - bestDerived.entropy) * 100),
      confidence: profile.confidence + 5
    },
    likely: {
      recovery: Math.round((futureState.RECOVERY - TwinState.RECOVERY) * 100),
      risk: Math.round((currentDerived.risk - likelyDerived.risk) * 100),
      entropy: Math.round((currentDerived.entropy - likelyDerived.entropy) * 100),
      confidence: profile.confidence
    },
    worst: {
      recovery: Math.round((worstState.RECOVERY - TwinState.RECOVERY) * 100),
      risk: Math.round((currentDerived.risk - worstDerived.risk) * -100),
      entropy: Math.round((worstDerived.entropy - currentDerived.entropy) * 100),
      confidence: Math.max(5, profile.confidence - 60)
    }
  };
}

// Generate physics-based reason for action recommendation
function generatePhysicsReason(actionKey) {
  const bn = PhysicsFrame.bottleneck;
  const snap = PhysicsFrame.snapshot;
  const recovery = TwinState.RECOVERY;
  const shock = TwinState.SHOCK;
  const friction = TwinState.FRICTION;
  
  const reasons = {
    recover: () => {
      if (recovery < 0.5) return `Recovery ${Math.round(recovery*100)}% < Critical(50%). ë³µêµ¬ ì—†ì´ ì‹œìŠ¤í…œ ë¶•ê´´ ê°€ì†.`;
      if (snap.entropy > 0.6) return `Entropy ${snap.entropy.toFixed(2)} ë†’ìŒ. Recoveryë¡œ ì•ˆì •í™” í•„ìš”.`;
      return `Recovery í™•ë³´ë¡œ ì „ì²´ Risk ${Math.round(snap.risk*100)}% ê°ì†Œ ê°€ëŠ¥.`;
    },
    defriction: () => {
      if (friction > 0.7) return `Friction ${Math.round(friction*100)}% ë³‘ëª©. ë§ˆì°° ì œê±°ë¡œ Flow ê°œì„ .`;
      if (snap.pressure > 0.6) return `Pressure ${snap.pressure.toFixed(2)} ê³¼ë‹¤. Defrictionìœ¼ë¡œ í•´ì†Œ.`;
      return `ë§ˆì°° ê°ì†Œë¡œ Time/Cost ì ˆê° íš¨ê³¼.`;
    },
    shock_damp: () => {
      if (shock > 0.7) return `Shock ${Math.round(shock*100)}% ìœ„í—˜. ì¦‰ì‹œ ê°ì‡  í•„ìš”.`;
      if (bn.axis === 'SHOCK') return `SHOCKì´ í˜„ì¬ ë³‘ëª©. ê°ì‡  ì‹œ ì „ì²´ ì•ˆì •í™”.`;
      return `ì¶©ê²© ê°ì‡ ë¡œ Reputation ë³´í˜¸ ë° ë¯¸ë˜ ìœ„í—˜ ì°¨ë‹¨.`;
    }
  };
  
  return reasons[actionKey] ? reasons[actionKey]() : '';
}

// Rank actions by physics score
function rankActions() {
  const snap = PhysicsFrame.snapshot;
  const bn = PhysicsFrame.bottleneck;
  const recovery = TwinState.RECOVERY;
  
  const scores = {
    recover: 0,
    defriction: 0,
    shock_damp: 0
  };
  
  // Recovery urgency
  if (recovery < 0.5) scores.recover += 30;
  if (recovery < 0.4) scores.recover += 20;
  
  // Bottleneck alignment
  if (bn.axis === 'SHOCK') scores.shock_damp += 25;
  if (bn.axis === 'FRICTION') scores.defriction += 25;
  if (bn.axis === 'RECOVERY') scores.recover += 25;
  
  // Risk mitigation
  scores.shock_damp += snap.risk * 20;
  scores.recover += snap.entropy * 15;
  scores.defriction += snap.pressure * 15;
  
  // Reputation protection
  if (TwinState.SHOCK > 0.7) scores.shock_damp += 20;
  
  return Object.entries(scores)
    .sort((a, b) => b[1] - a[1])
    .map(([action, score], idx) => ({ action, score, rank: idx + 1 }));
}

// Update hover simulation cards
function updateHoverSimCards() {
  const ranked = rankActions();
  const topAction = ranked[0].action;
  
  ['recover', 'defriction', 'shock_damp'].forEach(key => {
    const sim = simulateFutureBranches(key);
    const reason = generatePhysicsReason(key);
    const isTop = key === topAction;
    const el = document.getElementById(`sim-${key}`);
    if (!el || !sim) return;
    
    const profile = IMPULSE_PROFILES[key];
    
    el.innerHTML = `
      ${isTop ? '<div class="recommended-badge">ğŸ¯ RECOMMENDED</div>' : ''}
      <div class="sim-title">${profile.name} ì„ íƒ ì‹œ ì˜ˆì¸¡</div>
      
      <div class="sim-branch best">
        <span class="branch-tag">BEST</span>
        <div class="branch-delta">Recovery ${sim.best.recovery > 0 ? '+' : ''}${sim.best.recovery}% | Risk âˆ’${sim.best.risk}%</div>
        <div class="branch-metrics">
          <span>Entropy â†“${sim.best.entropy}%</span>
        </div>
        <div class="confidence-row">
          <div class="confidence-bar"><div class="confidence-fill high" style="width:${sim.best.confidence}%"></div></div>
          <span class="confidence-pct">${sim.best.confidence}%</span>
        </div>
      </div>
      
      <div class="sim-branch likely">
        <span class="branch-tag">LIKELY</span>
        <div class="branch-delta">Recovery ${sim.likely.recovery > 0 ? '+' : ''}${sim.likely.recovery}% | Risk âˆ’${sim.likely.risk}%</div>
        <div class="branch-metrics">
          <span>Entropy â†“${sim.likely.entropy}%</span>
        </div>
        <div class="confidence-row">
          <div class="confidence-bar"><div class="confidence-fill mid" style="width:${sim.likely.confidence}%"></div></div>
          <span class="confidence-pct">${sim.likely.confidence}%</span>
        </div>
      </div>
      
      <div class="sim-branch worst">
        <span class="branch-tag">WORST</span>
        <div class="branch-delta">Recovery ${sim.worst.recovery > 0 ? '+' : ''}${sim.worst.recovery}% | Risk +${sim.worst.risk}%</div>
        <div class="branch-metrics">
          <span>Entropy â†‘${sim.worst.entropy}%</span>
        </div>
        <div class="confidence-row">
          <div class="confidence-bar"><div class="confidence-fill low" style="width:${sim.worst.confidence}%"></div></div>
          <span class="confidence-pct">${sim.worst.confidence}%</span>
        </div>
      </div>
      
      <div class="physics-reason">
        <span class="reason-icon">ğŸ’¡</span>
        <span class="reason-text">${reason}</span>
      </div>
    `;
  });
}

// Compute bottleneck from any state object
function computeBottleneckFrom(state) {
  let maxBadness = -1, maxAxis = 'RECOVERY';
  PLANETS.forEach(p => {
    const value = state[p.key] || 0.5;
    const badness = p.positive ? (1 - value) : value;
    const weighted = BOTTLENECK_WEIGHTS[p.key] * badness;
    if (weighted > maxBadness) { maxBadness = weighted; maxAxis = p.key; }
  });
  return { axis: maxAxis, value: state[maxAxis] || 0.5, angle: BOTTLENECK_ANGLES[maxAxis], badness: maxBadness };
}

// Compute ring targets from derived and state
function computeRingTargets(derived, state, bottleneck) {
  return {
    targetRadiusScale: clamp(1.0 - PHYSICS.RISK_COMPRESSION * derived.risk, 0.25, 1.0),
    targetThickness: PHYSICS.BASE_THICKNESS * (1 + PHYSICS.PRESSURE_MULT * derived.pressure),
    targetPulseHz: PHYSICS.BASE_PULSE * (1 + PHYSICS.ENTROPY_MULT * derived.entropy),
    targetAsymStrength: clamp(PHYSICS.SHOCK_ASYM * Math.max(state.SHOCK, state.FRICTION), 0, 0.95),
    targetAsymAngle: bottleneck.angle
  };
}

// UPDATE FULL STATE â€” Writes to PhysicsFrame (SINGLE SOURCE)
function updateFullState() {
  // 1. Compute derived from TwinState
  const derived = computeDerived(TwinState);
  
  // 2. Write to PhysicsFrame.snapshot (SINGLE SOURCE)
  PhysicsFrame.snapshot.risk = derived.risk;
  PhysicsFrame.snapshot.entropy = derived.entropy;
  PhysicsFrame.snapshot.pressure = derived.pressure;
  PhysicsFrame.snapshot.flow = derived.flow;
  PhysicsFrame.snapshot.dignity = derived.dignity;       // EP10
  PhysicsFrame.snapshot.reputation = derived.reputation; // EP10
  
  // 3. Compute and write bottleneck (SINGLE SOURCE)
  const bn = computeBottleneckFrom(TwinState);
  PhysicsFrame.bottleneck.axis = bn.axis;
  PhysicsFrame.bottleneck.value = bn.value;
  PhysicsFrame.bottleneck.angle = bn.angle;
  PhysicsFrame.bottleneck.badness = bn.badness;
  
  // 4. Compute and write ring targets
  const targets = computeRingTargets(derived, TwinState, bn);
  PhysicsFrame.ring.targetRadiusScale = targets.targetRadiusScale;
  PhysicsFrame.ring.targetThickness = targets.targetThickness;
  PhysicsFrame.ring.targetPulseHz = targets.targetPulseHz;
  PhysicsFrame.ring.targetAsymStrength = targets.targetAsymStrength;
  PhysicsFrame.ring.targetAsymAngle = targets.targetAsymAngle;
  
  // 5. EP10: Compute action values for each impulse
  PhysicsFrame.actionValues.recover = computeActionValue(TwinState, derived, 'recover');
  PhysicsFrame.actionValues.defriction = computeActionValue(TwinState, derived, 'defriction');
  PhysicsFrame.actionValues.shock_damp = computeActionValue(TwinState, derived, 'shock_damp');
  PhysicsFrame.actionValues.no_action = computeActionValue(TwinState, derived, 'no_action');
  
  // 6. EP10: Update UI for forecast and value indicators
  updateForecastPanel();
  updateValueIndicators();
  updateDignityDisplay();
  
  // 7. PHASE 1: Update hover simulation cards
  updateHoverSimCards();
}

function animatePhysicsFrame(dt) {
  const r = PhysicsFrame.ring;
  r.radiusScale = lerpTau(r.radiusScale, r.targetRadiusScale, TAU.radiusScale, dt);
  r.thickness = lerpTau(r.thickness, r.targetThickness, TAU.thickness, dt);
  r.pulseHz = lerpTau(r.pulseHz, r.targetPulseHz, TAU.pulseHz, dt);
  r.asymStrength = lerpTau(r.asymStrength, r.targetAsymStrength, TAU.asymStrength, dt);
  r.asymAngle = lerpTau(r.asymAngle, r.targetAsymAngle, TAU.asymAngle, dt);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPULSE APPLICATION â€” FROZEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyImpulse(state, profileKey) {
  const profile = IMPULSE_PROFILES[profileKey];
  if (!profile) return { ...state };
  const next = { ...state };
  for (const key in profile.delta) {
    if (next.hasOwnProperty(key)) next[key] = clamp(next[key] + profile.delta[key]);
  }
  if (profile.bottleneckBonus && profile.bottleneckBonus.axes.includes(PhysicsFrame.bottleneck.axis)) {
    for (const key in profile.bottleneckBonus.delta) {
      if (next.hasOwnProperty(key)) next[key] = clamp(next[key] + profile.bottleneckBonus.delta[key]);
    }
  }
  return next;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, innerWidth / innerHeight, 0.1, 1000);
camera.position.set(0, 8, 14); camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0x404050, 0.5));
scene.add(new THREE.PointLight(0xffffff, 1.5, 50));

// Starfield
const starsGeo = new THREE.BufferGeometry();
const starPos = [];
for (let i = 0; i < 2500; i++) {
  const r = 45 + Math.random() * 70, t = Math.random() * Math.PI * 2, p = Math.acos(2 * Math.random() - 1);
  starPos.push(r * Math.sin(p) * Math.cos(t), r * Math.sin(p) * Math.sin(t), r * Math.cos(p));
}
starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.08 })));

// Globe
const globeGroup = new THREE.Group();
scene.add(globeGroup);
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.5, 64, 64), new THREE.MeshPhongMaterial({ color: 0x0066aa, emissive: 0x001133, transparent: true, opacity: 0.85 })));
globeGroup.add(new THREE.Mesh(new THREE.SphereGeometry(1.52, 36, 18), new THREE.MeshBasicMaterial({ color: 0x00d4ff, wireframe: true, transparent: true, opacity: 0.15 })));

// Failure Ring
const simGroup = new THREE.Group();
const RING_SEGMENTS = 128;
const failureRingGeo = new THREE.TorusGeometry(PHYSICS.BASE_RADIUS, 0.15, 16, RING_SEGMENTS);
const failureRingMat = new THREE.MeshBasicMaterial({ color: 0xff4444, transparent: true, opacity: 0.7, side: THREE.DoubleSide });
const failureRing = new THREE.Mesh(failureRingGeo, failureRingMat);
failureRing.rotation.x = Math.PI / 2; failureRing.position.y = 0.3;
simGroup.add(failureRing);
const failureRingBasePositions = failureRingGeo.attributes.position.array.slice();

// Ghost Ring
const ghostRingGeo = new THREE.TorusGeometry(PHYSICS.BASE_RADIUS, 0.08, 8, RING_SEGMENTS);
const ghostRingMat = new THREE.MeshBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.0, wireframe: true });
const ghostRing = new THREE.Mesh(ghostRingGeo, ghostRingMat);
ghostRing.rotation.x = Math.PI / 2; ghostRing.position.y = 0.35;
simGroup.add(ghostRing);
const ghostRingBasePositions = ghostRingGeo.attributes.position.array.slice();

scene.add(simGroup);

// Ring Deformation â€” READS FROM PhysicsFrame ONLY
function deformFailureRing(time) {
  const pf = PhysicsFrame.ring;
  const snap = PhysicsFrame.snapshot; // SINGLE SOURCE
  const positions = failureRingGeo.attributes.position.array;
  const basePos = failureRingBasePositions;
  const pulse = Math.sin(time * pf.pulseHz * Math.PI * 2) * 0.1;
  
  for (let i = 0; i < positions.length; i += 3) {
    const bx = basePos[i], by = basePos[i + 1], bz = basePos[i + 2];
    const angle = Math.atan2(bz, bx);
    const asymOffset = Math.cos(angle - pf.asymAngle) * pf.asymStrength * 0.4;
    const scale = pf.radiusScale * (1 + asymOffset) * (1 + pulse * 0.15);
    positions[i] = bx * scale;
    positions[i + 1] = by * (1 + pf.thickness * 3);
    positions[i + 2] = bz * scale;
  }
  failureRingGeo.attributes.position.needsUpdate = true;
  
  // Color based on snapshot.risk (SINGLE SOURCE)
  failureRingMat.color.setHex(snap.risk > 0.6 ? 0xff4444 : snap.risk > 0.4 ? 0xffaa00 : 0x00d4aa);
  failureRingMat.opacity = 0.4 + snap.risk * 0.5;
}

function deformGhostRing() {
  const pv = PhysicsFrame.preview;
  if (!pv.active) { ghostRingMat.opacity = 0; return; }
  
  ghostRingMat.opacity = 0.5;
  const positions = ghostRingGeo.attributes.position.array;
  const basePos = ghostRingBasePositions;
  
  for (let i = 0; i < positions.length; i += 3) {
    const bx = basePos[i], by = basePos[i + 1], bz = basePos[i + 2];
    const angle = Math.atan2(bz, bx);
    const asymOffset = Math.cos(angle - pv.ring.asymAngle) * pv.ring.asymStrength * 0.4;
    const scale = pv.ring.radiusScale * (1 + asymOffset);
    positions[i] = bx * scale;
    positions[i + 1] = by * (1 + pv.ring.thickness * 3);
    positions[i + 2] = bz * scale;
  }
  ghostRingGeo.attributes.position.needsUpdate = true;
}

// Planets
const planetGroup = new THREE.Group();
scene.add(planetGroup);
const planetMeshes = {}, planetLabelsEl = {}, orbitRings = [];
let planetsVisible = true, orbitsVisible = true;

PLANETS.forEach((p, i) => {
  const group = new THREE.Group();
  const mat = new THREE.MeshStandardMaterial({ color: p.color, emissive: p.color, emissiveIntensity: 0.3 });
  group.add(new THREE.Mesh(new THREE.SphereGeometry(p.size, 24, 24), mat));
  group.add(new THREE.Mesh(new THREE.SphereGeometry(p.size * 1.3, 16, 16), new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.15, side: THREE.BackSide })));
  if (p.rings) {
    const ring = new THREE.Mesh(new THREE.RingGeometry(p.size * 1.5, p.size * 2, 32), new THREE.MeshBasicMaterial({ color: p.color, transparent: true, opacity: 0.25, side: THREE.DoubleSide }));
    ring.rotation.x = Math.PI / 2.2; group.add(ring);
  }
  planetGroup.add(group);
  planetMeshes[p.key] = group;
  
  const oRing = new THREE.Mesh(new THREE.RingGeometry(p.orbit - 0.015, p.orbit + 0.015, 64), new THREE.MeshBasicMaterial({ color: 0x00d4ff, transparent: true, opacity: 0.2, side: THREE.DoubleSide }));
  oRing.rotation.x = -Math.PI / 2; scene.add(oRing); orbitRings.push(oRing);
  
  const label = document.createElement('div');
  label.className = 'planet-label';
  label.innerHTML = `<span style="color:#${p.color.toString(16).padStart(6,'0')}">${p.icon}</span> ${p.name}`;
  document.body.appendChild(label);
  planetLabelsEl[p.key] = label;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI UPDATES â€” ALL READ FROM PhysicsFrame (SINGLE SOURCE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKernelDisplay() {
  const r = PhysicsFrame.ring;
  const snap = PhysicsFrame.snapshot;  // SINGLE SOURCE
  const bn = PhysicsFrame.bottleneck;  // SINGLE SOURCE
  
  // Ring physics
  const radiusEl = document.getElementById('pf-radius');
  radiusEl.textContent = r.radiusScale.toFixed(3);
  radiusEl.className = 'kernel-val ' + (r.radiusScale < 0.6 ? 'danger' : r.radiusScale < 0.8 ? 'warning' : 'safe');
  document.getElementById('pf-thick').textContent = r.thickness.toFixed(3);
  document.getElementById('pf-pulse').textContent = r.pulseHz.toFixed(3);
  const asymEl = document.getElementById('pf-asym');
  asymEl.textContent = r.asymStrength.toFixed(3);
  asymEl.className = 'kernel-val ' + (r.asymStrength > 0.5 ? 'danger' : r.asymStrength > 0.3 ? 'warning' : 'safe');
  document.getElementById('pf-angle').textContent = Math.round(r.asymAngle * 180 / Math.PI) + 'Â°';
  
  // Snapshot (SINGLE SOURCE for all derived values)
  const riskEl = document.getElementById('snap-risk');
  riskEl.textContent = snap.risk.toFixed(3);
  riskEl.className = 'kernel-val ' + (snap.risk > 0.6 ? 'danger' : snap.risk > 0.4 ? 'warning' : 'safe');
  document.getElementById('snap-entropy').textContent = snap.entropy.toFixed(3);
  document.getElementById('snap-pressure').textContent = snap.pressure.toFixed(3);
  document.getElementById('snap-flow').textContent = snap.flow.toFixed(3);
  
  // Bottleneck (SINGLE SOURCE)
  document.getElementById('bn-axis').textContent = `${bn.axis} (${Math.round(bn.value * 100)}%)`;
  document.getElementById('bn-angle').textContent = Math.round(bn.angle * 180 / Math.PI) + 'Â°';
  document.getElementById('bn-warning').textContent = `âš ï¸ ${bn.axis} bottleneck detected ${bn.value.toFixed(2)}`;
  
  // Metric cards (READ FROM SNAPSHOT â€” SINGLE SOURCE)
  document.getElementById('m-entropy').textContent = snap.entropy.toFixed(2);
  document.getElementById('m-pressure').textContent = snap.pressure.toFixed(2);
  document.getElementById('m-risk').textContent = snap.risk.toFixed(2);
  document.getElementById('m-risk').className = 'metric-value' + (snap.risk > 0.6 ? ' danger' : snap.risk > 0.4 ? ' warning' : '');
  document.getElementById('m-flow').textContent = snap.flow.toFixed(2);
  
  // Status (READ FROM SNAPSHOT)
  const statusEl = document.getElementById('s-status');
  statusEl.textContent = snap.risk > 0.6 ? 'CRITICAL' : snap.risk > 0.4 ? 'WARNING' : 'STABLE';
  statusEl.className = 'stat-value' + (snap.risk > 0.6 ? ' critical' : snap.risk > 0.4 ? ' warning' : '');
  
  // Gate (READ FROM SNAPSHOT)
  const gateEl = document.getElementById('gate-badge');
  if (snap.risk > 0.6) { gateEl.className = 'gate-badge gate-red'; gateEl.textContent = 'GATE: RED'; }
  else if (snap.risk > 0.4) { gateEl.className = 'gate-badge gate-amber'; gateEl.textContent = 'GATE: AMBER'; }
  else { gateEl.className = 'gate-badge gate-green'; gateEl.textContent = 'GATE: GREEN'; }
}

function renderPlanetList() {
  const bn = PhysicsFrame.bottleneck; // SINGLE SOURCE
  const container = document.getElementById('planet-list');
  container.innerHTML = PLANETS.map(p => {
    const value = Math.round((TwinState[p.key] || 0.5) * 100);
    const colorHex = '#' + p.color.toString(16).padStart(6, '0');
    const isBottleneck = p.key === bn.axis; // Uses SINGLE SOURCE
    return `<div class="planet-row ${isBottleneck ? 'bottleneck-active' : ''}" data-key="${p.key}">
      <div class="planet-dot" style="background:${colorHex}"></div>
      <span class="planet-name">${p.icon} ${p.name}</span>
      <span class="planet-val" style="color:${colorHex}">${value}%</span>
    </div>`;
  }).join('');
}

function logAction(msg, type = 'info') {
  const container = document.getElementById('log-items');
  if (!container) return;
  const item = document.createElement('div');
  item.className = 'log-item' + (type === 'warning' ? ' warning' : type === 'critical' ? ' critical' : type === 'success' ? ' success' : '');
  const ts = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  item.textContent = `[${ts}] ${msg}`;
  container.insertBefore(item, container.firstChild);
  while (container.children.length > 15) container.removeChild(container.lastChild);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: FORECAST PANEL UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateForecastPanel() {
  const av = PhysicsFrame.actionValues;
  const snap = PhysicsFrame.snapshot;
  
  // Find best action (highest reputation gain)
  const actions = [
    { key: 'shock_damp', val: av.shock_damp },
    { key: 'recover', val: av.recover },
    { key: 'defriction', val: av.defriction }
  ].sort((a, b) => (b.val.reputation + b.val.dignity) - (a.val.reputation + a.val.dignity));
  
  // Best branch
  const best = actions[0];
  document.getElementById('fc-best').innerHTML = `
    <div class="branch-label">IF ${best.key.toUpperCase().replace('_', ' ')}:</div>
    <div class="branch-values">
      <span class="value-chip ${best.val.cost > 0 ? 'positive' : 'negative'}">ğŸ’° Cost ${best.val.cost > 0 ? 'âˆ’' : '+'}${Math.abs(best.val.cost)}%</span>
      <span class="value-chip ${best.val.time > 0 ? 'positive' : 'negative'}">â±ï¸ Time ${best.val.time > 0 ? 'âˆ’' : '+'}${Math.abs(best.val.time)}%</span>
      <span class="value-chip ${best.val.reputation > 0 ? 'positive' : 'negative'}">ğŸŒ Rep ${best.val.reputation > 0 ? '+' : ''}${best.val.reputation}Ïƒ</span>
    </div>
  `;
  
  // Mid branch
  const mid = actions[1];
  document.getElementById('fc-mid').innerHTML = `
    <div class="branch-label">IF ${mid.key.toUpperCase().replace('_', ' ')}:</div>
    <div class="branch-values">
      <span class="value-chip ${mid.val.dignity > 0 ? 'positive' : 'neutral'}">ğŸ›ï¸ Dignity ${mid.val.dignity > 0 ? '+' : ''}${mid.val.dignity}</span>
      <span class="value-chip ${mid.val.cost > 0 ? 'positive' : 'negative'}">ğŸ’° Cost ${mid.val.cost > 0 ? 'âˆ’' : '+'}${Math.abs(mid.val.cost)}%</span>
      <span class="value-chip neutral">â±ï¸ Time ${mid.val.time > 0 ? 'âˆ’' : '+'}${Math.abs(mid.val.time)}%</span>
    </div>
  `;
  
  // Worst branch (no action)
  const noAct = av.no_action;
  document.getElementById('fc-worst').innerHTML = `
    <div class="branch-label">IF NO ACTION:</div>
    <div class="branch-values">
      <span class="value-chip negative">ğŸ“ˆ Entropy +${Math.abs(noAct.cost)}%</span>
      <span class="value-chip negative">âš ï¸ Shock ì§€ì†</span>
      <span class="value-chip negative">ğŸŒ Rep ${noAct.reputation}Ïƒ</span>
    </div>
  `;
  
  // Reputation status
  const repEl = document.getElementById('rep-status');
  if (snap.reputation < 0.2) {
    repEl.textContent = 'ğŸŒ External Perception: Volatile';
    repEl.style.color = 'var(--accent-red)';
  } else if (snap.reputation < 0.5) {
    repEl.textContent = 'ğŸŒ External Perception: Uncertain';
    repEl.style.color = 'var(--accent-orange)';
  } else {
    repEl.textContent = 'ğŸŒ External Trust: Stabilizing';
    repEl.style.color = 'var(--accent-green)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: VALUE INDICATORS UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateValueIndicators() {
  const av = PhysicsFrame.actionValues;
  
  ['recover', 'defriction', 'shock_damp'].forEach(key => {
    const v = av[key];
    const el = document.getElementById(`vi-${key}`);
    if (!el) return;
    
    el.innerHTML = `
      <span class="value-ind"><span class="icon">ğŸ’°</span><span class="val ${v.cost > 0 ? 'down' : 'up'}">${v.cost > 0 ? 'âˆ’' : '+'}${Math.abs(v.cost)}%</span></span>
      <span class="value-ind"><span class="icon">â±ï¸</span><span class="val ${v.time > 0 ? 'down' : 'up'}">${v.time > 0 ? 'âˆ’' : '+'}${Math.abs(v.time)}%</span></span>
      <span class="value-ind"><span class="icon">ğŸ›ï¸</span><span class="val ${v.dignity > 0 ? 'up' : 'down'}">${v.dignity > 0 ? '+' : ''}${v.dignity}</span></span>
      <span class="value-ind"><span class="icon">ğŸŒ</span><span class="val ${v.reputation > 0 ? 'up' : 'down'}">${v.reputation > 0 ? '+' : ''}${v.reputation}Ïƒ</span></span>
    `;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EP10: DIGNITY DISPLAY UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDignityDisplay() {
  const dignity = PhysicsFrame.snapshot.dignity;
  const el = document.getElementById('dignity-display');
  
  if (dignity < 0.2) {
    el.className = 'low';
    el.textContent = 'DIGNITY: LOW';
  } else if (dignity < 0.5) {
    el.className = 'balanced';
    el.textContent = 'DIGNITY: BALANCED';
  } else {
    el.className = 'elevated';
    el.textContent = 'DIGNITY: ELEVATED';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW / AUDIT / LOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentAuditAction = null, auditTimer = null;
window.auditActive = false;

function previewAction(actionKey) {
  const profile = IMPULSE_PROFILES[actionKey];
  if (!profile) return;
  
  const futureState = applyImpulse(TwinState, actionKey);
  const futureDerived = computeDerived(futureState);
  const futureBottleneck = computeBottleneckFrom(futureState);
  const futureRing = computeRingTargets(futureDerived, futureState, futureBottleneck);
  
  // Set preview (SEPARATE from main snapshot)
  PhysicsFrame.preview.active = true;
  PhysicsFrame.preview.snapshot = { ...futureDerived };
  PhysicsFrame.preview.bottleneck = { ...futureBottleneck };
  PhysicsFrame.preview.ring = {
    radiusScale: futureRing.targetRadiusScale,
    thickness: futureRing.targetThickness,
    pulseHz: futureRing.targetPulseHz,
    asymStrength: futureRing.targetAsymStrength,
    asymAngle: futureRing.targetAsymAngle
  };
  
  ghostRingMat.color.setHex(futureDerived.risk < PhysicsFrame.snapshot.risk ? 0x00ff88 : 0xff4444);
  
  logAction(`Preview: ${profile.name} (Risk ${(PhysicsFrame.snapshot.risk*100).toFixed(0)}% â†’ ${(futureDerived.risk*100).toFixed(0)}%)`, 'warning');
  
  currentAuditAction = { key: actionKey, profile, futureState, futureDerived, futureBottleneck };
  openAudit();
}

function openAudit() {
  if (!currentAuditAction) return;
  clearInterval(auditTimer);
  window.auditActive = true;
  
  const { profile, futureDerived, futureBottleneck } = currentAuditAction;
  const snap = PhysicsFrame.snapshot; // SINGLE SOURCE
  const bn = PhysicsFrame.bottleneck; // SINGLE SOURCE
  
  document.getElementById('layer-audit').classList.add('active');
  document.getElementById('audit-action').textContent = `${profile.name} â€” ${profile.description}`;
  
  const riskImproved = futureDerived.risk < snap.risk;
  document.getElementById('audit-risk').textContent = `${(snap.risk*100).toFixed(0)}% â†’ ${(futureDerived.risk*100).toFixed(0)}%`;
  document.getElementById('audit-risk').className = 'value ' + (riskImproved ? 'positive' : 'negative');
  
  document.getElementById('audit-bn').textContent = `${bn.axis} â†’ ${futureBottleneck.axis}`;
  document.getElementById('audit-bn').className = 'value ' + (futureBottleneck.axis !== bn.axis ? 'positive' : '');
  
  document.getElementById('audit-conf').textContent = profile.confidence + '%';
  
  const costsEl = document.getElementById('audit-costs-list');
  costsEl.innerHTML = profile.costs.map(c => `<span class="cost-item">${c}</span>`).join('');
  
  let countdown = 30;
  const timerEl = document.getElementById('audit-countdown');
  timerEl.textContent = countdown;
  auditTimer = setInterval(() => {
    countdown--;
    timerEl.textContent = countdown;
    if (countdown <= 0) auditDecision('REJECT');
  }, 1000);
}

function auditDecision(verdict) {
  clearInterval(auditTimer);
  PhysicsFrame.preview.active = false;
  
  if (verdict === 'LOCK' && currentAuditAction) {
    Object.assign(TwinState, currentAuditAction.futureState);
    updateFullState();
    renderPlanetList();
    logAction(`LOCKED: ${currentAuditAction.profile.name} â†’ Risk ${(PhysicsFrame.snapshot.risk*100).toFixed(0)}%`, 'success');
  } else if (verdict === 'REJECT') {
    logAction(`REJECTED: ${currentAuditAction?.profile?.name || 'unknown'}`);
  } else {
    logAction(`HOLD: ${currentAuditAction?.profile?.name || 'unknown'}`);
    return;
  }
  
  document.getElementById('layer-audit').classList.remove('active');
  window.auditActive = false;
  currentAuditAction = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCEPTANCE TESTS â€” 8 AUTOMATED VERIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAcceptanceTests() {
  const tests = [];
  const snap = PhysicsFrame.snapshot;
  const bn = PhysicsFrame.bottleneck;
  const r = PhysicsFrame.ring;
  
  // Test 1: Single Source - Risk card matches snapshot
  const riskCard = parseFloat(document.getElementById('m-risk').textContent);
  tests.push({ name: 'T1: Risk Single Source', pass: Math.abs(riskCard - snap.risk) < 0.01 });
  
  // Test 2: Single Source - Pressure card matches snapshot
  const pressureCard = parseFloat(document.getElementById('m-pressure').textContent);
  tests.push({ name: 'T2: Pressure Single Source', pass: Math.abs(pressureCard - snap.pressure) < 0.01 });
  
  // Test 3: Bottleneck - Warning text includes correct axis
  const bnWarning = document.getElementById('bn-warning').textContent;
  tests.push({ name: 'T3: Bottleneck Axis Match', pass: bnWarning.includes(bn.axis) });
  
  // Test 4: Ring-Bottleneck coupling - asymAngle matches bottleneck angle
  tests.push({ name: 'T4: Ring-BN Angle Coupling', pass: Math.abs(r.targetAsymAngle - bn.angle) < 0.01 });
  
  // Test 5: Law 5 - Riskâ†’Radius monotonicity
  const expectedRadius = 1.0 - PHYSICS.RISK_COMPRESSION * snap.risk;
  tests.push({ name: 'T5: Law 5 Riskâ†’Radius', pass: Math.abs(r.targetRadiusScale - expectedRadius) < 0.01 });
  
  // Test 6: Law 6 - Entropyâ†’Pulse
  const expectedPulse = PHYSICS.BASE_PULSE * (1 + PHYSICS.ENTROPY_MULT * snap.entropy);
  tests.push({ name: 'T6: Law 6 Entropyâ†’Pulse', pass: Math.abs(r.targetPulseHz - expectedPulse) < 0.01 });
  
  // Test 7: Preview separation - preview.active is boolean
  tests.push({ name: 'T7: Preview Separation', pass: typeof PhysicsFrame.preview.active === 'boolean' });
  
  // Test 8: Impulse reproducibility - same input produces same output
  const state1 = applyImpulse({ ...TwinState }, 'recover');
  const state2 = applyImpulse({ ...TwinState }, 'recover');
  tests.push({ name: 'T8: Impulse Reproducibility', pass: JSON.stringify(state1) === JSON.stringify(state2) });
  
  // Report
  const passed = tests.filter(t => t.pass).length;
  const total = tests.length;
  const allPass = passed === total;
  
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('  ACCEPTANCE TESTS â€” PHYSICS KERNEL v2.3');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  tests.forEach(t => console.log(`  ${t.pass ? 'âœ“' : 'âœ—'} ${t.name}`));
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log(`  RESULT: ${passed}/${total} ${allPass ? 'ALL PASS âœ“' : 'FAILED âœ—'}`);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  const badge = document.getElementById('test-badge');
  badge.textContent = `TESTS: ${passed}/${total} ${allPass ? 'âœ“' : 'âœ—'}`;
  badge.className = 'test-badge' + (allPass ? '' : ' fail');
  
  logAction(`Tests: ${passed}/${total} ${allPass ? 'PASS' : 'FAIL'}`, allPass ? 'success' : 'critical');
  
  return { passed, total, allPass, tests };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePlanets() {
  planetsVisible = !planetsVisible;
  planetGroup.visible = planetsVisible;
  Object.values(planetLabelsEl).forEach(el => el.style.display = planetsVisible ? 'block' : 'none');
  document.querySelector('#controls button:nth-child(1)').classList.toggle('active', planetsVisible);
}

function toggleOrbits() {
  orbitsVisible = !orbitsVisible;
  orbitRings.forEach(r => r.visible = orbitsVisible);
  document.querySelector('#controls button:nth-child(2)').classList.toggle('active', orbitsVisible);
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('layer-audit').classList.remove('active');
    PhysicsFrame.preview.active = false;
    clearInterval(auditTimer);
    window.auditActive = false;
  }
  if (e.key === 'r' || e.key === 'R') {
    Object.assign(TwinState, { RECOVERY: 0.42, STABILITY: 0.55, COHESION: 0.62, SHOCK: 0.72, FRICTION: 0.79, TRANSFER: 0.60, TIME: 0.50, QUALITY: 0.68, OUTPUT: 0.55 });
    updateFullState();
    renderPlanetList();
    logAction('State reset', 'warning');
  }
  if (e.key === 't' || e.key === 'T') {
    runAcceptanceTests();
  }
});

// Camera
let isDragging = false, prevMouse = { x: 0, y: 0 };
let cameraTheta = 0, cameraPhi = 1.0, cameraDistance = 16;
renderer.domElement.addEventListener('mousedown', e => { isDragging = true; prevMouse = { x: e.clientX, y: e.clientY }; });
renderer.domElement.addEventListener('mousemove', e => {
  if (!isDragging) return;
  cameraTheta += (e.clientX - prevMouse.x) * 0.005;
  cameraPhi = Math.max(0.3, Math.min(2.5, cameraPhi + (e.clientY - prevMouse.y) * 0.005));
  prevMouse = { x: e.clientX, y: e.clientY };
  camera.position.set(cameraDistance * Math.sin(cameraPhi) * Math.cos(cameraTheta), cameraDistance * Math.cos(cameraPhi), cameraDistance * Math.sin(cameraPhi) * Math.sin(cameraTheta));
  camera.lookAt(0, 0, 0);
});
renderer.domElement.addEventListener('mouseup', () => isDragging = false);
renderer.domElement.addEventListener('wheel', e => {
  cameraDistance = Math.max(8, Math.min(30, cameraDistance + e.deltaY * 0.02));
  camera.position.set(cameraDistance * Math.sin(cameraPhi) * Math.cos(cameraTheta), cameraDistance * Math.cos(cameraPhi), cameraDistance * Math.sin(cameraPhi) * Math.sin(cameraTheta));
  camera.lookAt(0, 0, 0);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let time = 0, frames = 0, lastFPS = performance.now(), lastFrameTime = performance.now();

function animate() {
  requestAnimationFrame(animate);
  const now = performance.now();
  const dt = (now - lastFrameTime) / 1000;
  lastFrameTime = now;
  time += 0.016;
  
  if (!window.auditActive) globeGroup.rotation.y += 0.003;
  
  if (planetsVisible) {
    const bn = PhysicsFrame.bottleneck; // SINGLE SOURCE
    PLANETS.forEach((p, i) => {
      const value = TwinState[p.key] || 0.5;
      const group = planetMeshes[p.key];
      const angle = time * p.speed * 0.3 + (i / PLANETS.length) * Math.PI * 2;
      const r = p.orbit + (value - 0.5) * 0.2;
      group.position.set(Math.cos(angle) * r, Math.sin(time * 0.2 + i) * 0.1, Math.sin(angle) * r);
      group.rotation.y += 0.02;
      group.scale.setScalar(p.key === bn.axis ? 1.5 : 1); // Uses SINGLE SOURCE
      
      const label = planetLabelsEl[p.key];
      const screenPos = group.position.clone().project(camera);
      if (screenPos.z < 1) {
        label.style.left = ((screenPos.x + 1) / 2 * innerWidth) + 'px';
        label.style.top = ((-screenPos.y + 1) / 2 * innerHeight - 22) + 'px';
        label.style.opacity = p.key === bn.axis ? '1' : '0.5';
      } else label.style.opacity = '0';
    });
  }
  
  animatePhysicsFrame(dt);
  deformFailureRing(time);
  deformGhostRing();
  failureRing.rotation.z += 0.001;
  
  updateKernelDisplay();
  
  frames++;
  if (now - lastFPS >= 1000) { document.getElementById('sys-fps').textContent = frames; frames = 0; lastFPS = now; }
  document.getElementById('sys-time').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
  
  renderer.render(scene, camera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onresize = () => { camera.aspect = innerWidth / innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); };

// Initialize state
updateFullState();
renderPlanetList();

// Kernel init log
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('  AUTUS PHYSICS KERNEL v2.4 â€” EP10 FULL LOOP');
console.log('');
console.log('  "ë¯¸ë˜ë¥¼ ë§íˆëŠ” ê²Œ ì•„ë‹ˆë¼, ë¯¸ë˜ì˜ ì°¨ì´ë¥¼ ë³´ì—¬ì¤€ë‹¤"');
console.log('');
console.log('  EP10 USER VALUE:');
console.log('  â€¢ ğŸ’° Cost   = Entropyâ†“ + Frictionâ†“');
console.log('  â€¢ â±ï¸ Time   = Timeâ†“ + Pressureâ†“');
console.log('  â€¢ ğŸ›ï¸ Dignity = Quality Ã— Stability âˆ’ Entropy Ã— Friction');
console.log('  â€¢ ğŸŒ Reputation = âˆ’Future Shock Residual');
console.log('');
console.log('  FORECAST BRANCH: ì„ íƒë³„ ë¯¸ë˜ ë¶„ê¸° í‘œì‹œ');
console.log('  ACTION VALUE: ë²„íŠ¼ í•˜ë‹¨ì— 4ê°€ì§€ ê°€ì¹˜ ì§€í‘œ í‘œì‹œ');
console.log('');
console.log('  Press [T] to run acceptance tests');
console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

logAction('Kernel v2.4 EP10 initialized', 'success');
logAction(`Dignity: ${PhysicsFrame.snapshot.dignity > 0.5 ? 'ELEVATED' : PhysicsFrame.snapshot.dignity > 0.2 ? 'BALANCED' : 'LOW'}`, 'warning');
logAction(`Bottleneck: ${PhysicsFrame.bottleneck.axis} (${Math.round(PhysicsFrame.bottleneck.value * 100)}%)`, 'warning');

// Auto-run tests on load
setTimeout(() => runAcceptanceTests(), 500);

animate();
  </script>
  
  <!-- Future Simulator Module -->
  <link rel="stylesheet" href="simulator.css">
  <script src="future-simulator.js"></script>
  <script src="simulator-ui.js"></script>
  
  <!-- Choice Card System (ë²„íŠ¼ OS â†’ ì„ íƒ OS) -->
  <link rel="stylesheet" href="choice-card.css">
  <script src="choice-card.js"></script>
  <script src="choice-card-ui.js"></script>
  
  <!-- Phantom Orbit (ë¯¸ë˜ ê¶¤ë„ ì˜¤ë²„ë ˆì´) -->
  <link rel="stylesheet" href="phantom-orbit.css">
  <script src="phantom-orbit.js"></script>
  
  <!-- Phantom UI Elements -->
  <div class="phantom-legend" id="phantom-legend">
    <div class="legend-item">
      <span class="legend-dot current"></span>
      <span class="legend-text">CURRENT</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot future-good"></span>
      <span class="legend-text">FUTURE (improved)</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot future-bad"></span>
      <span class="legend-text">FUTURE (worse)</span>
    </div>
  </div>
  <div class="phantom-hint" id="phantom-hint">HOVER CHOICE TO SEE FUTURE ORBIT</div>
</body>
</html>
