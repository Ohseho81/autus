<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AUTUS ATLAS Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'SF Mono', monospace; overflow: hidden; }
        .glass { background: rgba(10,10,10,0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .glow-cyan { box-shadow: 0 0 20px rgba(0,255,255,0.3); }
        .glow-red { box-shadow: 0 0 20px rgba(255,0,0,0.5); }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .panel { position: absolute; z-index: 10; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="root"></div>
    
    <script type="text/babel">
        const API = "http://localhost:8000";
        
        // Organism 3D Renderer
        class OrganismRenderer {
            constructor(container) {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x000000, 1);
                container.appendChild(this.renderer.domElement);
                
                this.camera.position.z = 8;
                this.slots = {};
                this.createOrganism();
                this.animate();
                
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            createOrganism() {
                // Core sphere
                const coreGeo = new THREE.SphereGeometry(0.8, 32, 32);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
                this.core = new THREE.Mesh(coreGeo, coreMat);
                this.scene.add(this.core);
                
                // 7 Slots as orbiting rings
                const slotNames = ['Brain', 'Sensors', 'Heart', 'Core', 'Engines', 'Base', 'Boundary'];
                const colors = [0x4488ff, 0x44ff88, 0xff4488, 0xffff44, 0xff8844, 0x8844ff, 0x44ffff];
                
                slotNames.forEach((name, i) => {
                    const ringGeo = new THREE.TorusGeometry(1.5 + i * 0.3, 0.02, 8, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ color: colors[i], transparent: true, opacity: 0.6 });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI / 2 + (i * 0.2);
                    ring.rotation.y = i * 0.3;
                    this.slots[name] = { mesh: ring, baseOpacity: 0.6 };
                    this.scene.add(ring);
                });
                
                // Particles
                const particleGeo = new THREE.BufferGeometry();
                const positions = [];
                for (let i = 0; i < 500; i++) {
                    positions.push((Math.random() - 0.5) * 20);
                    positions.push((Math.random() - 0.5) * 20);
                    positions.push((Math.random() - 0.5) * 20);
                }
                particleGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                const particleMat = new THREE.PointsMaterial({ color: 0x00ffff, size: 0.05, transparent: true, opacity: 0.5 });
                this.particles = new THREE.Points(particleGeo, particleMat);
                this.scene.add(this.particles);
            }
            
            updateSlots(slotValues, blocked) {
                Object.keys(slotValues).forEach(name => {
                    if (this.slots[name]) {
                        const val = Math.min(1, slotValues[name]);
                        this.slots[name].mesh.material.opacity = 0.3 + val * 0.7;
                        this.slots[name].mesh.scale.setScalar(0.8 + val * 0.4);
                    }
                });
                
                // Blocked state - red pulse
                if (blocked) {
                    this.core.material.color.setHex(0xff0000);
                } else {
                    this.core.material.color.setHex(0x00ffff);
                }
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                this.core.rotation.y += 0.005;
                this.particles.rotation.y += 0.001;
                
                Object.values(this.slots).forEach((slot, i) => {
                    slot.mesh.rotation.z += 0.002 * (i + 1);
                });
                
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        function App() {
            const [state, setState] = React.useState({
                mode: 'SEED', integrity: 100, energy: 100, gmu_count: 1, cycle: 0
            });
            const [guardrail, setGuardrail] = React.useState({ is_blocked: false, can_commit: true });
            const [slots, setSlots] = React.useState({});
            const [logs, setLogs] = React.useState([]);
            const [input, setInput] = React.useState('');
            const [view, setView] = React.useState('MAIN');
            const rendererRef = React.useRef(null);
            
            React.useEffect(() => {
                const container = document.getElementById('canvas-container');
                rendererRef.current = new OrganismRenderer(container);
                fetchGuardrail();
                const interval = setInterval(fetchGuardrail, 5000);
                return () => clearInterval(interval);
            }, []);
            
            React.useEffect(() => {
                if (rendererRef.current) {
                    rendererRef.current.updateSlots(slots, guardrail.is_blocked);
                }
            }, [slots, guardrail.is_blocked]);
            
            const fetchGuardrail = async () => {
                try {
                    const res = await fetch(`${API}/autus/guardrail/status`);
                    const data = await res.json();
                    setGuardrail(data);
                } catch(e) {}
            };
            
            const addLog = (msg) => setLogs(prev => [msg, ...prev].slice(0, 10));
            
            const execute = async () => {
                if (!input.trim()) return;
                addLog(`> ${input}`);
                try {
                    const res = await fetch(`${API}/autus/pipeline/process`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ text: input })
                    });
                    const data = await res.json();
                    if (data.state) setState(data.state);
                    if (data.logs) data.logs.forEach(l => addLog(l));
                    if (data.slots) setSlots(data.slots);
                } catch(e) {
                    addLog('ERROR: Connection failed');
                }
                setInput('');
                fetchGuardrail();
            };
            
            const testGuardrail = async (pressure, base) => {
                try {
                    const res = await fetch(`${API}/autus/guardrail/check`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ pressure, slots: { Base: base } })
                    });
                    const data = await res.json();
                    addLog(`GUARDRAIL: ${data.evaluation.level.toUpperCase()}`);
                    if (data.is_blocked) addLog('⛔ SYSTEM BLOCKED');
                    fetchGuardrail();
                } catch(e) {}
            };
            
            const testBoundary = async (event) => {
                try {
                    const res = await fetch(`${API}/autus/talent/boundary/check`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ gmu_id: 'STU_PH_001', event })
                    });
                    const data = await res.json();
                    addLog(`BOUNDARY ${data.rule_id}: ${data.action.toUpperCase()}`);
                } catch(e) {}
            };
            
            return (
                <div className="w-full h-screen relative">
                    {/* Header */}
                    <div className="panel top-0 left-0 w-full p-4 flex justify-between items-center">
                        <div className="glass p-4 rounded-lg">
                            <h1 className="text-3xl font-bold tracking-widest">AUTUS ATLAS</h1>
                            <div className="text-xs text-cyan-400 mt-1">DECISION SAFETY ENGINE v2.0</div>
                        </div>
                        <div className="flex gap-2">
                            {['MAIN', 'CITY', 'TALENT', 'GUARDRAIL'].map(v => (
                                <button key={v} onClick={() => setView(v)}
                                    className={`glass px-4 py-2 rounded ${view === v ? 'glow-cyan text-cyan-400' : 'text-gray-400'}`}>
                                    {v}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Status Panel */}
                    <div className="panel top-24 left-4 glass p-4 rounded-lg w-64">
                        <div className="text-xs text-gray-500 mb-2">SYSTEM STATUS</div>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                            <div>MODE</div><div className="text-cyan-400">{state.mode}</div>
                            <div>INTEGRITY</div><div className="text-green-400">{state.integrity}%</div>
                            <div>ENERGY</div><div className="text-yellow-400">{state.energy}%</div>
                            <div>GMU</div><div className="text-purple-400">{state.gmu_count}</div>
                            <div>CYCLE</div><div className="text-gray-400">{state.cycle}</div>
                        </div>
                        <div className={`mt-3 p-2 rounded text-center text-sm ${guardrail.is_blocked ? 'bg-red-900 glow-red' : 'bg-green-900/50'}`}>
                            {guardrail.is_blocked ? '⛔ BLOCKED' : '✅ OPERATIONAL'}
                        </div>
                    </div>
                    
                    {/* Logs Panel */}
                    <div className="panel top-24 right-4 glass p-4 rounded-lg w-80 max-h-64 overflow-y-auto">
                        <div className="text-xs text-gray-500 mb-2">ACTIVITY LOG</div>
                        {logs.map((log, i) => (
                            <div key={i} className="text-xs text-gray-300 py-1 border-b border-gray-800">{log}</div>
                        ))}
                    </div>
                    
                    {/* Control Panel */}
                    <div className="panel bottom-4 left-4 glass p-4 rounded-lg">
                        <div className="text-xs text-gray-500 mb-2">GUARDRAIL TEST</div>
                        <div className="flex gap-2">
                            <button onClick={() => testGuardrail(0.5, 0.5)} className="glass px-3 py-1 text-xs rounded hover:bg-white/10">NORMAL</button>
                            <button onClick={() => testGuardrail(0.8, 0.3)} className="glass px-3 py-1 text-xs rounded hover:bg-yellow-900/30 text-yellow-400">DANGER</button>
                            <button onClick={() => testGuardrail(0.95, 0.1)} className="glass px-3 py-1 text-xs rounded hover:bg-red-900/30 text-red-400">CRITICAL</button>
                        </div>
                        <div className="text-xs text-gray-500 mt-3 mb-2">BOUNDARY TEST</div>
                        <div className="flex gap-2 flex-wrap">
                            <button onClick={() => testBoundary('VISA_EXPIRY_D14')} className="glass px-3 py-1 text-xs rounded hover:bg-orange-900/30 text-orange-400">VISA D-14</button>
                            <button onClick={() => testBoundary('WORK_HOUR_EXCEEDED')} className="glass px-3 py-1 text-xs rounded hover:bg-red-900/30 text-red-400">WORK HOUR</button>
                        </div>
                    </div>
                    
                    {/* Command Input */}
                    <div className="panel bottom-4 left-1/2 -translate-x-1/2 w-96">
                        <input value={input} onChange={e => setInput(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && execute()}
                            className="glass w-full px-4 py-3 rounded-lg text-center outline-none focus:glow-cyan"
                            placeholder="COMMAND INPUT" />
                    </div>
                    
                    {/* Slot Values */}
                    <div className="panel bottom-4 right-4 glass p-4 rounded-lg">
                        <div className="text-xs text-gray-500 mb-2">7-SLOT VALUES</div>
                        {['Brain', 'Sensors', 'Heart', 'Core', 'Engines', 'Base', 'Boundary'].map(slot => (
                            <div key={slot} className="flex justify-between text-xs py-1">
                                <span className="text-gray-400">{slot}</span>
                                <span className="text-cyan-400">{(slots[slot] || 0).toFixed(2)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
