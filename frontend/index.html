<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AUTUS OS v3.8 (Analyst Edition)</title>
    <script type="importmap">
        { "imports": { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "three": "https://esm.sh/three@0.160.0", "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three", "@react-three/drei": "https://esm.sh/@react-three/drei@9.99.0?external=react,react-dom,three,@react-three/fiber" } }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #000000; color: white; font-family: monospace; overflow: hidden; }
        #root { width: 100%; height: 100vh; }
        .glass { background: rgba(10,10,10,0.8); backdrop-filter: blur(8px); border: 1px solid #333; }
        .input-glow:focus { border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame } from '@react-three/fiber';
        import { OrbitControls, Stars, Html, Trail } from '@react-three/drei';

        const API_BASE = "http://localhost:8000/autus";

        function Particle({ color, isGhost }) {
            const ref = React.useRef();
            const [pos] = useState(()=>Math.random()*Math.PI*2);
            useFrame((state) => {
                const t = state.clock.elapsedTime + pos;
                ref.current.position.y = Math.sin(t) * 2;
                ref.current.position.x = Math.cos(t) * (isGhost ? 6 : 4);
                ref.current.position.z = Math.sin(t) * (isGhost ? 6 : 4);
            });
            return (
                <group>
                    <Trail width={isGhost?1:2} length={4} color={color} attenuation={t=>t}>
                        <mesh ref={ref}><sphereGeometry args={[0.2]} /><meshBasicMaterial color={color} /></mesh>
                    </Trail>
                </group>
            );
        }

        function App() {
            const [view, setView] = useState('EXTERNAL');
            const [state, setState] = useState({ mode: 'SEED', integrity: 100 });
            const [ghosts, setGhosts] = useState(false);
            const [input, setInput] = useState("");
            const [logs, setLogs] = useState([]);

            const addLog = (msg) => setLogs(prev => [...prev, msg].slice(-5));

            const send = async (e) => {
                e.preventDefault();
                const text = input;
                setInput("");
                try {
                    const res = await fetch(`${API_BASE}/pipeline/process`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ text })
                    });
                    const data = await res.json();
                    if(data.success) setState(data.state);
                    if(data.logs) data.logs.forEach(l => addLog(l));
                } catch(e) { 
                    addLog("SIMULATION: " + text); 
                }
            };
            
            const replay = async () => {
                setGhosts(true);
                addLog("REPLAY: Analyzing past patterns...");
                setTimeout(() => setGhosts(false), 3000);
            };

            return (
                <div className="w-full h-full relative">
                    <div className="absolute top-0 left-0 p-6 z-10 w-full flex justify-between pointer-events-none">
                        <div className="glass p-4 rounded text-white pointer-events-auto">
                            <h1 className="text-2xl font-bold">AUTUS v3.8</h1>
                            <div className="text-xs text-gray-400">ANALYST EDITION</div>
                            <div className="mt-2">MODE: <span className="text-blue-400">{state.mode}</span></div>
                            <div>INTEGRITY: <span className="text-green-400">{state.integrity}%</span></div>
                        </div>
                        <div className="pointer-events-auto flex gap-2 h-10">
                            <button onClick={()=>setView('EXTERNAL')} className="glass px-4 rounded hover:bg-white/10">UNIVERSE</button>
                            <button onClick={()=>setView('LAB')} className="glass px-4 rounded text-pink-400 border-pink-900 hover:bg-pink-900/20">LAB</button>
                        </div>
                    </div>

                    {/* Logs Panel */}
                    <div className="absolute top-32 left-6 w-64 glass p-2 rounded pointer-events-none text-xs text-gray-300 font-mono">
                         {logs.map((l, i) => <div key={i}>{l}</div>)}
                    </div>

                    {view === 'LAB' && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-auto z-20">
                            <button onClick={replay} className="glass px-8 py-4 rounded text-xl font-bold text-pink-500 hover:bg-pink-900/30 border border-pink-500">RUN GHOST REPLAY</button>
                        </div>
                    )}

                    <div className="absolute bottom-10 left-1/2 -translate-x-1/2 z-20 w-96 pointer-events-auto">
                        <form onSubmit={send}>
                            <input value={input} onChange={e=>setInput(e.target.value)} className="glass w-full px-4 py-3 text-white rounded outline-none text-center input-glow" placeholder="COMMAND LINE" />
                        </form>
                    </div>

                    <Canvas>
                        <color attach="background" args={['#000']} />
                        <Stars />
                        <ambientLight intensity={0.5} />
                        <pointLight position={[10,10,10]} />
                        {ghosts && Array.from({length:5}).map((_,i)=><Particle key={i} color="#ec4899" isGhost={true} />)}
                        {!ghosts && <Particle color="#00ffff" />}
                        <OrbitControls />
                    </Canvas>
                </div>
            );
        }
        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
