<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AUTUS HQ Command</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#020408;color:#fff;font-family:system-ui,sans-serif;overflow:hidden}
    
    /* Top Bar */
    .topbar{position:fixed;top:0;left:0;right:0;height:44px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:rgba(0,0,0,.9);border-bottom:1px solid rgba(0,212,255,.15);z-index:1000}
    .brand{font-weight:900;font-size:13px;letter-spacing:.25em;color:#00d4ff}
    .nav{display:flex;gap:4px}
    .nav button{padding:8px 14px;background:transparent;border:1px solid transparent;color:rgba(255,255,255,.4);font-size:10px;letter-spacing:.1em;border-radius:4px;cursor:pointer;transition:all .2s}
    .nav button:hover{color:#fff;border-color:rgba(0,212,255,.2)}
    .nav button.active{color:#00d4ff;border-color:#00d4ff;background:rgba(0,212,255,.1)}
    .clock{font-size:11px;color:rgba(255,255,255,.5);font-variant-numeric:tabular-nums}
    
    /* Status Strip */
    .status-strip{position:fixed;top:44px;left:0;right:0;height:50px;display:flex;align-items:center;justify-content:center;gap:32px;background:rgba(0,0,0,.7);border-bottom:1px solid rgba(0,212,255,.1);z-index:999}
    .status-item{text-align:center}
    .status-value{font-size:22px;font-weight:200;color:#00d4ff;font-variant-numeric:tabular-nums}
    .status-value.green{color:#00ff88}
    .status-value.yellow{color:#ffaa00}
    .status-value.red{color:#ff4444}
    .status-label{font-size:8px;letter-spacing:.12em;opacity:.35;margin-top:2px}
    
    /* Main Viewport */
    .viewport{position:fixed;top:94px;left:0;right:300px;bottom:100px}
    
    /* Right Panel */
    .right-panel{position:fixed;top:94px;right:0;width:300px;bottom:100px;background:rgba(0,10,20,.6);border-left:1px solid rgba(0,212,255,.1);overflow-y:auto;padding:12px}
    .panel-section{margin-bottom:16px}
    .panel-title{font-size:9px;letter-spacing:.15em;color:rgba(0,212,255,.5);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(0,212,255,.1)}
    
    /* Gauge */
    .gauge-row{display:flex;align-items:center;margin:8px 0}
    .gauge-label{width:70px;font-size:10px;opacity:.5}
    .gauge-bar{flex:1;height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden;margin:0 10px}
    .gauge-fill{height:100%;background:linear-gradient(90deg,#00d4ff,#00ff88);border-radius:3px;transition:width .3s}
    .gauge-fill.warning{background:linear-gradient(90deg,#ffaa00,#ff6644)}
    .gauge-fill.danger{background:linear-gradient(90deg,#ff4444,#ff0000)}
    .gauge-value{width:45px;font-size:10px;text-align:right;font-variant-numeric:tabular-nums}
    
    /* KPI Cards */
    .kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi-card{background:rgba(0,20,40,.5);border:1px solid rgba(0,212,255,.15);border-radius:6px;padding:10px;text-align:center}
    .kpi-value{font-size:20px;font-weight:200;color:#00d4ff}
    .kpi-label{font-size:8px;opacity:.4;margin-top:4px;letter-spacing:.1em}
    .kpi-delta{font-size:9px;margin-top:4px}
    .kpi-delta.up{color:#00ff88}
    .kpi-delta.down{color:#ff4444}
    
    /* Incident List */
    .incident-list{max-height:200px;overflow-y:auto}
    .incident-item{display:flex;align-items:center;padding:8px;margin:4px 0;background:rgba(0,0,0,.3);border-left:2px solid #00d4ff;border-radius:0 4px 4px 0;font-size:10px}
    .incident-item.warning{border-color:#ffaa00}
    .incident-item.error{border-color:#ff4444}
    .incident-dot{width:6px;height:6px;border-radius:50%;margin-right:8px;background:#00d4ff}
    .incident-item.warning .incident-dot{background:#ffaa00}
    .incident-item.error .incident-dot{background:#ff4444}
    .incident-text{flex:1;opacity:.7}
    .incident-time{font-size:9px;opacity:.4}
    
    /* Bottom Timeline */
    .timeline{position:fixed;left:0;right:0;bottom:0;height:100px;background:rgba(0,5,15,.9);border-top:1px solid rgba(0,212,255,.15)}
    .timeline-header{display:flex;justify-content:space-between;padding:8px 16px;font-size:9px;opacity:.4;letter-spacing:.1em}
    .timeline-canvas{width:100%;height:60px}
    
    /* Layer Controls */
    .layer-controls{position:fixed;top:100px;left:12px;z-index:100;display:flex;flex-direction:column;gap:6px}
    .layer-btn{width:36px;height:36px;background:rgba(0,20,40,.8);border:1px solid rgba(0,212,255,.2);border-radius:6px;color:#00d4ff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .layer-btn:hover{background:rgba(0,212,255,.15)}
    .layer-btn.active{background:rgba(0,212,255,.2);border-color:#00d4ff}
    .layer-btn.off{opacity:.3}
    
    /* Alert Banner */
    .alert-banner{position:fixed;top:94px;left:0;right:300px;padding:10px 20px;background:rgba(255,68,68,.15);border-bottom:1px solid #ff4444;display:none;align-items:center;gap:12px;z-index:50}
    .alert-banner.active{display:flex}
    .alert-icon{font-size:16px}
    .alert-text{flex:1;font-size:11px}
    .alert-action{padding:6px 12px;background:rgba(255,68,68,.2);border:1px solid #ff4444;border-radius:4px;color:#ff4444;font-size:10px;cursor:pointer}
    
    /* Beacon */
    .beacon{position:fixed;top:100px;right:312px;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;z-index:100;transition:all .3s}
    .beacon.green{background:rgba(0,255,136,.15);border:2px solid rgba(0,255,136,.4);color:#00ff88}
    .beacon.yellow{background:rgba(255,170,0,.15);border:2px solid rgba(255,170,0,.4);color:#ffaa00}
    .beacon.red{background:rgba(255,68,68,.2);border:2px solid rgba(255,68,68,.5);color:#ff4444;animation:beacon-pulse 1s infinite}
    @keyframes beacon-pulse{50%{transform:scale(1.05);border-color:#ff4444}}
  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="topbar">
    <span class="brand">AUTUS HQ</span>
    <nav class="nav">
      <button class="active" data-screen="globe">GLOBAL</button>
      <button data-screen="network">NETWORK</button>
      <button data-screen="radar">RADAR</button>
      <button data-screen="analytics">ANALYTICS</button>
      <button data-screen="control">CONTROL</button>
    </nav>
    <span class="clock" id="clock">--:--:--</span>
  </header>
  
  <!-- Status Strip -->
  <div class="status-strip">
    <div class="status-item"><div class="status-value" id="s-entropy">0.000</div><div class="status-label">ENTROPY</div></div>
    <div class="status-item"><div class="status-value" id="s-pressure">0.00</div><div class="status-label">PRESSURE</div></div>
    <div class="status-item"><div class="status-value" id="s-flow">0.00</div><div class="status-label">FLOW</div></div>
    <div class="status-item"><div class="status-value" id="s-energy">0.50</div><div class="status-label">ENERGY</div></div>
    <div class="status-item"><div class="status-value" id="s-risk">0.00</div><div class="status-label">RISK</div></div>
    <div class="status-item"><div class="status-value green" id="s-status">GREEN</div><div class="status-label">STATUS</div></div>
  </div>
  
  <!-- Beacon -->
  <div class="beacon green" id="beacon">‚óè</div>
  
  <!-- Alert Banner -->
  <div class="alert-banner" id="alertBanner">
    <span class="alert-icon">‚ö†</span>
    <span class="alert-text" id="alertText">High entropy detected</span>
    <button class="alert-action">ACKNOWLEDGE</button>
  </div>
  
  <!-- Layer Controls -->
  <div class="layer-controls">
    <button class="layer-btn active" data-layer="globe" title="Globe">üåç</button>
    <button class="layer-btn active" data-layer="network" title="Network">‚óâ</button>
    <button class="layer-btn active" data-layer="radar" title="Radar">‚óé</button>
    <button class="layer-btn" data-layer="heat" title="Heat">üî•</button>
    <button class="layer-btn" data-layer="grid" title="Grid">‚ñ¶</button>
  </div>
  
  <!-- Main Viewport -->
  <div class="viewport">
    <iframe id="mainFrame" src="/frontend/globe-hq.html" style="width:100%;height:100%;border:none"></iframe>
  </div>
  
  <!-- Right Panel -->
  <aside class="right-panel">
    <div class="panel-section">
      <div class="panel-title">SYSTEM STATE</div>
      <div class="gauge-row">
        <span class="gauge-label">Pressure</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-pressure" style="width:0%"></div></div>
        <span class="gauge-value" id="v-pressure">0.00</span>
      </div>
      <div class="gauge-row">
        <span class="gauge-label">Release</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-release" style="width:0%"></div></div>
        <span class="gauge-value" id="v-release">0.00</span>
      </div>
      <div class="gauge-row">
        <span class="gauge-label">Entropy</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-entropy" style="width:0%"></div></div>
        <span class="gauge-value" id="v-entropy">0.000</span>
      </div>
      <div class="gauge-row">
        <span class="gauge-label">Gravity</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-gravity" style="width:0%"></div></div>
        <span class="gauge-value" id="v-gravity">0.500</span>
      </div>
    </div>
    
    <div class="panel-section">
      <div class="panel-title">KEY METRICS</div>
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-value" id="kpi-tick">0</div>
          <div class="kpi-label">TICK</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value" id="kpi-cycle">0</div>
          <div class="kpi-label">CYCLE</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value" id="kpi-systems">4</div>
          <div class="kpi-label">SYSTEMS</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value" id="kpi-failure">--</div>
          <div class="kpi-label">FAILURE IN</div>
        </div>
      </div>
    </div>
    
    <div class="panel-section">
      <div class="panel-title">INCIDENTS</div>
      <div class="incident-list" id="incidentList">
        <div class="incident-item"><div class="incident-dot"></div><span class="incident-text">System initialized</span><span class="incident-time">00:00</span></div>
      </div>
    </div>
    
    <div class="panel-section">
      <div class="panel-title">OUTCOME (THIS PERIOD)</div>
      <div class="gauge-row">
        <span class="gauge-label">ŒîEntropy</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-dentropy" style="width:0%;background:#00ff88"></div></div>
        <span class="gauge-value" id="v-dentropy">+0.00</span>
      </div>
      <div class="gauge-row">
        <span class="gauge-label">ŒîPressure</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-dpressure" style="width:0%;background:#00ff88"></div></div>
        <span class="gauge-value" id="v-dpressure">+0.00</span>
      </div>
      <div class="gauge-row">
        <span class="gauge-label">Billable</span>
        <div class="gauge-bar"><div class="gauge-fill" id="g-billable" style="width:0%;background:#00d4ff"></div></div>
        <span class="gauge-value" id="v-billable">‚Ç©0</span>
      </div>
    </div>
  </aside>
  
  <!-- Timeline -->
  <div class="timeline">
    <div class="timeline-header">
      <span>TIMELINE</span>
      <span id="timeRange">Last 60 seconds</span>
    </div>
    <canvas id="timelineCanvas" class="timeline-canvas"></canvas>
  </div>
  
  <script>
// === Screen Navigation ===
const screens = {
  globe: '/frontend/globe-hq.html',
  network: '/frontend/network-hq.html',
  radar: '/frontend/radar-hq.html',
  analytics: '/frontend/sdf-demo.html',
  control: '/frontend/hud-system.html'
};

document.querySelectorAll('.nav button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('mainFrame').src = screens[btn.dataset.screen];
  };
});

// === Layer Toggle ===
document.querySelectorAll('.layer-btn').forEach(btn => {
  btn.onclick = () => {
    btn.classList.toggle('active');
    btn.classList.toggle('off', !btn.classList.contains('active'));
  };
});

// === Clock ===
function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

// === Timeline Canvas ===
const timelineCanvas = document.getElementById('timelineCanvas');
const tlCtx = timelineCanvas.getContext('2d');
let entropyHistory = [];
let pressureHistory = [];
const MAX_HISTORY = 120;

function drawTimeline() {
  const w = timelineCanvas.width = timelineCanvas.offsetWidth;
  const h = timelineCanvas.height = 60;
  
  tlCtx.clearRect(0, 0, w, h);
  
  // Grid
  tlCtx.strokeStyle = 'rgba(0,212,255,0.1)';
  tlCtx.lineWidth = 1;
  for (let i = 0; i < 6; i++) {
    const y = i * h / 5;
    tlCtx.beginPath();
    tlCtx.moveTo(0, y);
    tlCtx.lineTo(w, y);
    tlCtx.stroke();
  }
  
  // Entropy line
  if (entropyHistory.length > 1) {
    tlCtx.strokeStyle = '#ffaa00';
    tlCtx.lineWidth = 2;
    tlCtx.beginPath();
    entropyHistory.forEach((v, i) => {
      const x = (i / (MAX_HISTORY - 1)) * w;
      const y = h - v * h * 2;
      if (i === 0) tlCtx.moveTo(x, y);
      else tlCtx.lineTo(x, y);
    });
    tlCtx.stroke();
  }
  
  // Pressure line
  if (pressureHistory.length > 1) {
    tlCtx.strokeStyle = '#00d4ff';
    tlCtx.lineWidth = 2;
    tlCtx.beginPath();
    pressureHistory.forEach((v, i) => {
      const x = (i / (MAX_HISTORY - 1)) * w;
      const y = h - v * h;
      if (i === 0) tlCtx.moveTo(x, y);
      else tlCtx.lineTo(x, y);
    });
    tlCtx.stroke();
  }
}

// === Fetch Status ===
let lastStatus = null;
let incidents = [];

async function fetchStatus() {
  try {
    const r = await fetch('/status');
    const s = await r.json();
    lastStatus = s;
    
    const sig = s.signals;
    const out = s.output;
    const risk = Math.min(1, sig.entropy * 1.5 + sig.pressure * 0.5);
    
    // Status strip
    document.getElementById('s-entropy').textContent = sig.entropy.toFixed(3);
    document.getElementById('s-pressure').textContent = sig.pressure.toFixed(2);
    document.getElementById('s-flow').textContent = sig.release.toFixed(2);
    document.getElementById('s-energy').textContent = sig.gravity.toFixed(2);
    document.getElementById('s-risk').textContent = risk.toFixed(2);
    
    const statusEl = document.getElementById('s-status');
    statusEl.textContent = out.status;
    statusEl.className = 'status-value ' + out.status.toLowerCase();
    
    // Beacon
    const beacon = document.getElementById('beacon');
    beacon.className = 'beacon ' + out.status.toLowerCase();
    beacon.textContent = out.status === 'GREEN' ? '‚óè' : out.status === 'YELLOW' ? '‚ñ≤' : '‚ñ†';
    
    // Alert banner
    const alertBanner = document.getElementById('alertBanner');
    if (sig.entropy > 0.3 || risk > 0.5) {
      alertBanner.classList.add('active');
      document.getElementById('alertText').textContent = 
        sig.entropy > 0.3 ? `High entropy: ${sig.entropy.toFixed(3)}` : `Elevated risk: ${risk.toFixed(2)}`;
    } else {
      alertBanner.classList.remove('active');
    }
    
    // Gauges
    document.getElementById('g-pressure').style.width = (sig.pressure * 100) + '%';
    document.getElementById('v-pressure').textContent = sig.pressure.toFixed(2);
    document.getElementById('g-release').style.width = (sig.release * 100) + '%';
    document.getElementById('v-release').textContent = sig.release.toFixed(2);
    document.getElementById('g-entropy').style.width = (sig.entropy * 200) + '%';
    document.getElementById('v-entropy').textContent = sig.entropy.toFixed(3);
    document.getElementById('g-gravity').style.width = (sig.gravity * 100) + '%';
    document.getElementById('v-gravity').textContent = sig.gravity.toFixed(3);
    
    // Gauge colors
    const entropyGauge = document.getElementById('g-entropy');
    entropyGauge.className = 'gauge-fill' + (sig.entropy > 0.3 ? ' danger' : sig.entropy > 0.2 ? ' warning' : '');
    
    // KPIs
    document.getElementById('kpi-tick').textContent = s.tick;
    document.getElementById('kpi-cycle').textContent = s.cycle;
    document.getElementById('kpi-failure').textContent = out.failure_in_ticks || '--';
    
    // History
    entropyHistory.push(sig.entropy);
    pressureHistory.push(sig.pressure);
    if (entropyHistory.length > MAX_HISTORY) entropyHistory.shift();
    if (pressureHistory.length > MAX_HISTORY) pressureHistory.shift();
    
    // Incidents
    if (sig.entropy > 0.25 && (!incidents.length || incidents[0].type !== 'entropy')) {
      incidents.unshift({ type: 'entropy', text: `Entropy spike: ${sig.entropy.toFixed(3)}`, time: new Date(), level: 'warning' });
    }
    if (out.status === 'RED' && (!incidents.length || incidents[0].type !== 'red')) {
      incidents.unshift({ type: 'red', text: 'System status: RED', time: new Date(), level: 'error' });
    }
    if (incidents.length > 10) incidents.pop();
    
    renderIncidents();
    drawTimeline();
    
  } catch(e) {
    console.error('Status fetch error:', e);
  }
}

function renderIncidents() {
  const list = document.getElementById('incidentList');
  list.innerHTML = incidents.map(inc => `
    <div class="incident-item ${inc.level || ''}">
      <div class="incident-dot"></div>
      <span class="incident-text">${inc.text}</span>
      <span class="incident-time">${inc.time.toLocaleTimeString().slice(0,5)}</span>
    </div>
  `).join('') || '<div class="incident-item"><div class="incident-dot"></div><span class="incident-text">All systems nominal</span></div>';
}

// === Init ===
fetchStatus();
setInterval(fetchStatus, 1000);
drawTimeline();
  </script>
</body>
</html>
