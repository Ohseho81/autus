<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTUS — Unified Interface</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #050608;
            color: #00f0ff;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }
        
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        
        /* Page Tabs */
        .page-tabs {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }
        
        .page-tab {
            width: 50px; height: 50px;
            border: 2px solid rgba(0, 240, 255, 0.3);
            border-radius: 12px;
            background: rgba(5, 6, 8, 0.8);
            color: rgba(0, 240, 255, 0.5);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .page-tab:hover {
            border-color: rgba(0, 240, 255, 0.6);
            color: rgba(0, 240, 255, 0.8);
        }
        
        .page-tab.active {
            border-color: #00f0ff;
            color: #00f0ff;
            background: rgba(0, 240, 255, 0.1);
        }
        
        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(5, 6, 8, 0.9);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            z-index: 100;
            min-width: 180px;
            font-family: 'SF Mono', monospace;
        }
        
        .hud-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .hud-label { color: rgba(0, 240, 255, 0.5); }
        .hud-value { font-weight: 600; color: #00f0ff; }
        .hud-value.warning { color: #ff4444; }
        
        /* Mode Indicator */
        .mode-indicator {
            position: fixed;
            top: 20px;
            right: 90px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 2px;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .mode-indicator.sim {
            background: rgba(255, 136, 0, 0.15);
            border: 1px dashed #ff8800;
            color: #ff8800;
        }
        
        .mode-indicator.live {
            background: rgba(0, 240, 255, 0.15);
            border: 1px solid #00f0ff;
            color: #00f0ff;
        }
        
        /* Controls Panel */
        .controls-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: rgba(5, 6, 8, 0.9);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            z-index: 100;
            min-width: 280px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .control-label {
            width: 90px;
            font-size: 11px;
            color: rgba(0, 240, 255, 0.6);
            letter-spacing: 1px;
        }
        
        .control-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: rgba(0, 240, 255, 0.2);
            border-radius: 2px;
            margin: 0 12px;
        }
        
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: #00f0ff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px #00f0ff;
        }
        
        .control-value {
            width: 45px;
            text-align: right;
            font-size: 12px;
            font-family: 'SF Mono', monospace;
            color: #00f0ff;
        }
        
        /* Commit Button */
        .commit-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 28px;
            border: 2px solid #00f0ff;
            border-radius: 25px;
            background: rgba(0, 240, 255, 0.1);
            color: #00f0ff;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .commit-btn:hover {
            background: rgba(0, 240, 255, 0.2);
            transform: scale(1.02);
        }
        
        .commit-btn:active {
            transform: scale(0.98);
        }
        
        .commit-btn.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        /* Page Title */
        .page-title {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            letter-spacing: 3px;
            color: rgba(0, 240, 255, 0.4);
            z-index: 100;
        }
        
        /* Page-specific labels */
        .page-labels {
            position: fixed;
            z-index: 50;
            pointer-events: none;
        }
        
        .label {
            position: fixed;
            font-size: 11px;
            letter-spacing: 1px;
            color: rgba(0, 240, 255, 0.5);
        }
        
        /* Long-press HUD */
        .longpress-hud {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(5, 6, 8, 0.95);
            border: 1px solid rgba(0, 240, 255, 0.4);
            border-radius: 16px;
            padding: 24px 32px;
            z-index: 200;
            display: none;
            font-family: 'SF Mono', monospace;
        }
        
        .longpress-hud.visible { display: block; }
        
        .longpress-row {
            display: flex;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        /* Mandala slots */
        .mandala-slot {
            position: fixed;
            z-index: 60;
            cursor: pointer;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mandala-slot.visible { opacity: 1; }
        
        .slot-icon {
            width: 32px; height: 32px;
            margin: 0 auto 4px;
            opacity: 0.6;
        }
        
        .slot-name {
            font-size: 10px;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <!-- Page Tabs -->
    <div class="page-tabs">
        <button class="page-tab active" data-page="1">1</button>
        <button class="page-tab" data-page="2">2</button>
        <button class="page-tab" data-page="3">3</button>
    </div>
    
    <!-- Mode Indicator -->
    <div class="mode-indicator sim" id="mode-indicator">SIM</div>
    
    <!-- HUD -->
    <div class="hud" id="hud">
        <div class="hud-row">
            <span class="hud-label">DENSITY</span>
            <span class="hud-value" id="hud-density">0.50</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">STABILITY</span>
            <span class="hud-value" id="hud-stability">0.70</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">SIGMA (σ)</span>
            <span class="hud-value" id="hud-sigma">0.30</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">ENERGY</span>
            <span class="hud-value" id="hud-energy">0.50</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">P_OUTCOME</span>
            <span class="hud-value" id="hud-p-outcome">0%</span>
        </div>
    </div>
    
    <!-- Controls Panel (changes per page) -->
    <div class="controls-panel" id="controls">
        <!-- Page 1 Controls -->
        <div id="controls-page1">
            <div class="control-row">
                <span class="control-label">MASS</span>
                <input type="range" class="control-slider" id="slider-mass" min="-50" max="50" value="0">
                <span class="control-value" id="value-mass">0.00</span>
            </div>
            <div class="control-row">
                <span class="control-label">VOLUME</span>
                <input type="range" class="control-slider" id="slider-volume" min="1" max="100" value="50">
                <span class="control-value" id="value-volume">0.50</span>
            </div>
            <div class="control-row">
                <span class="control-label">HORIZON</span>
                <select id="select-horizon" style="flex:1; margin:0 12px; background:#0a0c10; border:1px solid rgba(0,240,255,0.3); color:#00f0ff; padding:6px; border-radius:4px;">
                    <option value="H1">H1</option>
                    <option value="D1" selected>D1</option>
                    <option value="D7">D7</option>
                    <option value="D30">D30</option>
                    <option value="D180">D180</option>
                </select>
            </div>
        </div>
        
        <!-- Page 2 Controls (hidden by default) -->
        <div id="controls-page2" style="display:none;">
            <div class="control-row">
                <span class="control-label">MASS FILTER</span>
                <input type="range" class="control-slider" id="slider-mass-filter" min="0" max="100" value="0">
                <span class="control-value" id="value-mass-filter">0.00</span>
            </div>
            <div class="control-row">
                <span class="control-label">FLOW FILTER</span>
                <input type="range" class="control-slider" id="slider-flow-filter" min="0" max="100" value="0">
                <span class="control-value" id="value-flow-filter">0.00</span>
            </div>
            <div class="control-row">
                <span class="control-label">SIGMA</span>
                <input type="range" class="control-slider" id="slider-sigma" min="-50" max="50" value="0">
                <span class="control-value" id="value-sigma-delta">0.00</span>
            </div>
        </div>
        
        <!-- Page 3 Controls (hidden by default) -->
        <div id="controls-page3" style="display:none;">
            <div style="text-align:center; font-size:11px; color:rgba(0,240,255,0.5); letter-spacing:1px;">
                TAP MANDALA SLOTS TO ALLOCATE
            </div>
        </div>
    </div>
    
    <!-- Commit Button -->
    <button class="commit-btn" id="commit-btn">COMMIT</button>
    
    <!-- Page Title -->
    <div class="page-title" id="page-title">AUTUS / PAGE 1 — GOAL CALIBRATION</div>
    
    <!-- Long-press HUD -->
    <div class="longpress-hud" id="longpress-hud">
        <div class="longpress-row">
            <span>Density:</span>
            <span id="lp-density">0.50</span>
        </div>
        <div class="longpress-row">
            <span>Stability:</span>
            <span id="lp-stability">0.70</span>
        </div>
        <div class="longpress-row">
            <span>P_outcome:</span>
            <span id="lp-p-outcome">0%</span>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ================================================================
        // CONFIGURATION
        // ================================================================
        
        const CONFIG = {
            API_BASE: 'http://localhost:8001',
            SESSION_ID: 'autus_unified_' + Date.now(),
            POLL_INTERVAL: 2000
        };
        
        const CYAN = 0x00f0ff;
        const RED_TINT = 0x401030;
        const DARK_TEAL = 0x002025;
        
        // ================================================================
        // STATE
        // ================================================================
        
        const appState = {
            mode: 'SIM',
            page: 1,
            measure: {
                density: 0.5,
                stability: 0.7,
                sigma: 0.3,
                E: 0.5
            },
            forecast: {
                P_outcome: 0
            },
            draft: {
                page1: { mass_mod: 0, volume_override: 0.5, horizon: 'D1' },
                page2: { sigma_delta: 0, mass_filter: 0, flow_filter: 0 },
                page3: { allocations: { N: 0.125, NE: 0.125, E: 0.125, SE: 0.125, S: 0.125, SW: 0.125, W: 0.125, NW: 0.125 } }
            }
        };
        
        // ================================================================
        // THREE.JS SETUP
        // ================================================================
        
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setClearColor(0x050608, 1);
        container.appendChild(renderer.domElement);
        
        // Layers
        const layers = {
            core: null,
            graph: null,
            mandala: null,
            particles: null
        };
        
        // ================================================================
        // CORE LAYER (Page 1, 3)
        // ================================================================
        
        function createCoreLayer() {
            const group = new THREE.Group();
            
            // Core sphere
            const coreGeometry = new THREE.SphereGeometry(1.2, 64, 64);
            const coreMaterial = new THREE.MeshBasicMaterial({
                color: CYAN,
                transparent: true,
                opacity: 0.25
            });
            const core = new THREE.Mesh(coreGeometry, coreMaterial);
            group.add(core);
            
            // Inner glow
            const innerGeometry = new THREE.SphereGeometry(1.0, 64, 64);
            const innerMaterial = new THREE.MeshBasicMaterial({
                color: 0x88ffff,
                transparent: true,
                opacity: 0.4
            });
            const inner = new THREE.Mesh(innerGeometry, innerMaterial);
            group.add(inner);
            
            // Rim
            const rimGeometry = new THREE.RingGeometry(1.18, 1.22, 128);
            const rimMaterial = new THREE.MeshBasicMaterial({
                color: CYAN,
                transparent: true,
                opacity: 0.9,
                side: THREE.DoubleSide
            });
            const rim = new THREE.Mesh(rimGeometry, rimMaterial);
            group.add(rim);
            
            // Volume ring
            const volumeRingGeometry = new THREE.RingGeometry(2.0, 2.03, 128);
            const volumeRingMaterial = new THREE.MeshBasicMaterial({
                color: CYAN,
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            const volumeRing = new THREE.Mesh(volumeRingGeometry, volumeRingMaterial);
            group.add(volumeRing);
            
            return { group, core, inner, rim, volumeRing };
        }
        
        // ================================================================
        // GRAPH LAYER (Page 2)
        // ================================================================
        
        function createGraphLayer() {
            const group = new THREE.Group();
            const nodes = [];
            const edges = [];
            
            // Concentric rings
            for (let i = 1; i <= 5; i++) {
                const ringGeometry = new THREE.RingGeometry(i * 0.5 - 0.01, i * 0.5 + 0.01, 128);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: CYAN,
                    transparent: true,
                    opacity: 0.12,
                    side: THREE.DoubleSide
                });
                group.add(new THREE.Mesh(ringGeometry, ringMaterial));
            }
            
            // Self node
            const selfGeometry = new THREE.SphereGeometry(0.3, 32, 32);
            const selfMaterial = new THREE.MeshBasicMaterial({ color: CYAN, transparent: true, opacity: 0.4 });
            const selfNode = new THREE.Mesh(selfGeometry, selfMaterial);
            group.add(selfNode);
            nodes.push({ mesh: selfNode, id: 'SELF' });
            
            // Outer nodes
            const nodeData = [
                { angle: 0.5, radius: 1.2 },
                { angle: 1.2, radius: 1.8 },
                { angle: 2.1, radius: 1.4 },
                { angle: 3.0, radius: 2.0 },
                { angle: 4.0, radius: 1.6 },
                { angle: 5.0, radius: 1.3 }
            ];
            
            nodeData.forEach((data, i) => {
                const nodeGeometry = new THREE.SphereGeometry(0.12, 16, 16);
                const nodeMaterial = new THREE.MeshBasicMaterial({ color: CYAN, transparent: true, opacity: 0.5 });
                const node = new THREE.Mesh(nodeGeometry, nodeMaterial);
                node.position.set(Math.cos(data.angle) * data.radius, Math.sin(data.angle) * data.radius, 0);
                group.add(node);
                nodes.push({ mesh: node, id: `N${i}` });
                
                // Edge to self
                const points = [new THREE.Vector3(0, 0, 0), node.position.clone()];
                const edgeGeometry = new THREE.BufferGeometry().setFromPoints(points);
                const edgeMaterial = new THREE.LineBasicMaterial({ color: CYAN, transparent: true, opacity: 0.2 });
                const edge = new THREE.Line(edgeGeometry, edgeMaterial);
                group.add(edge);
                edges.push(edge);
            });
            
            return { group, nodes, edges };
        }
        
        // ================================================================
        // MANDALA LAYER (Page 3)
        // ================================================================
        
        function createMandalaLayer() {
            const group = new THREE.Group();
            const segments = [];
            
            const innerRadius = 0.7;
            const outerRadius = 2.0;
            const segmentCount = 8;
            const redSlots = [0, 1, 3, 5, 7];
            
            for (let i = 0; i < segmentCount; i++) {
                const angleStart = (i / segmentCount) * Math.PI * 2 - Math.PI / 2 - Math.PI / segmentCount;
                const angleEnd = ((i + 1) / segmentCount) * Math.PI * 2 - Math.PI / 2 - Math.PI / segmentCount;
                
                const shape = new THREE.Shape();
                for (let j = 0; j <= 16; j++) {
                    const angle = angleStart + (angleEnd - angleStart) * (j / 16);
                    const x = Math.cos(angle) * outerRadius;
                    const y = Math.sin(angle) * outerRadius;
                    if (j === 0) shape.moveTo(x, y);
                    else shape.lineTo(x, y);
                }
                for (let j = 16; j >= 0; j--) {
                    const angle = angleStart + (angleEnd - angleStart) * (j / 16);
                    shape.lineTo(Math.cos(angle) * innerRadius, Math.sin(angle) * innerRadius);
                }
                shape.closePath();
                
                const geometry = new THREE.ShapeGeometry(shape);
                const material = new THREE.MeshBasicMaterial({
                    color: redSlots.includes(i) ? RED_TINT : DARK_TEAL,
                    transparent: true,
                    opacity: 0.6,
                    side: THREE.DoubleSide
                });
                const segment = new THREE.Mesh(geometry, material);
                group.add(segment);
                segments.push(segment);
            }
            
            // Center core (smaller)
            const coreGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const coreMaterial = new THREE.MeshBasicMaterial({ color: CYAN, transparent: true, opacity: 0.2 });
            const core = new THREE.Mesh(coreGeometry, coreMaterial);
            group.add(core);
            
            return { group, segments, core };
        }
        
        // ================================================================
        // PARTICLES
        // ================================================================
        
        function createParticles() {
            const count = 1200;
            const positions = new Float32Array(count * 3);
            
            for (let i = 0; i < count * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 14;
                positions[i + 1] = (Math.random() - 0.5) * 10;
                positions[i + 2] = (Math.random() - 0.5) * 6;
            }
            
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: CYAN,
                size: 0.02,
                transparent: true,
                opacity: 0.4,
                blending: THREE.AdditiveBlending
            });
            
            return new THREE.Points(geometry, material);
        }
        
        // ================================================================
        // INITIALIZATION
        // ================================================================
        
        function init() {
            layers.core = createCoreLayer();
            layers.graph = createGraphLayer();
            layers.mandala = createMandalaLayer();
            layers.particles = createParticles();
            
            scene.add(layers.core.group);
            scene.add(layers.graph.group);
            scene.add(layers.mandala.group);
            scene.add(layers.particles);
            
            setPage(1);
            animate();
            setupEventListeners();
            fetchState();
            setInterval(fetchState, CONFIG.POLL_INTERVAL);
        }
        
        // ================================================================
        // PAGE SWITCHING
        // ================================================================
        
        function setPage(page) {
            appState.page = page;
            
            // Hide all
            layers.core.group.visible = false;
            layers.graph.group.visible = false;
            layers.mandala.group.visible = false;
            
            // Show controls
            document.getElementById('controls-page1').style.display = 'none';
            document.getElementById('controls-page2').style.display = 'none';
            document.getElementById('controls-page3').style.display = 'none';
            
            switch (page) {
                case 1:
                    layers.core.group.visible = true;
                    camera.position.set(0, 0, 5);
                    document.getElementById('controls-page1').style.display = 'block';
                    document.getElementById('page-title').textContent = 'AUTUS / PAGE 1 — GOAL CALIBRATION';
                    break;
                case 2:
                    layers.graph.group.visible = true;
                    camera.position.set(0, 1, 6);
                    document.getElementById('controls-page2').style.display = 'block';
                    document.getElementById('page-title').textContent = 'AUTUS / PAGE 2 — ROUTE / TOPOLOGY';
                    break;
                case 3:
                    layers.mandala.group.visible = true;
                    camera.position.set(0, 0, 4);
                    document.getElementById('controls-page3').style.display = 'block';
                    document.getElementById('page-title').textContent = 'AUTUS / PAGE 3 — MANDALA INVESTMENT';
                    break;
            }
            
            camera.lookAt(0, 0, 0);
            
            // Update tabs
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.classList.toggle('active', parseInt(tab.dataset.page) === page);
            });
        }
        
        // ================================================================
        // API
        // ================================================================
        
        async function fetchState() {
            try {
                const res = await fetch(`${CONFIG.API_BASE}/state?session_id=${CONFIG.SESSION_ID}`);
                const data = await res.json();
                
                appState.mode = data.ui?.mode || 'SIM';
                appState.measure = data.measure || appState.measure;
                appState.forecast = data.forecast || appState.forecast;
                
                updateHUD();
                updateModeIndicator();
            } catch (e) {
                console.warn('API fetch failed:', e);
            }
        }
        
        async function sendDraftUpdate(page, patch) {
            try {
                const res = await fetch(`${CONFIG.API_BASE}/draft/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: CONFIG.SESSION_ID,
                        t_ms: Date.now(),
                        page: page,
                        patch: patch
                    })
                });
                const data = await res.json();
                appState.mode = 'SIM';
                updateModeIndicator();
                return data;
            } catch (e) {
                console.error('Draft update failed:', e);
            }
        }
        
        async function commit() {
            try {
                const res = await fetch(`${CONFIG.API_BASE}/commit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: CONFIG.SESSION_ID,
                        t_ms: Date.now()
                    })
                });
                const data = await res.json();
                appState.mode = 'LIVE';
                updateModeIndicator();
                fetchState();
                return data;
            } catch (e) {
                console.error('Commit failed:', e);
            }
        }
        
        // ================================================================
        // UI UPDATE
        // ================================================================
        
        function updateHUD() {
            const m = appState.measure;
            document.getElementById('hud-density').textContent = (m.density || 0).toFixed(2);
            document.getElementById('hud-stability').textContent = (m.stability || 0).toFixed(2);
            document.getElementById('hud-sigma').textContent = (m.sigma || 0).toFixed(2);
            document.getElementById('hud-energy').textContent = (m.E || 0).toFixed(2);
            document.getElementById('hud-p-outcome').textContent = Math.round((appState.forecast.P_outcome || 0) * 100) + '%';
            
            // Warning for high sigma
            const sigmaEl = document.getElementById('hud-sigma');
            sigmaEl.classList.toggle('warning', m.sigma > 0.6);
            
            // Long-press HUD
            document.getElementById('lp-density').textContent = (m.density || 0).toFixed(2);
            document.getElementById('lp-stability').textContent = (m.stability || 0).toFixed(2);
            document.getElementById('lp-p-outcome').textContent = Math.round((appState.forecast.P_outcome || 0) * 100) + '%';
        }
        
        function updateModeIndicator() {
            const el = document.getElementById('mode-indicator');
            el.textContent = appState.mode;
            el.className = 'mode-indicator ' + appState.mode.toLowerCase();
        }
        
        // ================================================================
        // EVENT LISTENERS
        // ================================================================
        
        function setupEventListeners() {
            // Page tabs
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.addEventListener('click', () => setPage(parseInt(tab.dataset.page)));
            });
            
            // Commit button
            document.getElementById('commit-btn').addEventListener('click', commit);
            
            // Page 1 controls
            document.getElementById('slider-mass').addEventListener('input', (e) => {
                const val = e.target.value / 100;
                document.getElementById('value-mass').textContent = val.toFixed(2);
                sendDraftUpdate(1, { mass_mod: val });
            });
            
            document.getElementById('slider-volume').addEventListener('input', (e) => {
                const val = e.target.value / 100;
                document.getElementById('value-volume').textContent = val.toFixed(2);
                sendDraftUpdate(1, { volume_override: val });
            });
            
            document.getElementById('select-horizon').addEventListener('change', (e) => {
                sendDraftUpdate(1, { horizon: e.target.value });
            });
            
            // Page 2 controls
            document.getElementById('slider-sigma').addEventListener('input', (e) => {
                const val = e.target.value / 100;
                document.getElementById('value-sigma-delta').textContent = val.toFixed(2);
                sendDraftUpdate(2, { sigma_delta: val });
            });
            
            // Long-press
            let longPressTimer;
            container.addEventListener('mousedown', () => {
                longPressTimer = setTimeout(() => {
                    document.getElementById('longpress-hud').classList.add('visible');
                }, 500);
            });
            
            container.addEventListener('mouseup', () => {
                clearTimeout(longPressTimer);
                document.getElementById('longpress-hud').classList.remove('visible');
            });
            
            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            // Swipe for page navigation
            let touchStartY = 0;
            container.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            });
            
            container.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const diff = touchStartY - touchEndY;
                
                if (Math.abs(diff) > 50) {
                    if (diff > 0 && appState.page < 3) {
                        setPage(appState.page + 1);
                    } else if (diff < 0 && appState.page > 1) {
                        setPage(appState.page - 1);
                    }
                }
            });
        }
        
        // ================================================================
        // ANIMATION
        // ================================================================
        
        let time = 0;
        
        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;
            
            // Core pulse
            if (layers.core.group.visible) {
                const pulse = 1 + Math.sin(time * 2) * 0.015;
                layers.core.core.scale.set(pulse, pulse, pulse);
                layers.core.inner.scale.set(pulse * 0.98, pulse * 0.98, pulse * 0.98);
                layers.core.core.rotation.y += 0.002;
            }
            
            // Graph nodes
            if (layers.graph.group.visible) {
                layers.graph.nodes.forEach((node, i) => {
                    const scale = 1 + Math.sin(time * 3 + i) * 0.03;
                    node.mesh.scale.set(scale, scale, scale);
                });
            }
            
            // Mandala core
            if (layers.mandala.group.visible) {
                const pulse = 1 + Math.sin(time * 2) * 0.02;
                layers.mandala.core.scale.set(pulse, pulse, pulse);
            }
            
            // Particles
            layers.particles.rotation.y += 0.0003;
            
            renderer.render(scene, camera);
        }
        
        // Start
        init();
    </script>
</body>
</html>
