<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTUS — BEZOS EDITION</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --cyan: #00f0ff;
            --cyan-dim: rgba(0, 240, 255, 0.3);
            --cyan-dark: rgba(0, 240, 255, 0.1);
            --bg: #030405;
            --panel: rgba(3, 4, 5, 0.95);
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff3344;
            --gold: #ffd700;
        }
        
        body {
            background: var(--bg);
            color: var(--cyan);
            font-family: 'SF Pro Display', -apple-system, sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        
        /* Technical Glow Background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse at 50% 50%, rgba(0, 240, 255, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 20% 80%, rgba(0, 255, 136, 0.02) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 20%, rgba(255, 170, 0, 0.02) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
        }
        
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Loading */
        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
            transition: opacity 0.6s;
        }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 60px; height: 60px;
            border: 2px solid var(--cyan-dim);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 10px; letter-spacing: 4px; opacity: 0.5; }
        
        /* Header */
        .header {
            position: fixed; top: 0; left: 0; right: 0;
            height: 55px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(3,4,5,0.9), transparent);
        }
        
        .logo {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-badge {
            padding: 3px 8px;
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid var(--gold);
            border-radius: 4px;
            font-size: 8px;
            color: var(--gold);
        }
        
        .status-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-badge {
            display: flex; align-items: center; gap: 6px;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 9px;
            letter-spacing: 1px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .status-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .mode-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 2px;
        }
        .mode-badge.sim { background: var(--cyan-dark); border: 1px solid var(--cyan); }
        .mode-badge.live { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--success); color: var(--success); }
        
        /* Page Title */
        .page-title {
            position: fixed;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            letter-spacing: 6px;
            opacity: 0.35;
            z-index: 100;
        }
        
        /* Page Nav */
        .page-nav {
            position: fixed;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 8px;
            z-index: 100;
        }
        
        .page-btn {
            width: 42px; height: 42px;
            border: 1px solid var(--cyan-dim);
            border-radius: 8px;
            background: var(--panel);
            color: var(--cyan-dim);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn:hover { border-color: var(--cyan); color: var(--cyan); }
        .page-btn.active {
            background: var(--cyan-dark);
            border-color: var(--cyan);
            color: var(--cyan);
            box-shadow: 0 0 25px rgba(0, 240, 255, 0.2);
        }
        
        /* HUD */
        .hud {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .metric {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 6px;
            font-size: 9px;
            letter-spacing: 1px;
        }
        
        .metric-label { width: 65px; opacity: 0.4; }
        
        .metric-bar {
            width: 90px; height: 3px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .metric-fill {
            height: 100%;
            background: var(--cyan);
            transition: width 0.4s;
            box-shadow: 0 0 8px var(--cyan);
        }
        .metric-fill.danger { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        .metric-fill.warning { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
        .metric-fill.success { background: var(--success); box-shadow: 0 0 8px var(--success); }
        
        .metric-value { width: 40px; text-align: right; font-weight: 600; font-size: 10px; }
        
        /* P_OUTCOME Large Display */
        .outcome-display {
            position: fixed;
            bottom: 120px;
            left: 20px;
            z-index: 100;
        }
        
        .outcome-label {
            font-size: 8px;
            letter-spacing: 2px;
            opacity: 0.4;
            margin-bottom: 4px;
        }
        
        .outcome-value {
            font-size: 36px;
            font-weight: 300;
            letter-spacing: -2px;
        }
        .outcome-value.locked { color: var(--danger); }
        .outcome-value.ready { color: var(--success); }
        
        .outcome-threshold {
            font-size: 9px;
            opacity: 0.5;
            margin-top: 4px;
        }
        
        /* Commit Button */
        .commit-section {
            position: fixed;
            bottom: 20px;
            right: 20px;
            text-align: right;
            z-index: 100;
        }
        
        .commit-btn {
            padding: 14px 28px;
            border: 2px solid var(--cyan);
            border-radius: 6px;
            background: var(--cyan-dark);
            color: var(--cyan);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .commit-btn:hover:not(:disabled) {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.3);
        }
        .commit-btn:disabled {
            opacity: 0.25;
            cursor: not-allowed;
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .commit-reason {
            margin-top: 8px;
            font-size: 9px;
            color: var(--danger);
            opacity: 0.8;
            max-width: 200px;
        }
        
        /* ============================================ */
        /* PAGE 1: FUTURE PR */
        /* ============================================ */
        
        .page1-panel {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            background: var(--panel);
            border: 1px solid var(--cyan-dim);
            border-radius: 12px;
            padding: 20px;
            display: none;
            z-index: 100;
        }
        .page1-panel.active { display: block; }
        
        .panel-title {
            font-size: 10px;
            letter-spacing: 3px;
            opacity: 0.5;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-title::before {
            content: '';
            width: 12px;
            height: 1px;
            background: var(--cyan);
        }
        
        .future-pr-input {
            width: 100%;
            height: 80px;
            background: rgba(0, 240, 255, 0.03);
            border: 1px solid var(--cyan-dim);
            border-radius: 6px;
            padding: 12px;
            color: var(--cyan);
            font-size: 12px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }
        .future-pr-input::placeholder { color: rgba(0, 240, 255, 0.3); }
        .future-pr-input:focus { border-color: var(--cyan); }
        
        .pr-hint {
            margin-top: 10px;
            font-size: 9px;
            opacity: 0.4;
            line-height: 1.4;
        }
        
        .gap-display {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 51, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 6px;
            display: none;
        }
        .gap-display.show { display: block; }
        
        .gap-title {
            font-size: 9px;
            color: var(--danger);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .gap-bar {
            height: 6px;
            background: rgba(255, 51, 68, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .gap-fill {
            height: 100%;
            background: var(--danger);
            transition: width 0.5s;
        }
        
        .gap-text {
            margin-top: 8px;
            font-size: 10px;
            color: var(--danger);
        }
        
        /* Sliders */
        .sliders-row {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .slider-group {
            flex: 1;
        }
        
        .slider-label {
            font-size: 8px;
            letter-spacing: 1px;
            opacity: 0.4;
            margin-bottom: 6px;
        }
        
        .slider {
            width: 100%;
            -webkit-appearance: none;
            background: rgba(0, 240, 255, 0.15);
            height: 3px;
            border-radius: 2px;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            background: var(--cyan);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider-value {
            margin-top: 4px;
            font-size: 10px;
            text-align: right;
        }
        
        /* ============================================ */
        /* PAGE 2: NODE CULLING */
        /* ============================================ */
        
        .page2-panel {
            position: fixed;
            top: 100px;
            left: 20px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        .page2-panel.active { display: flex; }
        
        .node-btn {
            padding: 10px 14px;
            border: 1px solid var(--cyan-dim);
            border-radius: 5px;
            background: var(--panel);
            color: var(--cyan);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .node-btn:hover { background: var(--cyan-dark); border-color: var(--cyan); }
        .node-btn.danger { border-color: var(--danger); color: var(--danger); }
        .node-btn.danger:hover { background: rgba(255, 51, 68, 0.1); }
        
        /* Node Info Panel */
        .node-info {
            position: fixed;
            top: 100px;
            right: 80px;
            width: 220px;
            background: var(--panel);
            border: 1px solid var(--cyan-dim);
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 100;
        }
        .node-info.show { display: block; }
        
        .node-info-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .node-roi {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .roi-label {
            font-size: 9px;
            opacity: 0.5;
        }
        
        .roi-value {
            font-size: 18px;
            font-weight: 300;
        }
        .roi-value.low { color: var(--danger); }
        .roi-value.medium { color: var(--warning); }
        .roi-value.high { color: var(--success); }
        
        .roi-warning {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 51, 68, 0.1);
            border-radius: 4px;
            font-size: 9px;
            color: var(--danger);
            line-height: 1.4;
        }
        
        /* ============================================ */
        /* PAGE 3: MANDALA + DATA SYNC */
        /* ============================================ */
        
        .mandala {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 380px;
            height: 380px;
            display: none;
            z-index: 50;
        }
        .mandala.active { display: block; }
        
        .mandala-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid var(--cyan-dim);
            border-radius: 50%;
        }
        
        .slot {
            position: absolute;
            width: 62px; height: 62px;
            transform: translate(-50%, -50%);
            border: 2px solid var(--cyan-dim);
            border-radius: 50%;
            background: var(--panel);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.25s;
        }
        .slot:hover {
            border-color: var(--cyan);
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 0 25px rgba(0, 240, 255, 0.3);
            z-index: 10;
        }
        .slot.synced { border-color: var(--success); }
        .slot.warning { border-color: var(--warning); }
        .slot-icon { font-size: 15px; }
        .slot-value { font-size: 10px; font-weight: 600; margin-top: 2px; }
        .slot-label { font-size: 7px; opacity: 0.5; }
        .slot-sync {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 14px; height: 14px;
            background: var(--success);
            border-radius: 50%;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg);
        }
        
        /* Impact Message */
        .impact-msg {
            position: fixed;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background: var(--panel);
            border: 1px solid var(--success);
            border-radius: 8px;
            font-size: 11px;
            color: var(--success);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .impact-msg.show { opacity: 1; }
        
        /* Data Sync Status */
        .sync-status {
            position: fixed;
            top: 100px;
            left: 20px;
            display: none;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }
        .sync-status.active { display: flex; }
        
        .sync-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--panel);
            border: 1px solid var(--cyan-dim);
            border-radius: 5px;
            font-size: 9px;
        }
        .sync-item.connected { border-color: var(--success); }
        .sync-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--cyan-dim);
        }
        .sync-item.connected .sync-dot { background: var(--success); }
        
        /* Tooltip */
        .tooltip {
            position: fixed;
            padding: 10px 14px;
            background: var(--panel);
            border: 1px solid var(--cyan);
            border-radius: 6px;
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 200;
            max-width: 200px;
        }
        .tooltip.show { opacity: 1; }
        
        /* Flash */
        .flash {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cyan);
            opacity: 0;
            pointer-events: none;
            z-index: 500;
        }
        .flash.active { animation: flash 0.3s ease-out; }
        @keyframes flash { 0% { opacity: 0.2; } 100% { opacity: 0; } }
        
        /* Deficit Popup */
        .deficit-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            background: var(--panel);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 25px;
            display: none;
            z-index: 300;
        }
        .deficit-popup.show { display: block; }
        
        .deficit-title {
            font-size: 12px;
            color: var(--danger);
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        
        .deficit-msg {
            font-size: 11px;
            line-height: 1.6;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .deficit-items {
            margin-bottom: 20px;
        }
        
        .deficit-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 51, 68, 0.2);
            font-size: 10px;
        }
        
        .deficit-item-label { opacity: 0.6; }
        .deficit-item-value { color: var(--danger); font-weight: 600; }
        
        .deficit-close {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--cyan);
            border-radius: 6px;
            background: transparent;
            color: var(--cyan);
            font-size: 11px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">BEZOS MODE INITIALIZING</div>
    </div>
    
    <div id="canvas"></div>
    
    <header class="header">
        <div class="logo">
            AUTUS
            <span class="logo-badge">BEZOS</span>
        </div>
        <div class="status-row">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>DAY 1</span>
            </div>
            <div class="mode-badge sim" id="mode-badge">SIM</div>
        </div>
    </header>
    
    <div class="page-title" id="page-title">WORKING BACKWARDS</div>
    
    <nav class="page-nav">
        <button class="page-btn active" data-page="1">1</button>
        <button class="page-btn" data-page="2">2</button>
        <button class="page-btn" data-page="3">3</button>
    </nav>
    
    <!-- HUD -->
    <div class="hud">
        <div class="metric">
            <span class="metric-label">DENSITY</span>
            <div class="metric-bar"><div class="metric-fill" id="density-fill" style="width:50%"></div></div>
            <span class="metric-value" id="density-val">0.50</span>
        </div>
        <div class="metric">
            <span class="metric-label">SIGMA</span>
            <div class="metric-bar"><div class="metric-fill" id="sigma-fill" style="width:30%"></div></div>
            <span class="metric-value" id="sigma-val">0.30</span>
        </div>
        <div class="metric">
            <span class="metric-label">STABILITY</span>
            <div class="metric-bar"><div class="metric-fill" id="stability-fill" style="width:70%"></div></div>
            <span class="metric-value" id="stability-val">0.70</span>
        </div>
    </div>
    
    <!-- P_OUTCOME Display -->
    <div class="outcome-display">
        <div class="outcome-label">SUCCESS PROBABILITY</div>
        <div class="outcome-value locked" id="outcome-val">0%</div>
        <div class="outcome-threshold">THRESHOLD: 80%</div>
    </div>
    
    <!-- Page 1: Future PR -->
    <div class="page1-panel active" id="page1-panel">
        <div class="panel-title">FUTURE PRESS RELEASE</div>
        <textarea class="future-pr-input" id="future-pr" placeholder="[날짜: 2025년 12월]&#10;&#10;[제목]이 [목표]를 달성하여 [결과]를 이끌어냈다..."></textarea>
        <div class="pr-hint">
            베이조스 원칙: 결과에서 역산하세요. 성공했을 때의 보도자료를 먼저 작성하십시오.
        </div>
        
        <div class="gap-display" id="gap-display">
            <div class="gap-title">⚠ ENERGY DEFICIT</div>
            <div class="gap-bar"><div class="gap-fill" id="gap-fill" style="width:60%"></div></div>
            <div class="gap-text" id="gap-text">현재 밀도(0.50)가 목표 달성에 40% 부족합니다</div>
        </div>
        
        <div class="sliders-row">
            <div class="slider-group">
                <div class="slider-label">MASS (역량)</div>
                <input type="range" class="slider" id="mass-slider" min="0.1" max="2" step="0.1" value="0.5">
                <div class="slider-value" id="mass-val">0.50</div>
            </div>
            <div class="slider-group">
                <div class="slider-label">VOLUME (목표 크기)</div>
                <input type="range" class="slider" id="volume-slider" min="0.2" max="2" step="0.1" value="0.5">
                <div class="slider-value" id="volume-val">0.50</div>
            </div>
            <div class="slider-group">
                <div class="slider-label">HORIZON (기한)</div>
                <input type="range" class="slider" id="horizon-slider" min="7" max="365" step="1" value="30">
                <div class="slider-value" id="horizon-val">30d</div>
            </div>
        </div>
    </div>
    
    <!-- Page 2: Node Controls -->
    <div class="page2-panel" id="page2-panel">
        <button class="node-btn" id="add-node">+ ADD NODE</button>
        <button class="node-btn" id="remove-node">− REMOVE NODE</button>
        <button class="node-btn danger" id="cull-low-roi">⚠ CULL LOW ROI</button>
        <button class="node-btn" id="compress-sigma">⟐ COMPRESS σ</button>
    </div>
    
    <!-- Node Info -->
    <div class="node-info" id="node-info">
        <div class="node-info-title" id="node-name">NODE</div>
        <div class="node-roi">
            <span class="roi-label">CONTRIBUTION INDEX</span>
            <span class="roi-value" id="node-roi">0.00</span>
        </div>
        <div class="roi-warning" id="roi-warning">
            이 노드는 목표와의 상관관계가 낮습니다. 제거를 권장합니다.
        </div>
    </div>
    
    <!-- Page 3: Mandala -->
    <div class="mandala" id="mandala"></div>
    
    <!-- Impact Message -->
    <div class="impact-msg" id="impact-msg"></div>
    
    <!-- Data Sync Status -->
    <div class="sync-status" id="sync-status">
        <div class="sync-item connected">
            <div class="sync-dot"></div>
            <span>Calendar API</span>
        </div>
        <div class="sync-item">
            <div class="sync-dot"></div>
            <span>Screen Time</span>
        </div>
        <div class="sync-item">
            <div class="sync-dot"></div>
            <span>Finance API</span>
        </div>
    </div>
    
    <!-- Commit Section -->
    <div class="commit-section">
        <button class="commit-btn" id="commit-btn" disabled>COMMIT</button>
        <div class="commit-reason" id="commit-reason">P_outcome &lt; 80%. 데이터가 부족합니다.</div>
    </div>
    
    <div class="flash" id="flash"></div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Deficit Popup -->
    <div class="deficit-popup" id="deficit-popup">
        <div class="deficit-title">⚠ COMMIT BLOCKED</div>
        <div class="deficit-msg">
            현재 데이터가 Commit 임계치(80%)에 도달하지 못했습니다.<br>
            다음 물리량을 개선하십시오:
        </div>
        <div class="deficit-items" id="deficit-items">
            <div class="deficit-item">
                <span class="deficit-item-label">P_outcome 부족분</span>
                <span class="deficit-item-value" id="deficit-poutcome">-45%</span>
            </div>
            <div class="deficit-item">
                <span class="deficit-item-label">Density 권장치</span>
                <span class="deficit-item-value" id="deficit-density">+0.30</span>
            </div>
            <div class="deficit-item">
                <span class="deficit-item-label">Sigma 감소 필요</span>
                <span class="deficit-item-value" id="deficit-sigma">-0.15</span>
            </div>
        </div>
        <button class="deficit-close" id="deficit-close">확인 - 개선 후 재시도</button>
    </div>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    
    <script>
    // ================================================================
    // AUTUS BEZOS EDITION
    // ================================================================
    
    const API = 'http://localhost:8001';
    const SESSION = 'autus_bezos_' + Date.now();
    const COMMIT_THRESHOLD = 0.80; // 80%
    
    let scene, camera, renderer, composer;
    let currentPage = 1;
    let state = null;
    
    // Pages
    const pages = {
        1: { group: null, core: null, glow: null, rings: [], particles: null, prKeywords: [] },
        2: { group: null, selfNode: null, nodes: [], edges: [], grid: null },
        3: { group: null, core: null, rings: [], markers: [] }
    };
    
    // Allocations
    let alloc = { M: 0.125, E: 0.125, V: 0.125, T: 0.125, S: 0.125, N: 0.125, NE: 0.125, C: 0.125 };
    
    // Future PR
    let futurePR = '';
    
    // Node ROI data
    const nodeROI = {};
    
    const SLOTS = [
        { key: 'M', label: 'Mass', icon: '⚫', angle: -90, api: null },
        { key: 'E', label: 'Energy', icon: '⚡', angle: -45, api: 'calendar' },
        { key: 'V', label: 'Volume', icon: '◯', angle: 0, api: null },
        { key: 'T', label: 'Time', icon: '⏱', angle: 45, api: 'calendar' },
        { key: 'S', label: 'Pattern', icon: '✦', angle: 90, api: null },
        { key: 'N', label: 'Constraint', icon: '▣', angle: 135, api: 'finance' },
        { key: 'NE', label: 'Risk', icon: '⚠', angle: 180, api: 'screentime' },
        { key: 'C', label: 'Context', icon: '◈', angle: 225, api: null }
    ];
    
    const TITLES = {
        1: 'WORKING BACKWARDS',
        2: 'THE CULLING',
        3: 'INPUT METRICS'
    };
    
    // ================================================================
    // INIT
    // ================================================================
    
    async function init() {
        setupScene();
        setupPostProcessing();
        
        createPage1();
        createPage2();
        createPage3();
        createMandalaUI();
        
        showPage(1);
        setupEvents();
        
        await fetchState();
        
        setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
        
        animate();
        setInterval(fetchState, 2000);
        setInterval(simulateDataSync, 5000); // Simulate data sync
    }
    
    function setupScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x030405);
        
        camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 6);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas').appendChild(renderer.domElement);
    }
    
    function setupPostProcessing() {
        composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        
        const bloom = new THREE.UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            1.2, 0.5, 0.1
        );
        composer.addPass(bloom);
        composer.bloom = bloom;
    }
    
    // ================================================================
    // PAGE 1: CORE + FUTURE PR KEYWORDS
    // ================================================================
    
    function createPage1() {
        const p = pages[1];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Core
        const coreGeo = new THREE.SphereGeometry(1.3, 64, 64);
        const coreMat = new THREE.ShaderMaterial({
            uniforms: {
                uTime: { value: 0 },
                uDensity: { value: 0.5 },
                uGap: { value: 0.4 }
            },
            vertexShader: `
                varying vec3 vNormal, vPos;
                uniform float uTime;
                void main() {
                    vNormal = normal;
                    vPos = position;
                    float n = sin(position.x * 4.0 + uTime) * cos(position.y * 4.0 + uTime) * 0.03;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position + normal * n, 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal, vPos;
                uniform float uDensity, uTime, uGap;
                void main() {
                    vec3 viewDir = normalize(cameraPosition - vPos);
                    float fresnel = pow(1.0 - dot(viewDir, vNormal), 2.5);
                    float pulse = 0.9 + 0.1 * sin(uTime * 2.0);
                    
                    vec3 baseColor = vec3(0.0, 0.94, 1.0);
                    vec3 gapColor = vec3(1.0, 0.2, 0.27);
                    vec3 col = mix(baseColor, gapColor, uGap * 0.3);
                    
                    col *= (0.35 + uDensity * 0.65);
                    col += fresnel * baseColor * 0.5;
                    col *= pulse;
                    
                    gl_FragColor = vec4(col, 0.9);
                }
            `,
            transparent: true
        });
        p.core = new THREE.Mesh(coreGeo, coreMat);
        p.group.add(p.core);
        
        // Glow
        const glowGeo = new THREE.SphereGeometry(1.7, 32, 32);
        const glowMat = new THREE.ShaderMaterial({
            uniforms: { uDensity: { value: 0.5 } },
            vertexShader: `varying vec3 vN; void main() { vN = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `varying vec3 vN; uniform float uDensity; void main() { float i = pow(0.5 - dot(vN, vec3(0,0,1)), 2.0); gl_FragColor = vec4(vec3(0,0.94,1) * i * (0.4 + uDensity * 0.6), i * 0.4); }`,
            transparent: true, side: THREE.BackSide, blending: THREE.AdditiveBlending
        });
        p.glow = new THREE.Mesh(glowGeo, glowMat);
        p.group.add(p.glow);
        
        // Rings
        [1.9, 2.3, 2.7].forEach((r, i) => {
            const ring = new THREE.Mesh(
                new THREE.TorusGeometry(r, 0.012, 8, 100),
                new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.2 - i * 0.05 })
            );
            ring.rotation.x = Math.PI / 2 + i * 0.25;
            p.rings.push(ring);
            p.group.add(ring);
        });
        
        // Particles
        const pCount = 120;
        const pGeo = new THREE.BufferGeometry();
        const pPos = new Float32Array(pCount * 3);
        for (let i = 0; i < pCount; i++) {
            const th = Math.random() * Math.PI * 2;
            const ph = Math.acos(2 * Math.random() - 1);
            const r = 2.0 + Math.random() * 1.5;
            pPos[i*3] = r * Math.sin(ph) * Math.cos(th);
            pPos[i*3+1] = r * Math.sin(ph) * Math.sin(th);
            pPos[i*3+2] = r * Math.cos(ph);
        }
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        p.particles = new THREE.Points(pGeo, new THREE.PointsMaterial({
            color: 0x00f0ff, size: 0.035, transparent: true, opacity: 0.4, blending: THREE.AdditiveBlending
        }));
        p.group.add(p.particles);
    }
    
    // ================================================================
    // PAGE 2: GRAPH WITH ROI
    // ================================================================
    
    function createPage2() {
        const p = pages[2];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Grid
        p.grid = new THREE.GridHelper(12, 24, 0x002530, 0x001520);
        p.grid.position.y = -2.5;
        p.group.add(p.grid);
        
        // Self node
        const selfGeo = new THREE.SphereGeometry(0.45, 32, 32);
        const selfMat = new THREE.MeshBasicMaterial({ color: 0x00f0ff });
        p.selfNode = new THREE.Mesh(selfGeo, selfMat);
        p.group.add(p.selfNode);
        
        // Self glow
        const selfGlow = new THREE.Mesh(
            new THREE.SphereGeometry(0.65, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.2, side: THREE.BackSide })
        );
        p.selfNode.add(selfGlow);
        
        // Initial nodes with ROI
        const initNodes = [
            { pos: [3.2, 0.6, 0.5], label: 'GOAL A', roi: 0.85, type: 'GOAL' },
            { pos: [-2.8, 0.3, 1.2], label: 'DISTRACTION', roi: 0.15, type: 'OBSTACLE' },
            { pos: [1.2, -0.6, 2.2], label: 'STEP 1', roi: 0.65, type: 'STEP' },
            { pos: [-1.2, 1.0, -1.2], label: 'GOAL B', roi: 0.78, type: 'GOAL' },
            { pos: [2.2, -0.2, -1.8], label: 'RESOURCE', roi: 0.55, type: 'RESOURCE' },
            { pos: [-2.5, -0.8, -0.5], label: 'BAD HABIT', roi: 0.08, type: 'OBSTACLE' }
        ];
        
        initNodes.forEach(n => addGraphNode(n.pos, n.label, n.roi, n.type));
    }
    
    function addGraphNode(pos, label, roi, type) {
        const p = pages[2];
        
        // Color based on ROI
        let color;
        if (roi < 0.3) color = 0xff3344; // Low ROI - danger
        else if (roi < 0.6) color = 0xffaa00; // Medium ROI - warning
        else color = 0x00ff88; // High ROI - good
        
        const node = new THREE.Mesh(
            new THREE.SphereGeometry(0.2, 16, 16),
            new THREE.MeshBasicMaterial({ color, transparent: true, opacity: roi < 0.3 ? 0.4 : 0.9 })
        );
        node.position.set(...pos);
        node.userData = { label, roi, type, id: 'node_' + p.nodes.length };
        nodeROI[node.userData.id] = roi;
        
        p.nodes.push(node);
        p.group.add(node);
        
        // Edge
        const edge = createEdge(p.selfNode.position, node.position, color, roi);
        p.edges.push(edge);
        p.group.add(edge);
        
        return node;
    }
    
    function createEdge(from, to, color, roi) {
        const geo = new THREE.BufferGeometry().setFromPoints([from.clone(), to.clone()]);
        const mat = new THREE.LineDashedMaterial({
            color, transparent: true, opacity: roi < 0.3 ? 0.2 : 0.5,
            dashSize: 0.1, gapSize: 0.05
        });
        const line = new THREE.Line(geo, mat);
        line.computeLineDistances();
        return line;
    }
    
    function cullLowROI() {
        const p = pages[2];
        const toRemove = [];
        
        p.nodes.forEach((node, i) => {
            if (node.userData.roi < 0.3) {
                toRemove.push(i);
            }
        });
        
        toRemove.reverse().forEach(i => {
            const node = p.nodes[i];
            p.group.remove(node);
            p.nodes.splice(i, 1);
            
            const edge = p.edges[i];
            if (edge) {
                p.group.remove(edge);
                p.edges.splice(i, 1);
            }
        });
        
        showImpact(`${toRemove.length}개의 저기여 노드가 제거되었습니다. σ 감소 예상.`);
    }
    
    // ================================================================
    // PAGE 3: MANDALA + DATA SYNC
    // ================================================================
    
    function createPage3() {
        const p = pages[3];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Center core
        p.core = new THREE.Mesh(
            new THREE.SphereGeometry(0.5, 32, 32),
            new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.85 })
        );
        p.group.add(p.core);
        
        // Glow
        const glow = new THREE.Mesh(
            new THREE.SphereGeometry(0.75, 16, 16),
            new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.2, side: THREE.BackSide })
        );
        p.group.add(glow);
        
        // Rings
        [1.3, 1.9, 2.5].forEach((r, i) => {
            const ring = new THREE.Mesh(
                new THREE.TorusGeometry(r, 0.01, 8, 64),
                new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.2 - i * 0.05 })
            );
            ring.rotation.x = Math.PI / 2;
            p.rings.push(ring);
            p.group.add(ring);
        });
        
        // Markers
        SLOTS.forEach(slot => {
            const angle = slot.angle * Math.PI / 180;
            const radius = 2.2;
            
            const marker = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 16, 16),
                new THREE.MeshBasicMaterial({ color: slot.api ? 0x00ff88 : 0x00f0ff, transparent: true, opacity: 0.5 })
            );
            marker.position.set(Math.cos(angle) * radius, 0, Math.sin(angle) * radius);
            marker.userData = { key: slot.key };
            p.markers.push(marker);
            p.group.add(marker);
            
            // Line
            const line = new THREE.Line(
                new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), marker.position.clone()]),
                new THREE.LineBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.1 })
            );
            p.group.add(line);
        });
    }
    
    function createMandalaUI() {
        const container = document.getElementById('mandala');
        
        // Rings
        [280, 200, 120].forEach(size => {
            const ring = document.createElement('div');
            ring.className = 'mandala-ring';
            ring.style.width = size + 'px';
            ring.style.height = size + 'px';
            container.appendChild(ring);
        });
        
        // Slots
        const radius = 125;
        SLOTS.forEach(slot => {
            const angle = slot.angle * Math.PI / 180;
            const x = 190 + Math.cos(angle) * radius;
            const y = 190 + Math.sin(angle) * radius;
            
            const el = document.createElement('div');
            el.className = 'slot' + (slot.api ? ' synced' : '');
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.dataset.key = slot.key;
            el.innerHTML = `
                <span class="slot-icon">${slot.icon}</span>
                <span class="slot-value">${Math.round(alloc[slot.key] * 100)}%</span>
                <span class="slot-label">${slot.label}</span>
                ${slot.api ? '<span class="slot-sync">↻</span>' : ''}
            `;
            el.onclick = () => invest(slot.key);
            container.appendChild(el);
        });
    }
    
    function invest(key) {
        const slot = SLOTS.find(s => s.key === key);
        if (slot?.api) {
            showImpact(`${slot.label}은 실시간 API와 연동되어 있습니다. 실제 행동을 변경하세요.`);
            return;
        }
        
        alloc[key] = Math.min(alloc[key] + 0.05, 0.9);
        
        // Normalize
        const total = Object.values(alloc).reduce((a, b) => a + b, 0);
        Object.keys(alloc).forEach(k => alloc[k] = alloc[k] / total);
        
        updateMandalaUI();
        
        // Calculate impact
        const impact = Math.round((alloc[key] - 0.125) * 100);
        showImpact(`이 배분은 성공 확률을 약 ${impact > 0 ? '+' : ''}${impact}% 변화시킵니다.`);
        
        sendAllocations();
    }
    
    function updateMandalaUI() {
        SLOTS.forEach(slot => {
            const el = document.querySelector(`.slot[data-key="${slot.key}"] .slot-value`);
            if (el) el.textContent = `${Math.round(alloc[slot.key] * 100)}%`;
        });
    }
    
    function showImpact(msg) {
        const el = document.getElementById('impact-msg');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }
    
    // Simulate external data sync
    function simulateDataSync() {
        // Simulate calendar data affecting Energy
        const calendarHours = 4 + Math.random() * 4; // 4-8 hours
        alloc.E = Math.min(calendarHours / 10, 0.8);
        
        // Simulate screen time affecting Risk
        const screenTime = 2 + Math.random() * 6; // 2-8 hours
        alloc.NE = Math.min(screenTime / 12, 0.7);
        
        // Normalize
        const total = Object.values(alloc).reduce((a, b) => a + b, 0);
        Object.keys(alloc).forEach(k => alloc[k] = alloc[k] / total);
        
        updateMandalaUI();
    }
    
    async function sendAllocations() {
        try {
            await fetch(`${API}/draft/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: SESSION, page: 3, patch: { allocations: alloc }, t_ms: Date.now() })
            });
            await fetchState();
        } catch (e) {}
    }
    
    // ================================================================
    // PAGE SWITCHING
    // ================================================================
    
    function showPage(page) {
        pages[1].group.visible = page === 1;
        pages[2].group.visible = page === 2;
        pages[3].group.visible = page === 3;
        
        document.getElementById('page1-panel').classList.toggle('active', page === 1);
        document.getElementById('page2-panel').classList.toggle('active', page === 2);
        document.getElementById('mandala').classList.toggle('active', page === 3);
        document.getElementById('sync-status').classList.toggle('active', page === 3);
        document.getElementById('node-info').classList.remove('show');
        
        document.querySelectorAll('.page-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.page) === page);
        });
        
        document.getElementById('page-title').textContent = TITLES[page];
        
        switch (page) {
            case 1: camera.position.set(0, 0, 6); break;
            case 2: camera.position.set(0, 4, 9); break;
            case 3: camera.position.set(0, 5, 5); break;
        }
        camera.lookAt(0, 0, 0);
        
        currentPage = page;
    }
    
    // ================================================================
    // API & STATE
    // ================================================================
    
    async function fetchState() {
        try {
            const res = await fetch(`${API}/state?session_id=${SESSION}`);
            state = await res.json();
            updateFromState();
        } catch (e) {}
    }
    
    function updateFromState() {
        if (!state?.measure) return;
        
        const { density, stability, sigma } = state.measure;
        const pOutcome = state.forecast?.P_outcome || 0;
        
        // HUD
        updateMetric('density', density);
        updateMetric('sigma', sigma);
        updateMetric('stability', stability);
        
        // P_outcome
        const outcomeEl = document.getElementById('outcome-val');
        outcomeEl.textContent = `${Math.round(pOutcome * 100)}%`;
        outcomeEl.className = 'outcome-value ' + (pOutcome >= COMMIT_THRESHOLD ? 'ready' : 'locked');
        
        // Mode
        const mode = state.ui?.mode || 'SIM';
        const badge = document.getElementById('mode-badge');
        badge.textContent = mode;
        badge.className = `mode-badge ${mode.toLowerCase()}`;
        
        // Commit gate - 80% threshold
        const canCommit = mode === 'SIM' && pOutcome >= COMMIT_THRESHOLD;
        document.getElementById('commit-btn').disabled = !canCommit;
        document.getElementById('commit-reason').style.display = canCommit ? 'none' : 'block';
        document.getElementById('commit-reason').textContent = 
            pOutcome < COMMIT_THRESHOLD 
                ? `P_outcome (${Math.round(pOutcome * 100)}%) < 80%. 데이터가 부족합니다.`
                : '';
        
        // Gap display
        const gap = Math.max(0, 0.8 - density);
        document.getElementById('gap-display').classList.toggle('show', gap > 0.1);
        document.getElementById('gap-fill').style.width = `${gap * 100}%`;
        document.getElementById('gap-text').textContent = 
            `현재 밀도(${density.toFixed(2)})가 목표 달성에 ${Math.round(gap * 100)}% 부족합니다`;
        
        // Update Page 1 visuals
        if (pages[1].core) {
            pages[1].core.material.uniforms.uDensity.value = density;
            pages[1].core.material.uniforms.uGap.value = gap;
        }
        if (pages[1].glow) pages[1].glow.material.uniforms.uDensity.value = density;
        
        // Bloom
        if (composer?.bloom) composer.bloom.strength = 0.8 + density * 0.8;
        
        // Deficit popup values
        document.getElementById('deficit-poutcome').textContent = `-${Math.round((COMMIT_THRESHOLD - pOutcome) * 100)}%`;
        document.getElementById('deficit-density').textContent = `+${gap.toFixed(2)}`;
        document.getElementById('deficit-sigma').textContent = `-${Math.max(0, sigma - 0.3).toFixed(2)}`;
    }
    
    function updateMetric(name, value) {
        const fill = document.getElementById(`${name}-fill`);
        const val = document.getElementById(`${name}-val`);
        
        fill.style.width = `${value * 100}%`;
        val.textContent = value.toFixed(2);
        
        // Color based on value
        if (name === 'sigma') {
            fill.className = 'metric-fill ' + (value > 0.5 ? 'danger' : value > 0.3 ? 'warning' : 'success');
        } else {
            fill.className = 'metric-fill ' + (value < 0.3 ? 'danger' : value < 0.5 ? 'warning' : '');
        }
    }
    
    async function commit() {
        const pOutcome = state?.forecast?.P_outcome || 0;
        
        if (pOutcome < COMMIT_THRESHOLD) {
            document.getElementById('deficit-popup').classList.add('show');
            return;
        }
        
        try {
            await fetch(`${API}/commit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: SESSION, t_ms: Date.now() })
            });
            
            document.getElementById('flash').classList.add('active');
            if ('vibrate' in navigator) navigator.vibrate([50, 30, 50]);
            setTimeout(() => document.getElementById('flash').classList.remove('active'), 300);
            
            await fetchState();
        } catch (e) {}
    }
    
    // ================================================================
    // ANIMATION
    // ================================================================
    
    function animate(time = 0) {
        requestAnimationFrame(animate);
        
        const t = time * 0.001;
        
        // Page 1
        if (pages[1].group.visible) {
            pages[1].core.material.uniforms.uTime.value = t;
            pages[1].core.rotation.y = t * 0.15;
            pages[1].rings.forEach((r, i) => r.rotation.z = t * 0.15 * (i + 1));
            pages[1].particles.rotation.y = t * 0.08;
        }
        
        // Page 2
        if (pages[2].group.visible) {
            pages[2].selfNode.rotation.y = t * 0.5;
            pages[2].nodes.forEach((n, i) => {
                n.position.y += Math.sin(t * 1.5 + i) * 0.001;
            });
        }
        
        // Page 3
        if (pages[3].group.visible) {
            pages[3].core.rotation.y = t * 0.4;
            pages[3].rings.forEach((r, i) => r.rotation.z = t * 0.12 * (i + 1));
        }
        
        composer.render();
    }
    
    // ================================================================
    // EVENTS
    // ================================================================
    
    function setupEvents() {
        // Page nav
        document.querySelectorAll('.page-btn').forEach(btn => {
            btn.onclick = () => showPage(parseInt(btn.dataset.page));
        });
        
        // Keyboard
        window.onkeydown = e => {
            if (e.key >= '1' && e.key <= '3') showPage(parseInt(e.key));
        };
        
        // Future PR
        document.getElementById('future-pr').oninput = e => {
            futurePR = e.target.value;
            // Analyze PR and update gap
            if (futurePR.length > 50) {
                document.getElementById('gap-display').classList.add('show');
            }
        };
        
        // Page 1 sliders
        ['mass', 'volume', 'horizon'].forEach(id => {
            const slider = document.getElementById(`${id}-slider`);
            slider.oninput = () => {
                const val = parseFloat(slider.value);
                document.getElementById(`${id}-val`).textContent = id === 'horizon' ? `${val}d` : val.toFixed(2);
            };
            slider.onchange = async () => {
                try {
                    await fetch(`${API}/draft/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: SESSION, page: 1, t_ms: Date.now(),
                            patch: {
                                mass_mod: parseFloat(document.getElementById('mass-slider').value),
                                volume_override: parseFloat(document.getElementById('volume-slider').value),
                                horizon_d: parseInt(document.getElementById('horizon-slider').value)
                            }
                        })
                    });
                    await fetchState();
                } catch (e) {}
            };
        });
        
        // Page 2 buttons
        document.getElementById('add-node').onclick = () => {
            const x = (Math.random() - 0.5) * 5;
            const y = (Math.random() - 0.5) * 2;
            const z = (Math.random() - 0.5) * 4;
            const roi = 0.3 + Math.random() * 0.6;
            addGraphNode([x, y, z], `NODE ${pages[2].nodes.length + 1}`, roi, 'STEP');
        };
        
        document.getElementById('remove-node').onclick = () => {
            const p = pages[2];
            if (p.nodes.length > 0) {
                const node = p.nodes.pop();
                p.group.remove(node);
                const edge = p.edges.pop();
                if (edge) p.group.remove(edge);
            }
        };
        
        document.getElementById('cull-low-roi').onclick = cullLowROI;
        
        document.getElementById('compress-sigma').onclick = async () => {
            try {
                await fetch(`${API}/draft/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: SESSION, page: 2, patch: { sigma_delta: -0.1 }, t_ms: Date.now() })
                });
                await fetchState();
            } catch (e) {}
        };
        
        // Node hover
        const tooltip = document.getElementById('tooltip');
        const nodeInfo = document.getElementById('node-info');
        
        renderer.domElement.onmousemove = e => {
            if (currentPage !== 2) return;
            
            const mouse = new THREE.Vector2(
                (e.clientX / window.innerWidth) * 2 - 1,
                -(e.clientY / window.innerHeight) * 2 + 1
            );
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(pages[2].nodes);
            
            if (intersects.length > 0) {
                const node = intersects[0].object;
                const { label, roi } = node.userData;
                
                document.getElementById('node-name').textContent = label;
                document.getElementById('node-roi').textContent = roi.toFixed(2);
                document.getElementById('node-roi').className = 'roi-value ' + 
                    (roi < 0.3 ? 'low' : roi < 0.6 ? 'medium' : 'high');
                document.getElementById('roi-warning').style.display = roi < 0.3 ? 'block' : 'none';
                
                nodeInfo.classList.add('show');
            } else {
                nodeInfo.classList.remove('show');
            }
        };
        
        // Commit
        document.getElementById('commit-btn').onclick = commit;
        
        // Deficit popup close
        document.getElementById('deficit-close').onclick = () => {
            document.getElementById('deficit-popup').classList.remove('show');
        };
        
        // Resize
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        };
    }
    
    // ================================================================
    // START
    // ================================================================
    
    init();
    </script>
</body>
</html>
