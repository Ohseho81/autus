<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTUS ‚Äî FLYWHEEL OS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --cyan: #00f0ff;
            --cyan-dim: rgba(0, 240, 255, 0.25);
            --cyan-glow: rgba(0, 240, 255, 0.15);
            --bg: #020304;
            --panel: rgba(2, 3, 4, 0.95);
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff3344;
            --gold: #ffd700;
            --attraction: #00aaff;
            --repulsion: #ff4466;
        }
        
        body {
            background: var(--bg);
            color: var(--cyan);
            font-family: 'SF Pro Display', -apple-system, sans-serif;
            overflow: hidden;
            height: 100vh;
        }
        
        /* Technical Glow Background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse at 50% 30%, rgba(0, 240, 255, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 20% 70%, rgba(0, 255, 136, 0.02) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 80%, rgba(255, 170, 0, 0.015) 0%, transparent 35%);
            pointer-events: none;
            z-index: 0;
        }
        
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Loading */
        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
            transition: opacity 0.6s;
        }
        .loading.hidden { opacity: 0; pointer-events: none; }
        .spinner {
            width: 50px; height: 50px;
            border: 2px solid var(--cyan-dim);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 18px; font-size: 9px; letter-spacing: 4px; opacity: 0.4; }
        
        /* Header */
        .header {
            position: fixed; top: 0; left: 0; right: 0;
            height: 50px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(2,3,4,0.95), transparent);
        }
        
        .logo {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-badge {
            padding: 3px 8px;
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid var(--cyan);
            border-radius: 4px;
            font-size: 7px;
            letter-spacing: 2px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .persona-select {
            padding: 5px 12px;
            background: var(--panel);
            border: 1px solid var(--cyan-dim);
            border-radius: 4px;
            color: var(--cyan);
            font-size: 9px;
            cursor: pointer;
        }
        
        .mode-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 2px;
            background: var(--cyan-glow);
            border: 1px solid var(--cyan);
        }
        
        /* Page Title */
        .page-title {
            position: fixed;
            top: 58px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            letter-spacing: 6px;
            opacity: 0.3;
            z-index: 100;
        }
        
        /* Page Nav */
        .page-nav {
            position: fixed;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 6px;
            z-index: 100;
        }
        
        .page-btn {
            width: 38px; height: 38px;
            border: 1px solid var(--cyan-dim);
            border-radius: 6px;
            background: var(--panel);
            color: var(--cyan-dim);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn:hover { border-color: var(--cyan); color: var(--cyan); }
        .page-btn.active {
            background: var(--cyan-glow);
            border-color: var(--cyan);
            color: var(--cyan);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
        }
        
        /* HUD Metrics */
        .hud {
            position: fixed;
            bottom: 15px;
            left: 15px;
            z-index: 100;
        }
        
        .metric {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 5px;
            font-size: 8px;
            letter-spacing: 1px;
        }
        
        .metric-label { width: 55px; opacity: 0.35; }
        
        .metric-bar {
            width: 80px; height: 2px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 1px;
            overflow: hidden;
        }
        
        .metric-fill {
            height: 100%;
            background: var(--cyan);
            transition: width 0.4s;
        }
        .metric-fill.danger { background: var(--danger); }
        .metric-fill.warning { background: var(--warning); }
        .metric-fill.success { background: var(--success); }
        
        .metric-value { width: 35px; text-align: right; font-size: 9px; }
        
        /* P_outcome Large */
        .outcome-display {
            position: fixed;
            bottom: 100px;
            left: 15px;
            z-index: 100;
        }
        
        .outcome-label {
            font-size: 7px;
            letter-spacing: 2px;
            opacity: 0.3;
            margin-bottom: 3px;
        }
        
        .outcome-value {
            font-size: 32px;
            font-weight: 200;
            letter-spacing: -1px;
        }
        .outcome-value.locked { color: var(--danger); }
        .outcome-value.ready { color: var(--success); }
        
        /* Commit Section */
        .commit-section {
            position: fixed;
            bottom: 15px;
            right: 15px;
            text-align: right;
            z-index: 100;
        }
        
        .commit-btn {
            padding: 12px 24px;
            border: 1px solid var(--cyan);
            border-radius: 5px;
            background: var(--cyan-glow);
            color: var(--cyan);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .commit-btn:hover:not(:disabled) {
            background: rgba(0, 240, 255, 0.2);
            box-shadow: 0 0 25px rgba(0, 240, 255, 0.3);
        }
        .commit-btn:disabled { opacity: 0.2; cursor: not-allowed; border-color: var(--danger); }
        
        .commit-status {
            margin-top: 6px;
            font-size: 8px;
            color: var(--danger);
            opacity: 0.7;
        }
        
        /* ============================================ */
        /* P1: CONVERGENCE GOAL */
        /* ============================================ */
        
        .p1-panel {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 520px;
            background: var(--panel);
            border: 1px solid var(--cyan-dim);
            border-radius: 10px;
            padding: 18px;
            display: none;
            z-index: 100;
        }
        .p1-panel.active { display: block; }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .panel-title {
            font-size: 9px;
            letter-spacing: 3px;
            opacity: 0.4;
        }
        
        .panel-title::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 1px;
            background: var(--cyan);
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .future-pr {
            width: 100%;
            height: 70px;
            background: rgba(0, 240, 255, 0.02);
            border: 1px solid var(--cyan-dim);
            border-radius: 5px;
            padding: 10px;
            color: var(--cyan);
            font-size: 11px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }
        .future-pr::placeholder { color: rgba(0, 240, 255, 0.25); }
        .future-pr:focus { border-color: var(--cyan); }
        
        /* Trade-off Report */
        .tradeoff-report {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 68, 102, 0.08);
            border: 1px solid var(--repulsion);
            border-radius: 5px;
            display: none;
        }
        .tradeoff-report.show { display: block; }
        
        .tradeoff-title {
            font-size: 8px;
            color: var(--repulsion);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .tradeoff-item {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 68, 102, 0.15);
        }
        .tradeoff-item:last-child { border-bottom: none; }
        
        .tradeoff-conflict { color: var(--repulsion); }
        
        /* Vector Inputs */
        .vector-inputs {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }
        
        .vector-group {
            flex: 1;
        }
        
        .vector-label {
            font-size: 7px;
            letter-spacing: 1px;
            opacity: 0.35;
            margin-bottom: 4px;
        }
        
        .vector-slider {
            width: 100%;
            -webkit-appearance: none;
            background: rgba(0, 240, 255, 0.1);
            height: 2px;
            border-radius: 1px;
        }
        .vector-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px; height: 10px;
            background: var(--cyan);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .vector-value {
            margin-top: 3px;
            font-size: 9px;
            text-align: right;
        }
        
        /* ============================================ */
        /* P2: NAVIGATION GEODESIC */
        /* ============================================ */
        
        .p2-panel {
            position: fixed;
            top: 90px;
            left: 15px;
            display: none;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }
        .p2-panel.active { display: flex; }
        
        .nav-btn {
            padding: 8px 12px;
            border: 1px solid var(--cyan-dim);
            border-radius: 4px;
            background: var(--panel);
            color: var(--cyan);
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-btn:hover { background: var(--cyan-glow); border-color: var(--cyan); }
        .nav-btn.danger { border-color: var(--danger); color: var(--danger); }
        
        /* High Velocity Decision */
        .velocity-panel {
            position: fixed;
            top: 90px;
            right: 70px;
            width: 200px;
            background: var(--panel);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 12px;
            display: none;
            z-index: 100;
        }
        .velocity-panel.show { display: block; }
        
        .velocity-title {
            font-size: 8px;
            color: var(--warning);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        
        .velocity-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 9px;
            border-bottom: 1px solid rgba(255, 170, 0, 0.15);
        }
        
        .velocity-checkbox {
            width: 14px; height: 14px;
            border: 1px solid var(--warning);
            border-radius: 3px;
            background: transparent;
            cursor: pointer;
        }
        .velocity-checkbox.done {
            background: var(--success);
            border-color: var(--success);
        }
        
        .velocity-deadline {
            font-size: 8px;
            opacity: 0.5;
        }
        .velocity-deadline.overdue { color: var(--danger); opacity: 1; }
        
        /* ============================================ */
        /* P3: ATTRIBUTE TOPOLOGY */
        /* ============================================ */
        
        .p3-panel {
            position: fixed;
            top: 90px;
            left: 15px;
            display: none;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }
        .p3-panel.active { display: flex; }
        
        /* Attribute Info */
        .attr-info {
            position: fixed;
            top: 90px;
            right: 70px;
            width: 220px;
            background: var(--panel);
            border: 1px solid var(--cyan-dim);
            border-radius: 8px;
            padding: 14px;
            display: none;
            z-index: 100;
        }
        .attr-info.show { display: block; }
        
        .attr-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .attr-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }
        
        .attr-chip {
            padding: 3px 8px;
            background: var(--cyan-glow);
            border: 1px solid var(--cyan-dim);
            border-radius: 10px;
            font-size: 8px;
        }
        .attr-chip.negative {
            background: rgba(255, 68, 102, 0.1);
            border-color: var(--repulsion);
            color: var(--repulsion);
        }
        
        .attr-roi {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        
        .roi-label { font-size: 8px; opacity: 0.4; }
        .roi-value { font-size: 18px; font-weight: 300; }
        .roi-value.low { color: var(--danger); }
        .roi-value.medium { color: var(--warning); }
        .roi-value.high { color: var(--success); }
        
        .attr-decay {
            font-size: 8px;
            color: var(--warning);
            padding: 6px;
            background: rgba(255, 170, 0, 0.1);
            border-radius: 4px;
        }
        
        .eject-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid var(--danger);
            border-radius: 4px;
            background: rgba(255, 51, 68, 0.1);
            color: var(--danger);
            font-size: 9px;
            cursor: pointer;
        }
        
        /* ============================================ */
        /* P4: MANDALA ACTUATOR */
        /* ============================================ */
        
        .mandala {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 360px;
            height: 360px;
            display: none;
            z-index: 50;
        }
        .mandala.active { display: block; }
        
        .mandala-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid var(--cyan-dim);
            border-radius: 50%;
        }
        
        .slot {
            position: absolute;
            width: 58px; height: 58px;
            transform: translate(-50%, -50%);
            border: 2px solid var(--cyan-dim);
            border-radius: 50%;
            background: var(--panel);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.25s;
        }
        .slot:hover {
            border-color: var(--cyan);
            transform: translate(-50%, -50%) scale(1.12);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.25);
        }
        .slot.resonating {
            animation: resonance 0.5s ease-out;
        }
        @keyframes resonance {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 40px var(--gold); }
        }
        .slot-icon { font-size: 14px; }
        .slot-value { font-size: 9px; font-weight: 600; margin-top: 2px; }
        .slot-label { font-size: 6px; opacity: 0.4; }
        
        /* Dopamine Feedback */
        .dopamine-msg {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 18px;
            background: var(--panel);
            border: 1px solid var(--gold);
            border-radius: 6px;
            font-size: 10px;
            color: var(--gold);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .dopamine-msg.show { opacity: 1; }
        
        /* Mass Erosion Overlay */
        .erosion-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 51, 68, 0.03) 10px,
                rgba(255, 51, 68, 0.03) 20px
            );
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 99;
        }
        .erosion-overlay.active { opacity: 1; }
        
        /* Automation Saved Time */
        .automation-panel {
            position: fixed;
            bottom: 60px;
            right: 15px;
            width: 180px;
            background: var(--panel);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 12px;
            display: none;
            z-index: 100;
        }
        .automation-panel.show { display: block; }
        
        .automation-title {
            font-size: 8px;
            color: var(--success);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .saved-time {
            font-size: 24px;
            font-weight: 300;
            color: var(--success);
        }
        
        .saved-label {
            font-size: 8px;
            opacity: 0.5;
            margin-top: 4px;
        }
        
        .reinvest-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid var(--gold);
            border-radius: 4px;
            background: rgba(255, 215, 0, 0.1);
            color: var(--gold);
            font-size: 9px;
            cursor: pointer;
        }
        
        /* Auto-Report Dropzone */
        .dropzone {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: 140px;
            border: 2px dashed var(--cyan-dim);
            border-radius: 12px;
            background: var(--panel);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 100;
        }
        .dropzone.active { display: flex; }
        .dropzone.dragover {
            border-color: var(--cyan);
            background: rgba(0, 240, 255, 0.05);
            transform: translateX(-50%) scale(1.02);
        }
        
        .dropzone-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.5; }
        .dropzone-text { font-size: 10px; opacity: 0.5; letter-spacing: 1px; }
        .dropzone-formats { font-size: 8px; opacity: 0.3; margin-top: 6px; }
        
        /* Processing Status */
        .processing-status {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            background: var(--panel);
            border: 1px solid var(--cyan);
            border-radius: 12px;
            padding: 18px;
            display: none;
            z-index: 100;
        }
        .processing-status.show { display: block; }
        
        .processing-title {
            font-size: 10px;
            letter-spacing: 2px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .processing-spinner {
            width: 14px; height: 14px;
            border: 2px solid var(--cyan-dim);
            border-top-color: var(--cyan);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        
        .processing-bar {
            height: 4px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .processing-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--success));
            width: 0%;
            transition: width 0.3s;
        }
        
        .processing-stage {
            font-size: 9px;
            opacity: 0.6;
        }
        
        /* Report Result */
        .report-result {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-height: 70vh;
            background: var(--panel);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 18px;
            display: none;
            overflow-y: auto;
            z-index: 100;
        }
        .report-result.show { display: block; }
        
        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .report-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--success);
        }
        
        .report-close {
            width: 24px; height: 24px;
            border: 1px solid var(--cyan-dim);
            border-radius: 4px;
            background: transparent;
            color: var(--cyan);
            cursor: pointer;
        }
        
        .report-insights {
            margin-bottom: 15px;
        }
        
        .insight-item {
            padding: 8px 10px;
            background: rgba(0, 255, 136, 0.05);
            border-left: 2px solid var(--success);
            margin-bottom: 6px;
            font-size: 10px;
        }
        
        .report-recommendations {
            margin-bottom: 15px;
        }
        
        .rec-title {
            font-size: 9px;
            letter-spacing: 1px;
            opacity: 0.5;
            margin-bottom: 8px;
        }
        
        .rec-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 9px;
        }
        
        .rec-bullet {
            width: 4px; height: 4px;
            background: var(--cyan);
            border-radius: 50%;
        }
        
        /* Share Recipients */
        .share-section {
            border-top: 1px solid var(--cyan-dim);
            padding-top: 12px;
        }
        
        .share-title {
            font-size: 9px;
            letter-spacing: 1px;
            opacity: 0.5;
            margin-bottom: 10px;
        }
        
        .share-recipients {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .recipient {
            padding: 5px 10px;
            background: rgba(0, 170, 255, 0.1);
            border: 1px solid var(--attraction);
            border-radius: 15px;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .recipient:hover {
            background: rgba(0, 170, 255, 0.2);
        }
        .recipient.selected {
            background: var(--attraction);
            color: #000;
        }
        .recipient.decision-maker {
            border-color: var(--gold);
            color: var(--gold);
        }
        .recipient.decision-maker.selected {
            background: var(--gold);
            color: #000;
        }
        
        .share-btn {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--success);
            border-radius: 5px;
            background: rgba(0, 255, 136, 0.1);
            color: var(--success);
            font-size: 10px;
            cursor: pointer;
        }
        
        /* Entropy Reduction Canvas */
        #entropy-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        
        /* Automation Proposal Popup */
        .automation-proposal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 340px;
            background: var(--panel);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            z-index: 600;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.15);
        }
        .automation-proposal.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .proposal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .proposal-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gold), #ff8800);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
        }
        
        .proposal-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gold);
        }
        
        .proposal-subtitle {
            font-size: 9px;
            opacity: 0.5;
            margin-top: 2px;
        }
        
        .proposal-content {
            font-size: 11px;
            line-height: 1.6;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--gold);
        }
        
        .proposal-savings {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 18px;
            padding: 12px;
            background: rgba(0, 255, 136, 0.08);
            border-radius: 8px;
        }
        
        .savings-number {
            font-size: 28px;
            font-weight: 300;
            color: var(--success);
        }
        
        .savings-unit {
            font-size: 10px;
            opacity: 0.6;
        }
        
        .proposal-actions {
            display: flex;
            gap: 10px;
        }
        
        .proposal-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .proposal-btn.accept {
            background: linear-gradient(135deg, var(--gold), #ff8800);
            border: none;
            color: #000;
        }
        .proposal-btn.accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }
        
        .proposal-btn.decline {
            background: transparent;
            border: 1px solid var(--cyan-dim);
            color: var(--cyan);
        }
        .proposal-btn.decline:hover {
            border-color: var(--cyan);
        }
        
        /* Active Automations List */
        .active-automations {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 215, 0, 0.15);
        }
        
        .auto-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 9px;
        }
        
        .auto-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .auto-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .auto-saved {
            color: var(--success);
        }
        
        /* Flash */
        .flash {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--cyan);
            opacity: 0;
            pointer-events: none;
            z-index: 500;
        }
        .flash.active { animation: flash 0.25s ease-out; }
        @keyframes flash { 0% { opacity: 0.2; } 100% { opacity: 0; } }
        
        /* Tooltip */
        .tooltip {
            position: fixed;
            padding: 8px 12px;
            background: var(--panel);
            border: 1px solid var(--cyan);
            border-radius: 5px;
            font-size: 9px;
            pointer-events: none;
            opacity: 0;
            z-index: 200;
        }
        .tooltip.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">FLYWHEEL INITIALIZING</div>
    </div>
    
    <div id="canvas"></div>
    
    <header class="header">
        <div class="logo">
            AUTUS
            <span class="logo-badge">FLYWHEEL OS</span>
        </div>
        <div class="header-right">
            <select class="persona-select" id="persona-select">
                <option value="professional">PROFESSIONAL</option>
                <option value="student">STUDENT</option>
                <option value="homemaker">HOMEMAKER</option>
            </select>
            <div class="mode-badge" id="mode-badge">SIM</div>
        </div>
    </header>
    
    <div class="page-title" id="page-title">CONVERGENCE GOAL</div>
    
    <nav class="page-nav">
        <button class="page-btn active" data-page="1">1</button>
        <button class="page-btn" data-page="2">2</button>
        <button class="page-btn" data-page="3">3</button>
        <button class="page-btn" data-page="4">4</button>
    </nav>
    
    <!-- HUD -->
    <div class="hud">
        <div class="metric">
            <span class="metric-label">MASS</span>
            <div class="metric-bar"><div class="metric-fill" id="mass-fill" style="width:50%"></div></div>
            <span class="metric-value" id="mass-val">0.50</span>
        </div>
        <div class="metric">
            <span class="metric-label">FRICTION</span>
            <div class="metric-bar"><div class="metric-fill danger" id="friction-fill" style="width:30%"></div></div>
            <span class="metric-value" id="friction-val">0.30</span>
        </div>
        <div class="metric">
            <span class="metric-label">ENTROPY</span>
            <div class="metric-bar"><div class="metric-fill warning" id="entropy-fill" style="width:20%"></div></div>
            <span class="metric-value" id="entropy-val">0.20</span>
        </div>
        <div class="metric">
            <span class="metric-label">VELOCITY</span>
            <div class="metric-bar"><div class="metric-fill success" id="velocity-fill" style="width:70%"></div></div>
            <span class="metric-value" id="velocity-val">0.70</span>
        </div>
    </div>
    
    <!-- P_outcome -->
    <div class="outcome-display">
        <div class="outcome-label">SUCCESS PROBABILITY</div>
        <div class="outcome-value locked" id="outcome-val">35%</div>
    </div>
    
    <!-- P1: Convergence Goal -->
    <div class="p1-panel active" id="p1-panel">
        <div class="panel-header">
            <span class="panel-title">FUTURE PRESS RELEASE</span>
        </div>
        <textarea class="future-pr" id="future-pr" placeholder="[2025ÎÖÑ 12Ïõî]&#10;&#10;[ÎãπÏã†Ïùò Ïù¥Î¶Ñ]Ïù¥ [Î™©Ìëú]Î•º Îã¨ÏÑ±ÌïòÏó¨ [Í≤∞Í≥º]Î•º Ïù¥ÎÅåÏñ¥ÎÉàÎã§..."></textarea>
        
        <div class="tradeoff-report" id="tradeoff-report">
            <div class="tradeoff-title">‚ö† TRADE-OFF DETECTED</div>
            <div class="tradeoff-item">
                <span>ÏûêÏú† ‚Üî Í≥†ÏàòÏûÖ</span>
                <span class="tradeoff-conflict">-0.35 Ï∂©Îèå</span>
            </div>
            <div class="tradeoff-item">
                <span>ÌñâÎèô Ïù¥Î†• ‚Üî Î™©Ìëú</span>
                <span class="tradeoff-conflict">Î∂àÏùºÏπò</span>
            </div>
        </div>
        
        <div class="vector-inputs">
            <div class="vector-group">
                <div class="vector-label">MASS (Ïó≠Îüâ)</div>
                <input type="range" class="vector-slider" id="mass-slider" min="0.1" max="2" step="0.1" value="0.5">
                <div class="vector-value" id="mass-display">0.50</div>
            </div>
            <div class="vector-group">
                <div class="vector-label">VOLUME (Î™©Ìëú ÌÅ¨Í∏∞)</div>
                <input type="range" class="vector-slider" id="volume-slider" min="0.2" max="2" step="0.1" value="0.5">
                <div class="vector-value" id="volume-display">0.50</div>
            </div>
            <div class="vector-group">
                <div class="vector-label">TIME (Í∏∞Ìïú)</div>
                <input type="range" class="vector-slider" id="time-slider" min="7" max="365" step="1" value="90">
                <div class="vector-value" id="time-display">90d</div>
            </div>
        </div>
    </div>
    
    <!-- P2: Navigation -->
    <div class="p2-panel" id="p2-panel">
        <button class="nav-btn" id="add-waypoint">+ WAYPOINT</button>
        <button class="nav-btn" id="optimize-path">‚óé OPTIMIZE</button>
        <button class="nav-btn danger" id="stop-line">‚äò STOP LINE</button>
    </div>
    
    <div class="velocity-panel" id="velocity-panel">
        <div class="velocity-title">HIGH-VELOCITY DECISIONS</div>
        <div id="velocity-items"></div>
    </div>
    
    <!-- P3: Attribute Topology -->
    <div class="p3-panel" id="p3-panel">
        <button class="nav-btn" id="add-attr">+ ATTRIBUTE</button>
        <button class="nav-btn" id="filter-low-roi">‚ö† LOW ROI</button>
        <button class="nav-btn danger" id="eject-all-low">‚äó EJECT <0.3</button>
    </div>
    
    <div class="attr-info" id="attr-info">
        <div class="attr-name" id="attr-name">Node</div>
        <div class="attr-chips" id="attr-chips"></div>
        <div class="attr-roi">
            <span class="roi-label">ROI</span>
            <span class="roi-value" id="attr-roi">0.00</span>
        </div>
        <div class="attr-decay" id="attr-decay">
            ‚è± ÎßàÏßÄÎßâ ÏÉÅÌò∏ÏûëÏö©: 14Ïùº Ï†Ñ ‚Äî Entropy Ï¶ùÍ∞Ä Ï§ë
        </div>
        <button class="eject-btn" id="eject-btn">EJECT NODE</button>
    </div>
    
    <!-- P4: Mandala -->
    <div class="mandala" id="mandala"></div>
    
    <div class="dopamine-msg" id="dopamine-msg"></div>
    
    <div class="automation-panel" id="automation-panel">
        <div class="automation-title">SAVED TIME</div>
        <div class="saved-time" id="saved-time">2.5h</div>
        <div class="saved-label">ÏûêÎèôÌôîÎ°ú Ï†àÏïΩÎêú ÏãúÍ∞Ñ</div>
        <button class="reinvest-btn" id="reinvest-btn">‚Üª Ïû¨Ìà¨ÏûêÌïòÍ∏∞</button>
    </div>
    
    <!-- Commit -->
    <div class="commit-section">
        <button class="commit-btn" id="commit-btn" disabled>COMMIT</button>
        <div class="commit-status" id="commit-status">P < 80%</div>
    </div>
    
    <div class="flash" id="flash"></div>
    <div class="erosion-overlay" id="erosion-overlay"></div>
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Auto-Report Dropzone -->
    <div class="dropzone" id="dropzone">
        <div class="dropzone-icon">üìÑ</div>
        <div class="dropzone-text">ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</div>
        <div class="dropzone-formats">CSV ¬∑ XLSX ¬∑ PDF ¬∑ JSON</div>
        <input type="file" id="file-input" accept=".csv,.xlsx,.pdf,.json" style="display:none">
    </div>
    
    <!-- Processing Status -->
    <div class="processing-status" id="processing-status">
        <div class="processing-title">
            <div class="processing-spinner"></div>
            <span id="processing-stage-text">Î∂ÑÏÑù Ï§ë...</span>
        </div>
        <div class="processing-bar">
            <div class="processing-fill" id="processing-fill"></div>
        </div>
        <div class="processing-stage" id="processing-detail">Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ï§ë...</div>
    </div>
    
    <!-- Report Result -->
    <div class="report-result" id="report-result">
        <div class="report-header">
            <div class="report-title">üìä Î∂ÑÏÑù ÏôÑÎ£å</div>
            <button class="report-close" id="report-close">√ó</button>
        </div>
        <div class="report-insights" id="report-insights"></div>
        <div class="report-recommendations">
            <div class="rec-title">RECOMMENDATIONS</div>
            <div id="rec-items"></div>
        </div>
        <div class="share-section">
            <div class="share-title">WHO SHOULD SEE THIS?</div>
            <div class="share-recipients" id="share-recipients"></div>
            <button class="share-btn" id="share-btn">üì§ ÏÑ†ÌÉùÎêú ÏàòÏã†ÏûêÏóêÍ≤å Í≥µÏú†</button>
        </div>
    </div>
    
    <!-- Entropy Canvas -->
    <canvas id="entropy-canvas"></canvas>
    
    <!-- Automation Proposal Popup -->
    <div class="automation-proposal" id="automation-proposal">
        <div class="proposal-header">
            <div class="proposal-icon">üîÑ</div>
            <div>
                <div class="proposal-title" id="proposal-title">Î∞òÎ≥µ ÏûëÏóÖ Î∞úÍ≤¨!</div>
                <div class="proposal-subtitle">LEARNING AGENT</div>
            </div>
        </div>
        <div class="proposal-content" id="proposal-content">
            Ìå®ÌÑ¥ Î∂ÑÏÑù Ï§ë...
        </div>
        <div class="proposal-savings">
            <div class="savings-number" id="savings-number">0</div>
            <div class="savings-unit">Î∂Ñ/Ï£º<br>Ï†àÏïΩ Í∞ÄÎä•</div>
        </div>
        <div class="proposal-actions">
            <button class="proposal-btn accept" id="accept-automation">ÏûêÎèôÌôî ÌôúÏÑ±Ìôî</button>
            <button class="proposal-btn decline" id="decline-automation">ÎÇòÏ§ëÏóê</button>
        </div>
    </div>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    
    <script>
    // ================================================================
    // AUTUS FLYWHEEL OS
    // ================================================================
    
    const API = 'http://localhost:8001';
    const SESSION = 'flywheel_' + Date.now();
    const COMMIT_THRESHOLD = 0.80;
    
    // ================================================================
    // LEARNING AGENT: Pattern Recognition & Automation
    // ================================================================
    
    const PatternAnalyzer = {
        findRepeat: (activityLog) => {
            const actionCounts = {};
            activityLog.forEach(action => {
                const key = `${action.type}_${action.target}`;
                if (!actionCounts[key]) {
                    actionCounts[key] = { name: action.name || key, duration: action.duration || 5, frequency: 0, actions: [] };
                }
                actionCounts[key].frequency++;
                actionCounts[key].actions.push(action);
            });
            
            // Find most frequent pattern
            let maxPattern = { frequency: 0 };
            Object.values(actionCounts).forEach(p => {
                if (p.frequency > maxPattern.frequency) maxPattern = p;
            });
            
            return maxPattern;
        }
    };
    
    const LearningAgent = {
        patterns: [],
        activityLog: [],
        isObserving: true,
        
        // 1. Ïú†Ï†Ä ÌñâÎèô Í∏∞Î°ù
        logAction: function(action) {
            if (!this.isObserving) return;
            
            this.activityLog.push({
                ...action,
                timestamp: Date.now()
            });
            
            // Keep only last 100 actions
            if (this.activityLog.length > 100) {
                this.activityLog.shift();
            }
            
            // Check for patterns every 10 actions
            if (this.activityLog.length % 10 === 0) {
                this.observeBehavior(this.activityLog);
            }
        },
        
        // 2. Ïú†Ï†Ä ÌñâÎèô Í¥ÄÏ∞∞ (Î°úÏª¨ Í∞ÄÎèô)
        observeBehavior: function(activityLog) {
            const pattern = PatternAnalyzer.findRepeat(activityLog);
            if (pattern.frequency >= 3) { // 3Ìöå Ïù¥ÏÉÅ Î∞òÎ≥µ Ïãú Ìå®ÌÑ¥ÏúºÎ°ú Ïù∏Ïãù
                // Check if pattern already proposed
                const alreadyProposed = this.patterns.find(p => p.name === pattern.name);
                if (!alreadyProposed) {
                    this.patterns.push(pattern);
                    this.proposeAutomation(pattern);
                }
            }
        },
        
        // 3. ÏûêÎèôÌôî Ï†úÏïà (ÎèÑÌååÎØº Ïú†ÎèÑ UI)
        proposeAutomation: function(pattern) {
            const savedTimePotential = Math.round(pattern.duration * pattern.frequency);
            showAutomationProposal({
                title: "üîÑ Î∞òÎ≥µ ÏûëÏóÖ Î∞úÍ≤¨!",
                content: `"${pattern.name}" ÏûëÏóÖÏùÑ ÏûêÎèôÌôîÌïòÎ©¥ Îß§Ï£º ${savedTimePotential}Î∂ÑÏùÑ ÏïÑÎÇÑ Ïàò ÏûàÏäµÎãàÎã§.`,
                pattern: pattern,
                action: "ÏûêÎèôÌôî Ìå© ÏÉùÏÑ±"
            });
        },
        
        // 4. ÏûêÎèôÌôî ÏäπÏù∏
        acceptAutomation: function(pattern) {
            const pack = {
                id: 'auto_' + Date.now(),
                name: pattern.name,
                trigger: pattern.actions[0],
                savedTime: pattern.duration * pattern.frequency,
                active: true
            };
            
            automationPacks.push(pack);
            savedTime += pack.savedTime / 60; // Convert to hours
            document.getElementById('saved-time').textContent = `${savedTime.toFixed(1)}h`;
            
            showDopamine(`‚ú¶ "${pattern.name}" ÏûêÎèôÌôî ÌôúÏÑ±Ìôî! +${pack.savedTime}Î∂Ñ/Ï£º Ï†àÏïΩ`);
            hideAutomationProposal();
            
            return pack;
        }
    };
    
    // Automation Packs storage
    let automationPacks = [];
    
    // ================================================================
    // AUTO-REPORT PROCESSOR
    // ================================================================
    
    const AutoReportProcessor = {
        supportedFormats: ['.csv', '.xlsx', '.pdf', '.json'],
        
        processFile: async function(file) {
            const ext = '.' + file.name.split('.').pop().toLowerCase();
            
            showProcessingStatus();
            
            // Simulate processing stages
            await this.simulateStage('ÌååÏã± Ï§ë...', 25, 800);
            await this.simulateStage('GPT-4o Î∂ÑÏÑù Ï§ë...', 50, 1200);
            await this.simulateStage('Ïù∏ÏÇ¨Ïù¥Ìä∏ Ï∂îÏ∂ú Ï§ë...', 75, 1000);
            await this.simulateStage('Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ï§ë...', 100, 600);
            
            hideProcessingStatus();
            
            const result = {
                filename: file.name,
                insights: [
                    'ÌïµÏã¨ ÏßÄÌëú 3Í∞ú Ï∂îÏ∂úÎê®',
                    'Ï†ÑÏõî ÎåÄÎπÑ 12% ÏÑ±Ïû• Í∞êÏßÄ',
                    'Ï£ºÏöî Ïù¥ÏÉÅÏπò 2Í±¥ ÏãùÎ≥Ñ',
                    'ÏòàÏ∏° Ï†ïÌôïÎèÑ: 87%'
                ],
                recommendations: [
                    'ÎßàÏºÄÌåÖ ÏòàÏÇ∞ Ïû¨Î∂ÑÎ∞∞ Í∂åÏû•',
                    'Ïã†Í∑ú Í≥†Í∞ù ÏÑ∏Í∑∏Î®ºÌä∏ ÌÉÄÍ≤üÌåÖ Ï†úÏïà',
                    'Ïö¥ÏòÅ Ìö®Ïú®ÏÑ± Í∞úÏÑ† Ìè¨Ïù∏Ìä∏ Î∞úÍ≤¨'
                ],
                savedTime: Math.round(15 + Math.random() * 30)
            };
            
            // Trigger entropy reduction animation
            triggerEntropyReduction();
            
            return result;
        },
        
        simulateStage: function(text, progress, duration) {
            return new Promise(resolve => {
                document.getElementById('processing-stage-text').textContent = text;
                document.getElementById('processing-fill').style.width = progress + '%';
                setTimeout(resolve, duration);
            });
        }
    };
    
    // ================================================================
    // RELATIONSHIP SYNC
    // ================================================================
    
    const RelationshipNodes = [
        { id: 'n1', name: 'Finance', chips: ['Finance', 'Decision Maker'], roi: 0.85, isDecisionMaker: true },
        { id: 'n2', name: 'Operations', chips: ['Operations', 'Manager'], roi: 0.72, isDecisionMaker: false },
        { id: 'n3', name: 'Executive', chips: ['Executive', 'Decision Maker'], roi: 0.92, isDecisionMaker: true },
        { id: 'n4', name: 'Marketing', chips: ['Marketing', 'Insight'], roi: 0.65, isDecisionMaker: false },
        { id: 'n5', name: 'HR', chips: ['HR', 'Support'], roi: 0.58, isDecisionMaker: false }
    ];
    
    function shareReport(nodeIds, reportId) {
        nodeIds.forEach(nodeId => {
            const node = RelationshipNodes.find(n => n.id === nodeId);
            if (node) {
                // Increase stability and influence
                node.stability = Math.min((node.stability || 0.5) + 0.05, 1);
                node.influence = Math.min((node.influence || 0.5) + 0.03, 1);
                
                // Update 3D visualization
                updateNodeVisualization(nodeId);
            }
        });
        
        showDopamine(`üì§ ${nodeIds.length}Î™ÖÏóêÍ≤å Î¶¨Ìè¨Ìä∏ Í≥µÏú† ÏôÑÎ£å! Í¥ÄÍ≥Ñ Í∞ïÌôî +5%`);
        DopamineEffects.playSuccessPing();
    }
    
    function updateNodeVisualization(nodeId) {
        // Update P3 node if visible
        const node = pages[3].nodes.find(n => n.userData?.id === nodeId);
        if (node) {
            node.material.opacity = 1;
            node.scale.multiplyScalar(1.1);
        }
    }
    
    // ================================================================
    // DOPAMINE EFFECTS (Sound/Visual)
    // ================================================================
    
    const DopamineEffects = {
        audioContext: null,
        
        init: function() {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        },
        
        playSuccessPing: function() {
            if (!this.audioContext) this.init();
            
            const ctx = this.audioContext;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.frequency.setValueAtTime(1200, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(2400, ctx.currentTime + 0.1);
            osc.frequency.exponentialRampToValueAtTime(1800, ctx.currentTime + 0.2);
            
            gain.gain.setValueAtTime(0.12, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);
        },
        
        playReinvestmentChime: function() {
            if (!this.audioContext) this.init();
            
            const ctx = this.audioContext;
            const notes = [523.25, 659.25, 783.99, 1046.50];
            
            notes.forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.frequency.value = freq;
                osc.type = 'sine';
                
                const startTime = ctx.currentTime + i * 0.1;
                gain.gain.setValueAtTime(0.08, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.4);
                
                osc.start(startTime);
                osc.stop(startTime + 0.4);
            });
        }
    };
    
    // ================================================================
    // ENTROPY REDUCTION ANIMATION
    // ================================================================
    
    let entropyParticles = [];
    let entropyCanvas, entropyCtx;
    let entropyAnimating = false;
    
    function initEntropyCanvas() {
        entropyCanvas = document.getElementById('entropy-canvas');
        entropyCtx = entropyCanvas.getContext('2d');
        entropyCanvas.width = window.innerWidth;
        entropyCanvas.height = window.innerHeight;
    }
    
    function triggerEntropyReduction() {
        entropyAnimating = true;
        
        // Create chaotic particles
        entropyParticles = [];
        for (let i = 0; i < 80; i++) {
            entropyParticles.push({
                x: Math.random() * entropyCanvas.width,
                y: Math.random() * entropyCanvas.height,
                targetX: entropyCanvas.width / 2 + (Math.random() - 0.5) * 200,
                targetY: entropyCanvas.height / 2 + (Math.random() - 0.5) * 100,
                size: 2 + Math.random() * 4,
                color: `rgba(0, ${180 + Math.random() * 75}, 255, ${0.5 + Math.random() * 0.5})`,
                speed: 0.02 + Math.random() * 0.03
            });
        }
        
        animateEntropy();
    }
    
    function animateEntropy() {
        if (!entropyAnimating) return;
        
        entropyCtx.clearRect(0, 0, entropyCanvas.width, entropyCanvas.height);
        
        let allConverged = true;
        
        entropyParticles.forEach(p => {
            // Move towards target
            const dx = p.targetX - p.x;
            const dy = p.targetY - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist > 5) {
                allConverged = false;
                p.x += dx * p.speed;
                p.y += dy * p.speed;
            }
            
            // Draw
            entropyCtx.beginPath();
            entropyCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            entropyCtx.fillStyle = p.color;
            entropyCtx.fill();
        });
        
        // Draw connecting lines
        entropyCtx.strokeStyle = 'rgba(0, 240, 255, 0.1)';
        entropyCtx.lineWidth = 0.5;
        for (let i = 0; i < entropyParticles.length; i += 3) {
            if (i + 1 < entropyParticles.length) {
                entropyCtx.beginPath();
                entropyCtx.moveTo(entropyParticles[i].x, entropyParticles[i].y);
                entropyCtx.lineTo(entropyParticles[i + 1].x, entropyParticles[i + 1].y);
                entropyCtx.stroke();
            }
        }
        
        if (allConverged) {
            entropyAnimating = false;
            setTimeout(() => {
                entropyCtx.clearRect(0, 0, entropyCanvas.width, entropyCanvas.height);
            }, 1000);
        } else {
            requestAnimationFrame(animateEntropy);
        }
    }
    
    // ================================================================
    // UI HELPERS
    // ================================================================
    
    function showProcessingStatus() {
        document.getElementById('dropzone').classList.remove('active');
        document.getElementById('processing-status').classList.add('show');
        document.getElementById('processing-fill').style.width = '0%';
    }
    
    function hideProcessingStatus() {
        document.getElementById('processing-status').classList.remove('show');
    }
    
    function showReportResult(result) {
        const container = document.getElementById('report-result');
        
        // Insights
        const insightsHtml = result.insights.map(i => 
            `<div class="insight-item">‚ú¶ ${i}</div>`
        ).join('');
        document.getElementById('report-insights').innerHTML = insightsHtml;
        
        // Recommendations
        const recsHtml = result.recommendations.map(r =>
            `<div class="rec-item"><span class="rec-bullet"></span>${r}</div>`
        ).join('');
        document.getElementById('rec-items').innerHTML = recsHtml;
        
        // Recipients
        const recipientsHtml = RelationshipNodes.map(n =>
            `<div class="recipient ${n.isDecisionMaker ? 'decision-maker' : ''}" data-id="${n.id}">
                ${n.isDecisionMaker ? '‚òÖ ' : ''}${n.name}
            </div>`
        ).join('');
        document.getElementById('share-recipients').innerHTML = recipientsHtml;
        
        // Add click handlers
        document.querySelectorAll('.recipient').forEach(el => {
            el.onclick = () => el.classList.toggle('selected');
        });
        
        container.classList.add('show');
        
        // Update saved time
        savedTime += result.savedTime / 60;
        document.getElementById('saved-time').textContent = `${savedTime.toFixed(1)}h`;
        
        showDopamine(`‚ú¶ ${result.filename} Î∂ÑÏÑù ÏôÑÎ£å! ${result.savedTime}Î∂Ñ Ï†àÏïΩ`);
        DopamineEffects.playSuccessPing();
    }
    
    function hideReportResult() {
        document.getElementById('report-result').classList.remove('show');
    }
    
    let scene, camera, renderer, composer;
    let currentPage = 1;
    let currentPersona = 'professional';
    let state = null;
    let savedTime = 2.5;
    
    // Pages
    const pages = {
        1: { group: null, core: null, glow: null, tradeoffVectors: [] },
        2: { group: null, selfNode: null, waypoints: [], paths: [], grid: null },
        3: { group: null, nodes: [], bonds: [] },
        4: { group: null, core: null, rings: [], markers: [] }
    };
    
    // Allocations
    let alloc = { Time: 0.2, Frequency: 0.2, Capital: 0.15, Focus: 0.15, Network: 0.1, Rest: 0.1, Learn: 0.1 };
    
    // High Velocity Decisions
    let velocityItems = [
        { id: 1, text: 'ÌïµÏã¨ ÏóÖÎ¨¥ 2ÏãúÍ∞Ñ ÏßëÏ§ë', done: false, deadline: 'Ïò§Îäò' },
        { id: 2, text: 'Ï£ºÍ∞Ñ Î¶¨Î∑∞ ÏûëÏÑ±', done: false, deadline: 'Í∏àÏöîÏùº' },
        { id: 3, text: 'ÎÑ§Ìä∏ÏõåÌÇπ Ïó∞ÎùΩ', done: true, deadline: 'ÏôÑÎ£å' }
    ];
    
    // Attribute Nodes
    let attrNodes = [
        { id: 'a1', chips: ['Insight', 'Mentor'], roi: 0.85, lastInteraction: 3, type: 'positive' },
        { id: 'a2', chips: ['Leisure', 'Distraction'], roi: 0.15, lastInteraction: 1, type: 'negative' },
        { id: 'a3', chips: ['Cooperation', 'Resource'], roi: 0.72, lastInteraction: 7, type: 'positive' },
        { id: 'a4', chips: ['Competition'], roi: 0.28, lastInteraction: 21, type: 'negative' },
        { id: 'a5', chips: ['Support', 'Family'], roi: 0.90, lastInteraction: 2, type: 'positive' }
    ];
    
    const SLOTS = [
        { key: 'Time', label: 'Ìà¨ÏûÖ ÏãúÍ∞Ñ', icon: '‚è±', angle: -90 },
        { key: 'Frequency', label: 'ÎπàÎèÑ', icon: '‚Üª', angle: -45 },
        { key: 'Capital', label: 'Ìà¨Ïûê ÏûêÎ≥∏', icon: '‚óà', angle: 0 },
        { key: 'Focus', label: 'ÏßëÏ§ëÎèÑ', icon: '‚óâ', angle: 45 },
        { key: 'Network', label: 'ÎÑ§Ìä∏ÏõåÌÅ¨', icon: '‚¨°', angle: 90 },
        { key: 'Rest', label: 'ÌöåÎ≥µ', icon: '‚óê', angle: 135 },
        { key: 'Learn', label: 'ÌïôÏäµ', icon: '‚ñ≥', angle: 180 }
    ];
    
    const TITLES = {
        1: 'CONVERGENCE GOAL',
        2: 'NAVIGATION GEODESIC',
        3: 'ATTRIBUTE TOPOLOGY',
        4: 'MANDALA ACTUATOR'
    };
    
    const PERSONA_CONFIG = {
        professional: { automation: 'Report/Email Agent', metric: 'Success Rate', action: 'Side-hustle' },
        student: { automation: 'Homework/Note Agent', metric: 'Grade Prediction', action: 'Study Focus' },
        homemaker: { automation: 'Finance/Schedule Sync', metric: 'Stability', action: 'Recharge' }
    };
    
    // ================================================================
    // INIT
    // ================================================================
    
    async function init() {
        setupScene();
        setupPostProcessing();
        
        createPage1();
        createPage2();
        createPage3();
        createPage4();
        createMandalaUI();
        
        showPage(1);
        setupEvents();
        renderVelocityItems();
        
        await fetchState();
        
        setTimeout(() => document.getElementById('loading').classList.add('hidden'), 400);
        
        animate();
        setInterval(fetchState, 2000);
        setInterval(checkMassErosion, 5000);
        
        // Initialize entropy canvas
        initEntropyCanvas();
        
        // Demo: Simulate pattern detection after 15 seconds
        setTimeout(() => {
            simulatePatternDetection();
        }, 15000);
    }
    
    // Demo: Simulate pattern for demonstration
    function simulatePatternDetection() {
        const demoPatterns = [
            { name: 'ÏùºÏùº Î¶¨Ìè¨Ìä∏ ÏûëÏÑ±', duration: 30, frequency: 5 },
            { name: 'Ïù¥Î©îÏùº Ï†ïÎ¶¨', duration: 15, frequency: 7 },
            { name: 'ÌöåÏùò ÎÖ∏Ìä∏ Ï†ïÎ¶¨', duration: 20, frequency: 4 }
        ];
        
        const pattern = demoPatterns[Math.floor(Math.random() * demoPatterns.length)];
        pattern.actions = [{ type: 'demo', target: 'demo' }];
        
        LearningAgent.proposeAutomation(pattern);
    }
    
    function setupScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020304);
        
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 7);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas').appendChild(renderer.domElement);
    }
    
    function setupPostProcessing() {
        composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        
        const bloom = new THREE.UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight),
            1.3, 0.5, 0.08
        );
        composer.addPass(bloom);
        composer.bloom = bloom;
    }
    
    // ================================================================
    // P1: CONVERGENCE GOAL
    // ================================================================
    
    function createPage1() {
        const p = pages[1];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Core with trade-off visualization
        const coreGeo = new THREE.SphereGeometry(1.2, 64, 64);
        const coreMat = new THREE.ShaderMaterial({
            uniforms: {
                uTime: { value: 0 },
                uMass: { value: 0.5 },
                uConflict: { value: 0.0 }
            },
            vertexShader: `
                varying vec3 vNormal, vPos;
                uniform float uTime, uConflict;
                void main() {
                    vNormal = normal;
                    vPos = position;
                    float n = sin(position.x * 4.0 + uTime) * cos(position.y * 4.0 + uTime) * 0.03;
                    float conflict = sin(position.z * 8.0 + uTime * 2.0) * uConflict * 0.05;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position + normal * (n + conflict), 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal, vPos;
                uniform float uMass, uTime, uConflict;
                void main() {
                    vec3 viewDir = normalize(cameraPosition - vPos);
                    float fresnel = pow(1.0 - dot(viewDir, vNormal), 2.5);
                    
                    vec3 baseColor = vec3(0.0, 0.94, 1.0);
                    vec3 conflictColor = vec3(1.0, 0.27, 0.4);
                    vec3 col = mix(baseColor, conflictColor, uConflict * 0.4);
                    
                    col *= (0.3 + uMass * 0.7);
                    col += fresnel * baseColor * 0.5;
                    col *= 0.9 + 0.1 * sin(uTime * 2.0);
                    
                    gl_FragColor = vec4(col, 0.88);
                }
            `,
            transparent: true
        });
        p.core = new THREE.Mesh(coreGeo, coreMat);
        p.group.add(p.core);
        
        // Glow
        const glowGeo = new THREE.SphereGeometry(1.6, 32, 32);
        const glowMat = new THREE.ShaderMaterial({
            uniforms: { uMass: { value: 0.5 } },
            vertexShader: `varying vec3 vN; void main() { vN = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `varying vec3 vN; uniform float uMass; void main() { float i = pow(0.5 - dot(vN, vec3(0,0,1)), 2.0); gl_FragColor = vec4(vec3(0,0.94,1) * i * (0.3 + uMass * 0.7), i * 0.35); }`,
            transparent: true, side: THREE.BackSide, blending: THREE.AdditiveBlending
        });
        p.glow = new THREE.Mesh(glowGeo, glowMat);
        p.group.add(p.glow);
    }
    
    function updateTradeoff(hasConflict) {
        if (pages[1].core) {
            pages[1].core.material.uniforms.uConflict.value = hasConflict ? 1.0 : 0.0;
        }
        document.getElementById('tradeoff-report').classList.toggle('show', hasConflict);
    }
    
    // ================================================================
    // P2: NAVIGATION GEODESIC
    // ================================================================
    
    function createPage2() {
        const p = pages[2];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Wireframe grid
        p.grid = new THREE.GridHelper(14, 28, 0x002025, 0x001015);
        p.grid.position.y = -2.5;
        p.group.add(p.grid);
        
        // Self node (A)
        const selfGeo = new THREE.SphereGeometry(0.4, 32, 32);
        const selfMat = new THREE.MeshBasicMaterial({ color: 0x00f0ff });
        p.selfNode = new THREE.Mesh(selfGeo, selfMat);
        p.selfNode.position.set(-4, 0, 0);
        p.group.add(p.selfNode);
        
        // Goal node (B)
        const goalGeo = new THREE.SphereGeometry(0.5, 32, 32);
        const goalMat = new THREE.MeshBasicMaterial({ color: 0x00ff88 });
        const goalNode = new THREE.Mesh(goalGeo, goalMat);
        goalNode.position.set(4, 0.5, 0);
        p.group.add(goalNode);
        
        // Geodesic path
        createGeodesicPath(p);
        
        // Waypoints
        const waypointPositions = [
            [-2, 0.3, 0.5],
            [0, 0.8, -0.3],
            [2, 0.2, 0.2]
        ];
        
        waypointPositions.forEach((pos, i) => {
            addWaypoint(pos, i);
        });
    }
    
    function createGeodesicPath(p) {
        const points = [];
        for (let i = 0; i <= 20; i++) {
            const t = i / 20;
            const x = -4 + t * 8;
            const y = Math.sin(t * Math.PI) * 0.8;
            const z = Math.sin(t * Math.PI * 2) * 0.3;
            points.push(new THREE.Vector3(x, y, z));
        }
        
        const curve = new THREE.CatmullRomCurve3(points);
        const geo = new THREE.TubeGeometry(curve, 50, 0.02, 8, false);
        const mat = new THREE.MeshBasicMaterial({ 
            color: 0x00f0ff, 
            transparent: true, 
            opacity: 0.6 
        });
        
        if (p.mainPath) p.group.remove(p.mainPath);
        p.mainPath = new THREE.Mesh(geo, mat);
        p.group.add(p.mainPath);
    }
    
    function addWaypoint(pos, index) {
        const p = pages[2];
        
        const wpGeo = new THREE.OctahedronGeometry(0.15);
        const wpMat = new THREE.MeshBasicMaterial({ 
            color: 0xffaa00, 
            transparent: true, 
            opacity: 0.8 
        });
        const wp = new THREE.Mesh(wpGeo, wpMat);
        wp.position.set(...pos);
        wp.userData = { index, completed: false };
        
        p.waypoints.push(wp);
        p.group.add(wp);
    }
    
    function stopTheLine() {
        // Turn path red
        if (pages[2].mainPath) {
            pages[2].mainPath.material.color.setHex(0xff3344);
        }
        showDopamine('‚äò SIMULATION STOPPED ‚Äî Complete High-Velocity Decision');
    }
    
    // ================================================================
    // P3: ATTRIBUTE TOPOLOGY (Molecular Structure)
    // ================================================================
    
    function createPage3() {
        const p = pages[3];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Create molecular structure
        attrNodes.forEach((attr, i) => {
            const angle = (i / attrNodes.length) * Math.PI * 2;
            const radius = 2 + Math.random() * 1;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const y = (Math.random() - 0.5) * 1.5;
            
            createAttrNode(attr, [x, y, z]);
        });
        
        // Create bonds
        createAttrBonds();
    }
    
    function createAttrNode(attr, pos) {
        const p = pages[3];
        
        // Color based on type and ROI
        let color;
        if (attr.roi < 0.3) color = 0xff4466; // Repulsion
        else if (attr.type === 'negative') color = 0xff8844;
        else color = 0x00aaff; // Attraction
        
        const size = 0.15 + attr.roi * 0.15;
        const opacity = attr.roi < 0.3 ? 0.4 : 0.9;
        
        // Calculate decay
        const decay = Math.min(attr.lastInteraction / 30, 1);
        
        const nodeGeo = new THREE.SphereGeometry(size, 16, 16);
        const nodeMat = new THREE.MeshBasicMaterial({ 
            color, 
            transparent: true, 
            opacity: opacity * (1 - decay * 0.5)
        });
        const node = new THREE.Mesh(nodeGeo, nodeMat);
        node.position.set(...pos);
        node.userData = { ...attr };
        
        p.nodes.push(node);
        p.group.add(node);
    }
    
    function createAttrBonds() {
        const p = pages[3];
        
        // Clear existing bonds
        p.bonds.forEach(b => p.group.remove(b));
        p.bonds = [];
        
        // Create center node
        const centerGeo = new THREE.SphereGeometry(0.3, 32, 32);
        const centerMat = new THREE.MeshBasicMaterial({ color: 0x00f0ff });
        const center = new THREE.Mesh(centerGeo, centerMat);
        p.group.add(center);
        
        // Connect all nodes to center
        p.nodes.forEach(node => {
            const color = node.userData.roi < 0.3 ? 0xff4466 : 0x00aaff;
            const opacity = node.userData.roi < 0.3 ? 0.2 : 0.4;
            
            const geo = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                node.position.clone()
            ]);
            const mat = new THREE.LineBasicMaterial({ 
                color, 
                transparent: true, 
                opacity 
            });
            const bond = new THREE.Line(geo, mat);
            
            p.bonds.push(bond);
            p.group.add(bond);
        });
    }
    
    function ejectLowROI() {
        const p = pages[3];
        
        const toRemove = [];
        p.nodes.forEach((node, i) => {
            if (node.userData.roi < 0.3) {
                toRemove.push(i);
            }
        });
        
        toRemove.reverse().forEach(i => {
            p.group.remove(p.nodes[i]);
            p.nodes.splice(i, 1);
            
            attrNodes = attrNodes.filter(a => a.roi >= 0.3);
        });
        
        createAttrBonds();
        showDopamine(`${toRemove.length}Í∞úÏùò Ï†ÄROI ÎÖ∏ÎìúÍ∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§`);
    }
    
    // ================================================================
    // P4: MANDALA ACTUATOR
    // ================================================================
    
    function createPage4() {
        const p = pages[4];
        p.group = new THREE.Group();
        scene.add(p.group);
        
        // Center core
        p.core = new THREE.Mesh(
            new THREE.SphereGeometry(0.45, 32, 32),
            new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.85 })
        );
        p.group.add(p.core);
        
        // Rings
        [1.2, 1.8, 2.4].forEach((r, i) => {
            const ring = new THREE.Mesh(
                new THREE.TorusGeometry(r, 0.01, 8, 64),
                new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.18 - i * 0.04 })
            );
            ring.rotation.x = Math.PI / 2;
            p.rings.push(ring);
            p.group.add(ring);
        });
        
        // Slot markers
        SLOTS.forEach(slot => {
            const angle = slot.angle * Math.PI / 180;
            const radius = 2.0;
            
            const marker = new THREE.Mesh(
                new THREE.SphereGeometry(0.08, 16, 16),
                new THREE.MeshBasicMaterial({ color: 0x00f0ff, transparent: true, opacity: 0.5 })
            );
            marker.position.set(Math.cos(angle) * radius, 0, Math.sin(angle) * radius);
            marker.userData = { key: slot.key };
            p.markers.push(marker);
            p.group.add(marker);
        });
    }
    
    function createMandalaUI() {
        const container = document.getElementById('mandala');
        
        // Rings
        [260, 180, 100].forEach(size => {
            const ring = document.createElement('div');
            ring.className = 'mandala-ring';
            ring.style.width = size + 'px';
            ring.style.height = size + 'px';
            container.appendChild(ring);
        });
        
        // Slots
        const radius = 115;
        SLOTS.forEach(slot => {
            const angle = slot.angle * Math.PI / 180;
            const x = 180 + Math.cos(angle) * radius;
            const y = 180 + Math.sin(angle) * radius;
            
            const el = document.createElement('div');
            el.className = 'slot';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.dataset.key = slot.key;
            el.innerHTML = `
                <span class="slot-icon">${slot.icon}</span>
                <span class="slot-value">${Math.round(alloc[slot.key] * 100)}%</span>
                <span class="slot-label">${slot.label}</span>
            `;
            el.onclick = () => investSlot(slot.key);
            container.appendChild(el);
        });
    }
    
    function investSlot(key) {
        alloc[key] = Math.min(alloc[key] + 0.05, 0.5);
        
        // Normalize
        const total = Object.values(alloc).reduce((a, b) => a + b, 0);
        Object.keys(alloc).forEach(k => alloc[k] = alloc[k] / total);
        
        updateMandalaUI();
        
        // Trigger resonance
        const slotEl = document.querySelector(`.slot[data-key="${key}"]`);
        if (slotEl) {
            slotEl.classList.add('resonating');
            setTimeout(() => slotEl.classList.remove('resonating'), 500);
        }
        
        // Dopamine feedback
        if (savedTime > 0) {
            showDopamine(`‚ú¶ ${key} Ìà¨Ïûê ‚Äî ÏÑ±Í≥µ ÌôïÎ•† +${Math.round(alloc[key] * 15)}%`);
        }
    }
    
    function updateMandalaUI() {
        SLOTS.forEach(slot => {
            const el = document.querySelector(`.slot[data-key="${slot.key}"] .slot-value`);
            if (el) el.textContent = `${Math.round(alloc[slot.key] * 100)}%`;
        });
        
        // Update 3D markers
        pages[4].markers.forEach(m => {
            const scale = 0.5 + alloc[m.userData.key] * 3;
            m.scale.setScalar(scale);
        });
    }
    
    function reinvestSavedTime() {
        if (savedTime <= 0) return;
        
        const persona = PERSONA_CONFIG[currentPersona];
        const investedTime = savedTime;
        
        // Increase focus slot (Skill-up equivalent)
        alloc.Focus = Math.min(alloc.Focus + savedTime * 0.05, 0.4);
        alloc.Learn = Math.min(alloc.Learn + savedTime * 0.03, 0.3);
        
        // Normalize
        const total = Object.values(alloc).reduce((a, b) => a + b, 0);
        Object.keys(alloc).forEach(k => alloc[k] = alloc[k] / total);
        
        updateMandalaUI();
        
        // Transfer visual - highlight the Learning slot
        const learnSlot = document.querySelector('.slot[data-key="Learn"]');
        if (learnSlot) {
            learnSlot.classList.add('resonating');
            setTimeout(() => learnSlot.classList.remove('resonating'), 800);
        }
        
        // Trigger dopamine sound and visual
        DopamineEffects.playReinvestmentChime();
        showDopamine(`‚ú¶ ${investedTime.toFixed(1)}h Ïû¨Ìà¨Ïûê ‚Üí ${persona.metric} ÏÉÅÏäπ!`);
        
        // Visual feedback - shimmer glow
        document.getElementById('flash').classList.add('active');
        setTimeout(() => document.getElementById('flash').classList.remove('active'), 400);
        
        // Update bloom for visual impact
        if (composer?.bloom) {
            const originalStrength = composer.bloom.strength;
            composer.bloom.strength = 2.5;
            setTimeout(() => { composer.bloom.strength = originalStrength; }, 600);
        }
        
        savedTime = 0;
        document.getElementById('saved-time').textContent = '0h';
    }
    
    function showDopamine(msg) {
        const el = document.getElementById('dopamine-msg');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }
    
    // ================================================================
    // AUTOMATION PROPOSAL UI
    // ================================================================
    
    let currentProposal = null;
    
    function showAutomationProposal(proposal) {
        currentProposal = proposal;
        
        document.getElementById('proposal-title').textContent = proposal.title;
        document.getElementById('proposal-content').textContent = proposal.content;
        document.getElementById('savings-number').textContent = Math.round(proposal.pattern.duration * proposal.pattern.frequency);
        
        document.getElementById('automation-proposal').classList.add('show');
        
        // Play notification sound (optional)
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 880;
            gain.gain.value = 0.1;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            osc.stop(ctx.currentTime + 0.3);
        } catch(e) {}
    }
    
    function hideAutomationProposal() {
        document.getElementById('automation-proposal').classList.remove('show');
        currentProposal = null;
    }
    
    function updateAutomationsList() {
        const panel = document.getElementById('automation-panel');
        let listHtml = '';
        
        if (automationPacks.length > 0) {
            listHtml = '<div class="active-automations">';
            automationPacks.forEach(pack => {
                listHtml += `
                    <div class="auto-item">
                        <span class="auto-name"><span class="auto-dot"></span>${pack.name}</span>
                        <span class="auto-saved">+${pack.savedTime}Î∂Ñ</span>
                    </div>
                `;
            });
            listHtml += '</div>';
        }
        
        // Find or create the list container
        let listContainer = panel.querySelector('.active-automations');
        if (listContainer) {
            listContainer.remove();
        }
        if (automationPacks.length > 0) {
            panel.insertAdjacentHTML('beforeend', listHtml);
        }
    }
    
    // ================================================================
    // MASS EROSION
    // ================================================================
    
    function checkMassErosion() {
        // Simulate checking actual vs commitment
        const actualVsCommitment = Math.random(); // 0-1
        
        if (actualVsCommitment < 0.5) {
            // Trigger erosion
            document.getElementById('erosion-overlay').classList.add('active');
            
            // Reduce mass visual
            if (pages[1].core) {
                pages[1].core.material.uniforms.uMass.value *= 0.95;
            }
            
            setTimeout(() => {
                document.getElementById('erosion-overlay').classList.remove('active');
            }, 2000);
        }
    }
    
    // ================================================================
    // VELOCITY ITEMS
    // ================================================================
    
    function renderVelocityItems() {
        const container = document.getElementById('velocity-items');
        container.innerHTML = '';
        
        velocityItems.forEach(item => {
            const el = document.createElement('div');
            el.className = 'velocity-item';
            el.innerHTML = `
                <div class="velocity-checkbox ${item.done ? 'done' : ''}" data-id="${item.id}"></div>
                <span>${item.text}</span>
                <span class="velocity-deadline ${item.deadline === 'Ïò§Îäò' && !item.done ? 'overdue' : ''}">${item.deadline}</span>
            `;
            
            el.querySelector('.velocity-checkbox').onclick = () => toggleVelocityItem(item.id);
            container.appendChild(el);
        });
    }
    
    function toggleVelocityItem(id) {
        const item = velocityItems.find(i => i.id === id);
        if (item) {
            item.done = !item.done;
            if (item.done) item.deadline = 'ÏôÑÎ£å';
            renderVelocityItems();
            
            if (item.done) {
                showDopamine('‚úì High-Velocity Decision ÏôÑÎ£å!');
                savedTime += 0.5;
                document.getElementById('saved-time').textContent = `${savedTime.toFixed(1)}h`;
            }
        }
    }
    
    // ================================================================
    // PAGE SWITCHING
    // ================================================================
    
    function showPage(page) {
        pages[1].group.visible = page === 1;
        pages[2].group.visible = page === 2;
        pages[3].group.visible = page === 3;
        pages[4].group.visible = page === 4;
        
        document.getElementById('p1-panel').classList.toggle('active', page === 1);
        document.getElementById('p2-panel').classList.toggle('active', page === 2);
        document.getElementById('p3-panel').classList.toggle('active', page === 3);
        document.getElementById('mandala').classList.toggle('active', page === 4);
        
        document.getElementById('dropzone').classList.toggle('active', page === 1 || page === 4);
        document.getElementById('velocity-panel').classList.toggle('show', page === 2);
        document.getElementById('attr-info').classList.toggle('show', page === 3);
        document.getElementById('automation-panel').classList.toggle('show', page === 4);
        
        // Hide report result on page change
        hideReportResult();
        
        document.querySelectorAll('.page-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.page) === page);
        });
        
        document.getElementById('page-title').textContent = TITLES[page];
        
        switch (page) {
            case 1: camera.position.set(0, 0, 5); break;
            case 2: camera.position.set(0, 4, 10); break;
            case 3: camera.position.set(0, 3, 6); break;
            case 4: camera.position.set(0, 5, 5); break;
        }
        camera.lookAt(0, 0, 0);
        
        currentPage = page;
    }
    
    // ================================================================
    // API & STATE
    // ================================================================
    
    async function fetchState() {
        try {
            const res = await fetch(`${API}/state?session_id=${SESSION}`);
            state = await res.json();
            updateFromState();
        } catch (e) {}
    }
    
    function updateFromState() {
        if (!state?.measure) return;
        
        const { density, stability, sigma } = state.measure;
        const pOutcome = state.forecast?.P_outcome || 0;
        
        // HUD
        const mass = density;
        const friction = sigma;
        const entropy = 1 - stability;
        const velocity = Math.max(0, density - sigma);
        
        updateMetricUI('mass', mass);
        updateMetricUI('friction', friction, true);
        updateMetricUI('entropy', entropy, true);
        updateMetricUI('velocity', velocity, false, true);
        
        // Outcome
        const outcomeEl = document.getElementById('outcome-val');
        outcomeEl.textContent = `${Math.round(pOutcome * 100)}%`;
        outcomeEl.className = 'outcome-value ' + (pOutcome >= COMMIT_THRESHOLD ? 'ready' : 'locked');
        
        // Mode
        const mode = state.ui?.mode || 'SIM';
        document.getElementById('mode-badge').textContent = mode;
        
        // Commit
        const canCommit = mode === 'SIM' && pOutcome >= COMMIT_THRESHOLD;
        document.getElementById('commit-btn').disabled = !canCommit;
        document.getElementById('commit-status').textContent = canCommit ? '' : `P < ${COMMIT_THRESHOLD * 100}%`;
        
        // Update Page 1 visuals
        if (pages[1].core) {
            pages[1].core.material.uniforms.uMass.value = mass;
        }
        if (pages[1].glow) {
            pages[1].glow.material.uniforms.uMass.value = mass;
        }
        
        // Bloom
        if (composer?.bloom) {
            composer.bloom.strength = 0.8 + mass * 1.0;
        }
    }
    
    function updateMetricUI(name, value, isDanger = false, isSuccess = false) {
        const fill = document.getElementById(`${name}-fill`);
        const val = document.getElementById(`${name}-val`);
        
        fill.style.width = `${Math.min(value, 1) * 100}%`;
        val.textContent = value.toFixed(2);
        
        if (isDanger) fill.className = 'metric-fill ' + (value > 0.5 ? 'danger' : value > 0.3 ? 'warning' : '');
        else if (isSuccess) fill.className = 'metric-fill success';
    }
    
    async function commit() {
        try {
            await fetch(`${API}/commit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: SESSION, t_ms: Date.now() })
            });
            
            document.getElementById('flash').classList.add('active');
            setTimeout(() => document.getElementById('flash').classList.remove('active'), 250);
            
            await fetchState();
        } catch (e) {}
    }
    
    // ================================================================
    // ANIMATION
    // ================================================================
    
    function animate(time = 0) {
        requestAnimationFrame(animate);
        
        const t = time * 0.001;
        
        // P1
        if (pages[1].group.visible && pages[1].core) {
            pages[1].core.material.uniforms.uTime.value = t;
            pages[1].core.rotation.y = t * 0.12;
        }
        
        // P2
        if (pages[2].group.visible) {
            pages[2].selfNode.rotation.y = t * 0.5;
            pages[2].waypoints.forEach((wp, i) => {
                wp.rotation.y = t + i;
                wp.position.y += Math.sin(t * 2 + i) * 0.002;
            });
        }
        
        // P3
        if (pages[3].group.visible) {
            pages[3].nodes.forEach((node, i) => {
                node.position.y += Math.sin(t * 1.5 + i) * 0.001;
            });
        }
        
        // P4
        if (pages[4].group.visible) {
            pages[4].core.rotation.y = t * 0.4;
            pages[4].rings.forEach((r, i) => r.rotation.z = t * 0.1 * (i + 1));
        }
        
        composer.render();
    }
    
    // ================================================================
    // EVENTS
    // ================================================================
    
    function setupEvents() {
        // Page nav
        document.querySelectorAll('.page-btn').forEach(btn => {
            btn.onclick = () => showPage(parseInt(btn.dataset.page));
        });
        
        // Keyboard
        window.onkeydown = e => {
            if (e.key >= '1' && e.key <= '4') showPage(parseInt(e.key));
        };
        
        // Persona
        document.getElementById('persona-select').onchange = e => {
            currentPersona = e.target.value;
            const config = PERSONA_CONFIG[currentPersona];
            showDopamine(`${config.automation} ÌôúÏÑ±ÌôîÎê®`);
        };
        
        // P1 sliders
        ['mass', 'volume', 'time'].forEach(id => {
            const slider = document.getElementById(`${id}-slider`);
            slider.oninput = () => {
                const val = parseFloat(slider.value);
                document.getElementById(`${id}-display`).textContent = id === 'time' ? `${val}d` : val.toFixed(2);
            };
        });
        
        // Future PR
        document.getElementById('future-pr').oninput = e => {
            const text = e.target.value.toLowerCase();
            const hasConflict = (text.includes('ÏûêÏú†') && text.includes('ÏàòÏûÖ')) || 
                               (text.includes('Ïó¨Ìñâ') && text.includes('Ï†ÄÏ∂ï'));
            updateTradeoff(hasConflict);
        };
        
        // P2 buttons
        document.getElementById('add-waypoint').onclick = () => {
            const pos = [(Math.random() - 0.5) * 6, Math.random() * 1.5, (Math.random() - 0.5) * 2];
            addWaypoint(pos, pages[2].waypoints.length);
        };
        document.getElementById('optimize-path').onclick = () => createGeodesicPath(pages[2]);
        document.getElementById('stop-line').onclick = stopTheLine;
        
        // P3 buttons
        document.getElementById('eject-all-low').onclick = ejectLowROI;
        
        // P3 node hover
        renderer.domElement.onmousemove = e => {
            if (currentPage !== 3) return;
            
            const mouse = new THREE.Vector2(
                (e.clientX / window.innerWidth) * 2 - 1,
                -(e.clientY / window.innerHeight) * 2 + 1
            );
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(pages[3].nodes);
            
            if (intersects.length > 0) {
                const node = intersects[0].object;
                const data = node.userData;
                
                document.getElementById('attr-name').textContent = `Attribute #${data.id}`;
                
                const chipsEl = document.getElementById('attr-chips');
                chipsEl.innerHTML = data.chips.map(c => 
                    `<span class="attr-chip ${data.type === 'negative' ? 'negative' : ''}">${c}</span>`
                ).join('');
                
                const roiEl = document.getElementById('attr-roi');
                roiEl.textContent = data.roi.toFixed(2);
                roiEl.className = 'roi-value ' + (data.roi < 0.3 ? 'low' : data.roi < 0.6 ? 'medium' : 'high');
                
                document.getElementById('attr-decay').textContent = 
                    `‚è± ÎßàÏßÄÎßâ ÏÉÅÌò∏ÏûëÏö©: ${data.lastInteraction}Ïùº Ï†Ñ`;
                
                document.getElementById('attr-info').classList.add('show');
            }
        };
        
        // P4 reinvest
        document.getElementById('reinvest-btn').onclick = reinvestSavedTime;
        
        // Commit
        document.getElementById('commit-btn').onclick = commit;
        
        // Automation Proposal
        document.getElementById('accept-automation').onclick = () => {
            if (currentProposal) {
                LearningAgent.acceptAutomation(currentProposal.pattern);
                updateAutomationsList();
            }
        };
        
        document.getElementById('decline-automation').onclick = hideAutomationProposal;
        
        // Dropzone events
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        
        dropzone.onclick = () => fileInput.click();
        
        fileInput.onchange = async (e) => {
            if (e.target.files.length > 0) {
                const result = await AutoReportProcessor.processFile(e.target.files[0]);
                showReportResult(result);
            }
        };
        
        dropzone.ondragover = (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        };
        
        dropzone.ondragleave = () => {
            dropzone.classList.remove('dragover');
        };
        
        dropzone.ondrop = async (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                const result = await AutoReportProcessor.processFile(e.dataTransfer.files[0]);
                showReportResult(result);
            }
        };
        
        // Report result events
        document.getElementById('report-close').onclick = hideReportResult;
        
        document.getElementById('share-btn').onclick = () => {
            const selectedIds = Array.from(document.querySelectorAll('.recipient.selected'))
                .map(el => el.dataset.id);
            
            if (selectedIds.length > 0) {
                shareReport(selectedIds, 'current_report');
                hideReportResult();
            } else {
                showDopamine('‚ö† ÏàòÏã†ÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
            }
        };
        
        // Track all user interactions for Learning Agent
        document.addEventListener('click', (e) => {
            const target = e.target;
            let action = null;
            
            if (target.classList.contains('slot')) {
                action = { type: 'invest', target: target.dataset.key, name: `${target.dataset.key} Ìà¨Ïûê`, duration: 2 };
            } else if (target.classList.contains('page-btn')) {
                action = { type: 'navigate', target: target.dataset.page, name: `P${target.dataset.page} Ïù¥Îèô`, duration: 1 };
            } else if (target.classList.contains('nav-btn')) {
                action = { type: 'action', target: target.id, name: target.textContent.trim(), duration: 3 };
            } else if (target.classList.contains('velocity-checkbox')) {
                action = { type: 'complete', target: 'velocity', name: 'High-Velocity Ï≤¥ÌÅ¨', duration: 5 };
            }
            
            if (action) {
                LearningAgent.logAction(action);
            }
        });
        
        // Resize
        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        };
    }
    
    // ================================================================
    // START
    // ================================================================
    
    init();
    </script>
</body>
</html>




