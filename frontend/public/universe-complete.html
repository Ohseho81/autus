<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AUTUS Universe Complete Edition v2.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
    
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#080b12;--panel:#0f1219;--card:#161c28;--card-hover:#1e2536;--border:rgba(255,255,255,0.06);--text:#e8ecf4;--dim:#5c6370;--cyan:#06b6d4;--green:#10b981;--yellow:#f59e0b;--orange:#f97316;--red:#ef4444;--purple:#8b5cf6;--blue:#3b82f6;--glow-cyan:rgba(6,182,212,0.4);--glow-green:rgba(16,185,129,0.4);--glow-red:rgba(239,68,68,0.4)}
    
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;-webkit-font-smoothing:antialiased}
    
    .app{display:grid;grid-template-rows:52px 1fr 56px;grid-template-columns:180px 1fr 260px;height:100vh}
    
    /* Header */
    .header{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .logo{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:700}
    .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--cyan),var(--blue));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .header-center{display:flex;align-items:center;gap:12px}
    .badge{padding:5px 10px;background:var(--card);border:1px solid var(--border);border-radius:16px;font-size:11px;display:flex;align-items:center;gap:5px}
    .badge .dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .view-toggle{display:flex;background:var(--card);border-radius:6px;padding:3px}
    .view-btn{padding:6px 14px;background:none;border:none;color:var(--dim);font-size:12px;font-weight:500;cursor:pointer;border-radius:4px;transition:all 0.2s}
    .view-btn.active{background:var(--blue);color:white}
    .view-btn:hover:not(.active){color:var(--text)}
    .header-right{display:flex;align-items:center;gap:14px}
    .metrics{display:flex;gap:10px}
    .metric{text-align:center;min-width:40px}
    .metric-value{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600}
    .metric-label{font-size:9px;color:var(--dim);text-transform:uppercase}
    .users{display:flex}
    .user-avatar{width:28px;height:28px;border-radius:50%;border:2px solid var(--bg);margin-left:-6px;display:flex;align-items:center;justify-content:center;font-size:12px;transition:transform 0.2s}
    .user-avatar:hover{transform:scale(1.1);z-index:10}
    .user-avatar:first-child{margin-left:0}
    
    /* Left Panel */
    .nodes-panel{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;padding:10px;scrollbar-width:thin;scrollbar-color:var(--card) transparent}
    .nodes-panel::-webkit-scrollbar{width:4px}
    .nodes-panel::-webkit-scrollbar-thumb{background:var(--card);border-radius:2px}
    .nodes-title{font-size:10px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding:0 2px}
    .nodes-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .node-item{aspect-ratio:1;background:var(--card);border:1px solid var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:grab;transition:all 0.15s;font-size:18px}
    .node-item:hover{border-color:var(--cyan);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .node-item:active{cursor:grabbing;transform:scale(0.95)}
    .node-item span{font-size:8px;color:var(--dim);margin-top:2px}
    
    /* Canvas */
    .canvas-area{position:relative;background:radial-gradient(ellipse at 50% 30%,#12182a 0%,var(--bg) 60%);overflow:hidden}
    .canvas-bg{position:absolute;inset:0;opacity:0.3}
    #tasksContainer{position:absolute;inset:0}
    
    /* Drop Zones */
    .drop-zones{position:absolute;bottom:70px;left:50%;transform:translateX(-50%);display:flex;gap:60px;z-index:50}
    .drop-zone{width:90px;height:90px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all 0.3s;cursor:pointer}
    .drop-zone.merge{background:radial-gradient(circle,rgba(59,130,246,0.2),transparent 70%);border:2px dashed rgba(59,130,246,0.5)}
    .drop-zone.eliminate{background:radial-gradient(circle,rgba(239,68,68,0.2),transparent 70%);border:2px dashed rgba(239,68,68,0.5)}
    .drop-zone:hover,.drop-zone.active{transform:scale(1.15)}
    .drop-zone.merge:hover,.drop-zone.merge.active{border-color:var(--blue);box-shadow:0 0 30px var(--glow-cyan)}
    .drop-zone.eliminate:hover,.drop-zone.eliminate.active{border-color:var(--red);box-shadow:0 0 30px var(--glow-red)}
    .drop-zone .icon{font-size:24px;margin-bottom:2px}
    .drop-zone .label{font-size:10px;font-weight:600}
    
    /* Tasks */
    .task{position:absolute;width:110px;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:grab;transition:all 0.2s;z-index:10;backdrop-filter:blur(8px)}
    .task:hover{border-color:var(--cyan);box-shadow:0 0 20px rgba(6,182,212,0.2)}
    .task.dragging{cursor:grabbing;box-shadow:0 15px 40px rgba(0,0,0,0.5);transform:scale(1.05);z-index:100}
    .task.magnetic{border-color:var(--blue);box-shadow:0 0 25px var(--glow-cyan);animation:magneticPulse 1s infinite}
    @keyframes magneticPulse{0%,100%{box-shadow:0 0 25px var(--glow-cyan)}50%{box-shadow:0 0 35px var(--glow-cyan)}}
    .task.ready{border-color:var(--green);box-shadow:0 0 15px var(--glow-green)}
    .task-icon{font-size:22px;margin-bottom:4px}
    .task-name{font-size:10px;font-weight:500;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .task-progress{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden}
    .task-progress-bar{height:100%;border-radius:2px;transition:width 0.4s ease}
    .task-meta{display:flex;justify-content:space-between;margin-top:4px;font-size:9px;color:var(--dim)}
    .task-k{font-family:'JetBrains Mono',monospace;color:var(--cyan)}
    
    /* Right Panel */
    .right-panel{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column}
    .panel-tabs{display:flex;border-bottom:1px solid var(--border)}
    .panel-tab{flex:1;padding:10px;background:none;border:none;color:var(--dim);font-size:11px;cursor:pointer;transition:all 0.2s;border-bottom:2px solid transparent}
    .panel-tab.active{color:var(--text);background:var(--card);border-bottom-color:var(--cyan)}
    .panel-tab:hover:not(.active){color:var(--text)}
    .panel-content{flex:1;overflow-y:auto;padding:10px;scrollbar-width:thin}
    .panel-section{display:none}
    .panel-section.active{display:block}
    
    /* AI Cards */
    .ai-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:8px;transition:all 0.2s}
    .ai-card:hover{border-color:rgba(255,255,255,0.1)}
    .ai-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .ai-card-title{font-size:11px;font-weight:600;display:flex;align-items:center;gap:6px}
    .ai-card-confidence{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 6px;border-radius:8px}
    .ai-card-desc{font-size:10px;color:var(--dim);margin-bottom:8px;line-height:1.4}
    .ai-btn{width:100%;padding:7px;border:none;border-radius:5px;color:white;font-size:10px;font-weight:600;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px}
    .ai-btn:hover{filter:brightness(1.15);transform:translateY(-1px)}
    .ai-btn:active{transform:translateY(0)}
    .ai-btn.merge{background:linear-gradient(135deg,var(--blue),#2563eb)}
    .ai-btn.eliminate{background:linear-gradient(135deg,var(--red),#dc2626)}
    .ai-btn.optimize{background:linear-gradient(135deg,var(--green),#059669)}
    
    /* API Panel */
    .api-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--card);border:1px solid var(--border);border-radius:6px;margin-bottom:6px}
    .api-item-left{display:flex;align-items:center;gap:8px}
    .api-status{width:6px;height:6px;border-radius:50%}
    .api-status.online{background:var(--green);box-shadow:0 0 6px var(--green)}
    .api-status.offline{background:var(--red)}
    .api-name{font-size:11px;font-weight:500}
    .api-test-btn{padding:3px 8px;background:var(--bg);border:1px solid var(--border);border-radius:3px;color:var(--dim);font-size:9px;cursor:pointer;transition:all 0.2s}
    .api-test-btn:hover{border-color:var(--cyan);color:var(--cyan)}
    
    /* DB Panel */
    .db-query{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--purple);margin-bottom:8px;line-height:1.5}
    .db-logs{max-height:300px;overflow-y:auto}
    .db-log{font-size:10px;padding:5px 0;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:flex-start}
    .db-log-time{color:var(--dim);font-family:'JetBrains Mono',monospace;font-size:9px;flex-shrink:0}
    .db-log-action{font-weight:600;flex-shrink:0;min-width:50px}
    .db-log-action.insert{color:var(--green)}
    .db-log-action.delete{color:var(--red)}
    .db-log-action.merge{color:var(--blue)}
    .db-log-action.query{color:var(--purple)}
    .db-log-action.api{color:var(--yellow)}
    
    /* Footer */
    .footer{grid-column:1/-1;background:var(--panel);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .footer-stats{display:flex;gap:20px}
    .footer-stat{display:flex;align-items:center;gap:6px;font-size:12px}
    .footer-stat .icon{font-size:14px}
    .footer-stat .value{font-weight:600;font-family:'JetBrains Mono',monospace}
    .footer-stat .label{color:var(--dim);font-size:10px}
    .pipeline{display:flex;align-items:center;gap:6px;font-size:11px}
    .pipeline-step{padding:5px 10px;background:var(--card);border-radius:4px;font-weight:500;transition:all 0.2s}
    .pipeline-step.active{background:var(--green);color:black}
    .pipeline-arrow{color:var(--dim);font-size:10px}
    .execute-btn{padding:8px 20px;background:linear-gradient(135deg,var(--green),#059669);border:none;border-radius:6px;color:white;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px}
    .execute-btn:hover{transform:translateY(-2px);box-shadow:0 4px 15px var(--glow-green)}
    .execute-btn:active{transform:translateY(0)}
    
    /* Toast */
    .toast{position:fixed;top:70px;right:16px;padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;font-size:12px;display:flex;align-items:center;gap:8px;z-index:1000;animation:toastIn 0.3s ease;backdrop-filter:blur(10px);max-width:300px}
    @keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-color:var(--green)}
    .toast.info{border-color:var(--blue)}
    .toast.warning{border-color:var(--yellow)}
    .toast.hide{animation:toastOut 0.3s ease forwards}
    @keyframes toastOut{to{transform:translateX(100%);opacity:0}}
    
    /* 3D Container */
    .three-container{position:absolute;inset:0;display:none}
    .three-container.active{display:block}
    
    /* Connections SVG */
    .connections{position:absolute;inset:0;pointer-events:none;z-index:5}
    .connection-line{stroke:rgba(6,182,212,0.3);stroke-width:1;fill:none}
    .connection-line.active{stroke:var(--cyan);stroke-width:2;filter:drop-shadow(0 0 4px var(--cyan))}
    
    /* Particles */
    .particle{position:absolute;width:4px;height:4px;background:var(--cyan);border-radius:50%;pointer-events:none;z-index:5}
    
    /* Responsive */
    @media(max-width:1200px){.app{grid-template-columns:160px 1fr 240px}}
    @media(max-width:900px){.app{grid-template-columns:1fr}.nodes-panel,.right-panel{display:none}}
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="logo">
        <div class="logo-icon">üèõÔ∏è</div>
        <span>AUTUS</span>
        <span style="font-size:10px;color:var(--dim);font-weight:400">v2.0</span>
      </div>
      <div class="header-center">
        <div class="badge"><span>36 Nodes</span></div>
        <div class="badge"><div class="dot"></div><span id="syncStatus">Synced</span></div>
        <div class="view-toggle">
          <button class="view-btn active" onclick="setView('2d')">2D Flow</button>
          <button class="view-btn" onclick="setView('3d')">3D Universe</button>
        </div>
      </div>
      <div class="header-right">
        <div class="metrics">
          <div class="metric"><div class="metric-value" style="color:var(--cyan)" id="metricK">4.2</div><div class="metric-label">K</div></div>
          <div class="metric"><div class="metric-value" style="color:var(--green)" id="metricI">0.85</div><div class="metric-label">I</div></div>
          <div class="metric"><div class="metric-value" style="color:var(--yellow)" id="metricR">0.92</div><div class="metric-label">r</div></div>
        </div>
        <div class="users" id="usersContainer"></div>
      </div>
    </header>
    
    <aside class="nodes-panel">
      <div class="nodes-title">36 Core Nodes</div>
      <div class="nodes-grid" id="nodesGrid"></div>
    </aside>
    
    <main class="canvas-area" id="canvasArea">
      <svg class="connections" id="connections"></svg>
      <div id="tasksContainer"></div>
      <div class="drop-zones" id="dropZones">
        <div class="drop-zone merge" id="mergeZone" data-zone="merge">
          <div class="icon">üß≤</div>
          <div class="label" style="color:var(--blue)">MERGE</div>
        </div>
        <div class="drop-zone eliminate" id="eliminateZone" data-zone="eliminate">
          <div class="icon">üï≥Ô∏è</div>
          <div class="label" style="color:var(--red)">ELIMINATE</div>
        </div>
      </div>
      <div class="three-container" id="threeContainer"></div>
    </main>
    
    <aside class="right-panel">
      <div class="panel-tabs">
        <button class="panel-tab active" data-panel="ai">ü§ñ AI</button>
        <button class="panel-tab" data-panel="api">üîó API</button>
        <button class="panel-tab" data-panel="db">üóÑÔ∏è DB</button>
      </div>
      <div class="panel-content">
        <div class="panel-section active" id="panelAI">
          <div class="ai-card">
            <div class="ai-card-header">
              <div class="ai-card-title">üß≤ Merge Suggestion</div>
              <div class="ai-card-confidence" style="background:rgba(59,130,246,0.2);color:var(--blue)">92%</div>
            </div>
            <div class="ai-card-desc">Similar tasks detected. Merging increases automation +15%</div>
            <button class="ai-btn merge" onclick="aiAction('merge')">Merge Now</button>
          </div>
          <div class="ai-card">
            <div class="ai-card-header">
              <div class="ai-card-title">üï≥Ô∏è Ready to Eliminate</div>
              <div class="ai-card-confidence" style="background:rgba(239,68,68,0.2);color:var(--red)">98%</div>
            </div>
            <div class="ai-card-desc">Task reached 100% automation. Ready for elimination.</div>
            <button class="ai-btn eliminate" onclick="aiAction('eliminate')">Eliminate</button>
          </div>
          <div class="ai-card">
            <div class="ai-card-header">
              <div class="ai-card-title">‚ö° Optimize All</div>
              <div class="ai-card-confidence" style="background:rgba(16,185,129,0.2);color:var(--green)">+15%</div>
            </div>
            <div class="ai-card-desc">Reorder and optimize all tasks for better efficiency.</div>
            <button class="ai-btn optimize" onclick="aiAction('optimize')">Optimize</button>
          </div>
        </div>
        <div class="panel-section" id="panelAPI">
          <div class="api-item"><div class="api-item-left"><div class="api-status online"></div><div class="api-name">Supabase</div></div><button class="api-test-btn" onclick="testAPI('Supabase')">Test</button></div>
          <div class="api-item"><div class="api-item-left"><div class="api-status online"></div><div class="api-name">n8n Workflow</div></div><button class="api-test-btn" onclick="testAPI('n8n')">Test</button></div>
          <div class="api-item"><div class="api-item-left"><div class="api-status online"></div><div class="api-name">ERP System</div></div><button class="api-test-btn" onclick="testAPI('ERP')">Test</button></div>
          <div class="api-item"><div class="api-item-left"><div class="api-status offline"></div><div class="api-name">Legacy CRM</div></div><button class="api-test-btn" onclick="testAPI('CRM')">Test</button></div>
        </div>
        <div class="panel-section" id="panelDB">
          <div class="db-query">MATCH $t isa task,<br>&nbsp;&nbsp;has automation >= 0.9;<br>FETCH $t;</div>
          <button class="ai-btn" style="background:linear-gradient(135deg,var(--purple),#7c3aed);margin-bottom:10px" onclick="runQuery()">Run Query</button>
          <div class="db-logs" id="dbLogs"></div>
        </div>
      </div>
    </aside>
    
    <footer class="footer">
      <div class="footer-stats">
        <div class="footer-stat"><span class="icon">üìã</span><span class="value" id="taskCount">0</span><span class="label">Tasks</span></div>
        <div class="footer-stat"><span class="icon">üß≤</span><span class="value" id="mergeCount">+0</span><span class="label">Merged</span></div>
        <div class="footer-stat"><span class="icon">üï≥Ô∏è</span><span class="value" id="elimCount">+0</span><span class="label">Eliminated</span></div>
      </div>
      <div class="pipeline">
        <div class="pipeline-step active" id="pipeGen">GEN</div>
        <span class="pipeline-arrow">‚Üí</span>
        <div class="pipeline-step" id="pipeProc">PROC</div>
        <span class="pipeline-arrow">‚Üí</span>
        <div class="pipeline-step" id="pipeRep">REP</div>
      </div>
      <button class="execute-btn" onclick="executeAll()">Execute All 90%+</button>
    </footer>
  </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTUS Universe v2.0 - Optimized
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const NODES=[{id:1,icon:'üéØ',name:'Goal'},{id:2,icon:'üì¶',name:'Inventory'},{id:3,icon:'üìà',name:'Analytics'},{id:4,icon:'üöö',name:'Logistics'},{id:5,icon:'ü§ù',name:'Partner'},{id:6,icon:'üí¨',name:'Comms'},{id:7,icon:'üíª',name:'IT'},{id:8,icon:'üí∞',name:'Finance'},{id:9,icon:'üë•',name:'HR'},{id:10,icon:'üõ°Ô∏è',name:'Security'},{id:11,icon:'üìö',name:'Training'},{id:12,icon:'üîó',name:'Integration'},{id:13,icon:'‚öñÔ∏è',name:'Compliance'},{id:14,icon:'üî¨',name:'R&D'},{id:15,icon:'üè≠',name:'Production'},{id:16,icon:'üìä',name:'Reports'},{id:17,icon:'üéß',name:'Support'},{id:18,icon:'üìù',name:'Docs'},{id:19,icon:'üîß',name:'Maintenance'},{id:20,icon:'üì±',name:'Mobile'},{id:21,icon:'üåê',name:'Web'},{id:22,icon:'‚òÅÔ∏è',name:'Cloud'},{id:23,icon:'üîí',name:'Auth'},{id:24,icon:'üìß',name:'Email'},{id:25,icon:'üìÖ',name:'Calendar'},{id:26,icon:'üí≥',name:'Payments'},{id:27,icon:'üõí',name:'Orders'},{id:28,icon:'üì¶',name:'Shipping'},{id:29,icon:'üè∑Ô∏è',name:'Pricing'},{id:30,icon:'üëî',name:'Sales'},{id:31,icon:'üì£',name:'Marketing'},{id:32,icon:'üé®',name:'Design'},{id:33,icon:'‚öôÔ∏è',name:'Settings'},{id:34,icon:'üìã',name:'Tasks'},{id:35,icon:'üîî',name:'Alerts'},{id:36,icon:'üìÅ',name:'Files'}];
const USERS=[{name:'You',color:'#ef4444',emoji:'üë§'},{name:'AI Agent',color:'#22c55e',emoji:'ü§ñ'},{name:'Sarah',color:'#3b82f6',emoji:'üë©'},{name:'Mike',color:'#a855f7',emoji:'üë®'}];

const state={tasks:[],taskId:0,mergeCount:0,elimCount:0,k:4.2,i:0.85,r:0.92,view:'2d',logs:[],dragging:null};
const $=id=>document.getElementById(id);
const $$=sel=>document.querySelectorAll(sel);

// Init
function init(){
  renderNodes();
  renderUsers();
  setupEvents();
  updateStats();
  // Demo tasks
  setTimeout(()=>{
    createTask(NODES[0],280,120);
    createTask(NODES[7],420,180);
    createTask(NODES[2],330,280);
  },300);
}

// Render
function renderNodes(){
  $('nodesGrid').innerHTML=NODES.map(n=>`<div class="node-item" draggable="true" data-id="${n.id}">${n.icon}<span>${n.name}</span></div>`).join('');
}

function renderUsers(){
  $('usersContainer').innerHTML=USERS.map(u=>`<div class="user-avatar" style="background:${u.color}" title="${u.name}">${u.emoji}</div>`).join('');
}

function renderTask(t){
  const color=t.automation>=90?'var(--green)':t.automation>=60?'var(--yellow)':'var(--blue)';
  const cls=t.automation>=90?' ready':'';
  const el=document.createElement('div');
  el.className='task'+cls;
  el.id=`task-${t.id}`;
  el.draggable=true;
  el.dataset.id=t.id;
  el.style.cssText=`left:${t.x}px;top:${t.y}px`;
  el.innerHTML=`<div class="task-icon">${t.icon}</div><div class="task-name">${t.name} #${t.id}</div><div class="task-progress"><div class="task-progress-bar" style="width:${t.automation}%;background:${color}"></div></div><div class="task-meta"><span>${t.automation}%</span><span class="task-k">K${t.k}</span></div>`;
  $('tasksContainer').appendChild(el);
  setupTaskDrag(el,t);
}

// Task Management
function createTask(node,x,y){
  const t={id:++state.taskId,nodeId:node.id,icon:node.icon,name:node.name,automation:20+Math.floor(Math.random()*50),x,y,k:(1+Math.random()*4).toFixed(1)};
  state.tasks.push(t);
  renderTask(t);
  updateStats();
  addLog('INSERT',`task:${t.id} (${node.name})`);
  toast(`‚úÖ ${node.name} task created`,'success');
  notifyOther('created a task');
}

function removeTask(id){
  const el=$(`task-${id}`);
  if(el){el.style.transform='scale(0)';el.style.opacity='0';setTimeout(()=>el.remove(),200);}
  state.tasks=state.tasks.filter(t=>t.id!==id);
}

function updateTask(t){
  const el=$(`task-${t.id}`);
  if(!el)return;
  const color=t.automation>=90?'var(--green)':t.automation>=60?'var(--yellow)':'var(--blue)';
  el.className='task'+(t.automation>=90?' ready':'');
  el.querySelector('.task-name').textContent=`${t.name} #${t.id}`;
  el.querySelector('.task-progress-bar').style.cssText=`width:${t.automation}%;background:${color}`;
  el.querySelector('.task-meta').innerHTML=`<span>${t.automation}%</span><span class="task-k">K${t.k}</span>`;
}

// Drag & Drop
function setupEvents(){
  const canvas=$('canvasArea');
  
  // Node drag
  $('nodesGrid').addEventListener('dragstart',e=>{
    if(!e.target.classList.contains('node-item'))return;
    e.dataTransfer.setData('nodeId',e.target.dataset.id);
    e.dataTransfer.setData('type','node');
  });
  
  // Canvas
  canvas.addEventListener('dragover',e=>e.preventDefault());
  canvas.addEventListener('drop',e=>{
    e.preventDefault();
    if(e.dataTransfer.getData('type')==='node'){
      const node=NODES.find(n=>n.id==e.dataTransfer.getData('nodeId'));
      const rect=canvas.getBoundingClientRect();
      createTask(node,e.clientX-rect.left-55,e.clientY-rect.top-45);
    }
  });
  
  // Drop zones
  ['mergeZone','eliminateZone'].forEach(id=>{
    const zone=$(id);
    zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('active');});
    zone.addEventListener('dragleave',()=>zone.classList.remove('active'));
    zone.addEventListener('drop',e=>{
      e.preventDefault();zone.classList.remove('active');
      const taskId=parseInt(e.dataTransfer.getData('taskId'));
      if(taskId){id==='mergeZone'?handleMerge(taskId):handleEliminate(taskId);}
    });
  });
  
  // Panel tabs
  $$('.panel-tab').forEach(tab=>{
    tab.onclick=()=>{
      $$('.panel-tab').forEach(t=>t.classList.remove('active'));
      $$('.panel-section').forEach(s=>s.classList.remove('active'));
      tab.classList.add('active');
      $(`panel${tab.dataset.panel.toUpperCase()}`).classList.add('active');
    };
  });
}

function setupTaskDrag(el,task){
  let ox,oy;
  el.addEventListener('dragstart',e=>{
    e.dataTransfer.setData('taskId',task.id);
    e.dataTransfer.setData('type','task');
    el.classList.add('dragging');
    state.dragging=task;
    const rect=el.getBoundingClientRect();
    ox=e.clientX-rect.left;oy=e.clientY-rect.top;
  });
  el.addEventListener('dragend',e=>{
    el.classList.remove('dragging');
    state.dragging=null;
    const rect=$('canvasArea').getBoundingClientRect();
    task.x=Math.max(0,Math.min(e.clientX-rect.left-ox,rect.width-115));
    task.y=Math.max(0,Math.min(e.clientY-rect.top-oy,rect.height-90));
    el.style.left=task.x+'px';el.style.top=task.y+'px';
    checkMagnetic(task);
  });
}

// Magnetic Merge
function checkMagnetic(moved){
  state.tasks.forEach(other=>{
    if(other.id===moved.id)return;
    const dx=moved.x-other.x,dy=moved.y-other.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const el1=$(`task-${moved.id}`),el2=$(`task-${other.id}`);
    if(dist<80){
      el1?.classList.add('magnetic');el2?.classList.add('magnetic');
      if(dist<35)performMerge(moved,other);
    }else{
      el1?.classList.remove('magnetic');el2?.classList.remove('magnetic');
    }
  });
  drawConnections();
}

function performMerge(t1,t2){
  t1.automation=Math.min(100,Math.max(t1.automation,t2.automation)+15);
  t1.k=(parseFloat(t1.k)+0.1).toFixed(1);
  t1.name=`${t1.name}+`;
  removeTask(t2.id);
  updateTask(t1);
  $(`task-${t1.id}`)?.classList.remove('magnetic');
  state.mergeCount++;
  state.k=Math.min(10,state.k+0.1);
  updateStats();
  addLog('MERGE',`task:${t1.id}+${t2.id}`);
  toast(`üß≤ Merged! ‚Üí ${t1.automation}%`,'info');
  notifyOther('merged tasks');
}

function handleMerge(taskId){
  const ready=state.tasks.filter(t=>t.automation>=50);
  if(ready.length>=2)performMerge(ready[0],ready[1]);
  else toast('‚ö†Ô∏è Need 2+ tasks with 50%+','warning');
}

function handleEliminate(taskId){
  const task=state.tasks.find(t=>t.id===taskId);
  if(!task)return;
  removeTask(taskId);
  state.elimCount++;
  state.i=Math.min(1,state.i+0.02);
  updateStats();
  addLog('DELETE',`task:${taskId} ‚Üí ERP`);
  toast(`üï≥Ô∏è Eliminated ‚Üí ERP submitted`,'success');
  notifyOther('eliminated a task');
}

// Connections
function drawConnections(){
  const svg=$('connections');
  svg.innerHTML='';
  if(state.tasks.length<2)return;
  for(let i=0;i<state.tasks.length-1;i++){
    const t1=state.tasks[i],t2=state.tasks[i+1];
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',t1.x+55);line.setAttribute('y1',t1.y+45);
    line.setAttribute('x2',t2.x+55);line.setAttribute('y2',t2.y+45);
    line.setAttribute('class','connection-line');
    svg.appendChild(line);
  }
}

// AI Actions
function aiAction(type){
  if(type==='merge'){
    const ready=state.tasks.filter(t=>t.automation>=50);
    if(ready.length>=2)performMerge(ready[0],ready[1]);
    else toast('‚ö†Ô∏è No tasks for merge','warning');
  }else if(type==='eliminate'){
    const task=state.tasks.find(t=>t.automation>=90);
    if(task)handleEliminate(task.id);
    else toast('‚ö†Ô∏è No tasks ready','warning');
  }else if(type==='optimize'){
    state.tasks.forEach(t=>{t.automation=Math.min(100,t.automation+5);updateTask(t);});
    toast('‚ö° All tasks +5%','success');
    notifyOther('optimized all');
  }
}

function testAPI(name){
  toast(`üîó ${name} OK (23ms)`,'success');
  addLog('API',`${name} ping`);
}

function runQuery(){
  const count=state.tasks.filter(t=>t.automation>=90).length;
  addLog('QUERY',`Found ${count} ready`);
  toast(`üóÑÔ∏è Query: ${count} results`,'info');
}

function executeAll(){
  const ready=state.tasks.filter(t=>t.automation>=90);
  if(ready.length===0){toast('‚ö†Ô∏è No 90%+ tasks','warning');return;}
  ready.forEach(t=>handleEliminate(t.id));
  updatePipeline();
}

// Stats & UI
function updateStats(){
  $('taskCount').textContent=state.tasks.length;
  $('mergeCount').textContent='+'+state.mergeCount;
  $('elimCount').textContent='+'+state.elimCount;
  $('metricK').textContent=state.k.toFixed(1);
  $('metricI').textContent=state.i.toFixed(2);
  $('metricR').textContent=state.r.toFixed(2);
  drawConnections();
}

function updatePipeline(){
  const steps=['pipeGen','pipeProc','pipeRep'];
  steps.forEach((id,i)=>{
    setTimeout(()=>{
      steps.forEach(s=>$(s).classList.remove('active'));
      $(id).classList.add('active');
    },i*800);
  });
}

function addLog(action,msg){
  const time=new Date().toTimeString().slice(0,8);
  state.logs.unshift({time,action,msg});
  $('dbLogs').innerHTML=state.logs.slice(0,15).map(l=>`<div class="db-log"><span class="db-log-time">${l.time}</span><span class="db-log-action ${l.action.toLowerCase()}">${l.action}</span><span>${l.msg}</span></div>`).join('');
}

function toast(msg,type='info'){
  const existing=document.querySelector('.toast');
  if(existing){existing.classList.add('hide');setTimeout(()=>existing.remove(),300);}
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>{el.classList.add('hide');setTimeout(()=>el.remove(),300);},2500);
}

function notifyOther(action){
  if(Math.random()>0.6){
    const user=USERS[Math.floor(Math.random()*USERS.length)];
    setTimeout(()=>toast(`${user.emoji} ${user.name} ${action}`,'info'),1500+Math.random()*1500);
  }
}

// View Toggle
function setView(view){
  state.view=view;
  $$('.view-btn').forEach((btn,i)=>btn.classList.toggle('active',i===(view==='2d'?0:1)));
  $('threeContainer').classList.toggle('active',view==='3d');
  $('tasksContainer').style.display=view==='2d'?'block':'none';
  $('dropZones').style.display=view==='2d'?'flex':'none';
  if(view==='3d')init3D();
}

// 3D (Three.js)
let scene,camera,renderer,nodes3d=[],stars;
function init3D(){
  const c=$('threeContainer');
  if(c.querySelector('canvas'))return;
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,c.clientWidth/c.clientHeight,0.1,1000);
  renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(c.clientWidth,c.clientHeight);
  c.appendChild(renderer.domElement);
  
  // Stars
  const geo=new THREE.BufferGeometry();
  const pos=[];
  for(let i=0;i<1500;i++)pos.push((Math.random()-0.5)*400,(Math.random()-0.5)*400,(Math.random()-0.5)*400);
  geo.setAttribute('position',new THREE.Float32BufferAttribute(pos,3));
  stars=new THREE.Points(geo,new THREE.PointsMaterial({color:0xffffff,size:0.4}));
  scene.add(stars);
  
  // Nodes
  NODES.slice(0,12).forEach((n,i)=>{
    const sphere=new THREE.Mesh(
      new THREE.SphereGeometry(0.8,24,24),
      new THREE.MeshBasicMaterial({color:new THREE.Color().setHSL(i/12,0.7,0.5),wireframe:true})
    );
    const a=(i/12)*Math.PI*2,r=12;
    sphere.position.set(Math.cos(a)*r,(Math.random()-0.5)*8,Math.sin(a)*r);
    scene.add(sphere);
    nodes3d.push(sphere);
  });
  
  camera.position.z=30;
  animate3D();
}

function animate3D(){
  if(state.view!=='3d')return;
  requestAnimationFrame(animate3D);
  stars.rotation.y+=0.0002;
  nodes3d.forEach((n,i)=>{n.rotation.x+=0.01;n.rotation.y+=0.01;n.position.y=Math.sin(Date.now()*0.001+i)*1.5;});
  camera.position.x=Math.sin(Date.now()*0.0002)*4;
  camera.lookAt(0,0,0);
  renderer.render(scene,camera);
}

// Start
init();
</script>
</body>
</html>
