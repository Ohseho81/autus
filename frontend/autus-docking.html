<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AUTUS — Decision Docking</title>
  <!--
    AUTUS UI
    Standards Decide.
    Look & Choose.

    UI는 계기판이다.
    엔진은 계측기다.
    결정은 인간의 것이다.
  -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --safe: #00ff88;
      --warning: #ffaa00;
      --critical: #ff4444;
      --irreversible: #660000;
      --precision: #00aaff;
      --bg: #000;
      --text: #fff;
      --text-dim: rgba(255,255,255,0.4);
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════════════════════════
       ALIGNMENT HUD (SpaceX Docking 중앙)
       ═══════════════════════════════════════════════════════════ */
    .alignment-hud {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      background: radial-gradient(circle at center, rgba(0,255,136,0.03) 0%, transparent 70%);
    }

    .hud-canvas {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1;
    }

    /* Deviation Panel */
    .deviation-panel {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-top: 24px;
    }

    .deviation-item {
      text-align: center;
    }

    .deviation-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .deviation-value {
      font-size: 20px;
      font-weight: 600;
      transition: color 0.3s;
    }

    .deviation-value.safe { color: var(--safe); }
    .deviation-value.warning { color: var(--warning); }
    .deviation-value.critical { color: var(--critical); }

    /* Rate & Range */
    .rate-range {
      display: flex;
      justify-content: center;
      gap: 48px;
      margin-top: 16px;
      padding: 12px 24px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
    }

    .rate-item {
      text-align: center;
    }

    .rate-label {
      font-size: 9px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .rate-value {
      font-size: 16px;
      font-weight: 600;
      margin-top: 2px;
    }

    /* ═══════════════════════════════════════════════════════════
       TESLA DASHBOARD (하단)
       ═══════════════════════════════════════════════════════════ */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .gauge {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 16px 12px;
      text-align: center;
    }

    .gauge-label {
      font-size: 9px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .gauge-value {
      font-size: 18px;
      font-weight: 600;
    }

    .gauge-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .gauge-fill {
      height: 100%;
      transition: width 0.5s, background 0.3s;
    }

    /* ═══════════════════════════════════════════════════════════
       PRECISION MODE
       ═══════════════════════════════════════════════════════════ */
    .precision-mode {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: rgba(0,170,255,0.1);
      border-top: 1px solid rgba(0,170,255,0.2);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .precision-mode.active {
      opacity: 1;
    }

    .precision-dot {
      width: 8px;
      height: 8px;
      background: var(--precision);
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    .precision-text {
      font-size: 11px;
      color: var(--precision);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ═══════════════════════════════════════════════════════════
       ACTION (CHOOSE)
       ═══════════════════════════════════════════════════════════ */
    .action-section {
      padding: 20px 16px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      background: var(--bg);
    }

    .choose-btn {
      width: 100%;
      padding: 18px 32px;
      font-size: 14px;
      font-weight: 700;
      font-family: inherit;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: #222;
      color: #555;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: not-allowed;
      transition: all 0.3s;
    }

    .choose-btn.enabled {
      background: var(--critical);
      color: #fff;
      border-color: var(--critical);
      cursor: pointer;
      animation: glow 2s infinite;
    }

    .choose-btn.enabled:active {
      transform: scale(0.98);
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,68,68,0.4); }
      50% { box-shadow: 0 0 20px 4px rgba(255,68,68,0.2); }
    }

    .action-note {
      text-align: center;
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 8px;
    }

    /* ═══════════════════════════════════════════════════════════
       AUDIT SCREEN
       ═══════════════════════════════════════════════════════════ */
    .audit-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.5s;
    }

    .audit-screen.hidden { display: none; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .audit-icon {
      width: 80px;
      height: 80px;
      border: 2px solid var(--safe);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--safe);
      margin-bottom: 16px;
    }

    .audit-text {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .audit-id {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 32px;
    }

    .audit-stats {
      display: flex;
      gap: 32px;
    }

    .audit-stat {
      text-align: center;
    }

    .audit-stat-label {
      font-size: 9px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .audit-stat-value {
      font-size: 20px;
      font-weight: 600;
    }

    .audit-stat-value.highlight {
      color: var(--safe);
    }

    .audit-note {
      margin-top: 32px;
      font-size: 11px;
      color: var(--text-dim);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container" id="main">
    <!-- ALIGNMENT HUD -->
    <div class="alignment-hud">
      <canvas class="hud-canvas" id="hud-canvas"></canvas>
      
      <!-- Deviation Panel -->
      <div class="deviation-panel">
        <div class="deviation-item">
          <div class="deviation-label">Roll</div>
          <div class="deviation-value safe" id="roll-value">0.00°</div>
        </div>
        <div class="deviation-item">
          <div class="deviation-label">Pitch</div>
          <div class="deviation-value safe" id="pitch-value">0.00°</div>
        </div>
        <div class="deviation-item">
          <div class="deviation-label">Yaw</div>
          <div class="deviation-value safe" id="yaw-value">0.00°</div>
        </div>
      </div>

      <!-- Rate & Range -->
      <div class="rate-range">
        <div class="rate-item">
          <div class="rate-label">Rate</div>
          <div class="rate-value" id="rate-value">0.00</div>
        </div>
        <div class="rate-item">
          <div class="rate-label">Range</div>
          <div class="rate-value" id="range-value">14d</div>
        </div>
      </div>
    </div>

    <!-- TESLA DASHBOARD -->
    <div class="dashboard">
      <div class="gauge">
        <div class="gauge-label">Velocity</div>
        <div class="gauge-value" id="velocity-value">+₩41K</div>
        <div class="gauge-bar">
          <div class="gauge-fill" id="velocity-fill" style="width: 40%; background: var(--warning)"></div>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-label">Trajectory</div>
        <div class="gauge-value" id="trajectory-value">₩12.4M</div>
        <div class="gauge-bar">
          <div class="gauge-fill" id="trajectory-fill" style="width: 26%; background: var(--safe)"></div>
        </div>
      </div>
      <div class="gauge">
        <div class="gauge-label">Energy</div>
        <div class="gauge-value" id="energy-value">74%</div>
        <div class="gauge-bar">
          <div class="gauge-fill" id="energy-fill" style="width: 74%; background: var(--safe)"></div>
        </div>
      </div>
    </div>

    <!-- PRECISION MODE -->
    <div class="precision-mode" id="precision-mode">
      <div class="precision-dot"></div>
      <div class="precision-text">Precision Mode Active</div>
    </div>

    <!-- ACTION -->
    <div class="action-section">
      <button class="choose-btn" id="choose-btn">Choose</button>
      <div class="action-note">실행 즉시 되돌릴 수 없음</div>
    </div>
  </div>

  <!-- AUDIT SCREEN -->
  <div class="audit-screen hidden" id="audit-screen">
    <div class="audit-icon">✓</div>
    <div class="audit-text">DOCKED</div>
    <div class="audit-id" id="audit-id">AUD-000000</div>
    
    <div class="audit-stats">
      <div class="audit-stat">
        <div class="audit-stat-label">Final Deviation</div>
        <div class="audit-stat-value" id="final-deviation">0.12</div>
      </div>
      <div class="audit-stat">
        <div class="audit-stat-label">Value Gained</div>
        <div class="audit-stat-value" id="value-gained">₩8.4M</div>
      </div>
      <div class="audit-stat">
        <div class="audit-stat-label">Next Precision</div>
        <div class="audit-stat-value highlight" id="next-precision">×1.3</div>
      </div>
    </div>
    
    <div class="audit-note">이 기록은 변경할 수 없습니다</div>
  </div>

  <script>
    /**
     * AUTUS — Decision Docking
     * Standards Decide. Look & Choose.
     * 
     * UI는 계기판이다.
     * 엔진은 계측기다.
     * 결정은 인간의 것이다.
     */
    (function() {
      'use strict';

      // ═══════════════════════════════════════════════════════════
      // CONFIG
      // ═══════════════════════════════════════════════════════════
      const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:8000' 
        : 'https://autus-production.up.railway.app';

      // ═══════════════════════════════════════════════════════════
      // STATE (Engine에서 받아올 값)
      // ═══════════════════════════════════════════════════════════
      const STATE = {
        // Deviation (0에 가까울수록 안전)
        roll: 0.15,
        pitch: 0.12,
        yaw: 0.18,
        
        // Rate & Range
        rate: 0.08,
        pnrDays: 14,
        
        // Cost metrics (Engine: TC, CV, VB, PNR_ETA)
        totalCost: 12400000,      // TC
        costVelocity: 41000,      // CV
        valueEnergy: 74,          // VB (%)
        pnrCost: 48000000,        // PNR_TC
        
        // State
        state: 'WARNING',  // SAFE, WARNING, CRITICAL, IRREVERSIBLE
        precisionMode: false,
        totalDecisions: 11,
        
        // Flags
        locked: false
      };

      // Elements
      const els = {
        hudCanvas: document.getElementById('hud-canvas'),
        rollValue: document.getElementById('roll-value'),
        pitchValue: document.getElementById('pitch-value'),
        yawValue: document.getElementById('yaw-value'),
        rateValue: document.getElementById('rate-value'),
        rangeValue: document.getElementById('range-value'),
        velocityValue: document.getElementById('velocity-value'),
        trajectoryValue: document.getElementById('trajectory-value'),
        energyValue: document.getElementById('energy-value'),
        velocityFill: document.getElementById('velocity-fill'),
        trajectoryFill: document.getElementById('trajectory-fill'),
        energyFill: document.getElementById('energy-fill'),
        precisionMode: document.getElementById('precision-mode'),
        chooseBtn: document.getElementById('choose-btn'),
        main: document.getElementById('main'),
        auditScreen: document.getElementById('audit-screen'),
        auditId: document.getElementById('audit-id'),
        finalDeviation: document.getElementById('final-deviation'),
        valueGained: document.getElementById('value-gained'),
        nextPrecision: document.getElementById('next-precision')
      };

      // Intervals
      let simulationInterval = null;
      let fetchInterval = null;

      // ═══════════════════════════════════════════════════════════
      // INIT
      // ═══════════════════════════════════════════════════════════
      function init() {
        setupHUD();
        fetchState();
        updateUI();
        setupEvents();
        startSimulation();
        
        // Engine 연결 (1초 간격)
        fetchInterval = setInterval(fetchState, 1000);
      }

      // ═══════════════════════════════════════════════════════════
      // ENGINE FETCH (최소 연결)
      // ═══════════════════════════════════════════════════════════
      async function fetchState() {
        if (STATE.locked) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/v1/physics/solar-binding`);
          const data = await res.json();
          
          // TC (Total Cost)
          if (data.total_loss) STATE.totalCost = data.total_loss;
          
          // CV (Cost Velocity)
          if (data.loss_rate) STATE.costVelocity = data.loss_rate;
          
          // PNR_ETA
          if (data.pnr_days !== undefined) STATE.pnrDays = data.pnr_days;
          
          // VB (Value Battery)
          STATE.valueEnergy = Math.max(0, Math.round((1 - STATE.totalCost / STATE.pnrCost) * 100));
          
          // State from API
          if (data.state) {
            STATE.state = data.state;
          }
          
          // Deviation from risk (TC/PNR_TC 비율로 변환)
          const riskRatio = STATE.totalCost / STATE.pnrCost;
          STATE.roll = riskRatio * 0.8 + Math.random() * 0.1;
          STATE.pitch = riskRatio * 0.7 + Math.random() * 0.1;
          STATE.yaw = riskRatio * 0.6 + Math.random() * 0.1;
          
          updateUI();
        } catch (e) {
          // Engine 오류 시 UI 정지 + 마지막 상태 유지
          console.log('[AUTUS] Engine offline, holding last state');
        }
      }

      // ═══════════════════════════════════════════════════════════
      // ALIGNMENT HUD (SpaceX Docking)
      // ═══════════════════════════════════════════════════════════
      function setupHUD() {
        const canvas = els.hudCanvas;
        const ctx = canvas.getContext('2d');
        
        function resize() {
          const rect = canvas.parentElement.getBoundingClientRect();
          const size = Math.min(rect.width * 0.8, 400);
          canvas.width = size * 2;
          canvas.height = size * 2;
          canvas.style.width = size + 'px';
          canvas.style.height = size + 'px';
          ctx.scale(2, 2);
        }
        resize();
        window.addEventListener('resize', resize);

        function render() {
          if (STATE.locked) return;
          
          const w = canvas.width / 2;
          const h = canvas.height / 2;
          const cx = w / 2;
          const cy = h / 2;
          const maxR = Math.min(w, h) / 2 - 20;

          // Clear
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, w, h);

          // Grid lines
          ctx.strokeStyle = 'rgba(255,255,255,0.05)';
          ctx.lineWidth = 1;
          
          // Horizontal
          for (let i = -4; i <= 4; i++) {
            ctx.beginPath();
            ctx.moveTo(cx - maxR, cy + i * (maxR / 4));
            ctx.lineTo(cx + maxR, cy + i * (maxR / 4));
            ctx.stroke();
          }
          
          // Vertical
          for (let i = -4; i <= 4; i++) {
            ctx.beginPath();
            ctx.moveTo(cx + i * (maxR / 4), cy - maxR);
            ctx.lineTo(cx + i * (maxR / 4), cy + maxR);
            ctx.stroke();
          }

          // Concentric circles
          ctx.strokeStyle = 'rgba(255,255,255,0.08)';
          [0.25, 0.5, 0.75, 1].forEach(r => {
            ctx.beginPath();
            ctx.arc(cx, cy, maxR * r, 0, Math.PI * 2);
            ctx.stroke();
          });

          // Safety zone (0.2)
          ctx.strokeStyle = 'rgba(0,255,136,0.2)';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(cx, cy, maxR * 0.2, 0, Math.PI * 2);
          ctx.stroke();

          // Optimal Point (◇) - 중앙 고정
          ctx.fillStyle = '#00ff88';
          ctx.beginPath();
          ctx.moveTo(cx, cy - 12);
          ctx.lineTo(cx + 10, cy);
          ctx.lineTo(cx, cy + 12);
          ctx.lineTo(cx - 10, cy);
          ctx.closePath();
          ctx.fill();

          // Current State (+) - deviation에 따라 이동
          const totalDev = Math.sqrt(STATE.roll**2 + STATE.pitch**2) / Math.sqrt(2);
          const angle = Math.atan2(STATE.pitch, STATE.roll);
          const currentX = cx + Math.cos(angle) * totalDev * maxR;
          const currentY = cy + Math.sin(angle) * totalDev * maxR;

          // State color
          let stateColor = '#00ff88';
          if (totalDev > 0.7) stateColor = '#ff4444';
          else if (totalDev > 0.4) stateColor = '#ffaa00';

          // Crosshair (+)
          ctx.strokeStyle = stateColor;
          ctx.lineWidth = 2;
          
          ctx.beginPath();
          ctx.moveTo(currentX - 15, currentY);
          ctx.lineTo(currentX + 15, currentY);
          ctx.stroke();
          
          ctx.beginPath();
          ctx.moveTo(currentX, currentY - 15);
          ctx.lineTo(currentX, currentY + 15);
          ctx.stroke();

          // Glow
          ctx.beginPath();
          ctx.arc(currentX, currentY, 20, 0, Math.PI * 2);
          ctx.fillStyle = stateColor + '22';
          ctx.fill();

          // Connection line
          ctx.strokeStyle = stateColor + '44';
          ctx.lineWidth = 1;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
          ctx.setLineDash([]);

          requestAnimationFrame(render);
        }
        render();
      }

      // ═══════════════════════════════════════════════════════════
      // UPDATE UI
      // ═══════════════════════════════════════════════════════════
      function updateUI() {
        // Deviation values
        updateDeviation(els.rollValue, STATE.roll);
        updateDeviation(els.pitchValue, STATE.pitch);
        updateDeviation(els.yawValue, STATE.yaw);

        // Rate & Range
        els.rateValue.textContent = STATE.rate.toFixed(2);
        els.rangeValue.textContent = `${STATE.pnrDays}d`;

        // Dashboard (Tesla gauges)
        els.velocityValue.textContent = `+₩${Math.round(STATE.costVelocity/1000)}K`;
        els.trajectoryValue.textContent = `₩${(STATE.totalCost/1000000).toFixed(1)}M`;
        els.energyValue.textContent = `${STATE.valueEnergy}%`;

        // Bars (색상만 연동)
        const velPercent = Math.min(STATE.costVelocity / 100000 * 100, 100);
        els.velocityFill.style.width = velPercent + '%';
        els.velocityFill.style.background = velPercent > 70 ? 'var(--critical)' : velPercent > 40 ? 'var(--warning)' : 'var(--safe)';

        const trajPercent = (STATE.totalCost / STATE.pnrCost) * 100;
        els.trajectoryFill.style.width = trajPercent + '%';
        els.trajectoryFill.style.background = trajPercent > 70 ? 'var(--critical)' : trajPercent > 40 ? 'var(--warning)' : 'var(--safe)';

        els.energyFill.style.width = STATE.valueEnergy + '%';
        els.energyFill.style.background = STATE.valueEnergy < 30 ? 'var(--critical)' : STATE.valueEnergy < 50 ? 'var(--warning)' : 'var(--safe)';

        // Precision Mode
        if (STATE.pnrDays < 7) {
          STATE.precisionMode = true;
          els.precisionMode.classList.add('active');
        }

        // State & Choose button
        const totalDev = Math.sqrt(STATE.roll**2 + STATE.pitch**2 + STATE.yaw**2) / Math.sqrt(3);
        
        if (STATE.pnrDays <= 0 || totalDev >= 1.0 || STATE.state === 'IRREVERSIBLE') {
          STATE.state = 'IRREVERSIBLE';
          els.chooseBtn.classList.remove('enabled');
          els.chooseBtn.textContent = 'LOCKED';
        } else if (totalDev > 0.7 || STATE.pnrDays < 7 || STATE.state === 'CRITICAL') {
          STATE.state = 'CRITICAL';
          els.chooseBtn.classList.add('enabled');
        } else if (totalDev > 0.4 || STATE.state === 'WARNING') {
          STATE.state = 'WARNING';
          els.chooseBtn.classList.remove('enabled');
        } else {
          STATE.state = 'SAFE';
          els.chooseBtn.classList.remove('enabled');
        }
      }

      function updateDeviation(el, value) {
        el.textContent = value.toFixed(2) + '°';
        el.className = 'deviation-value';
        if (value > 0.5) el.classList.add('critical');
        else if (value > 0.2) el.classList.add('warning');
        else el.classList.add('safe');
      }

      // ═══════════════════════════════════════════════════════════
      // EVENTS
      // ═══════════════════════════════════════════════════════════
      function setupEvents() {
        els.chooseBtn.addEventListener('click', executeChoice);
      }

      async function executeChoice() {
        if (!els.chooseBtn.classList.contains('enabled')) return;
        
        // 모든 실시간 계산 중단
        STATE.locked = true;
        if (simulationInterval) clearInterval(simulationInterval);
        if (fetchInterval) clearInterval(fetchInterval);

        const totalDev = Math.sqrt(STATE.roll**2 + STATE.pitch**2 + STATE.yaw**2) / Math.sqrt(3);
        const valueGained = STATE.totalCost * (1 - totalDev) * 0.7;
        const nextPrecision = 1 + (STATE.totalDecisions * 0.05);

        // ACTION_COMMIT Event 생성
        try {
          await fetch(`${API_BASE}/api/v1/action/execute`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              event_type: 'ACTION_COMMIT',
              state: STATE.state,
              metrics: {
                TC: STATE.totalCost,
                CV: STATE.costVelocity,
                VB: STATE.valueEnergy,
                PNR_ETA: STATE.pnrDays
              },
              deviation: { roll: STATE.roll, pitch: STATE.pitch, yaw: STATE.yaw }
            })
          });
        } catch (e) {
          console.log('[AUTUS] Audit API offline');
        }

        // Audit Snapshot 고정 표시
        els.auditId.textContent = `AUD-${Date.now()}`;
        els.finalDeviation.textContent = totalDev.toFixed(2);
        els.valueGained.textContent = `₩${(valueGained/1000000).toFixed(1)}M`;
        els.nextPrecision.textContent = `×${nextPrecision.toFixed(1)}`;

        // Show audit
        els.main.style.display = 'none';
        els.auditScreen.classList.remove('hidden');

        // 이후 모든 입력 차단 + Lock navigation
        window.history.pushState(null, '', '/audit');
        window.addEventListener('popstate', () => {
          window.history.pushState(null, '', '/audit');
        });
      }

      // ═══════════════════════════════════════════════════════════
      // SIMULATION (Engine 없을 때 fallback)
      // ═══════════════════════════════════════════════════════════
      function startSimulation() {
        simulationInterval = setInterval(() => {
          if (STATE.locked || STATE.state === 'IRREVERSIBLE') return;

          // Drift toward misalignment
          STATE.roll += (Math.random() - 0.45) * 0.02;
          STATE.pitch += (Math.random() - 0.45) * 0.02;
          STATE.yaw += (Math.random() - 0.45) * 0.02;

          // Clamp
          STATE.roll = Math.max(0, Math.min(1, STATE.roll));
          STATE.pitch = Math.max(0, Math.min(1, STATE.pitch));
          STATE.yaw = Math.max(0, Math.min(1, STATE.yaw));

          // Rate
          const totalDev = Math.sqrt(STATE.roll**2 + STATE.pitch**2 + STATE.yaw**2) / Math.sqrt(3);
          STATE.rate = totalDev * 0.3;

          // Cost erosion
          STATE.totalCost += Math.round(STATE.costVelocity / 86400 * 100);
          STATE.valueEnergy = Math.max(0, 100 - (STATE.totalCost / STATE.pnrCost * 100));

          // PNR countdown (slow)
          if (Math.random() < 0.01) {
            STATE.pnrDays = Math.max(0, STATE.pnrDays - 1);
            
            // PNR 도달 시 자동 PNR_CROSS Event
            if (STATE.pnrDays <= 0) {
              STATE.state = 'IRREVERSIBLE';
              els.chooseBtn.classList.remove('enabled');
              els.chooseBtn.textContent = 'LOCKED';
            }
          }

          updateUI();
        }, 100);
      }

      // ═══════════════════════════════════════════════════════════
      // START
      // ═══════════════════════════════════════════════════════════
      document.readyState === 'loading'
        ? document.addEventListener('DOMContentLoaded', init)
        : init();

    })();
  </script>
</body>
</html>
