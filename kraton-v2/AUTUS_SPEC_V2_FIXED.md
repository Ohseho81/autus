# AUTUS × AllThatBasket - 수정된 스펙 V2

## 🔴 원본 문제점 → ✅ 수정안

---

## 1. OutcomeFact 재정의

### 원본 문제
- `renewal.succeeded/failed` 하나로 묶음 → 트리거 로직 혼란
- `teacher.change_executed` = 고객 행동 아님 (시스템 결과)
- `churn.finalized` = Terminal State (트리거 의미 없음)

### ✅ 수정: 3-Tier 분류

```
┌─────────────────────────────────────────────────────┐
│  S-Tier: TRIGGER (즉시 프로세스 생성)              │
├─────────────────────────────────────────────────────┤
│  1. renewal.failed       재등록 실패               │
│  2. attendance.drop      연속 결석 ≥3회            │
│  3. notification.ignored 알림 무응답 ≥7일          │
└─────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────┐
│  A-Tier: LOG (기록만, 트리거 아님)                 │
├─────────────────────────────────────────────────────┤
│  4. renewal.succeeded    재등록 성공 (긍정 로그)   │
│  5. attendance.normal    정상 출석 (패턴 학습용)   │
│  6. notification.read    알림 확인 (반응 측정)     │
└─────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────┐
│  TERMINAL: 최종 상태 (더 이상 액션 없음)           │
├─────────────────────────────────────────────────────┤
│  7. churn.finalized      계약 종료 (통계용)        │
│  8. teacher.changed      강사 변경 완료 (결과)     │
└─────────────────────────────────────────────────────┘
```

### 임계치 명시 (LOCKED)
```javascript
const THRESHOLDS = {
  'attendance.drop': 3,        // 연속 3회 결석
  'notification.ignored': 7,   // 7일 무응답
};
```

---

## 2. V = Velocity 수정

### 원본 문제
```
VV = (CE × OY) ÷ CLF
```
→ 부정 이벤트가 많으면 점수 상승하는 역설

### ✅ 수정: 방향성 가중치 적용

```javascript
// 비가역 행동에 방향성 부여
const OUTCOME_WEIGHT = {
  'renewal.succeeded':    +1.0,   // 긍정
  'renewal.failed':       -1.0,   // 부정
  'attendance.normal':    +0.3,   // 약한 긍정
  'attendance.drop':      -0.5,   // 부정
  'notification.read':    +0.2,   // 약한 긍정
  'notification.ignored': -0.3,   // 부정
  'churn.finalized':      -2.0,   // 강한 부정
};

// 수정된 VV 공식
VV = Σ(outcome × weight) / (time × CLF)
```

### 해석
- VV > 0: 긍정 방향 (유지/확장)
- VV < 0: 부정 방향 (개선/Kill)
- VV = 0: 정체

### 새 임계치
```
VV ≥ +0.5  → Green (확장)
VV -0.2~+0.5 → Yellow (유지)
VV < -0.2  → Red (개선 or Kill)
```

---

## 3. 닫힌 순환 재정의

### 원본 문제
- "불만 미발생 순환" = 측정 불가능

### ✅ 수정: 측정 가능한 4개만

```
┌──────────────────────────────────────────────────────┐
│  닫힌 순환 (Closed Loop) - 4개 LOCKED               │
├──────────────────────────────────────────────────────┤
│                                                      │
│  1. 출석 순환                                        │
│     [수업예정] → [출석] → [다음수업예정]             │
│     닫힘 조건: 출석 완료                             │
│                                                      │
│  2. 결석 복귀 순환                                   │
│     [결석] → [알림] → [복귀출석]                     │
│     닫힘 조건: 복귀 출석 완료                        │
│     열림 조건: 연속 결석 ≥3 → attendance.drop        │
│                                                      │
│  3. 알림 반응 순환                                   │
│     [알림발송] → [확인] → [반응]                     │
│     닫힘 조건: 반응 완료 (클릭/답변)                 │
│     열림 조건: 7일 무응답 → notification.ignored     │
│                                                      │
│  4. 재등록 순환                                      │
│     [만료예정] → [안내] → [결제]                     │
│     닫힘 조건: 결제 완료 → renewal.succeeded         │
│     열림 조건: 미결제 → renewal.failed               │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### 삭제됨
- ~~불만 미발생 순환~~ → 측정 불가능, Shadow에서 추적

---

## 4. Shadow 정책 현실화

### 원본 문제
- 승격률 ≤5% = 고객 95% 무시 = 이탈 폭발

### ✅ 수정: 카테고리별 차등 승격률

```javascript
const SHADOW_POLICY = {
  // 높은 승격률 (고객 만족 영향 큼)
  'makeup.requested': {
    승격률: 70,      // 보강 요청은 대부분 승인
    자동승인조건: '가용 시간대 있음',
  },

  // 중간 승격률 (검토 필요)
  'teacher.change.requested': {
    승격률: 30,      // 강사 변경은 신중하게
    승인권한: 'owner',
  },

  // 낮은 승격률 (비용 영향)
  'discount.requested': {
    승격률: 15,      // 할인은 제한적
    자동거절조건: '이미 할인 적용 중',
  },

  // 매우 낮은 승격률 (예외적 승인)
  'complaint': {
    승격률: 5,       // 불만으로 인한 요구는 신중
    에스컬레이션: 'owner 직접 판단',
  },
};
```

### Shadow 처리 흐름
```
요청 발생
    ↓
Shadow 적재 (즉시 반영 ❌)
    ↓
카테고리별 자동 판단
    ↓
┌─────────────┬─────────────┬─────────────┐
│ 자동 승인    │ 검토 대기    │ 자동 거절    │
│ (조건 충족)  │ (수동 판단)  │ (조건 위반)  │
└─────────────┴─────────────┴─────────────┘
```

---

## 5. UI 라벨 수정

### 원본 문제
- CLF, VV 노출 = AUTUS 내부 지표 노출 = 규칙 위반

### ✅ 수정: 사용자 친화적 라벨

| 내부 지표 | UI 라벨 | 설명 |
|-----------|---------|------|
| VV | 효율 점수 | 초록/노랑/빨강 색상만 |
| CLF | 복잡도 | 낮음/보통/높음 |
| CE | 강사 점수 | 숫자 대신 별점 ⭐ |
| OY | 결과율 | 퍼센트 % |

### 강사 UI
```
┌─────────────────────────────┐
│  오늘 수업 효율              │
│  ⭐⭐⭐⭐☆ (4.2)            │
│                             │
│  현재 복잡도: 보통 🟡        │
│  학생 12명 · 연령대 3개      │
└─────────────────────────────┘
```

### 원장 UI
```
┌─────────────────────────────┐
│  이번 주 전체 효율           │
│  🟢 +0.7 (확장 가능)         │
│                             │
│  권고 사항:                  │
│  • 화요일 저녁 인원 증원      │
│  • 토요일 오전 강사 추가      │
└─────────────────────────────┘
```

---

## 6. 최종 파일 구조

```
/autus-core
  /rules
    outcome_rules.json       ← S/A/Terminal 3-Tier
    synthesis_rules.json     ← 닫힌 순환 4개
    shadow_policy.json       ← 카테고리별 승격률
    thresholds.json          ← 임계치 (3회, 7일 등)

  /engine
    fact_ledger.ts           ← append-only 기록
    state_machine.ts         ← 순환 상태 관리
    velocity_calc.ts         ← VV 계산 (가중치 적용)
    shadow_engine.ts         ← Shadow 처리
    kill_switch.ts           ← Kill 로직

  /brand/allthatbasket
    brand_config.json        ← 라벨, 색상, 임계치
    metrics_adapter.ts       ← CLF→복잡도 변환

  /ui
    owner_dashboard.tsx
    coach_view.tsx
    parent_view.tsx
```

---

## 7. 검증 체크리스트

- [ ] OutcomeFact 3개 S-Tier만 트리거
- [ ] VV 공식에 방향성 가중치 적용
- [ ] 닫힌 순환 4개 모두 측정 가능
- [ ] Shadow 승격률 카테고리별 차등
- [ ] UI에 내부 지표 직접 노출 안 함
- [ ] 임계치 모두 명시적 숫자

---

*이 문서로 구현 진행*
