/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});











/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

/**
 * AUTUS LangChain AI Server
 * =========================
 * Grok + Claude + GPT í†µí•© ë¶„ì„ API
 * 
 * ì—”ë“œí¬ì¸íŠ¸:
 * - POST /api/analyze - ì „ì²´ ìµœì í™” ë¶„ì„
 * - POST /api/predict - 12ê°œì›” ì˜ˆì¸¡
 * - POST /api/automate - ìë™í™” ì œì•ˆ
 * - POST /api/bottleneck - ë³‘ëª© íƒì§€
 * - POST /api/synergy - ì‹œë„ˆì§€ ìµœì í™”
 * - POST /api/node - ë…¸ë“œë³„ ë¶„ì„
 */

import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ChatOpenAI } from '@langchain/openai';
import { ChatAnthropic } from '@langchain/anthropic';
import { HumanMessage, SystemMessage } from '@langchain/core/messages';

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let gpt, claude, grok;

try {
  if (process.env.OPENAI_API_KEY) {
    gpt = new ChatOpenAI({
      modelName: 'gpt-4o',
      temperature: 0.7,
      openAIApiKey: process.env.OPENAI_API_KEY
    });
    console.log('âœ… GPT-4o ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ GPT-4o ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.ANTHROPIC_API_KEY) {
    claude = new ChatAnthropic({
      modelName: 'claude-3-5-sonnet-20241022',
      temperature: 0.7,
      anthropicApiKey: process.env.ANTHROPIC_API_KEY
    });
    console.log('âœ… Claude ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Claude ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

try {
  if (process.env.XAI_API_KEY) {
    grok = new ChatOpenAI({
      modelName: 'grok-beta',
      temperature: 0.7,
      openAIApiKey: process.env.XAI_API_KEY,
      configuration: {
        baseURL: 'https://api.x.ai/v1'
      }
    });
    console.log('âœ… Grok ì´ˆê¸°í™” ì™„ë£Œ');
  }
} catch (e) {
  console.log('âš ï¸ Grok ì´ˆê¸°í™” ì‹¤íŒ¨:', e.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTUS ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ AUTUS ê²½ì œ ë¬¼ë¦¬ ì—”ì§„ì˜ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.

## AUTUS ì² í•™
- ëª¨ë“  ê°œì²´ëŠ” ì‚¬ëŒìœ¼ë¡œ í™˜ì›
- í”¼ì‹œìŠ¤ì˜ ìœ ì¼í•œ í•´ë‹µì€ ëˆ
- ì˜ë¯¸ ì œê±° = ìŠ¤ì¼€ì¼ ê·¹ëŒ€í™”
- V = D - T + S (ê°€ì¹˜ = ì§ì ‘ëˆ - ì‹œê°„ë¹„ìš© + ì‹œë„ˆì§€)

## ë¶„ì„ ì›ì¹™
1. ëª¨ë“  ì œì•ˆì€ êµ¬ì²´ì  ìˆ«ìë¡œ í‘œí˜„ (ì› ë‹¨ìœ„)
2. ì‹œë„ˆì§€ìœ¨ ë³µë¦¬ ê³„ì‚°: F = V Ã— (1+s)^t
3. ë³‘ëª© = ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ëˆ ìƒì‚° ë‚®ì€ ë…¸ë“œ
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€ í•­ìƒ ê²€í† 
5. ì™¸ë¶€ ì—°ê²°(ìŠ¤í°ì„œ, íŒŒíŠ¸ë„ˆ) í™•ì¥ ì œì•ˆ

## ì‘ë‹µ í˜•ì‹
- ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ
- ìˆ«ìì™€ í¼ì„¼íŠ¸ ê°•ì¡°
- êµ¬ì²´ì  ì•¡ì…˜ ì œì•ˆ
- í•œêµ­ì–´ë¡œ ì‘ë‹µ`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI í˜¸ì¶œ í•¨ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function callAI(prompt, preferredModel = 'gpt') {
  const models = { gpt, claude, grok };
  const fallbackOrder = ['gpt', 'claude', 'grok'];
  
  // ì„ í˜¸ ëª¨ë¸ì„ ë§¨ ì•ìœ¼ë¡œ
  const order = [preferredModel, ...fallbackOrder.filter(m => m !== preferredModel)];
  
  for (const modelName of order) {
    const model = models[modelName];
    if (!model) continue;
    
    try {
      const response = await model.invoke([
        new SystemMessage(SYSTEM_PROMPT),
        new HumanMessage(prompt)
      ]);
      
      return {
        model: modelName,
        content: response.content,
        success: true
      };
    } catch (error) {
      console.log(`${modelName} í˜¸ì¶œ ì‹¤íŒ¨:`, error.message);
    }
  }
  
  // ëª¨ë“  ëª¨ë¸ ì‹¤íŒ¨ ì‹œ ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
  return {
    model: 'simulation',
    content: generateSimulationResponse(prompt),
    success: true
  };
}

function generateSimulationResponse(prompt) {
  if (prompt.includes('ì „ì²´') || prompt.includes('ìµœì í™”')) {
    return `## AUTUS AI ë¶„ì„ ê²°ê³¼

### í•µì‹¬ ë°œê²¬
â€¢ ì˜¤ì€ìš° ê°€ì¹˜ 700ë§Œ (ë‚®ìŒ) â†’ **ìë™í™” ë˜ëŠ” ì¬ë°°ì¹˜** ê¶Œì¥
  - ì‹œê°„ ë¹„ìš© ì ˆê° ì˜ˆìƒ: +500ë§Œ/ì›”

â€¢ ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì˜ˆì¸¡ ì—°ê²° ì‹œë„ˆì§€ ê°•í™” ê¶Œì¥
  - ì‹œë„ˆì§€ìœ¨ 0.30 ì ìš© ì‹œ ì›” +1,000ë§Œ ì¶”ê°€

â€¢ ì™¸ë¶€ ìŠ¤í°ì„œ ë„ì… ê¶Œì¥
  - ì˜ˆìƒ ê°€ì†: +3,000ë§Œ/ì›”

### 12ê°œì›” ì˜ˆì¸¡
í˜„ì¬ 6,000ë§Œ â†’ **5ì–µ 5,800ë§Œ** (9.3ë°° ì„±ì¥)`;
  }
  
  if (prompt.includes('ì˜ˆì¸¡') || prompt.includes('12ê°œì›”')) {
    return `## 12ê°œì›” ëˆ ìµœê³ ì¹˜ ì˜ˆì¸¡

â€¢ í˜„ì¬ ì›” ê°€ì¹˜: **6,000ë§Œì›**

### ì‹œë„ˆì§€ìœ¨ë³„ ì˜ˆì¸¡
| ì‹œë„ˆì§€ìœ¨ | 6ê°œì›” í›„ | 12ê°œì›” í›„ | ì„±ì¥ë°°ìˆ˜ |
|---------|---------|----------|---------|
| 20% | 1.1ì–µ | 2.5ì–µ | 4.2x |
| 30% | 1.6ì–µ | 5.6ì–µ | 9.3x |
| 40% | 2.3ì–µ | 13ì–µ | 21.7x |

### ê¶Œì¥ ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ â†’ ì˜¤ì€ìš° ì§ì ‘ ì—°ê²° í™œì„±í™”
2. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ 1ê°œ ì¶”ê°€
3. ì‹œë„ˆì§€ìœ¨ 30% â†’ 40% í–¥ìƒ ì§‘ì¤‘`;
  }
  
  if (prompt.includes('ìë™í™”')) {
    return `## ìë™í™” ì œì•ˆ

### ì¦‰ì‹œ ìë™í™” ê°€ëŠ¥
â€¢ **ì˜¤ì€ìš° ë°˜ë³µ ì—…ë¬´** - AI ëŒ€ì²´ 70% ê°€ëŠ¥
  - ì˜ˆìƒ ì ˆê°: 500ë§Œ/ì›”

â€¢ **ê³ ê° ì‘ëŒ€** - ì±—ë´‡ ë„ì…
  - ì˜ˆìƒ ì ˆê°: 300ë§Œ/ì›”

â€¢ **ì •ì‚° ì—…ë¬´** - ìë™í™” ì‹œìŠ¤í…œ
  - ì˜ˆìƒ ì ˆê°: 400ë§Œ/ì›”

### ì´ ì˜ˆìƒ ì ˆê°
**ì›” 1,200ë§Œì›** (ì—° 1.44ì–µ)`;
  }
  
  if (prompt.includes('ë³‘ëª©')) {
    return `## ë³‘ëª© ì§€ì  íƒì§€ ê²°ê³¼

### ì‹¬ê°ë„ ë†’ìŒ ğŸš¨
**ì˜¤ì€ìš°** - íˆ¬ì… ì‹œê°„ ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ìŒ
- í˜„ì¬ ê°€ì¹˜: 700ë§Œ/ì›”
- ì‹œë„ˆì§€ ì—°ê²°: 1ê°œ (ì•½í•¨)
- ê¶Œì¥: ìë™í™” ë˜ëŠ” ì—­í•  ì¬ì •ì˜

### ê°œì„  ì¡°ì¹˜
1. ì˜¤ì„¸í˜¸ ì§ì ‘ ì—°ê²° í™œì„±í™” â†’ +500ë§Œ/ì›”
2. ë°˜ë³µ ì—…ë¬´ ìë™í™” â†’ ì‹œê°„ 50% ì ˆê°
3. ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì—°ê²° â†’ ê°€ì¹˜ ë¶„ì‚°`;
  }
  
  if (prompt.includes('ì‹œë„ˆì§€')) {
    return `## ì‹œë„ˆì§€ ìµœì í™” ì œì•ˆ

### í˜„ì¬ ì‹œë„ˆì§€ í˜„í™©
| ì—°ê²° | ì‹œë„ˆì§€ìœ¨ | ê°œì„  ê°€ëŠ¥ |
|-----|---------|---------|
| ì˜¤ì„¸í˜¸ â†” ê¹€ê²½í¬ | 25% | â†’ 35% |
| ê¹€ê²½í¬ â†” ì˜¤ì„ ìš° | 20% | â†’ 30% |
| ì˜¤ì„ ìš° â†” ì˜¤ì—°ìš° | 15% | â†’ 25% |

### ì‹ ê·œ ì—°ê²° ì œì•ˆ
â€¢ **ì˜¤ì„¸í˜¸ â†’ ì˜¤ì—°ìš°** ì§ì ‘ ì—°ê²° (í˜„ì¬ ì—†ìŒ)
  - ì˜ˆìƒ ì‹œë„ˆì§€: 20%
  - ì˜ˆìƒ ê°€ì¹˜: +800ë§Œ/ì›”

### ìµœì í™” í›„ ì˜ˆìƒ
ì´ ê°€ì¹˜: **8,500ë§Œ/ì›”** (+40%)`;
  }
  
  return `## AI ë¶„ì„ ê²°ê³¼
ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì‹œë©´ ë” ì •í™•í•œ ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API ì—”ë“œí¬ì¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/health', (req, res) => {
  res.json({
    ok: true,
    models: {
      gpt: !!gpt,
      claude: !!claude,
      grok: !!grok
    }
  });
});

app.post('/api/analyze', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `ì•„ë˜ AUTUS ë„¤íŠ¸ì›Œí¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ (ì‚¬ëŒ):
${JSON.stringify(nodes, null, 2)}

ë§í¬ (ëˆ íë¦„):
${JSON.stringify(links, null, 2)}

ë‹¤ìŒì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:
1. í•µì‹¬ ê°€ì¹˜ ìƒì‚°ì ì‹ë³„
2. ë³‘ëª© ì§€ì  ë° ê°œì„  ë°©ì•ˆ
3. ì‹œë„ˆì§€ ê°•í™” ì œì•ˆ
4. ìë™í™” ê°€ëŠ¥ ì˜ì—­
5. 12ê°œì›” ì„±ì¥ ì˜ˆì¸¡ (ë³µë¦¬ ê³„ì‚°)

êµ¬ì²´ì ì¸ ìˆ«ì(ì› ë‹¨ìœ„)ì™€ í¼ì„¼íŠ¸ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/predict', async (req, res) => {
  const { nodes, links, months = 12, synergyRate = 0.3 } = req.body;
  
  const totalValue = nodes.reduce((sum, n) => sum + n.value, 0);
  
  const prompt = `AUTUS 12ê°œì›” ëˆ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

í˜„ì¬ ì´ ê°€ì¹˜: ${totalValue}ì›/ì›”
ì‹œë„ˆì§€ìœ¨: ${synergyRate * 100}%
ì˜ˆì¸¡ ê¸°ê°„: ${months}ê°œì›”

ë³µë¦¬ ê³µì‹: F = V Ã— (1+s)^t

ë‹¤ìŒì„ ê³„ì‚°í•´ ì£¼ì„¸ìš”:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ ìœ ì§€ ì‹œ ì˜ˆì¸¡
2. ì‹œë„ˆì§€ìœ¨ +10% í–¥ìƒ ì‹œ ì˜ˆì¸¡
3. ì‹œë„ˆì§€ìœ¨ +20% í–¥ìƒ ì‹œ ì˜ˆì¸¡
4. ìµœì í™” ë‹¬ì„±ì„ ìœ„í•œ êµ¬ì²´ì  ì•¡ì…˜

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/automate', async (req, res) => {
  const { nodes } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì—ì„œ ìë™í™” ê°€ëŠ¥í•œ ì˜ì—­ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. ë°˜ë³µ ì—…ë¬´ ìë™í™” ê°€ëŠ¥ ì˜ì—­
2. AI ëŒ€ì²´ ê°€ëŠ¥ ë¹„ìœ¨ (%)
3. ì˜ˆìƒ ë¹„ìš© ì ˆê°ì•¡ (ì›/ì›”)
4. êµ¬í˜„ ìš°ì„ ìˆœìœ„
5. êµ¬ì²´ì  ë„êµ¬/ì†”ë£¨ì…˜ ì¶”ì²œ

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'grok');
  res.json(result);
});

app.post('/api/bottleneck', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ë³‘ëª© ì§€ì ì„ íƒì§€í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. ì‹œê°„ íˆ¬ì… ëŒ€ë¹„ ê°€ì¹˜ ìƒì‚° ë‚®ì€ ë…¸ë“œ ì‹ë³„
2. ì‹œë„ˆì§€ ì—°ê²°ì´ ì•½í•œ ë…¸ë“œ
3. ê°œì„  ìš°ì„ ìˆœìœ„ (ì‹¬ê°ë„ ê¸°ì¤€)
4. êµ¬ì²´ì  í•´ê²° ë°©ì•ˆ
5. ì˜ˆìƒ ê°œì„  íš¨ê³¼ (ì›/ì›”)

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

app.post('/api/synergy', async (req, res) => {
  const { nodes, links } = req.body;
  
  const prompt = `AUTUS ë„¤íŠ¸ì›Œí¬ì˜ ì‹œë„ˆì§€ ìµœì í™”ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”:

ë…¸ë“œ ë°ì´í„°:
${JSON.stringify(nodes, null, 2)}

ë§í¬ ë°ì´í„°:
${JSON.stringify(links, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ì‹œë„ˆì§€ìœ¨ í‰ê°€
2. ì‹œë„ˆì§€ ê°•í™” ê°€ëŠ¥í•œ ì—°ê²°
3. ì‹ ê·œ ì—°ê²° ì œì•ˆ (í˜„ì¬ ì—†ëŠ” ì—°ê²°)
4. ê° ì œì•ˆë³„ ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ (ì›/ì›”)
5. ìµœì í™” í›„ ì´ ê°€ì¹˜ ì˜ˆì¸¡

ìˆ«ìë¡œ ëª…í™•í•˜ê²Œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'gpt');
  res.json(result);
});

app.post('/api/node', async (req, res) => {
  const { node, allNodes, links } = req.body;
  
  const nodeLinks = links.filter(l => l.source === node.id || l.target === node.id);
  
  const prompt = `AUTUS ë…¸ë“œ ê°œë³„ ë¶„ì„ì„ ìˆ˜í–‰í•´ ì£¼ì„¸ìš”:

ë¶„ì„ ëŒ€ìƒ:
${JSON.stringify(node, null, 2)}

ì—°ê²°ëœ ë§í¬:
${JSON.stringify(nodeLinks, null, 2)}

ì „ì²´ ë…¸ë“œ ì»¨í…ìŠ¤íŠ¸:
${JSON.stringify(allNodes, null, 2)}

ë¶„ì„ í•­ëª©:
1. í˜„ì¬ ê¸°ì—¬ë„ í‰ê°€
2. ì‹œë„ˆì§€ ì—°ê²° ìƒíƒœ
3. ê°œì„  ì œì•ˆ (êµ¬ì²´ì )
4. ìë™í™” ê°€ëŠ¥ ì—¬ë¶€
5. ì˜ˆìƒ ê°€ì¹˜ ì¦ê°€ ê°€ëŠ¥ì„± (ì›/ì›”)

ê°„ê²°í•˜ê³  ì§ì ‘ì ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

  const result = await callAI(prompt, 'claude');
  res.json(result);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„œë²„ ì‹œì‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ§  AUTUS LangChain AI Server                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Server: http://localhost:${PORT}                               â•‘
â•‘  Health: http://localhost:${PORT}/health                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Models:                                                      â•‘
â•‘  â€¢ GPT-4o:  ${gpt ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Claude:  ${claude ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â•‘  â€¢ Grok:    ${grok ? 'âœ… Ready' : 'âŒ Not configured'}                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Endpoints:                                                   â•‘
â•‘  POST /api/analyze    - ì „ì²´ ìµœì í™” ë¶„ì„                      â•‘
â•‘  POST /api/predict    - 12ê°œì›” ì˜ˆì¸¡                           â•‘
â•‘  POST /api/automate   - ìë™í™” ì œì•ˆ                           â•‘
â•‘  POST /api/bottleneck - ë³‘ëª© íƒì§€                             â•‘
â•‘  POST /api/synergy    - ì‹œë„ˆì§€ ìµœì í™”                         â•‘
â•‘  POST /api/node       - ë…¸ë“œë³„ ë¶„ì„                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

















