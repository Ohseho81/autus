<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>AUTUS Ultimate â€” 7-Layer Ã— 90-Type Ã— 3D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- GSAP for Pro Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- Three.js for 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- html2canvas for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }

        :root {
            --bg-base: #F4F4F4;
            --bg-card: #FFFFFF;
            --bg-dock: #1a1a1a;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #999999;
            --stroke-weak: #e8e8e8;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --blue: #3498db; --red: #E82127; --green: #27ae60;
            --orange: #f39c12; --yellow: #f1c40f; --purple: #9b59b6; --cyan: #1abc9c;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 24px;
        }

        [data-theme="dark"] {
            --bg-base: #0a0a0a; --bg-card: #1a1a1a; --bg-dock: #000000;
            --text-primary: #ffffff; --text-secondary: #aaaaaa; --text-muted: #666666;
            --stroke-weak: #333333; --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
        }

        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { background: var(--bg-base); color: var(--text-primary); transition: all 0.3s; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .app { display: grid; width: 100%; height: 100%; grid-template-rows: 56px 1fr 80px; grid-template-columns: 1fr; }

        @media (min-width: 1024px) {
            .app { grid-template-columns: 300px 1fr; grid-template-rows: 56px 1fr 80px; }
            .top-bar { grid-column: 1 / -1; }
            .dock { grid-column: 1 / -1; }
        }

        @media (max-width: 768px) {
            .left-panel { display: none; }
            .view-tabs { flex-wrap: wrap; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOP BAR
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .top-bar {
            background: var(--bg-card); box-shadow: var(--shadow);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 100; transition: background 0.3s;
        }

        .top-section { display: flex; align-items: center; gap: 12px; }

        .logo {
            width: 34px; height: 34px; border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--blue), var(--purple));
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: white; font-size: 15px; cursor: pointer;
        }

        .title-section h1 { font-size: 14px; font-weight: 600; }
        .title-section p { font-size: 10px; color: var(--text-secondary); }

        .view-tabs { display: flex; gap: 4px; }

        .view-tab {
            padding: 8px 14px; border-radius: 16px; font-size: 11px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; background: var(--bg-base);
            color: var(--text-secondary); border: 1px solid transparent;
        }

        .view-tab:hover { background: var(--stroke-weak); }
        .view-tab.active { background: var(--blue); color: white; }

        .icon-btn {
            width: 32px; height: 32px; border-radius: 16px;
            background: var(--bg-base); border: 1px solid var(--stroke-weak);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 13px; transition: all 0.2s;
        }

        .icon-btn:hover { background: var(--stroke-weak); transform: scale(1.08); }

        .status-badge {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 14px; font-size: 10px;
            background: rgba(39, 174, 96, 0.15); color: var(--green);
        }

        .status-dot { width: 6px; height: 6px; border-radius: 3px; background: var(--green); animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .clock {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; color: var(--text-muted);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LEFT PANEL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .left-panel {
            background: var(--bg-card); box-shadow: var(--shadow);
            padding: 14px; display: flex; flex-direction: column; gap: 12px;
            overflow-y: auto; transition: background 0.3s;
        }

        .panel-card { background: var(--bg-base); border-radius: var(--radius-md); padding: 12px; }

        .velocity-display { text-align: center; padding: 8px 0; }
        .velocity-value { font-size: 64px; font-weight: 200; line-height: 1; }
        .velocity-unit { font-size: 11px; color: var(--text-muted); letter-spacing: 3px; }

        .metric-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .metric-label { font-size: 11px; color: var(--text-secondary); min-width: 70px; }
        .metric-bar { flex: 1; height: 5px; background: var(--stroke-weak); border-radius: 3px; overflow: hidden; }
        .metric-fill { height: 100%; border-radius: 3px; transition: all 0.3s; }
        .metric-value { font-size: 12px; font-weight: 600; min-width: 35px; text-align: right; }

        /* Layer List */
        .layer-list { display: flex; flex-direction: column; gap: 4px; }

        .layer-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 10px; border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.15s;
        }

        .layer-item:hover { background: var(--bg-card); }
        .layer-item.active { background: rgba(52, 152, 219, 0.15); }

        .layer-badge {
            width: 28px; height: 28px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 700; color: white;
        }

        .layer-info { flex: 1; }
        .layer-name { font-size: 11px; font-weight: 500; }
        .layer-types { font-size: 9px; color: var(--text-muted); }
        .layer-count { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 8px; background: var(--stroke-weak); }

        /* Ledger */
        .ledger-scroll { max-height: 120px; overflow-y: auto; }

        .ledger-entry {
            display: flex; align-items: center; gap: 6px;
            padding: 6px 8px; background: var(--bg-card); border-radius: var(--radius-sm);
            margin-bottom: 4px; font-size: 9px; animation: slideIn 0.3s ease;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .ledger-time { color: var(--text-muted); font-family: 'JetBrains Mono', monospace; min-width: 50px; }
        .ledger-type { flex: 1; font-weight: 500; }
        .ledger-policy { padding: 2px 5px; border-radius: 4px; font-size: 7px; font-weight: 600; }
        .ledger-policy.normal { background: rgba(52, 152, 219, 0.2); color: var(--blue); }
        .ledger-policy.alternate { background: rgba(232, 33, 39, 0.2); color: var(--red); }
        .ledger-policy.loop { background: rgba(241, 196, 15, 0.2); color: #c9a90c; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN CANVAS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main-canvas {
            background: var(--bg-card); position: relative; overflow: hidden;
            transition: background 0.3s;
        }

        .canvas-grid {
            position: absolute; inset: 0; opacity: 0.3;
            background-image: linear-gradient(var(--stroke-weak) 1px, transparent 1px),
                              linear-gradient(90deg, var(--stroke-weak) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none;
        }

        /* View Containers */
        .view-container { position: absolute; inset: 0; opacity: 0; pointer-events: none; transition: opacity 0.4s; }
        .view-container.active { opacity: 1; pointer-events: auto; }

        /* 2D Router View */
        .router-2d { padding: 20px; display: flex; flex-direction: column; height: 100%; }
        .router-header { margin-bottom: 12px; }
        .router-title { font-size: 15px; font-weight: 600; }
        .router-subtitle { font-size: 10px; color: var(--text-secondary); }
        .router-graph { flex: 1; position: relative; }
        .router-svg { position: absolute; inset: 0; width: 100%; height: 100%; }

        @keyframes dashFlow { from { stroke-dashoffset: 0; } to { stroke-dashoffset: -40; } }
        @keyframes loopPulse { 0%, 100% { stroke-dashoffset: 0; } 50% { stroke-dashoffset: 60; } }

        .route-path { transition: stroke 0.3s; }
        .route-path.alternate { animation: dashFlow 1s linear infinite; }
        .route-path.loop { animation: loopPulse 2s ease-in-out infinite; }

        .layer-node {
            position: absolute; transform: translate(-50%, -50%);
            cursor: pointer; transition: all 0.3s;
        }

        .layer-node:hover { transform: translate(-50%, -50%) scale(1.1); }

        .layer-node-inner {
            width: 70px; height: 70px; border-radius: 35px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: var(--shadow);
        }

        .layer-node.active .layer-node-inner { box-shadow: 0 0 0 4px rgba(255,255,255,0.3), 0 8px 32px rgba(0,0,0,0.2); }

        .layer-node .id { font-size: 10px; font-weight: 700; color: white; }
        .layer-node .name { font-size: 8px; color: rgba(255,255,255,0.7); }
        .layer-node .count { font-size: 14px; font-weight: 700; color: white; margin-top: 2px; }

        .node-pulse {
            position: absolute; inset: -6px; border: 2px solid; border-radius: 50%;
            animation: nodePulse 2s infinite; pointer-events: none;
        }

        @keyframes nodePulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }

        /* 3D View */
        .three-container { position: absolute; inset: 0; }
        #threeCanvas { width: 100%; height: 100%; }

        .three-controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: var(--bg-card); padding: 10px 16px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow);
        }

        .three-btn {
            padding: 8px 14px; border-radius: var(--radius-sm);
            background: var(--bg-base); border: none; font-size: 11px;
            cursor: pointer; transition: all 0.2s; color: var(--text-primary);
        }

        .three-btn:hover { background: var(--stroke-weak); }
        .three-btn.active { background: var(--blue); color: white; }

        /* Stats View */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px; padding: 20px; height: 100%; overflow-y: auto;
        }

        .stat-card {
            background: var(--bg-base); border-radius: var(--radius-md);
            padding: 16px; display: flex; flex-direction: column; gap: 8px;
        }

        .stat-header { display: flex; justify-content: space-between; align-items: center; }
        .stat-title { font-size: 11px; color: var(--text-secondary); }
        .stat-icon { font-size: 16px; }
        .stat-value { font-size: 32px; font-weight: 200; }
        .stat-change { font-size: 10px; padding: 3px 8px; border-radius: 8px; }
        .stat-change.up { background: rgba(39, 174, 96, 0.15); color: var(--green); }
        .stat-change.down { background: rgba(232, 33, 39, 0.15); color: var(--red); }

        /* Info Bar */
        .info-bar {
            position: absolute; bottom: 16px; left: 16px; right: 16px;
            background: var(--bg-base); border-radius: var(--radius-md);
            padding: 12px 16px; display: flex; align-items: center; gap: 16px;
        }

        .info-stat { text-align: center; }
        .info-value { font-size: 18px; font-weight: 700; }
        .info-label { font-size: 8px; color: var(--text-muted); text-transform: uppercase; }

        .info-flow { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .flow-chip { padding: 4px 10px; border-radius: 10px; font-size: 9px; font-weight: 600; color: white; }
        .flow-arrow { color: var(--text-muted); font-size: 10px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BOTTOM DOCK
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .dock {
            background: var(--bg-dock); display: flex; align-items: center;
            justify-content: space-between; padding: 0 16px; transition: background 0.3s;
        }

        .dock-section { display: flex; align-items: center; gap: 8px; }

        .dock-layers { display: flex; gap: 4px; }

        .dock-layer {
            width: 44px; height: 44px; border-radius: var(--radius-sm);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
        }

        .dock-layer:hover { transform: scale(1.08); }
        .dock-layer.active { border-color: white; }
        .dock-layer .id { font-size: 10px; font-weight: 700; color: white; }
        .dock-layer .short { font-size: 7px; color: rgba(255,255,255,0.6); }

        .bucket-btns { display: flex; gap: 4px; }

        .bucket-btn {
            padding: 8px 12px; border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.06); display: flex; flex-direction: column;
            align-items: center; gap: 2px; cursor: pointer; transition: all 0.2s;
            border: 2px solid transparent;
        }

        .bucket-btn:hover { background: rgba(255,255,255,0.12); }
        .bucket-btn.active { background: rgba(255,255,255,0.15); }
        .bucket-btn .icon { font-size: 14px; }
        .bucket-btn .label { font-size: 7px; color: rgba(255,255,255,0.5); font-weight: 600; }
        .bucket-btn.active .label { color: white; }

        .export-btns { display: flex; gap: 4px; }

        .export-btn {
            padding: 8px 12px; border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.08); border: none;
            color: rgba(255,255,255,0.6); font-size: 10px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }

        .export-btn:hover { background: rgba(255,255,255,0.15); color: white; }

        .debug-pill {
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px; padding: 6px 12px; border-radius: 12px;
            background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.5);
            font-weight: 600;
        }

        .debug-pill.alt { background: rgba(232, 33, 39, 0.2); color: var(--red); }
        .debug-pill.loop { background: rgba(241, 196, 15, 0.2); color: var(--yellow); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           OVERLAYS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast {
            position: fixed; top: 70px; right: 20px; z-index: 1000;
            background: var(--bg-card); border-radius: var(--radius-md);
            padding: 12px 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 10px;
            transform: translateX(120%); transition: transform 0.4s ease;
        }

        .toast.show { transform: translateX(0); }
        .toast-icon { font-size: 18px; }
        .toast-content .toast-title { font-size: 11px; font-weight: 600; }
        .toast-content .toast-msg { font-size: 9px; color: var(--text-muted); }
        .toast-close { cursor: pointer; color: var(--text-muted); font-size: 12px; }

        .modal-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }

        .modal-overlay.show { opacity: 1; pointer-events: auto; }

        .modal {
            background: var(--bg-card); border-radius: var(--radius-xl);
            padding: 28px; max-width: 400px; width: 90%; text-align: center;
            transform: scale(0.9); transition: transform 0.3s;
        }

        .modal-overlay.show .modal { transform: scale(1); }
        .modal-icon { font-size: 48px; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .modal-msg { font-size: 12px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }

        .modal-btn {
            background: var(--blue); color: white; border: none;
            padding: 12px 28px; border-radius: var(--radius-md);
            font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }

        .modal-btn:hover { transform: scale(1.05); }

        /* Export Preview */
        .export-preview {
            position: fixed; inset: 0; z-index: 1001;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }

        .export-preview.show { opacity: 1; pointer-events: auto; }
        .export-preview img { max-width: 90%; max-height: 70%; border-radius: var(--radius-lg); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .export-actions { margin-top: 20px; display: flex; gap: 12px; }

        .export-action {
            padding: 12px 24px; border-radius: var(--radius-md);
            font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: none;
        }

        .export-action.primary { background: var(--green); color: white; }
        .export-action.secondary { background: rgba(255,255,255,0.1); color: white; }
        .export-action:hover { transform: scale(1.05); }

        /* WebSocket Status */
        .ws-status {
            position: fixed; bottom: 100px; right: 20px; z-index: 100;
            background: var(--bg-card); border-radius: var(--radius-md);
            padding: 10px 14px; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 8px;
            font-size: 10px; opacity: 0; transition: opacity 0.3s;
        }

        .ws-status.show { opacity: 1; }
        .ws-dot { width: 8px; height: 8px; border-radius: 4px; }
        .ws-dot.connected { background: var(--green); }
        .ws-dot.disconnected { background: var(--red); }
        .ws-dot.connecting { background: var(--yellow); animation: pulse 1s infinite; }
    </style>
</head>
<body>

<div class="app" id="app">
    <!-- TOP BAR -->
    <header class="top-bar">
        <div class="top-section">
            <div class="logo" onclick="location.reload()">A</div>
            <div class="title-section">
                <h1>AUTUS Ultimate</h1>
                <p>7-Layer Ã— 90-Type Ã— 3D</p>
            </div>
        </div>

        <div class="view-tabs">
            <div class="view-tab active" data-view="router" onclick="switchView('router')">ğŸš‡ Router</div>
            <div class="view-tab" data-view="three" onclick="switchView('three')">ğŸ® 3D</div>
            <div class="view-tab" data-view="stats" onclick="switchView('stats')">ğŸ“Š Stats</div>
        </div>

        <div class="top-section">
            <div class="status-badge" id="wsStatus">
                <div class="status-dot"></div>
                <span id="wsStatusText">Connected</span>
            </div>
            <div class="clock" id="clock">00:00:00</div>
            <div class="icon-btn" onclick="showToast('Notification', 'info')" title="Notifications">ğŸ””</div>
            <div class="icon-btn" onclick="toggleTheme()" title="Theme" id="themeBtn">ğŸŒ™</div>
            <div class="icon-btn" onclick="showModal()" title="Info">â„¹ï¸</div>
        </div>
    </header>

    <!-- LEFT PANEL -->
    <aside class="left-panel">
        <div class="panel-card">
            <div class="velocity-display">
                <div class="velocity-value" id="velocityValue">74</div>
                <div class="velocity-unit">MPH</div>
            </div>
            <div class="metric-row">
                <span class="metric-label">âš¡ Entropy</span>
                <div class="metric-bar"><div class="metric-fill" id="entropyFill" style="width:32%;background:var(--green);"></div></div>
                <span class="metric-value" id="entropyValue">0.32</span>
            </div>
        </div>

        <div class="panel-card">
            <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">ğŸ”— 7-LAYER SYSTEM</div>
            <div class="layer-list" id="layerList"></div>
        </div>

        <div class="panel-card" style="flex:1;overflow:hidden;">
            <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;">ğŸ“’ LEDGER (<span id="ledgerCount">0</span>)</div>
            <div class="ledger-scroll" id="ledgerContent"></div>
        </div>
    </aside>

    <!-- MAIN CANVAS -->
    <main class="main-canvas" id="mainCanvas">
        <div class="canvas-grid"></div>

        <!-- Router View -->
        <div class="view-container active" id="routerView">
            <div class="router-2d">
                <div class="router-header">
                    <div class="router-title">ğŸš‡ 7-Layer Router Graph</div>
                    <div class="router-subtitle">Policy: <span id="currentPolicy">NORMAL</span> â€¢ Type: <span id="currentType">decision.approve</span></div>
                </div>
                <div class="router-graph">
                    <svg class="router-svg" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                        </defs>
                        <path id="routePath" class="route-path" d="M60 350 Q150 350 180 280 Q210 200 320 200 Q440 200 480 120 Q520 60 700 60" stroke="var(--blue)" stroke-width="5" fill="none" stroke-linecap="round" filter="url(#glow)"/>
                    </svg>
                    <div id="layerNodesContainer"></div>
                </div>
                <div class="info-bar">
                    <div class="info-stat"><div class="info-value" id="infoVelocity" style="color:var(--blue);">74</div><div class="info-label">Velocity</div></div>
                    <div class="info-flow" id="infoFlow"></div>
                    <div class="info-stat"><div class="info-value" style="color:var(--purple);">90</div><div class="info-label">Types</div></div>
                    <div class="info-stat"><div class="info-value" style="color:var(--green);">7</div><div class="info-label">Layers</div></div>
                </div>
            </div>
        </div>

        <!-- 3D View -->
        <div class="view-container" id="threeView">
            <div class="three-container">
                <canvas id="threeCanvas"></canvas>
            </div>
            <div class="three-controls">
                <button class="three-btn active" onclick="set3DMode('orbit')">ğŸ”„ Orbit</button>
                <button class="three-btn" onclick="set3DMode('top')">â¬†ï¸ Top</button>
                <button class="three-btn" onclick="set3DMode('side')">â¡ï¸ Side</button>
                <button class="three-btn" onclick="toggle3DLabels()">ğŸ·ï¸ Labels</button>
            </div>
        </div>

        <!-- Stats View -->
        <div class="view-container" id="statsView">
            <div class="stats-grid" id="statsGrid"></div>
        </div>
    </main>

    <!-- BOTTOM DOCK -->
    <nav class="dock">
        <div class="dock-section">
            <div class="dock-layers" id="dockLayers"></div>
        </div>

        <div class="bucket-btns" id="bucketBtns"></div>

        <div class="dock-section">
            <div class="export-btns">
                <button class="export-btn" onclick="exportPNG()">ğŸ“· PNG</button>
                <button class="export-btn" onclick="exportPDF()">ğŸ“„ PDF</button>
            </div>
            <div class="debug-pill" id="debugPill">L3 | NORMAL</div>
        </div>
    </nav>
</div>

<!-- Toast -->
<div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon">â„¹ï¸</div>
    <div class="toast-content">
        <div class="toast-title" id="toastTitle">Title</div>
        <div class="toast-msg" id="toastMsg">Message</div>
    </div>
    <div class="toast-close" onclick="hideToast()">âœ•</div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)hideModal()">
    <div class="modal">
        <div class="modal-icon">ğŸš€</div>
        <div class="modal-title">AUTUS Ultimate</div>
        <div class="modal-msg">7-Layer Architecture Ã— 90-Type Router Ã— 3D Visualization<br>WebSocket Ready â€¢ Export PDF/PNG â€¢ Responsive</div>
        <button class="modal-btn" onclick="hideModal()">Got it</button>
    </div>
</div>

<!-- Export Preview -->
<div class="export-preview" id="exportPreview">
    <img id="exportImage" src="" alt="Export Preview">
    <div class="export-actions">
        <button class="export-action primary" onclick="downloadExport()">ğŸ’¾ Download</button>
        <button class="export-action secondary" onclick="hideExportPreview()">âœ• Close</button>
    </div>
</div>

<!-- WebSocket Status -->
<div class="ws-status" id="wsStatusBox">
    <div class="ws-dot connecting" id="wsDot"></div>
    <span id="wsText">Connecting...</span>
</div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const LAYERS = {
        L0: { name: 'ExternalField', short: 'EXT', color: '#2c3e50', x: 8, y: 88 },
        L1: { name: 'SystemBar', short: 'SYS', color: '#3498db', x: 20, y: 72 },
        L2: { name: 'EntityPanel', short: 'ENT', color: '#27ae60', x: 35, y: 52 },
        L3: { name: 'CoreCanvas', short: 'CORE', color: '#f39c12', x: 50, y: 38 },
        L4: { name: 'FlowDock', short: 'DOCK', color: '#9b59b6', x: 65, y: 25 },
        L5: { name: 'ContextOverlay', short: 'CTX', color: '#1abc9c', x: 80, y: 15 },
        L6: { name: 'Override', short: 'OVR', color: '#E82127', x: 92, y: 8 }
    };

    const LAYER_TYPE_MAP = {
        'state.initial': 'L0', 'state.active': 'L2', 'state.pending': 'L5', 'state.completed': 'L3',
        'state.failed': 'L6', 'state.archived': 'L0', 'signal.trigger': 'L5', 'signal.alert': 'L5',
        'signal.info': 'L1', 'signal.error': 'L6', 'signal.notification': 'L1', 'decision.approve': 'L3',
        'decision.reject': 'L6', 'decision.route': 'L3', 'action.execute': 'L3', 'action.queue': 'L4',
        'action.process': 'L4', 'constraint.policy': 'L6', 'constraint.validation': 'L5', 'record.log': 'L0',
        'record.metric': 'L2', 'record.audit': 'L2'
    };

    const TYPES = {
        'decision.approve': { policy: 'NORMAL', bucket: 'decision', icon: 'âœ“' },
        'decision.reject': { policy: 'ALTERNATE', bucket: 'decision', icon: 'âœ—' },
        'decision.route': { policy: 'NORMAL', bucket: 'decision', icon: 'ğŸ›¤' },
        'signal.alert': { policy: 'ALTERNATE', bucket: 'signal', icon: 'ğŸš¨' },
        'signal.info': { policy: 'NORMAL', bucket: 'signal', icon: 'â„¹ï¸' },
        'action.execute': { policy: 'NORMAL', bucket: 'action', icon: 'â–¶ï¸' },
        'action.queue': { policy: 'LOOP', bucket: 'action', icon: 'ğŸ“‹' },
        'constraint.policy': { policy: 'ALTERNATE', bucket: 'constraint', icon: 'ğŸ“œ' },
        'state.active': { policy: 'NORMAL', bucket: 'state', icon: 'â–¶ï¸' },
        'record.metric': { policy: 'NORMAL', bucket: 'record', icon: 'ğŸ“Š' }
    };

    const POLICY_COLORS = { NORMAL: '#3498db', ALTERNATE: '#E82127', LOOP: '#f1c40f' };
    const BUCKETS = ['all', 'state', 'signal', 'decision', 'action', 'constraint', 'record'];
    const BUCKET_ICONS = { all: 'ğŸ”—', state: 'ğŸ“Š', signal: 'ğŸ“¡', decision: 'â¦¿', action: 'âš¡', constraint: 'ğŸ”’', record: 'ğŸ“' };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const state = {
        currentView: 'router',
        currentLayer: 'L3',
        currentType: 'decision.approve',
        currentBucket: 'all',
        velocity: 74,
        entropy: 0.32,
        theme: 'light',
        wsConnected: false,
        show3DLabels: true
    };

    const ledger = { entries: [], maxEntries: 20 };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderLayerList() {
        const container = document.getElementById('layerList');
        container.innerHTML = Object.entries(LAYERS).map(([id, l]) => {
            const count = Object.values(LAYER_TYPE_MAP).filter(v => v === id).length;
            return `
                <div class="layer-item ${state.currentLayer === id ? 'active' : ''}" onclick="selectLayer('${id}')">
                    <div class="layer-badge" style="background:${l.color};">${id}</div>
                    <div class="layer-info">
                        <div class="layer-name">${l.name}</div>
                        <div class="layer-types">z-index: ${id.slice(1)}0</div>
                    </div>
                    <div class="layer-count">${count}</div>
                </div>
            `;
        }).join('');
    }

    function renderLayerNodes() {
        const container = document.getElementById('layerNodesContainer');
        container.innerHTML = Object.entries(LAYERS).map(([id, l]) => {
            const count = Object.values(LAYER_TYPE_MAP).filter(v => v === id).length;
            const isActive = state.currentLayer === id;
            return `
                <div class="layer-node ${isActive ? 'active' : ''}" style="left:${l.x}%;top:${l.y}%;" onclick="selectLayer('${id}')">
                    ${isActive ? `<div class="node-pulse" style="border-color:${l.color};"></div>` : ''}
                    <div class="layer-node-inner" style="background:${l.color};">
                        <div class="id">${id}</div>
                        <div class="name">${l.short}</div>
                        <div class="count">${count}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderDockLayers() {
        document.getElementById('dockLayers').innerHTML = Object.entries(LAYERS).map(([id, l]) => `
            <div class="dock-layer ${state.currentLayer === id ? 'active' : ''}" style="background:${l.color};" onclick="selectLayer('${id}')">
                <div class="id">${id}</div>
                <div class="short">${l.short}</div>
            </div>
        `).join('');
    }

    function renderBucketBtns() {
        document.getElementById('bucketBtns').innerHTML = BUCKETS.map(b => `
            <div class="bucket-btn ${state.currentBucket === b ? 'active' : ''}" onclick="filterBucket('${b}')">
                <span class="icon">${BUCKET_ICONS[b]}</span>
                <span class="label">${b.toUpperCase()}</span>
            </div>
        `).join('');
    }

    function renderLedger() {
        document.getElementById('ledgerContent').innerHTML = ledger.entries.map(e => `
            <div class="ledger-entry">
                <span class="ledger-time">${e.time}</span>
                <span class="ledger-type">${e.type.split('.')[1]}</span>
                <span class="ledger-policy ${e.policy.toLowerCase()}">${e.layer}</span>
            </div>
        `).join('');
        document.getElementById('ledgerCount').textContent = ledger.entries.length;
    }

    function renderInfoFlow() {
        const typeData = TYPES[state.currentType] || { policy: 'NORMAL' };
        const targetLayer = LAYER_TYPE_MAP[state.currentType] || 'L3';
        let flow = typeData.policy === 'NORMAL' ? ['L0', 'L2', targetLayer] :
                   typeData.policy === 'ALTERNATE' ? ['L0', 'L5', 'L6', targetLayer] :
                   ['L0', 'L4', targetLayer, 'L4'];

        document.getElementById('infoFlow').innerHTML = flow.map((l, i) => `
            <div class="flow-chip" style="background:${LAYERS[l].color};">${l}</div>
            ${i < flow.length - 1 ? '<span class="flow-arrow">â†’</span>' : ''}
        `).join('');
    }

    function renderStats() {
        const stats = [
            { title: 'Velocity', icon: 'âš¡', value: state.velocity, change: '+5%', up: true },
            { title: 'Entropy', icon: 'ğŸ”¥', value: state.entropy.toFixed(2), change: '-2%', up: false },
            { title: 'Active Layer', icon: 'ğŸ“', value: state.currentLayer, change: '', up: true },
            { title: 'Current Type', icon: 'ğŸ¯', value: state.currentType.split('.')[1], change: '', up: true },
            { title: 'Ledger Events', icon: 'ğŸ“’', value: ledger.entries.length, change: '+3', up: true },
            { title: 'Total Types', icon: 'ğŸ“Š', value: Object.keys(TYPES).length, change: '', up: true }
        ];

        document.getElementById('statsGrid').innerHTML = stats.map(s => `
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">${s.title}</span>
                    <span class="stat-icon">${s.icon}</span>
                </div>
                <div class="stat-value">${s.value}</div>
                ${s.change ? `<div class="stat-change ${s.up ? 'up' : 'down'}">${s.change}</div>` : ''}
            </div>
        `).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function selectLayer(id) {
        state.currentLayer = id;
        const layer = LAYERS[id];

        // GSAP Animation
        gsap.to('#routePath', { stroke: layer.color, duration: 0.3 });

        updateDebugPill();
        renderLayerList();
        renderLayerNodes();
        renderDockLayers();
        renderInfoFlow();

        // Record to ledger
        recordLedger(state.currentType, id);

        showToast(`Layer ${id} activated`, 'info');
    }

    function selectType(typeSlug) {
        state.currentType = typeSlug;
        const typeData = TYPES[typeSlug] || { policy: 'NORMAL' };
        const targetLayer = LAYER_TYPE_MAP[typeSlug] || 'L3';

        document.getElementById('currentType').textContent = typeSlug;
        document.getElementById('currentPolicy').textContent = typeData.policy;

        const routePath = document.getElementById('routePath');
        const color = POLICY_COLORS[typeData.policy];
        gsap.to(routePath, { stroke: color, duration: 0.3 });

        routePath.classList.remove('alternate', 'loop');
        if (typeData.policy === 'ALTERNATE') {
            routePath.style.strokeDasharray = '12,8';
            routePath.classList.add('alternate');
        } else if (typeData.policy === 'LOOP') {
            routePath.style.strokeDasharray = '20,12';
            routePath.classList.add('loop');
        } else {
            routePath.style.strokeDasharray = '0';
        }

        selectLayer(targetLayer);
    }

    function filterBucket(bucket) {
        state.currentBucket = bucket;
        renderBucketBtns();
    }

    function recordLedger(type, layer) {
        ledger.entries.unshift({
            time: new Date().toLocaleTimeString('en-US', { hour12: false }),
            type: type,
            policy: (TYPES[type] || { policy: 'NORMAL' }).policy,
            layer: layer
        });
        if (ledger.entries.length > ledger.maxEntries) ledger.entries.pop();
        renderLedger();
    }

    function updateDebugPill() {
        const typeData = TYPES[state.currentType] || { policy: 'NORMAL' };
        const pill = document.getElementById('debugPill');
        pill.textContent = `${state.currentLayer} | ${typeData.policy}`;
        pill.classList.remove('alt', 'loop');
        if (typeData.policy === 'ALTERNATE') pill.classList.add('alt');
        if (typeData.policy === 'LOOP') pill.classList.add('loop');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VIEWS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function switchView(view) {
        state.currentView = view;
        document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
        document.querySelectorAll('.view-container').forEach(v => v.classList.toggle('active', v.id === view + 'View'));

        if (view === 'three') initThree();
        if (view === 'stats') renderStats();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THREE.JS 3D
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let scene, camera, renderer, layerMeshes = [];
    let threeInitialized = false;

    function initThree() {
        if (threeInitialized) return;
        threeInitialized = true;

        const canvas = document.getElementById('threeCanvas');
        const container = canvas.parentElement;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(state.theme === 'dark' ? 0x0a0a0a : 0xf4f4f4);

        camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 8, 12);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // Ambient Light
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);

        // Create Layer Discs
        Object.entries(LAYERS).forEach(([id, layer], i) => {
            const geometry = new THREE.CylinderGeometry(1.2, 1.2, 0.3, 32);
            const material = new THREE.MeshStandardMaterial({ color: layer.color, metalness: 0.3, roughness: 0.7 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.y = i * 1.2 - 3.6;
            mesh.userData = { id, layer };
            scene.add(mesh);
            layerMeshes.push(mesh);

            // Connection line
            if (i > 0) {
                const lineGeom = new THREE.BufferGeometry().setFromPoints([
                    new THREE.Vector3(0, (i - 1) * 1.2 - 3.6 + 0.15, 0),
                    new THREE.Vector3(0, i * 1.2 - 3.6 - 0.15, 0)
                ]);
                const lineMat = new THREE.LineBasicMaterial({ color: 0x666666 });
                scene.add(new THREE.Line(lineGeom, lineMat));
            }
        });

        animate3D();
    }

    function animate3D() {
        requestAnimationFrame(animate3D);

        // Rotate meshes slightly
        layerMeshes.forEach((mesh, i) => {
            mesh.rotation.y += 0.005;
            // Highlight active layer
            const isActive = mesh.userData.id === state.currentLayer;
            mesh.scale.setScalar(isActive ? 1.2 : 1);
        });

        renderer.render(scene, camera);
    }

    function set3DMode(mode) {
        document.querySelectorAll('.three-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        gsap.to(camera.position, {
            x: mode === 'side' ? 15 : 0,
            y: mode === 'top' ? 15 : 8,
            z: mode === 'top' ? 0.1 : (mode === 'side' ? 0 : 12),
            duration: 1,
            ease: 'power2.out',
            onUpdate: () => camera.lookAt(0, 0, 0)
        });
    }

    function toggle3DLabels() {
        state.show3DLabels = !state.show3DLabels;
        showToast(`Labels ${state.show3DLabels ? 'ON' : 'OFF'}`, 'info');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPORT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let exportDataUrl = '';

    function exportPNG() {
        showToast('Capturing...', 'info');

        html2canvas(document.getElementById('app'), {
            scale: 2,
            backgroundColor: state.theme === 'dark' ? '#0a0a0a' : '#f4f4f4'
        }).then(canvas => {
            exportDataUrl = canvas.toDataURL('image/png');
            document.getElementById('exportImage').src = exportDataUrl;
            document.getElementById('exportPreview').classList.add('show');
        });
    }

    function exportPDF() {
        showToast('Generating PDF...', 'info');

        html2canvas(document.getElementById('app'), { scale: 2 }).then(canvas => {
            exportDataUrl = canvas.toDataURL('image/png');
            // In real app, use jsPDF here
            document.getElementById('exportImage').src = exportDataUrl;
            document.getElementById('exportPreview').classList.add('show');
        });
    }

    function downloadExport() {
        const link = document.createElement('a');
        link.download = `autus-dashboard-${Date.now()}.png`;
        link.href = exportDataUrl;
        link.click();
        hideExportPreview();
        showToast('Downloaded!', 'success');
    }

    function hideExportPreview() {
        document.getElementById('exportPreview').classList.remove('show');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WEBSOCKET (Simulated)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let ws;
    function initWebSocket() {
        const wsBox = document.getElementById('wsStatusBox');
        const wsDot = document.getElementById('wsDot');
        const wsText = document.getElementById('wsText');
        const wsStatusBadge = document.getElementById('wsStatus');
        const wsStatusText = document.getElementById('wsStatusText');

        wsBox.classList.add('show');

        try {
            // Auto-detect: use same host as page, or fallback to localhost
            const wsHost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'localhost' 
                : window.location.hostname;
            ws = new WebSocket(`ws://${wsHost}:3001`);

            ws.onopen = () => {
                console.log('ğŸ”Œ WebSocket Connected');
                wsDot.classList.remove('connecting', 'disconnected');
                wsDot.classList.add('connected');
                wsText.textContent = 'Connected';
                wsStatusText.textContent = 'Live';
                wsStatusBadge.style.background = 'rgba(39, 174, 96, 0.15)';
                wsStatusBadge.style.color = 'var(--green)';
                state.wsConnected = true;
                showToast('WebSocket Connected!', 'success');
                setTimeout(() => wsBox.classList.remove('show'), 2000);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleWSMessage(msg);
            };

            ws.onclose = () => {
                console.log('ğŸ”Œ WebSocket Disconnected');
                wsDot.classList.remove('connecting', 'connected');
                wsDot.classList.add('disconnected');
                wsText.textContent = 'Disconnected';
                wsStatusText.textContent = 'Offline';
                wsStatusBadge.style.background = 'rgba(232, 33, 39, 0.15)';
                wsStatusBadge.style.color = 'var(--red)';
                state.wsConnected = false;
                // Reconnect after 3s
                setTimeout(initWebSocket, 3000);
            };

            ws.onerror = (err) => {
                console.log('ğŸ”Œ WebSocket Error - Using simulation mode');
                wsText.textContent = 'Simulation';
                wsStatusText.textContent = 'Simulated';
                setTimeout(() => wsBox.classList.remove('show'), 2000);
            };
        } catch (e) {
            console.log('ğŸ”Œ WebSocket not available - Using simulation mode');
            wsText.textContent = 'Simulation';
            setTimeout(() => wsBox.classList.remove('show'), 2000);
        }
    }

    function handleWSMessage(msg) {
        switch (msg.type) {
            case 'INIT':
                console.log('ğŸ“¥ Received INIT:', msg.data);
                break;
            case 'STATE':
                state.velocity = msg.data.velocity;
                state.entropy = msg.data.entropy;
                state.currentLayer = msg.data.currentLayer;
                state.currentType = msg.data.currentType;
                document.getElementById('velocityValue').textContent = Math.round(state.velocity);
                document.getElementById('infoVelocity').textContent = Math.round(state.velocity);
                document.getElementById('entropyValue').textContent = state.entropy.toFixed(2);
                break;
            case 'TICK':
                document.getElementById('velocityValue').textContent = msg.data.velocity;
                document.getElementById('infoVelocity').textContent = msg.data.velocity;
                document.getElementById('entropyValue').textContent = msg.data.entropy;
                break;
            case 'LEDGER':
                recordLedger(msg.data.type, msg.data.layer);
                break;
        }
    }

    function sendWS(type, data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type, data }));
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', state.theme);
        document.getElementById('themeBtn').textContent = state.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';

        if (scene) scene.background = new THREE.Color(state.theme === 'dark' ? 0x0a0a0a : 0xf4f4f4);
    }

    function showToast(msg, type = 'info') {
        const icons = { success: 'âœ“', warning: 'âš ï¸', error: 'âœ—', info: 'â„¹ï¸' };
        document.getElementById('toastIcon').textContent = icons[type];
        document.getElementById('toastTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1);
        document.getElementById('toastMsg').textContent = msg;
        document.getElementById('toast').classList.add('show');
        setTimeout(hideToast, 3000);
    }

    function hideToast() { document.getElementById('toast').classList.remove('show'); }
    function showModal() { document.getElementById('modalOverlay').classList.add('show'); }
    function hideModal() { document.getElementById('modalOverlay').classList.remove('show'); }

    function updateClock() {
        document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
    }

    function simulate() {
        state.velocity = Math.max(0, Math.min(120, state.velocity + (Math.random() - 0.4) * 4));
        state.entropy = Math.max(0, Math.min(1, state.entropy + (Math.random() - 0.5) * 0.05));

        document.getElementById('velocityValue').textContent = Math.round(state.velocity);
        document.getElementById('infoVelocity').textContent = Math.round(state.velocity);
        document.getElementById('entropyValue').textContent = state.entropy.toFixed(2);
        document.getElementById('entropyFill').style.width = (state.entropy * 100) + '%';
        document.getElementById('entropyFill').style.background = 
            state.entropy > 0.6 ? 'var(--red)' : state.entropy > 0.3 ? 'var(--orange)' : 'var(--green)';

        // Random type selection
        if (Math.random() < 0.05) {
            const types = Object.keys(TYPES);
            selectType(types[Math.floor(Math.random() * types.length)]);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    renderLayerList();
    renderLayerNodes();
    renderDockLayers();
    renderBucketBtns();
    renderLedger();
    renderInfoFlow();
    updateClock();
    selectType('decision.approve');
    initWebSocket();

    setInterval(simulate, 300);
    setInterval(updateClock, 1000);

    // Responsive resize
    window.addEventListener('resize', () => {
        if (renderer) {
            const container = document.getElementById('threeCanvas').parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
    });

    console.log('ğŸš€ AUTUS Ultimate â€” 7-Layer Ã— 90-Type Ã— 3D');
</script>

</body>
</html>

