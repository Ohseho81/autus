<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AUTUS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --subject: #00ff88;
      --operator: #00aaff;
      --education: #ff66ff;
      --sponsor: #ffaa00;
      --pnr: #ff4444;
      --safe: #00ff88;
      --warning: #ffaa00;
      --critical: #ff4444;
      --bg: #000;
      --bg-card: rgba(255,255,255,0.02);
      --border: rgba(255,255,255,0.08);
      --text: #fff;
      --text-dim: rgba(255,255,255,0.4);
    }
    html, body { width: 100%; height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: -apple-system, 'SF Pro Display', sans-serif; }
    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

    /* BACK BUTTON */
    .back-btn {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 36px;
      height: 36px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.3s;
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    /* LAYER 1: EXTERNAL FIELD */
    .external-field { flex: 0 0 auto; padding: 12px 20px; padding-left: 56px; background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%); border-bottom: 1px solid var(--border); }
    .external-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .logo { font-size: 18px; font-weight: 300; letter-spacing: 4px; }
    .external-label { font-size: 9px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
    .external-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
    .external-node { flex: 0 0 auto; min-width: 64px; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; text-align: center; }
    .external-node.safe { border-color: var(--safe); }
    .external-node.warning { border-color: var(--warning); }
    .external-node.critical { border-color: var(--critical); }
    .external-icon { font-size: 16px; margin-bottom: 4px; }
    .external-name { font-size: 9px; color: var(--text-dim); letter-spacing: 0.5px; }
    .external-status { width: 6px; height: 6px; border-radius: 50%; margin: 6px auto 0; }
    .external-node.safe .external-status { background: var(--safe); box-shadow: 0 0 8px var(--safe); }
    .external-node.warning .external-status { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
    .external-node.critical .external-status { background: var(--critical); box-shadow: 0 0 8px var(--critical); animation: pulse 2s infinite; }

    /* LAYER 2: DECISION FIELD */
    .decision-field { flex: 1; position: relative; overflow: hidden; }
    .field-canvas { width: 100%; height: 100%; position: relative; }
    .goal-node { position: absolute; top: 8%; left: 50%; transform: translateX(-50%); text-align: center; }
    .goal-circle { width: 56px; height: 56px; border-radius: 50%; background: radial-gradient(circle, rgba(0,255,136,0.3) 0%, transparent 70%); border: 2px solid var(--safe); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; animation: goalPulse 3s infinite; }
    .goal-icon { font-size: 24px; }
    .goal-label { font-size: 10px; color: var(--text-dim); letter-spacing: 1px; }
    .goal-name { font-size: 12px; font-weight: 600; color: var(--safe); }
    .path-container { position: absolute; top: 18%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 55%; }
    .path-svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    .path-line { fill: none; stroke: var(--safe); stroke-width: 3; stroke-linecap: round; opacity: 0.6; }
    .path-line.active { opacity: 1; filter: drop-shadow(0 0 8px var(--safe)); }
    .path-line.pnr { stroke: var(--critical); stroke-dasharray: 8 4; filter: drop-shadow(0 0 8px var(--critical)); }
    .path-line.inactive { stroke: rgba(255,255,255,0.1); stroke-dasharray: 4 4; }
    .decision-node { position: absolute; display: flex; flex-direction: column; align-items: center; transform: translate(-50%, -50%); cursor: pointer; transition: all 0.3s; }
    .decision-node:hover { transform: translate(-50%, -50%) scale(1.1); }
    .node-circle { width: 40px; height: 40px; border-radius: 50%; border: 2px solid; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; background: var(--bg); }
    .node-circle.subject { border-color: var(--subject); color: var(--subject); }
    .node-circle.education { border-color: var(--education); color: var(--education); }
    .node-circle.sponsor { border-color: var(--sponsor); color: var(--sponsor); }
    .node-circle.operator { border-color: var(--operator); color: var(--operator); }
    .node-circle.complete { background: currentColor; color: #000; }
    .node-circle.current { box-shadow: 0 0 20px currentColor; animation: nodePulse 2s infinite; }
    .node-circle.pnr { border-color: var(--critical) !important; color: var(--critical) !important; box-shadow: 0 0 20px var(--critical); }
    .node-label { font-size: 9px; color: var(--text-dim); margin-top: 6px; text-align: center; max-width: 80px; }
    .node-label.current { color: var(--text); font-weight: 500; }
    .transfer-badge { position: absolute; padding: 2px 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 8px; color: var(--text-dim); }
    .current-position { position: absolute; bottom: 5%; left: 50%; transform: translateX(-50%); text-align: center; }
    .current-circle { width: 48px; height: 48px; border-radius: 50%; background: var(--subject); display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; box-shadow: 0 0 30px var(--subject); animation: youPulse 2s infinite; }
    .current-circle.warning { background: var(--warning); box-shadow: 0 0 30px var(--warning); }
    .current-circle.critical { background: var(--critical); box-shadow: 0 0 30px var(--critical); animation: criticalYouPulse 1s infinite; }
    .current-icon { font-size: 20px; }
    .current-label { font-size: 10px; color: var(--text-dim); }
    .current-name { font-size: 13px; font-weight: 600; }
    .current-id { font-size: 10px; color: var(--text-dim); font-family: 'SF Mono', monospace; }

    /* LAYER 3: INTERNAL STATE */
    .internal-state { flex: 0 0 auto; padding: 16px 20px; background: linear-gradient(0deg, rgba(255,255,255,0.03) 0%, transparent 100%); border-top: 1px solid var(--border); }
    .state-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px; }
    .state-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
    .state-card.warning { border-color: var(--warning); background: rgba(255,170,0,0.05); }
    .state-card.critical { border-color: var(--critical); background: rgba(255,68,68,0.05); }
    .state-label { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
    .state-value { font-size: 20px; font-weight: 600; font-family: 'SF Mono', monospace; }
    .state-card.warning .state-value { color: var(--warning); }
    .state-card.critical .state-value { color: var(--critical); }
    .state-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .state-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
    .state-bar-fill.safe { background: var(--safe); }
    .state-bar-fill.warning { background: var(--warning); }
    .state-bar-fill.critical { background: var(--critical); }
    .resistance-row { display: flex; justify-content: center; gap: 24px; padding: 8px 0; border-top: 1px solid var(--border); margin-top: 8px; }
    .resistance-item { display: flex; align-items: center; gap: 8px; font-size: 11px; }
    .resistance-label { color: var(--text-dim); }
    .resistance-value { font-family: 'SF Mono', monospace; font-weight: 600; }

    /* CHOOSE BUTTON */
    .choose-section { flex: 0 0 auto; padding: 12px 20px 24px; }
    .choose-btn { width: 100%; padding: 18px; font-size: 14px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; background: #fff; color: #000; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
    .choose-btn:hover { box-shadow: 0 4px 30px rgba(255,255,255,0.3); transform: translateY(-2px); }
    .choose-btn.warning { background: var(--warning); }
    .choose-btn.critical { background: var(--critical); color: #fff; animation: criticalPulse 1s infinite; }

    /* ANIMATIONS */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes goalPulse { 0%, 100% { box-shadow: 0 0 20px rgba(0,255,136,0.3); transform: scale(1); } 50% { box-shadow: 0 0 40px rgba(0,255,136,0.5); transform: scale(1.05); } }
    @keyframes nodePulse { 0%, 100% { box-shadow: 0 0 15px currentColor; } 50% { box-shadow: 0 0 30px currentColor; } }
    @keyframes youPulse { 0%, 100% { box-shadow: 0 0 20px var(--subject); transform: scale(1); } 50% { box-shadow: 0 0 40px var(--subject); transform: scale(1.05); } }
    @keyframes criticalYouPulse { 0%, 100% { box-shadow: 0 0 20px var(--critical); transform: scale(1); } 50% { box-shadow: 0 0 40px var(--critical); transform: scale(1.1); } }
    @keyframes criticalPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    @keyframes pathFlow { 0% { stroke-dashoffset: 0; } 100% { stroke-dashoffset: -20; } }
    .path-flow { stroke-dasharray: 10 10; animation: pathFlow 1s linear infinite; }

    @media (max-width: 380px) { .state-grid { gap: 8px; } .state-value { font-size: 16px; } .external-node { min-width: 56px; padding: 6px 8px; } }
  </style>
</head>
<body>
  <div class="app">
    <!-- BACK BUTTON -->
    <button class="back-btn" onclick="goBack()">‚Üê</button>

    <!-- LAYER 1: EXTERNAL FIELD -->
    <div class="external-field">
      <div class="external-header">
        <div class="logo">AUTUS</div>
        <div class="external-label">External Field</div>
      </div>
      <div class="external-grid">
        <div class="external-node safe"><div class="external-icon">üõÇ</div><div class="external-name">VISA</div><div class="external-status"></div></div>
        <div class="external-node warning"><div class="external-icon">üìã</div><div class="external-name">POLICY</div><div class="external-status"></div></div>
        <div class="external-node safe"><div class="external-icon">üìà</div><div class="external-name">MARKET</div><div class="external-status"></div></div>
        <div class="external-node critical"><div class="external-icon">üíπ</div><div class="external-name">ECONOMY</div><div class="external-status"></div></div>
        <div class="external-node safe"><div class="external-icon">üìÖ</div><div class="external-name">SEASON</div><div class="external-status"></div></div>
      </div>
    </div>

    <!-- LAYER 2: DECISION FIELD -->
    <div class="decision-field">
      <div class="field-canvas">
        <div class="goal-node">
          <div class="goal-circle"><div class="goal-icon">üéØ</div></div>
          <div class="goal-label">DESTINATION</div>
          <div class="goal-name">Ï†ïÏ∞© ÏôÑÎ£å</div>
        </div>
        <div class="path-container">
          <svg class="path-svg" viewBox="0 0 400 300" preserveAspectRatio="xMidYMid meet">
            <path class="path-line active path-flow" d="M200,280 L200,220 L200,160 L200,100 L200,40" />
            <path class="path-line inactive" d="M200,160 L280,120 L320,80" />
            <path class="path-line pnr" d="M200,100 L200,40" />
          </svg>
          <div class="decision-node" style="left: 50%; top: 93%;"><div class="node-circle subject complete">S</div><div class="node-label">ÏßÑÏûÖ ÏôÑÎ£å</div></div>
          <div class="decision-node" style="left: 50%; top: 73%;"><div class="node-circle subject complete">S</div><div class="node-label">Ï§ÄÎπÑ ÏôÑÎ£å</div></div>
          <div class="decision-node" id="currentDecision" style="left: 50%; top: 53%;"><div class="node-circle education current">E</div><div class="node-label current" id="currentDecisionLabel">ÏÑùÏÇ¨ ÏßÄÏÜç<br>#16</div></div>
          <div class="transfer-badge" style="left: 58%; top: 53%;">T5</div>
          <div class="decision-node" style="left: 50%; top: 33%;"><div class="node-circle sponsor">P</div><div class="node-label">Ï∑®ÏóÖ</div></div>
          <div class="decision-node" style="left: 50%; top: 13%;"><div class="node-circle pnr">!</div><div class="node-label">Ï†ïÏ∞© PNR<br>#20</div></div>
          <div class="decision-node" style="left: 80%; top: 40%; opacity: 0.4;"><div class="node-circle operator">O</div><div class="node-label">Ïù¥ÌÉà Í≤ΩÎ°ú</div></div>
        </div>
        <div class="current-position">
          <div class="current-circle" id="currentCircle"><div class="current-icon">‚óè</div></div>
          <div class="current-label">CURRENT</div>
          <div class="current-name" id="subjectName">Kim</div>
          <div class="current-id" id="subjectId">S001</div>
        </div>
      </div>
    </div>

    <!-- LAYER 3: INTERNAL STATE -->
    <div class="internal-state">
      <div class="state-grid">
        <div class="state-card" id="energyCard"><div class="state-label">Energy</div><div class="state-value" id="energyValue">78%</div><div class="state-bar"><div class="state-bar-fill safe" id="energyBar" style="width: 78%"></div></div></div>
        <div class="state-card warning" id="pnrCard"><div class="state-label">PNR</div><div class="state-value" id="pnrValue">14d</div><div class="state-bar"><div class="state-bar-fill warning" id="pnrBar" style="width: 45%"></div></div></div>
        <div class="state-card" id="entropyCard"><div class="state-label">Entropy</div><div class="state-value" id="entropyValue">23%</div><div class="state-bar"><div class="state-bar-fill safe" id="entropyBar" style="width: 23%"></div></div></div>
      </div>
      <div class="resistance-row">
        <div class="resistance-item"><span class="resistance-label">RESISTANCE</span><span class="resistance-value" id="resistanceValue" style="color: var(--warning)">‚Ç©12.4M</span></div>
        <div class="resistance-item"><span class="resistance-label">VELOCITY</span><span class="resistance-value" id="velocityValue" style="color: var(--critical)">+‚Ç©41K/d</span></div>
      </div>
    </div>

    <!-- CHOOSE BUTTON -->
    <div class="choose-section">
      <button class="choose-btn warning" id="chooseBtn">CHOOSE</button>
    </div>
  </div>

  <script>
    // Subject Database (shared with operator.html)
    const subjects = {
      'S001': { id: 'S001', name: 'Kim', pnr: 7, energy: 45, entropy: 42, stage: 'E', stageName: 'ÏÑùÏÇ¨', decision: '#16', status: 'critical', resistance: 15.2, velocity: 52 },
      'S002': { id: 'S002', name: 'Lee', pnr: 14, energy: 68, entropy: 28, stage: 'E', stageName: 'ÏÑùÏÇ¨', decision: '#14', status: 'warning', resistance: 12.4, velocity: 41 },
      'S003': { id: 'S003', name: 'Park', pnr: 45, energy: 85, entropy: 15, stage: 'S', stageName: 'Ï§ÄÎπÑ', decision: '#08', status: 'safe', resistance: 8.5, velocity: 22 },
      'S004': { id: 'S004', name: 'Choi', pnr: 60, energy: 92, entropy: 10, stage: 'S', stageName: 'ÏßÑÏûÖ', decision: '#03', status: 'safe', resistance: 5.2, velocity: 15 },
      'S005': { id: 'S005', name: 'Jung', pnr: 21, energy: 55, entropy: 35, stage: 'E', stageName: 'ÏÑùÏÇ¨', decision: '#15', status: 'warning', resistance: 14.1, velocity: 38 },
      'S006': { id: 'S006', name: 'Kang', pnr: 90, energy: 88, entropy: 8, stage: 'S', stageName: 'ÏßÑÏûÖ', decision: '#02', status: 'safe', resistance: 4.8, velocity: 12 },
      'S007': { id: 'S007', name: 'Yoo', pnr: 55, energy: 78, entropy: 18, stage: 'S', stageName: 'Ï§ÄÎπÑ', decision: '#07', status: 'safe', resistance: 9.2, velocity: 25 },
      'S008': { id: 'S008', name: 'Han', pnr: 3, energy: 32, entropy: 58, stage: 'P', stageName: 'Ï∑®ÏóÖ', decision: '#19', status: 'critical', resistance: 18.7, velocity: 68 },
      'S009': { id: 'S009', name: 'Lim', pnr: 18, energy: 62, entropy: 31, stage: 'E', stageName: 'ÏÑùÏÇ¨', decision: '#16', status: 'warning', resistance: 13.5, velocity: 35 },
      'S010': { id: 'S010', name: 'Oh', pnr: 42, energy: 81, entropy: 16, stage: 'S', stageName: 'Ï§ÄÎπÑ', decision: '#09', status: 'safe', resistance: 7.8, velocity: 20 },
    };

    // Get subject ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id') || 'S001';
    const subject = subjects[subjectId] || subjects['S001'];

    // Update UI with subject data
    function loadSubjectData(s) {
      // Name & ID
      document.getElementById('subjectName').textContent = s.name;
      document.getElementById('subjectId').textContent = s.id;

      // Current circle color
      const circle = document.getElementById('currentCircle');
      circle.className = 'current-circle';
      if (s.status === 'critical') circle.classList.add('critical');
      else if (s.status === 'warning') circle.classList.add('warning');

      // Energy
      document.getElementById('energyValue').textContent = s.energy + '%';
      document.getElementById('energyBar').style.width = s.energy + '%';
      document.getElementById('energyBar').className = 'state-bar-fill ' + (s.energy >= 70 ? 'safe' : s.energy >= 40 ? 'warning' : 'critical');
      
      // PNR
      document.getElementById('pnrValue').textContent = s.pnr + 'd';
      const pnrPercent = Math.min(100, (s.pnr / 90) * 100);
      document.getElementById('pnrBar').style.width = pnrPercent + '%';
      document.getElementById('pnrBar').className = 'state-bar-fill ' + (s.pnr <= 7 ? 'critical' : s.pnr <= 21 ? 'warning' : 'safe');
      const pnrCard = document.getElementById('pnrCard');
      pnrCard.className = 'state-card ' + (s.pnr <= 7 ? 'critical' : s.pnr <= 21 ? 'warning' : '');

      // Entropy
      document.getElementById('entropyValue').textContent = s.entropy + '%';
      document.getElementById('entropyBar').style.width = s.entropy + '%';
      document.getElementById('entropyBar').className = 'state-bar-fill ' + (s.entropy <= 20 ? 'safe' : s.entropy <= 40 ? 'warning' : 'critical');

      // Resistance & Velocity
      document.getElementById('resistanceValue').textContent = '‚Ç©' + s.resistance + 'M';
      document.getElementById('resistanceValue').style.color = s.resistance > 15 ? 'var(--critical)' : s.resistance > 10 ? 'var(--warning)' : 'var(--safe)';
      document.getElementById('velocityValue').textContent = '+‚Ç©' + s.velocity + 'K/d';
      document.getElementById('velocityValue').style.color = s.velocity > 50 ? 'var(--critical)' : s.velocity > 30 ? 'var(--warning)' : 'var(--safe)';

      // Current Decision
      document.getElementById('currentDecisionLabel').innerHTML = s.stageName + '<br>' + s.decision;
      const decisionNode = document.querySelector('#currentDecision .node-circle');
      decisionNode.className = 'node-circle current';
      if (s.stage === 'S') decisionNode.classList.add('subject');
      else if (s.stage === 'E') decisionNode.classList.add('education');
      else if (s.stage === 'P') decisionNode.classList.add('sponsor');

      // Choose Button
      const btn = document.getElementById('chooseBtn');
      btn.className = 'choose-btn';
      if (s.status === 'critical') btn.classList.add('critical');
      else if (s.status === 'warning') btn.classList.add('warning');
    }

    // Back to Operator
    function goBack() {
      window.location.href = 'operator.html';
    }

    // Choose Action
    document.getElementById('chooseBtn').addEventListener('click', () => {
      if (navigator.vibrate) navigator.vibrate(50);
      
      console.log('CHOICE MADE:', {
        timestamp: new Date().toISOString(),
        entity: subject.name,
        id: subject.id,
        decision: subject.decision,
        status: subject.status,
        pnr_days: subject.pnr
      });
      
      alert(`‚úÖ ÏÑ†ÌÉù Í∏∞Î°ùÎê®\n\n${subject.name} (${subject.id})\nDecision: ${subject.decision}\nPNR: ${subject.pnr}d\n\nAudit LogÏóê Ï†ÄÏû•Îê®.`);
    });

    // Initialize
    loadSubjectData(subject);
  </script>
</body>
</html>
