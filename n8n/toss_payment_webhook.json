{
  "name": "KRATON í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ Webhook",
  "nodes": [
    {
      "parameters": { "httpMethod": "POST", "path": "toss-payment-webhook", "responseMode": "responseNode" },
      "id": "webhook",
      "name": "í† ìŠ¤ Webhook ìˆ˜ì‹ ",
      "type": "n8n-nodes-base.webhook",
      "position": [100, 300],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body;\nconst statusMap = { 'DONE': 'completed', 'CANCELED': 'canceled', 'ABORTED': 'failed', 'EXPIRED': 'expired', 'WAITING_FOR_DEPOSIT': 'pending' };\nconst payment = {\n  payment_key: body.paymentKey,\n  order_id: body.orderId,\n  amount: body.totalAmount,\n  status: statusMap[body.status] || body.status,\n  method: body.method,\n  requested_at: body.requestedAt,\n  approved_at: body.approvedAt\n};\nconst isFailed = ['canceled', 'failed', 'expired'].includes(payment.status);\nreturn [{ json: { ...payment, is_failed: isFailed, risk_action_needed: isFailed } }];"
      },
      "id": "parse",
      "name": "ê²°ì œ ìƒíƒœ íŒŒì‹±",
      "type": "n8n-nodes-base.code",
      "position": [300, 300],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "payments",
        "columns": "payment_key,order_id,amount,status,method,requested_at,approved_at"
      },
      "id": "save_payment",
      "name": "ê²°ì œ ì •ë³´ ì €ì¥",
      "type": "n8n-nodes-base.supabase",
      "position": [500, 300],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": { "boolean": [{ "value1": "={{ $json.is_failed }}", "value2": true }] }
      },
      "id": "check_failed",
      "name": "ê²°ì œ ì‹¤íŒ¨ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "position": [700, 300],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "churn_risk_events",
        "columns": "order_id,risk_type,risk_level,detected_at,source"
      },
      "id": "save_risk",
      "name": "Risk Queue ë“±ë¡",
      "type": "n8n-nodes-base.supabase",
      "position": [900, 200],
      "typeVersion": 1
    },
    {
      "parameters": {
        "channel": "#payment-alerts",
        "text": "ğŸ’° ê²°ì œ ì‹¤íŒ¨\nì£¼ë¬¸ID: {{ $json.order_id }}\nê¸ˆì•¡: {{ $json.amount }}ì›\nìƒíƒœ: {{ $json.status }}"
      },
      "id": "slack_failed",
      "name": "Slack ì•Œë¦¼ (ì‹¤íŒ¨)",
      "type": "n8n-nodes-base.slack",
      "position": [1100, 200],
      "typeVersion": 2
    },
    {
      "parameters": {
        "channel": "#payments",
        "text": "âœ… ê²°ì œ ì™„ë£Œ\nì£¼ë¬¸ID: {{ $json.order_id }}\nê¸ˆì•¡: {{ $json.amount }}ì›"
      },
      "id": "slack_success",
      "name": "Slack ì•Œë¦¼ (ì„±ê³µ)",
      "type": "n8n-nodes-base.slack",
      "position": [900, 400],
      "typeVersion": 2
    },
    {
      "parameters": { "respondWith": "json", "responseBody": "{ \"success\": true }" },
      "id": "respond",
      "name": "ì‘ë‹µ",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1300, 300],
      "typeVersion": 1
    }
  ],
  "connections": {
    "webhook": { "main": [[{ "node": "parse", "type": "main", "index": 0 }]] },
    "parse": { "main": [[{ "node": "save_payment", "type": "main", "index": 0 }]] },
    "save_payment": { "main": [[{ "node": "check_failed", "type": "main", "index": 0 }]] },
    "check_failed": { "main": [[{ "node": "save_risk", "type": "main", "index": 0 }], [{ "node": "slack_success", "type": "main", "index": 0 }]] },
    "save_risk": { "main": [[{ "node": "slack_failed", "type": "main", "index": 0 }]] },
    "slack_failed": { "main": [[{ "node": "respond", "type": "main", "index": 0 }]] },
    "slack_success": { "main": [[{ "node": "respond", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "meta": { "description": "í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ Webhook + ì‹¤íŒ¨ ì‹œ Risk Queue + ì•Œë¦¼", "effect": "Tâ†“30%, ë¯¸ë‚© íšŒìˆ˜ìœ¨ â†‘" }
}
