{
  "name": "AUTUS - Weekly V Report",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1"
            }
          ]
        }
      },
      "id": "weekly-trigger",
      "name": "ë§¤ì£¼ ì›”ìš”ì¼ 9ì‹œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "={{$env.VERCEL_API_URL}}/api/physics?userId={{$env.AUTUS_USER_ID}}",
        "options": {}
      },
      "id": "fetch-physics",
      "name": "ì „ì²´ ë¬¼ë¦¬ ìƒíƒœ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "// Weekly V Report Generator\nconst response = $input.first().json;\nconst organisms = response.data?.organisms || [];\nconst summary = response.data?.summary || {};\n\n// ìƒíƒœë³„ ë¶„ë¥˜\nconst urgent = organisms.filter(o => o.summary?.status === 'urgent');\nconst warning = organisms.filter(o => o.summary?.status === 'warning');\nconst opportunity = organisms.filter(o => o.summary?.status === 'opportunity');\nconst stable = organisms.filter(o => o.summary?.status === 'stable');\n\n// Top 3 ì„±ì¥ì\nconst topGrowers = [...organisms]\n  .sort((a, b) => (b.velocity || 0) - (a.velocity || 0))\n  .slice(0, 3);\n\n// Top 3 ìœ„í—˜ì\nconst topRisks = [...organisms]\n  .sort((a, b) => (b.urgency || 0) - (a.urgency || 0))\n  .slice(0, 3);\n\n// ë¦¬í¬íŠ¸ ìƒì„±\nconst report = {\n  generated_at: new Date().toISOString(),\n  period: 'ì§€ë‚œ 7ì¼',\n  \n  summary: {\n    total_v: summary.total_v || 0,\n    avg_synergy: summary.avg_synergy || 0,\n    organism_count: summary.organism_count || 0,\n    urgent_count: summary.urgent_count || 0\n  },\n  \n  distribution: {\n    urgent: urgent.length,\n    warning: warning.length,\n    opportunity: opportunity.length,\n    stable: stable.length\n  },\n  \n  top_growers: topGrowers.map(o => ({\n    name: o.name,\n    velocity: o.velocity,\n    value_v: o.computed_v\n  })),\n  \n  top_risks: topRisks.map(o => ({\n    name: o.name,\n    urgency: o.urgency,\n    entropy: o.entropy,\n    recommended_impulse: o.recommended_impulse\n  })),\n  \n  // ë¦¬í¬íŠ¸ ë©”ì‹œì§€ ìƒì„±\n  message: `ğŸ“Š AUTUS ì£¼ê°„ ë¦¬í¬íŠ¸\\n\\n` +\n    `ì´ V: ${(summary.total_v || 0).toLocaleString()}ì›\\n` +\n    `í‰ê·  ì‹œë„ˆì§€: ${((summary.avg_synergy || 0) * 100).toFixed(1)}%\\n\\n` +\n    `ğŸš¨ ê¸´ê¸‰: ${urgent.length}ëª…\\n` +\n    `âš ï¸ ì£¼ì˜: ${warning.length}ëª…\\n` +\n    `âœ¨ ê¸°íšŒ: ${opportunity.length}ëª…\\n` +\n    `âœ… ì•ˆì •: ${stable.length}ëª…\\n\\n` +\n    `ğŸ† ì„±ì¥ TOP 3:\\n` +\n    topGrowers.map((o, i) => `${i+1}. ${o.name} (+${((o.velocity || 0) * 100).toFixed(1)}%)`).join('\\n') + '\\n\\n' +\n    `âš¡ ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”:\\n` +\n    topRisks.slice(0, 3).map(o => `- ${o.name}: ${o.recommended_impulse}`).join('\\n')\n};\n\nreturn [{ json: report }];"
      },
      "id": "report-gen",
      "name": "ë¦¬í¬íŠ¸ ìƒì„±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "https://kakaoapi.aligo.in/akv10/alimtalk/send/",
        "sendBody": true,
        "specifyBody": "form",
        "bodyParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$env.ALIGO_API_KEY}}" },
            { "name": "userid", "value": "={{$env.ALIGO_USER_ID}}" },
            { "name": "senderkey", "value": "={{$env.ALIGO_SENDER_KEY}}" },
            { "name": "tpl_code", "value": "AUTUS_WEEKLY_001" },
            { "name": "sender", "value": "={{$env.SENDER_PHONE}}" },
            { "name": "receiver_1", "value": "={{$env.ADMIN_PHONE}}" },
            { "name": "subject_1", "value": "[AUTUS] ì£¼ê°„ V ë¦¬í¬íŠ¸" },
            { "name": "message_1", "value": "={{ $json.message }}" }
          ]
        },
        "options": {}
      },
      "id": "kakao-report",
      "name": "ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "={{$env.VERCEL_API_URL}}/api/rewards",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ action: 'generate', userId: $env.AUTUS_USER_ID, payload: { context: { type: 'weekly_report', summary: $json.summary, distribution: $json.distribution, top_growers: $json.top_growers } } }) }}",
        "options": {}
      },
      "id": "save-report",
      "name": "ë¦¬í¬íŠ¸ ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    }
  ],
  "connections": {
    "ë§¤ì£¼ ì›”ìš”ì¼ 9ì‹œ": {
      "main": [[{ "node": "ì „ì²´ ë¬¼ë¦¬ ìƒíƒœ ì¡°íšŒ", "type": "main", "index": 0 }]]
    },
    "ì „ì²´ ë¬¼ë¦¬ ìƒíƒœ ì¡°íšŒ": {
      "main": [[{ "node": "ë¦¬í¬íŠ¸ ìƒì„±", "type": "main", "index": 0 }]]
    },
    "ë¦¬í¬íŠ¸ ìƒì„±": {
      "main": [[
        { "node": "ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡", "type": "main", "index": 0 },
        { "node": "ë¦¬í¬íŠ¸ ì €ì¥", "type": "main", "index": 0 }
      ]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["autus", "report", "weekly"]
}
