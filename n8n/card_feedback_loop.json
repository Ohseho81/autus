{
  "name": "KRATON ì¹´ë“œ í”¼ë“œë°± ë£¨í”„",
  "nodes": [
    {
      "parameters": { "rule": { "interval": [{ "field": "cronExpression", "expression": "0 17 * * *" }] } },
      "id": "trigger",
      "name": "ë§¤ì¼ ì˜¤í›„ 5ì‹œ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [100, 300],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "operation": "select",
        "table": "students",
        "filters": { "filter": [{ "field": "churn_risk_level", "condition": "in", "value": "critical,high" }] }
      },
      "id": "get_risk_students",
      "name": "ìœ„í—˜ í•™ìƒ ì¡°íšŒ",
      "type": "n8n-nodes-base.supabase",
      "position": [300, 200],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "select",
        "table": "students",
        "filters": { "filter": [{ "field": "attendance_rate", "condition": "gte", "value": "90" }, { "field": "homework_rate", "condition": "gte", "value": "90" }] }
      },
      "id": "get_growth_students",
      "name": "ì„±ì¥ í•™ìƒ ì¡°íšŒ",
      "type": "n8n-nodes-base.supabase",
      "position": [300, 400],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst cards = [];\n\nfor (const item of items) {\n  const s = item.json;\n  const isRisk = ['critical', 'high'].includes(s.churn_risk_level);\n  \n  cards.push({\n    json: {\n      student_id: s.id,\n      student_name: s.name,\n      parent_phone: s.parent_phone,\n      parent_name: s.parent_name,\n      card_type: isRisk ? 'care' : 'growth',\n      title: isRisk \n        ? s.name + ' í•™ìƒì—ê²Œ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤' \n        : s.name + ' í•™ìƒì´ ì„±ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤!',\n      message: isRisk\n        ? 'ìµœê·¼ ' + s.name + ' í•™ìƒì˜ ì¶œì„ë¥ ì´ ' + s.attendance_rate + '%ì…ë‹ˆë‹¤. í•¨ê»˜ ì‘ì›í•´ì£¼ì„¸ìš”.'\n        : s.name + ' í•™ìƒì´ ì¶œì„ë¥  ' + s.attendance_rate + '%, ìˆ™ì œ ì™„ë£Œìœ¨ ' + s.homework_rate + '%ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!',\n      cta: isRisk ? 'ìƒë‹´ ì˜ˆì•½í•˜ê¸°' : 'ì¹­ì°¬ ë©”ì‹œì§€ ë³´ë‚´ê¸°',\n      feedback_url: 'https://kraton.app/feedback/' + s.id,\n      created_at: new Date().toISOString()\n    }\n  });\n}\n\nreturn cards;"
      },
      "id": "generate_cards",
      "name": "ì¹´ë“œ ë°ì´í„° ìƒì„±",
      "type": "n8n-nodes-base.code",
      "position": [500, 300],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "https://api.solapi.com/messages/v4/send-many",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth"
      },
      "id": "send_alimtalk",
      "name": "ì•Œë¦¼í†¡ ë°œì†¡",
      "type": "n8n-nodes-base.httpRequest",
      "position": [700, 300],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "notifications",
        "columns": "student_id,card_type,title,message,sent_at,status"
      },
      "id": "save_notification",
      "name": "ì•Œë¦¼ ê¸°ë¡ ì €ì¥",
      "type": "n8n-nodes-base.supabase",
      "position": [900, 300],
      "typeVersion": 1
    },
    {
      "parameters": { "httpMethod": "POST", "path": "card-feedback", "responseMode": "responseNode" },
      "id": "feedback_webhook",
      "name": "í”¼ë“œë°± Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [100, 550],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "const feedback = $input.first().json.body;\n\nreturn [{\n  json: {\n    student_id: feedback.student_id,\n    feedback_type: feedback.type,\n    content: feedback.content,\n    received_at: new Date().toISOString(),\n    risk_update_needed: feedback.type === 'consultation_request'\n  }\n}];"
      },
      "id": "process_feedback",
      "name": "í”¼ë“œë°± ì²˜ë¦¬",
      "type": "n8n-nodes-base.code",
      "position": [300, 550],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "feedback_logs",
        "columns": "student_id,feedback_type,content,received_at"
      },
      "id": "save_feedback",
      "name": "í”¼ë“œë°± ì €ì¥",
      "type": "n8n-nodes-base.supabase",
      "position": [500, 550],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": { "boolean": [{ "value1": "={{ $json.risk_update_needed }}", "value2": true }] }
      },
      "id": "check_consultation",
      "name": "ìƒë‹´ ìš”ì²­ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "position": [700, 550],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "update",
        "table": "churn_risk_events",
        "filters": { "filter": [{ "field": "student_id", "condition": "eq", "value": "={{ $json.student_id }}" }] },
        "columns": "status,consultation_requested_at"
      },
      "id": "update_risk",
      "name": "Risk Queue ì—…ë°ì´íŠ¸",
      "type": "n8n-nodes-base.supabase",
      "position": [900, 500],
      "typeVersion": 1
    },
    {
      "parameters": {
        "channel": "#feedback",
        "text": "ğŸ“ í”¼ë“œë°± ìˆ˜ì‹ \ní•™ìƒ: {{ $json.student_name }}\nìœ í˜•: {{ $json.feedback_type }}\në‚´ìš©: {{ $json.content }}"
      },
      "id": "slack_feedback",
      "name": "Slack ì•Œë¦¼",
      "type": "n8n-nodes-base.slack",
      "position": [900, 600],
      "typeVersion": 2
    },
    {
      "parameters": { "respondWith": "json", "responseBody": "{ \"success\": true }" },
      "id": "respond_feedback",
      "name": "ì‘ë‹µ",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1100, 550],
      "typeVersion": 1
    }
  ],
  "connections": {
    "trigger": { "main": [[{ "node": "get_risk_students", "type": "main", "index": 0 }, { "node": "get_growth_students", "type": "main", "index": 0 }]] },
    "get_risk_students": { "main": [[{ "node": "generate_cards", "type": "main", "index": 0 }]] },
    "get_growth_students": { "main": [[{ "node": "generate_cards", "type": "main", "index": 0 }]] },
    "generate_cards": { "main": [[{ "node": "send_alimtalk", "type": "main", "index": 0 }]] },
    "send_alimtalk": { "main": [[{ "node": "save_notification", "type": "main", "index": 0 }]] },
    "feedback_webhook": { "main": [[{ "node": "process_feedback", "type": "main", "index": 0 }]] },
    "process_feedback": { "main": [[{ "node": "save_feedback", "type": "main", "index": 0 }]] },
    "save_feedback": { "main": [[{ "node": "check_consultation", "type": "main", "index": 0 }]] },
    "check_consultation": { "main": [[{ "node": "update_risk", "type": "main", "index": 0 }], [{ "node": "slack_feedback", "type": "main", "index": 0 }]] },
    "update_risk": { "main": [[{ "node": "slack_feedback", "type": "main", "index": 0 }]] },
    "slack_feedback": { "main": [[{ "node": "respond_feedback", "type": "main", "index": 0 }]] }
  },
  "settings": { "executionOrder": "v1" },
  "meta": { "description": "ë§¤ì¼ ì˜¤í›„ 5ì‹œ ì¹´ë“œ ë°œì†¡ + í”¼ë“œë°± ìˆ˜ì‹  + Risk Queue ì—…ë°ì´íŠ¸", "effect": "Tâ†“50%, sâ†‘0.3" }
}
