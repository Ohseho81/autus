{
  "name": "AUTUS - ERP to Physics Engine",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [{ "field": "hours", "hoursInterval": 6 }]
        }
      },
      "id": "schedule-trigger",
      "name": "6ì‹œê°„ë§ˆë‹¤ ìŠ¤ìº”",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "https://api.hagnara.com/v1/students/vitals",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {},
        "headerParameters": {
          "parameters": [
            { "name": "X-API-KEY", "value": "={{$env.HAGNARA_KEY}}" }
          ]
        }
      },
      "id": "erp-fetch",
      "name": "ERP ë°ì´í„° ìˆ˜ì§‘",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "// AUTUS Physics v2.2 - Signal Transformer\nconst items = $input.all();\nconst ENTROPY_THRESHOLD = 0.7;\nconst VELOCITY_THRESHOLD = 0.1;\n\nreturn items.map(item => {\n  const d = item.json;\n  \n  // M (Mint): ì‚°ì¶œ ê°€ì¹˜ = ìˆ˜ì—…ë£Œ + ì„±ì·¨ë„ ë³´ë„ˆìŠ¤\n  const mint = (d.monthly_fee || 300000) * (1 + (d.achievement_score || 0.7));\n  \n  // T (Tax): íˆ¬ì… ë¹„ìš© = ë¯¸ë‚©ì•¡ + ê´€ë¦¬ ë¹„ìš©\n  const unpaidAmount = d.payment_status === 'unpaid' ? (d.unpaid_balance || 100000) : 0;\n  const tax = unpaidAmount + (d.admin_cost || 50000);\n  \n  // s (Synergy): ì—°ê²° ê³„ìˆ˜ = ì¶œì„ë¥  ê¸°ë°˜\n  const synergy = Math.min(1, (d.attendance_rate || 80) / 100 * 0.3);\n  \n  // Entropy: ë¬´ì§ˆì„œë„ = ë¯¸ë‚© + ê²°ì„ + ì„±ì í•˜ë½\n  const paymentEntropy = d.payment_status === 'unpaid' ? 0.4 : 0;\n  const attendanceEntropy = d.attendance_rate < 70 ? 0.3 : 0;\n  const performanceEntropy = d.grade_trend === 'down' ? 0.2 : 0;\n  const entropy = Math.min(1, paymentEntropy + attendanceEntropy + performanceEntropy);\n  \n  // Velocity: ì„±ì¥ë¥  = ì´ì „ ëŒ€ë¹„ ë³€í™”\n  const velocity = (d.grade_delta || 0) * 0.1;\n  \n  // Friction: ë§ˆì°° = ë¶ˆë§Œ/ì»´í”Œë ˆì¸\n  const friction = (d.complaint_count || 0) * 0.1;\n  \n  // V ê³„ì‚°: V = (M - T) Ã— (1 + s)^t\n  const t = 1; // ì›” ë‹¨ìœ„\n  const value_v = (mint - tax) * Math.pow(1 + synergy, t);\n  \n  // ìƒíƒœ íŒì •\n  let status = 'stable';\n  if (entropy > ENTROPY_THRESHOLD || value_v < 0) status = 'urgent';\n  else if (entropy > 0.5 || velocity < 0) status = 'warning';\n  else if (velocity > VELOCITY_THRESHOLD && synergy > 0.2) status = 'opportunity';\n  \n  // ê¸´ê¸‰ë„\n  const urgency = Math.min(1, entropy * 0.6 + (value_v < 0 ? 0.4 : 0));\n  \n  // ì¶”ì²œ Impulse\n  let recommended_impulse = 'RECOVER';\n  if (entropy > ENTROPY_THRESHOLD) recommended_impulse = 'SHOCK_DAMP';\n  else if (tax > mint * 0.8) recommended_impulse = 'DEFRICTION';\n  \n  return {\n    json: {\n      external_id: d.student_id || d.external_id,\n      name: d.student_name || d.name,\n      type: 'student',\n      \n      // Physics íŒŒë¼ë¯¸í„°\n      mint: Math.round(mint),\n      tax: Math.round(tax),\n      synergy: parseFloat(synergy.toFixed(3)),\n      entropy: parseFloat(entropy.toFixed(3)),\n      velocity: parseFloat(velocity.toFixed(3)),\n      friction: parseFloat(friction.toFixed(3)),\n      value_v: Math.round(value_v),\n      \n      // ìƒíƒœ\n      status,\n      urgency: parseFloat(urgency.toFixed(3)),\n      recommended_impulse,\n      \n      // ì›ë³¸ ë°ì´í„° ì°¸ì¡°\n      _raw: {\n        payment_status: d.payment_status,\n        attendance_rate: d.attendance_rate,\n        grade_trend: d.grade_trend\n      }\n    }\n  };\n});"
      },
      "id": "physics-calc",
      "name": "Physics v2.2 ê³„ì‚°ê¸°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "={{$env.VERCEL_API_URL}}/api/organisms",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ userId: $env.AUTUS_USER_ID, ...($json) }) }}",
        "options": {}
      },
      "id": "supabase-sync",
      "name": "Supabase ë™ê¸°í™”",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "entropy-check",
              "leftValue": "={{ $json.entropy }}",
              "rightValue": 0.5,
              "operator": { "type": "number", "operation": "gt" }
            }
          ]
        }
      },
      "id": "risk-check",
      "name": "ìœ„í—˜ ê°ì§€?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "url": "={{$env.VERCEL_API_URL}}/api/brain",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ action: 'generate_reward_card', userId: $env.AUTUS_USER_ID, payload: { role: 'director', pain_point: 'churn', orbit_distance: 0.3, context_data: { student_name: $json.name, entropy: $json.entropy, status: $json.status, recommended_impulse: $json.recommended_impulse } } }) }}",
        "options": {}
      },
      "id": "ai-card-gen",
      "name": "AI ë³´ìƒ ì¹´ë“œ ìƒì„±",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "url": "https://kakaoapi.aligo.in/akv10/alimtalk/send/",
        "sendBody": true,
        "specifyBody": "form",
        "bodyParameters": {
          "parameters": [
            { "name": "apikey", "value": "={{$env.ALIGO_API_KEY}}" },
            { "name": "userid", "value": "={{$env.ALIGO_USER_ID}}" },
            { "name": "senderkey", "value": "={{$env.ALIGO_SENDER_KEY}}" },
            { "name": "tpl_code", "value": "AUTUS_ALERT_001" },
            { "name": "sender", "value": "={{$env.SENDER_PHONE}}" },
            { "name": "receiver_1", "value": "={{$env.ADMIN_PHONE}}" },
            { "name": "subject_1", "value": "[AUTUS] í‡´ì› ìœ„í—˜ ê°ì§€" },
            { "name": "message_1", "value": "âš ï¸ {{ $json.name }} í•™ìƒ ì—”íŠ¸ë¡œí”¼ ê¸‰ë“±!\n\nğŸ“Š ìƒíƒœ: {{ $json.status }}\nğŸŒ¡ï¸ ì—”íŠ¸ë¡œí”¼: {{ Math.round($json.entropy * 100) }}%\nğŸ’¡ ì¶”ì²œ: {{ $json.recommended_impulse }}\n\nì•„ìš°íˆ¬ìŠ¤ì—ì„œ ì²˜ë°© ì¹´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”." }
          ]
        },
        "options": {}
      },
      "id": "kakao-alert",
      "name": "ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "opportunity-check",
              "leftValue": "={{ $json.status }}",
              "rightValue": "opportunity",
              "operator": { "type": "string", "operation": "equals" }
            }
          ]
        }
      },
      "id": "opportunity-check",
      "name": "ê¸°íšŒ ê°ì§€?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 450]
    },
    {
      "parameters": {
        "url": "={{$env.VERCEL_API_URL}}/api/rewards",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ action: 'generate', userId: $env.AUTUS_USER_ID, payload: { context: { student_name: $json.name, velocity: $json.velocity, synergy: $json.synergy, status: 'opportunity' } } }) }}",
        "options": {}
      },
      "id": "reward-badge",
      "name": "ë³´ìƒ ë°°ì§€ ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 450]
    }
  ],
  "connections": {
    "6ì‹œê°„ë§ˆë‹¤ ìŠ¤ìº”": {
      "main": [[{ "node": "ERP ë°ì´í„° ìˆ˜ì§‘", "type": "main", "index": 0 }]]
    },
    "ERP ë°ì´í„° ìˆ˜ì§‘": {
      "main": [[{ "node": "Physics v2.2 ê³„ì‚°ê¸°", "type": "main", "index": 0 }]]
    },
    "Physics v2.2 ê³„ì‚°ê¸°": {
      "main": [[{ "node": "Supabase ë™ê¸°í™”", "type": "main", "index": 0 }]]
    },
    "Supabase ë™ê¸°í™”": {
      "main": [
        [
          { "node": "ìœ„í—˜ ê°ì§€?", "type": "main", "index": 0 },
          { "node": "ê¸°íšŒ ê°ì§€?", "type": "main", "index": 0 }
        ]
      ]
    },
    "ìœ„í—˜ ê°ì§€?": {
      "main": [
        [{ "node": "AI ë³´ìƒ ì¹´ë“œ ìƒì„±", "type": "main", "index": 0 }],
        []
      ]
    },
    "AI ë³´ìƒ ì¹´ë“œ ìƒì„±": {
      "main": [[{ "node": "ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡", "type": "main", "index": 0 }]]
    },
    "ê¸°íšŒ ê°ì§€?": {
      "main": [
        [{ "node": "ë³´ìƒ ë°°ì§€ ë°œê¸‰", "type": "main", "index": 0 }],
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["autus", "erp", "physics", "alert"]
}
