# 결제선생(PaySSAM) × 온리쌤 연동 스터디

> **목적**: 결제선생의 약관·개인정보·보안약정 + 온리쌤 코드베이스를 교차 분석하여, 연동 시 지켜야 할 규칙과 활용 가능한 데이터 흐름을 정리한다.
>
> **핵심 문장**: "결제선생의 Truth(수납)를 흡수하여, 온리쌤의 상담선생이 위험을 감지하고, 기록선생이 로그를 쌓는다."
>
> **작성일**: 2026-02-13 (v2 — 약관 분석 추가)

---

## 1. 결제선생의 정체 — 온리쌤 관점

### 1-1. 서비스 개요

결제선생은 페이민트 주식회사(대표 김영환)가 운영하는 비대면 모바일 청구서 결제 서비스다. 사업자가 고객에게 카카오 알림톡 또는 문자로 청구서를 보내면, 고객이 앱 설치나 회원가입 없이 모바일에서 바로 결제할 수 있다. 누적 가맹점 101,700개, 월 거래 금액 3,300억 원, 누적 거래액 8.8조 원 규모다.

### 1-2. 표면 vs 실체

| 표면 | 실체 (온리쌤 관점) |
|------|-------------------|
| 모바일 청구서 결제 서비스 | **지속 로그(Persistence Log)** 생산기 |
| 카카오 알림톡 발송 도구 | 학부모와의 **유일한 결제 접점** |
| 수납 관리 대시보드 | **위험 신호(미납/연체)** 감지 센서 |
| 쌤포인트 충전 시스템 | 온리쌤 운영 비용의 **변동비 원천** |
| 출결선생 부가서비스 | 온리쌤 출결선생의 **동명이인** (같은 이름, 다른 시스템) |

### 1-3. 온리쌤 5대 로그에서의 위치

| 로그 | 소스 | 결제선생 역할 |
|------|------|-------------|
| 움직임(Movement) | YouTube | - |
| 관찰(Observation) | Notion | - |
| 빈도(Frequency) | 출결선생 | 결제선생의 출결선생과 **데이터 교환** |
| **지속(Persistence)** | **결제선생** | **핵심 Truth 생산자** |
| 패턴(Pattern) | 스케줄 | 정기 결제 패턴에서 추출 가능 |

---

## 2. 약관에서 읽는 연동 규칙

### 2-1. 우리(온리쌤)의 법적 지위

약관 제2조에 따르면:
- **"회원"** = 온리쌤을 사용하는 학원 원장 (사업자로 가입)
- **"플랫폼 사용자"** = 학부모 (결제하는 사람)
- 결제선생은 회원과 플랫폼 사용자 간 **결제를 돕는 시스템을 운영**할 뿐, 거래에 개입하지 않음 (제11조)

온리쌤은 "회원의 도구"로서 결제선생 API를 호출하는 구조. 온리쌤 자체가 회원이 아니라, 회원(학원)이 온리쌤을 통해 결제선생을 사용한다.

### 2-2. 핵심 서비스 (약관 제12조, 19조, 20조)

| 서비스 | 약관 조항 | 온리쌤 활용 |
|--------|----------|------------|
| 결제선생 (청구서 발송 + 수납관리) | 제12조 1항, 제19조 | 수업료 청구의 핵심 |
| 출결선생 (출결 메시지 + 이력관리) | 제12조 3항, 제20조 | 교육업종 한정, 온리쌤 자체 출결과 병행 가능 |
| 쌤포인트 (전용 결제수단) | 제22조, 23조 | 청구서 발송 비용 (55P/건), 출결 메시지 (11P/건) |
| 카드 가맹점 등록 대행 | 제17조 | 신규 학원 온보딩 시 활용 |

### 2-3. 쌤포인트 약관 분석 (제22~24조)

| 항목 | 내용 | 온리쌤 영향 |
|------|------|-----------|
| 1P = 1원 | 제23조 4항 | 비용 계산 그대로 |
| 유효기간 5년 | 제23조 5항 | 장기 보관 가능 |
| 자동충전 가능 | 제22조 3항 | 발송 실패 방지 자동화 |
| 7일 이내 환불 가능 | 제24조 1항 | 미사용분 전액 |
| 7일 초과 환불 시 수수료 10% | 제24조 1항 단서 | 충전 전략에 반영 |
| 양도·부정사용 금지 | 제23조 2항 | 학원 간 포인트 공유 불가 |
| 탈퇴 시 소멸 | 제31조 4항 | 반드시 탈퇴 전 환불 |

### 2-4. 데이터 처리 제약 (개인정보처리방침)

| 수집 항목 | 용도 | 온리쌤 매핑 |
|----------|------|------------|
| 고객 휴대전화번호 (필수) | 청구서 발송 | `parent_phone` |
| 고객 이름 (선택) | 청구서 관리 | `students.name` |
| 학생 이름, 생년월일, 전화번호 | 학생 관리 | `students` 테이블 |
| 보호자 휴대전화번호 | 출결 메시지 | `students.parent_phone` |
| 결제정보 (카드번호 마스킹, 승인번호 등) | 수납 관리 | `payment_invoices.raw_response` |

핵심 제약:
- 수집 목적 외 사용 금지 — 결제 데이터를 마케팅에 사용하면 안 됨
- 제3자 제공 시 별도 동의 필요 — 여러 학원 간 결제 데이터 교차 분석은 학부모 동의 필수
- 보유 기간: 거래 관련 5년, 소비자 불만 3년, 접속 로그 3개월

### 2-5. 보안약정 핵심 (고객정보 보안관리 약정서)

| 조항 | 의무 | 온리쌤 대응 |
|------|------|-----------|
| 제4조 (목적 외 사용 금지) | 결제 데이터는 청구·수납 목적으로만 | lesson_records에는 상태(paid/overdue)만 참조 |
| 제5조 (재위탁 제한) | 제3자 위탁 시 페이민트 사전승인 | 데이터 파이프라인 설계 시 고려 |
| 제6조 (암호화 전송) | 네트워크 전송 시 암호화 | HTTPS + API Key 인증 ✅ |
| 제8조 (파기 의무) | 기간 초과 즉시 파기 + 파기확인서 | 5년 자동 파기 cron 필요 |
| 제9조 (손해배상) | 데이터 유출 시 수탁자(온리쌤) 배상 | RLS + 암호화 필수 |
| 제12조 (교육) | 연 1회 정보보호 교육 | 운영 절차에 포함 |

위탁 항목 (약정서 제3조):
- 청구서: 받는사람 이름, 휴대전화번호, 청구사유, 청구금액, 결제정보
- 학생 관리: 이름, 전화번호, 생년월일, 입학일, 보호자 전화번호
- 출결 관리: 이름, 출결여부, 등하원일시, 보호자 전화번호

---

## 3. 코드베이스 현황 — 이미 구현된 것

### 3-1. PaySSAM API 연동 (paySSAMService.ts)

```
API Base: api.payssam.kr/v1
인증: Authorization: PLKEY {API_KEY}

4가지 엔드포인트:
├─ POST /invoices/send        → 청구서 발송
├─ GET  /invoices/{id}/status → 수납 상태 조회
├─ GET  /points/balance       → 쌤포인트 잔액
└─ POST /invoices/{id}/cancel → 청구서 취소
```

### 3-2. DB 스키마 (payment_invoices 테이블)

```
payment_invoices
├─ id, org_id, student_id      → 온리쌤 내부 식별
├─ parent_phone, amount         → 청구 정보
├─ payssam_invoice_id           → 결제선생 외부 ID
├─ status (6종)                 → pending → sent → paid/overdue/cancelled/failed
├─ point_cost (기본 55)         → 쌤포인트 차감 기록
├─ dedupe_key (UNIQUE)          → 중복 발송 방지
└─ raw_response (JSONB)         → 원본 응답 보관
```

### 3-3. Webhook 처리 (webhook-payssam Edge Function)

```
PaySSAM → POST callback_url → 온리쌤
  ├─ PAYMENT_COMPLETED: status → 'paid'
  ├─ INVOICE_EXPIRED:   status → 'overdue'
  └─ PAYMENT_FAILED:    status → 'failed'

보안: SHA256(customer_phone + invoice_id + API_KEY) 서명 검증
멱등성: events 테이블에 idempotency_key로 중복 수신 방지
```

### 3-4. 상담선생 연동 (consultationTeacherService.ts)

```
결제 Truth → 상담선생 위험 감지

감지 조건:
├─ overdue_payment: due_date < NOW() - 3일 AND status IN ('sent','overdue')
├─ low_vindex:      students.v_index < 60
└─ absent_streak:   연속 결석 3회 이상

감지 → consultation_sessions 자동 INSERT
```

### 3-5. 기록선생 연동 (recordTeacherService.ts)

```
출석 Truth → 기록선생 빈도 로그

체인: attendance_records → lesson_records (log_type: 'frequency')
연결: lesson_records.attendance_event_id → attendance_records.id
```

### 3-6. 청구서 발송 흐름 (IOO 패턴)

```
Input:  sendInvoice({ studentId, parentPhone, amount, description })
  ↓
Operation: 6단계
  1️⃣ 선기록: payment_invoices에 pending 상태로 저장
  2️⃣ 중복 체크: dedupe_key 조회
  3️⃣ PaySSAM API 호출: POST /invoices/send
  4️⃣ 외부 ID 수신: payssam_invoice_id 획득
  5️⃣ 상태 업데이트: status → 'sent'
  6️⃣ 에러 처리: 실패 시 status → 'failed'
  ↓
Output: { invoiceId, paySSAMInvoiceId, dedupeKey, remainingPoints }
```

### 3-7. Toss Payments와의 역할 분담

| 서비스 | 용도 | 결제 방식 |
|--------|------|---------|
| PaySSAM | 청구서 기반 수업료 | 카카오 알림톡 → 링크 결제 |
| Toss | 앱 내 직접 결제 | 카드/계좌이체/정기결제 |

---

## 4. 연동 포인트 — 아직 안 된 것

### 4-1. 결제 Truth → 기록선생 지속 로그 (우선순위 1)

현재: 결제선생 → payment_invoices (수납 상태만)
필요: 결제 완료 → lesson_records (log_type: 'persistence') 자동 생성

```
webhook-payssam (PAYMENT_COMPLETED)
  └─→ lesson_records INSERT
       log_type: 'persistence'
       metadata: { payment_amount, payment_method, invoice_id }
```

이것이 완성되면 5대 로그 중 4개가 자동 수집됨.

### 4-2. 쌤포인트 잔액 모니터링 (우선순위 2)

현재: getPointBalance() 함수 존재하지만 자동 모니터링 없음
필요: 포인트 부족 시 알림 → 청구서 발송 실패 예방

```
cron (매일 08:00)
  ├─ getPointBalance() < 임계값(1,000P)
  └─ 몰트봇 알림: "쌤포인트 {잔액}P — 충전 필요"
```

### 4-3. 미납 → V-Index 감소 자동화 (우선순위 3)

현재: 상담선생이 미납 감지 → 상담 예약
필요: 미납 → V-Index Threats 직접 증가 → 물리엔진 반영

### 4-4. 정기 결제 패턴 → 패턴 로그 (우선순위 4)

결제선생의 정기 발송 패턴도 lesson_records에 log_type: 'pattern'으로 기록

### 4-5. 출결선생 동기화 (우선순위 5)

결제선생 출결선생(카카오 알림톡 기반) ↔ 온리쌤 출결선생(QR 기반) 데이터 동기화
약관 제약: 출결선생은 교육업종에 한해 제공 (제20조)

---

## 5. 데이터 흐름 종합도

```
결제선생 (PaySSAM)                     온리쌤
━━━━━━━━━━━━━━━━━━                    ━━━━━━

[청구서 발송 API] ──────────────→ payment_invoices (pending→sent)
         │                              │
         │ 카카오 알림톡                │
         ▼                              │
    학부모 결제                          │
         │                              │
[Webhook 콜백] ────────────────→ payment_invoices (sent→paid) ──┐
                                        │                        │
                                        ▼                        │
                                 events (IOO Trace)              │
                                        │                        │
                               ┌────────┴────────┐              │
                               ▼                  ▼              ▼
                        상담선생              기록선생         V-Index
                    (위험 감지)          (지속 로그 생성)    (감소/증가)
                        │                      │                 │
                        ▼                      ▼                 ▼
                 consultation_          lesson_records     students.v_index
                 sessions              (persistence)
                        │                      │
                        └──────────┬───────────┘
                                   ▼
                            학생 포트폴리오
                         (clone_readiness_score)
                                   ▼
                         피지컬 AI 클론 (궁극 목표)
```

---

## 6. 비용 구조

### 6-1. 현재 비용

| 항목 | 비용 | 설명 |
|------|------|------|
| 청구서 발송 | 55원/건 (쌤포인트) | 카카오 알림톡 포함 |
| 결제 수수료 | 0.4%~ | 카드사 직접 정산 (PG 없음) |
| 가입비/월정액/약정 | 0원 | 없음 |
| 출결 메시지 | 11원/건 (쌤포인트) | 출결선생 이용 시 |

### 6-2. 월간 비용 시뮬레이션 (학원 50명 기준)

```
청구서 발송:  50명 × 55원 = 2,750원/월
출결 메시지:  50명 × 20일 × 11원 = 11,000원/월
결제 수수료:  50명 × 30만원 × 0.4% = 60,000원/월
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
총: ~73,750원/월 (쌤포인트: 13,750P/월)
```

---

## 7. 약관상 체크리스트

### MUST (반드시)

- [ ] 결제 데이터는 청구·수납 목적으로만 사용 (보안약정 제4조)
- [ ] 학부모 개인정보 제3자 제공 시 별도 동의 (개인정보처리방침 3조)
- [ ] 결제선생 데이터 재위탁 시 페이민트 사전승인 (보안약정 제5조)
- [ ] 네트워크 전송 시 암호화 (보안약정 제6조)
- [ ] 기간 초과 데이터 즉시 파기 (보안약정 제8조)
- [ ] 연 1회 정보보호 교육 (보안약정 제12조)

### SHOULD (권장)

- [ ] lesson_records에 결제 금액 직접 저장보다 상태만 참조
- [ ] raw_response에 카드번호 마스킹 검증
- [ ] 학원 폐업 시 데이터 파기 절차

### MUST NOT (금지)

- 결제 데이터를 마케팅·광고에 활용
- 학부모 전화번호를 결제 외 목적 사용
- API Key를 클라이언트 코드에 노출
- 카드번호(마스킹 전)를 DB에 저장

---

## 8. 다음 구현 우선순위

| 순위 | 작업 | 난이도 | 영향도 |
|------|------|--------|--------|
| 1 | webhook-payssam → 기록선생 지속 로그 | 낮음 | **높음** (5대 로그 4/5) |
| 2 | 쌤포인트 잔액 모니터링 cron | 낮음 | 중간 |
| 3 | 미납 → V-Index 감소 자동화 | 중간 | 높음 |
| 4 | 정기 결제 패턴 로그 | 중간 | 중간 |
| 5 | 출결선생 동기화 | 높음 | 중간 |

---

## 9. 결론

결제선생을 단순 결제 도구로 보면 안 된다. 온리쌤 관점에서 결제선생은:

1. **지속 로그의 유일한 생산자** — 학생이 계속 다니는지의 Truth
2. **위험 감지의 첫 번째 센서** — 미납 = 퇴원 징조
3. **학부모 접점의 유일한 채널** — 카카오 알림톡
4. **비용의 변동비 원천** — 쌤포인트 55원/건

**"결제가 흐르면 학생이 남고, 결제가 멈추면 학생이 떠난다."**

이것이 결제선생이 온리쌤의 핵심 Truth Source인 이유다.

---

*v2 업데이트: 2026-02-13 — 서비스 이용약관, 개인정보 처리방침, 고객정보 보안관리 약정서 분석 추가*
