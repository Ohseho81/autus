{"version":3,"file":"app/api/consensus/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/consensus/route.ts","webpack://_N_E/./app/api/consensus/route.ts?2e7b","webpack://_N_E/?001f"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","// ============================================\n// AUTUS Consensus API - 활용 기반 자동 합의\n// ============================================\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { db } from '@/lib/supabase';\nimport { calculateEffectiveness, checkStandardQualification, calculateVGrowth } from '@/lib/physics';\n\nexport const runtime = 'edge';\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n};\n\nexport async function OPTIONS() {\n  return new NextResponse(null, { status: 200, headers: corsHeaders });\n}\n\n// GET /api/consensus?taskId=xxx\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const taskId = searchParams.get('taskId');\n\n    // 솔루션 랭킹 조회\n    const ranking = await db.getSolutionRanking(taskId || undefined);\n\n    // 표준 솔루션 조회\n    const standard = taskId ? await db.getStandard(taskId) : null;\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        ranking,\n        standard,\n        criteria: {\n          effectiveness_threshold: 0.80,\n          usage_count_threshold: 50,\n          v_growth_threshold: 0.15\n        }\n      }\n    }, { status: 200, headers: corsHeaders });\n\n  } catch (error: any) {\n    console.error('Consensus GET Error:', error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n\n// POST /api/consensus (활용 기록)\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { action, payload } = body;\n\n    if (action === 'log_usage') {\n      const {\n        task_id,\n        solution_id,\n        user_id,\n        before,    // { m, t, s }\n        after,     // { m, t, s }\n        duration_minutes\n      } = payload;\n\n      // Validation\n      if (!task_id || !solution_id || !user_id || !before || !after) {\n        return NextResponse.json(\n          { success: false, error: 'Missing required fields' },\n          { status: 400, headers: corsHeaders }\n        );\n      }\n\n      // 실효성 점수 계산\n      const deltaM = before.m > 0 ? (after.m - before.m) / before.m : 0;\n      const deltaT = before.t > 0 ? (before.t - after.t) / before.t : 0;\n      const deltaS = before.s > 0 ? (after.s - before.s) / before.s : 0;\n      \n      // 사용 빈도 정규화 (간단히 0.5 고정, 실제론 전체 대비 비율)\n      const usageNorm = 0.5;\n      \n      const effectivenessScore = calculateEffectiveness(deltaM, deltaT, usageNorm, deltaS);\n      \n      // V 성장률\n      const vGrowth = calculateVGrowth(\n        { mint: before.m, tax: before.t, synergy: before.s },\n        { mint: after.m, tax: after.t, synergy: after.s }\n      );\n\n      // 로그 저장\n      const log = await db.createUsageLog({\n        task_id,\n        solution_id,\n        user_id,\n        before_m: before.m,\n        before_t: before.t,\n        before_s: before.s,\n        after_m: after.m,\n        after_t: after.t,\n        after_s: after.s,\n        effectiveness_score: effectivenessScore,\n        v_growth: vGrowth,\n        duration_minutes: duration_minutes || 0\n      });\n\n      return NextResponse.json({\n        success: true,\n        data: {\n          log,\n          effectiveness_score: effectivenessScore,\n          v_growth: vGrowth,\n          is_effective: effectivenessScore >= 0.8\n        }\n      }, { status: 200, headers: corsHeaders });\n    }\n\n    if (action === 'check_standard') {\n      const { solution_id } = payload;\n      \n      // 솔루션 통계 조회\n      const ranking = await db.getSolutionRanking();\n      const solution = ranking.find((s: any) => s.solution_id === solution_id);\n      \n      if (!solution) {\n        return NextResponse.json(\n          { success: false, error: 'Solution not found in ranking' },\n          { status: 404, headers: corsHeaders }\n        );\n      }\n\n      const qualifies = checkStandardQualification(\n        solution.avg_score,\n        solution.usage_count,\n        solution.avg_v_growth\n      );\n\n      return NextResponse.json({\n        success: true,\n        data: {\n          solution_id,\n          current_stats: {\n            effectiveness: solution.avg_score,\n            usage_count: solution.usage_count,\n            avg_v_growth: solution.avg_v_growth\n          },\n          qualifies_for_standard: qualifies,\n          missing: {\n            effectiveness: Math.max(0, 0.80 - solution.avg_score),\n            usage: Math.max(0, 50 - solution.usage_count),\n            v_growth: Math.max(0, 0.15 - solution.avg_v_growth)\n          }\n        }\n      }, { status: 200, headers: corsHeaders });\n    }\n\n    return NextResponse.json(\n      { success: false, error: 'Unknown action' },\n      { status: 400, headers: corsHeaders }\n    );\n\n  } catch (error: any) {\n    console.error('Consensus POST Error:', error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/Users/oseho/Desktop/autus/vercel-api/app/api/consensus/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/consensus/route\",\n        pathname: \"/api/consensus\",\n        filename: \"route\",\n        bundlePath: \"app/api/consensus/route\"\n    },\n    resolvedPagePath: \"/Users/oseho/Desktop/autus/vercel-api/app/api/consensus/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/consensus/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fconsensus%2Froute&page=%2Fapi%2Fconsensus%2Froute&pagePath=private-next-app-dir%2Fapi%2Fconsensus%2Froute.ts&appDir=%2FUsers%2Foseho%2FDesktop%2Fautus%2Fvercel-api%2Fapp&appPaths=%2Fapi%2Fconsensus%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/consensus/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map"],"names":["module","exports","require","runtime","corsHeaders","OPTIONS","NextResponse","status","headers","GET","request","searchParams","URL","url","taskId","get","ranking","db","getSolutionRanking","undefined","standard","getStandard","json","success","data","criteria","effectiveness_threshold","usage_count_threshold","v_growth_threshold","error","console","message","POST","action","payload","task_id","solution_id","user_id","before","after","duration_minutes","deltaM","m","deltaT","t","deltaS","s","effectivenessScore","calculateEffectiveness","vGrowth","calculateVGrowth","mint","tax","synergy","log","createUsageLog","before_m","before_t","before_s","after_m","after_t","after_s","effectiveness_score","v_growth","is_effective","solution","find","qualifies","checkStandardQualification","avg_score","usage_count","avg_v_growth","current_stats","effectiveness","qualifies_for_standard","missing","Math","max","usage","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fconsensus_2Froute_ts_page_2Fapi_2Fconsensus_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGY29uc2Vuc3VzJTJGcm91dGUmcGFnZT0lMkZhcGklMkZjb25zZW5zdXMlMkZyb3V0ZSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmNvbnNlbnN1cyUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRm9zZWhvJTJGRGVza3RvcCUyRmF1dHVzJTJGdmVyY2VsLWFwaSUyRmFwcCZhcHBQYXRocz0lMkZhcGklMkZjb25zZW5zdXMlMkZyb3V0ZSZwYWdlRXh0ZW5zaW9ucz10c3gmcGFnZUV4dGVuc2lvbnM9dHMmcGFnZUV4dGVuc2lvbnM9anN4JnBhZ2VFeHRlbnNpb25zPWpzJmJhc2VQYXRoPSZhc3NldFByZWZpeD0mbmV4dENvbmZpZ091dHB1dD0mcHJlZmVycmVkUmVnaW9uPSZtaWRkbGV3YXJlQ29uZmlnPWUzMCUzRCE_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap"],"sourceRoot":""}