{"version":3,"file":"app/api/erp/smartfit/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/erp/smartfit/route.ts","webpack://_N_E/./app/api/erp/smartfit/route.ts?ca29","webpack://_N_E/?8265"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","/**\n * AUTUS x 스마트핏 (SmartFit) ERP 연동 API\n * \n * 지원 방식:\n * 1. CSV 파일 업로드 (POST with multipart/form-data)\n * 2. JSON 데이터 직접 전송 (POST with application/json)\n * 3. 구글드라이브 연동 (GET with folder_id)\n */\n\nimport { createClient } from '@supabase/supabase-js';\n\nexport const runtime = 'edge';\n\n// Supabase 클라이언트\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL || '',\n  process.env.SUPABASE_SERVICE_ROLE_KEY || ''\n);\n\n// 스마트핏 CSV 필드 매핑\ninterface SmartFitStudent {\n  student_code: string;\n  name: string;\n  grade: string;\n  class_name: string;\n  parent_name: string;\n  parent_phone: string;\n  registered_at: string;\n  monthly_fee: number;\n  unpaid_amount: number;\n  last_attendance: string;\n  attendance_rate: number;\n  memo: string;\n}\n\n// 위험도 계산 함수\nfunction calculateRiskScore(student: SmartFitStudent): number {\n  let risk = 0;\n  \n  // 1. 미납금 기준 (최대 150점)\n  if (student.unpaid_amount >= 500000) risk += 150;\n  else if (student.unpaid_amount >= 300000) risk += 100;\n  else if (student.unpaid_amount >= 100000) risk += 50;\n  else if (student.unpaid_amount > 0) risk += 20;\n  \n  // 2. 출석률 기준 (최대 150점)\n  if (student.attendance_rate < 50) risk += 150;\n  else if (student.attendance_rate < 70) risk += 100;\n  else if (student.attendance_rate < 85) risk += 50;\n  \n  // 3. 최근 출석 기준 (최대 50점)\n  const daysSinceLastAttendance = Math.floor(\n    (Date.now() - new Date(student.last_attendance).getTime()) / (1000 * 60 * 60 * 24)\n  );\n  if (daysSinceLastAttendance > 7) risk += 50;\n  else if (daysSinceLastAttendance > 3) risk += 25;\n  \n  // 4. 메모 키워드 분석 (최대 50점)\n  const warningKeywords = ['퇴원', '고민', '불만', '연락', '어려움', '변경', '중단'];\n  const memoLower = student.memo?.toLowerCase() || '';\n  for (const keyword of warningKeywords) {\n    if (memoLower.includes(keyword)) {\n      risk += 25;\n      break;\n    }\n  }\n  \n  return Math.min(300, risk);\n}\n\n// Risk Band 결정\nfunction getRiskBand(score: number): string {\n  if (score >= 200) return 'critical';\n  if (score >= 150) return 'high';\n  if (score >= 100) return 'medium';\n  return 'low';\n}\n\n// CSV 파싱 함수\nfunction parseCSV(csvText: string): SmartFitStudent[] {\n  const lines = csvText.trim().split('\\n');\n  const headers = lines[0].split(',').map(h => h.trim());\n  \n  // 헤더 인덱스 찾기 (스마트핏 다양한 포맷 대응)\n  const findIndex = (keywords: string[]) => {\n    return headers.findIndex(h => \n      keywords.some(k => h.includes(k))\n    );\n  };\n  \n  const idx = {\n    code: findIndex(['학생코드', '코드', 'ID', '번호']),\n    name: findIndex(['학생명', '이름', '성명']),\n    grade: findIndex(['학년', '학교']),\n    className: findIndex(['반', '클래스', '과목']),\n    parentName: findIndex(['학부모', '보호자', '부모']),\n    parentPhone: findIndex(['연락처', '전화', '휴대폰', '핸드폰']),\n    registeredAt: findIndex(['등록일', '입학일', '가입일']),\n    fee: findIndex(['등록금', '수강료', '월납입']),\n    unpaid: findIndex(['미납', '미수금', '연체']),\n    lastAttendance: findIndex(['최근출석', '마지막출석', '출석일']),\n    attendanceRate: findIndex(['출석률', '출석%']),\n    memo: findIndex(['메모', '비고', '상담']),\n  };\n  \n  const students: SmartFitStudent[] = [];\n  \n  for (let i = 1; i < lines.length; i++) {\n    const values = lines[i].split(',').map(v => v.trim());\n    if (values.length < 3) continue; // 빈 줄 스킵\n    \n    const student: SmartFitStudent = {\n      student_code: values[idx.code] || `AUTO_${i}`,\n      name: values[idx.name] || '',\n      grade: values[idx.grade] || '',\n      class_name: values[idx.className] || '',\n      parent_name: values[idx.parentName] || '',\n      parent_phone: values[idx.parentPhone] || '',\n      registered_at: values[idx.registeredAt] || new Date().toISOString().split('T')[0],\n      monthly_fee: parseInt(values[idx.fee]?.replace(/[^0-9]/g, '') || '0'),\n      unpaid_amount: parseInt(values[idx.unpaid]?.replace(/[^0-9]/g, '') || '0'),\n      last_attendance: values[idx.lastAttendance] || new Date().toISOString().split('T')[0],\n      attendance_rate: parseFloat(values[idx.attendanceRate]?.replace('%', '') || '100'),\n      memo: values[idx.memo] || '',\n    };\n    \n    if (student.name) {\n      students.push(student);\n    }\n  }\n  \n  return students;\n}\n\n// POST: CSV 업로드 또는 JSON 데이터 수신\nexport async function POST(req: Request) {\n  try {\n    const contentType = req.headers.get('content-type') || '';\n    const url = new URL(req.url);\n    const academyId = url.searchParams.get('academy_id') || 'demo-academy';\n    \n    let students: SmartFitStudent[] = [];\n    \n    // Content-Type에 따른 처리\n    if (contentType.includes('multipart/form-data')) {\n      // CSV 파일 업로드\n      const formData = await req.formData();\n      const file = formData.get('file') as File;\n      \n      if (!file) {\n        return Response.json({ success: false, error: 'CSV 파일이 필요합니다' }, { status: 400 });\n      }\n      \n      const csvText = await file.text();\n      students = parseCSV(csvText);\n      \n    } else if (contentType.includes('application/json')) {\n      // JSON 직접 전송\n      const body = await req.json();\n      \n      if (body.csv_text) {\n        students = parseCSV(body.csv_text);\n      } else if (body.students && Array.isArray(body.students)) {\n        students = body.students;\n      } else {\n        return Response.json({ success: false, error: 'csv_text 또는 students 배열이 필요합니다' }, { status: 400 });\n      }\n      \n    } else if (contentType.includes('text/csv')) {\n      // Raw CSV 텍스트\n      const csvText = await req.text();\n      students = parseCSV(csvText);\n      \n    } else {\n      return Response.json({ \n        success: false, \n        error: '지원하지 않는 Content-Type입니다. multipart/form-data, application/json, text/csv 중 하나를 사용하세요.' \n      }, { status: 400 });\n    }\n    \n    if (students.length === 0) {\n      return Response.json({ success: false, error: '파싱된 학생 데이터가 없습니다' }, { status: 400 });\n    }\n    \n    // 데이터 변환 및 저장\n    const results = {\n      total: students.length,\n      synced: 0,\n      critical: 0,\n      high: 0,\n      errors: [] as string[],\n    };\n    \n    for (const student of students) {\n      try {\n        const riskScore = calculateRiskScore(student);\n        const riskBand = getRiskBand(riskScore);\n        \n        // Supabase에 저장\n        const { error } = await supabase.from('students').upsert({\n          academy_id: academyId,\n          external_id: student.student_code,\n          name: student.name,\n          grade: student.grade,\n          class_name: student.class_name,\n          parent_name: student.parent_name,\n          parent_phone: student.parent_phone,\n          registered_at: student.registered_at,\n          monthly_fee: student.monthly_fee,\n          unpaid_amount: student.unpaid_amount,\n          last_attendance: student.last_attendance,\n          attendance_rate: student.attendance_rate,\n          memo: student.memo,\n          risk_score: riskScore,\n          risk_band: riskBand,\n          erp_source: 'smartfit',\n          synced_at: new Date().toISOString(),\n        }, {\n          onConflict: 'academy_id,external_id',\n        });\n        \n        if (error) {\n          results.errors.push(`${student.name}: ${error.message}`);\n        } else {\n          results.synced++;\n          if (riskBand === 'critical') results.critical++;\n          else if (riskBand === 'high') results.high++;\n        }\n        \n      } catch (err) {\n        results.errors.push(`${student.name}: ${err}`);\n      }\n    }\n    \n    // 동기화 로그 저장\n    await supabase.from('sync_logs').insert({\n      academy_id: academyId,\n      erp_source: 'smartfit',\n      total_records: results.total,\n      synced_records: results.synced,\n      critical_count: results.critical,\n      high_count: results.high,\n      errors: results.errors.length > 0 ? results.errors : null,\n      synced_at: new Date().toISOString(),\n    });\n    \n    return Response.json({\n      success: true,\n      message: `스마트핏 데이터 동기화 완료`,\n      data: {\n        total: results.total,\n        synced: results.synced,\n        critical_students: results.critical,\n        high_risk_students: results.high,\n        errors: results.errors.length,\n      },\n      alerts: results.critical > 0 ? [\n        `⚠️ 위험 학생 ${results.critical}명 감지됨! AUTUS 대시보드를 확인하세요.`\n      ] : [],\n    });\n    \n  } catch (error) {\n    console.error('SmartFit sync error:', error);\n    return Response.json({ \n      success: false, \n      error: error instanceof Error ? error.message : '데이터 처리 중 오류 발생' \n    }, { status: 500 });\n  }\n}\n\n// GET: 동기화 상태 확인\nexport async function GET(req: Request) {\n  const url = new URL(req.url);\n  const academyId = url.searchParams.get('academy_id') || 'demo-academy';\n  \n  // 최근 동기화 로그 조회\n  const { data: logs, error: logsError } = await supabase\n    .from('sync_logs')\n    .select('*')\n    .eq('academy_id', academyId)\n    .eq('erp_source', 'smartfit')\n    .order('synced_at', { ascending: false })\n    .limit(5);\n  \n  // 현재 학생 통계\n  const { data: students, error: studentsError } = await supabase\n    .from('students')\n    .select('risk_band')\n    .eq('academy_id', academyId)\n    .eq('erp_source', 'smartfit');\n  \n  const stats = {\n    total: students?.length || 0,\n    critical: students?.filter(s => s.risk_band === 'critical').length || 0,\n    high: students?.filter(s => s.risk_band === 'high').length || 0,\n    medium: students?.filter(s => s.risk_band === 'medium').length || 0,\n    low: students?.filter(s => s.risk_band === 'low').length || 0,\n  };\n  \n  return Response.json({\n    success: true,\n    academy_id: academyId,\n    erp_source: 'smartfit',\n    current_stats: stats,\n    recent_syncs: logs || [],\n    instructions: {\n      upload_csv: 'POST /api/erp/smartfit?academy_id=YOUR_ID with CSV file',\n      upload_json: 'POST /api/erp/smartfit?academy_id=YOUR_ID with { \"csv_text\": \"...\" }',\n      check_status: 'GET /api/erp/smartfit?academy_id=YOUR_ID',\n    },\n  });\n}\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/Users/oseho/Desktop/autus/vercel-api/app/api/erp/smartfit/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/erp/smartfit/route\",\n        pathname: \"/api/erp/smartfit\",\n        filename: \"route\",\n        bundlePath: \"app/api/erp/smartfit/route\"\n    },\n    resolvedPagePath: \"/Users/oseho/Desktop/autus/vercel-api/app/api/erp/smartfit/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/erp/smartfit/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Ferp%2Fsmartfit%2Froute&page=%2Fapi%2Ferp%2Fsmartfit%2Froute&pagePath=private-next-app-dir%2Fapi%2Ferp%2Fsmartfit%2Froute.ts&appDir=%2FUsers%2Foseho%2FDesktop%2Fautus%2Fvercel-api%2Fapp&appPaths=%2Fapi%2Ferp%2Fsmartfit%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/erp/smartfit/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map"],"names":["module","exports","require","runtime","supabase","createClient","process","env","SUPABASE_SERVICE_ROLE_KEY","parseCSV","csvText","lines","trim","split","headers","map","h","findIndex","keywords","some","k","includes","idx","code","name","grade","className","parentName","parentPhone","registeredAt","fee","unpaid","lastAttendance","attendanceRate","memo","students","i","length","values","v","student","student_code","class_name","parent_name","parent_phone","registered_at","Date","toISOString","monthly_fee","parseInt","replace","unpaid_amount","last_attendance","attendance_rate","parseFloat","push","POST","req","contentType","get","academyId","url","URL","searchParams","file","formData","Response","json","success","error","status","text","body","csv_text","Array","isArray","results","total","synced","critical","high","errors","riskScore","calculateRiskScore","risk","daysSinceLastAttendance","Math","floor","now","getTime","memoLower","toLowerCase","keyword","min","riskBand","score","from","upsert","academy_id","external_id","risk_score","risk_band","erp_source","synced_at","onConflict","message","err","insert","total_records","synced_records","critical_count","high_count","data","critical_students","high_risk_students","alerts","console","Error","GET","logs","logsError","select","eq","order","ascending","limit","studentsError","stats","filter","s","medium","low","current_stats","recent_syncs","instructions","upload_csv","upload_json","check_status","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Ferp_2Fsmartfit_2Froute_ts_page_2Fapi_2Ferp_2Fsmartfit_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGZXJwJTJGc21hcnRmaXQlMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRmVycCUyRnNtYXJ0Zml0JTJGcm91dGUmcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZlcnAlMkZzbWFydGZpdCUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRm9zZWhvJTJGRGVza3RvcCUyRmF1dHVzJTJGdmVyY2VsLWFwaSUyRmFwcCZhcHBQYXRocz0lMkZhcGklMkZlcnAlMkZzbWFydGZpdCUyRnJvdXRlJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEIQ_3D_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap"],"sourceRoot":""}