(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[762],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},559:(e,t,a)=>{"use strict";a.r(t),a.d(t,{ComponentMod:()=>R,default:()=>k});var r={};a.r(r),a.d(r,{GET:()=>_,POST:()=>m,runtime:()=>l});var s={};a.r(s),a.d(s,{originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var n=a(932),i=a(2561),o=a(4828),c=a(6631),d=a(4956);let l="edge",u=(0,d.eI)("https://pphzvnaedmzcvpxjulti.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY||"");function p(e){let t=e.trim().split("\n"),a=t[0].split(",").map(e=>e.trim()),r=e=>a.findIndex(t=>e.some(e=>t.includes(e))),s={code:r(["학생코드","코드","ID","번호"]),name:r(["학생명","이름","성명"]),grade:r(["학년","학교"]),className:r(["반","클래스","과목"]),parentName:r(["학부모","보호자","부모"]),parentPhone:r(["연락처","전화","휴대폰","핸드폰"]),registeredAt:r(["등록일","입학일","가입일"]),fee:r(["등록금","수강료","월납입"]),unpaid:r(["미납","미수금","연체"]),lastAttendance:r(["최근출석","마지막출석","출석일"]),attendanceRate:r(["출석률","출석%"]),memo:r(["메모","비고","상담"])},n=[];for(let e=1;e<t.length;e++){let a=t[e].split(",").map(e=>e.trim());if(a.length<3)continue;let r={student_code:a[s.code]||`AUTO_${e}`,name:a[s.name]||"",grade:a[s.grade]||"",class_name:a[s.className]||"",parent_name:a[s.parentName]||"",parent_phone:a[s.parentPhone]||"",registered_at:a[s.registeredAt]||new Date().toISOString().split("T")[0],monthly_fee:parseInt(a[s.fee]?.replace(/[^0-9]/g,"")||"0"),unpaid_amount:parseInt(a[s.unpaid]?.replace(/[^0-9]/g,"")||"0"),last_attendance:a[s.lastAttendance]||new Date().toISOString().split("T")[0],attendance_rate:parseFloat(a[s.attendanceRate]?.replace("%","")||"100"),memo:a[s.memo]||""};r.name&&n.push(r)}return n}async function m(e){try{let t=e.headers.get("content-type")||"",a=new URL(e.url).searchParams.get("academy_id")||"demo-academy",r=[];if(t.includes("multipart/form-data")){let t=(await e.formData()).get("file");if(!t)return Response.json({success:!1,error:"CSV 파일이 필요합니다"},{status:400});let a=await t.text();r=p(a)}else if(t.includes("application/json")){let t=await e.json();if(t.csv_text)r=p(t.csv_text);else{if(!(t.students&&Array.isArray(t.students)))return Response.json({success:!1,error:"csv_text 또는 students 배열이 필요합니다"},{status:400});r=t.students}}else{if(!t.includes("text/csv"))return Response.json({success:!1,error:"지원하지 않는 Content-Type입니다. multipart/form-data, application/json, text/csv 중 하나를 사용하세요."},{status:400});let a=await e.text();r=p(a)}if(0===r.length)return Response.json({success:!1,error:"파싱된 학생 데이터가 없습니다"},{status:400});let s={total:r.length,synced:0,critical:0,high:0,errors:[]};for(let e of r)try{let t=function(e){let t=0;e.unpaid_amount>=5e5?t+=150:e.unpaid_amount>=3e5?t+=100:e.unpaid_amount>=1e5?t+=50:e.unpaid_amount>0&&(t+=20),e.attendance_rate<50?t+=150:e.attendance_rate<70?t+=100:e.attendance_rate<85&&(t+=50);let a=Math.floor((Date.now()-new Date(e.last_attendance).getTime())/864e5);a>7?t+=50:a>3&&(t+=25);let r=e.memo?.toLowerCase()||"";for(let e of["퇴원","고민","불만","연락","어려움","변경","중단"])if(r.includes(e)){t+=25;break}return Math.min(300,t)}(e),r=t>=200?"critical":t>=150?"high":t>=100?"medium":"low",{error:n}=await u.from("students").upsert({academy_id:a,external_id:e.student_code,name:e.name,grade:e.grade,class_name:e.class_name,parent_name:e.parent_name,parent_phone:e.parent_phone,registered_at:e.registered_at,monthly_fee:e.monthly_fee,unpaid_amount:e.unpaid_amount,last_attendance:e.last_attendance,attendance_rate:e.attendance_rate,memo:e.memo,risk_score:t,risk_band:r,erp_source:"smartfit",synced_at:new Date().toISOString()},{onConflict:"academy_id,external_id"});n?s.errors.push(`${e.name}: ${n.message}`):(s.synced++,"critical"===r?s.critical++:"high"===r&&s.high++)}catch(t){s.errors.push(`${e.name}: ${t}`)}return await u.from("sync_logs").insert({academy_id:a,erp_source:"smartfit",total_records:s.total,synced_records:s.synced,critical_count:s.critical,high_count:s.high,errors:s.errors.length>0?s.errors:null,synced_at:new Date().toISOString()}),Response.json({success:!0,message:`스마트핏 데이터 동기화 완료`,data:{total:s.total,synced:s.synced,critical_students:s.critical,high_risk_students:s.high,errors:s.errors.length},alerts:s.critical>0?[`⚠️ 위험 학생 ${s.critical}명 감지됨! AUTUS 대시보드를 확인하세요.`]:[]})}catch(e){return console.error("SmartFit sync error:",e),Response.json({success:!1,error:e instanceof Error?e.message:"데이터 처리 중 오류 발생"},{status:500})}}async function _(e){let t=new URL(e.url).searchParams.get("academy_id")||"demo-academy",{data:a,error:r}=await u.from("sync_logs").select("*").eq("academy_id",t).eq("erp_source","smartfit").order("synced_at",{ascending:!1}).limit(5),{data:s,error:n}=await u.from("students").select("risk_band").eq("academy_id",t).eq("erp_source","smartfit"),i={total:s?.length||0,critical:s?.filter(e=>"critical"===e.risk_band).length||0,high:s?.filter(e=>"high"===e.risk_band).length||0,medium:s?.filter(e=>"medium"===e.risk_band).length||0,low:s?.filter(e=>"low"===e.risk_band).length||0};return Response.json({success:!0,academy_id:t,erp_source:"smartfit",current_stats:i,recent_syncs:a||[],instructions:{upload_csv:"POST /api/erp/smartfit?academy_id=YOUR_ID with CSV file",upload_json:'POST /api/erp/smartfit?academy_id=YOUR_ID with { "csv_text": "..." }',check_status:"GET /api/erp/smartfit?academy_id=YOUR_ID"}})}let f=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/erp/smartfit/route",pathname:"/api/erp/smartfit",filename:"route",bundlePath:"app/api/erp/smartfit/route"},resolvedPagePath:"/Users/oseho/Desktop/autus/vercel-api/app/api/erp/smartfit/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:y}=f,w="/api/erp/smartfit/route";function S(){return(0,c.XH)({serverHooks:y,staticGenerationAsyncStorage:g})}let R=s,k=n.a.wrap(f)}},e=>{var t=t=>e(e.s=t);e.O(0,[546,956],()=>t(559));var a=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/erp/smartfit/route"]=a}]);
//# sourceMappingURL=route.js.map