{"version":3,"file":"app/api/rewards/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/rewards/route.ts","webpack://_N_E/./app/api/rewards/route.ts?9b32","webpack://_N_E/?8082","webpack://_N_E/./lib/claude.ts","webpack://_N_E/./lib/supabase.ts"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","// ============================================\n// AUTUS Rewards API - 보상 카드 관리\n// ============================================\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { db } from '@/lib/supabase';\nimport { ai } from '@/lib/claude';\n\nexport const runtime = 'edge';\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n};\n\nexport async function OPTIONS() {\n  return new NextResponse(null, { status: 200, headers: corsHeaders });\n}\n\n// GET /api/rewards?userId=xxx\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const userId = searchParams.get('userId');\n\n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'userId is required' },\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    const unread = await db.getUnreadRewards(userId);\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        unread_count: unread.length,\n        cards: unread\n      }\n    }, { status: 200, headers: corsHeaders });\n\n  } catch (error: any) {\n    console.error('Rewards GET Error:', error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n\n// POST /api/rewards (새 보상 카드 생성)\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { action, userId, payload } = body;\n\n    if (action === 'generate') {\n      // 사용자 정보 조회\n      const user = await db.getUser(userId);\n      if (!user) {\n        return NextResponse.json(\n          { success: false, error: 'User not found' },\n          { status: 404, headers: corsHeaders }\n        );\n      }\n\n      // AI로 보상 카드 생성\n      const cardContent = await ai.generateRewardCard({\n        role: user.role_id,\n        pain_point: user.pain_point_top1 || 'general',\n        orbit_distance: user.sync_orbit,\n        context_data: payload?.context || {}\n      });\n\n      // DB에 저장\n      const card = await db.createRewardCard({\n        user_id: userId,\n        card_type: user.pain_point_top1 || 'general',\n        title: cardContent.title,\n        icon: cardContent.icon,\n        message: cardContent.message,\n        actions: cardContent.actions,\n        is_read: false,\n        is_acted: false\n      });\n\n      return NextResponse.json({\n        success: true,\n        data: card\n      }, { status: 201, headers: corsHeaders });\n    }\n\n    if (action === 'mark_read') {\n      const { cardId } = payload;\n      \n      const { getSupabaseAdmin } = await import('@/lib/supabase');\n      await getSupabaseAdmin()\n        .from('reward_cards')\n        .update({ is_read: true })\n        .eq('id', cardId);\n\n      return NextResponse.json({\n        success: true,\n        data: { card_id: cardId, is_read: true }\n      }, { status: 200, headers: corsHeaders });\n    }\n\n    if (action === 'mark_acted') {\n      const { cardId, actionType } = payload;\n      \n      const { getSupabaseAdmin } = await import('@/lib/supabase');\n      await getSupabaseAdmin()\n        .from('reward_cards')\n        .update({ is_acted: true })\n        .eq('id', cardId);\n\n      return NextResponse.json({\n        success: true,\n        data: { card_id: cardId, is_acted: true, action_type: actionType }\n      }, { status: 200, headers: corsHeaders });\n    }\n\n    return NextResponse.json(\n      { success: false, error: 'Unknown action' },\n      { status: 400, headers: corsHeaders }\n    );\n\n  } catch (error: any) {\n    console.error('Rewards POST Error:', error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/Users/oseho/Desktop/autus/vercel-api/app/api/rewards/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/rewards/route\",\n        pathname: \"/api/rewards\",\n        filename: \"route\",\n        bundlePath: \"app/api/rewards/route\"\n    },\n    resolvedPagePath: \"/Users/oseho/Desktop/autus/vercel-api/app/api/rewards/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/rewards/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Frewards%2Froute&page=%2Fapi%2Frewards%2Froute&pagePath=private-next-app-dir%2Fapi%2Frewards%2Froute.ts&appDir=%2FUsers%2Foseho%2FDesktop%2Fautus%2Fvercel-api%2Fapp&appPaths=%2Fapi%2Frewards%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/rewards/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map","// ============================================\n// AUTUS Claude AI Integration\n// ============================================\n\nimport Anthropic from '@anthropic-ai/sdk';\nimport { createClient } from '@supabase/supabase-js';\n\n// Lazy initialization to avoid build-time errors\nfunction getAnthropicClient() {\n  if (!process.env.CLAUDE_API_KEY) {\n    throw new Error('CLAUDE_API_KEY environment variable not configured');\n  }\n  return new Anthropic({\n    apiKey: process.env.CLAUDE_API_KEY,\n  });\n}\n\n// Supabase client for metrics logging\nfunction getSupabaseClient() {\n  const url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\n// Prompt Cache 메트릭 로깅\ninterface CacheMetrics {\n  endpoint: string;\n  input_tokens: number;\n  output_tokens: number;\n  cache_creation_input_tokens?: number;\n  cache_read_input_tokens?: number;\n  response_time_ms: number;\n}\n\nasync function logCacheMetrics(metrics: CacheMetrics) {\n  const supabase = getSupabaseClient();\n  if (!supabase) return;\n\n  // Claude API 가격 (2026년 기준 추정)\n  const INPUT_COST_PER_1K = 0.003;  // $0.003 per 1K input tokens\n  const OUTPUT_COST_PER_1K = 0.015; // $0.015 per 1K output tokens\n  const CACHE_WRITE_COST_PER_1K = 0.00375; // $0.00375 per 1K (25% premium)\n  const CACHE_READ_COST_PER_1K = 0.0003;   // $0.0003 per 1K (90% discount)\n\n  const totalTokens = metrics.input_tokens + metrics.output_tokens;\n  const cacheHit = (metrics.cache_read_input_tokens || 0) > 0;\n  \n  // 비용 계산\n  const estimatedCost = \n    (metrics.input_tokens / 1000 * INPUT_COST_PER_1K) +\n    (metrics.output_tokens / 1000 * OUTPUT_COST_PER_1K) +\n    ((metrics.cache_creation_input_tokens || 0) / 1000 * CACHE_WRITE_COST_PER_1K) +\n    ((metrics.cache_read_input_tokens || 0) / 1000 * CACHE_READ_COST_PER_1K);\n\n  // 캐시로 절약한 비용 (캐시 읽기가 있으면 일반 입력 대비 절약)\n  const savings = cacheHit \n    ? (metrics.cache_read_input_tokens || 0) / 1000 * (INPUT_COST_PER_1K - CACHE_READ_COST_PER_1K)\n    : 0;\n\n  try {\n    await supabase.from('prompt_cache_metrics').insert({\n      endpoint: metrics.endpoint,\n      cache_hit: cacheHit,\n      cache_creation_input_tokens: metrics.cache_creation_input_tokens,\n      cache_read_input_tokens: metrics.cache_read_input_tokens,\n      input_tokens: metrics.input_tokens,\n      output_tokens: metrics.output_tokens,\n      total_tokens: totalTokens,\n      estimated_cost_usd: estimatedCost,\n      savings_usd: savings,\n      response_time_ms: metrics.response_time_ms\n    });\n  } catch (e) {\n    console.error('Failed to log cache metrics:', e);\n  }\n}\n\n// Types\nexport interface RewardCardRequest {\n  role: string;\n  pain_point: string;\n  orbit_distance: number;\n  context_data: Record<string, any>;\n}\n\nexport interface RewardCardAction {\n  label: string;\n  type: string;\n  requires_approval: boolean;\n  webhook_payload?: {\n    action_type: string;\n    target?: string;\n    message?: string;\n    template_id?: string;\n    metadata?: Record<string, any>;\n  };\n}\n\nexport interface RewardCardResponse {\n  title: string;\n  icon: string;\n  message: string;\n  actions: RewardCardAction[];\n}\n\nexport interface AnalysisRequest {\n  type: 'churn_risk' | 'cashflow' | 'performance' | 'engagement';\n  data: Record<string, any>;\n}\n\nexport interface AnalysisResponse {\n  summary: string;\n  risk_level: 'low' | 'medium' | 'high';\n  recommendations: string[];\n  predicted_impact: number;\n}\n\n// ============================================\n// AI Functions\n// ============================================\n\nexport const ai = {\n  /**\n   * 보상 카드 메시지 생성\n   */\n  async generateRewardCard(request: RewardCardRequest): Promise<RewardCardResponse> {\n    const startTime = Date.now();\n    \n    const systemPrompt = `너는 AUTUS의 실행형 AI 에이전트야. \n사용자의 역할과 고민에 맞는 '즉시 보상 카드'를 생성하고, 버튼 클릭 시 자동 실행할 수 있는 webhook_payload도 포함해.\n\n규칙:\n1. 숫자나 퍼센트를 직접 노출하지 마\n2. 따뜻하고 격려하는 톤 유지\n3. 즉시 행동할 수 있는 구체적 제안\n4. orbit_distance에 따라 자동화 수준 조절:\n   - 0.2 (가까이): 원클릭 자동 실행 제안\n   - 0.5 (중간): 승인 후 실행 제안\n   - 0.8 (멀리): 정보 제공만\n\n사용 가능한 action_type:\n- send_sms: 문자 발송 (알리고)\n- send_kakao: 카카오 알림톡\n- update_erp: ERP 업데이트\n- issue_reward: 리워드 발급\n- generate_report: 보고서 생성\n- sync_data: 데이터 동기화\n\nJSON 형식으로 응답:\n{\n  \"title\": \"카드 제목\",\n  \"icon\": \"이모지\",\n  \"message\": \"메인 메시지 (1-2문장)\",\n  \"actions\": [\n    {\n      \"label\": \"버튼텍스트\",\n      \"type\": \"action_type\",\n      \"requires_approval\": boolean,\n      \"webhook_payload\": {\n        \"action_type\": \"send_sms|send_kakao|update_erp|...\",\n        \"target\": \"대상 (전화번호, ID 등)\",\n        \"message\": \"실행할 메시지 내용\",\n        \"template_id\": \"템플릿 ID (선택)\",\n        \"metadata\": {}\n      }\n    }\n  ]\n}`;\n\n    const userPrompt = `역할: ${request.role}\n주요 고민: ${request.pain_point}\n자동화 거리: ${request.orbit_distance}\n컨텍스트 데이터: ${JSON.stringify(request.context_data)}\n\n이 사용자를 위한 보상 카드를 생성해.`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 500,\n      messages: [\n        { role: 'user', content: userPrompt }\n      ],\n      system: systemPrompt,\n    });\n\n    // Prompt Cache 메트릭 로깅\n    const responseTime = Date.now() - startTime;\n    logCacheMetrics({\n      endpoint: '/api/brain/generateRewardCard',\n      input_tokens: response.usage?.input_tokens || 0,\n      output_tokens: response.usage?.output_tokens || 0,\n      cache_creation_input_tokens: (response.usage as any)?.cache_creation_input_tokens,\n      cache_read_input_tokens: (response.usage as any)?.cache_read_input_tokens,\n      response_time_ms: responseTime\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      // JSON 파싱\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    // Fallback\n    return {\n      title: '오늘의 제안',\n      icon: '✨',\n      message: '새로운 기회가 준비되어 있습니다.',\n      actions: [{ label: '확인하기', type: 'view', requires_approval: false }]\n    };\n  },\n\n  /**\n   * 데이터 분석\n   */\n  async analyzeData(request: AnalysisRequest): Promise<AnalysisResponse> {\n    const startTime = Date.now();\n    \n    const typePrompts: Record<string, string> = {\n      churn_risk: '퇴원/이탈 위험 분석',\n      cashflow: '현금흐름 및 미납 분석',\n      performance: '성과 및 생산성 분석',\n      engagement: '참여도 및 만족도 분석'\n    };\n\n    const systemPrompt = `너는 AUTUS의 데이터 분석 AI야.\n${typePrompts[request.type]}을 수행하고 결과를 JSON으로 반환해.\n\n응답 형식:\n{\n  \"summary\": \"1문장 요약\",\n  \"risk_level\": \"low|medium|high\",\n  \"recommendations\": [\"추천1\", \"추천2\", \"추천3\"],\n  \"predicted_impact\": 0.0~1.0 사이 영향도\n}\n\n규칙:\n1. 구체적이고 실행 가능한 추천\n2. 숫자는 내부 분석용으로만 사용\n3. 사용자 친화적 요약 제공`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 800,\n      messages: [\n        { role: 'user', content: `분석 대상 데이터:\\n${JSON.stringify(request.data, null, 2)}` }\n      ],\n      system: systemPrompt,\n    });\n\n    // Prompt Cache 메트릭 로깅\n    const responseTime = Date.now() - startTime;\n    logCacheMetrics({\n      endpoint: `/api/brain/analyzeData/${request.type}`,\n      input_tokens: response.usage?.input_tokens || 0,\n      output_tokens: response.usage?.output_tokens || 0,\n      cache_creation_input_tokens: (response.usage as any)?.cache_creation_input_tokens,\n      cache_read_input_tokens: (response.usage as any)?.cache_read_input_tokens,\n      response_time_ms: responseTime\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    return {\n      summary: '분석이 완료되었습니다.',\n      risk_level: 'medium',\n      recommendations: ['데이터를 더 수집해 주세요.'],\n      predicted_impact: 0.5\n    };\n  },\n\n  /**\n   * 자연어 업무 → 3지 선택 생성\n   */\n  async generateThreeOptions(taskDescription: string): Promise<{\n    a: string;\n    b: string;\n    c: string;\n    meta: { a_time: string; b_time: string; c_time: string };\n  }> {\n    const systemPrompt = `사용자가 요청한 업무에 대해 정확히 3가지 선택지를 생성해.\n\n규칙:\n1) A: 가장 빠르고 간단한 방법 (T 최소화)\n2) B: 표준적이고 균형 잡힌 방법 (T 중간, s 중간)\n3) C: 장기적으로 가장 가치가 쌓이는 방법 (s 최대화)\n\n제약:\n- 각 옵션은 1문장\n- 시간은 \"짧게/보통/길게\" 범주만\n- 숫자/퍼센트 금지\n\nJSON 형식:\n{\n  \"a\": \"옵션 A 설명\",\n  \"b\": \"옵션 B 설명\", \n  \"c\": \"옵션 C 설명\",\n  \"meta\": {\"a_time\": \"짧게\", \"b_time\": \"보통\", \"c_time\": \"길게\"}\n}`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 500,\n      messages: [\n        { role: 'user', content: `업무: ${taskDescription}` }\n      ],\n      system: systemPrompt,\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    return {\n      a: '기존 방식으로 빠르게 처리',\n      b: '표준 프로세스를 따라 진행',\n      c: '자동화 시스템 구축 후 반복 활용',\n      meta: { a_time: '짧게', b_time: '보통', c_time: '길게' }\n    };\n  },\n\n  /**\n   * 일일 카페 콘텐츠 생성\n   */\n  async generateDailyContent(data: {\n    type: 'cafe_post' | 'comment' | 'dm';\n    topic?: string;\n    context?: string;\n  }): Promise<{ title?: string; content: string }> {\n    const startTime = Date.now();\n\n    const topics = ['퇴원 관리', '미수금 회수', '학부모 상담', '마케팅 노하우', '강사 관리'];\n    const randomTopic = data.topic || topics[Math.floor(Math.random() * topics.length)];\n\n    const prompts: Record<string, string> = {\n      cafe_post: `학원 원장 커뮤니티(학원노)에 올릴 가치 제공형 글을 작성해줘.\n\n주제: ${randomTopic}\n${data.context ? `추가 컨텍스트: ${data.context}` : ''}\n\n규칙:\n1. 제목 포함 ([제목] 형식)\n2. 따뜻하고 공감하는 톤\n3. 구체적인 숫자나 사례 1-2개 포함\n4. 300-500자 내외\n5. 마지막에 댓글 유도 문구\n6. 홍보성 절대 금지 - 순수 노하우 공유만\n7. 이모지 적절히 사용\n\nJSON 형식으로 응답:\n{\"title\": \"제목\", \"content\": \"본문 내용\"}`,\n      \n      comment: `학원 원장이 쓴 고민 글에 달 공감 댓글을 작성해줘.\n\n주제: ${randomTopic}\n${data.context ? `원글 내용: ${data.context}` : ''}\n\n규칙:\n1. 2-3문장으로 짧게\n2. 진심 어린 공감\n3. 구체적인 조언 1개\n4. 홍보 절대 금지\n\nJSON 형식으로 응답:\n{\"content\": \"댓글 내용\"}`,\n\n      dm: `학원 원장에게 보낼 첫 DM을 작성해줘.\n\n상황: 퇴원/미수금 고민 글을 쓴 원장님에게 연락\n${data.context ? `추가 정보: ${data.context}` : ''}\n\n규칙:\n1. 자연스럽고 부담 없는 톤\n2. 무료 파일럿 언급 (효과 없으면 0원)\n3. 통화 제안으로 마무리\n4. 100자 내외\n\nJSON 형식으로 응답:\n{\"content\": \"DM 내용\"}`\n    };\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 800,\n      messages: [\n        { role: 'user', content: prompts[data.type] || prompts.cafe_post }\n      ],\n      system: '너는 학원 운영 전문가야. 학원 원장 커뮤니티에서 신뢰받는 조언을 제공해.'\n    });\n\n    const responseTime = Date.now() - startTime;\n    logCacheMetrics({\n      endpoint: '/api/brain/generateDailyContent',\n      input_tokens: response.usage?.input_tokens || 0,\n      output_tokens: response.usage?.output_tokens || 0,\n      cache_creation_input_tokens: (response.usage as any)?.cache_creation_input_tokens,\n      cache_read_input_tokens: (response.usage as any)?.cache_read_input_tokens,\n      response_time_ms: responseTime\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    return { content: text };\n  },\n\n  /**\n   * 학부모 상담 일지 자동 생성\n   */\n  async generateConsultReport(data: {\n    studentName: string;\n    subject: string;\n    attendance: number;\n    performance: string;\n    notes: string;\n  }): Promise<string> {\n    const systemPrompt = `학부모 상담 일지 초안을 작성해.\n톤: 따뜻하고 전문적\n길이: 3-4문단\n포함: 학생 강점, 개선점, 다음 목표`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 600,\n      messages: [\n        { role: 'user', content: `학생: ${data.studentName}\n과목: ${data.subject}\n출석률: ${data.attendance}%\n성취도: ${data.performance}\n메모: ${data.notes}` }\n      ],\n      system: systemPrompt,\n    });\n\n    return response.content[0].type === 'text' ? response.content[0].text : '';\n  }\n};\n","// ============================================\n// AUTUS Supabase Client\n// ============================================\n\nimport { createClient } from '@supabase/supabase-js';\n\n// Types\nexport interface User {\n  id: string;\n  email: string;\n  role_id: 'owner' | 'director' | 'teacher' | 'staff' | 'parent' | 'student';\n  affiliation_map: Record<string, string>;\n  base_capacity: number;\n  pain_point_top1: string | null;\n  sync_orbit: number;\n  current_energy: number;\n}\n\nexport interface Organism {\n  id: string;\n  user_id: string;\n  name: string;\n  type: 'teacher' | 'student' | 'parent' | 'branch' | 'class';\n  emoji: string;\n  mint: number;\n  tax: number;\n  synergy: number;\n  value_v: number;\n  entropy: number;\n  velocity: number;\n  friction: number;\n  sync_rate: number;\n  status: 'urgent' | 'warning' | 'stable' | 'opportunity';\n  urgency: number;\n}\n\nexport interface UsageLog {\n  id: string;\n  task_id: string;\n  solution_id: string;\n  user_id: string;\n  before_m: number;\n  before_t: number;\n  before_s: number;\n  after_m: number;\n  after_t: number;\n  after_s: number;\n  effectiveness_score: number;\n  v_growth: number;\n  duration_minutes: number;\n}\n\nexport interface RewardCard {\n  id: string;\n  user_id: string;\n  card_type: string;\n  title: string;\n  icon: string;\n  message: string;\n  actions: { label: string; type: string; requires_approval: boolean }[];\n  is_read: boolean;\n  is_acted: boolean;\n}\n\n// Lazy initialization to avoid build-time errors\nlet _supabaseAdmin: ReturnType<typeof createClient> | null = null;\nlet _supabaseClient: ReturnType<typeof createClient> | null = null;\n\n// Client (Server-side with service role)\nexport const supabaseAdmin = (() => {\n  if (!_supabaseAdmin && process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    _supabaseAdmin = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL,\n      process.env.SUPABASE_SERVICE_ROLE_KEY,\n      {\n        auth: {\n          autoRefreshToken: false,\n          persistSession: false\n        }\n      }\n    );\n  }\n  return _supabaseAdmin;\n})();\n\n// Client (Client-side with anon key)\nexport const supabaseClient = (() => {\n  if (!_supabaseClient && process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {\n    _supabaseClient = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n    );\n  }\n  return _supabaseClient;\n})();\n\n// Helper to get admin client (throws at runtime if not configured)\nexport function getSupabaseAdmin() {\n  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    throw new Error('Supabase environment variables not configured');\n  }\n  return createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL,\n    process.env.SUPABASE_SERVICE_ROLE_KEY,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  );\n}\n\n// ============================================\n// Database Functions\n// ============================================\n\nexport const db = {\n  // Users\n  async getUser(userId: string): Promise<User | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('users')\n      .select('*')\n      .eq('id', userId)\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async updateUserKernel(userId: string, updates: Partial<User>): Promise<boolean> {\n    const client = getSupabaseAdmin();\n    const { error } = await client\n      .from('users')\n      .update(updates)\n      .eq('id', userId);\n    \n    return !error;\n  },\n\n  // Organisms\n  async getOrganisms(userId: string): Promise<Organism[]> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('organisms')\n      .select('*')\n      .eq('user_id', userId)\n      .order('urgency', { ascending: false });\n    \n    if (error) return [];\n    return data;\n  },\n\n  async getOrganism(organismId: string): Promise<Organism | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('organisms')\n      .select('*')\n      .eq('id', organismId)\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async updateOrganism(organismId: string, updates: Partial<Organism>): Promise<boolean> {\n    const client = getSupabaseAdmin();\n    const { error } = await client\n      .from('organisms')\n      .update(updates)\n      .eq('id', organismId);\n    \n    return !error;\n  },\n\n  // Usage Logs\n  async createUsageLog(log: Omit<UsageLog, 'id'>): Promise<UsageLog | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('usage_logs')\n      .insert(log)\n      .select()\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async getSolutionRanking(taskId?: string) {\n    const client = getSupabaseAdmin();\n    let query = client\n      .from('solution_ranking')\n      .select('*');\n    \n    if (taskId) {\n      query = query.eq('task_id', taskId);\n    }\n    \n    const { data, error } = await query.order('avg_score', { ascending: false });\n    \n    if (error) return [];\n    return data;\n  },\n\n  // Reward Cards\n  async createRewardCard(card: Omit<RewardCard, 'id'>): Promise<RewardCard | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('reward_cards')\n      .insert(card)\n      .select()\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async getUnreadRewards(userId: string): Promise<RewardCard[]> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('reward_cards')\n      .select('*')\n      .eq('user_id', userId)\n      .eq('is_read', false)\n      .order('created_at', { ascending: false });\n    \n    if (error) return [];\n    return data;\n  },\n\n  // V Leaderboard\n  async getLeaderboard(limit = 10) {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('v_leaderboard')\n      .select('*')\n      .order('rank', { ascending: true })\n      .limit(limit);\n    \n    if (error) return [];\n    return data;\n  },\n\n  // Standards\n  async getStandard(taskId: string) {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('standards')\n      .select('*, solutions(*)')\n      .eq('task_id', taskId)\n      .single();\n    \n    if (error) return null;\n    return data;\n  }\n};\n"],"names":["module","exports","require","runtime","corsHeaders","OPTIONS","NextResponse","status","headers","GET","request","searchParams","URL","url","userId","get","json","success","error","unread","db","getUnreadRewards","data","unread_count","length","cards","console","message","POST","action","payload","user","getUser","cardContent","ai","generateRewardCard","role","role_id","pain_point","pain_point_top1","orbit_distance","sync_orbit","context_data","context","card","createRewardCard","user_id","card_type","title","icon","actions","is_read","is_acted","cardId","getSupabaseAdmin","Promise","resolve","then","__webpack_require__","bind","from","update","eq","card_id","actionType","action_type","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Frewards_2Froute_ts_page_2Fapi_2Frewards_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGcmV3YXJkcyUyRnJvdXRlJnBhZ2U9JTJGYXBpJTJGcmV3YXJkcyUyRnJvdXRlJnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGcmV3YXJkcyUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRm9zZWhvJTJGRGVza3RvcCUyRmF1dHVzJTJGdmVyY2VsLWFwaSUyRmFwcCZhcHBQYXRocz0lMkZhcGklMkZyZXdhcmRzJTJGcm91dGUmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZiYXNlUGF0aD0mYXNzZXRQcmVmaXg9Jm5leHRDb25maWdPdXRwdXQ9JnByZWZlcnJlZFJlZ2lvbj0mbWlkZGxld2FyZUNvbmZpZz1lMzAlM0Qh_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap","getAnthropicClient","process","env","CLAUDE_API_KEY","Anthropic","apiKey","logCacheMetrics","metrics","supabase","getSupabaseClient","SUPABASE_URL","key","SUPABASE_SERVICE_ROLE_KEY","createClient","totalTokens","input_tokens","output_tokens","cacheHit","cache_read_input_tokens","estimatedCost","cache_creation_input_tokens","savings","INPUT_COST_PER_1K","insert","endpoint","cache_hit","total_tokens","estimated_cost_usd","savings_usd","response_time_ms","e","startTime","Date","now","systemPrompt","userPrompt","JSON","stringify","response","messages","create","model","max_tokens","content","system","responseTime","usage","text","type","jsonMatch","match","parse","label","requires_approval","analyzeData","typePrompts","churn_risk","cashflow","performance","engagement","summary","risk_level","recommendations","predicted_impact","generateThreeOptions","taskDescription","b","c","meta","a_time","b_time","c_time","generateDailyContent","topics","randomTopic","topic","Math","floor","random","prompts","cafe_post","comment","dm","generateConsultReport","studentName","subject","attendance","notes","_supabaseClient","auth","autoRefreshToken","persistSession","client","select","single","updateUserKernel","updates","getOrganisms","order","ascending","getOrganism","organismId","updateOrganism","createUsageLog","log","getSolutionRanking","taskId","query","getLeaderboard","limit","getStandard"],"sourceRoot":""}