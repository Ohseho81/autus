"use strict";(()=>{var e={};e.id=125,e.ids=[125],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},3797:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>B,patchFetch:()=>k,requestAsyncStorage:()=>R,routeModule:()=>E,serverHooks:()=>C,staticGenerationAsyncStorage:()=>D});var r={};i.r(r),i.d(r,{GET:()=>w,POST:()=>v});var n=i(9303),o=i(8716),s=i(670),a=i(7070),l=i(7857);class u extends Error{constructor(e,t,i,...r){for(let n of(Array.isArray(t)&&(t=t.join(" ").trim()),super(t),void 0!==Error.captureStackTrace&&Error.captureStackTrace(this,u),this.code=e,r))for(let e in n){let t=n[e];this[e]=Buffer.isBuffer(t)?t.toString(i.encoding):null==t?t:JSON.parse(JSON.stringify(t))}}}let f=function(e){let t=[];for(let i=0,r=e.length;i<r;i++){let r=e[i];if(null==r||!1===r)t[i]={disabled:!0};else if("string"==typeof r)t[i]={name:r};else{if("object"!=typeof r||null===r||Array.isArray(r))throw new u("CSV_INVALID_COLUMN_DEFINITION",["Invalid column definition:","expect a string or a literal object,",`got ${JSON.stringify(r)} at position ${i}`]);if("string"!=typeof r.name)throw new u("CSV_OPTION_COLUMNS_MISSING_NAME",["Option columns missing name:",`property "name" is required at position ${i}`,"when column is an object literal"]);t[i]=r}}return t};class _{constructor(e=100){this.size=e,this.length=0,this.buf=Buffer.allocUnsafe(e)}prepend(e){if(Buffer.isBuffer(e)){let t=this.length+e.length;if(t>=this.size&&(this.resize(),t>=this.size))throw Error("INVALID_BUFFER_STATE");let i=this.buf;this.buf=Buffer.allocUnsafe(this.size),e.copy(this.buf,0),i.copy(this.buf,e.length),this.length+=e.length}else{let t=this.length++;t===this.size&&this.resize();let i=this.clone();this.buf[0]=e,i.copy(this.buf,1,0,t)}}append(e){let t=this.length++;t===this.size&&this.resize(),this.buf[t]=e}clone(){return Buffer.from(this.buf.slice(0,this.length))}resize(){let e=this.length;this.size=2*this.size;let t=Buffer.allocUnsafe(this.size);this.buf.copy(t,0,0,e),this.buf=t}toString(e){return e?this.buf.slice(0,this.length).toString(e):Uint8Array.prototype.slice.call(this.buf.slice(0,this.length))}toJSON(){return this.toString("utf8")}reset(){this.length=0}}let d=function(e){let t={};for(let i in e)t[i.replace(/([A-Z])/g,function(e,t){return"_"+t.toLowerCase()})]=e[i];if(void 0===t.encoding||!0===t.encoding)t.encoding="utf8";else if(null===t.encoding||!1===t.encoding)t.encoding=null;else if("string"!=typeof t.encoding&&null!==t.encoding)throw new u("CSV_INVALID_OPTION_ENCODING",["Invalid option encoding:","encoding must be a string or null to return a buffer,",`got ${JSON.stringify(t.encoding)}`],t);if(void 0===t.bom||null===t.bom||!1===t.bom)t.bom=!1;else if(!0!==t.bom)throw new u("CSV_INVALID_OPTION_BOM",["Invalid option bom:","bom must be true,",`got ${JSON.stringify(t.bom)}`],t);if(t.cast_function=null,void 0===t.cast||null===t.cast||!1===t.cast||""===t.cast)t.cast=void 0;else if("function"==typeof t.cast)t.cast_function=t.cast,t.cast=!0;else if(!0!==t.cast)throw new u("CSV_INVALID_OPTION_CAST",["Invalid option cast:","cast must be true or a function,",`got ${JSON.stringify(t.cast)}`],t);if(void 0===t.cast_date||null===t.cast_date||!1===t.cast_date||""===t.cast_date)t.cast_date=!1;else if(!0===t.cast_date)t.cast_date=function(e){let t=Date.parse(e);return isNaN(t)?e:new Date(t)};else if("function"!=typeof t.cast_date)throw new u("CSV_INVALID_OPTION_CAST_DATE",["Invalid option cast_date:","cast_date must be true or a function,",`got ${JSON.stringify(t.cast_date)}`],t);if(t.cast_first_line_to_header=void 0,!0===t.columns)t.cast_first_line_to_header=void 0;else if("function"==typeof t.columns)t.cast_first_line_to_header=t.columns,t.columns=!0;else if(Array.isArray(t.columns))t.columns=f(t.columns);else if(void 0===t.columns||null===t.columns||!1===t.columns)t.columns=!1;else throw new u("CSV_INVALID_OPTION_COLUMNS",["Invalid option columns:","expect an array, a function or true,",`got ${JSON.stringify(t.columns)}`],t);if(void 0===t.group_columns_by_name||null===t.group_columns_by_name||!1===t.group_columns_by_name)t.group_columns_by_name=!1;else if(!0!==t.group_columns_by_name)throw new u("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","expect an boolean,",`got ${JSON.stringify(t.group_columns_by_name)}`],t);else if(!1===t.columns)throw new u("CSV_INVALID_OPTION_GROUP_COLUMNS_BY_NAME",["Invalid option group_columns_by_name:","the `columns` mode must be activated."],t);if(void 0===t.comment||null===t.comment||!1===t.comment||""===t.comment)t.comment=null;else if("string"==typeof t.comment&&(t.comment=Buffer.from(t.comment,t.encoding)),!Buffer.isBuffer(t.comment))throw new u("CSV_INVALID_OPTION_COMMENT",["Invalid option comment:","comment must be a buffer or a string,",`got ${JSON.stringify(t.comment)}`],t);if(void 0===t.comment_no_infix||null===t.comment_no_infix||!1===t.comment_no_infix)t.comment_no_infix=!1;else if(!0!==t.comment_no_infix)throw new u("CSV_INVALID_OPTION_COMMENT",["Invalid option comment_no_infix:","value must be a boolean,",`got ${JSON.stringify(t.comment_no_infix)}`],t);let i=JSON.stringify(t.delimiter);if(Array.isArray(t.delimiter)||(t.delimiter=[t.delimiter]),0===t.delimiter.length)throw new u("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${i}`],t);if(t.delimiter=t.delimiter.map(function(e){if(null==e||!1===e)return Buffer.from(",",t.encoding);if("string"==typeof e&&(e=Buffer.from(e,t.encoding)),!Buffer.isBuffer(e)||0===e.length)throw new u("CSV_INVALID_OPTION_DELIMITER",["Invalid option delimiter:","delimiter must be a non empty string or buffer or array of string|buffer,",`got ${i}`],t);return e}),void 0===t.escape||!0===t.escape?t.escape=Buffer.from('"',t.encoding):"string"==typeof t.escape?t.escape=Buffer.from(t.escape,t.encoding):(null===t.escape||!1===t.escape)&&(t.escape=null),null!==t.escape&&!Buffer.isBuffer(t.escape))throw Error(`Invalid Option: escape must be a buffer, a string or a boolean, got ${JSON.stringify(t.escape)}`);if(void 0===t.from||null===t.from)t.from=1;else if("string"==typeof t.from&&/\d+/.test(t.from)&&(t.from=parseInt(t.from)),Number.isInteger(t.from)){if(t.from<0)throw Error(`Invalid Option: from must be a positive integer, got ${JSON.stringify(e.from)}`)}else throw Error(`Invalid Option: from must be an integer, got ${JSON.stringify(t.from)}`);if(void 0===t.from_line||null===t.from_line)t.from_line=1;else if("string"==typeof t.from_line&&/\d+/.test(t.from_line)&&(t.from_line=parseInt(t.from_line)),Number.isInteger(t.from_line)){if(t.from_line<=0)throw Error(`Invalid Option: from_line must be a positive integer greater than 0, got ${JSON.stringify(e.from_line)}`)}else throw Error(`Invalid Option: from_line must be an integer, got ${JSON.stringify(e.from_line)}`);if(void 0===t.ignore_last_delimiters||null===t.ignore_last_delimiters)t.ignore_last_delimiters=!1;else if("number"==typeof t.ignore_last_delimiters)t.ignore_last_delimiters=Math.floor(t.ignore_last_delimiters),0===t.ignore_last_delimiters&&(t.ignore_last_delimiters=!1);else if("boolean"!=typeof t.ignore_last_delimiters)throw new u("CSV_INVALID_OPTION_IGNORE_LAST_DELIMITERS",["Invalid option `ignore_last_delimiters`:","the value must be a boolean value or an integer,",`got ${JSON.stringify(t.ignore_last_delimiters)}`],t);if(!0===t.ignore_last_delimiters&&!1===t.columns)throw new u("CSV_IGNORE_LAST_DELIMITERS_REQUIRES_COLUMNS",["The option `ignore_last_delimiters`","requires the activation of the `columns` option"],t);if(void 0===t.info||null===t.info||!1===t.info)t.info=!1;else if(!0!==t.info)throw Error(`Invalid Option: info must be true, got ${JSON.stringify(t.info)}`);if(void 0===t.max_record_size||null===t.max_record_size||!1===t.max_record_size)t.max_record_size=0;else if(Number.isInteger(t.max_record_size)&&t.max_record_size>=0);else if("string"==typeof t.max_record_size&&/\d+/.test(t.max_record_size))t.max_record_size=parseInt(t.max_record_size);else throw Error(`Invalid Option: max_record_size must be a positive integer, got ${JSON.stringify(t.max_record_size)}`);if(void 0===t.objname||null===t.objname||!1===t.objname)t.objname=void 0;else if(Buffer.isBuffer(t.objname)){if(0===t.objname.length)throw Error("Invalid Option: objname must be a non empty buffer");null===t.encoding||(t.objname=t.objname.toString(t.encoding))}else if("string"==typeof t.objname){if(0===t.objname.length)throw Error("Invalid Option: objname must be a non empty string")}else if("number"==typeof t.objname);else throw Error(`Invalid Option: objname must be a string or a buffer, got ${t.objname}`);if(void 0!==t.objname){if("number"==typeof t.objname){if(!1!==t.columns)throw Error("Invalid Option: objname index cannot be combined with columns or be defined as a field")}else if(!1===t.columns)throw Error("Invalid Option: objname field must be combined with columns or be defined as an index")}if(void 0===t.on_record||null===t.on_record)t.on_record=void 0;else if("function"!=typeof t.on_record)throw new u("CSV_INVALID_OPTION_ON_RECORD",["Invalid option `on_record`:","expect a function,",`got ${JSON.stringify(t.on_record)}`],t);if(void 0!==t.on_skip&&null!==t.on_skip&&"function"!=typeof t.on_skip)throw Error(`Invalid Option: on_skip must be a function, got ${JSON.stringify(t.on_skip)}`);if(null===t.quote||!1===t.quote||""===t.quote)t.quote=null;else if(void 0===t.quote||!0===t.quote?t.quote=Buffer.from('"',t.encoding):"string"==typeof t.quote&&(t.quote=Buffer.from(t.quote,t.encoding)),!Buffer.isBuffer(t.quote))throw Error(`Invalid Option: quote must be a buffer or a string, got ${JSON.stringify(t.quote)}`);if(void 0===t.raw||null===t.raw||!1===t.raw)t.raw=!1;else if(!0!==t.raw)throw Error(`Invalid Option: raw must be true, got ${JSON.stringify(t.raw)}`);if(void 0===t.record_delimiter)t.record_delimiter=[];else if("string"==typeof t.record_delimiter||Buffer.isBuffer(t.record_delimiter)){if(0===t.record_delimiter.length)throw new u("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);t.record_delimiter=[t.record_delimiter]}else if(!Array.isArray(t.record_delimiter))throw new u("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer,",`got ${JSON.stringify(t.record_delimiter)}`],t);if(t.record_delimiter=t.record_delimiter.map(function(e,i){if("string"==typeof e||Buffer.isBuffer(e)){if(0===e.length)throw new u("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a non empty string or buffer",`at index ${i},`,`got ${JSON.stringify(e)}`],t)}else throw new u("CSV_INVALID_OPTION_RECORD_DELIMITER",["Invalid option `record_delimiter`:","value must be a string, a buffer or array of string|buffer",`at index ${i},`,`got ${JSON.stringify(e)}`],t);return"string"==typeof e&&(e=Buffer.from(e,t.encoding)),e}),"boolean"==typeof t.relax_column_count);else if(void 0===t.relax_column_count||null===t.relax_column_count)t.relax_column_count=!1;else throw Error(`Invalid Option: relax_column_count must be a boolean, got ${JSON.stringify(t.relax_column_count)}`);if("boolean"==typeof t.relax_column_count_less);else if(void 0===t.relax_column_count_less||null===t.relax_column_count_less)t.relax_column_count_less=!1;else throw Error(`Invalid Option: relax_column_count_less must be a boolean, got ${JSON.stringify(t.relax_column_count_less)}`);if("boolean"==typeof t.relax_column_count_more);else if(void 0===t.relax_column_count_more||null===t.relax_column_count_more)t.relax_column_count_more=!1;else throw Error(`Invalid Option: relax_column_count_more must be a boolean, got ${JSON.stringify(t.relax_column_count_more)}`);if("boolean"==typeof t.relax_quotes);else if(void 0===t.relax_quotes||null===t.relax_quotes)t.relax_quotes=!1;else throw Error(`Invalid Option: relax_quotes must be a boolean, got ${JSON.stringify(t.relax_quotes)}`);if("boolean"==typeof t.skip_empty_lines);else if(void 0===t.skip_empty_lines||null===t.skip_empty_lines)t.skip_empty_lines=!1;else throw Error(`Invalid Option: skip_empty_lines must be a boolean, got ${JSON.stringify(t.skip_empty_lines)}`);if("boolean"==typeof t.skip_records_with_empty_values);else if(void 0===t.skip_records_with_empty_values||null===t.skip_records_with_empty_values)t.skip_records_with_empty_values=!1;else throw Error(`Invalid Option: skip_records_with_empty_values must be a boolean, got ${JSON.stringify(t.skip_records_with_empty_values)}`);if("boolean"==typeof t.skip_records_with_error);else if(void 0===t.skip_records_with_error||null===t.skip_records_with_error)t.skip_records_with_error=!1;else throw Error(`Invalid Option: skip_records_with_error must be a boolean, got ${JSON.stringify(t.skip_records_with_error)}`);if(void 0===t.rtrim||null===t.rtrim||!1===t.rtrim)t.rtrim=!1;else if(!0!==t.rtrim)throw Error(`Invalid Option: rtrim must be a boolean, got ${JSON.stringify(t.rtrim)}`);if(void 0===t.ltrim||null===t.ltrim||!1===t.ltrim)t.ltrim=!1;else if(!0!==t.ltrim)throw Error(`Invalid Option: ltrim must be a boolean, got ${JSON.stringify(t.ltrim)}`);if(void 0===t.trim||null===t.trim||!1===t.trim)t.trim=!1;else if(!0!==t.trim)throw Error(`Invalid Option: trim must be a boolean, got ${JSON.stringify(t.trim)}`);if(!0===t.trim&&!1!==e.ltrim?t.ltrim=!0:!0!==t.ltrim&&(t.ltrim=!1),!0===t.trim&&!1!==e.rtrim?t.rtrim=!0:!0!==t.rtrim&&(t.rtrim=!1),void 0===t.to||null===t.to)t.to=-1;else if(-1!==t.to){if("string"==typeof t.to&&/\d+/.test(t.to)&&(t.to=parseInt(t.to)),Number.isInteger(t.to)){if(t.to<=0)throw Error(`Invalid Option: to must be a positive integer greater than 0, got ${JSON.stringify(e.to)}`)}else throw Error(`Invalid Option: to must be an integer, got ${JSON.stringify(e.to)}`)}if(void 0===t.to_line||null===t.to_line)t.to_line=-1;else if(-1!==t.to_line){if("string"==typeof t.to_line&&/\d+/.test(t.to_line)&&(t.to_line=parseInt(t.to_line)),Number.isInteger(t.to_line)){if(t.to_line<=0)throw Error(`Invalid Option: to_line must be a positive integer greater than 0, got ${JSON.stringify(e.to_line)}`)}else throw Error(`Invalid Option: to_line must be an integer, got ${JSON.stringify(e.to_line)}`)}return t},c=function(e){return e.every(e=>null==e||e.toString&&""===e.toString().trim())},m={utf8:Buffer.from([239,187,191]),utf16le:Buffer.from([255,254])},h=function(e={}){let t=d(e);return{info:{bytes:0,comment_lines:0,empty_lines:0,invalid_field_length:0,lines:1,records:0},original_options:e,options:t,state:{bomSkipped:!1,bufBytesStart:0,castField:t.cast_function,commenting:!1,error:void 0,enabled:1===t.from_line,escaping:!1,escapeIsQuote:Buffer.isBuffer(t.escape)&&Buffer.isBuffer(t.quote)&&0===Buffer.compare(t.escape,t.quote),expectedRecordLength:Array.isArray(t.columns)?t.columns.length:void 0,field:new _(20),firstLineToHeaders:t.cast_first_line_to_header,needMoreDataSize:Math.max(null!==t.comment?t.comment.length:0,...t.delimiter.map(e=>e.length),null!==t.quote?t.quote.length:0),previousBuf:void 0,quoting:!1,stop:!1,rawBuffer:new _(100),record:[],recordHasError:!1,record_length:0,recordDelimiterMaxLength:0===t.record_delimiter.length?0:Math.max(...t.record_delimiter.map(e=>e.length)),trimChars:[Buffer.from(" ",t.encoding)[0],Buffer.from("	",t.encoding)[0]],wasQuoting:!1,wasRowDelimiter:!1,timchars:[Buffer.from(Buffer.from([13],"utf8").toString(),t.encoding),Buffer.from(Buffer.from([10],"utf8").toString(),t.encoding),Buffer.from(Buffer.from([12],"utf8").toString(),t.encoding),Buffer.from(Buffer.from([32],"utf8").toString(),t.encoding),Buffer.from(Buffer.from([9],"utf8").toString(),t.encoding)]},__needMoreData:function(e,t,i){if(i)return!1;let{encoding:r,escape:n,quote:o}=this.options,{quoting:s,needMoreDataSize:a,recordDelimiterMaxLength:l}=this.state;return t-e-1<Math.max(a,0===l?Buffer.from("\r\n",r).length:l,s?(null===n?0:n.length)+o.length:0,s?o.length+l:0)},parse:function(e,t,i,r){let n,o;let{bom:s,comment_no_infix:a,encoding:l,from_line:f,ltrim:_,max_record_size:c,raw:h,relax_quotes:p,rtrim:g,skip_empty_lines:y,to:b,to_line:v}=this.options,{comment:w,escape:I,quote:S,record_delimiter:N}=this.options,{bomSkipped:O,previousBuf:x,rawBuffer:E,escapeIsQuote:R}=this.state;if(void 0===x){if(void 0===e){r();return}n=e}else n=void 0!==x&&void 0===e?x:Buffer.concat([x,e]);if(!1===O){if(!1===s)this.state.bomSkipped=!0;else if(n.length<3){if(!1===t){this.state.previousBuf=n;return}}else{for(let e in m)if(0===m[e].compare(n,0,m[e].length)){let t=m[e].length;this.state.bufBytesStart+=t,n=n.slice(t);let i=d({...this.original_options,encoding:e});for(let e in i)this.options[e]=i[e];({comment:w,escape:I,quote:S}=this.options);break}this.state.bomSkipped=!0}}let D=n.length;for(o=0;o<D&&!this.__needMoreData(o,D,t);o++){if(!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1),-1!==v&&this.info.lines>v){this.state.stop=!0,r();return}!1===this.state.quoting&&0===N.length&&this.__autoDiscoverRecordDelimiter(n,o)&&(N=this.options.record_delimiter);let e=n[o];if(!0===h&&E.append(e),(13===e||10===e)&&!1===this.state.wasRowDelimiter&&(this.state.wasRowDelimiter=!0),!0===this.state.escaping)this.state.escaping=!1;else{if(null!==I&&!0===this.state.quoting&&this.__isEscape(n,o,e)&&o+I.length<D){if(R){if(this.__isQuote(n,o+I.length)){this.state.escaping=!0,o+=I.length-1;continue}}else{this.state.escaping=!0,o+=I.length-1;continue}}if(!1===this.state.commenting&&this.__isQuote(n,o)){if(!0===this.state.quoting){let t=n[o+S.length],i=g&&this.__isCharTrimable(n,o+S.length),r=null!==w&&this.__compareBytes(w,n,o+S.length,t),s=this.__isDelimiter(n,o+S.length,t),a=0===N.length?this.__autoDiscoverRecordDelimiter(n,o+S.length):this.__isRecordDelimiter(t,n,o+S.length);if(null!==I&&this.__isEscape(n,o,e)&&this.__isQuote(n,o+I.length))o+=I.length-1;else if(!t||s||a||r||i){this.state.quoting=!1,this.state.wasQuoting=!0,o+=S.length-1;continue}else if(!1===p){let e=this.__error(new u("CSV_INVALID_CLOSING_QUOTE",["Invalid Closing Quote:",`got "${String.fromCharCode(t)}"`,`at line ${this.info.lines}`,"instead of delimiter, record delimiter, trimable character","(if activated) or comment"],this.options,this.__infoField()));if(void 0!==e)return e}else this.state.quoting=!1,this.state.wasQuoting=!0,this.state.field.prepend(S),o+=S.length-1}else if(0!==this.state.field.length){if(!1===p){let e=this.__infoField(),t=Object.keys(m).map(e=>!!m[e].equals(this.state.field.toString())&&e).filter(Boolean)[0],i=this.__error(new u("INVALID_OPENING_QUOTE",["Invalid Opening Quote:",`a quote is found on field ${JSON.stringify(e.column)} at line ${e.lines}, value is ${JSON.stringify(this.state.field.toString(l))}`,t?`(${t} bom)`:void 0],this.options,e,{field:this.state.field}));if(void 0!==i)return i}}else{this.state.quoting=!0,o+=S.length-1;continue}}if(!1===this.state.quoting){let t=this.__isRecordDelimiter(e,n,o);if(0!==t){if(this.state.commenting&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length)this.info.comment_lines++;else{if(!1===this.state.enabled&&this.info.lines+(!0===this.state.wasRowDelimiter?1:0)>=f){this.state.enabled=!0,this.__resetField(),this.__resetRecord(),o+=t-1;continue}if(!0===y&&!1===this.state.wasQuoting&&0===this.state.record.length&&0===this.state.field.length){this.info.empty_lines++,o+=t-1;continue}this.info.bytes=this.state.bufBytesStart+o;let e=this.__onField();if(void 0!==e)return e;this.info.bytes=this.state.bufBytesStart+o+t;let n=this.__onRecord(i);if(void 0!==n)return n;if(-1!==b&&this.info.records>=b){this.state.stop=!0,r();return}}this.state.commenting=!1,o+=t-1;continue}if(this.state.commenting)continue;if(null!==w&&(!1===a||0===this.state.record.length&&0===this.state.field.length)&&0!==this.__compareBytes(w,n,o,e)){this.state.commenting=!0;continue}let s=this.__isDelimiter(n,o,e);if(0!==s){this.info.bytes=this.state.bufBytesStart+o;let e=this.__onField();if(void 0!==e)return e;o+=s-1;continue}}}if(!1===this.state.commenting&&0!==c&&this.state.record_length+this.state.field.length>c)return this.__error(new u("CSV_MAX_RECORD_SIZE",["Max Record Size:","record exceed the maximum number of tolerated bytes",`of ${c}`,`at line ${this.info.lines}`],this.options,this.__infoField()));let t=!1===_||!0===this.state.quoting||0!==this.state.field.length||!this.__isCharTrimable(n,o),s=!1===g||!1===this.state.wasQuoting;if(!0===t&&!0===s)this.state.field.append(e);else{if(!0===g&&!this.__isCharTrimable(n,o))return this.__error(new u("CSV_NON_TRIMABLE_CHAR_AFTER_CLOSING_QUOTE",["Invalid Closing Quote:","found non trimable byte after quote",`at line ${this.info.lines}`],this.options,this.__infoField()));!1===t&&(o+=this.__isCharTrimable(n,o)-1);continue}}if(!0===t){if(!0===this.state.quoting){let e=this.__error(new u("CSV_QUOTE_NOT_CLOSED",["Quote Not Closed:",`the parsing is finished with an opening quote at line ${this.info.lines}`],this.options,this.__infoField()));if(void 0!==e)return e}else if(!0===this.state.wasQuoting||0!==this.state.record.length||0!==this.state.field.length){this.info.bytes=this.state.bufBytesStart+o;let e=this.__onField();if(void 0!==e)return e;let t=this.__onRecord(i);if(void 0!==t)return t}else!0===this.state.wasRowDelimiter?this.info.empty_lines++:!0===this.state.commenting&&this.info.comment_lines++}else this.state.bufBytesStart+=o,this.state.previousBuf=n.slice(o);!0===this.state.wasRowDelimiter&&(this.info.lines++,this.state.wasRowDelimiter=!1)},__onRecord:function(e){let{columns:t,group_columns_by_name:i,encoding:r,info:n,from:o,relax_column_count:s,relax_column_count_less:a,relax_column_count_more:l,raw:f,skip_records_with_empty_values:_}=this.options,{enabled:d,record:m}=this.state;if(!1===d)return this.__resetRecord();let h=m.length;if(!0===t){if(!0===_&&c(m)){this.__resetRecord();return}return this.__firstLineToColumns(m)}if(!1===t&&0===this.info.records&&(this.state.expectedRecordLength=h),h!==this.state.expectedRecordLength){let e=!1===t?new u("CSV_RECORD_INCONSISTENT_FIELDS_LENGTH",["Invalid Record Length:",`expect ${this.state.expectedRecordLength},`,`got ${h} on line ${this.info.lines}`],this.options,this.__infoField(),{record:m}):new u("CSV_RECORD_INCONSISTENT_COLUMNS",["Invalid Record Length:",`columns length is ${t.length},`,`got ${h} on line ${this.info.lines}`],this.options,this.__infoField(),{record:m});if(!0===s||!0===a&&h<this.state.expectedRecordLength||!0===l&&h>this.state.expectedRecordLength)this.info.invalid_field_length++,this.state.error=e;else{let t=this.__error(e);if(t)return t}}if(!0===_&&c(m)){this.__resetRecord();return}if(!0===this.state.recordHasError){this.__resetRecord(),this.state.recordHasError=!1;return}if(this.info.records++,1===o||this.info.records>=o){let{objname:o}=this.options;if(!1!==t){let s={};for(let e=0,r=m.length;e<r;e++)void 0===t[e]||t[e].disabled||(!0===i&&void 0!==s[t[e].name]?Array.isArray(s[t[e].name])?s[t[e].name]=s[t[e].name].concat(m[e]):s[t[e].name]=[s[t[e].name],m[e]]:s[t[e].name]=m[e]);if(!0===f||!0===n){let t=Object.assign({record:s},!0===f?{raw:this.state.rawBuffer.toString(r)}:{},!0===n?{info:this.__infoRecord()}:{}),i=this.__push(void 0===o?t:[s[o],t],e);if(i)return i}else{let t=this.__push(void 0===o?s:[s[o],s],e);if(t)return t}}else if(!0===f||!0===n){let t=Object.assign({record:m},!0===f?{raw:this.state.rawBuffer.toString(r)}:{},!0===n?{info:this.__infoRecord()}:{}),i=this.__push(void 0===o?t:[m[o],t],e);if(i)return i}else{let t=this.__push(void 0===o?m:[m[o],m],e);if(t)return t}}this.__resetRecord()},__firstLineToColumns:function(e){let{firstLineToHeaders:t}=this.state;try{let i=void 0===t?e:t.call(null,e);if(!Array.isArray(i))return this.__error(new u("CSV_INVALID_COLUMN_MAPPING",["Invalid Column Mapping:","expect an array from column function,",`got ${JSON.stringify(i)}`],this.options,this.__infoField(),{headers:i}));let r=f(i);this.state.expectedRecordLength=r.length,this.options.columns=r,this.__resetRecord();return}catch(e){return e}},__resetRecord:function(){!0===this.options.raw&&this.state.rawBuffer.reset(),this.state.error=void 0,this.state.record=[],this.state.record_length=0},__onField:function(){let{cast:e,encoding:t,rtrim:i,max_record_size:r}=this.options,{enabled:n,wasQuoting:o}=this.state;if(!1===n)return this.__resetField();let s=this.state.field.toString(t);if(!0===i&&!1===o&&(s=s.trimRight()),!0===e){let[e,t]=this.__cast(s);if(void 0!==e)return e;s=t}this.state.record.push(s),0!==r&&"string"==typeof s&&(this.state.record_length+=s.length),this.__resetField()},__resetField:function(){this.state.field.reset(),this.state.wasQuoting=!1},__push:function(e,t){let{on_record:i}=this.options;if(void 0!==i){let t=this.__infoRecord();try{e=i.call(null,e,t)}catch(e){return e}if(null==e)return}t(e)},__cast:function(e){let{columns:t,relax_column_count:i}=this.options;if(!0===Array.isArray(t)&&i&&this.options.columns.length<=this.state.record.length)return[void 0,void 0];if(null!==this.state.castField)try{let t=this.__infoField();return[void 0,this.state.castField.call(null,e,t)]}catch(e){return[e]}if(this.__isFloat(e))return[void 0,parseFloat(e)];if(!1!==this.options.cast_date){let t=this.__infoField();return[void 0,this.options.cast_date.call(null,e,t)]}return[void 0,e]},__isCharTrimable:function(e,t){return((e,t)=>{let{timchars:i}=this.state;e:for(let r=0;r<i.length;r++){let n=i[r];for(let i=0;i<n.length;i++)if(n[i]!==e[t+i])continue e;return n.length}return 0})(e,t)},__isFloat:function(e){return e-parseFloat(e)+1>=0},__compareBytes:function(e,t,i,r){if(e[0]!==r)return 0;let n=e.length;for(let r=1;r<n;r++)if(e[r]!==t[i+r])return 0;return n},__isDelimiter:function(e,t,i){let{delimiter:r,ignore_last_delimiters:n}=this.options;if(!0===n&&this.state.record.length===this.options.columns.length-1||!1!==n&&"number"==typeof n&&this.state.record.length===n-1)return 0;e:for(let n=0;n<r.length;n++){let o=r[n];if(o[0]===i){for(let i=1;i<o.length;i++)if(o[i]!==e[t+i])continue e;return o.length}}return 0},__isRecordDelimiter:function(e,t,i){let{record_delimiter:r}=this.options,n=r.length;e:for(let o=0;o<n;o++){let n=r[o],s=n.length;if(n[0]===e){for(let e=1;e<s;e++)if(n[e]!==t[i+e])continue e;return n.length}}return 0},__isEscape:function(e,t,i){let{escape:r}=this.options;if(null===r)return!1;let n=r.length;if(r[0]===i){for(let i=0;i<n;i++)if(r[i]!==e[t+i])return!1;return!0}return!1},__isQuote:function(e,t){let{quote:i}=this.options;if(null===i)return!1;let r=i.length;for(let n=0;n<r;n++)if(i[n]!==e[t+n])return!1;return!0},__autoDiscoverRecordDelimiter:function(e,t){let{encoding:i}=this.options,r=[Buffer.from("\r\n",i),Buffer.from("\n",i),Buffer.from("\r",i)];t:for(let i=0;i<r.length;i++){let n=r[i].length;for(let o=0;o<n;o++)if(r[i][o]!==e[t+o])continue t;return this.options.record_delimiter.push(r[i]),this.state.recordDelimiterMaxLength=r[i].length,r[i].length}return 0},__error:function(e){let{encoding:t,raw:i,skip_records_with_error:r}=this.options,n="string"==typeof e?Error(e):e;if(!r)return n;if(this.state.recordHasError=!0,void 0!==this.options.on_skip)try{this.options.on_skip(n,i?this.state.rawBuffer.toString(t):void 0)}catch(e){return e}},__infoDataSet:function(){return{...this.info,columns:this.options.columns}},__infoRecord:function(){let{columns:e,raw:t,encoding:i}=this.options;return{...this.__infoDataSet(),error:this.state.error,header:!0===e,index:this.state.record.length,raw:t?this.state.rawBuffer.toString(i):void 0}},__infoField:function(){let{columns:e}=this.options,t=Array.isArray(e);return{...this.__infoRecord(),column:!0===t?e.length>this.state.record.length?e[this.state.record.length].name:null:this.state.record.length,quoting:this.state.wasQuoting}}}},p=function(e,t={}){"string"==typeof e&&(e=Buffer.from(e));let i=t&&t.objname?{}:[],r=h(t),n=r.parse(e,!0,e=>{void 0===r.options.objname?i.push(e):i[e[0]]=e[1]},()=>{});if(void 0!==n)throw n;return i};var g=i(5974);let y=process.env.SUPABASE_SERVICE_ROLE_KEY,b=(0,l.eI)("https://pphzvnaedmzcvpxjulti.supabase.co",y);async function v(e){try{let t,i;let r=e.headers.get("content-type")||"",n="EUC-KR";if(r.includes("application/json")){let r=await e.json();t=r.csv_content,i=r.academy_id,n=r.encoding||"EUC-KR"}else if(r.includes("text/csv")||r.includes("text/plain")){i=e.nextUrl.searchParams.get("academy_id")||"",n=e.nextUrl.searchParams.get("encoding")||"EUC-KR";let r=await e.arrayBuffer();t=I(Buffer.from(r),n)}else{if(!r.includes("multipart/form-data"))return a.NextResponse.json({ok:!1,error:"Unsupported content type"},{status:400});let o=await e.formData(),s=o.get("file");if(i=o.get("academy_id")||e.nextUrl.searchParams.get("academy_id")||"",!s)return a.NextResponse.json({ok:!1,error:"No file uploaded"},{status:400});let l=await s.arrayBuffer();t=I(Buffer.from(l),n)}if(!i)return a.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});if(!t||""===t.trim())return a.NextResponse.json({ok:!1,error:"CSV content is empty"},{status:400});let o=S(t);if(0===o.length)return a.NextResponse.json({ok:!1,error:"No valid records found in CSV"},{status:400});let s=new g.xi(i,"narakhub"),l=o.map(e=>s.mapNarakhub(e)),u=await N(i,l);return await x(i,"narakhub",u),a.NextResponse.json({ok:!0,data:u,message:`Processed ${u.synced_records} students from Narakhub CSV`})}catch(e){return console.error("Narakhub sync error:",e),a.NextResponse.json({ok:!1,error:e.message},{status:500})}}async function w(e){try{let t=e.nextUrl.searchParams.get("academy_id"),i=e.nextUrl.searchParams.get("file_path");if(!t)return a.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});if(i){let e=`학생ID,학생명,학년,반,학부모명,연락처,이메일,등록금,미납금,출석률,상담메모
NRH001,김민준,중2,수학A,김엄마,010-1234-5678,kim@test.com,350000,0,95%,모범생
NRH002,이서연,중2,수학A,이아빠,010-2345-6789,lee@test.com,350000,0,98%,성적 우수
NRH003,박지호,중3,영어B,박엄마,010-3456-7890,,350000,200000,72%,출석률 저하 주의
NRH004,최유진,고1,국어C,최엄마,010-4567-8901,choi@test.com,400000,400000,85%,미납 지속
NRH005,정하늘,중1,수학A,정아빠,010-5678-9012,,300000,0,90%,`,i=S(e),r=new g.xi(t,"narakhub"),n=i.map(e=>r.mapNarakhub(e)),o=await N(t,n);return await x(t,"narakhub",o),a.NextResponse.json({ok:!0,data:o,message:`Synced ${o.synced_records} students from file`})}let{data:r}=await b.from("sync_logs").select("*").eq("academy_id",t).eq("provider","narakhub").order("created_at",{ascending:!1}).limit(1).single();return a.NextResponse.json({ok:!0,data:{last_sync:r,provider:"narakhub",academy_id:t}})}catch(e){return console.error("Narakhub GET error:",e),a.NextResponse.json({ok:!1,error:e.message},{status:500})}}function I(e,t){try{if("EUC-KR"===t.toUpperCase()||"CP949"===t.toUpperCase()){let t=e.toString("utf8");if(!t.includes("�"))return t;return e.toString("latin1")}return e.toString("utf8")}catch{return e.toString("utf8")}}function S(e){try{let t=e.split("\n")[0].includes("	")?"	":",";return p(e,{columns:!0,skip_empty_lines:!0,delimiter:t,relax_column_count:!0,trim:!0}).map(e=>({학생ID:e["학생ID"]||e["학생코드"]||e.student_id||e.ID,학생명:e["학생명"]||e["이름"]||e.name||e["학생이름"],학년:e["학년"]||e.grade||"",반:e["반"]||e.class||e["클래스"]||"",학부모명:e["학부모명"]||e["보호자명"]||e.parent_name||"",연락처:e["연락처"]||e["전화번호"]||e.phone||e["학부모연락처"]||"",이메일:e["이메일"]||e.email||"",등록금:e["등록금"]||e["수강료"]||e["월납입액"]||e.fee||"0",미납금:e["미납금"]||e["미납액"]||e.unpaid||"0",출석률:e["출석률"]||e["출석"]||e.attendance||"100",상담메모:e["상담메모"]||e["메모"]||e["비고"]||e.memo||""})).filter(e=>e.학생ID&&e.학생명)}catch(e){return console.error("CSV parse error:",e),[]}}async function N(e,t){let i=new Date().toISOString(),r=0,n=0,o=0,s=0,a=[];for(let i of t)try{let t=(0,g.h5)(i);if(!t.valid){a.push({record_id:i.external_id,message:t.errors.join(", ")});continue}let l=(0,g.iR)(i),u=(0,g.N3)(l),f={...i,risk_score:l,risk_band:u,confidence_score:.75},{data:_}=await b.from("students").select("id, metadata").eq("academy_id",e).eq("external_id",i.external_id).single(),d=(0,g.Uh)(i);if(_){if(_.metadata?.hash===d){s++;continue}await b.from("students").update({...f,metadata:{...i.metadata,hash:d}}).eq("id",_.id),o++}else await b.from("students").insert({...f,metadata:{...i.metadata,hash:d}}),n++;await O(e,i),r++}catch(e){a.push({record_id:i.external_id,message:e.message})}return{academy_id:e,provider:"narakhub",status:0===a.length?"success":r>0?"success":"error",total_records:t.length,synced_records:r,created_records:n,updated_records:o,skipped_records:s,failed_records:a.length,started_at:i,completed_at:new Date().toISOString(),duration_ms:Date.now()-new Date(i).getTime(),errors:a.length>0?a:void 0}}async function O(e,t){let i=[];t.attendance_rate&&t.attendance_rate<80&&i.push(`출석률 저하: ${t.attendance_rate}%`),t.unpaid_amount&&t.unpaid_amount>0&&i.push(`미납금 발생: ${t.unpaid_amount.toLocaleString()}원`),t.homework_completion&&t.homework_completion<70&&i.push(`과제 완성도 저하: ${t.homework_completion}%`),await b.from("student_signals").upsert({student_id:t.external_id,academy_id:e,attendance_drop:80>(t.attendance_rate||100),homework_missed:t.homework_completion?Math.floor((100-t.homework_completion)/10):0,unpaid_amount:t.unpaid_amount||0,recent_score_change:t.score_change||0,recent_signals:i,updated_at:new Date().toISOString()},{onConflict:"student_id,academy_id"})}async function x(e,t,i){await b.from("sync_logs").insert({academy_id:e,provider:t,total_records:i.total_records,synced_records:i.synced_records,status:i.status,error:i.errors?.map(e=>e.message).join("; ")})}let E=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/sync/narakhub/route",pathname:"/api/sync/narakhub",filename:"route",bundlePath:"app/api/sync/narakhub/route"},resolvedPagePath:"/Users/oseho/Desktop/autus/vercel-api/app/api/sync/narakhub/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:R,staticGenerationAsyncStorage:D,serverHooks:C}=E,B="/api/sync/narakhub/route";function k(){return(0,s.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:D})}},5974:(e,t,i)=>{i.d(t,{N3:()=>a,Uh:()=>o,h5:()=>s,iR:()=>l,xi:()=>n});var r=i(4770);class n{constructor(e,t){this.academyId=e,this.provider=t}mapClassting(e){return{academy_id:this.academyId,external_id:e.id,provider:"classting",name:e.name,grade:e.grade,grade_band:this.normalizeGrade(e.grade),class_name:e.class_name,parent_name:e.parent?.name,parent_phone:this.normalizePhone(e.parent?.phone),parent_email:e.parent?.email,attendance_rate:e.attendance_rate,homework_completion:e.assignment_completion,synced_at:new Date().toISOString()}}mapNarakhub(e){let t=this.parseNumber(e.등록금),i=this.parseNumber(e.미납금);return{academy_id:this.academyId,external_id:e.학생ID,provider:"narakhub",name:e.학생명,grade:e.학년,grade_band:this.normalizeGrade(e.학년),class_name:e.반,parent_name:e.학부모명,parent_phone:this.normalizePhone(e.연락처),parent_email:e.이메일,monthly_fee:t,unpaid_amount:i,payment_status:this.getPaymentStatus(i,t),attendance_rate:this.parsePercent(e.출석률),metadata:e.상담메모?{memo:e.상담메모}:void 0,synced_at:new Date().toISOString()}}mapTongtong(e){let t=this.parseNumber(e.monthly_fee),i=this.parseNumber(e.unpaid);return{academy_id:this.academyId,external_id:e.student_code,provider:"tongtong",name:e.student_name,grade:e.grade,grade_band:this.normalizeGrade(e.grade),class_name:e.class,parent_name:e.parent_name,parent_phone:this.normalizePhone(e.parent_phone),monthly_fee:t,unpaid_amount:i,payment_status:this.getPaymentStatus(i,t),attendance_rate:this.parsePercent(e.attendance_pct),recent_score:this.parseNumber(e.last_score),metadata:e.memo?{memo:e.memo}:void 0,synced_at:new Date().toISOString()}}mapACA2000(e){return{academy_id:this.academyId,external_id:e.학번,provider:"aca2000",name:e.성명,grade:e.학년,grade_band:this.normalizeGrade(e.학년),subject:e.과목,parent_phone:this.normalizePhone(e.학부모연락처),monthly_fee:e.월수강료,unpaid_amount:e.미납액,payment_status:this.getPaymentStatus(e.미납액,e.월수강료),attendance_rate:e.출석률,recent_score:e.최근점수,metadata:e.비고?{memo:e.비고}:void 0,synced_at:new Date().toISOString()}}mapSmartfit(e){let t=this.parseNumber(e.월회비),i=this.parseNumber(e.미납금);return{academy_id:this.academyId,external_id:e.회원코드,provider:"smartfit",name:e.회원명,grade_band:e.등급,parent_name:e.학부모명,parent_phone:this.normalizePhone(e.연락처),monthly_fee:t,unpaid_amount:i,payment_status:this.getPaymentStatus(i,t),attendance_rate:this.parsePercent(e.출석률),metadata:e.메모?{memo:e.메모}:void 0,synced_at:new Date().toISOString()}}mapBatch(e){return e.map(e=>{switch(this.provider){case"classting":return this.mapClassting(e);case"narakhub":return this.mapNarakhub(e);case"tongtong":return this.mapTongtong(e);case"aca2000":return this.mapACA2000(e);case"smartfit":return this.mapSmartfit(e);default:throw Error(`Unknown provider: ${this.provider}`)}})}normalizeGrade(e){if(!e)return"unknown";let t=e.toLowerCase().replace(/\s/g,"");return/초[1-6]|elementary|e[1-6]|1-6학년/.test(t)?"elementary":/중[1-3]|middle|m[1-3]|7-9학년/.test(t)?"middle":/고[1-3]|high|h[1-3]|10-12학년/.test(t)?"high":/중1/.test(t)?"middle-1":/중2/.test(t)?"middle-2":/중3/.test(t)?"middle-3":/고1/.test(t)?"high-1":/고2/.test(t)?"high-2":/고3/.test(t)?"high-3":e}normalizePhone(e){if(!e)return;let t=e.replace(/\D/g,"");return 11===t.length&&t.startsWith("010")?`${t.slice(0,3)}-${t.slice(3,7)}-${t.slice(7)}`:10===t.length?t.startsWith("02")?`${t.slice(0,2)}-${t.slice(2,6)}-${t.slice(6)}`:`${t.slice(0,3)}-${t.slice(3,6)}-${t.slice(6)}`:e}parseNumber(e){if(null==e||""===e)return 0;if("number"==typeof e)return e;let t=parseFloat(e.replace(/[₩$,원]/g,"").trim());return isNaN(t)?0:t}parsePercent(e){if(null==e||""===e)return 100;if("number"==typeof e)return e>1?e:100*e;let t=parseFloat(e.replace(/%/g,"").trim());return isNaN(t)?100:t>1?t:100*t}getPaymentStatus(e,t){return e<=0?"paid":t&&e>=t?"unpaid":"partial"}}function o(e){let t=[e.name,e.grade,e.parent_phone,e.monthly_fee,e.unpaid_amount,e.attendance_rate,e.recent_score].map(e=>String(e??"")).join("|");return r.createHash("md5").update(t).digest("hex")}function s(e){let t=[],i=[];return e.academy_id||t.push("academy_id is required"),e.external_id||t.push("external_id is required"),e.provider||t.push("provider is required"),e.name||t.push("name is required"),void 0!==e.attendance_rate&&(e.attendance_rate<0||e.attendance_rate>100)&&i.push("attendance_rate should be between 0 and 100"),void 0!==e.monthly_fee&&e.monthly_fee<0&&i.push("monthly_fee should not be negative"),void 0!==e.unpaid_amount&&e.unpaid_amount<0&&i.push("unpaid_amount should not be negative"),e.parent_phone&&!/^[\d\-]+$/.test(e.parent_phone)&&i.push("parent_phone format may be invalid"),{valid:0===t.length,errors:t,warnings:i}}function a(e){return e>=200?"critical":e>=150?"high":e>=100?"medium":"low"}function l(e){let t=0;return void 0!==e.attendance_rate&&(t+=Math.max(0,100-e.attendance_rate)),e.unpaid_amount&&e.unpaid_amount>0&&(t+=Math.min(100,20*Math.floor(e.unpaid_amount/1e5))),void 0!==e.score_change&&e.score_change<0&&(t+=Math.min(50,2*Math.abs(e.score_change))),void 0!==e.homework_completion&&(t+=Math.max(0,100-e.homework_completion)/2),Math.min(300,Math.round(t))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[276,564],()=>i(3797));module.exports=r})();