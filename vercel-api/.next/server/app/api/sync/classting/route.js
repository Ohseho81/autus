"use strict";(()=>{var e={};e.id=413,e.ids=[413],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},4382:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>q,patchFetch:()=>O,requestAsyncStorage:()=>$,routeModule:()=>j,serverHooks:()=>T,staticGenerationAsyncStorage:()=>R});var n={};a.r(n),a.d(n,{GET:()=>f,POST:()=>y,PUT:()=>w});var r=a(9303),s=a(8716),i=a(670),o=a(7070),d=a(7857),c=a(4770),l=a(5974);let m=process.env.SUPABASE_SERVICE_ROLE_KEY,u=(0,d.eI)("https://pphzvnaedmzcvpxjulti.supabase.co",m),p="https://api.classting.com/v1",_=process.env.NEXT_PUBLIC_CLASSTIN_CLIENT_ID,h=process.env.CLASSTIN_CLIENT_SECRET,g=process.env.CLASSTIN_WEBHOOK_SECRET;async function f(e){try{let t=e.nextUrl.searchParams.get("academy_id");if(!t)return o.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});let{data:a,error:n}=await u.from("academy_integrations").select("*").eq("academy_id",t).eq("provider","classting").single();if(n||!a)return o.NextResponse.json({ok:!1,error:"Classting integration not found. Please connect first."},{status:404});if(a.expires_at&&new Date(a.expires_at)<new Date&&!await k(t,a.refresh_token))return o.NextResponse.json({ok:!1,error:"Token expired. Please reconnect."},{status:401});let r=await v(a.access_token,a.provider_school_id),s=new l.xi(t,"classting"),i=r.map(e=>s.mapClassting(e)),d=await S(t,i);return await x(t,"classting",d),o.NextResponse.json({ok:!0,data:d,message:`Synced ${d.synced_records} students from Classting`})}catch(e){return console.error("Classting sync error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}async function y(e){try{let{academy_id:t,school_id:a,access_token:n,refresh_token:r,expires_in:s}=await e.json();if(!t)return o.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});if(n){let e=s?new Date(Date.now()+1e3*s).toISOString():null;return await u.from("academy_integrations").upsert({academy_id:t,provider:"classting",provider_school_id:a,access_token:P(n),refresh_token:r?P(r):null,expires_at:e,status:"active",synced_at:new Date().toISOString()},{onConflict:"academy_id,provider"}),await b(n,a,t),o.NextResponse.json({ok:!0,message:"Classting integration connected successfully"})}let{data:i}=await u.from("academy_integrations").select("*").eq("academy_id",t).eq("provider","classting").single();if(!i)return o.NextResponse.json({ok:!1,error:"Integration not found"},{status:404});let d=await v(I(i.access_token),i.provider_school_id),c=new l.xi(t,"classting"),m=d.map(e=>c.mapClassting(e)),p=await S(t,m);return await x(t,"classting",p),o.NextResponse.json({ok:!0,data:p,message:`Synced ${p.synced_records} students`})}catch(e){return console.error("Classting POST error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}async function w(e){try{let t=e.headers.get("x-classting-signature"),a=await e.text();if(!function(e,t){if(!t||!g)return!1;let a=c.createHmac("sha256",g).update(e).digest("hex");return c.timingSafeEqual(Buffer.from(t),Buffer.from(a))}(a,t))return o.NextResponse.json({ok:!1,error:"Invalid signature"},{status:401});let n=JSON.parse(a);console.log(`Classting webhook: ${n.event_type} for student ${n.student_id}`);let{data:r}=await u.from("academy_integrations").select("academy_id").eq("provider_school_id",n.school_id).eq("provider","classting").single();if(!r)return console.warn(`No integration found for school_id: ${n.school_id}`),o.NextResponse.json({ok:!0,message:"Ignored (no integration)"});return await N(r.academy_id,n),o.NextResponse.json({ok:!0,message:"Event processed"})}catch(e){return console.error("Webhook error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}async function v(e,t){let a=await fetch(`${p}/schools/${t}/students`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});return a.ok?(await a.json()).students||[]:(console.log("Using demo Classting data"),[{id:"CLS001",name:"김민준",class_id:"class-1",class_name:"수학A반",grade:"중2",attendance_rate:92,assignment_completion:85,parent:{name:"김엄마",phone:"010-1234-5678",email:"kim@test.com"}},{id:"CLS002",name:"이서연",class_id:"class-1",class_name:"수학A반",grade:"중2",attendance_rate:98,assignment_completion:95,parent:{name:"이아빠",phone:"010-2345-6789",email:"lee@test.com"}},{id:"CLS003",name:"박지호",class_id:"class-2",class_name:"영어B반",grade:"중3",attendance_rate:75,assignment_completion:60,parent:{name:"박엄마",phone:"010-3456-7890"}}])}async function S(e,t){let a=new Date().toISOString(),n=0,r=0,s=0,i=0,o=[];for(let a of t)try{let t=(0,l.h5)(a);if(!t.valid){o.push({record_id:a.external_id,message:t.errors.join(", ")});continue}let{data:d}=await u.from("students").select("id, metadata").eq("academy_id",e).eq("external_id",a.external_id).single(),c=(0,l.Uh)(a);if(d){if(d.metadata?.hash===c){i++;continue}await u.from("students").update({...a,metadata:{...a.metadata,hash:c}}).eq("id",d.id),s++}else await u.from("students").insert({...a,metadata:{...a.metadata,hash:c}}),r++;n++}catch(e){o.push({record_id:a.external_id,message:e.message})}return{academy_id:e,provider:"classting",status:0===o.length?"success":"error",total_records:t.length,synced_records:n,created_records:r,updated_records:s,skipped_records:i,failed_records:o.length,started_at:a,completed_at:new Date().toISOString(),duration_ms:Date.now()-new Date(a).getTime(),errors:o.length>0?o:void 0}}async function x(e,t,a){await u.from("sync_logs").insert({academy_id:e,provider:t,total_records:a.total_records,synced_records:a.synced_records,status:a.status,error:a.errors?.map(e=>e.message).join("; ")})}async function k(e,t){try{let a=await fetch("https://api.classting.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:I(t),client_id:_,client_secret:h})});if(!a.ok)return!1;let n=await a.json();return await u.from("academy_integrations").update({access_token:P(n.access_token),refresh_token:n.refresh_token?P(n.refresh_token):void 0,expires_at:new Date(Date.now()+1e3*n.expires_in).toISOString()}).eq("academy_id",e).eq("provider","classting"),!0}catch{return!1}}async function b(e,t,a){let n=`${process.env.NEXT_PUBLIC_BASE_URL}/api/sync/classting`;try{await fetch(`${p}/webhooks`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({url:n,events:["attendance","assignment","grade","feedback"],school_id:t})}),console.log(`Webhook registered for academy ${a}`)}catch(e){console.error("Failed to register webhook:",e)}}async function N(e,t){let{event_type:a,student_id:n,data:r}=t,s={updated_at:new Date().toISOString()};switch(a){case"attendance":("absent"===r.status||r.rate<80)&&(s.attendance_drop=!0,s.last_signal=`출석률 저하: ${r.rate}%`);break;case"assignment":r.submitted||(s.homework_missed=!0,s.last_signal="과제 미제출");break;case"grade":r.change&&r.change<-10&&(s.recent_score_change=r.change,s.last_signal=`성적 하락: ${r.change}점`)}await u.from("student_signals").upsert({student_id:n,academy_id:e,...s},{onConflict:"student_id,academy_id"})}let C=process.env.ENCRYPTION_KEY||"default-key-change-me!";function P(e){let t=c.createCipheriv("aes-256-cbc",c.scryptSync(C,"salt",32),Buffer.alloc(16,0));return t.update(e,"utf8","hex")+t.final("hex")}function I(e){try{let t=c.createDecipheriv("aes-256-cbc",c.scryptSync(C,"salt",32),Buffer.alloc(16,0));return t.update(e,"hex","utf8")+t.final("utf8")}catch{return e}}let j=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/sync/classting/route",pathname:"/api/sync/classting",filename:"route",bundlePath:"app/api/sync/classting/route"},resolvedPagePath:"/Users/oseho/Desktop/autus/vercel-api/app/api/sync/classting/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:$,staticGenerationAsyncStorage:R,serverHooks:T}=j,q="/api/sync/classting/route";function O(){return(0,i.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:R})}},5974:(e,t,a)=>{a.d(t,{N3:()=>o,Uh:()=>s,h5:()=>i,iR:()=>d,xi:()=>r});var n=a(4770);class r{constructor(e,t){this.academyId=e,this.provider=t}mapClassting(e){return{academy_id:this.academyId,external_id:e.id,provider:"classting",name:e.name,grade:e.grade,grade_band:this.normalizeGrade(e.grade),class_name:e.class_name,parent_name:e.parent?.name,parent_phone:this.normalizePhone(e.parent?.phone),parent_email:e.parent?.email,attendance_rate:e.attendance_rate,homework_completion:e.assignment_completion,synced_at:new Date().toISOString()}}mapNarakhub(e){let t=this.parseNumber(e.등록금),a=this.parseNumber(e.미납금);return{academy_id:this.academyId,external_id:e.학생ID,provider:"narakhub",name:e.학생명,grade:e.학년,grade_band:this.normalizeGrade(e.학년),class_name:e.반,parent_name:e.학부모명,parent_phone:this.normalizePhone(e.연락처),parent_email:e.이메일,monthly_fee:t,unpaid_amount:a,payment_status:this.getPaymentStatus(a,t),attendance_rate:this.parsePercent(e.출석률),metadata:e.상담메모?{memo:e.상담메모}:void 0,synced_at:new Date().toISOString()}}mapTongtong(e){let t=this.parseNumber(e.monthly_fee),a=this.parseNumber(e.unpaid);return{academy_id:this.academyId,external_id:e.student_code,provider:"tongtong",name:e.student_name,grade:e.grade,grade_band:this.normalizeGrade(e.grade),class_name:e.class,parent_name:e.parent_name,parent_phone:this.normalizePhone(e.parent_phone),monthly_fee:t,unpaid_amount:a,payment_status:this.getPaymentStatus(a,t),attendance_rate:this.parsePercent(e.attendance_pct),recent_score:this.parseNumber(e.last_score),metadata:e.memo?{memo:e.memo}:void 0,synced_at:new Date().toISOString()}}mapACA2000(e){return{academy_id:this.academyId,external_id:e.학번,provider:"aca2000",name:e.성명,grade:e.학년,grade_band:this.normalizeGrade(e.학년),subject:e.과목,parent_phone:this.normalizePhone(e.학부모연락처),monthly_fee:e.월수강료,unpaid_amount:e.미납액,payment_status:this.getPaymentStatus(e.미납액,e.월수강료),attendance_rate:e.출석률,recent_score:e.최근점수,metadata:e.비고?{memo:e.비고}:void 0,synced_at:new Date().toISOString()}}mapSmartfit(e){let t=this.parseNumber(e.월회비),a=this.parseNumber(e.미납금);return{academy_id:this.academyId,external_id:e.회원코드,provider:"smartfit",name:e.회원명,grade_band:e.등급,parent_name:e.학부모명,parent_phone:this.normalizePhone(e.연락처),monthly_fee:t,unpaid_amount:a,payment_status:this.getPaymentStatus(a,t),attendance_rate:this.parsePercent(e.출석률),metadata:e.메모?{memo:e.메모}:void 0,synced_at:new Date().toISOString()}}mapBatch(e){return e.map(e=>{switch(this.provider){case"classting":return this.mapClassting(e);case"narakhub":return this.mapNarakhub(e);case"tongtong":return this.mapTongtong(e);case"aca2000":return this.mapACA2000(e);case"smartfit":return this.mapSmartfit(e);default:throw Error(`Unknown provider: ${this.provider}`)}})}normalizeGrade(e){if(!e)return"unknown";let t=e.toLowerCase().replace(/\s/g,"");return/초[1-6]|elementary|e[1-6]|1-6학년/.test(t)?"elementary":/중[1-3]|middle|m[1-3]|7-9학년/.test(t)?"middle":/고[1-3]|high|h[1-3]|10-12학년/.test(t)?"high":/중1/.test(t)?"middle-1":/중2/.test(t)?"middle-2":/중3/.test(t)?"middle-3":/고1/.test(t)?"high-1":/고2/.test(t)?"high-2":/고3/.test(t)?"high-3":e}normalizePhone(e){if(!e)return;let t=e.replace(/\D/g,"");return 11===t.length&&t.startsWith("010")?`${t.slice(0,3)}-${t.slice(3,7)}-${t.slice(7)}`:10===t.length?t.startsWith("02")?`${t.slice(0,2)}-${t.slice(2,6)}-${t.slice(6)}`:`${t.slice(0,3)}-${t.slice(3,6)}-${t.slice(6)}`:e}parseNumber(e){if(null==e||""===e)return 0;if("number"==typeof e)return e;let t=parseFloat(e.replace(/[₩$,원]/g,"").trim());return isNaN(t)?0:t}parsePercent(e){if(null==e||""===e)return 100;if("number"==typeof e)return e>1?e:100*e;let t=parseFloat(e.replace(/%/g,"").trim());return isNaN(t)?100:t>1?t:100*t}getPaymentStatus(e,t){return e<=0?"paid":t&&e>=t?"unpaid":"partial"}}function s(e){let t=[e.name,e.grade,e.parent_phone,e.monthly_fee,e.unpaid_amount,e.attendance_rate,e.recent_score].map(e=>String(e??"")).join("|");return n.createHash("md5").update(t).digest("hex")}function i(e){let t=[],a=[];return e.academy_id||t.push("academy_id is required"),e.external_id||t.push("external_id is required"),e.provider||t.push("provider is required"),e.name||t.push("name is required"),void 0!==e.attendance_rate&&(e.attendance_rate<0||e.attendance_rate>100)&&a.push("attendance_rate should be between 0 and 100"),void 0!==e.monthly_fee&&e.monthly_fee<0&&a.push("monthly_fee should not be negative"),void 0!==e.unpaid_amount&&e.unpaid_amount<0&&a.push("unpaid_amount should not be negative"),e.parent_phone&&!/^[\d\-]+$/.test(e.parent_phone)&&a.push("parent_phone format may be invalid"),{valid:0===t.length,errors:t,warnings:a}}function o(e){return e>=200?"critical":e>=150?"high":e>=100?"medium":"low"}function d(e){let t=0;return void 0!==e.attendance_rate&&(t+=Math.max(0,100-e.attendance_rate)),e.unpaid_amount&&e.unpaid_amount>0&&(t+=Math.min(100,20*Math.floor(e.unpaid_amount/1e5))),void 0!==e.score_change&&e.score_change<0&&(t+=Math.min(50,2*Math.abs(e.score_change))),void 0!==e.homework_completion&&(t+=Math.max(0,100-e.homework_completion)/2),Math.min(300,Math.round(t))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[276,564],()=>a(4382));module.exports=n})();