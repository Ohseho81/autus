"use strict";(()=>{var e={};e.id=391,e.ids=[391],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},1847:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>_});var r={};a.r(r),a.d(r,{GET:()=>u,POST:()=>l});var s=a(9303),n=a(8716),i=a(670),d=a(7070),o=a(7857),c=a(5974);class m{constructor(e){let t=process.env.SUPABASE_SERVICE_ROLE_KEY;this.supabase=(0,o.eI)("https://pphzvnaedmzcvpxjulti.supabase.co",t),this.academyId=e}async getIntegrations(){let{data:e,error:t}=await this.supabase.from("academy_integrations").select("*").eq("academy_id",this.academyId).eq("status","active");if(t)throw Error(`Failed to get integrations: ${t.message}`);return e||[]}async upsertIntegration(e){let{data:t,error:a}=await this.supabase.from("academy_integrations").upsert({academy_id:this.academyId,...e,synced_at:new Date().toISOString()},{onConflict:"academy_id,provider"}).select().single();if(a)throw Error(`Failed to upsert integration: ${a.message}`);return t}async syncAll(){let e=await this.getIntegrations(),t=[];for(let a of e)try{let e=await this.syncProvider(a.provider);t.push(e)}catch(e){t.push({academy_id:this.academyId,provider:a.provider,status:"error",total_records:0,synced_records:0,created_records:0,updated_records:0,skipped_records:0,failed_records:0,started_at:new Date().toISOString(),completed_at:new Date().toISOString(),errors:[{message:e.message}]})}return t}async syncProvider(e,t){let a=process.env.NEXT_PUBLIC_BASE_URL||"http://localhost:3000",r=await fetch(`${a}/api/sync/${e}?academy_id=${this.academyId}`,{method:"GET"});if(!r.ok)throw Error(`Sync failed: ${r.statusText}`);return(await r.json()).data}async syncStudents(e){let t=new Date().toISOString(),a=0,r=0,s=0,n=0,i=[];for(let t of e)try{let e=(0,c.h5)(t);if(!e.valid){i.push({record_id:t.external_id,message:e.errors.join(", ")});continue}let d=(0,c.iR)(t),o=(0,c.N3)(d),m={...t,risk_score:d,risk_band:o,confidence_score:.75},{data:l}=await this.supabase.from("students").select("id, metadata").eq("academy_id",this.academyId).eq("external_id",t.external_id).single(),u=(0,c.Uh)(t);if(l){if(l.metadata?.hash===u){n++;continue}await this.supabase.from("students").update({...m,metadata:{...t.metadata,hash:u}}).eq("id",l.id),s++}else await this.supabase.from("students").insert({...m,metadata:{...t.metadata,hash:u}}),r++;a++}catch(e){i.push({record_id:t.external_id,message:e.message})}let d={academy_id:this.academyId,provider:e[0]?.provider||"unknown",status:0===i.length?"success":a>0?"success":"error",total_records:e.length,synced_records:a,created_records:r,updated_records:s,skipped_records:n,failed_records:i.length,started_at:t,completed_at:new Date().toISOString(),duration_ms:Date.now()-new Date(t).getTime(),errors:i.length>0?i:void 0};return await this.logSync(d),d}async getSyncHistory(e=20){let{data:t}=await this.supabase.from("sync_logs").select("*").eq("academy_id",this.academyId).order("created_at",{ascending:!1}).limit(e);return t||[]}async getStudents(e){let t=this.supabase.from("students").select("*").eq("academy_id",this.academyId);e?.riskBand&&(t=t.eq("risk_band",e.riskBand)),e?.provider&&(t=t.eq("provider",e.provider)),e?.limit&&(t=t.limit(e.limit));let{data:a}=await t.order("risk_score",{ascending:!1});return a||[]}async getRiskSummary(){let{data:e}=await this.supabase.from("students").select("risk_score, risk_band").eq("academy_id",this.academyId);return e&&0!==e.length?{total:e.length,critical:e.filter(e=>"critical"===e.risk_band).length,high:e.filter(e=>"high"===e.risk_band).length,medium:e.filter(e=>"medium"===e.risk_band).length,low:e.filter(e=>"low"===e.risk_band).length,avgRisk:Math.round(e.reduce((e,t)=>e+(t.risk_score||0),0)/e.length)}:{total:0,critical:0,high:0,medium:0,low:0,avgRisk:0}}async logSync(e){await this.supabase.from("sync_logs").insert({academy_id:this.academyId,provider:e.provider,total_records:e.total_records,synced_records:e.synced_records,status:e.status,error:e.errors?.map(e=>e.message).join("; ")}),await this.supabase.from("academy_integrations").update({synced_at:new Date().toISOString()}).eq("academy_id",this.academyId).eq("provider",e.provider)}}async function l(e){try{let{academy_id:t}=await e.json();if(!t)return d.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});let a=new m(t),r=await a.syncAll(),s={total_providers:r.length,successful:r.filter(e=>"success"===e.status).length,failed:r.filter(e=>"error"===e.status).length,total_synced:r.reduce((e,t)=>e+t.synced_records,0),total_created:r.reduce((e,t)=>e+t.created_records,0),total_updated:r.reduce((e,t)=>e+t.updated_records,0)};return d.NextResponse.json({ok:!0,data:{results:r,summary:s},message:`Synced ${s.total_synced} records from ${s.successful} providers`})}catch(e){return console.error("Sync all error:",e),d.NextResponse.json({ok:!1,error:e.message},{status:500})}}async function u(e){try{let t=e.nextUrl.searchParams.get("academy_id");if(!t)return d.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});let a=new m(t),[r,s,n]=await Promise.all([a.getIntegrations(),a.getSyncHistory(10),a.getRiskSummary()]);return d.NextResponse.json({ok:!0,data:{integrations:r,recent_syncs:s,risk_summary:n}})}catch(e){return console.error("Get sync status error:",e),d.NextResponse.json({ok:!1,error:e.message},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sync/all/route",pathname:"/api/sync/all",filename:"route",bundlePath:"app/api/sync/all/route"},resolvedPagePath:"/Users/oseho/Desktop/autus/vercel-api/app/api/sync/all/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:_,serverHooks:g}=p,y="/api/sync/all/route";function f(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:_})}},5974:(e,t,a)=>{a.d(t,{N3:()=>d,Uh:()=>n,h5:()=>i,iR:()=>o,xi:()=>s});var r=a(4770);class s{constructor(e,t){this.academyId=e,this.provider=t}mapClassting(e){return{academy_id:this.academyId,external_id:e.id,provider:"classting",name:e.name,grade:e.grade,grade_band:this.normalizeGrade(e.grade),class_name:e.class_name,parent_name:e.parent?.name,parent_phone:this.normalizePhone(e.parent?.phone),parent_email:e.parent?.email,attendance_rate:e.attendance_rate,homework_completion:e.assignment_completion,synced_at:new Date().toISOString()}}mapNarakhub(e){let t=this.parseNumber(e.등록금),a=this.parseNumber(e.미납금);return{academy_id:this.academyId,external_id:e.학생ID,provider:"narakhub",name:e.학생명,grade:e.학년,grade_band:this.normalizeGrade(e.학년),class_name:e.반,parent_name:e.학부모명,parent_phone:this.normalizePhone(e.연락처),parent_email:e.이메일,monthly_fee:t,unpaid_amount:a,payment_status:this.getPaymentStatus(a,t),attendance_rate:this.parsePercent(e.출석률),metadata:e.상담메모?{memo:e.상담메모}:void 0,synced_at:new Date().toISOString()}}mapTongtong(e){let t=this.parseNumber(e.monthly_fee),a=this.parseNumber(e.unpaid);return{academy_id:this.academyId,external_id:e.student_code,provider:"tongtong",name:e.student_name,grade:e.grade,grade_band:this.normalizeGrade(e.grade),class_name:e.class,parent_name:e.parent_name,parent_phone:this.normalizePhone(e.parent_phone),monthly_fee:t,unpaid_amount:a,payment_status:this.getPaymentStatus(a,t),attendance_rate:this.parsePercent(e.attendance_pct),recent_score:this.parseNumber(e.last_score),metadata:e.memo?{memo:e.memo}:void 0,synced_at:new Date().toISOString()}}mapACA2000(e){return{academy_id:this.academyId,external_id:e.학번,provider:"aca2000",name:e.성명,grade:e.학년,grade_band:this.normalizeGrade(e.학년),subject:e.과목,parent_phone:this.normalizePhone(e.학부모연락처),monthly_fee:e.월수강료,unpaid_amount:e.미납액,payment_status:this.getPaymentStatus(e.미납액,e.월수강료),attendance_rate:e.출석률,recent_score:e.최근점수,metadata:e.비고?{memo:e.비고}:void 0,synced_at:new Date().toISOString()}}mapSmartfit(e){let t=this.parseNumber(e.월회비),a=this.parseNumber(e.미납금);return{academy_id:this.academyId,external_id:e.회원코드,provider:"smartfit",name:e.회원명,grade_band:e.등급,parent_name:e.학부모명,parent_phone:this.normalizePhone(e.연락처),monthly_fee:t,unpaid_amount:a,payment_status:this.getPaymentStatus(a,t),attendance_rate:this.parsePercent(e.출석률),metadata:e.메모?{memo:e.메모}:void 0,synced_at:new Date().toISOString()}}mapBatch(e){return e.map(e=>{switch(this.provider){case"classting":return this.mapClassting(e);case"narakhub":return this.mapNarakhub(e);case"tongtong":return this.mapTongtong(e);case"aca2000":return this.mapACA2000(e);case"smartfit":return this.mapSmartfit(e);default:throw Error(`Unknown provider: ${this.provider}`)}})}normalizeGrade(e){if(!e)return"unknown";let t=e.toLowerCase().replace(/\s/g,"");return/초[1-6]|elementary|e[1-6]|1-6학년/.test(t)?"elementary":/중[1-3]|middle|m[1-3]|7-9학년/.test(t)?"middle":/고[1-3]|high|h[1-3]|10-12학년/.test(t)?"high":/중1/.test(t)?"middle-1":/중2/.test(t)?"middle-2":/중3/.test(t)?"middle-3":/고1/.test(t)?"high-1":/고2/.test(t)?"high-2":/고3/.test(t)?"high-3":e}normalizePhone(e){if(!e)return;let t=e.replace(/\D/g,"");return 11===t.length&&t.startsWith("010")?`${t.slice(0,3)}-${t.slice(3,7)}-${t.slice(7)}`:10===t.length?t.startsWith("02")?`${t.slice(0,2)}-${t.slice(2,6)}-${t.slice(6)}`:`${t.slice(0,3)}-${t.slice(3,6)}-${t.slice(6)}`:e}parseNumber(e){if(null==e||""===e)return 0;if("number"==typeof e)return e;let t=parseFloat(e.replace(/[₩$,원]/g,"").trim());return isNaN(t)?0:t}parsePercent(e){if(null==e||""===e)return 100;if("number"==typeof e)return e>1?e:100*e;let t=parseFloat(e.replace(/%/g,"").trim());return isNaN(t)?100:t>1?t:100*t}getPaymentStatus(e,t){return e<=0?"paid":t&&e>=t?"unpaid":"partial"}}function n(e){let t=[e.name,e.grade,e.parent_phone,e.monthly_fee,e.unpaid_amount,e.attendance_rate,e.recent_score].map(e=>String(e??"")).join("|");return r.createHash("md5").update(t).digest("hex")}function i(e){let t=[],a=[];return e.academy_id||t.push("academy_id is required"),e.external_id||t.push("external_id is required"),e.provider||t.push("provider is required"),e.name||t.push("name is required"),void 0!==e.attendance_rate&&(e.attendance_rate<0||e.attendance_rate>100)&&a.push("attendance_rate should be between 0 and 100"),void 0!==e.monthly_fee&&e.monthly_fee<0&&a.push("monthly_fee should not be negative"),void 0!==e.unpaid_amount&&e.unpaid_amount<0&&a.push("unpaid_amount should not be negative"),e.parent_phone&&!/^[\d\-]+$/.test(e.parent_phone)&&a.push("parent_phone format may be invalid"),{valid:0===t.length,errors:t,warnings:a}}function d(e){return e>=200?"critical":e>=150?"high":e>=100?"medium":"low"}function o(e){let t=0;return void 0!==e.attendance_rate&&(t+=Math.max(0,100-e.attendance_rate)),e.unpaid_amount&&e.unpaid_amount>0&&(t+=Math.min(100,20*Math.floor(e.unpaid_amount/1e5))),void 0!==e.score_change&&e.score_change<0&&(t+=Math.min(50,2*Math.abs(e.score_change))),void 0!==e.homework_completion&&(t+=Math.max(0,100-e.homework_completion)/2),Math.min(300,Math.round(t))}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,564],()=>a(1847));module.exports=r})();