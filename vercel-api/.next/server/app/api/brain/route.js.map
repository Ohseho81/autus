{"version":3,"file":"app/api/brain/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/brain/route.ts","webpack://_N_E/./app/api/brain/route.ts?6ca2","webpack://_N_E/?e41b","webpack://_N_E/./lib/claude.ts","webpack://_N_E/./lib/supabase.ts"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","// ============================================\n// AUTUS Brain API - Claude Integration\n// Edge Runtime for Low Latency\n// ============================================\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { ai } from '@/lib/claude';\nimport { db } from '@/lib/supabase';\n\nexport const runtime = 'edge';\n\n// CORS Headers\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n};\n\n// OPTIONS (CORS Preflight)\nexport async function OPTIONS() {\n  return new NextResponse(null, { status: 200, headers: corsHeaders });\n}\n\n// POST /api/brain\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { action, payload, userId } = body;\n\n    if (!action) {\n      return NextResponse.json(\n        { success: false, error: 'action is required' },\n        { status: 400, headers: corsHeaders }\n      );\n    }\n\n    let result: any;\n\n    switch (action) {\n      // 보상 카드 생성\n      case 'generate_reward_card': {\n        const { role, pain_point, orbit_distance, context_data } = payload;\n        \n        result = await ai.generateRewardCard({\n          role: role || 'owner',\n          pain_point: pain_point || 'cashflow',\n          orbit_distance: orbit_distance || 0.5,\n          context_data: context_data || {}\n        });\n\n        // DB에 저장\n        if (userId) {\n          await db.createRewardCard({\n            user_id: userId,\n            card_type: pain_point || 'general',\n            title: result.title,\n            icon: result.icon,\n            message: result.message,\n            actions: result.actions,\n            is_read: false,\n            is_acted: false\n          });\n        }\n        break;\n      }\n\n      // 데이터 분석\n      case 'analyze': {\n        const { type, data } = payload;\n        result = await ai.analyzeData({ type, data });\n        break;\n      }\n\n      // 3지 선택 생성\n      case 'generate_options': {\n        const { task_description } = payload;\n        result = await ai.generateThreeOptions(task_description);\n        break;\n      }\n\n      // 상담 일지 생성\n      case 'generate_report': {\n        const { studentName, subject, attendance, performance, notes } = payload;\n        result = await ai.generateConsultReport({\n          studentName,\n          subject,\n          attendance,\n          performance,\n          notes\n        });\n        break;\n      }\n\n      // 일일 카페 콘텐츠 생성\n      case 'generateDailyContent': {\n        const { type, topic, context } = payload || body.data || {};\n        result = await ai.generateDailyContent({\n          type: type || 'cafe_post',\n          topic,\n          context\n        });\n        break;\n      }\n\n      // 보상 카드 생성 (alternative name)\n      case 'generateRewardCard': {\n        const cardData = payload || body.data || {};\n        result = { reward_card: await ai.generateRewardCard({\n          role: cardData.role || 'owner',\n          pain_point: cardData.pain_point || 'cashflow',\n          orbit_distance: cardData.orbit_distance || 0.5,\n          context_data: cardData.context_data || {}\n        })};\n        break;\n      }\n\n      default:\n        return NextResponse.json(\n          { success: false, error: `Unknown action: ${action}` },\n          { status: 400, headers: corsHeaders }\n        );\n    }\n\n    return NextResponse.json(\n      { success: true, data: result },\n      { status: 200, headers: corsHeaders }\n    );\n\n  } catch (error: any) {\n    console.error('Brain API Error:', error);\n    return NextResponse.json(\n      { success: false, error: error.message || 'Internal server error' },\n      { status: 500, headers: corsHeaders }\n    );\n  }\n}\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/Users/oseho/Desktop/autus/vercel-api/app/api/brain/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/brain/route\",\n        pathname: \"/api/brain\",\n        filename: \"route\",\n        bundlePath: \"app/api/brain/route\"\n    },\n    resolvedPagePath: \"/Users/oseho/Desktop/autus/vercel-api/app/api/brain/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/brain/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fbrain%2Froute&page=%2Fapi%2Fbrain%2Froute&pagePath=private-next-app-dir%2Fapi%2Fbrain%2Froute.ts&appDir=%2FUsers%2Foseho%2FDesktop%2Fautus%2Fvercel-api%2Fapp&appPaths=%2Fapi%2Fbrain%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/brain/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map","// ============================================\n// AUTUS Claude AI Integration\n// ============================================\n\nimport Anthropic from '@anthropic-ai/sdk';\nimport { createClient } from '@supabase/supabase-js';\n\n// Lazy initialization to avoid build-time errors\nfunction getAnthropicClient() {\n  if (!process.env.CLAUDE_API_KEY) {\n    throw new Error('CLAUDE_API_KEY environment variable not configured');\n  }\n  return new Anthropic({\n    apiKey: process.env.CLAUDE_API_KEY,\n  });\n}\n\n// Supabase client for metrics logging\nfunction getSupabaseClient() {\n  const url = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\n// Prompt Cache 메트릭 로깅\ninterface CacheMetrics {\n  endpoint: string;\n  input_tokens: number;\n  output_tokens: number;\n  cache_creation_input_tokens?: number;\n  cache_read_input_tokens?: number;\n  response_time_ms: number;\n}\n\nasync function logCacheMetrics(metrics: CacheMetrics) {\n  const supabase = getSupabaseClient();\n  if (!supabase) return;\n\n  // Claude API 가격 (2026년 기준 추정)\n  const INPUT_COST_PER_1K = 0.003;  // $0.003 per 1K input tokens\n  const OUTPUT_COST_PER_1K = 0.015; // $0.015 per 1K output tokens\n  const CACHE_WRITE_COST_PER_1K = 0.00375; // $0.00375 per 1K (25% premium)\n  const CACHE_READ_COST_PER_1K = 0.0003;   // $0.0003 per 1K (90% discount)\n\n  const totalTokens = metrics.input_tokens + metrics.output_tokens;\n  const cacheHit = (metrics.cache_read_input_tokens || 0) > 0;\n  \n  // 비용 계산\n  const estimatedCost = \n    (metrics.input_tokens / 1000 * INPUT_COST_PER_1K) +\n    (metrics.output_tokens / 1000 * OUTPUT_COST_PER_1K) +\n    ((metrics.cache_creation_input_tokens || 0) / 1000 * CACHE_WRITE_COST_PER_1K) +\n    ((metrics.cache_read_input_tokens || 0) / 1000 * CACHE_READ_COST_PER_1K);\n\n  // 캐시로 절약한 비용 (캐시 읽기가 있으면 일반 입력 대비 절약)\n  const savings = cacheHit \n    ? (metrics.cache_read_input_tokens || 0) / 1000 * (INPUT_COST_PER_1K - CACHE_READ_COST_PER_1K)\n    : 0;\n\n  try {\n    await supabase.from('prompt_cache_metrics').insert({\n      endpoint: metrics.endpoint,\n      cache_hit: cacheHit,\n      cache_creation_input_tokens: metrics.cache_creation_input_tokens,\n      cache_read_input_tokens: metrics.cache_read_input_tokens,\n      input_tokens: metrics.input_tokens,\n      output_tokens: metrics.output_tokens,\n      total_tokens: totalTokens,\n      estimated_cost_usd: estimatedCost,\n      savings_usd: savings,\n      response_time_ms: metrics.response_time_ms\n    });\n  } catch (e) {\n    console.error('Failed to log cache metrics:', e);\n  }\n}\n\n// Types\nexport interface RewardCardRequest {\n  role: string;\n  pain_point: string;\n  orbit_distance: number;\n  context_data: Record<string, any>;\n}\n\nexport interface RewardCardAction {\n  label: string;\n  type: string;\n  requires_approval: boolean;\n  webhook_payload?: {\n    action_type: string;\n    target?: string;\n    message?: string;\n    template_id?: string;\n    metadata?: Record<string, any>;\n  };\n}\n\nexport interface RewardCardResponse {\n  title: string;\n  icon: string;\n  message: string;\n  actions: RewardCardAction[];\n}\n\nexport interface AnalysisRequest {\n  type: 'churn_risk' | 'cashflow' | 'performance' | 'engagement';\n  data: Record<string, any>;\n}\n\nexport interface AnalysisResponse {\n  summary: string;\n  risk_level: 'low' | 'medium' | 'high';\n  recommendations: string[];\n  predicted_impact: number;\n}\n\n// ============================================\n// AI Functions\n// ============================================\n\nexport const ai = {\n  /**\n   * 보상 카드 메시지 생성\n   */\n  async generateRewardCard(request: RewardCardRequest): Promise<RewardCardResponse> {\n    const startTime = Date.now();\n    \n    const systemPrompt = `너는 AUTUS의 실행형 AI 에이전트야. \n사용자의 역할과 고민에 맞는 '즉시 보상 카드'를 생성하고, 버튼 클릭 시 자동 실행할 수 있는 webhook_payload도 포함해.\n\n규칙:\n1. 숫자나 퍼센트를 직접 노출하지 마\n2. 따뜻하고 격려하는 톤 유지\n3. 즉시 행동할 수 있는 구체적 제안\n4. orbit_distance에 따라 자동화 수준 조절:\n   - 0.2 (가까이): 원클릭 자동 실행 제안\n   - 0.5 (중간): 승인 후 실행 제안\n   - 0.8 (멀리): 정보 제공만\n\n사용 가능한 action_type:\n- send_sms: 문자 발송 (알리고)\n- send_kakao: 카카오 알림톡\n- update_erp: ERP 업데이트\n- issue_reward: 리워드 발급\n- generate_report: 보고서 생성\n- sync_data: 데이터 동기화\n\nJSON 형식으로 응답:\n{\n  \"title\": \"카드 제목\",\n  \"icon\": \"이모지\",\n  \"message\": \"메인 메시지 (1-2문장)\",\n  \"actions\": [\n    {\n      \"label\": \"버튼텍스트\",\n      \"type\": \"action_type\",\n      \"requires_approval\": boolean,\n      \"webhook_payload\": {\n        \"action_type\": \"send_sms|send_kakao|update_erp|...\",\n        \"target\": \"대상 (전화번호, ID 등)\",\n        \"message\": \"실행할 메시지 내용\",\n        \"template_id\": \"템플릿 ID (선택)\",\n        \"metadata\": {}\n      }\n    }\n  ]\n}`;\n\n    const userPrompt = `역할: ${request.role}\n주요 고민: ${request.pain_point}\n자동화 거리: ${request.orbit_distance}\n컨텍스트 데이터: ${JSON.stringify(request.context_data)}\n\n이 사용자를 위한 보상 카드를 생성해.`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 500,\n      messages: [\n        { role: 'user', content: userPrompt }\n      ],\n      system: systemPrompt,\n    });\n\n    // Prompt Cache 메트릭 로깅\n    const responseTime = Date.now() - startTime;\n    logCacheMetrics({\n      endpoint: '/api/brain/generateRewardCard',\n      input_tokens: response.usage?.input_tokens || 0,\n      output_tokens: response.usage?.output_tokens || 0,\n      cache_creation_input_tokens: (response.usage as any)?.cache_creation_input_tokens,\n      cache_read_input_tokens: (response.usage as any)?.cache_read_input_tokens,\n      response_time_ms: responseTime\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      // JSON 파싱\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    // Fallback\n    return {\n      title: '오늘의 제안',\n      icon: '✨',\n      message: '새로운 기회가 준비되어 있습니다.',\n      actions: [{ label: '확인하기', type: 'view', requires_approval: false }]\n    };\n  },\n\n  /**\n   * 데이터 분석\n   */\n  async analyzeData(request: AnalysisRequest): Promise<AnalysisResponse> {\n    const startTime = Date.now();\n    \n    const typePrompts: Record<string, string> = {\n      churn_risk: '퇴원/이탈 위험 분석',\n      cashflow: '현금흐름 및 미납 분석',\n      performance: '성과 및 생산성 분석',\n      engagement: '참여도 및 만족도 분석'\n    };\n\n    const systemPrompt = `너는 AUTUS의 데이터 분석 AI야.\n${typePrompts[request.type]}을 수행하고 결과를 JSON으로 반환해.\n\n응답 형식:\n{\n  \"summary\": \"1문장 요약\",\n  \"risk_level\": \"low|medium|high\",\n  \"recommendations\": [\"추천1\", \"추천2\", \"추천3\"],\n  \"predicted_impact\": 0.0~1.0 사이 영향도\n}\n\n규칙:\n1. 구체적이고 실행 가능한 추천\n2. 숫자는 내부 분석용으로만 사용\n3. 사용자 친화적 요약 제공`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 800,\n      messages: [\n        { role: 'user', content: `분석 대상 데이터:\\n${JSON.stringify(request.data, null, 2)}` }\n      ],\n      system: systemPrompt,\n    });\n\n    // Prompt Cache 메트릭 로깅\n    const responseTime = Date.now() - startTime;\n    logCacheMetrics({\n      endpoint: `/api/brain/analyzeData/${request.type}`,\n      input_tokens: response.usage?.input_tokens || 0,\n      output_tokens: response.usage?.output_tokens || 0,\n      cache_creation_input_tokens: (response.usage as any)?.cache_creation_input_tokens,\n      cache_read_input_tokens: (response.usage as any)?.cache_read_input_tokens,\n      response_time_ms: responseTime\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    return {\n      summary: '분석이 완료되었습니다.',\n      risk_level: 'medium',\n      recommendations: ['데이터를 더 수집해 주세요.'],\n      predicted_impact: 0.5\n    };\n  },\n\n  /**\n   * 자연어 업무 → 3지 선택 생성\n   */\n  async generateThreeOptions(taskDescription: string): Promise<{\n    a: string;\n    b: string;\n    c: string;\n    meta: { a_time: string; b_time: string; c_time: string };\n  }> {\n    const systemPrompt = `사용자가 요청한 업무에 대해 정확히 3가지 선택지를 생성해.\n\n규칙:\n1) A: 가장 빠르고 간단한 방법 (T 최소화)\n2) B: 표준적이고 균형 잡힌 방법 (T 중간, s 중간)\n3) C: 장기적으로 가장 가치가 쌓이는 방법 (s 최대화)\n\n제약:\n- 각 옵션은 1문장\n- 시간은 \"짧게/보통/길게\" 범주만\n- 숫자/퍼센트 금지\n\nJSON 형식:\n{\n  \"a\": \"옵션 A 설명\",\n  \"b\": \"옵션 B 설명\", \n  \"c\": \"옵션 C 설명\",\n  \"meta\": {\"a_time\": \"짧게\", \"b_time\": \"보통\", \"c_time\": \"길게\"}\n}`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 500,\n      messages: [\n        { role: 'user', content: `업무: ${taskDescription}` }\n      ],\n      system: systemPrompt,\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    return {\n      a: '기존 방식으로 빠르게 처리',\n      b: '표준 프로세스를 따라 진행',\n      c: '자동화 시스템 구축 후 반복 활용',\n      meta: { a_time: '짧게', b_time: '보통', c_time: '길게' }\n    };\n  },\n\n  /**\n   * 일일 카페 콘텐츠 생성\n   */\n  async generateDailyContent(data: {\n    type: 'cafe_post' | 'comment' | 'dm';\n    topic?: string;\n    context?: string;\n  }): Promise<{ title?: string; content: string }> {\n    const startTime = Date.now();\n\n    const topics = ['퇴원 관리', '미수금 회수', '학부모 상담', '마케팅 노하우', '강사 관리'];\n    const randomTopic = data.topic || topics[Math.floor(Math.random() * topics.length)];\n\n    const prompts: Record<string, string> = {\n      cafe_post: `학원 원장 커뮤니티(학원노)에 올릴 가치 제공형 글을 작성해줘.\n\n주제: ${randomTopic}\n${data.context ? `추가 컨텍스트: ${data.context}` : ''}\n\n규칙:\n1. 제목 포함 ([제목] 형식)\n2. 따뜻하고 공감하는 톤\n3. 구체적인 숫자나 사례 1-2개 포함\n4. 300-500자 내외\n5. 마지막에 댓글 유도 문구\n6. 홍보성 절대 금지 - 순수 노하우 공유만\n7. 이모지 적절히 사용\n\nJSON 형식으로 응답:\n{\"title\": \"제목\", \"content\": \"본문 내용\"}`,\n      \n      comment: `학원 원장이 쓴 고민 글에 달 공감 댓글을 작성해줘.\n\n주제: ${randomTopic}\n${data.context ? `원글 내용: ${data.context}` : ''}\n\n규칙:\n1. 2-3문장으로 짧게\n2. 진심 어린 공감\n3. 구체적인 조언 1개\n4. 홍보 절대 금지\n\nJSON 형식으로 응답:\n{\"content\": \"댓글 내용\"}`,\n\n      dm: `학원 원장에게 보낼 첫 DM을 작성해줘.\n\n상황: 퇴원/미수금 고민 글을 쓴 원장님에게 연락\n${data.context ? `추가 정보: ${data.context}` : ''}\n\n규칙:\n1. 자연스럽고 부담 없는 톤\n2. 무료 파일럿 언급 (효과 없으면 0원)\n3. 통화 제안으로 마무리\n4. 100자 내외\n\nJSON 형식으로 응답:\n{\"content\": \"DM 내용\"}`\n    };\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 800,\n      messages: [\n        { role: 'user', content: prompts[data.type] || prompts.cafe_post }\n      ],\n      system: '너는 학원 운영 전문가야. 학원 원장 커뮤니티에서 신뢰받는 조언을 제공해.'\n    });\n\n    const responseTime = Date.now() - startTime;\n    logCacheMetrics({\n      endpoint: '/api/brain/generateDailyContent',\n      input_tokens: response.usage?.input_tokens || 0,\n      output_tokens: response.usage?.output_tokens || 0,\n      cache_creation_input_tokens: (response.usage as any)?.cache_creation_input_tokens,\n      cache_read_input_tokens: (response.usage as any)?.cache_read_input_tokens,\n      response_time_ms: responseTime\n    });\n\n    const text = response.content[0].type === 'text' ? response.content[0].text : '';\n    \n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        return JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      console.error('JSON parse error:', e);\n    }\n\n    return { content: text };\n  },\n\n  /**\n   * 학부모 상담 일지 자동 생성\n   */\n  async generateConsultReport(data: {\n    studentName: string;\n    subject: string;\n    attendance: number;\n    performance: string;\n    notes: string;\n  }): Promise<string> {\n    const systemPrompt = `학부모 상담 일지 초안을 작성해.\n톤: 따뜻하고 전문적\n길이: 3-4문단\n포함: 학생 강점, 개선점, 다음 목표`;\n\n    const response = await getAnthropicClient().messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 600,\n      messages: [\n        { role: 'user', content: `학생: ${data.studentName}\n과목: ${data.subject}\n출석률: ${data.attendance}%\n성취도: ${data.performance}\n메모: ${data.notes}` }\n      ],\n      system: systemPrompt,\n    });\n\n    return response.content[0].type === 'text' ? response.content[0].text : '';\n  }\n};\n","// ============================================\n// AUTUS Supabase Client\n// ============================================\n\nimport { createClient } from '@supabase/supabase-js';\n\n// Types\nexport interface User {\n  id: string;\n  email: string;\n  role_id: 'owner' | 'director' | 'teacher' | 'staff' | 'parent' | 'student';\n  affiliation_map: Record<string, string>;\n  base_capacity: number;\n  pain_point_top1: string | null;\n  sync_orbit: number;\n  current_energy: number;\n}\n\nexport interface Organism {\n  id: string;\n  user_id: string;\n  name: string;\n  type: 'teacher' | 'student' | 'parent' | 'branch' | 'class';\n  emoji: string;\n  mint: number;\n  tax: number;\n  synergy: number;\n  value_v: number;\n  entropy: number;\n  velocity: number;\n  friction: number;\n  sync_rate: number;\n  status: 'urgent' | 'warning' | 'stable' | 'opportunity';\n  urgency: number;\n}\n\nexport interface UsageLog {\n  id: string;\n  task_id: string;\n  solution_id: string;\n  user_id: string;\n  before_m: number;\n  before_t: number;\n  before_s: number;\n  after_m: number;\n  after_t: number;\n  after_s: number;\n  effectiveness_score: number;\n  v_growth: number;\n  duration_minutes: number;\n}\n\nexport interface RewardCard {\n  id: string;\n  user_id: string;\n  card_type: string;\n  title: string;\n  icon: string;\n  message: string;\n  actions: { label: string; type: string; requires_approval: boolean }[];\n  is_read: boolean;\n  is_acted: boolean;\n}\n\n// Lazy initialization to avoid build-time errors\nlet _supabaseAdmin: ReturnType<typeof createClient> | null = null;\nlet _supabaseClient: ReturnType<typeof createClient> | null = null;\n\n// Client (Server-side with service role)\nexport const supabaseAdmin = (() => {\n  if (!_supabaseAdmin && process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    _supabaseAdmin = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL,\n      process.env.SUPABASE_SERVICE_ROLE_KEY,\n      {\n        auth: {\n          autoRefreshToken: false,\n          persistSession: false\n        }\n      }\n    );\n  }\n  return _supabaseAdmin;\n})();\n\n// Client (Client-side with anon key)\nexport const supabaseClient = (() => {\n  if (!_supabaseClient && process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {\n    _supabaseClient = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n    );\n  }\n  return _supabaseClient;\n})();\n\n// Helper to get admin client (throws at runtime if not configured)\nexport function getSupabaseAdmin() {\n  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.SUPABASE_SERVICE_ROLE_KEY) {\n    throw new Error('Supabase environment variables not configured');\n  }\n  return createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL,\n    process.env.SUPABASE_SERVICE_ROLE_KEY,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  );\n}\n\n// ============================================\n// Database Functions\n// ============================================\n\nexport const db = {\n  // Users\n  async getUser(userId: string): Promise<User | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('users')\n      .select('*')\n      .eq('id', userId)\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async updateUserKernel(userId: string, updates: Partial<User>): Promise<boolean> {\n    const client = getSupabaseAdmin();\n    const { error } = await client\n      .from('users')\n      .update(updates)\n      .eq('id', userId);\n    \n    return !error;\n  },\n\n  // Organisms\n  async getOrganisms(userId: string): Promise<Organism[]> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('organisms')\n      .select('*')\n      .eq('user_id', userId)\n      .order('urgency', { ascending: false });\n    \n    if (error) return [];\n    return data;\n  },\n\n  async getOrganism(organismId: string): Promise<Organism | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('organisms')\n      .select('*')\n      .eq('id', organismId)\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async updateOrganism(organismId: string, updates: Partial<Organism>): Promise<boolean> {\n    const client = getSupabaseAdmin();\n    const { error } = await client\n      .from('organisms')\n      .update(updates)\n      .eq('id', organismId);\n    \n    return !error;\n  },\n\n  // Usage Logs\n  async createUsageLog(log: Omit<UsageLog, 'id'>): Promise<UsageLog | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('usage_logs')\n      .insert(log)\n      .select()\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async getSolutionRanking(taskId?: string) {\n    const client = getSupabaseAdmin();\n    let query = client\n      .from('solution_ranking')\n      .select('*');\n    \n    if (taskId) {\n      query = query.eq('task_id', taskId);\n    }\n    \n    const { data, error } = await query.order('avg_score', { ascending: false });\n    \n    if (error) return [];\n    return data;\n  },\n\n  // Reward Cards\n  async createRewardCard(card: Omit<RewardCard, 'id'>): Promise<RewardCard | null> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('reward_cards')\n      .insert(card)\n      .select()\n      .single();\n    \n    if (error) return null;\n    return data;\n  },\n\n  async getUnreadRewards(userId: string): Promise<RewardCard[]> {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('reward_cards')\n      .select('*')\n      .eq('user_id', userId)\n      .eq('is_read', false)\n      .order('created_at', { ascending: false });\n    \n    if (error) return [];\n    return data;\n  },\n\n  // V Leaderboard\n  async getLeaderboard(limit = 10) {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('v_leaderboard')\n      .select('*')\n      .order('rank', { ascending: true })\n      .limit(limit);\n    \n    if (error) return [];\n    return data;\n  },\n\n  // Standards\n  async getStandard(taskId: string) {\n    const client = getSupabaseAdmin();\n    const { data, error } = await client\n      .from('standards')\n      .select('*, solutions(*)')\n      .eq('task_id', taskId)\n      .single();\n    \n    if (error) return null;\n    return data;\n  }\n};\n"],"names":["module","exports","require","runtime","corsHeaders","OPTIONS","NextResponse","status","headers","POST","request","result","body","json","action","payload","userId","success","error","role","pain_point","orbit_distance","context_data","ai","generateRewardCard","db","createRewardCard","user_id","card_type","title","icon","message","actions","is_read","is_acted","type","data","analyzeData","task_description","generateThreeOptions","studentName","subject","attendance","performance","notes","generateConsultReport","topic","context","generateDailyContent","cardData","reward_card","console","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fbrain_2Froute_ts_page_2Fapi_2Fbrain_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGYnJhaW4lMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRmJyYWluJTJGcm91dGUmcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZicmFpbiUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRm9zZWhvJTJGRGVza3RvcCUyRmF1dHVzJTJGdmVyY2VsLWFwaSUyRmFwcCZhcHBQYXRocz0lMkZhcGklMkZicmFpbiUyRnJvdXRlJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEIQ_3D_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap","getAnthropicClient","process","env","CLAUDE_API_KEY","Anthropic","apiKey","logCacheMetrics","metrics","supabase","getSupabaseClient","url","SUPABASE_URL","key","SUPABASE_SERVICE_ROLE_KEY","createClient","totalTokens","input_tokens","output_tokens","cacheHit","cache_read_input_tokens","estimatedCost","cache_creation_input_tokens","savings","INPUT_COST_PER_1K","from","insert","endpoint","cache_hit","total_tokens","estimated_cost_usd","savings_usd","response_time_ms","e","startTime","Date","now","systemPrompt","userPrompt","JSON","stringify","response","messages","create","model","max_tokens","content","system","responseTime","usage","text","jsonMatch","match","parse","label","requires_approval","typePrompts","churn_risk","cashflow","engagement","summary","risk_level","recommendations","predicted_impact","taskDescription","b","c","meta","a_time","b_time","c_time","topics","randomTopic","Math","floor","random","length","prompts","cafe_post","comment","dm","_supabaseClient","getSupabaseAdmin","auth","autoRefreshToken","persistSession","getUser","client","select","eq","single","updateUserKernel","updates","update","getOrganisms","order","ascending","getOrganism","organismId","updateOrganism","createUsageLog","log","getSolutionRanking","taskId","query","card","getUnreadRewards","getLeaderboard","limit","getStandard"],"sourceRoot":""}