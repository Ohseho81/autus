"use strict";(()=>{var e={};e.id=586,e.ids=[586],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7546:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>f,routeModule:()=>g,serverHooks:()=>k,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{GET:()=>h,POST:()=>p});var i=r(9303),n=r(8716),s=r(670),o=r(7070),d=r(7857);let c={attendance:.3,homework:.25,grade:.2,payment:.15,parent_engagement:.1,version:1,updated_at:new Date().toISOString()},u=process.env.SUPABASE_SERVICE_ROLE_KEY,l=(0,d.eI)("https://pphzvnaedmzcvpxjulti.supabase.co",u);async function p(e){try{let{student_id:t,academy_id:r}=await e.json();if(!t||!r)return o.NextResponse.json({ok:!1,error:"student_id and academy_id are required"},{status:400});let{data:a,error:i}=await l.from("students").select("*").eq("external_id",t).eq("academy_id",r).single();if(i||!a)return o.NextResponse.json({ok:!1,error:"Student not found"},{status:404});let{data:n}=await l.from("student_signals").select("*").eq("student_id",t).eq("academy_id",r).single(),s=await _(r),d=m(a,n,s);return await l.from("students").update({risk_score:d.risk_score,risk_band:d.risk_band,confidence_score:d.confidence}).eq("id",a.id),o.NextResponse.json({ok:!0,data:d})}catch(e){return console.error("V-Pulse error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}async function h(e){try{let t=e.nextUrl.searchParams.get("academy_id"),r=e.nextUrl.searchParams.get("risk_band");if(!t)return o.NextResponse.json({ok:!1,error:"academy_id is required"},{status:400});let a=l.from("students").select("*").eq("academy_id",t);r&&(a=a.eq("risk_band",r));let{data:i,error:n}=await a;if(n)return o.NextResponse.json({ok:!1,error:n.message},{status:500});let s=await _(t),d=[];for(let e of i||[]){let{data:r}=await l.from("student_signals").select("*").eq("student_id",e.external_id).eq("academy_id",t).single(),a=m(e,r,s);d.push(a),await l.from("students").update({risk_score:a.risk_score,risk_band:a.risk_band,confidence_score:a.confidence}).eq("id",e.id)}let c={total:d.length,critical:d.filter(e=>"critical"===e.risk_band).length,high:d.filter(e=>"high"===e.risk_band).length,medium:d.filter(e=>"medium"===e.risk_band).length,low:d.filter(e=>"low"===e.risk_band).length,avg_risk:d.reduce((e,t)=>e+t.risk_score,0)/d.length||0,avg_confidence:d.reduce((e,t)=>e+t.confidence,0)/d.length||0};return o.NextResponse.json({ok:!0,data:{students:d,summary:c}})}catch(e){return console.error("V-Pulse batch error:",e),o.NextResponse.json({ok:!1,error:e.message},{status:500})}}function m(e,t,r){let a=[],i=0,n=0,s=e.attendance_rate??100;s<100&&(i+=Math.max(0,100-s)*r.attendance*3,n++,s<80&&a.push({type:"attendance",severity:s<60?"critical":"high",description:`출석률 ${s}% (기준 80% 미만)`}));let o=t?.homework_missed??0;o>0&&(i+=Math.min(75,15*o)*r.homework*3,n++,o>=2&&a.push({type:"homework",severity:o>=5?"critical":o>=3?"high":"medium",description:`과제 미제출 ${o}회`}));let d=e.score_change??t?.recent_score_change??0;d<0&&(i+=Math.min(50,2*Math.abs(d))*r.grade*2.5,n++,d<=-10&&a.push({type:"grade",severity:d<=-20?"critical":"high",description:`성적 ${d}점 하락`}));let c=e.unpaid_amount??t?.unpaid_amount??0,u=e.monthly_fee??35e4;if(c>0){let e=Math.min(3,c/u);i+=Math.min(100,35*e)*r.payment*3,n++,a.push({type:"payment",severity:e>=2?"critical":e>=1?"high":"medium",description:`미납금 ${c.toLocaleString()}원 (${Math.round(10*e)/10}개월분)`})}let l=Math.min(300,Math.round(i)),p=Math.min(1,(n+1)/4),h=a.length>0?.8:.5,m=l>=200?"critical":l>=150?"high":l>=100?"medium":"low",_=function(e,t,r){if(e<80)return;let a=r.some(e=>"critical"===e.severity),i=r.some(e=>"high"===e.severity),n=r.find(e=>"payment"===e.type),s=r.find(e=>"attendance"===e.type);return a||e>=200?{type:"EMERGENCY",priority:1,reason:`긴급 상담 필요: ${r[0]?.description||"복합 위험 감지"}`}:i||e>=150?{type:"ATTENTION",priority:2,reason:n?.description||s?.description||"위험 신호 감지"}:e>=100?{type:"INSIGHT",priority:3,reason:"예방적 관심 권장"}:void 0}(l,0,a);return{student_id:e.external_id,academy_id:e.academy_id,risk_score:l,risk_band:m,confidence:Math.round((.6*p+.4*h)*100)/100,signals:a,suggested_card:_,calculated_at:new Date().toISOString()}}async function _(e){try{let{data:t}=await l.from("academy_settings").select("feature_weights").eq("academy_id",e).single();if(t?.feature_weights)return t.feature_weights}catch{}return c}let g=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/brain/v-pulse/route",pathname:"/api/brain/v-pulse",filename:"route",bundlePath:"app/api/brain/v-pulse/route"},resolvedPagePath:"/Users/oseho/Desktop/autus/vercel-api/app/api/brain/v-pulse/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:k}=g,v="/api/brain/v-pulse/route";function w(){return(0,s.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:y})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,564],()=>r(7546));module.exports=a})();