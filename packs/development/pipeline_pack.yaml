name: dev_pipeline
version: 1.0.0
description: "기능 요청부터 완성까지 전체 파이프라인 실행"
author: "AUTUS Core"

metadata:
  category: development
  tags: [pipeline, orchestration, meta]
  requires_llm: true
  requires_packs: [dev_architect, dev_codegen, dev_testgen]

llm:
  provider: anthropic
  model: claude-sonnet-4-20250514
  temperature: 0.1
  max_tokens: 4000

cells:
  - name: execute_pipeline
    description: "전체 개발 파이프라인 실행"
    prompt: |
      다음 기능을 완전히 구현하는 파이프라인을 실행합니다:
      
      기능: {feature_description}
      
      단계:
      1. architect_pack으로 계획 생성
      2. 각 파일마다 codegen_pack으로 코드 생성
      3. 각 파일마다 testgen_pack으로 테스트 생성
      4. 테스트 실행
      5. 실패시 자동 수정 (최대 3회)
      
      현재 단계를 JSON으로 출력:
      {
        "current_step": "planning or coding or testing or fixing or done",
        "progress": "50 percent",
        "next_action": "run_architect"
      }
    output: pipeline_status

workflow:
  steps:
    - name: plan
      pack: dev_architect
      input:
        feature_description: "{feature_description}"
      output: plan
      
    - name: generate_code
      pack: dev_codegen
      for_each: "{plan.file_plan.files}"
      input:
        file_path: "{item.path}"
        purpose: "{item.purpose}"
        dependencies: "{item.dependencies}"
        key_functions: "{item.key_functions}"
        estimated_lines: "{item.estimated_lines}"
      output: generated_files
      
    - name: generate_tests
      pack: dev_testgen
      for_each: "{generated_files}"
      input:
        source_file: "{item.path}"
        source_code: "{item.content}"
        module_name: "{item.module_name}"
      output: test_files
      
    - name: run_tests
      command: "pytest tests/ -v"
      retry_on_failure: true
      max_retries: 3
      
    - name: fix_on_failure
      condition: "{run_tests.failed}"
      pack: dev_codegen
      input:
        file_path: "{run_tests.failed_file}"
        error_message: "{run_tests.error}"
        fix_mode: true
      output: fixed_files

output:
  format: json
  schema:
    type: object
    properties:
      status: string
      files_created: array
      tests_created: array
      tests_passed: boolean
      duration_seconds: number

actions:
  - type: write_file
    path: ".autus/pipelines/{feature_name}_result.json"
    content: "{output}"
    
  - type: git_commit
    message: "feat: {feature_name} - Auto-generated by AUTUS"
    files: "{output.files_created}"
    
  - type: log
    message: "Pipeline completed: {feature_name}"
    level: info

error_handling:
  retry_count: 1
  on_error: "rollback_and_log"
  rollback_steps:
    - "git reset --hard HEAD"
    - "rm -rf {generated_files}"
