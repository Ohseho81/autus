{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "LimePass RulePack Schema",
  "description": "Schema for defining RulePacks that evaluate events and trigger flows",
  "type": "object",
  "properties": {
    "pack_id": {
      "type": "string",
      "pattern": "^RulePack::[A-Za-z]+$"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "description": {
      "type": "string"
    },
    "listens_to": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^EVT::[A-Z_]+$"
      },
      "description": "Events this RulePack evaluates"
    },
    "conditions": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "field": { "type": "string" },
          "op": {
            "type": "string",
            "enum": ["==", "!=", ">=", "<=", ">", "<", "in", "not_in", "contains", "exists"]
          },
          "value": {},
          "weight": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Optional weight for partial matching (0-1)"
          },
          "required": {
            "type": "boolean",
            "default": true
          }
        },
        "required": ["id", "field", "op", "value"]
      }
    },
    "evaluation_mode": {
      "type": "string",
      "enum": ["all", "any", "weighted"],
      "default": "all",
      "description": "all=AND, any=OR, weighted=threshold-based"
    },
    "threshold": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "For weighted mode, minimum score to pass"
    },
    "on_pass": {
      "type": "object",
      "properties": {
        "trigger_flow": {
          "type": "string",
          "pattern": "^Flow::[A-Z_]+$"
        },
        "emit_event": {
          "type": "string",
          "pattern": "^EVT::[A-Z_]+$"
        },
        "notify": {
          "type": "array",
          "items": { "type": "string" }
        },
        "log_level": {
          "type": "string",
          "enum": ["info", "warn", "critical"]
        }
      }
    },
    "on_fail": {
      "type": "object",
      "properties": {
        "retry_after_seconds": { "type": "integer" },
        "fallback_flow": {
          "type": "string",
          "pattern": "^Flow::[A-Z_]+$"
        },
        "notify": {
          "type": "array",
          "items": { "type": "string" }
        },
        "log_level": {
          "type": "string",
          "enum": ["info", "warn", "critical"]
        }
      }
    },
    "delta_overrides": {
      "type": "object",
      "description": "Country-specific overrides keyed by country code",
      "additionalProperties": {
        "type": "object"
      }
    }
  },
  "required": ["pack_id", "version", "conditions", "on_pass"]
}
