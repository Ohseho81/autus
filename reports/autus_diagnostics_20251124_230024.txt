=== AUTUS DIAGNOSTICS :: 20251124_230024 ===

## 1. PYTHON & PACKAGES
Python 3.14.0

# ì£¼ìš” íŒ¨í‚¤ì§€ ë²„ì „
anthropic          0.74.1
fastapi            0.121.3
openai             2.8.1
pyzbar             0.1.9
uvicorn            0.38.0

## 2. GIT STATUS
## master
 D ....
 M .envrc
 M .github/workflows/armp.yml
 M ARCHITECTURE_REVIEW.md
 D ARMP_V2_COMPLETE.md
 D CURSOR_COMMANDS.txt
 D CURSOR_REMAINING_TASKS.md
 D CURSOR_TASKS.md
 D CURSOR_TASKS_QUICK.md
 D CURSOR_WORK_COMPLETE.md
 D DEVELOPMENT_STRATEGY.md
 D DEVELOPMENT_TODO.md
 D PROJECT_FINAL_STATUS.md
 D SESSION_FINAL_SUMMARY.md
 D analyze_structure.py
 D auto_develop_all.sh
 D auto_develop_critical.sh
 D auto_generate_all.sh
 D benchmark_performance.py
 D check_progress.sh
 D check_runner.sh
 M config.py
 M core/armp/performance.py
 M core/armp/risk_plan.md
 M core/armp/risks_api_external.py
 M core/armp/risks_data_integrity.py
 M core/armp/risks_data_management.py
 M core/armp/risks_files_network.py
 M core/armp/risks_final.py
 M core/armp/risks_performance_monitoring.py
 M core/armp/risks_protocol_compliance.py
 M core/armp/risks_security_advanced.py
 M core/armp/scanners/code_scanner.py
 M core/armp/scanners/constitution_checker.py
 M core/cli/commands/__init__.py
 M core/cli/commands/armp.py
 M core/cli/commands/memory.py
 M core/cli/commands/protocol.py
 M core/exceptions.py
 M core/llm/cost_tracker.py
 M core/llm/retry.py
 M core/pack/code_validator.py
 M core/utils/files.py
 M core/utils/json_utils.py
 M core/utils/logging.py
 M core/utils/paths.py
 D demo_identity.py
 D demo_real_working.sh
 M docs/api/armp.md
 M docs/api/auth.md
 M docs/api/identity.md
 M docs/api/memory_os.md
 M docs/api/workflow.md
 D docs/archive/FOLDER_STRUCTURE_ANALYSIS.md
 D docs/archive/IMPLEMENTATION_ORDER.md
 D docs/archive/IMPLEMENTATION_REQUIREMENTS.md
 D docs/archive/PROGRESS.md
 D docs/archive/RISK_MANAGEMENT.md
 D docs/archive/TASK_CATEGORIZATION.md
 D docs/archive/WEEK0_COMPLETE.md
 D docs/archive/WEEK3_PLAN.md
 D docs/archive/feedback.md
 D docs/archive/file.md
 M docs/examples/armp_example.py
 M docs/examples/auth_example.py
 M docs/examples/identity_example.py
 M docs/examples/memory_example.py
 M docs/examples/pack_example.py
 M docs/examples/workflow_example.py
 M docs/guides/best_practices.md
 M docs/guides/migration.md
 M docs/guides/troubleshooting.md
 D docs/planning/MILESTONE_ACHIEVED.md
 D docs/planning/NEXT_SESSION.md
 D docs/planning/NEXT_SESSION_TASKS.md
 D docs/planning/ROADMAP.md
 M docs/protocols/workflow.md
 D docs/reports/COMPLETENESS_CHECK.md
 D docs/reports/FINAL_CHECK.md
 D docs/reports/FINAL_SESSION_REPORT.md
 D docs/reports/FIXES_SUMMARY.md
 D docs/reports/SESSION_SUMMARY_2024-11-22.md
 D docs/reports/STATUS_SUMMARY.md
 D docs/reports/WEEK1_SUMMARY.md
 D extract_generated_code.py
 D final_status.sh
 D fix_compatibility.py
 D fix_final.py
 D fix_paths.py
 D fix_runner.py
 D optimize_autus.sh
 D organize_files.py
 D organize_protocols.sh
 D paths.py
 M protocols/identity/pattern_tracker.py
 M protocols/identity/surface.py
 M protocols/identity/tracker.py
 D prototype_demo.sh
 D quick_test.sh
 D run_tests.sh
 M server/main.py
 D show_all_docs.sh
 D show_completion.sh
 M standard.py
 D test_protocols.sh
 M tests/armp/test_all_risks.py
 M tests/armp/test_enforcer_advanced.py
 M tests/armp/test_integration.py
 M tests/armp/test_monitor_advanced.py
 M tests/performance/test_load.py
 M tests/protocols/auth/test_advanced_sync.py
 M tests/protocols/auth/test_auth_integration_advanced.py
 M tests/protocols/identity/test_identity.py
 M tests/protocols/identity/test_pattern_tracker.py
 M tests/protocols/memory/test_memory_os.py
 M tests/protocols/workflow/test_workflow.py
 D update_docs.py
 D update_rfc_full.py
 D view_docs.sh
?? .cursorignore
?? AUTUS_PROJECT.backup.20251124151737
?? autus_diagnostics_20251124_230024.txt
?? docs/cells/
?? docs/packs/
?? packs/autogen_cells_autogen.py
?? packs/device_bridge_autogen.py
?? packs/emo_cmms_autogen.py
?? packs/erp_adapter_autogen.py
?? packs/flow_orchestrator_autogen.py
?? packs/habit_tracker_autogen.py
?? packs/hello_autogen.py
?? packs/history_timeline_autogen.py
?? packs/identity_core_autogen.py
?? packs/jeju_school_autogen.py
?? packs/local_memory_autogen.py
?? packs/meta_tester_autogen.py
?? packs/nba_atb_autogen.py
?? packs/pack_factory_autogen.py
?? packs/pattern_learner_autogen.py
?? packs/preference_vector_autogen.py
?? packs/privacy_guard_autogen.py
?? packs/risk_monitor_autogen.py
?? packs/runtime_controller_autogen.py
?? packs/saas_adapter_autogen.py
?? packs/style_analyzer_autogen.py
?? packs/zero_identity_autogen.py
?? scripts/
?? server/routes/

## 3. PROJECT DIR TREE (DEPTH 2)
.
./__pycache__
./.git
./.git/hooks
./.git/info
./.git/logs
./.git/objects
./.git/refs
./.github
./.github/workflows
./.pytest_cache
./.pytest_cache/v
./.venv
./.venv/bin
./.venv/include
./.venv/lib
./.vscode
./core
./core/__pycache__
./core/{engine,llm,pack,learning}
./core/armp
./core/cli
./core/connector
./core/data
./core/engine
./core/learning
./core/llm
./core/pack
./core/registry
./core/runtime
./core/utils
./data
./data/local
./data/local_test
./data/patterns
./data/styles
./docs
./docs/api
./docs/architecture
./docs/business
./docs/cells
./docs/concepts
./docs/examples
./docs/guides
./docs/packs
./docs/protocols
./docs/public
./docs/rfc
./packs
./packs/__pycache__
./packs/{development,examples,integration}
./packs/development
./packs/examples
./protocols
./protocols/__pycache__
./protocols/{identity,workflow,memory,auth}
./protocols/auth
./protocols/identity
./protocols/logging
./protocols/memory
./protocols/workflow
./scripts
./server
./server/__pycache__
./server/routes
./tests
./tests/__pycache__
./tests/armp
./tests/connector
./tests/data
./tests/integration
./tests/learning
./tests/performance
./tests/protocols
./tests/wisdom

## 4. KEY CONFIG FILE SNAPSHOT (ìƒìœ„ 120ì¤„)
------------------------------
# FILE: AUTUS_PROJECT.yaml
------------------------------
version: 3.0
project: autus-core
core:
  version: "3.0"
  description: "AI Sovereign OS Core"
axes:
  - id: self_gen
    name: "Self-Generation"
    description: "AUTUSê°€ AUTUSë¥¼ ë§Œë“œëŠ” ìê¸°ìƒì„± ì¶•"
    status: "alpha"
  - id: sovereign
    name: "Sovereign"
    description: "ë¡œì»¬ ì£¼ê¶ŒÂ·ë°ì´í„° ì†Œìœ ë¥¼ ë³´ì¥í•˜ëŠ” ì¶•"
    status: "alpha"
  - id: identity_3d
    name: "3D Identity"
    description: "ì‚¬ìš©ì/ì‹œìŠ¤í…œ ìƒíƒœë¥¼ 3Dë¡œ í‘œí˜„í•˜ëŠ” ì¶•"
    status: "alpha"
  - id: self_learning
    name: "Self-Learning"
    description: "ë°˜ë³µ ì‚¬ìš©ì„ í†µí•´ ìŠ¤ìŠ¤ë¡œ í•™ìŠµÂ·ê°œì„ í•˜ëŠ” ì¶•"
    status: "alpha"
  - id: adapter
    name: "Adapter"
    description: "ERP/SAAS/ë¡œì»¬ì•± ë“± ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ ì—°ê²°í•˜ëŠ” ì¶•"
    status: "alpha"
  - id: control_core
    name: "Control Core"
    description: "ê°€ì¥ ì‘ì€ í†µì œê¶Œê³¼ ì „ì²´ ëŸ°íƒ€ì„ ì œì–´ ì¶•"
    status: "alpha"
modules:
  - id: identity_core
    axis: identity_3d
    kind: core
    description: "3D ì•„ì´ë´í‹°í‹°ì˜ ì¤‘ì‹¬ ì¢Œí‘œ/í‘œë©´ ì •ì˜"
  - id: history_timeline
    axis: identity_3d
    kind: view
    description: "ì‹œê°„ì— ë”°ë¥¸ í–‰ë™Â·ê²°ì •ì˜ ê¶¤ì "
  - id: preference_vector
    axis: identity_3d
    kind: model
    description: "ì„ í˜¸Â·ìŠ¤íƒ€ì¼Â·ê²°ì • íŒ¨í„´ í‘œí˜„"
  - id: local_memory
    axis: sovereign
    kind: storage
    description: "ë¡œì»¬ ë©”ëª¨ë¦¬/íˆìŠ¤í† ë¦¬ ì €ì¥ ê³„ì¸µ"
  - id: privacy_guard
    axis: sovereign
    kind: policy
    description: "ë°ì´í„° ìœ ì¶œ ë¶ˆê°€ ì•„í‚¤í…ì²˜ ì •ì±…"
  - id: zero_identity
    axis: sovereign
    kind: protocol
    description: "PII ì—†ëŠ” ì œë¡œ ì•„ì´ë´í‹°í‹° í”„ë¡œí† ì½œ"
  - id: autogen_cells
    axis: self_gen
    kind: engine
    description: "ì…€(JSON) ê¸°ë°˜ ì½”ë“œ ìë™ìƒì„± ì—”ì§„"
  - id: pack_factory
    axis: self_gen
    kind: builder
    description: "Pack/Test/Docs/Routerë¥¼ ì¡°ë¦½í•˜ëŠ” íŒ© íŒ©í† ë¦¬"
  - id: meta_tester
    axis: self_gen
    kind: tester
    description: "AUTUSê°€ AUTUSë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë©”íƒ€ í…ŒìŠ¤í„°"
  - id: pattern_learner
    axis: self_learning
    kind: engine
    description: "ì‚¬ìš©ì/ì‹œìŠ¤í…œ íŒ¨í„´ í•™ìŠµ ì—”ì§„"
  - id: style_analyzer
    axis: self_learning
    kind: analyzer
    description: "ìŠ¤íƒ€ì¼/í†¤/ì„ í˜¸ ë¶„ì„ ëª¨ë“ˆ"
  - id: habit_tracker
    axis: self_learning
    kind: tracker
    description: "ë°˜ë³µ í–‰ë™/ìŠµê´€ ì¶”ì  ëª¨ë“ˆ"
  - id: saas_adapter
    axis: adapter
    kind: adapter
    description: "Notion/Jira/Slack ë“± SAASì™€ ì—°ê²°"
  - id: erp_adapter
    axis: adapter
    kind: adapter
    description: "ERP/CMMS/WorkOS ë“±ê³¼ ì—°ê²°"
  - id: device_bridge
    axis: adapter
    kind: bridge
    description: "ë§¥/íŒ¨ë“œ/ëª¨ë°”ì¼/ì„œë²„ ê°„ ë¸Œë¦¬ì§€"
  - id: runtime_controller
    axis: control_core
    kind: controller
    description: "ì „ì²´ ë£¨í”„ì™€ ìš°ì„ ìˆœìœ„ë¥¼ í†µì œí•˜ëŠ” ì½”ì–´"
  - id: risk_monitor
    axis: control_core
    kind: monitor
    description: "ë¦¬ìŠ¤í¬/ì´ìƒ ì§•í›„ ëª¨ë‹ˆí„°ë§ ëª¨ë“ˆ"
  - id: flow_orchestrator
    axis: control_core
    kind: orchestrator
    description: "Pack/Workflow ì‹¤í–‰ ìˆœì„œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜"
  - id: 3d_shell
    axis: control_core
    kind: ui
    description: "3D Force-Directed ì…¸(UI)"
autogen:
  enabled: true
  generate:
    pack: true
    test: true
    docs: true
    router: true
folders:
  core: "core/"
  packs: "packs/"
  routers: "server/routes/"
  docs: "docs/"
  cells: "docs/cells/"

------------------------------
# FILE: CONSTITUTION.md
------------------------------
# AUTUS Constitution
## The Five Fundamental Principles
```
Version: 1.0.0
Established: 2024
Status: Immutable
```

---

## Article I: Zero Identity

### Principle
**AUTUS shall never store, request, or require user identity.**

### Implementation
- No login system
- No email collection
- No names, no accounts
- No authentication servers
- No user databases with identity fields

### Technology
**3D Living Form Identity**
- Core: Immutable seed (32 bytes, local-only)
- Surface: Evolving characteristics
- Representation: Three.js 3D form
- Storage: Local device only
- Sync: QR code between devices (no server transmission)

### Rationale
Identity is the root of surveillance capitalism. By eliminating identity at the protocol level, AUTUS creates structural impossibility for data exploitation. Users own their complete digital presence.

---

## Article II: Privacy by Architecture

### Principle
**Privacy is not a featureÃ¢â‚¬â€it is the foundation.**

### Database Design
**Prohibited Fields:**
- Ã¢ÂÅ’ `user_id`
- Ã¢ÂÅ’ `email`
- Ã¢ÂÅ’ `name`
- Ã¢ÂÅ’ `phone`
- Ã¢ÂÅ’ `address`
- Ã¢ÂÅ’ Any personally identifiable information

**Allowed Fields:**
- Ã¢Å“â€¦ Behavioral characteristics
- Ã¢Å“â€¦ Preference patterns
- Ã¢Å“â€¦ Workflow data
- Ã¢Å“â€¦ Anonymous metrics
- Ã¢Å“â€¦ Capability profiles

### Data Storage
- All personal data: Local device
- Server storage: Only anonymous aggregates
- No data mining possible
- No third-party sharing possible
- GDPR compliant by design (no PII to regulate)

### Rationale
Traditional systems add privacy features after building surveillance infrastructure. AUTUS inverts this: surveillance is architecturally impossible.

---

## Article III: Meta-Circular Development

### Principle
**AUTUS develops itself.**

### Implementation
**Development Pack System:**
- `architect_pack`: Plans features
- `codegen_pack`: Generates code
- `testgen_pack`: Writes tests
- `pipeline_pack`: Orchestrates everything

### Process
```
User: "Add 3D Identity System"
Ã¢â€ â€œ
AUTUS: Architect Ã¢â€ â€™ Code Ã¢â€ â€™ Test Ã¢â€ â€™ Deploy
Ã¢â€ â€œ
Feature: Complete in minutes, not weeks
```

### Self-Evolution
- AUTUS reads its own code
- AUTUS improves its own architecture
- AUTUS generates new capabilities
- No human bottleneck for development

### Rationale
The only way to compete with billion-dollar companies is to eliminate development time. Meta-circular development makes AUTUS evolve at AI speed, not human speed.

---

## Article IV: Minimal Core, Infinite Extension

### Principle
**Core must be tiny. Extensions must be limitless.**

### Architecture
**Core (300 lines):**
- PER Loop (Plan-Execute-Review)
- Pack System
- LLM Integration
- Minimal orchestration

**Everything Else (Packs):**
- Identity system Ã¢â€ â€™ Pack
- Database Ã¢â€ â€™ Pack
- UI components Ã¢â€ â€™ Pack
- API integrations Ã¢â€ â€™ Pack
- Business logic Ã¢â€ â€™ Pack

### Pack Philosophy

------------------------------
# FILE: pyproject.toml
------------------------------
[project]
name = "autus"
version = "0.1.0"
description = "Autus - ìë™í™”ëœ ì…€ ê¸°ë°˜ ì‹¤í–‰ í”Œë«í¼"
requires-python = ">=3.11"

[tool.ruff]
# Ruff ì„¤ì •
line-length = 100
target-version = "py311"
exclude = [
    ".git",
    ".venv*",
    "__pycache__",
    "*.pyc",
    "build",
    "dist",
    ".pytest_cache",
    ".mypy_cache",
    "node_modules",
]

[tool.ruff.lint]
# í™œì„±í™”í•  ë¦°íŠ¸ ê·œì¹™
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "B",   # flake8-bugbear
    "C4",  # flake8-comprehensions
    "UP",  # pyupgrade
]
ignore = [
    "E501",  # line too long (handled by formatter)
    "B008",  # do not perform function calls in argument defaults
    "C901",  # too complex
]

[tool.ruff.lint.isort]
known-first-party = ["core", "routers", "packs", "tools"]

[tool.ruff.format]
# í¬ë§·í„° ì„¤ì •
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"

[tool.black]
# Black ì„¤ì • (Ruffì™€ í˜¸í™˜)
line-length = 100
target-version = ['py311']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.venv
  | \.venv311
  | __pycache__
  | build
  | dist
  | \.pytest_cache
  | \.mypy_cache
)/
'''

[tool.mypy]
# mypy ì„¤ì • (ì„ íƒì‚¬í•­)
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = [
    "packs.*",
    "tools.*",
]
ignore_missing_imports = true

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = "-v --tb=short"



------------------------------
# FILE: config.py
------------------------------
"""
AUTUS í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì •
ëª¨ë“  ê²½ë¡œëŠ” ì—¬ê¸°ì„œ ì¤‘ì•™ ê´€ë¦¬

ì´ íŒŒì¼ì€ AUTUS í”„ë¡œì íŠ¸ì˜ í´ë” êµ¬ì¡°ë¥¼ ê³ ì •í•˜ê³ ,
ëª¨ë“  ëª¨ë“ˆì—ì„œ ì¼ê´€ëœ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
"""
from pathlib import Path

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ (ì´ íŒŒì¼ì´ ë£¨íŠ¸ì— ìœ„ì¹˜)
PROJECT_ROOT = Path(__file__).resolve().parent

# ============================================
# í•µì‹¬ ë””ë ‰í† ë¦¬
# ============================================

CORE_DIR = PROJECT_ROOT / "core"
PROTOCOLS_DIR = PROJECT_ROOT / "protocols"
SERVER_DIR = PROJECT_ROOT / "server"
PACKS_DIR = PROJECT_ROOT / "packs"
TOOLS_DIR = PROJECT_ROOT / "tools"
DOCS_DIR = PROJECT_ROOT / "docs"
TESTS_DIR = PROJECT_ROOT / "tests"

# ============================================
# Core í•˜ìœ„ ë””ë ‰í† ë¦¬
# ============================================

CORE_ENGINE_DIR = CORE_DIR / "engine"
CORE_LLM_DIR = CORE_DIR / "llm"
CORE_PACK_DIR = CORE_DIR / "pack"

# ============================================
# Pack ë””ë ‰í† ë¦¬
# ============================================

PACKS_DEVELOPMENT_DIR = PACKS_DIR / "development"
PACKS_EXAMPLES_DIR = PACKS_DIR / "examples"
PACKS_INTEGRATION_DIR = PACKS_DIR / "integration"

# ============================================
# Protocols í•˜ìœ„ ë””ë ‰í† ë¦¬
# ============================================

PROTOCOLS_WORKFLOW_DIR = PROTOCOLS_DIR / "workflow"
PROTOCOLS_MEMORY_DIR = PROTOCOLS_DIR / "memory"
PROTOCOLS_IDENTITY_DIR = PROTOCOLS_DIR / "identity"
PROTOCOLS_AUTH_DIR = PROTOCOLS_DIR / "auth"

# ============================================
# ì„¤ì • ë° ë¡œê·¸ íŒŒì¼
# ============================================

AUTUS_CONFIG_FILE = PROJECT_ROOT / ".autus"
LOGS_DIR = PROJECT_ROOT / "logs"
CELL_LOGS_DIR = LOGS_DIR / "cells" if (PROJECT_ROOT / "logs").exists() else None

# ============================================
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================

def ensure_dir(path: Path) -> Path:
    """
    ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±í•˜ê³  Path ë°˜í™˜

    Args:
        path: ìƒì„±í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ

    Returns:
        ìƒì„±ëœ ë””ë ‰í† ë¦¬ Path
    """
    path.mkdir(parents=True, exist_ok=True)
    return path


def get_pack_path(pack_name: str, category: str = None) -> Path:
    """
    Pack íŒŒì¼ ê²½ë¡œ ë°˜í™˜

    Args:
        pack_name: Pack ì´ë¦„ (ì˜ˆ: "architect_pack")
        category: Pack ì¹´í…Œê³ ë¦¬ ("development", "examples", "integration")
                 Noneì´ë©´ ìë™ìœ¼ë¡œ ì°¾ìŒ

    Returns:
        Pack íŒŒì¼ ê²½ë¡œ

    Raises:
        FileNotFoundError: Packì„ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ
    """
    if category:
        pack_path = PACKS_DIR / category / f"{pack_name}.yaml"
        if pack_path.exists():
            return pack_path
        raise FileNotFoundError(f"Pack not found: {pack_name} in {category}")

    # ìë™ìœ¼ë¡œ ì°¾ê¸°
    for cat_dir in [PACKS_DEVELOPMENT_DIR, PACKS_EXAMPLES_DIR, PACKS_INTEGRATION_DIR]:
        pack_path = cat_dir / f"{pack_name}.yaml"
        if pack_path.exists():
            return pack_path

    raise FileNotFoundError(f"Pack not found: {pack_name}")


def list_pack_dirs() -> list[Path]:
    """
    ëª¨ë“  Pack ë””ë ‰í† ë¦¬ ëª©ë¡ ë°˜í™˜

    Returns:
        Pack ë””ë ‰í† ë¦¬ Path ë¦¬ìŠ¤íŠ¸
    """
    return [
        PACKS_DEVELOPMENT_DIR,
        PACKS_EXAMPLES_DIR,
        PACKS_INTEGRATION_DIR
    ]




------------------------------
# FILE: core/__init__.py
------------------------------

------------------------------
# FILE: core/engine/__init__.py
------------------------------

------------------------------
# FILE: core/engine/per_loop.py
------------------------------
"""
AUTUS PER Loop Engine - Fixed Version
Plan â†’ Execute â†’ Review â†’ Improve â†’ Repeat
"""

from __future__ import annotations

import json
import time
from typing import Dict, List, Any, Optional, TYPE_CHECKING
from datetime import datetime

if TYPE_CHECKING:
    from .dsl import DSLExecutor


class PERLoop:
    """
    Plan-Execute-Review Loop Engine
    The core engine that enables AUTUS to develop itself.
    """

    def __init__(self, llm_provider: Optional[Any] = None) -> None:
        """Initialize PER Loop Engine."""
        self.llm_provider: Optional[Any] = llm_provider
        self.history: List[Dict[str, Any]] = []
        self.current_cycle: int = 0

        # Try to load DSL if available
        try:
            from .dsl import DSLExecutor
            self.dsl: Optional[DSLExecutor] = DSLExecutor()
        except Exception:
            self.dsl: Optional[DSLExecutor] = None

    def plan(self, goal: str, context: Optional[Dict] = None) -> Dict[str, Any]:
        """Plan phase: Decompose goal into actionable steps."""
        print(f"ğŸ“‹ Planning: {goal}")

        plan = {
            'goal': goal,
            'created_at': datetime.now().isoformat(),
            'cycle': self.current_cycle,
            'steps': [],
            'context': context or {}
        }

        # Simple heuristic-based planning
        goal_lower = goal.lower()

        if 'feature' in goal_lower or 'add' in goal_lower:
            plan['type'] = 'development'
            plan['steps'] = [
                {'id': 1, 'action': 'analyze', 'target': 'requirements'},
                {'id': 2, 'action': 'design', 'target': 'architecture'},
                {'id': 3, 'action': 'implement', 'target': 'code'},
                {'id': 4, 'action': 'test', 'target': 'functionality'}
            ]
        elif 'fix' in goal_lower or 'debug' in goal_lower:
            plan['type'] = 'debugging'
            plan['steps'] = [
                {'id': 1, 'action': 'identify', 'target': 'issue'},
                {'id': 2, 'action': 'analyze', 'target': 'root_cause'},
                {'id': 3, 'action': 'fix', 'target': 'code'},
                {'id': 4, 'action': 'verify', 'target': 'solution'}
            ]
        else:
            plan['type'] = 'generic'
            plan['steps'] = [
                {'id': 1, 'action': 'analyze', 'target': 'goal'},
                {'id': 2, 'action': 'execute', 'target': 'task'},
                {'id': 3, 'action': 'verify', 'target': 'result'}
            ]

        return plan

    def execute(self, plan: Dict[str, Any]) -> Dict[str, Any]:
        """Execute phase: Run the planned steps."""
        print(f"âš¡ Executing: {plan['goal']}")

        results = {
            'plan_id': id(plan),
            'started_at': datetime.now().isoformat(),
            'steps_completed': [],
            'steps_failed': [],
            'outputs': {}
        }

        for step in plan['steps']:
            try:
                # Simulate execution
                import random
                success = random.random() > 0.3  # 70% success rate

                if success:
                    results['steps_completed'].append(step)
                    results['outputs'][f"step_{step['id']}"] = f"{step['action']}_{step['target']}_done"
                else:
                    results['steps_failed'].append(step)
            except Exception as e:
                results['steps_failed'].append({**step, 'error': str(e)})

        results['completed_at'] = datetime.now().isoformat()
        results['success_rate'] = len(results['steps_completed']) / len(plan['steps']) if plan['steps'] else 0

        return results

    def review(self, plan: Dict[str, Any], results: Dict[str, Any]) -> Dict[str, Any]:
        """Review phase: Analyze results and generate improvements."""
        print(f"ğŸ” Reviewing: {plan['goal']}")

        review = {
            'plan_id': id(plan),
            'reviewed_at': datetime.now().isoformat(),
            'success_rate': results['success_rate'],
            'analysis': {},
            'improvements': [],
            'learnings': []
        }


------------------------------
# FILE: core/cli.py
------------------------------
#!/usr/bin/env python3
"""
AUTUS CLI
The main command-line interface for AUTUS protocol.
"""

from __future__ import annotations

import os
import sys
import json
import argparse
from pathlib import Path
from typing import Dict, Any, Optional

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

# Configuration
AUTUS_DIR = Path.cwd()
AUTUS_CONFIG_FILE = AUTUS_DIR / '.autus.config.json'


def load_config() -> Dict[str, Any]:
    """Load AUTUS configuration."""
    if AUTUS_CONFIG_FILE.exists():
        try:
            with open(AUTUS_CONFIG_FILE, 'r') as f:
                return json.load(f)
        except Exception:
            return {}
    return {}


def save_config(config: Dict[str, Any]) -> None:
    """Save AUTUS configuration."""
    with open(AUTUS_CONFIG_FILE, 'w') as f:
        json.dump(config, f, indent=2)


def cmd_init(args: argparse.Namespace) -> None:
    """Initialize AUTUS project."""
    print("ğŸš€ Initializing AUTUS Project")

    # Create directories
    dirs = ['outputs', 'cache', 'packs/examples', 'packs/development']
    for dir_path in dirs:
        Path(dir_path).mkdir(parents=True, exist_ok=True)

    # Create config
    config = {
        'version': '1.0.0',
        'project_name': args.name or 'my_project',
        'initialized': True
    }
    save_config(config)

    # Create identity
    from protocols.identity.core import IdentityCore
    identity = IdentityCore()
    identity_file = AUTUS_DIR / '.autus.identity'
    with open(identity_file, 'w') as f:
        f.write(identity.export_for_sync())

    print(f"âœ… Project initialized: {config['project_name']}")


def cmd_list(args: argparse.Namespace) -> None:
    """List packs."""
    from core.pack.loader import PackLoader

    loader = PackLoader()
    packs = loader.list_packs()

    if not packs:
        print("No packs found.")
        return

    print(f"\nğŸ“¦ Available Packs ({len(packs)}):\n")

    # Group by category
    by_category = {}
    for pack in packs:
        category = pack.get('category', 'uncategorized')
        if category not in by_category:
            by_category[category] = []
        by_category[category].append(pack['name'])

    for category, pack_names in sorted(by_category.items()):
        print(f"  [{category}]")
        for name in sorted(pack_names):
            print(f"    â€¢ {name}")
        print()


def cmd_run(args: argparse.Namespace) -> None:
    """Run a pack."""
    if not args.pack:
        print("âŒ Please specify a pack with --pack")
        return

    from core.pack.loader import PackLoader
    from core.engine.per_loop import PERLoop

    print(f"ğŸš€ Running pack: {args.pack}")

    # Parse inputs
    inputs = {}
    if args.inputs:
        try:
            inputs = json.loads(args.inputs)
        except:
            print(f"âš ï¸  Invalid JSON inputs, using empty inputs")

    try:
        # Try to load and execute pack
        loader = PackLoader()
        pack = loader.load_pack(args.pack)

        # Simple execution

------------------------------
# FILE: core/cli/commands/__init__.py
------------------------------
"""
CLI Commands

Modular command structure for AUTUS CLI
"""

from core.cli.commands.armp import armp_commands
from core.cli.commands.protocol import protocol_commands
from core.cli.commands.memory import memory_commands

__all__ = [
    "armp_commands",
    "protocol_commands",
    "memory_commands",
]



------------------------------
# FILE: protocols/identity/core.py
------------------------------
"""
Identity Core

Zero Identity Protocol - Core identity without PII
"""

import hashlib
from datetime import datetime
from typing import Optional
from protocols.identity.surface import IdentitySurface


class IdentityCore:
    """
    Core identity without any PII

    Based on a seed value (device ID, random string, etc.)
    Creates deterministic but anonymous identity
    """

    def __init__(self, seed: str):
        """
        Initialize identity from seed

        Args:
            seed: Any string (device ID, random string, etc.)
                  No PII allowed!
        """
        self.seed_hash = self._hash_seed(seed)
        self.created_at = datetime.now()
        self.surface: Optional[IdentitySurface] = None

    def _hash_seed(self, seed: str) -> str:
        """
        Hash seed to create core identity

        Uses SHA256 for deterministic hashing
        """
        return hashlib.sha256(seed.encode()).hexdigest()

    def get_core_hash(self) -> str:
        """Get the core identity hash"""
        return self.seed_hash

    def create_surface(self) -> IdentitySurface:
        """
        Create 3D Identity Surface

        Returns:
            IdentitySurface instance
        """
        if self.surface is None:
            self.surface = IdentitySurface(self.seed_hash)
        return self.surface

    def get_surface(self) -> Optional[IdentitySurface]:
        """Get existing surface (or None)"""
        return self.surface

    def evolve_surface(self, pattern: dict) -> None:
        """
        Evolve surface with behavioral pattern

        Args:
            pattern: Behavioral pattern from Memory OS or Workflow
        """
        if self.surface is None:
            self.create_surface()

        self.surface.evolve(pattern)

    def export_to_dict(self) -> dict:
        """Export identity to dictionary"""
        return {
            'seed_hash': self.seed_hash,
            'created_at': self.created_at.isoformat(),
            'surface': self.surface.export_to_dict() if self.surface else None
        }

    @classmethod
    def from_dict(cls, data: dict) -> 'IdentityCore':
        """Import identity from dictionary"""
        # Create with dummy seed (we only have hash)
        identity = cls.__new__(cls)
        identity.seed_hash = data['seed_hash']
        identity.created_at = datetime.fromisoformat(data['created_at'])

        if data.get('surface'):
            identity.surface = IdentitySurface.from_dict(data['surface'])
        else:
            identity.surface = None

        return identity

------------------------------
# FILE: protocols/memory/memory_os.py
------------------------------
"""
MemoryOS - High-level interface for Local Memory OS

MemoryStoreë¥¼ ë˜í•‘í•˜ëŠ” ìƒìœ„ ë ˆë²¨ ì¸í„°í˜ì´ìŠ¤
ë²¡í„° ê²€ìƒ‰ ë° ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ ê¸°ëŠ¥ ì œê³µ
"""
from typing import Any, Dict, Optional, List
from protocols.memory.store import MemoryStore
from protocols.memory.pii_validator import PIIValidator, PIIViolationError
from protocols.memory.vector_search import VectorSearch
from core.utils.logging import get_logger

logger = get_logger(__name__)


class MemoryOS:
    """
    MemoryOS - Local Memory Operating System

    ìƒìœ„ ë ˆë²¨ ì¸í„°í˜ì´ìŠ¤ë¡œ MemoryStoreë¥¼ ë˜í•‘í•˜ê³ ,
    ë²¡í„° ê²€ìƒ‰ ë° ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
    """

    def __init__(self, db_path: str = ".autus/memory/memory.db"):
        """
        MemoryOS ì´ˆê¸°í™”

        Args:
            db_path: ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ê²½ë¡œ
        """
        self.store = MemoryStore(db_path)
        self._vector_search_engine = VectorSearch()
        # ë©”ëª¨ë¦¬ ì¸ë±ì‹± (ì´ˆê¸°í™” ì‹œ í•œ ë²ˆë§Œ)
        self._indexed = False
        self._index_memory()

    def _index_memory(self):
        """ë©”ëª¨ë¦¬ ì¸ë±ì‹± (ì¤‘ë³µ ë°©ì§€)"""
        if not self._indexed:
            self._vector_search_engine.index_memory(self.store)
            self._indexed = True

    def set_preference(self, key: str, value: Any, category: str = "general") -> None:
        """
        ì„ í˜¸ë„ ì„¤ì • (ê°„í¸ ë©”ì„œë“œ)

        Args:
            key: ì„ í˜¸ë„ í‚¤
            value: ì„ í˜¸ë„ ê°’
            category: ì¹´í…Œê³ ë¦¬
        """
        self.store.store_preference(key, value, category)
        # ë²¡í„° ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        text = f"{key} {value} {category}"
        self._vector_search_engine.index.add_document(
            doc_id=f"pref:{key}",
            text=text,
            metadata={"type": "preference", "key": key, "category": category}
        )
        logger.debug(f"Preference set: {key} = {value}")

    def get_preference(self, key: str) -> Optional[Any]:
        """
        ì„ í˜¸ë„ ì¡°íšŒ

        Args:
            key: ì„ í˜¸ë„ í‚¤

        Returns:
            ì„ í˜¸ë„ ê°’ ë˜ëŠ” None
        """
        return self.store.get_preference(key)

    def learn_pattern(self, pattern_type: str, data: Dict[str, Any]) -> None:
        """
        í–‰ë™ íŒ¨í„´ í•™ìŠµ

        Args:
            pattern_type: íŒ¨í„´ íƒ€ì…
            data: íŒ¨í„´ ë°ì´í„°
        """
        self.store.store_pattern(pattern_type, data)
        # ë²¡í„° ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
        import json
        pattern_text = json.dumps(data)
        self._vector_search_engine.index.add_document(
            doc_id=f"pattern:{pattern_type}",
            text=pattern_text,
            metadata={"type": "pattern", "pattern_type": pattern_type}
        )
        logger.debug(f"Pattern learned: {pattern_type}")

    def get_patterns(self, pattern_type: Optional[str] = None) -> List[Dict[str, Any]]:
        """
        í–‰ë™ íŒ¨í„´ ì¡°íšŒ

        Args:
            pattern_type: íŠ¹ì • íƒ€ì…ë§Œ ì¡°íšŒ (Noneì´ë©´ ì „ì²´)

        Returns:
            íŒ¨í„´ ë¦¬ìŠ¤íŠ¸
        """
        return self.store.get_patterns(pattern_type)

    def set_context(self, context_type: str, value: Any, expires_at: Optional[str] = None) -> None:
        """
        ì»¨í…ìŠ¤íŠ¸ ì„¤ì •

        Args:
            context_type: ì»¨í…ìŠ¤íŠ¸ íƒ€ì…
            value: ì»¨í…ìŠ¤íŠ¸ ê°’
            expires_at: ë§Œë£Œ ì‹œê°„ (ISO í˜•ì‹)
        """
        self.store.store_context(context_type, value, expires_at)
        logger.debug(f"Context set: {context_type}")

    def get_context(self, context_type: str) -> Optional[Any]:
        """
        ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ


------------------------------
# FILE: protocols/workflow/graph.py
------------------------------
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional


@dataclass
class WorkflowNode:
    id: str
    type: str = "task"
    config: Dict[str, Any] = field(default_factory=dict)


@dataclass
class WorkflowEdge:
    source: str
    target: str
    label: Optional[str] = None


class WorkflowGraph:
    """
    Minimal WorkflowGraph used by tests.

    - nodes: dict[id, WorkflowNode]
    - edges: list of WorkflowEdge
    """

    def __init__(self) -> None:
        self.nodes: Dict[str, WorkflowNode] = {}
        self.edges: List[WorkflowEdge] = []

    def add_node(self, node_id: str, node_type: str = "task", config: Optional[Dict[str, Any]] = None) -> WorkflowNode:
        if config is None:
            config = {}
        node = WorkflowNode(id=node_id, type=node_type, config=config)
        self.nodes[node_id] = node
        return node

    def add_edge(self, source: str, target: str, label: Optional[str] = None) -> WorkflowEdge:
        edge = WorkflowEdge(source=source, target=target, label=label)
        self.edges.append(edge)
        return edge

    def get_node(self, node_id: str) -> WorkflowNode:
        return self.nodes[node_id]

    def neighbors(self, node_id: str) -> List[WorkflowNode]:
        out_ids = [e.target for e in self.edges if e.source == node_id]
        return [self.nodes[nid] for nid in out_ids if nid in self.nodes]

    def to_dict(self) -> Dict[str, Any]:
        return {
            "nodes": [
                {"id": n.id, "type": n.type, "config": n.config}
                for n in self.nodes.values()
            ],
            "edges": [
                {"source": e.source, "target": e.target, "label": e.label}
                for e in self.edges
            ],
        }

------------------------------
# FILE: server/main.py
------------------------------
"""
AUTUS - Autonomous Universal Thinking & Understanding System
Main FastAPI Application Entry Point
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager
import uvicorn
from pathlib import Path

try:
    import sys
    ROOT = Path(__file__).resolve().parent.parent
    sys.path.insert(0, str(ROOT))
    from config import (
        PACKS_DEVELOPMENT_DIR,
        PACKS_EXAMPLES_DIR,
        LOGS_DIR,
        CELL_LOGS_DIR
    )
except ImportError:
    # fallback
    PACKS_DEVELOPMENT_DIR = Path("packs/development")
    PACKS_EXAMPLES_DIR = Path("packs/examples")
    LOGS_DIR = Path("logs")
    CELL_LOGS_DIR = LOGS_DIR / "cells" if LOGS_DIR.exists() else None

# Lifespan ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    print("ğŸš€ AUTUS ì‹œì‘...")
    yield
    # Shutdown
    print("ğŸ›‘ AUTUS ì¢…ë£Œ...")

app = FastAPI(
    title="AUTUS",
    description="Self-Evolving AI Operating System",
    version="1.0.0",
    lifespan=lifespan
)

# CORS ì„¤ì •
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ì •ì  íŒŒì¼ ì„œë¹™
try:
    app.mount("/static", StaticFiles(directory="static"), name="static")
except Exception as e:
    print(f"âš ï¸ Static files mount ì‹¤íŒ¨: {e}")

@app.get("/")
async def root():
    """AUTUS ë£¨íŠ¸ ì—”ë“œí¬ì¸íŠ¸"""
    return {
        "message": "AUTUS - Autonomous Universal Thinking & Understanding System",
        "version": "1.0.0",
        "status": "running",
        "docs": "/docs",
        "health": "/health"
    }

@app.get("/health")
async def health():
    """í—¬ìŠ¤ ì²´í¬"""
    return {
        "status": "healthy",
        "layers": {
            "core": "OK",
            "packs": "OK",
            "protocols": "OK",
            "server": "OK"
        },
        "features": {
            "cell_system": "active",
            "pack_generator": "active",
            "cache": "active"
        }
    }

@app.get("/api/cells")
async def list_cells():
    """Cell ëª©ë¡ ì¡°íšŒ"""
    cells = []

    if CELL_LOGS_DIR and CELL_LOGS_DIR.exists():
        for log_file in CELL_LOGS_DIR.glob("*.jsonl"):
            cells.append({
                "name": log_file.stem,
                "log_file": str(log_file)
            })

    return {
        "status": "success",
        "count": len(cells),
        "cells": cells
    }

@app.get("/api/packs")
async def list_packs():
    """Pack ëª©ë¡ ì¡°íšŒ"""
    packs = []

    # Development packs ìŠ¤ìº”
    if PACKS_DEVELOPMENT_DIR.exists():
        for pack_file in PACKS_DEVELOPMENT_DIR.glob("*.yaml"):
            packs.append({
                "name": pack_file.stem,
                "path": str(pack_file),
                "type": "development"
            })



## 5. REGISTRY STATE
------------------------------
# REGISTRY: core/registry/cells_registry.json
------------------------------
{
  "cells": []
}

------------------------------
# REGISTRY: core/registry/packs_registry.json
------------------------------
{
  "packs": []
}

------------------------------
# REGISTRY: core/registry/tests_registry.json
------------------------------
{
  "tests": []
}


## 6. PACKS & ROUTES
# packs/
__pycache__
{development,examples,integration}
autogen_cells_autogen.py
development
device_bridge_autogen.py
emo_cmms_autogen.py
erp_adapter_autogen.py
examples
flow_orchestrator_autogen.py
habit_tracker_autogen.py
hello_autogen.py
history_timeline_autogen.py
identity_core_autogen.py
jeju_school_autogen.py
local_memory_autogen.py
meta_tester_autogen.py
nba_atb_autogen.py
pack_factory_autogen.py
pattern_learner_autogen.py
preference_vector_autogen.py
privacy_guard_autogen.py
risk_monitor_autogen.py
runtime_controller_autogen.py
saas_adapter_autogen.py
style_analyzer_autogen.py
zero_identity_autogen.py

# server/routes/
server/routes/autogen_cells.py
server/routes/device_bridge.py
server/routes/emo_cmms.py
server/routes/erp_adapter.py
server/routes/flow_orchestrator.py
server/routes/habit_tracker.py
server/routes/hello.py
server/routes/history_timeline.py
server/routes/identity_core.py
server/routes/jeju_school.py
server/routes/local_memory.py
server/routes/meta_tester.py
server/routes/nba_atb.py
server/routes/pack_factory.py
server/routes/pattern_learner.py
server/routes/preference_vector.py
server/routes/privacy_guard.py
server/routes/risk_monitor.py
server/routes/runtime_controller.py
server/routes/saas_adapter.py
server/routes/style_analyzer.py
server/routes/zero_identity.py

## 7. 3D / WEB SHELL FILES
autus_3d_web.* ì—†ìŒ (ì¶”í›„ ìƒì„± ëŒ€ìƒ)

## 8. PYTEST SMOKE (í•µì‹¬ íŒŒì¼ ìœ„ì£¼)
# style_analyzer / identity / memory_store ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
[WARN] ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì§„í–‰ ì¤‘ ê¸°ëŠ¥ì´ ìˆìœ¼ë©´ ì •ìƒ)

## 9. ENDPOINT SMOKE (404 ì—¬ë¶€ë§Œ í™•ì¸)
uvicorn ì„œë²„ ë¯¸ì‹¤í–‰ ìƒíƒœ (ì—”ë“œí¬ì¸íŠ¸ ìŠ¤ëª¨í¬ ìƒëµ)

